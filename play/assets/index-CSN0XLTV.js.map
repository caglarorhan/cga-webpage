{"version":3,"mappings":"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","names":["GameLoop","tickRate","onUpdate","onRender","currentTime","frameTime","alpha","DEFAULT_BINDINGS","InputManager","canvas","rect","moveLen","binding","action","offset","zoom","bindings","HeroId","Team","WeaponId","GamePhase","GameMode","PacketType","GameEventType","DEFAULT_CONFIG","COLORS","WEAPONS","HEROES","NETWORK","GAMEPLAY","Renderer","width","height","ctx","dpr","x","y","worldPos","screenPos","margin","screen","color","options","fill","stroke","strokeWidth","glow","glowColor","glowSize","cornerRadius","radius","startAngle","endAngle","x1","y1","x2","y2","dash","points","i","text","font","size","align","baseline","metrics","sprite","w","h","image","rotation","intensity","current","max","shield","maxShield","healthPercent","shieldPercent","healthWidth","shieldWidth","cooldownPercent","icon","iconSize","cellSize","startX","startY","endX","endY","label","AudioManager","key","url","arrayBuffer","audioBuffer","e","buffer","source","gainNode","id","fadeIn","fadeOut","volume","Vec2","v","a","b","scalar","len","dx","dy","angle","length","cos","sin","maxLength","epsilon","Collision","point","circle","radiusSum","closestX","closestY","p1","p2","p3","p4","d","ua","ub","start","end","edges","closest","closestDist","edge","hit","dist","idCounter","generateId","prefix","lerp","randomRange","min","formatTime","ms","totalSeconds","minutes","seconds","ColliderType","CollisionLayers","SpatialHashGrid","body","bounds","keys","minCX","minCY","maxCX","maxCY","cx","cy","c","cellKeys","result","cell","nearby","CollisionWorld","position","velocity","bodyA","otherId","bodyB","colliderA","colliderB","posA","posB","normal","depth","rectA","rectB","overlapX","overlapY","centerA","centerB","diff","circleBody","boxBody","box","circlePos","boxPos","distSquared","radiusSquared","leftDist","rightDist","topDist","bottomDist","minDist","sortedCollisions","aHasStatic","bHasStatic","collision","velDotNormal","halfDepth","separationScale","origin","direction","maxDistance","layerMask","normalizedDir","collider","pos","hitPoint","distance","center","f","discriminant","t1","t2","EventEmitter","event","callback","data","callbacks","wrapper","DEFAULT_ICE_SERVERS","PeerConnection","peerId","config","state","channel","offer","answer","candidate","SignalingClient","serverUrl","resolve","reject","error","message","delay","roomCode","targetId","FirestoreSignaling","firebaseConfig","initializeApp","getApps","getApp","__vitePreload","getFirestore","collection","doc","setDoc","getDoc","addDoc","onSnapshot","deleteDoc","updateDoc","serverTimestamp","arrayUnion","app","roomRef","peerRef","roomSnap","existingPeers","otherPeers","p","peersRef","unsubscribe","snapshot","change","signalsRef","messageId","messageRef","type","payload","unsub","newPeers","chars","code","PacketSerializer","packet","json","input","senderId","view","senderBytes","flags","timestamp","senderLength","moveX","moveY","aimX","aimY","sequence","tick","players","projectiles","objectives","NetworkManager","signalingUrl","peers","peer","startTime","latency","now","sum","Player","name","team","heroId","spawnPosition","heroDef","defaultWeapon","pistolState","_","index","dt","time","aimDir","regenRate","speed","moveDir","targetVelocity","frictionFactor","weaponDef","ability","abilityDef","fireInterval","abilityIndex","_time","amount","attackerId","damageType","actualDamage","shieldDamage","bonusHeal","actualHeal","actualShield","slot","targetWeapon","nextSlot","prevSlot","weaponId","newWeapon","player","Projectile","ownerId","damage","lifetime","spawnTime","proj","GameMap","row","prop","world","sp","spawns","spawn","site","worldX","worldY","tileX","tileY","MAP_REGISTRY","getMapById","mapId","createNeonArenaMap","createCyberDistrictMap","createHelixLabsMap","createReactorCoreMap","createGridMazeMap","createSkyBridgeMap","createDataVaultMap","createNeonTowerMap","createCrossfireMap","createWarehouseMap","createServerFarmMap","createNexusHubMap","tiles","mapData","centerX","centerY","normalizedAngle","isGap","isPillar","BotAIMode","TacticalIntent","DEFAULT_BOT_CONFIG","RuleBasedBotController","context","map","ability1","ability2","stateInfo","t","intent","directions","dir","siteIndex","allPlayers","collisionWorld","_map","enemies","teammates","visibleEnemies","spikeState","spikeCarrier","nearest","nearestDist","teammate","visible","enemy","timeSinceStateChange","newState","_collisionWorld","separationX","separationY","other","pushDir","strength","sepLen","lookAngle","strafeDir","toEnemy","perpendicular","inaccuracy","awayDir","target","normalized","leftDir","rightDir","leftHit","rightHit","timeOffset","idOffset","offsetAngle","spikePos","sitePos","toTarget","lookDir","SLMBotController","_stateInfo","response","lower","BotControllerFactory","mode","available","EffectType","EFFECT_DEFINITIONS","ZoneVisualType","EffectSystem","sourceId","duration","value","tickInterval","definition","targetEffects","existingIndex","existing","existingFromSource","newEffect","effects","cloakIndex","removed","effect","effectId","count","affectsAllies","affectsEnemies","visualType","zone","zoneId","z","category","modifier","reduction","_gameTime","getEntitiesInRadius","tickValue","entitiesInZone","TILE_SIZE","tilesToPixels","ABILITY_RANGES","VisualEffectType","AbilitySystem","effectSystem","blinkDistance","targetPos","finalPos","behindDir","behindPos","stunDuration","hitTargets","revealedTargets","shieldAmount","allies","shieldedTargets","ally","throwDistance","landingPos","trapPos","turretPos","turret","range","cloudPos","firstTarget","chainRadius","infected","bestDot","normalizedToEnemy","dot","dashDistance","backwardDirection","_dt","shots","turretId","playerId","endTime","GameWorld","targetIds","isAlly","isEnemy","excludeId","maxDist","_ignorePlayers","existingPlayer","spawnIndex","spawnPos","oldPeerId","newPeerId","difficulty","botIndex","difficultySettings","botController","botWeapons","bot","randomWeapon","wasDead","attackers","humanAttackers","carrier","winningTeam","disconnectedTeam","disconnectedPlayerName","isForfeit","playerName","isPaused","pausedBy","botId","botAI","projectile","mapWidth","mapHeight","tileSize","playerRadius","minBound","maxBoundX","maxBoundY","localPlayer","weapon","baseAngle","spread","pellets","endPoint","isHeadshot","baseDamage","chargeGain","turretShots","shot","isLocalPlayer","qAbilityIndex","fAbilityIndex","canUse","ultCost","vfx","speedMod","isCloaked","damageBoost","markedEffect","plantTime","defuseTime","aliveAttackers","aliveHumans","newCarrier","defusingPlayer","oldDefuser","totalPlayers","roundTime","attackerPlayers","defenderPlayers","attackersAlive","defendersAlive","uploadTime","localPeerId","seenPeerIds","playerState","wasRoundReset","justRespawned","distSq","largeDistanceMismatch","seenProjectileIds","projState","events","phase","ParticleSystem","dtSec","renderer","lifeRatio","tailLength","tail","tailEnd","prev","curr","trailAlpha","offsetX","offsetY","char","life","colors","gravity","friction","rotationSpeed","trail","spd","sz","lf","rotSpd","particleCount","edgePos","particlePos","scale","hex","r","g","GameRenderer","appVersion","interpX","interpY","viewWidth","viewHeight","spikeX","spikeY","pulse","barWidth","barHeight","barX","barY","progress","isLocal","bodyColor","timeSinceDeath","fadeOutDuration","fadeAlpha","corpseColor","facingX","facingY","targetY","_alpha","trailX","trailY","flash","age","arcStart","arcEnd","currentRadius","flashAlpha","trailEnd","interpAlpha","barrierEffects","elapsed","effectPosition","effectDirection","px","py","maxRadius","innerAlpha","safeAlpha","arcAngle","nx","ny","segments","segAngle","sx","sy","coreAlpha","tracer","tracerColor","impactColor","iconX","iconY","gap","score","remaining","uploadRemaining","isLocalCarrier","slotSize","slotGap","slotsStartX","slotX","slotY","hasWeapon","isActive","displayNumber","initial","weaponInfoX","ammoText","icons","abilitySize","abilityGap","totalWidth","ay","creditsX","ax","isPassive","isUltimate","cooldownRemaining","isReady","hasCharges","secondsLeft","keyColor","chargeText","ultCharge","ultPercent","barYPos","ultReady","displayName","isMatchEnd","subtext","isVictory","isDefeat","attackersWon","finalScore","mainColor","countdownTime","countdownText","countdownColor","instructionText","_height","confettiColors","pulseIntensity","gradient","numSkulls","baseX","SFX","SOUND_FILES","SOUND_CATEGORIES","SOUND_VOLUMES","DEFAULT_AUDIO_SETTINGS","GameAudio","saved","newSettings","soundKey","volumeMultiplier","categoryVolume","categoryEnabled","baseVolume","masterVolume","loadPromises","essential","sound","offsetSeconds","pitchVariation","music","gameAudioInstance","getGameAudio","FIREBASE_CONFIG","PlayerStatsServiceClass","storageKey","info","increment","callsign","playerRef","newPlayer","won","kills","deaths","assists","sessionDuration","updates","field","globalRef","countryCode","delta","playerDoc","globalDoc","PlayerStatsService","GA_MEASUREMENT_ID","AnalyticsServiceClass","eventName","params","durationSeconds","gamesPlayed","abilityName","abilitySlot","price","element","eventMap","props","AnalyticsService","DEFAULT_SETTINGS","Game","gameMode","version","connectedPeers","peerIds","botCount","friendlyBotCount","attackerScore","defenderScore","stats","playerCount","peerCount","realPeerId","isMultiplayerGame","defenders","letters","digits","lobbyPlayer","remainingHumans","oldName","existingByName","placeholderPlayer","inputData","stateData","settings","serializedState","victim","currentPhase","isRoundActive","soundDuration","inputState","playerInput","switched","recentShots","cameraOffset","cameraZoom","fps","tps","show","shownTutorials","style","dismiss","LobbyBrowserServiceClass","query","where","orderBy","limit","getDocs","lobbyRef","currentPlayers","status","q","lobbies","tenMinutesAgo","cleaned","docSnap","LobbyBrowserService","VoiceChatService","track","pc","audioTrack","remoteStream","audio","sender","UIAudio","enabled","uiAudio","initUIAudio","lobbyNetwork","connectionUI","versionBadge","playerNameInput","hostButton","joinButton","roomCodeInput","connectButton","backButton","joinButtons","settingsButton","settingsPanel","howToPlayButton","howToPlayModal","howToPlayCloseButton","statsButton","statsModal","statsCloseButton","micToggleButton","botCountSlider","botCountValue","botDifficultySelect","friendlyBotsSlider","friendlyBotsValue","aiModeSelect","gameModeSelect","mapSelect","mapHint","heroSelect","abilityQSelect","abilityFSelect","abilityQName","abilityFName","settingsSaveButton","settingsCloseButton","settingsAudioMasterVolume","settingsAudioMasterEnabled","settingsAudioMasterValue","settingsAudioMusicVolume","settingsAudioMusicEnabled","settingsAudioMusicValue","settingsAudioSfxVolume","settingsAudioSfxEnabled","settingsAudioSfxValue","settingsAudioVoiceVolume","settingsAudioVoiceEnabled","settingsAudioVoiceValue","settingsAudioUiVolume","settingsAudioUiEnabled","settingsAudioUiValue","pauseMenu","resumeButton","quitButton","sensitivitySlider","sensitivityValue","fpsCheckbox","audioMasterVolume","audioMasterEnabled","audioMasterValue","audioMusicVolume","audioMusicEnabled","audioMusicValue","audioSfxVolume","audioSfxEnabled","audioSfxValue","audioVoiceVolume","audioVoiceEnabled","audioVoiceValue","audioUiVolume","audioUiEnabled","audioUiValue","helpPanel","helpPanelVisible","helpAutoHideTimer","buyMenu","buyCredits","weaponItems","roundOverPanel","winnerText","matchInfo","scoreAttackers","scoreDefenders","playAgainButton","mainMenuButton","countdownDisplay","pauseCountdownButton","roomCodeDisplay","roomCodeText","copyCodeButton","lobbyScreen","lobbyRoomCode","hostSettings","lobbyPlayerCountSelect","lobbyRoundCountSelect","lobbyCurrentPlayers","lobbyMaxPlayers","lobbyPlayerList","lobbyWaitingText","lobbyCountdown","leaveLobbyButton","copyLobbyCodeButton","startGameButton","lobbyMakePublicCheckbox","findMatchButton","lobbyBrowserModal","lobbyBrowserCloseButton","refreshLobbiesButton","lobbyList","lobbyEmpty","game","HERO_ABILITIES","gameSettings","populateMapDropdown","currentMapId","filteredMaps","option","m","updateMapHint","mapInfo","updateAbilityNames","hero","abilities","qSlot","fSlot","countryFlag","formatStatNumber","num","loadStatsModal","totalPlayersEl","totalGamesEl","totalHoursEl","myStatsEl","countriesEl","leaderboardEl","globalStats","sorted","myStats","winRate","kd","topPlayers","loadLeaderboardData","db","lobbyBrowserUnsubscribe","openLobbyBrowser","renderLobbies","closeLobbyBrowser","refreshLobbies","item","lobby","modeLabel","mapName","escapeHtml","joinPublicLobby","div","handleConnect","loadSettings","parsed","saveSettings","gameplaySettings","audioSettings","loadAudioSettings","updateAudioSettingsUI","masterVol","uiVol","saveAudioSettings","loadGameplaySettings","updatePauseMenuUI","saveGameplaySettings","WEAPON_PRICES","showHelpPanel","autoHide","hideHelpPanel","openBuyMenu","updateBuyMenuUI","closeBuyMenu","slotStr","owned","canAfford","priceEl","tryBuyWeapon","enumWeaponId","pauseGame","resumeGame","quitToMenu","cleanupVoiceChat","gameStarted","stopRoundEndPolling","stopLobbyCountdown","lobbyState","lobbyCountdownInterval","generateRoomCode","showLobby","isHost","updateLobbyUI","canStart","startLobbyCountdown","startGameFromLobby","leaveLobby","networkToPass","lobbyPlayersForGame","startRoundEndPolling","initVoiceChat","roundEndPollingId","roundOverShown","idleTimeoutId","lastInteractionTime","showRoundOver","isMatchOver","roundsToWin","forfeitPlayerName","header","startIdleTimeout","updateCountdownDisplay","countdownInfo","clearIdleTimeout","resetIdleTimer","playAgain","toggleCountdownPause","voiceChat","updateMicButtonUI","allowedPeers","init","savedName","handleHost","handleJoinClick","handleBack","copyLobbyCode","setupAudioSlider","slider","valueDisplay","settingKey","isSettingsPanel","isEnabled","enabledKey","handlePageUnload","button","actualRoomCode","weaponTooltip","weaponNames","slotNumber","weaponName"],"ignoreList":[],"sources":["../../src/engine/GameLoop.ts","../../src/engine/InputManager.ts","../../src/shared/types.ts","../../src/shared/constants.ts","../../src/engine/Renderer.ts","../../src/engine/AudioManager.ts","../../src/shared/utils.ts","../../src/engine/CollisionSystem.ts","../../src/network/EventEmitter.ts","../../src/network/PeerConnection.ts","../../src/network/SignalingClient.ts","../../src/network/FirestoreSignaling.ts","../../src/network/PacketSerializer.ts","../../src/network/NetworkManager.ts","../../src/game/entities/Player.ts","../../src/game/entities/Projectile.ts","../../src/game/map/GameMap.ts","../../src/game/ai/IBotController.ts","../../src/game/ai/BotAI.ts","../../src/game/ai/SLMBotController.ts","../../src/game/ai/BotControllerFactory.ts","../../src/game/systems/EffectSystem.ts","../../src/game/systems/AbilitySystem.ts","../../src/game/GameWorld.ts","../../src/game/effects/ParticleSystem.ts","../../src/game/GameRenderer.ts","../../src/game/GameAudio.ts","../../src/config/firebase.config.ts","../../src/services/PlayerStatsService.ts","../../src/services/AnalyticsService.ts","../../src/game/Game.ts","../../src/services/LobbyBrowserService.ts","../../src/services/VoiceChatService.ts","../../src/main.ts"],"sourcesContent":["// ============================================================================\r\n// GAME LOOP - Fixed Timestep with Interpolation\r\n// ============================================================================\r\n\r\nexport type UpdateCallback = (dt: number, time: number) => void;\r\nexport type RenderCallback = (alpha: number) => void;\r\n\r\nexport class GameLoop {\r\n  private running = false;\r\n  private lastTime = 0;\r\n  private accumulator = 0;\r\n  private frameId = 0;\r\n\r\n  private readonly fixedDeltaTime: number;\r\n  private readonly maxFrameTime: number;\r\n\r\n  private onUpdate: UpdateCallback;\r\n  private onRender: RenderCallback;\r\n\r\n  // Performance metrics\r\n  private fps = 0;\r\n  private frameCount = 0;\r\n  private fpsTimer = 0;\r\n  private tickCount = 0;\r\n  private tps = 0;\r\n\r\n  constructor(\r\n    tickRate: number,\r\n    onUpdate: UpdateCallback,\r\n    onRender: RenderCallback\r\n  ) {\r\n    this.fixedDeltaTime = 1000 / tickRate;\r\n    this.maxFrameTime = this.fixedDeltaTime * 5; // Prevent spiral of death\r\n    this.onUpdate = onUpdate;\r\n    this.onRender = onRender;\r\n  }\r\n\r\n  start(): void {\r\n    if (this.running) return;\r\n    this.running = true;\r\n    this.lastTime = performance.now();\r\n    this.accumulator = 0;\r\n    this.frameCount = 0;\r\n    this.tickCount = 0;\r\n    this.fpsTimer = this.lastTime;\r\n    this.loop();\r\n  }\r\n\r\n  stop(): void {\r\n    this.running = false;\r\n    if (this.frameId) {\r\n      cancelAnimationFrame(this.frameId);\r\n      this.frameId = 0;\r\n    }\r\n  }\r\n\r\n  private loop = (): void => {\r\n    if (!this.running) return;\r\n\r\n    const currentTime = performance.now();\r\n    let frameTime = currentTime - this.lastTime;\r\n    this.lastTime = currentTime;\r\n\r\n    // Clamp frame time to prevent spiral of death\r\n    if (frameTime > this.maxFrameTime) {\r\n      frameTime = this.maxFrameTime;\r\n    }\r\n\r\n    this.accumulator += frameTime;\r\n\r\n    // Fixed timestep updates\r\n    while (this.accumulator >= this.fixedDeltaTime) {\r\n      this.onUpdate(this.fixedDeltaTime, currentTime);\r\n      this.accumulator -= this.fixedDeltaTime;\r\n      this.tickCount++;\r\n    }\r\n\r\n    // Render with interpolation alpha\r\n    const alpha = this.accumulator / this.fixedDeltaTime;\r\n    this.onRender(alpha);\r\n    this.frameCount++;\r\n\r\n    // Calculate FPS/TPS every second\r\n    if (currentTime - this.fpsTimer >= 1000) {\r\n      this.fps = this.frameCount;\r\n      this.tps = this.tickCount;\r\n      this.frameCount = 0;\r\n      this.tickCount = 0;\r\n      this.fpsTimer = currentTime;\r\n    }\r\n\r\n    this.frameId = requestAnimationFrame(this.loop);\r\n  };\r\n\r\n  getFPS(): number {\r\n    return this.fps;\r\n  }\r\n\r\n  getTPS(): number {\r\n    return this.tps;\r\n  }\r\n\r\n  isRunning(): boolean {\r\n    return this.running;\r\n  }\r\n\r\n  getFixedDeltaTime(): number {\r\n    return this.fixedDeltaTime;\r\n  }\r\n}\r\n","// ============================================================================\r\n// INPUT MANAGER - Keyboard, Mouse, Gamepad\r\n// ============================================================================\r\n\r\nimport { Vector2 } from '@/shared/types';\r\n\r\nexport interface InputState {\r\n  // Movement\r\n  moveX: number;\r\n  moveY: number;\r\n  \r\n  // Aiming (world position)\r\n  aimX: number;\r\n  aimY: number;\r\n  \r\n  // Actions\r\n  shoot: boolean;\r\n  reload: boolean;\r\n  interact: boolean;\r\n  ability1: boolean;\r\n  ability2: boolean;\r\n  ultimate: boolean;\r\n  \r\n  // Weapon switching (1-5)\r\n  weaponSlot: number;  // 0 = no switch, 1-10 = weapon slot\r\n  \r\n  // UI\r\n  menu: boolean;\r\n  scoreboard: boolean;\r\n  buyMenu: boolean;\r\n}\r\n\r\nexport type KeyBinding = {\r\n  action: keyof InputState;\r\n  key: string;\r\n  type: 'press' | 'hold';\r\n};\r\n\r\nconst DEFAULT_BINDINGS: KeyBinding[] = [\r\n  { action: 'reload', key: 'KeyR', type: 'press' },\r\n  { action: 'interact', key: 'KeyE', type: 'hold' },  // Hold for planting/defusing spike\r\n  { action: 'ability1', key: 'KeyQ', type: 'press' },\r\n  { action: 'ability2', key: 'KeyF', type: 'press' },\r\n  { action: 'ultimate', key: 'KeyX', type: 'press' },\r\n  { action: 'menu', key: 'Escape', type: 'press' },\r\n  { action: 'scoreboard', key: 'Tab', type: 'hold' },\r\n  { action: 'buyMenu', key: 'KeyB', type: 'press' },\r\n];\r\n\r\nexport class InputManager {\r\n  private canvas: HTMLCanvasElement;\r\n  \r\n  // Raw input state\r\n  private keysDown = new Set<string>();\r\n  private keysPressed = new Set<string>();\r\n  private mouseDown = new Set<number>();\r\n  private mousePressed = new Set<number>();\r\n  private mousePosition: Vector2 = { x: 0, y: 0 };\r\n  private mouseWorldPosition: Vector2 = { x: 0, y: 0 };\r\n  private mouseWheelDelta = 0; // Positive = scroll down, Negative = scroll up\r\n  \r\n  // Processed state\r\n  private currentState: InputState;\r\n  private previousState: InputState;\r\n  \r\n  // Camera reference for screen-to-world conversion\r\n  private cameraOffset: Vector2 = { x: 0, y: 0 };\r\n  private cameraZoom = 1;\r\n  \r\n  // Bindings\r\n  private bindings: KeyBinding[];\r\n  \r\n  // Sequence number for network ordering\r\n  private sequence = 0;\r\n\r\n  constructor(canvas: HTMLCanvasElement) {\r\n    this.canvas = canvas;\r\n    this.bindings = [...DEFAULT_BINDINGS];\r\n    this.currentState = this.createEmptyState();\r\n    this.previousState = this.createEmptyState();\r\n    \r\n    this.setupListeners();\r\n  }\r\n\r\n  private createEmptyState(): InputState {\r\n    return {\r\n      moveX: 0,\r\n      moveY: 0,\r\n      aimX: 0,\r\n      aimY: 0,\r\n      shoot: false,\r\n      reload: false,\r\n      interact: false,\r\n      ability1: false,\r\n      ability2: false,\r\n      ultimate: false,\r\n      weaponSlot: 0,\r\n      menu: false,\r\n      scoreboard: false,\r\n      buyMenu: false,\r\n    };\r\n  }\r\n\r\n  private setupListeners(): void {\r\n    // Keyboard\r\n    window.addEventListener('keydown', this.onKeyDown);\r\n    window.addEventListener('keyup', this.onKeyUp);\r\n    \r\n    // Mouse\r\n    this.canvas.addEventListener('mousedown', this.onMouseDown);\r\n    this.canvas.addEventListener('mouseup', this.onMouseUp);\r\n    this.canvas.addEventListener('mousemove', this.onMouseMove);\r\n    this.canvas.addEventListener('wheel', this.onMouseWheel, { passive: false });\r\n    this.canvas.addEventListener('contextmenu', (e) => e.preventDefault());\r\n    \r\n    // Prevent tab from changing focus\r\n    window.addEventListener('keydown', (e) => {\r\n      if (e.code === 'Tab') e.preventDefault();\r\n    });\r\n  }\r\n\r\n  private onKeyDown = (e: KeyboardEvent): void => {\r\n    if (!this.keysDown.has(e.code)) {\r\n      this.keysPressed.add(e.code);\r\n    }\r\n    this.keysDown.add(e.code);\r\n  };\r\n\r\n  private onKeyUp = (e: KeyboardEvent): void => {\r\n    this.keysDown.delete(e.code);\r\n  };\r\n\r\n  private onMouseDown = (e: MouseEvent): void => {\r\n    if (!this.mouseDown.has(e.button)) {\r\n      this.mousePressed.add(e.button);\r\n    }\r\n    this.mouseDown.add(e.button);\r\n  };\r\n\r\n  private onMouseUp = (e: MouseEvent): void => {\r\n    this.mouseDown.delete(e.button);\r\n  };\r\n\r\n  private onMouseWheel = (e: WheelEvent): void => {\r\n    e.preventDefault(); // Prevent page scroll\r\n    this.mouseWheelDelta = e.deltaY;\r\n  };\r\n\r\n  private onMouseMove = (e: MouseEvent): void => {\r\n    const rect = this.canvas.getBoundingClientRect();\r\n    this.mousePosition = {\r\n      x: e.clientX - rect.left,\r\n      y: e.clientY - rect.top,\r\n    };\r\n    \r\n    // Convert to world position\r\n    this.mouseWorldPosition = {\r\n      x: (this.mousePosition.x / this.cameraZoom) + this.cameraOffset.x,\r\n      y: (this.mousePosition.y / this.cameraZoom) + this.cameraOffset.y,\r\n    };\r\n  };\r\n\r\n  update(): void {\r\n    // Store previous state\r\n    this.previousState = { ...this.currentState };\r\n    \r\n    // Reset state\r\n    this.currentState = this.createEmptyState();\r\n    \r\n    // Process movement (WASD)\r\n    if (this.keysDown.has('KeyW') || this.keysDown.has('ArrowUp')) {\r\n      this.currentState.moveY -= 1;\r\n    }\r\n    if (this.keysDown.has('KeyS') || this.keysDown.has('ArrowDown')) {\r\n      this.currentState.moveY += 1;\r\n    }\r\n    if (this.keysDown.has('KeyA') || this.keysDown.has('ArrowLeft')) {\r\n      this.currentState.moveX -= 1;\r\n    }\r\n    if (this.keysDown.has('KeyD') || this.keysDown.has('ArrowRight')) {\r\n      this.currentState.moveX += 1;\r\n    }\r\n    \r\n    // Normalize diagonal movement\r\n    const moveLen = Math.sqrt(\r\n      this.currentState.moveX * this.currentState.moveX +\r\n      this.currentState.moveY * this.currentState.moveY\r\n    );\r\n    if (moveLen > 1) {\r\n      this.currentState.moveX /= moveLen;\r\n      this.currentState.moveY /= moveLen;\r\n    }\r\n    \r\n    // Process aim\r\n    this.currentState.aimX = this.mouseWorldPosition.x;\r\n    this.currentState.aimY = this.mouseWorldPosition.y;\r\n    \r\n    // Process shoot (left mouse button)\r\n    this.currentState.shoot = this.mouseDown.has(0);\r\n    \r\n    // Process reload (R key OR right mouse button)\r\n    if (this.mousePressed.has(2)) {\r\n      this.currentState.reload = true;\r\n    }\r\n    \r\n    // Process key bindings\r\n    for (const binding of this.bindings) {\r\n      if (binding.type === 'press') {\r\n        if (this.keysPressed.has(binding.key)) {\r\n          (this.currentState as unknown as Record<string, boolean>)[binding.action] = true;\r\n        }\r\n      } else {\r\n        if (this.keysDown.has(binding.key)) {\r\n          (this.currentState as unknown as Record<string, boolean>)[binding.action] = true;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Process weapon switching (number keys 1-9, 0 for slot 10, OR mouse wheel)\r\n    if (this.keysPressed.has('Digit1')) this.currentState.weaponSlot = 1;\r\n    else if (this.keysPressed.has('Digit2')) this.currentState.weaponSlot = 2;\r\n    else if (this.keysPressed.has('Digit3')) this.currentState.weaponSlot = 3;\r\n    else if (this.keysPressed.has('Digit4')) this.currentState.weaponSlot = 4;\r\n    else if (this.keysPressed.has('Digit5')) this.currentState.weaponSlot = 5;\r\n    else if (this.keysPressed.has('Digit6')) this.currentState.weaponSlot = 6;\r\n    else if (this.keysPressed.has('Digit7')) this.currentState.weaponSlot = 7;\r\n    else if (this.keysPressed.has('Digit8')) this.currentState.weaponSlot = 8;\r\n    else if (this.keysPressed.has('Digit9')) this.currentState.weaponSlot = 9;\r\n    else if (this.keysPressed.has('Digit0')) this.currentState.weaponSlot = 10;\r\n    else if (this.mouseWheelDelta !== 0) {\r\n      // Mouse wheel weapon cycling\r\n      // deltaY > 0 = scroll down = next weapon, deltaY < 0 = scroll up = previous weapon\r\n      this.currentState.weaponSlot = this.mouseWheelDelta > 0 ? -1 : -2; // -1 = next, -2 = previous\r\n      this.mouseWheelDelta = 0; // Reset after processing\r\n    }\r\n    \r\n    // Clear pressed states (they only last one frame)\r\n    this.keysPressed.clear();\r\n    this.mousePressed.clear();\r\n  }\r\n\r\n  getState(): InputState {\r\n    return { ...this.currentState };\r\n  }\r\n\r\n  wasPressed(action: keyof InputState): boolean {\r\n    return this.currentState[action] === true && this.previousState[action] === false;\r\n  }\r\n\r\n  wasReleased(action: keyof InputState): boolean {\r\n    return this.currentState[action] === false && this.previousState[action] === true;\r\n  }\r\n\r\n  isDown(action: keyof InputState): boolean {\r\n    return this.currentState[action] === true;\r\n  }\r\n\r\n  getMousePosition(): Vector2 {\r\n    return { ...this.mousePosition };\r\n  }\r\n\r\n  getMouseWorldPosition(): Vector2 {\r\n    return { ...this.mouseWorldPosition };\r\n  }\r\n\r\n  updateCamera(offset: Vector2, zoom: number): void {\r\n    this.cameraOffset = offset;\r\n    this.cameraZoom = zoom;\r\n    \r\n    // Recalculate world position\r\n    this.mouseWorldPosition = {\r\n      x: (this.mousePosition.x / this.cameraZoom) + this.cameraOffset.x,\r\n      y: (this.mousePosition.y / this.cameraZoom) + this.cameraOffset.y,\r\n    };\r\n  }\r\n\r\n  getNextSequence(): number {\r\n    return ++this.sequence;\r\n  }\r\n\r\n  setBindings(bindings: KeyBinding[]): void {\r\n    this.bindings = bindings;\r\n  }\r\n\r\n  /**\r\n   * Reset all input state - call this when transitioning between rounds\r\n   * to prevent held inputs from carrying over\r\n   */\r\n  resetAllInputs(): void {\r\n    this.keysDown.clear();\r\n    this.keysPressed.clear();\r\n    this.mouseDown.clear();\r\n    this.mousePressed.clear();\r\n    this.mouseWheelDelta = 0;\r\n    this.currentState = this.createEmptyState();\r\n    this.previousState = this.createEmptyState();\r\n  }\r\n\r\n  destroy(): void {\r\n    window.removeEventListener('keydown', this.onKeyDown);\r\n    window.removeEventListener('keyup', this.onKeyUp);\r\n    this.canvas.removeEventListener('mousedown', this.onMouseDown);\r\n    this.canvas.removeEventListener('mouseup', this.onMouseUp);\r\n    this.canvas.removeEventListener('mousemove', this.onMouseMove);\r\n  }\r\n}\r\n","// ============================================================================\r\n// CYBERGRID ASSAULT - SHARED TYPE DEFINITIONS\r\n// ============================================================================\r\n\r\n// ----------------------------------------------------------------------------\r\n// CORE PRIMITIVES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface Vector2 {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\nexport interface Rectangle {\r\n  x: number;\r\n  y: number;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface Circle {\r\n  x: number;\r\n  y: number;\r\n  radius: number;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// ENTITY SYSTEM\r\n// ----------------------------------------------------------------------------\r\n\r\nexport type EntityId = string;\r\n\r\nexport interface Entity {\r\n  id: EntityId;\r\n  type: EntityType;\r\n  position: Vector2;\r\n  rotation: number; // radians\r\n  active: boolean;\r\n}\r\n\r\nexport enum EntityType {\r\n  Player = 'player',\r\n  Projectile = 'projectile',\r\n  Pickup = 'pickup',\r\n  Trigger = 'trigger',\r\n  Prop = 'prop',\r\n  Drone = 'drone',\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// PLAYER & HERO\r\n// ----------------------------------------------------------------------------\r\n\r\nexport enum HeroId {\r\n  // Original heroes (keeping for backward compatibility, mapped to new roles)\r\n  Spectre = 'spectre',   // Recon role\r\n  Byte = 'byte',         // Tech/Cipher role  \r\n  Vanta = 'vanta',       // Tank/Titan role\r\n  Katana = 'katana',     // Assassin/Phantom role\r\n  Glyph = 'glyph',       // Vision/Utility\r\n  Spark = 'spark',       // Area Denial/Havoc role\r\n  Zero = 'zero',         // Sniper\r\n  Mira = 'mira',         // Medic/Support role\r\n  \r\n  // New hero aliases (for clarity in ability implementation)\r\n  Phantom = 'katana',    // Assassin - blink, invisibility\r\n  Titan = 'vanta',       // Tank - fortify, shockwave\r\n  Medic = 'mira',        // Support - heal, revive\r\n  Havoc = 'spark',       // Assault - grenade, minigun\r\n  Cipher = 'byte',       // Tech - hack, turret\r\n  Venom = 'glyph',       // Saboteur - poison (repurposing Glyph)\r\n  Aegis = 'zero',        // Guardian - barriers (repurposing Zero)\r\n}\r\n\r\nexport enum Team {\r\n  None = 0,\r\n  Attackers = 1,\r\n  Defenders = 2,\r\n}\r\n\r\nexport interface PlayerState {\r\n  id: EntityId;\r\n  name: string;\r\n  peerId: string;\r\n  team: Team;\r\n  heroId: HeroId;\r\n  position: Vector2;\r\n  velocity: Vector2;\r\n  rotation: number;\r\n  health: number;\r\n  maxHealth: number;\r\n  shield: number;\r\n  maxShield: number;\r\n  alive: boolean;\r\n  credits: number;\r\n  kills: number;\r\n  deaths: number;\r\n  assists: number;\r\n  weapon: WeaponState;\r\n  abilities: AbilityState[];\r\n  input: PlayerInput;\r\n}\r\n\r\nexport interface PlayerInput {\r\n  moveX: number; // -1 to 1\r\n  moveY: number; // -1 to 1\r\n  aimX: number;  // world position\r\n  aimY: number;  // world position\r\n  shoot: boolean;\r\n  reload: boolean;\r\n  ability1: boolean;\r\n  ability2: boolean;\r\n  ultimate: boolean;\r\n  interact: boolean;\r\n  weaponSlot: number;  // 0 = no switch, 1-10 = weapon slot\r\n  sequence: number; // for input ordering\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// WEAPONS\r\n// ----------------------------------------------------------------------------\r\n\r\nexport enum WeaponId {\r\n  BurstPistol = 'burst_pistol',\r\n  NeoSMG9 = 'neo_smg9',\r\n  PulseRifle = 'pulse_rifle',\r\n  ScatterShot = 'scatter_shot',\r\n  RailSniper = 'rail_sniper',\r\n  ShardLauncher = 'shard_launcher',\r\n  NanoRepeater = 'nano_repeater',\r\n  ArcWelder = 'arc_welder',\r\n  PhaseRepeater = 'phase_repeater',\r\n  PlasmaCannon = 'plasma_cannon',\r\n}\r\n\r\nexport interface WeaponState {\r\n  weaponId: WeaponId;\r\n  ammo: number;\r\n  maxAmmo: number;\r\n  reloading: boolean;\r\n  reloadEndTime: number;\r\n  lastFireTime: number;\r\n}\r\n\r\nexport interface WeaponDefinition {\r\n  id: WeaponId;\r\n  name: string;\r\n  price: number;\r\n  damage: number;\r\n  spread: number;         // radians\r\n  fireRate: number;       // shots per second\r\n  range: number;          // max distance\r\n  ammoCapacity: number;\r\n  reloadTime: number;     // ms\r\n  burstCount: number;     // 1 = single shot\r\n  burstDelay: number;     // ms between burst shots\r\n  projectileSpeed: number; // 0 = hitscan\r\n  headshotMultiplier: number;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// ABILITIES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface AbilityState {\r\n  abilityIndex: number; // 0 = passive, 1 = skill1, 2 = skill2, 3 = ultimate\r\n  cooldownEndTime: number;\r\n  charges: number;\r\n  active: boolean;\r\n  duration: number;\r\n  ultimateCharge: number; // Points accumulated toward ultimate\r\n}\r\n\r\nexport interface AbilityDefinition {\r\n  name: string;\r\n  description: string;\r\n  cooldown: number;      // ms\r\n  duration: number;      // ms (0 = instant)\r\n  charges: number;       // max charges\r\n  chargeTime: number;    // ms to restore one charge\r\n  isUltimate: boolean;\r\n  ultimateCost: number;  // points needed\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// GAME STATE\r\n// ----------------------------------------------------------------------------\r\n\r\nexport enum GamePhase {\r\n  Lobby = 'lobby',\r\n  HeroSelect = 'hero_select',\r\n  BuyPhase = 'buy_phase',\r\n  RoundActive = 'round_active',\r\n  RoundEnd = 'round_end',\r\n  MatchEnd = 'match_end',\r\n}\r\n\r\nexport enum GameMode {\r\n  DataSpikeAssault = 'data_spike',\r\n  ReactorEscort = 'reactor_escort',\r\n  NeonDeathmatch = 'deathmatch',\r\n}\r\n\r\nexport interface GameState {\r\n  phase: GamePhase;\r\n  mode: GameMode;\r\n  mapId: string;\r\n  tick: number;\r\n  time: number;           // absolute game time in ms\r\n  roundStartTime: number; // when current round started (for timer calc)\r\n  roundNumber: number;\r\n  maxRounds: number;\r\n  roundTimeLimit: number; // ms\r\n  attackerScore: number;\r\n  defenderScore: number;\r\n  players: Map<EntityId, PlayerState>;\r\n  projectiles: Map<EntityId, ProjectileState>;\r\n  objectives: ObjectiveState;\r\n  // Recent shots for bullet tracer visualization on clients\r\n  recentShots?: Array<{\r\n    start: { x: number; y: number };\r\n    end: { x: number; y: number };\r\n    shooterId: EntityId;\r\n    shooterPeerId: string;\r\n  }>;\r\n  // Countdown between rounds\r\n  countdownTime?: number;  // Remaining countdown in ms (10000 = 10 seconds)\r\n  countdownPaused?: boolean;\r\n  countdownPausedBy?: string; // Player name who paused\r\n}\r\n\r\nexport interface ProjectileState {\r\n  id: EntityId;\r\n  ownerId: EntityId;\r\n  position: Vector2;\r\n  velocity: Vector2;\r\n  damage: number;\r\n  lifetime: number;\r\n  spawnTime: number;\r\n}\r\n\r\nexport interface ObjectiveState {\r\n  // Data Spike\r\n  spikeCarrierId: EntityId | null;\r\n  spikePlanted: boolean;\r\n  spikeSite: number; // 0, 1, etc. (-1 = not planted)\r\n  spikePlantTime: number;\r\n  spikeProgress: number; // 0-1 (upload progress after planted)\r\n  spikePosition: Vector2 | null; // Position where spike is planted\r\n  \r\n  // Planting/Defusing progress\r\n  plantingPlayerId: EntityId | null;\r\n  plantingPeerId: string | null; // PeerId for network sync (entity IDs differ between host/client)\r\n  plantingProgress: number; // 0-1\r\n  defusingPlayerId: EntityId | null;\r\n  defusingPeerId: string | null; // PeerId for network sync (entity IDs differ between host/client)\r\n  defusingProgress: number; // 0-1\r\n\r\n  // Reactor Escort\r\n  reactorPosition: Vector2;\r\n  reactorProgress: number; // 0-1\r\n  reactorContested: boolean;\r\n  reactorPushers: number;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// NETWORKING\r\n// ----------------------------------------------------------------------------\r\n\r\nexport enum PacketType {\r\n  // Connection\r\n  Handshake = 0,\r\n  HandshakeAck = 1,\r\n  Disconnect = 2,\r\n  Ping = 3,\r\n  Pong = 4,\r\n\r\n  // Lobby\r\n  LobbyState = 10,\r\n  PlayerJoin = 11,\r\n  PlayerLeave = 12,\r\n  PlayerReady = 13,\r\n  TeamChange = 14,\r\n  HeroSelect = 15,\r\n  GameStart = 16,\r\n\r\n  // Gameplay\r\n  Input = 20,\r\n  StateSnapshot = 21,\r\n  StateDelta = 22,\r\n  Event = 23,\r\n\r\n  // Events\r\n  PlayerDamage = 30,\r\n  PlayerKill = 31,\r\n  AbilityUse = 32,\r\n  WeaponFire = 33,\r\n  Reload = 34,\r\n  SpikePlant = 35,\r\n  SpikeDefuse = 36,\r\n  RoundEnd = 37,\r\n\r\n  // Countdown control\r\n  CountdownPause = 40,\r\n  CountdownResume = 41,\r\n\r\n  // Game pause (tab focus)\r\n  GamePause = 50,\r\n  GameResume = 51,\r\n}\r\n\r\nexport interface Packet {\r\n  type: PacketType;\r\n  timestamp: number;\r\n  senderId: string;\r\n  data: unknown;\r\n}\r\n\r\nexport interface InputPacket extends Packet {\r\n  type: PacketType.Input;\r\n  data: PlayerInput;\r\n}\r\n\r\nexport interface StateSnapshotPacket extends Packet {\r\n  type: PacketType.StateSnapshot;\r\n  data: {\r\n    tick: number;\r\n    players: PlayerState[];\r\n    projectiles: ProjectileState[];\r\n    objectives: ObjectiveState;\r\n  };\r\n}\r\n\r\nexport interface EventPacket extends Packet {\r\n  type: PacketType.Event;\r\n  data: GameEvent;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// GAME EVENTS\r\n// ----------------------------------------------------------------------------\r\n\r\nexport enum GameEventType {\r\n  PlayerDamage = 'player_damage',\r\n  PlayerKill = 'player_kill',\r\n  PlayerRespawn = 'player_respawn',\r\n  AbilityUsed = 'ability_used',\r\n  WeaponFired = 'weapon_fired',\r\n  SpikePlanted = 'spike_planted',\r\n  SpikeDefused = 'spike_defused',\r\n  RoundStarted = 'round_started',\r\n  RoundEnded = 'round_ended',\r\n}\r\n\r\nexport interface GameEvent {\r\n  type: GameEventType;\r\n  tick: number;\r\n  data: unknown;\r\n}\r\n\r\nexport interface DamageEvent extends GameEvent {\r\n  type: GameEventType.PlayerDamage;\r\n  data: {\r\n    targetId: EntityId;\r\n    attackerId: EntityId;\r\n    damage: number;\r\n    position: Vector2;\r\n    isHeadshot: boolean;\r\n  };\r\n}\r\n\r\nexport interface KillEvent extends GameEvent {\r\n  type: GameEventType.PlayerKill;\r\n  data: {\r\n    victimId: EntityId;\r\n    killerId: EntityId;\r\n    weaponId: WeaponId;\r\n    isHeadshot: boolean;\r\n  };\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// MAP DATA\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface MapData {\r\n  id: string;\r\n  name: string;\r\n  width: number;\r\n  height: number;\r\n  tileSize: number;\r\n  tiles: number[][];          // collision layer\r\n  spawnPoints: SpawnPoint[];\r\n  spikeSites: Rectangle[];\r\n  reactorPath: Vector2[];\r\n  props: PropData[];\r\n}\r\n\r\nexport interface SpawnPoint {\r\n  position: Vector2;\r\n  team: Team;\r\n  index: number;\r\n}\r\n\r\nexport interface PropData {\r\n  id: string;\r\n  type: string;\r\n  position: Vector2;\r\n  rotation: number;\r\n  collider?: Rectangle;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// CONFIGURATION\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface GameConfig {\r\n  // Display\r\n  canvasWidth: number;\r\n  canvasHeight: number;\r\n  targetFPS: number;\r\n\r\n  // Simulation\r\n  tickRate: number;           // server ticks per second\r\n  snapshotRate: number;       // snapshots per second\r\n  inputSendRate: number;      // inputs per second\r\n\r\n  // Gameplay\r\n  roundTimeLimit: number;     // ms\r\n  buyPhaseTime: number;       // ms\r\n  respawnTime: number;        // ms\r\n  spikeUploadTime: number;    // ms\r\n  spikePlantTime: number;     // ms\r\n  spikeDefuseTime: number;    // ms\r\n\r\n  // Movement\r\n  playerSpeed: number;        // units per second\r\n  playerAcceleration: number;\r\n  playerFriction: number;\r\n\r\n  // Combat\r\n  headshotMultiplier: number;\r\n  friendlyFire: boolean;\r\n}\r\n\r\n// Default config\r\nexport const DEFAULT_CONFIG: GameConfig = {\r\n  canvasWidth: 1280,\r\n  canvasHeight: 720,\r\n  targetFPS: 60,\r\n\r\n  tickRate: 20,\r\n  snapshotRate: 10,\r\n  inputSendRate: 20,\r\n\r\n  roundTimeLimit: 180000,     // 3 minutes\r\n  buyPhaseTime: 30000,        // 30 seconds\r\n  respawnTime: 5000,\r\n  spikeUploadTime: 45000,\r\n  spikePlantTime: 3000,\r\n  spikeDefuseTime: 5000,\r\n\r\n  playerSpeed: 200,\r\n  playerAcceleration: 1500,\r\n  playerFriction: 800,\r\n\r\n  headshotMultiplier: 2.0,\r\n  friendlyFire: false,\r\n};\r\n","// ============================================================================\r\n// SHARED CONSTANTS\r\n// ============================================================================\r\n\r\nimport { WeaponDefinition, WeaponId, HeroId, AbilityDefinition } from './types';\r\n\r\n// ----------------------------------------------------------------------------\r\n// COLORS (Cyberpunk Theme)\r\n// ----------------------------------------------------------------------------\r\n\r\nexport const COLORS = {\r\n  // Primary palette\r\n  CYAN: '#0CE5F0',\r\n  MAGENTA: '#F02BFF',\r\n  YELLOW: '#FFE500',\r\n  \r\n  // UI colors\r\n  BACKGROUND: '#0a0a12',\r\n  PANEL: '#12121a',\r\n  PANEL_BORDER: '#1a1a2e',\r\n  \r\n  // Team colors\r\n  ATTACKER: '#FF4444',\r\n  DEFENDER: '#44AAFF',\r\n  \r\n  // Health/Shield\r\n  HEALTH: '#44FF44',\r\n  SHIELD: '#44AAFF',\r\n  DAMAGE: '#FF4444',\r\n  \r\n  // Text\r\n  TEXT_PRIMARY: '#FFFFFF',\r\n  TEXT_SECONDARY: '#AAAAAA',\r\n  TEXT_ACCENT: '#0CE5F0',\r\n} as const;\r\n\r\n// ----------------------------------------------------------------------------\r\n// WEAPON DEFINITIONS\r\n// ----------------------------------------------------------------------------\r\n\r\nexport const WEAPONS: Record<WeaponId, WeaponDefinition> = {\r\n  [WeaponId.BurstPistol]: {\r\n    id: WeaponId.BurstPistol,\r\n    name: 'Burst Pistol',\r\n    price: 0,\r\n    damage: 25,\r\n    spread: 0.02,\r\n    fireRate: 4,\r\n    range: 800,\r\n    ammoCapacity: 15,\r\n    reloadTime: 1500,\r\n    burstCount: 3,\r\n    burstDelay: 60,\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 1.5,\r\n  },\r\n  [WeaponId.NeoSMG9]: {\r\n    id: WeaponId.NeoSMG9,\r\n    name: 'Neo SMG-9',\r\n    price: 1100,\r\n    damage: 18,\r\n    spread: 0.06,\r\n    fireRate: 12,\r\n    range: 600,\r\n    ammoCapacity: 30,\r\n    reloadTime: 1800,\r\n    burstCount: 1,\r\n    burstDelay: 0,\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 1.3,\r\n  },\r\n  [WeaponId.PulseRifle]: {\r\n    id: WeaponId.PulseRifle,\r\n    name: 'Pulse Rifle',\r\n    price: 1500,\r\n    damage: 35,\r\n    spread: 0.03,\r\n    fireRate: 6,\r\n    range: 1000,\r\n    ammoCapacity: 25,\r\n    reloadTime: 2000,\r\n    burstCount: 1,\r\n    burstDelay: 0,\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 2.0,\r\n  },\r\n  [WeaponId.ScatterShot]: {\r\n    id: WeaponId.ScatterShot,\r\n    name: 'Scatter Shot',\r\n    price: 1400,\r\n    damage: 15, // per pellet\r\n    spread: 0.15,\r\n    fireRate: 1.2,\r\n    range: 300,\r\n    ammoCapacity: 6,\r\n    reloadTime: 2500,\r\n    burstCount: 8, // 8 pellets\r\n    burstDelay: 0, // all at once\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 1.5,\r\n  },\r\n  [WeaponId.RailSniper]: {\r\n    id: WeaponId.RailSniper,\r\n    name: 'Rail Sniper',\r\n    price: 2100,\r\n    damage: 120,\r\n    spread: 0.005,\r\n    fireRate: 0.8,\r\n    range: 2000,\r\n    ammoCapacity: 5,\r\n    reloadTime: 3000,\r\n    burstCount: 1,\r\n    burstDelay: 0,\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 2.5,\r\n  },\r\n  [WeaponId.ShardLauncher]: {\r\n    id: WeaponId.ShardLauncher,\r\n    name: 'Shard Launcher',\r\n    price: 600,\r\n    damage: 40,\r\n    spread: 0.01,\r\n    fireRate: 3,\r\n    range: 900,\r\n    ammoCapacity: 12,\r\n    reloadTime: 1800,\r\n    burstCount: 1,\r\n    burstDelay: 0,\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 1.8,\r\n  },\r\n  [WeaponId.NanoRepeater]: {\r\n    id: WeaponId.NanoRepeater,\r\n    name: 'Nano Repeater',\r\n    price: 900,\r\n    damage: 22,\r\n    spread: 0.05,\r\n    fireRate: 10,\r\n    range: 750,\r\n    ammoCapacity: 35,\r\n    reloadTime: 2200,\r\n    burstCount: 1,\r\n    burstDelay: 0,\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 1.4,\r\n  },\r\n  [WeaponId.ArcWelder]: {\r\n    id: WeaponId.ArcWelder,\r\n    name: 'Arc Welder',\r\n    price: 1300,\r\n    damage: 20,\r\n    spread: 0,\r\n    fireRate: 15,\r\n    range: 400,\r\n    ammoCapacity: 100,\r\n    reloadTime: 2500,\r\n    burstCount: 1,\r\n    burstDelay: 0,\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 1.2,\r\n  },\r\n  [WeaponId.PhaseRepeater]: {\r\n    id: WeaponId.PhaseRepeater,\r\n    name: 'Phase Repeater',\r\n    price: 1800,\r\n    damage: 28,\r\n    spread: 0.025,\r\n    fireRate: 7,\r\n    range: 1200,\r\n    ammoCapacity: 28,\r\n    reloadTime: 2300,\r\n    burstCount: 1,\r\n    burstDelay: 0,\r\n    projectileSpeed: 0,\r\n    headshotMultiplier: 1.6,\r\n  },\r\n  [WeaponId.PlasmaCannon]: {\r\n    id: WeaponId.PlasmaCannon,\r\n    name: 'Plasma Cannon',\r\n    price: 2800,\r\n    damage: 80,\r\n    spread: 0.01,\r\n    fireRate: 1.5,\r\n    range: 800,\r\n    ammoCapacity: 8,\r\n    reloadTime: 3500,\r\n    burstCount: 1,\r\n    burstDelay: 0,\r\n    projectileSpeed: 600,\r\n    headshotMultiplier: 1.0,\r\n  },\r\n};\r\n\r\n// ----------------------------------------------------------------------------\r\n// HERO DEFINITIONS\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface HeroDefinition {\r\n  id: HeroId;\r\n  name: string;\r\n  faction: string;\r\n  role: string;\r\n  health: number;\r\n  shield: number;\r\n  speed: number; // multiplier\r\n  abilities: [AbilityDefinition, AbilityDefinition, AbilityDefinition, AbilityDefinition];\r\n}\r\n\r\nexport const HEROES: Record<HeroId, HeroDefinition> = {\r\n  [HeroId.Spectre]: {\r\n    id: HeroId.Spectre,\r\n    name: 'Spectre',\r\n    faction: 'Vanta Syndicate',\r\n    role: 'Flanker / Scout',\r\n    health: 100,\r\n    shield: 0,\r\n    speed: 1.0,\r\n    abilities: [\r\n      { name: 'Ghost Protocol', description: '10% damage reduction', cooldown: 0, duration: 0, charges: 1, chargeTime: 0, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Cloak', description: 'Invisible for 2s', cooldown: 10000, duration: 2000, charges: 1, chargeTime: 10000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Reveal Pulse', description: 'Reveal enemies nearby 3s', cooldown: 14000, duration: 3000, charges: 1, chargeTime: 14000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Shadow Dive', description: 'Teleport behind enemy + 75 dmg', cooldown: 50000, duration: 0, charges: 1, chargeTime: 50000, isUltimate: true, ultimateCost: 6 },\r\n    ],\r\n  },\r\n  [HeroId.Byte]: {\r\n    id: HeroId.Byte,\r\n    name: 'Byte',\r\n    faction: 'Collapse Unit',\r\n    role: 'Control Specialist',\r\n    health: 100,\r\n    shield: 25,\r\n    speed: 0.95,\r\n    abilities: [\r\n      { name: 'Quick Recovery', description: '+25% shield regen speed', cooldown: 0, duration: 0, charges: 1, chargeTime: 0, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'EMP Pulse', description: 'AOE stun + slow 1.5s', cooldown: 12000, duration: 1500, charges: 1, chargeTime: 12000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Shock Trap', description: 'Slowing zone 5s', cooldown: 15000, duration: 5000, charges: 1, chargeTime: 15000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'System Crash', description: 'Large AOE stun + slow', cooldown: 60000, duration: 3000, charges: 1, chargeTime: 60000, isUltimate: true, ultimateCost: 7 },\r\n    ],\r\n  },\r\n  [HeroId.Vanta]: {\r\n    id: HeroId.Vanta,\r\n    name: 'Vanta',\r\n    faction: 'HelixCorp',\r\n    role: 'Tank / Frontline',\r\n    health: 120,\r\n    shield: 50,\r\n    speed: 0.85,\r\n    abilities: [\r\n      { name: 'Titan Armor', description: '+50 shield, 15% damage reduction', cooldown: 0, duration: 0, charges: 1, chargeTime: 0, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Energy Shield', description: 'Front barrier 3s, blocks bullets', cooldown: 10000, duration: 3000, charges: 1, chargeTime: 10000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Shockwave Slam', description: 'AOE stun + 30 dmg', cooldown: 14000, duration: 1000, charges: 1, chargeTime: 14000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Overclock', description: '40% DR + fire rate 5s', cooldown: 55000, duration: 4000, charges: 1, chargeTime: 55000, isUltimate: true, ultimateCost: 6 },\r\n    ],\r\n  },\r\n  [HeroId.Katana]: {\r\n    id: HeroId.Katana,\r\n    name: 'Katana',\r\n    faction: 'ArcLight Initiative',\r\n    role: 'Burst Assassin',\r\n    health: 90,\r\n    shield: 0,\r\n    speed: 1.15,\r\n    abilities: [\r\n      { name: 'Swift Strike', description: '+15% speed, +10% damage', cooldown: 0, duration: 0, charges: 1, chargeTime: 0, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Blink', description: 'Teleport 3 tiles forward', cooldown: 8000, duration: 200, charges: 2, chargeTime: 8000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Invisibility', description: 'Cloak for 4 seconds', cooldown: 12000, duration: 4000, charges: 1, chargeTime: 12000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Shadow Strike', description: 'Teleport behind enemy + 75 dmg', cooldown: 50000, duration: 0, charges: 1, chargeTime: 50000, isUltimate: true, ultimateCost: 6 },\r\n    ],\r\n  },\r\n  [HeroId.Glyph]: {\r\n    id: HeroId.Glyph,\r\n    name: 'Glyph',\r\n    faction: 'ArcLight Initiative',\r\n    role: 'Vision / Utility',\r\n    health: 100,\r\n    shield: 25,\r\n    speed: 1.0,\r\n    abilities: [\r\n      { name: 'Keen Eyes', description: '+10% damage (precision)', cooldown: 0, duration: 0, charges: 1, chargeTime: 0, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Poison Cloud', description: 'DOT zone 15dmg/tick 4s', cooldown: 10000, duration: 4000, charges: 1, chargeTime: 10000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Turret Deploy', description: 'Auto-attack turret 10s', cooldown: 14000, duration: 10000, charges: 1, chargeTime: 14000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Toxic Storm', description: 'Massive poison zone 5s', cooldown: 55000, duration: 5000, charges: 1, chargeTime: 55000, isUltimate: true, ultimateCost: 7 },\r\n    ],\r\n  },\r\n  [HeroId.Spark]: {\r\n    id: HeroId.Spark,\r\n    name: 'Spark',\r\n    faction: 'HelixCorp',\r\n    role: 'Area Denial',\r\n    health: 100,\r\n    shield: 25,\r\n    speed: 0.95,\r\n    abilities: [\r\n      { name: 'Fireproof', description: 'Fire immune, +10% fire rate', cooldown: 0, duration: 0, charges: 1, chargeTime: 0, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Fire Bottle', description: 'Burning zone 15dmg/tick', cooldown: 12000, duration: 4000, charges: 2, chargeTime: 12000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Minigun Mode', description: '+50% fire rate 4s', cooldown: 15000, duration: 4000, charges: 1, chargeTime: 15000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Napalm Strike', description: 'Huge fire zone 6s', cooldown: 55000, duration: 6000, charges: 1, chargeTime: 55000, isUltimate: true, ultimateCost: 7 },\r\n    ],\r\n  },\r\n  [HeroId.Zero]: {\r\n    id: HeroId.Zero,\r\n    name: 'Zero',\r\n    faction: 'Collapse Unit',\r\n    role: 'Sniper / Scout',\r\n    health: 90,\r\n    shield: 0,\r\n    speed: 1.0,\r\n    abilities: [\r\n      { name: 'Steady Aim', description: '+15% damage (sniper)', cooldown: 0, duration: 0, charges: 1, chargeTime: 0, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Mark Target', description: 'Reveal + 20% bonus dmg 5s', cooldown: 8000, duration: 5000, charges: 1, chargeTime: 8000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Dash Back', description: 'Quick backward escape', cooldown: 12000, duration: 200, charges: 1, chargeTime: 12000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Dome Shield', description: 'Team protection dome 3s', cooldown: 60000, duration: 3000, charges: 1, chargeTime: 60000, isUltimate: true, ultimateCost: 8 },\r\n    ],\r\n  },\r\n  [HeroId.Mira]: {\r\n    id: HeroId.Mira,\r\n    name: 'Mira',\r\n    faction: 'Independent',\r\n    role: 'Medic / Support',\r\n    health: 100,\r\n    shield: 25,\r\n    speed: 1.0,\r\n    abilities: [\r\n      { name: 'Combat Medic', description: '+25% healing received/given', cooldown: 0, duration: 0, charges: 1, chargeTime: 0, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Heal Field', description: 'Healing zone 10HP/tick 4s', cooldown: 10000, duration: 4000, charges: 1, chargeTime: 10000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Shield Burst', description: '+30 shields to allies', cooldown: 14000, duration: 3000, charges: 1, chargeTime: 14000, isUltimate: false, ultimateCost: 0 },\r\n      { name: 'Resync', description: 'Revive ally at 50% HP', cooldown: 60000, duration: 0, charges: 1, chargeTime: 60000, isUltimate: true, ultimateCost: 8 },\r\n    ],\r\n  },\r\n};\r\n\r\n// ----------------------------------------------------------------------------\r\n// NETWORK CONSTANTS\r\n// ----------------------------------------------------------------------------\r\n\r\nexport const NETWORK = {\r\n  // Signaling - Use localhost for development, replace for production\r\n  SIGNALING_SERVER: 'ws://localhost:8080',\r\n  \r\n  // Timing\r\n  TICK_RATE: 20,\r\n  SNAPSHOT_RATE: 10,\r\n  INPUT_RATE: 20,\r\n  PING_INTERVAL: 1000,\r\n  TIMEOUT_MS: 10000,\r\n  \r\n  // Buffers\r\n  INPUT_BUFFER_SIZE: 64,\r\n  SNAPSHOT_BUFFER_SIZE: 32,\r\n  INTERPOLATION_DELAY: 100, // ms\r\n} as const;\r\n\r\n// ----------------------------------------------------------------------------\r\n// GAMEPLAY CONSTANTS\r\n// ----------------------------------------------------------------------------\r\n\r\nexport const GAMEPLAY = {\r\n  // Round\r\n  ROUND_TIME: 180000,\r\n  BUY_TIME: 30000,\r\n  ROUNDS_TO_WIN: 7,\r\n  MAX_ROUNDS: 13,\r\n  \r\n  // Spike\r\n  SPIKE_PLANT_TIME: 3000,\r\n  SPIKE_DEFUSE_TIME: 5000,\r\n  SPIKE_UPLOAD_TIME: 45000,\r\n  \r\n  // Economy\r\n  STARTING_CREDITS: 800,\r\n  KILL_REWARD: 300,\r\n  ASSIST_REWARD: 100,\r\n  ROUND_WIN_REWARD: 3000,\r\n  ROUND_LOSS_REWARD: 1900,\r\n  LOSS_STREAK_BONUS: 500, // per consecutive loss\r\n  MAX_LOSS_STREAK: 4,\r\n  \r\n  // Combat\r\n  HEADSHOT_ZONE_RATIO: 0.3, // top 30% of hitbox\r\n  FRIENDLY_FIRE: false,\r\n  \r\n  // Movement\r\n  BASE_SPEED: 200,\r\n  ACCELERATION: 1500,\r\n  FRICTION: 800,\r\n} as const;\r\n","// ============================================================================\r\n// CANVAS RENDERER - 2D Rendering with Neon Effects\r\n// ============================================================================\r\n\r\nimport { Vector2, Rectangle } from '@/shared/types';\r\nimport { COLORS } from '@/shared/constants';\r\n\r\nexport interface RenderLayer {\r\n  name: string;\r\n  zIndex: number;\r\n  visible: boolean;\r\n}\r\n\r\nexport interface Sprite {\r\n  image: HTMLImageElement;\r\n  x: number;\r\n  y: number;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface DrawTextOptions {\r\n  font?: string;\r\n  size?: number;\r\n  color?: string;\r\n  align?: CanvasTextAlign;\r\n  baseline?: CanvasTextBaseline;\r\n  glow?: boolean;\r\n  glowColor?: string;\r\n  glowSize?: number;\r\n}\r\n\r\nexport interface DrawRectOptions {\r\n  fill?: string;\r\n  stroke?: string;\r\n  strokeWidth?: number;\r\n  glow?: boolean;\r\n  glowColor?: string;\r\n  glowSize?: number;\r\n  cornerRadius?: number;\r\n}\r\n\r\nexport interface DrawCircleOptions {\r\n  fill?: string;\r\n  stroke?: string;\r\n  strokeWidth?: number;\r\n  glow?: boolean;\r\n  glowColor?: string;\r\n  glowSize?: number;\r\n}\r\n\r\nexport interface DrawLineOptions {\r\n  color?: string;\r\n  width?: number;\r\n  glow?: boolean;\r\n  glowColor?: string;\r\n  glowSize?: number;\r\n  dash?: number[];\r\n}\r\n\r\nexport class Renderer {\r\n  private canvas: HTMLCanvasElement;\r\n  private ctx: CanvasRenderingContext2D;\r\n\r\n  // Camera\r\n  private cameraX = 0;\r\n  private cameraY = 0;\r\n  private cameraZoom = 1;\r\n  private cameraShake: Vector2 = { x: 0, y: 0 };\r\n\r\n  // Viewport\r\n  private viewportWidth: number;\r\n  private viewportHeight: number;\r\n\r\n  constructor(canvas: HTMLCanvasElement, width: number, height: number) {\r\n    this.canvas = canvas;\r\n    this.viewportWidth = width;\r\n    this.viewportHeight = height;\r\n\r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) throw new Error('Failed to get 2D context');\r\n    this.ctx = ctx;\r\n\r\n    // Set canvas size\r\n    this.resize(width, height);\r\n\r\n    // Default settings\r\n    this.ctx.imageSmoothingEnabled = false;\r\n  }\r\n\r\n  resize(width: number, height: number): void {\r\n    const dpr = window.devicePixelRatio || 1;\r\n    this.canvas.width = width * dpr;\r\n    this.canvas.height = height * dpr;\r\n    this.canvas.style.width = `${width}px`;\r\n    this.canvas.style.height = `${height}px`;\r\n    this.ctx.scale(dpr, dpr);\r\n    this.viewportWidth = width;\r\n    this.viewportHeight = height;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Camera\r\n  // -------------------------------------------------------------------------\r\n\r\n  setCamera(x: number, y: number, zoom = 1): void {\r\n    this.cameraX = x;\r\n    this.cameraY = y;\r\n    this.cameraZoom = zoom;\r\n  }\r\n\r\n  setCameraShake(x: number, y: number): void {\r\n    this.cameraShake = { x, y };\r\n  }\r\n\r\n  getCameraOffset(): Vector2 {\r\n    return {\r\n      x: this.cameraX - this.viewportWidth / 2 / this.cameraZoom + this.cameraShake.x,\r\n      y: this.cameraY - this.viewportHeight / 2 / this.cameraZoom + this.cameraShake.y,\r\n    };\r\n  }\r\n\r\n  getCameraZoom(): number {\r\n    return this.cameraZoom;\r\n  }\r\n\r\n  worldToScreen(worldPos: Vector2): Vector2 {\r\n    const offset = this.getCameraOffset();\r\n    return {\r\n      x: (worldPos.x - offset.x) * this.cameraZoom,\r\n      y: (worldPos.y - offset.y) * this.cameraZoom,\r\n    };\r\n  }\r\n\r\n  screenToWorld(screenPos: Vector2): Vector2 {\r\n    const offset = this.getCameraOffset();\r\n    return {\r\n      x: screenPos.x / this.cameraZoom + offset.x,\r\n      y: screenPos.y / this.cameraZoom + offset.y,\r\n    };\r\n  }\r\n\r\n  isInView(x: number, y: number, margin = 100): boolean {\r\n    const screen = this.worldToScreen({ x, y });\r\n    return (\r\n      screen.x >= -margin &&\r\n      screen.x <= this.viewportWidth + margin &&\r\n      screen.y >= -margin &&\r\n      screen.y <= this.viewportHeight + margin\r\n    );\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Frame Control\r\n  // -------------------------------------------------------------------------\r\n\r\n  beginFrame(): void {\r\n    this.ctx.save();\r\n    this.clear();\r\n  }\r\n\r\n  endFrame(): void {\r\n    this.ctx.restore();\r\n  }\r\n\r\n  beginWorld(): void {\r\n    this.ctx.save();\r\n    const offset = this.getCameraOffset();\r\n    this.ctx.scale(this.cameraZoom, this.cameraZoom);\r\n    this.ctx.translate(-offset.x, -offset.y);\r\n  }\r\n\r\n  endWorld(): void {\r\n    this.ctx.restore();\r\n  }\r\n\r\n  clear(color = COLORS.BACKGROUND): void {\r\n    this.ctx.fillStyle = color;\r\n    this.ctx.fillRect(0, 0, this.viewportWidth, this.viewportHeight);\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Basic Shapes\r\n  // -------------------------------------------------------------------------\r\n\r\n  drawRect(x: number, y: number, width: number, height: number, options: DrawRectOptions = {}): void {\r\n    const {\r\n      fill,\r\n      stroke,\r\n      strokeWidth = 1,\r\n      glow = false,\r\n      glowColor = COLORS.CYAN,\r\n      glowSize = 10,\r\n      cornerRadius = 0,\r\n    } = options;\r\n\r\n    this.ctx.save();\r\n\r\n    if (glow) {\r\n      this.ctx.shadowColor = glowColor;\r\n      this.ctx.shadowBlur = glowSize;\r\n    }\r\n\r\n    if (cornerRadius > 0) {\r\n      this.ctx.beginPath();\r\n      this.ctx.roundRect(x, y, width, height, cornerRadius);\r\n      if (fill) {\r\n        this.ctx.fillStyle = fill;\r\n        this.ctx.fill();\r\n      }\r\n      if (stroke) {\r\n        this.ctx.strokeStyle = stroke;\r\n        this.ctx.lineWidth = strokeWidth;\r\n        this.ctx.stroke();\r\n      }\r\n    } else {\r\n      if (fill) {\r\n        this.ctx.fillStyle = fill;\r\n        this.ctx.fillRect(x, y, width, height);\r\n      }\r\n      if (stroke) {\r\n        this.ctx.strokeStyle = stroke;\r\n        this.ctx.lineWidth = strokeWidth;\r\n        this.ctx.strokeRect(x, y, width, height);\r\n      }\r\n    }\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  drawCircle(x: number, y: number, radius: number, options: DrawCircleOptions = {}): void {\r\n    const {\r\n      fill,\r\n      stroke,\r\n      strokeWidth = 1,\r\n      glow = false,\r\n      glowColor = COLORS.CYAN,\r\n      glowSize = 10,\r\n    } = options;\r\n\r\n    this.ctx.save();\r\n\r\n    if (glow) {\r\n      this.ctx.shadowColor = glowColor;\r\n      this.ctx.shadowBlur = glowSize;\r\n    }\r\n\r\n    this.ctx.beginPath();\r\n    this.ctx.arc(x, y, radius, 0, Math.PI * 2);\r\n\r\n    if (fill) {\r\n      this.ctx.fillStyle = fill;\r\n      this.ctx.fill();\r\n    }\r\n    if (stroke) {\r\n      this.ctx.strokeStyle = stroke;\r\n      this.ctx.lineWidth = strokeWidth;\r\n      this.ctx.stroke();\r\n    }\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  drawArc(x: number, y: number, radius: number, startAngle: number, endAngle: number, options: DrawCircleOptions = {}): void {\r\n    const {\r\n      fill,\r\n      stroke,\r\n      strokeWidth = 1,\r\n      glow = false,\r\n      glowColor = COLORS.CYAN,\r\n      glowSize = 10,\r\n    } = options;\r\n\r\n    this.ctx.save();\r\n\r\n    if (glow) {\r\n      this.ctx.shadowColor = glowColor;\r\n      this.ctx.shadowBlur = glowSize;\r\n    }\r\n\r\n    this.ctx.beginPath();\r\n    this.ctx.arc(x, y, radius, startAngle, endAngle);\r\n\r\n    if (fill) {\r\n      this.ctx.fillStyle = fill;\r\n      this.ctx.fill();\r\n    }\r\n    if (stroke) {\r\n      this.ctx.strokeStyle = stroke;\r\n      this.ctx.lineWidth = strokeWidth;\r\n      this.ctx.stroke();\r\n    }\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  drawLine(x1: number, y1: number, x2: number, y2: number, options: DrawLineOptions = {}): void {\r\n    const {\r\n      color = COLORS.CYAN,\r\n      width = 1,\r\n      glow = false,\r\n      glowColor = COLORS.CYAN,\r\n      glowSize = 10,\r\n      dash = [],\r\n    } = options;\r\n\r\n    this.ctx.save();\r\n\r\n    if (glow) {\r\n      this.ctx.shadowColor = glowColor;\r\n      this.ctx.shadowBlur = glowSize;\r\n    }\r\n\r\n    this.ctx.strokeStyle = color;\r\n    this.ctx.lineWidth = width;\r\n    this.ctx.setLineDash(dash);\r\n\r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(x1, y1);\r\n    this.ctx.lineTo(x2, y2);\r\n    this.ctx.stroke();\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  drawPolygon(points: Vector2[], options: DrawRectOptions = {}): void {\r\n    if (points.length < 3) return;\r\n\r\n    const {\r\n      fill,\r\n      stroke,\r\n      strokeWidth = 1,\r\n      glow = false,\r\n      glowColor = COLORS.CYAN,\r\n      glowSize = 10,\r\n    } = options;\r\n\r\n    this.ctx.save();\r\n\r\n    if (glow) {\r\n      this.ctx.shadowColor = glowColor;\r\n      this.ctx.shadowBlur = glowSize;\r\n    }\r\n\r\n    this.ctx.beginPath();\r\n    this.ctx.moveTo(points[0]!.x, points[0]!.y);\r\n    for (let i = 1; i < points.length; i++) {\r\n      this.ctx.lineTo(points[i]!.x, points[i]!.y);\r\n    }\r\n    this.ctx.closePath();\r\n\r\n    if (fill) {\r\n      this.ctx.fillStyle = fill;\r\n      this.ctx.fill();\r\n    }\r\n    if (stroke) {\r\n      this.ctx.strokeStyle = stroke;\r\n      this.ctx.lineWidth = strokeWidth;\r\n      this.ctx.stroke();\r\n    }\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Text\r\n  // -------------------------------------------------------------------------\r\n\r\n  drawText(text: string, x: number, y: number, options: DrawTextOptions = {}): void {\r\n    const {\r\n      font = 'Segoe UI',\r\n      size = 14,\r\n      color = COLORS.TEXT_PRIMARY,\r\n      align = 'left',\r\n      baseline = 'top',\r\n      glow = false,\r\n      glowColor = COLORS.CYAN,\r\n      glowSize = 10,\r\n    } = options;\r\n\r\n    this.ctx.save();\r\n\r\n    if (glow) {\r\n      this.ctx.shadowColor = glowColor;\r\n      this.ctx.shadowBlur = glowSize;\r\n    }\r\n\r\n    this.ctx.font = `${size}px ${font}`;\r\n    this.ctx.fillStyle = color;\r\n    this.ctx.textAlign = align;\r\n    this.ctx.textBaseline = baseline;\r\n    this.ctx.fillText(text, x, y);\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  measureText(text: string, font: string, size: number): TextMetrics {\r\n    this.ctx.save();\r\n    this.ctx.font = `${size}px ${font}`;\r\n    const metrics = this.ctx.measureText(text);\r\n    this.ctx.restore();\r\n    return metrics;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Sprites\r\n  // -------------------------------------------------------------------------\r\n\r\n  drawSprite(sprite: Sprite, x: number, y: number, width?: number, height?: number): void {\r\n    const w = width ?? sprite.width;\r\n    const h = height ?? sprite.height;\r\n    this.ctx.drawImage(\r\n      sprite.image,\r\n      sprite.x,\r\n      sprite.y,\r\n      sprite.width,\r\n      sprite.height,\r\n      x,\r\n      y,\r\n      w,\r\n      h\r\n    );\r\n  }\r\n\r\n  drawImage(\r\n    image: HTMLImageElement | HTMLCanvasElement,\r\n    x: number,\r\n    y: number,\r\n    width?: number,\r\n    height?: number,\r\n    rotation = 0\r\n  ): void {\r\n    const w = width ?? image.width;\r\n    const h = height ?? image.height;\r\n\r\n    this.ctx.save();\r\n    this.ctx.translate(x + w / 2, y + h / 2);\r\n    this.ctx.rotate(rotation);\r\n    this.ctx.drawImage(image, -w / 2, -h / 2, w, h);\r\n    this.ctx.restore();\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Effects\r\n  // -------------------------------------------------------------------------\r\n\r\n  drawNeonRect(rect: Rectangle, color: string, intensity = 1): void {\r\n    const { x, y, width, height } = rect;\r\n    \r\n    // Outer glow\r\n    this.drawRect(x, y, width, height, {\r\n      stroke: color,\r\n      strokeWidth: 2,\r\n      glow: true,\r\n      glowColor: color,\r\n      glowSize: 15 * intensity,\r\n    });\r\n    \r\n    // Inner fill with transparency\r\n    this.drawRect(x + 2, y + 2, width - 4, height - 4, {\r\n      fill: `${color}22`,\r\n    });\r\n  }\r\n\r\n  drawHealthBar(\r\n    x: number,\r\n    y: number,\r\n    width: number,\r\n    height: number,\r\n    current: number,\r\n    max: number,\r\n    shield = 0,\r\n    maxShield = 0\r\n  ): void {\r\n    const healthPercent = Math.max(0, current / max);\r\n    const shieldPercent = maxShield > 0 ? Math.max(0, shield / maxShield) : 0;\r\n\r\n    // Background\r\n    this.drawRect(x, y, width, height, {\r\n      fill: '#000000AA',\r\n      stroke: '#333',\r\n      strokeWidth: 1,\r\n    });\r\n\r\n    // Health bar\r\n    if (healthPercent > 0) {\r\n      const healthWidth = (width - 2) * healthPercent;\r\n      this.drawRect(x + 1, y + 1, healthWidth, height - 2, {\r\n        fill: COLORS.HEALTH,\r\n      });\r\n    }\r\n\r\n    // Shield bar (on top)\r\n    if (shieldPercent > 0) {\r\n      const shieldWidth = (width - 2) * shieldPercent;\r\n      this.drawRect(x + 1, y + 1, shieldWidth, height - 2, {\r\n        fill: COLORS.SHIELD,\r\n      });\r\n    }\r\n  }\r\n\r\n  drawAbilityCooldown(\r\n    x: number,\r\n    y: number,\r\n    radius: number,\r\n    cooldownPercent: number,\r\n    icon?: HTMLImageElement\r\n  ): void {\r\n    // Background\r\n    this.drawCircle(x, y, radius, {\r\n      fill: '#222',\r\n      stroke: COLORS.CYAN,\r\n      strokeWidth: 2,\r\n    });\r\n\r\n    // Icon\r\n    if (icon) {\r\n      const iconSize = radius * 1.4;\r\n      this.drawImage(icon, x - iconSize / 2, y - iconSize / 2, iconSize, iconSize);\r\n    }\r\n\r\n    // Cooldown overlay\r\n    if (cooldownPercent > 0) {\r\n      this.ctx.save();\r\n      this.ctx.globalAlpha = 0.7;\r\n      this.ctx.fillStyle = '#000';\r\n      this.ctx.beginPath();\r\n      this.ctx.moveTo(x, y);\r\n      this.ctx.arc(\r\n        x,\r\n        y,\r\n        radius,\r\n        -Math.PI / 2,\r\n        -Math.PI / 2 + Math.PI * 2 * cooldownPercent,\r\n        false\r\n      );\r\n      this.ctx.closePath();\r\n      this.ctx.fill();\r\n      this.ctx.restore();\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Debug\r\n  // -------------------------------------------------------------------------\r\n\r\n  drawDebugGrid(cellSize: number, color = '#333'): void {\r\n    const offset = this.getCameraOffset();\r\n    const startX = Math.floor(offset.x / cellSize) * cellSize;\r\n    const startY = Math.floor(offset.y / cellSize) * cellSize;\r\n    const endX = offset.x + this.viewportWidth / this.cameraZoom + cellSize;\r\n    const endY = offset.y + this.viewportHeight / this.cameraZoom + cellSize;\r\n\r\n    this.ctx.save();\r\n    this.ctx.strokeStyle = color;\r\n    this.ctx.lineWidth = 0.5;\r\n\r\n    for (let x = startX; x <= endX; x += cellSize) {\r\n      this.drawLine(x, startY, x, endY, { color, width: 0.5 });\r\n    }\r\n    for (let y = startY; y <= endY; y += cellSize) {\r\n      this.drawLine(startX, y, endX, y, { color, width: 0.5 });\r\n    }\r\n\r\n    this.ctx.restore();\r\n  }\r\n\r\n  drawDebugPoint(x: number, y: number, color = COLORS.CYAN, label?: string): void {\r\n    this.drawCircle(x, y, 4, { fill: color });\r\n    if (label) {\r\n      this.drawText(label, x + 8, y - 8, { color, size: 10 });\r\n    }\r\n  }\r\n\r\n  drawDebugRect(rect: Rectangle, color = COLORS.CYAN, label?: string): void {\r\n    this.drawRect(rect.x, rect.y, rect.width, rect.height, {\r\n      stroke: color,\r\n      strokeWidth: 1,\r\n    });\r\n    if (label) {\r\n      this.drawText(label, rect.x, rect.y - 14, { color, size: 10 });\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Getters\r\n  // -------------------------------------------------------------------------\r\n\r\n  getWidth(): number {\r\n    return this.viewportWidth;\r\n  }\r\n\r\n  getHeight(): number {\r\n    return this.viewportHeight;\r\n  }\r\n\r\n  getContext(): CanvasRenderingContext2D {\r\n    return this.ctx;\r\n  }\r\n}\r\n","// ============================================================================\r\n// AUDIO MANAGER - Sound Effects and Music\r\n// ============================================================================\r\n\r\nexport interface SoundOptions {\r\n  volume?: number;\r\n  loop?: boolean;\r\n  pitch?: number;\r\n  offset?: number; // Start position in seconds\r\n}\r\n\r\nexport class AudioManager {\r\n  private context: AudioContext | null = null;\r\n  private masterVolume = 1;\r\n  private sfxVolume = 1;\r\n  private musicVolume = 0.5;\r\n  \r\n  private sounds = new Map<string, AudioBuffer>();\r\n  private activeSources = new Map<string, AudioBufferSourceNode>();\r\n  private activeGains = new Map<string, GainNode>(); // Track gain nodes for volume control\r\n  private currentMusic: AudioBufferSourceNode | null = null;\r\n  private currentMusicKey: string | null = null;\r\n\r\n  private initialized = false;\r\n\r\n  async init(): Promise<void> {\r\n    if (this.initialized) return;\r\n\r\n    try {\r\n      this.context = new AudioContext();\r\n      this.initialized = true;\r\n    } catch (e) {\r\n      console.warn('Web Audio API not supported:', e);\r\n    }\r\n  }\r\n\r\n  async loadSound(key: string, url: string): Promise<void> {\r\n    if (!this.context) return;\r\n\r\n    try {\r\n      const response = await fetch(url);\r\n      const arrayBuffer = await response.arrayBuffer();\r\n      const audioBuffer = await this.context.decodeAudioData(arrayBuffer);\r\n      this.sounds.set(key, audioBuffer);\r\n    } catch (e) {\r\n      console.warn(`Failed to load sound: ${key}`, e);\r\n    }\r\n  }\r\n\r\n  play(key: string, options: SoundOptions = {}): string | null {\r\n    if (!this.context || !this.sounds.has(key)) return null;\r\n\r\n    const buffer = this.sounds.get(key)!;\r\n    const source = this.context.createBufferSource();\r\n    source.buffer = buffer;\r\n\r\n    // Create gain node for volume\r\n    const gainNode = this.context.createGain();\r\n    gainNode.gain.value = (options.volume ?? 1) * this.sfxVolume * this.masterVolume;\r\n\r\n    // Connect nodes\r\n    source.connect(gainNode);\r\n    gainNode.connect(this.context.destination);\r\n\r\n    // Set options\r\n    source.loop = options.loop ?? false;\r\n    if (options.pitch) {\r\n      source.playbackRate.value = options.pitch;\r\n    }\r\n\r\n    // Generate unique ID\r\n    const id = `${key}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n    this.activeSources.set(id, source);\r\n    this.activeGains.set(id, gainNode);\r\n\r\n    // Clean up when finished\r\n    source.onended = () => {\r\n      this.activeSources.delete(id);\r\n      this.activeGains.delete(id);\r\n    };\r\n\r\n    // Start at offset if specified\r\n    const offset = options.offset ?? 0;\r\n    source.start(0, offset);\r\n    return id;\r\n  }\r\n\r\n  stop(id: string): void {\r\n    const source = this.activeSources.get(id);\r\n    if (source) {\r\n      source.stop();\r\n      this.activeSources.delete(id);\r\n      this.activeGains.delete(id);\r\n    }\r\n  }\r\n  \r\n  // Get duration of a loaded sound\r\n  getSoundDuration(key: string): number {\r\n    const buffer = this.sounds.get(key);\r\n    return buffer ? buffer.duration : 0;\r\n  }\r\n\r\n  playMusic(key: string, fadeIn = 0): void {\r\n    if (!this.context || !this.sounds.has(key)) return;\r\n    if (this.currentMusicKey === key) return;\r\n\r\n    // Stop current music\r\n    this.stopMusic(0.5);\r\n\r\n    const buffer = this.sounds.get(key)!;\r\n    const source = this.context.createBufferSource();\r\n    source.buffer = buffer;\r\n    source.loop = true;\r\n\r\n    const gainNode = this.context.createGain();\r\n    \r\n    if (fadeIn > 0) {\r\n      gainNode.gain.value = 0;\r\n      gainNode.gain.linearRampToValueAtTime(\r\n        this.musicVolume * this.masterVolume,\r\n        this.context.currentTime + fadeIn\r\n      );\r\n    } else {\r\n      gainNode.gain.value = this.musicVolume * this.masterVolume;\r\n    }\r\n\r\n    source.connect(gainNode);\r\n    gainNode.connect(this.context.destination);\r\n\r\n    source.start(0);\r\n    this.currentMusic = source;\r\n    this.currentMusicKey = key;\r\n  }\r\n\r\n  stopMusic(fadeOut = 0): void {\r\n    if (!this.currentMusic || !this.context) return;\r\n\r\n    const source = this.currentMusic;\r\n    \r\n    if (fadeOut > 0) {\r\n      const gainNode = this.context.createGain();\r\n      source.disconnect();\r\n      source.connect(gainNode);\r\n      gainNode.connect(this.context.destination);\r\n      gainNode.gain.linearRampToValueAtTime(0, this.context.currentTime + fadeOut);\r\n      \r\n      setTimeout(() => {\r\n        try {\r\n          source.stop();\r\n        } catch {\r\n          // Already stopped\r\n        }\r\n      }, fadeOut * 1000);\r\n    } else {\r\n      source.stop();\r\n    }\r\n\r\n    this.currentMusic = null;\r\n    this.currentMusicKey = null;\r\n  }\r\n\r\n  setMasterVolume(volume: number): void {\r\n    this.masterVolume = Math.max(0, Math.min(1, volume));\r\n  }\r\n\r\n  setSFXVolume(volume: number): void {\r\n    this.sfxVolume = Math.max(0, Math.min(1, volume));\r\n  }\r\n\r\n  setMusicVolume(volume: number): void {\r\n    this.musicVolume = Math.max(0, Math.min(1, volume));\r\n  }\r\n\r\n  // Resume audio context (needed after user interaction)\r\n  async resume(): Promise<void> {\r\n    if (this.context?.state === 'suspended') {\r\n      await this.context.resume();\r\n    }\r\n  }\r\n\r\n  suspend(): void {\r\n    this.context?.suspend();\r\n  }\r\n\r\n  stopAll(): void {\r\n    for (const [id] of this.activeSources) {\r\n      this.stop(id);\r\n    }\r\n    this.stopMusic();\r\n  }\r\n\r\n  isInitialized(): boolean {\r\n    return this.initialized;\r\n  }\r\n}\r\n","// ============================================================================\r\n// SHARED UTILITIES\r\n// ============================================================================\r\n\r\nimport { Vector2, Rectangle, Circle, EntityId } from './types';\r\n\r\n// ----------------------------------------------------------------------------\r\n// VECTOR MATH\r\n// ----------------------------------------------------------------------------\r\n\r\nexport const Vec2 = {\r\n  create(x = 0, y = 0): Vector2 {\r\n    return { x, y };\r\n  },\r\n\r\n  clone(v: Vector2): Vector2 {\r\n    return { x: v.x, y: v.y };\r\n  },\r\n\r\n  add(a: Vector2, b: Vector2): Vector2 {\r\n    return { x: a.x + b.x, y: a.y + b.y };\r\n  },\r\n\r\n  sub(a: Vector2, b: Vector2): Vector2 {\r\n    return { x: a.x - b.x, y: a.y - b.y };\r\n  },\r\n\r\n  mul(v: Vector2, scalar: number): Vector2 {\r\n    return { x: v.x * scalar, y: v.y * scalar };\r\n  },\r\n\r\n  div(v: Vector2, scalar: number): Vector2 {\r\n    if (scalar === 0) return { x: 0, y: 0 };\r\n    return { x: v.x / scalar, y: v.y / scalar };\r\n  },\r\n\r\n  dot(a: Vector2, b: Vector2): number {\r\n    return a.x * b.x + a.y * b.y;\r\n  },\r\n\r\n  cross(a: Vector2, b: Vector2): number {\r\n    return a.x * b.y - a.y * b.x;\r\n  },\r\n\r\n  length(v: Vector2): number {\r\n    return Math.sqrt(v.x * v.x + v.y * v.y);\r\n  },\r\n\r\n  lengthSquared(v: Vector2): number {\r\n    return v.x * v.x + v.y * v.y;\r\n  },\r\n\r\n  normalize(v: Vector2): Vector2 {\r\n    const len = Vec2.length(v);\r\n    if (len === 0) return { x: 0, y: 0 };\r\n    return { x: v.x / len, y: v.y / len };\r\n  },\r\n\r\n  distance(a: Vector2, b: Vector2): number {\r\n    const dx = b.x - a.x;\r\n    const dy = b.y - a.y;\r\n    return Math.sqrt(dx * dx + dy * dy);\r\n  },\r\n\r\n  distanceSquared(a: Vector2, b: Vector2): number {\r\n    const dx = b.x - a.x;\r\n    const dy = b.y - a.y;\r\n    return dx * dx + dy * dy;\r\n  },\r\n\r\n  angle(v: Vector2): number {\r\n    return Math.atan2(v.y, v.x);\r\n  },\r\n\r\n  fromAngle(angle: number, length = 1): Vector2 {\r\n    return {\r\n      x: Math.cos(angle) * length,\r\n      y: Math.sin(angle) * length,\r\n    };\r\n  },\r\n\r\n  rotate(v: Vector2, angle: number): Vector2 {\r\n    const cos = Math.cos(angle);\r\n    const sin = Math.sin(angle);\r\n    return {\r\n      x: v.x * cos - v.y * sin,\r\n      y: v.x * sin + v.y * cos,\r\n    };\r\n  },\r\n\r\n  lerp(a: Vector2, b: Vector2, t: number): Vector2 {\r\n    return {\r\n      x: a.x + (b.x - a.x) * t,\r\n      y: a.y + (b.y - a.y) * t,\r\n    };\r\n  },\r\n\r\n  clamp(v: Vector2, maxLength: number): Vector2 {\r\n    const len = Vec2.length(v);\r\n    if (len <= maxLength) return { x: v.x, y: v.y };\r\n    return Vec2.mul(Vec2.normalize(v), maxLength);\r\n  },\r\n\r\n  equals(a: Vector2, b: Vector2, epsilon = 0.0001): boolean {\r\n    return Math.abs(a.x - b.x) < epsilon && Math.abs(a.y - b.y) < epsilon;\r\n  },\r\n\r\n  zero(): Vector2 {\r\n    return { x: 0, y: 0 };\r\n  },\r\n};\r\n\r\n// ----------------------------------------------------------------------------\r\n// COLLISION DETECTION\r\n// ----------------------------------------------------------------------------\r\n\r\nexport const Collision = {\r\n  pointInRect(point: Vector2, rect: Rectangle): boolean {\r\n    return (\r\n      point.x >= rect.x &&\r\n      point.x <= rect.x + rect.width &&\r\n      point.y >= rect.y &&\r\n      point.y <= rect.y + rect.height\r\n    );\r\n  },\r\n\r\n  pointInCircle(point: Vector2, circle: Circle): boolean {\r\n    const dx = point.x - circle.x;\r\n    const dy = point.y - circle.y;\r\n    return dx * dx + dy * dy <= circle.radius * circle.radius;\r\n  },\r\n\r\n  rectIntersect(a: Rectangle, b: Rectangle): boolean {\r\n    return (\r\n      a.x < b.x + b.width &&\r\n      a.x + a.width > b.x &&\r\n      a.y < b.y + b.height &&\r\n      a.y + a.height > b.y\r\n    );\r\n  },\r\n\r\n  circleIntersect(a: Circle, b: Circle): boolean {\r\n    const dx = b.x - a.x;\r\n    const dy = b.y - a.y;\r\n    const radiusSum = a.radius + b.radius;\r\n    return dx * dx + dy * dy <= radiusSum * radiusSum;\r\n  },\r\n\r\n  circleRectIntersect(circle: Circle, rect: Rectangle): boolean {\r\n    const closestX = Math.max(rect.x, Math.min(circle.x, rect.x + rect.width));\r\n    const closestY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.height));\r\n    const dx = circle.x - closestX;\r\n    const dy = circle.y - closestY;\r\n    return dx * dx + dy * dy <= circle.radius * circle.radius;\r\n  },\r\n\r\n  lineIntersect(\r\n    p1: Vector2,\r\n    p2: Vector2,\r\n    p3: Vector2,\r\n    p4: Vector2\r\n  ): Vector2 | null {\r\n    const d = (p4.y - p3.y) * (p2.x - p1.x) - (p4.x - p3.x) * (p2.y - p1.y);\r\n    if (Math.abs(d) < 0.0001) return null;\r\n\r\n    const ua = ((p4.x - p3.x) * (p1.y - p3.y) - (p4.y - p3.y) * (p1.x - p3.x)) / d;\r\n    const ub = ((p2.x - p1.x) * (p1.y - p3.y) - (p2.y - p1.y) * (p1.x - p3.x)) / d;\r\n\r\n    if (ua >= 0 && ua <= 1 && ub >= 0 && ub <= 1) {\r\n      return {\r\n        x: p1.x + ua * (p2.x - p1.x),\r\n        y: p1.y + ua * (p2.y - p1.y),\r\n      };\r\n    }\r\n    return null;\r\n  },\r\n\r\n  lineRectIntersect(start: Vector2, end: Vector2, rect: Rectangle): Vector2 | null {\r\n    const edges = [\r\n      { p1: { x: rect.x, y: rect.y }, p2: { x: rect.x + rect.width, y: rect.y } },\r\n      { p1: { x: rect.x + rect.width, y: rect.y }, p2: { x: rect.x + rect.width, y: rect.y + rect.height } },\r\n      { p1: { x: rect.x + rect.width, y: rect.y + rect.height }, p2: { x: rect.x, y: rect.y + rect.height } },\r\n      { p1: { x: rect.x, y: rect.y + rect.height }, p2: { x: rect.x, y: rect.y } },\r\n    ];\r\n\r\n    let closest: Vector2 | null = null;\r\n    let closestDist = Infinity;\r\n\r\n    for (const edge of edges) {\r\n      const hit = this.lineIntersect(start, end, edge.p1, edge.p2);\r\n      if (hit) {\r\n        const dist = Vec2.distanceSquared(start, hit);\r\n        if (dist < closestDist) {\r\n          closestDist = dist;\r\n          closest = hit;\r\n        }\r\n      }\r\n    }\r\n\r\n    return closest;\r\n  },\r\n};\r\n\r\n// ----------------------------------------------------------------------------\r\n// ID GENERATION\r\n// ----------------------------------------------------------------------------\r\n\r\nlet idCounter = 0;\r\n\r\nexport function generateId(prefix = 'e'): EntityId {\r\n  return `${prefix}_${Date.now().toString(36)}_${(idCounter++).toString(36)}`;\r\n}\r\n\r\nexport function generateRoomCode(): string {\r\n  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';\r\n  let code = '';\r\n  for (let i = 0; i < 6; i++) {\r\n    code += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return code;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// MATH UTILITIES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport function clamp(value: number, min: number, max: number): number {\r\n  return Math.max(min, Math.min(max, value));\r\n}\r\n\r\nexport function lerp(a: number, b: number, t: number): number {\r\n  return a + (b - a) * t;\r\n}\r\n\r\nexport function inverseLerp(a: number, b: number, value: number): number {\r\n  if (a === b) return 0;\r\n  return (value - a) / (b - a);\r\n}\r\n\r\nexport function remap(\r\n  value: number,\r\n  inMin: number,\r\n  inMax: number,\r\n  outMin: number,\r\n  outMax: number\r\n): number {\r\n  const t = inverseLerp(inMin, inMax, value);\r\n  return lerp(outMin, outMax, t);\r\n}\r\n\r\nexport function randomRange(min: number, max: number): number {\r\n  return min + Math.random() * (max - min);\r\n}\r\n\r\nexport function randomInt(min: number, max: number): number {\r\n  return Math.floor(randomRange(min, max + 1));\r\n}\r\n\r\nexport function degToRad(degrees: number): number {\r\n  return degrees * (Math.PI / 180);\r\n}\r\n\r\nexport function radToDeg(radians: number): number {\r\n  return radians * (180 / Math.PI);\r\n}\r\n\r\nexport function normalizeAngle(angle: number): number {\r\n  while (angle < -Math.PI) angle += Math.PI * 2;\r\n  while (angle > Math.PI) angle -= Math.PI * 2;\r\n  return angle;\r\n}\r\n\r\nexport function angleDifference(a: number, b: number): number {\r\n  return normalizeAngle(b - a);\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// TIME UTILITIES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport function formatTime(ms: number): string {\r\n  const totalSeconds = Math.floor(ms / 1000);\r\n  const minutes = Math.floor(totalSeconds / 60);\r\n  const seconds = totalSeconds % 60;\r\n  return `${minutes}:${seconds.toString().padStart(2, '0')}`;\r\n}\r\n\r\nexport function now(): number {\r\n  return performance.now();\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// OBJECT UTILITIES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport function deepClone<T>(obj: T): T {\r\n  return JSON.parse(JSON.stringify(obj));\r\n}\r\n\r\nexport function pick<T extends object, K extends keyof T>(\r\n  obj: T,\r\n  keys: K[]\r\n): Pick<T, K> {\r\n  const result = {} as Pick<T, K>;\r\n  for (const key of keys) {\r\n    if (key in obj) {\r\n      result[key] = obj[key];\r\n    }\r\n  }\r\n  return result;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// ARRAY UTILITIES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport function shuffleArray<T>(array: T[]): T[] {\r\n  const result = [...array];\r\n  for (let i = result.length - 1; i > 0; i--) {\r\n    const j = Math.floor(Math.random() * (i + 1));\r\n    [result[i], result[j]] = [result[j]!, result[i]!];\r\n  }\r\n  return result;\r\n}\r\n\r\nexport function removeFromArray<T>(array: T[], item: T): boolean {\r\n  const index = array.indexOf(item);\r\n  if (index !== -1) {\r\n    array.splice(index, 1);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n","// ============================================================================\r\n// COLLISION SYSTEM - Spatial Partitioning and Detection\r\n// ============================================================================\r\n\r\nimport { Vector2, Rectangle, EntityId } from '@/shared/types';\r\nimport { Vec2, Collision } from '@/shared/utils';\r\n\r\n// ----------------------------------------------------------------------------\r\n// Collider Types\r\n// ----------------------------------------------------------------------------\r\n\r\nexport enum ColliderType {\r\n  Circle = 'circle',\r\n  Box = 'box',\r\n}\r\n\r\nexport interface CircleCollider {\r\n  type: ColliderType.Circle;\r\n  offset: Vector2;\r\n  radius: number;\r\n}\r\n\r\nexport interface BoxCollider {\r\n  type: ColliderType.Box;\r\n  offset: Vector2;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport type Collider = CircleCollider | BoxCollider;\r\n\r\nexport interface CollisionBody {\r\n  id: EntityId;\r\n  position: Vector2;\r\n  velocity: Vector2;\r\n  collider: Collider;\r\n  layer: number;       // What layer this body is on\r\n  mask: number;        // What layers this body collides with\r\n  isStatic: boolean;\r\n  isTrigger: boolean;  // Don't resolve collision, just detect\r\n  userData?: unknown;\r\n}\r\n\r\nexport interface CollisionResult {\r\n  bodyA: CollisionBody;\r\n  bodyB: CollisionBody;\r\n  normal: Vector2;\r\n  depth: number;\r\n  point: Vector2;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// Collision Layers\r\n// ----------------------------------------------------------------------------\r\n\r\nexport const CollisionLayers = {\r\n  NONE: 0,\r\n  PLAYER: 1 << 0,\r\n  ENEMY: 1 << 1,\r\n  PROJECTILE: 1 << 2,\r\n  WALL: 1 << 3,\r\n  TRIGGER: 1 << 4,\r\n  PICKUP: 1 << 5,\r\n  ALL: 0xFFFFFFFF,\r\n} as const;\r\n\r\n// ----------------------------------------------------------------------------\r\n// Spatial Hash Grid\r\n// ----------------------------------------------------------------------------\r\n\r\nexport class SpatialHashGrid {\r\n  private cellSize: number;\r\n  private cells = new Map<string, Set<EntityId>>();\r\n  private bodyPositions = new Map<EntityId, string[]>();\r\n\r\n  constructor(cellSize = 128) {\r\n    this.cellSize = cellSize;\r\n  }\r\n\r\n  private getCellsForBody(body: CollisionBody): string[] {\r\n    const bounds = this.getBodyBounds(body);\r\n    const keys: string[] = [];\r\n\r\n    const minCX = Math.floor(bounds.x / this.cellSize);\r\n    const minCY = Math.floor(bounds.y / this.cellSize);\r\n    const maxCX = Math.floor((bounds.x + bounds.width) / this.cellSize);\r\n    const maxCY = Math.floor((bounds.y + bounds.height) / this.cellSize);\r\n\r\n    for (let cx = minCX; cx <= maxCX; cx++) {\r\n      for (let cy = minCY; cy <= maxCY; cy++) {\r\n        keys.push(`${cx},${cy}`);\r\n      }\r\n    }\r\n\r\n    return keys;\r\n  }\r\n\r\n  private getBodyBounds(body: CollisionBody): Rectangle {\r\n    if (body.collider.type === ColliderType.Circle) {\r\n      const c = body.collider;\r\n      return {\r\n        x: body.position.x + c.offset.x - c.radius,\r\n        y: body.position.y + c.offset.y - c.radius,\r\n        width: c.radius * 2,\r\n        height: c.radius * 2,\r\n      };\r\n    } else {\r\n      const c = body.collider;\r\n      return {\r\n        x: body.position.x + c.offset.x,\r\n        y: body.position.y + c.offset.y,\r\n        width: c.width,\r\n        height: c.height,\r\n      };\r\n    }\r\n  }\r\n\r\n  insert(body: CollisionBody): void {\r\n    this.remove(body.id);\r\n\r\n    const cellKeys = this.getCellsForBody(body);\r\n    this.bodyPositions.set(body.id, cellKeys);\r\n\r\n    for (const key of cellKeys) {\r\n      if (!this.cells.has(key)) {\r\n        this.cells.set(key, new Set());\r\n      }\r\n      this.cells.get(key)!.add(body.id);\r\n    }\r\n  }\r\n\r\n  remove(id: EntityId): void {\r\n    const cellKeys = this.bodyPositions.get(id);\r\n    if (cellKeys) {\r\n      for (const key of cellKeys) {\r\n        this.cells.get(key)?.delete(id);\r\n      }\r\n      this.bodyPositions.delete(id);\r\n    }\r\n  }\r\n\r\n  update(body: CollisionBody): void {\r\n    this.insert(body);\r\n  }\r\n\r\n  query(bounds: Rectangle): Set<EntityId> {\r\n    const result = new Set<EntityId>();\r\n\r\n    const minCX = Math.floor(bounds.x / this.cellSize);\r\n    const minCY = Math.floor(bounds.y / this.cellSize);\r\n    const maxCX = Math.floor((bounds.x + bounds.width) / this.cellSize);\r\n    const maxCY = Math.floor((bounds.y + bounds.height) / this.cellSize);\r\n\r\n    for (let cx = minCX; cx <= maxCX; cx++) {\r\n      for (let cy = minCY; cy <= maxCY; cy++) {\r\n        const cell = this.cells.get(`${cx},${cy}`);\r\n        if (cell) {\r\n          for (const id of cell) {\r\n            result.add(id);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  getNearby(body: CollisionBody): Set<EntityId> {\r\n    const bounds = this.getBodyBounds(body);\r\n    // Expand bounds slightly\r\n    bounds.x -= this.cellSize;\r\n    bounds.y -= this.cellSize;\r\n    bounds.width += this.cellSize * 2;\r\n    bounds.height += this.cellSize * 2;\r\n\r\n    const nearby = this.query(bounds);\r\n    nearby.delete(body.id);\r\n    return nearby;\r\n  }\r\n\r\n  clear(): void {\r\n    this.cells.clear();\r\n    this.bodyPositions.clear();\r\n  }\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// Collision World\r\n// ----------------------------------------------------------------------------\r\n\r\nexport class CollisionWorld {\r\n  private bodies = new Map<EntityId, CollisionBody>();\r\n  private spatialHash: SpatialHashGrid;\r\n  private collisions: CollisionResult[] = [];\r\n\r\n  constructor(cellSize = 128) {\r\n    this.spatialHash = new SpatialHashGrid(cellSize);\r\n  }\r\n\r\n  addBody(body: CollisionBody): void {\r\n    this.bodies.set(body.id, body);\r\n    this.spatialHash.insert(body);\r\n  }\r\n\r\n  removeBody(id: EntityId): void {\r\n    this.bodies.delete(id);\r\n    this.spatialHash.remove(id);\r\n  }\r\n\r\n  getBody(id: EntityId): CollisionBody | undefined {\r\n    return this.bodies.get(id);\r\n  }\r\n\r\n  updateBody(id: EntityId, position: Vector2, velocity?: Vector2): void {\r\n    const body = this.bodies.get(id);\r\n    if (body) {\r\n      body.position = position;\r\n      if (velocity) body.velocity = velocity;\r\n      this.spatialHash.update(body);\r\n    }\r\n  }\r\n\r\n  detectCollisions(): CollisionResult[] {\r\n    this.collisions = [];\r\n\r\n    for (const [id, bodyA] of this.bodies) {\r\n      const nearby = this.spatialHash.getNearby(bodyA);\r\n\r\n      for (const otherId of nearby) {\r\n        // Avoid duplicate checks\r\n        if (otherId <= id) continue;\r\n\r\n        const bodyB = this.bodies.get(otherId);\r\n        if (!bodyB) continue;\r\n\r\n        // Check layer masks\r\n        if ((bodyA.layer & bodyB.mask) === 0 && (bodyB.layer & bodyA.mask) === 0) {\r\n          continue;\r\n        }\r\n\r\n        // Check collision\r\n        const result = this.checkCollision(bodyA, bodyB);\r\n        if (result) {\r\n          this.collisions.push(result);\r\n        }\r\n      }\r\n    }\r\n\r\n    return this.collisions;\r\n  }\r\n\r\n  private checkCollision(bodyA: CollisionBody, bodyB: CollisionBody): CollisionResult | null {\r\n    const colliderA = bodyA.collider;\r\n    const colliderB = bodyB.collider;\r\n\r\n    const posA = Vec2.add(bodyA.position, colliderA.offset);\r\n    const posB = Vec2.add(bodyB.position, colliderB.offset);\r\n\r\n    // Circle vs Circle\r\n    if (colliderA.type === ColliderType.Circle && colliderB.type === ColliderType.Circle) {\r\n      const radiusSum = colliderA.radius + colliderB.radius;\r\n      const dist = Vec2.distance(posA, posB);\r\n\r\n      if (dist < radiusSum) {\r\n        const normal = Vec2.normalize(Vec2.sub(posB, posA));\r\n        const depth = radiusSum - dist;\r\n        const point = Vec2.add(posA, Vec2.mul(normal, colliderA.radius));\r\n\r\n        return { bodyA, bodyB, normal, depth, point };\r\n      }\r\n    }\r\n\r\n    // Box vs Box\r\n    if (colliderA.type === ColliderType.Box && colliderB.type === ColliderType.Box) {\r\n      const rectA: Rectangle = { x: posA.x, y: posA.y, width: colliderA.width, height: colliderA.height };\r\n      const rectB: Rectangle = { x: posB.x, y: posB.y, width: colliderB.width, height: colliderB.height };\r\n\r\n      if (Collision.rectIntersect(rectA, rectB)) {\r\n        // Calculate overlap and normal (simplified)\r\n        const overlapX = Math.min(rectA.x + rectA.width, rectB.x + rectB.width) - Math.max(rectA.x, rectB.x);\r\n        const overlapY = Math.min(rectA.y + rectA.height, rectB.y + rectB.height) - Math.max(rectA.y, rectB.y);\r\n\r\n        const centerA = { x: posA.x + colliderA.width / 2, y: posA.y + colliderA.height / 2 };\r\n        const centerB = { x: posB.x + colliderB.width / 2, y: posB.y + colliderB.height / 2 };\r\n        const diff = Vec2.sub(centerB, centerA);\r\n\r\n        let normal: Vector2;\r\n        let depth: number;\r\n\r\n        if (overlapX < overlapY) {\r\n          normal = { x: diff.x > 0 ? 1 : -1, y: 0 };\r\n          depth = overlapX;\r\n        } else {\r\n          normal = { x: 0, y: diff.y > 0 ? 1 : -1 };\r\n          depth = overlapY;\r\n        }\r\n\r\n        const point = { x: centerA.x + normal.x * (colliderA.width / 2), y: centerA.y + normal.y * (colliderA.height / 2) };\r\n\r\n        return { bodyA, bodyB, normal, depth, point };\r\n      }\r\n    }\r\n\r\n    // Circle vs Box\r\n    if (\r\n      (colliderA.type === ColliderType.Circle && colliderB.type === ColliderType.Box) ||\r\n      (colliderA.type === ColliderType.Box && colliderB.type === ColliderType.Circle)\r\n    ) {\r\n      const circleBody = colliderA.type === ColliderType.Circle ? bodyA : bodyB;\r\n      const boxBody = colliderA.type === ColliderType.Box ? bodyA : bodyB;\r\n      const circle = circleBody.collider as CircleCollider;\r\n      const box = boxBody.collider as BoxCollider;\r\n\r\n      const circlePos = Vec2.add(circleBody.position, circle.offset);\r\n      const boxPos = Vec2.add(boxBody.position, box.offset);\r\n\r\n      const rect: Rectangle = { x: boxPos.x, y: boxPos.y, width: box.width, height: box.height };\r\n\r\n      // Find closest point on box to circle center\r\n      const closestX = Math.max(rect.x, Math.min(circlePos.x, rect.x + rect.width));\r\n      const closestY = Math.max(rect.y, Math.min(circlePos.y, rect.y + rect.height));\r\n\r\n      const dx = circlePos.x - closestX;\r\n      const dy = circlePos.y - closestY;\r\n      const distSquared = dx * dx + dy * dy;\r\n      const radiusSquared = circle.radius * circle.radius;\r\n\r\n      // Check if circle center is inside the box\r\n      const centerInsideBox = \r\n        circlePos.x >= rect.x && circlePos.x <= rect.x + rect.width &&\r\n        circlePos.y >= rect.y && circlePos.y <= rect.y + rect.height;\r\n\r\n      if (centerInsideBox) {\r\n        // Circle center is inside box - find shortest escape direction\r\n        const leftDist = circlePos.x - rect.x;\r\n        const rightDist = (rect.x + rect.width) - circlePos.x;\r\n        const topDist = circlePos.y - rect.y;\r\n        const bottomDist = (rect.y + rect.height) - circlePos.y;\r\n        \r\n        const minDist = Math.min(leftDist, rightDist, topDist, bottomDist);\r\n        let normal: Vector2;\r\n        let depth: number;\r\n        \r\n        // Push OUT of the box (normal points away from box center)\r\n        if (minDist === leftDist) {\r\n          normal = { x: -1, y: 0 };\r\n          depth = leftDist + circle.radius;\r\n        } else if (minDist === rightDist) {\r\n          normal = { x: 1, y: 0 };\r\n          depth = rightDist + circle.radius;\r\n        } else if (minDist === topDist) {\r\n          normal = { x: 0, y: -1 };\r\n          depth = topDist + circle.radius;\r\n        } else {\r\n          normal = { x: 0, y: 1 };\r\n          depth = bottomDist + circle.radius;\r\n        }\r\n        \r\n        return {\r\n          bodyA: circleBody,\r\n          bodyB: boxBody,\r\n          normal,\r\n          depth,\r\n          point: { x: closestX, y: closestY },\r\n        };\r\n      } else if (distSquared < radiusSquared) {\r\n        // Circle overlaps box but center is outside\r\n        const dist = Math.sqrt(distSquared);\r\n        const depth = circle.radius - dist;\r\n        \r\n        // Normal points from closest point to circle center (pushing circle away)\r\n        const normal = dist > 0.0001 \r\n          ? { x: dx / dist, y: dy / dist }\r\n          : { x: 1, y: 0 }; // Fallback\r\n        \r\n        return {\r\n          bodyA: circleBody,\r\n          bodyB: boxBody,\r\n          normal,\r\n          depth,\r\n          point: { x: closestX, y: closestY },\r\n        };\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  resolveCollisions(): void {\r\n    // Sort collisions: static-dynamic first (walls), then dynamic-dynamic\r\n    // This ensures walls are resolved before player-player pushes\r\n    const sortedCollisions = [...this.collisions].sort((a, b) => {\r\n      const aHasStatic = a.bodyA.isStatic || a.bodyB.isStatic;\r\n      const bHasStatic = b.bodyA.isStatic || b.bodyB.isStatic;\r\n      if (aHasStatic && !bHasStatic) return -1;\r\n      if (!aHasStatic && bHasStatic) return 1;\r\n      return 0;\r\n    });\r\n    \r\n    for (const collision of sortedCollisions) {\r\n      const { bodyA, bodyB, normal, depth } = collision;\r\n\r\n      // Skip triggers\r\n      if (bodyA.isTrigger || bodyB.isTrigger) continue;\r\n      \r\n      // Skip if depth is invalid\r\n      if (depth <= 0 || !isFinite(depth)) continue;\r\n\r\n      // Normal points from bodyB toward bodyA\r\n      // So to separate: bodyA moves in +normal direction, bodyB moves in -normal direction\r\n      \r\n      if (bodyA.isStatic && !bodyB.isStatic) {\r\n        // bodyA is static (wall), push bodyB away (in -normal direction)\r\n        bodyB.position.x -= normal.x * depth;\r\n        bodyB.position.y -= normal.y * depth;\r\n        // Stop velocity toward the wall\r\n        const velDotNormal = bodyB.velocity.x * normal.x + bodyB.velocity.y * normal.y;\r\n        if (velDotNormal > 0) {\r\n          bodyB.velocity.x -= normal.x * velDotNormal;\r\n          bodyB.velocity.y -= normal.y * velDotNormal;\r\n        }\r\n      } else if (bodyB.isStatic && !bodyA.isStatic) {\r\n        // bodyB is static (wall), push bodyA away (in +normal direction)\r\n        bodyA.position.x += normal.x * depth;\r\n        bodyA.position.y += normal.y * depth;\r\n        // Stop velocity toward the wall\r\n        const velDotNormal = bodyA.velocity.x * normal.x + bodyA.velocity.y * normal.y;\r\n        if (velDotNormal < 0) {\r\n          bodyA.velocity.x -= normal.x * velDotNormal;\r\n          bodyA.velocity.y -= normal.y * velDotNormal;\r\n        }\r\n      } else if (!bodyA.isStatic && !bodyB.isStatic) {\r\n        // Both dynamic (player-player collision)\r\n        // Use smaller separation to reduce wall-clipping risk\r\n        const halfDepth = depth / 2;\r\n        \r\n        // Before moving, check if pushing into a wall (using velocity as indicator)\r\n        // Only separate if there's overlap, with reduced force\r\n        const separationScale = 0.8; // Don't fully separate - let next iteration handle it\r\n        bodyA.position.x += normal.x * halfDepth * separationScale;\r\n        bodyA.position.y += normal.y * halfDepth * separationScale;\r\n        bodyB.position.x -= normal.x * halfDepth * separationScale;\r\n        bodyB.position.y -= normal.y * halfDepth * separationScale;\r\n      }\r\n\r\n      // Update spatial hash\r\n      this.spatialHash.update(bodyA);\r\n      this.spatialHash.update(bodyB);\r\n    }\r\n  }\r\n\r\n  // Raycast\r\n  raycast(\r\n    origin: Vector2,\r\n    direction: Vector2,\r\n    maxDistance: number,\r\n    layerMask: number = CollisionLayers.ALL\r\n  ): { body: CollisionBody; point: Vector2; distance: number } | null {\r\n    const normalizedDir = Vec2.normalize(direction);\r\n    const end = Vec2.add(origin, Vec2.mul(normalizedDir, maxDistance));\r\n\r\n    let closest: { body: CollisionBody; point: Vector2; distance: number } | null = null;\r\n\r\n    for (const [, body] of this.bodies) {\r\n      if ((body.layer & layerMask) === 0) continue;\r\n\r\n      const collider = body.collider;\r\n      const pos = Vec2.add(body.position, collider.offset);\r\n\r\n      let hitPoint: Vector2 | null = null;\r\n\r\n      if (collider.type === ColliderType.Box) {\r\n        const rect: Rectangle = { x: pos.x, y: pos.y, width: collider.width, height: collider.height };\r\n        hitPoint = Collision.lineRectIntersect(origin, end, rect);\r\n      } else if (collider.type === ColliderType.Circle) {\r\n        // Line-circle intersection\r\n        hitPoint = this.lineCircleIntersection(origin, end, pos, collider.radius);\r\n      }\r\n\r\n      if (hitPoint) {\r\n        const distance = Vec2.distance(origin, hitPoint);\r\n        if (!closest || distance < closest.distance) {\r\n          closest = { body, point: hitPoint, distance };\r\n        }\r\n      }\r\n    }\r\n\r\n    return closest;\r\n  }\r\n\r\n  private lineCircleIntersection(\r\n    start: Vector2,\r\n    end: Vector2,\r\n    center: Vector2,\r\n    radius: number\r\n  ): Vector2 | null {\r\n    const d = Vec2.sub(end, start);\r\n    const f = Vec2.sub(start, center);\r\n\r\n    const a = Vec2.dot(d, d);\r\n    const b = 2 * Vec2.dot(f, d);\r\n    const c = Vec2.dot(f, f) - radius * radius;\r\n\r\n    let discriminant = b * b - 4 * a * c;\r\n    if (discriminant < 0) return null;\r\n\r\n    discriminant = Math.sqrt(discriminant);\r\n    const t1 = (-b - discriminant) / (2 * a);\r\n    const t2 = (-b + discriminant) / (2 * a);\r\n\r\n    if (t1 >= 0 && t1 <= 1) {\r\n      return Vec2.add(start, Vec2.mul(d, t1));\r\n    }\r\n    if (t2 >= 0 && t2 <= 1) {\r\n      return Vec2.add(start, Vec2.mul(d, t2));\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  getCollisions(): CollisionResult[] {\r\n    return this.collisions;\r\n  }\r\n\r\n  clear(): void {\r\n    this.bodies.clear();\r\n    this.spatialHash.clear();\r\n    this.collisions = [];\r\n  }\r\n}\r\n","// ============================================================================\r\n// SIMPLE EVENT EMITTER\r\n// ============================================================================\r\n\r\ntype EventCallback<T> = (data: T) => void;\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport class EventEmitter<Events extends Record<string, any>> {\r\n  private listeners = new Map<keyof Events, Set<EventCallback<unknown>>>();\r\n\r\n  on<K extends keyof Events>(event: K, callback: EventCallback<Events[K]>): void {\r\n    if (!this.listeners.has(event)) {\r\n      this.listeners.set(event, new Set());\r\n    }\r\n    this.listeners.get(event)!.add(callback as EventCallback<unknown>);\r\n  }\r\n\r\n  off<K extends keyof Events>(event: K, callback: EventCallback<Events[K]>): void {\r\n    this.listeners.get(event)?.delete(callback as EventCallback<unknown>);\r\n  }\r\n\r\n  emit<K extends keyof Events>(event: K, data: Events[K]): void {\r\n    const callbacks = this.listeners.get(event);\r\n    if (callbacks) {\r\n      for (const callback of callbacks) {\r\n        try {\r\n          callback(data);\r\n        } catch (e) {\r\n          console.error(`Error in event handler for ${String(event)}:`, e);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  once<K extends keyof Events>(event: K, callback: EventCallback<Events[K]>): void {\r\n    const wrapper = ((data: Events[K]) => {\r\n      this.off(event, wrapper);\r\n      callback(data);\r\n    }) as EventCallback<Events[K]>;\r\n    this.on(event, wrapper);\r\n  }\r\n\r\n  removeAllListeners<K extends keyof Events>(event?: K): void {\r\n    if (event) {\r\n      this.listeners.delete(event);\r\n    } else {\r\n      this.listeners.clear();\r\n    }\r\n  }\r\n}\r\n","// ============================================================================\r\n// WEBRTC PEER CONNECTION MANAGER\r\n// ============================================================================\r\n\r\nimport { EventEmitter } from './EventEmitter';\r\n\r\nexport interface PeerConfig {\r\n  iceServers?: RTCIceServer[];\r\n}\r\n\r\nexport interface PeerEvents {\r\n  connected: { peerId: string };\r\n  disconnected: { peerId: string };\r\n  message: { peerId: string; data: ArrayBuffer | string };\r\n  error: { peerId: string; error: Error };\r\n}\r\n\r\nconst DEFAULT_ICE_SERVERS: RTCIceServer[] = [\r\n  { urls: 'stun:stun.l.google.com:19302' },\r\n  { urls: 'stun:stun1.l.google.com:19302' },\r\n];\r\n\r\nexport class PeerConnection extends EventEmitter<PeerEvents> {\r\n  private peerId: string;\r\n  private connection: RTCPeerConnection;\r\n  private dataChannel: RTCDataChannel | null = null;\r\n  private isConnected = false;\r\n\r\n  constructor(peerId: string, config?: PeerConfig) {\r\n    super();\r\n    this.peerId = peerId;\r\n\r\n    this.connection = new RTCPeerConnection({\r\n      iceServers: config?.iceServers ?? DEFAULT_ICE_SERVERS,\r\n    });\r\n\r\n    this.setupConnectionListeners();\r\n  }\r\n\r\n  private setupConnectionListeners(): void {\r\n    this.connection.oniceconnectionstatechange = () => {\r\n      const state = this.connection.iceConnectionState;\r\n      console.log(`[Peer ${this.peerId}] ICE state: ${state}`);\r\n\r\n      if (state === 'connected') {\r\n        // Only emit connected once\r\n        if (!this.isConnected) {\r\n          this.isConnected = true;\r\n          this.emit('connected', { peerId: this.peerId });\r\n        }\r\n      } else if (state === 'disconnected' || state === 'failed' || state === 'closed') {\r\n        this.isConnected = false;\r\n        this.emit('disconnected', { peerId: this.peerId });\r\n      }\r\n    };\r\n\r\n    this.connection.ondatachannel = (event) => {\r\n      this.setupDataChannel(event.channel);\r\n    };\r\n  }\r\n\r\n  private setupDataChannel(channel: RTCDataChannel): void {\r\n    this.dataChannel = channel;\r\n    this.dataChannel.binaryType = 'arraybuffer';\r\n\r\n    this.dataChannel.onopen = () => {\r\n      console.log(`[Peer ${this.peerId}] Data channel opened`);\r\n    };\r\n\r\n    this.dataChannel.onclose = () => {\r\n      console.log(`[Peer ${this.peerId}] Data channel closed`);\r\n    };\r\n\r\n    this.dataChannel.onmessage = (event) => {\r\n      this.emit('message', { peerId: this.peerId, data: event.data });\r\n    };\r\n\r\n    this.dataChannel.onerror = (event) => {\r\n      this.emit('error', { peerId: this.peerId, error: new Error('Data channel error') });\r\n      console.error(`[Peer ${this.peerId}] Data channel error:`, event);\r\n    };\r\n  }\r\n\r\n  // Create offer (initiator)\r\n  async createOffer(): Promise<RTCSessionDescriptionInit> {\r\n    // Create data channel before offer\r\n    const channel = this.connection.createDataChannel('game', {\r\n      ordered: false,          // Unordered for speed\r\n      maxRetransmits: 0,       // No retransmits for real-time\r\n    });\r\n    this.setupDataChannel(channel);\r\n\r\n    const offer = await this.connection.createOffer();\r\n    await this.connection.setLocalDescription(offer);\r\n    return offer;\r\n  }\r\n\r\n  // Handle offer (receiver)\r\n  async handleOffer(offer: RTCSessionDescriptionInit): Promise<RTCSessionDescriptionInit> {\r\n    await this.connection.setRemoteDescription(offer);\r\n    const answer = await this.connection.createAnswer();\r\n    await this.connection.setLocalDescription(answer);\r\n    return answer;\r\n  }\r\n\r\n  // Handle answer (initiator)\r\n  async handleAnswer(answer: RTCSessionDescriptionInit): Promise<void> {\r\n    await this.connection.setRemoteDescription(answer);\r\n  }\r\n\r\n  // Add ICE candidate\r\n  async addIceCandidate(candidate: RTCIceCandidateInit): Promise<void> {\r\n    try {\r\n      await this.connection.addIceCandidate(candidate);\r\n    } catch (e) {\r\n      console.warn(`[Peer ${this.peerId}] Failed to add ICE candidate:`, e);\r\n    }\r\n  }\r\n\r\n  // Get ICE candidates\r\n  onIceCandidate(callback: (candidate: RTCIceCandidate) => void): void {\r\n    this.connection.onicecandidate = (event) => {\r\n      if (event.candidate) {\r\n        callback(event.candidate);\r\n      }\r\n    };\r\n  }\r\n\r\n  // Send data\r\n  send(data: ArrayBuffer | string): boolean {\r\n    if (!this.dataChannel || this.dataChannel.readyState !== 'open') {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      if (typeof data === 'string') {\r\n        this.dataChannel.send(data);\r\n      } else {\r\n        this.dataChannel.send(new Uint8Array(data));\r\n      }\r\n      return true;\r\n    } catch (e) {\r\n      console.error(`[Peer ${this.peerId}] Send failed:`, e);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Send with buffering check\r\n  sendIfReady(data: ArrayBuffer | string): boolean {\r\n    if (!this.dataChannel || this.dataChannel.readyState !== 'open') {\r\n      return false;\r\n    }\r\n\r\n    // Don't send if buffer is getting full\r\n    if (this.dataChannel.bufferedAmount > 65536) {\r\n      console.warn(`[Peer ${this.peerId}] Buffer full, skipping send`);\r\n      return false;\r\n    }\r\n\r\n    return this.send(data);\r\n  }\r\n\r\n  close(): void {\r\n    this.dataChannel?.close();\r\n    this.connection.close();\r\n    this.isConnected = false;\r\n  }\r\n\r\n  getPeerId(): string {\r\n    return this.peerId;\r\n  }\r\n\r\n  getIsConnected(): boolean {\r\n    return this.isConnected && this.dataChannel?.readyState === 'open';\r\n  }\r\n\r\n  getStats(): Promise<RTCStatsReport> {\r\n    return this.connection.getStats();\r\n  }\r\n}\r\n","// ============================================================================\r\n// SIGNALING CLIENT - WebSocket for WebRTC Signaling\r\n// ============================================================================\r\n\r\nimport { EventEmitter } from './EventEmitter';\r\n\r\nexport interface SignalingMessage {\r\n  type: string;\r\n  roomCode?: string;\r\n  peerId?: string;\r\n  targetId?: string;\r\n  payload?: unknown;\r\n}\r\n\r\nexport interface SignalingEvents {\r\n  connected: void;\r\n  disconnected: void;\r\n  roomCreated: { roomCode: string };\r\n  roomJoined: { roomCode: string; peers: string[] };\r\n  peerJoined: { peerId: string };\r\n  peerLeft: { peerId: string };\r\n  offer: { peerId: string; offer: RTCSessionDescriptionInit };\r\n  answer: { peerId: string; answer: RTCSessionDescriptionInit };\r\n  iceCandidate: { peerId: string; candidate: RTCIceCandidateInit };\r\n  error: { message: string };\r\n}\r\n\r\nexport class SignalingClient extends EventEmitter<SignalingEvents> {\r\n  private ws: WebSocket | null = null;\r\n  private serverUrl: string;\r\n  private localPeerId: string;\r\n  private reconnectAttempts = 0;\r\n  private maxReconnectAttempts = 5;\r\n  private reconnectDelay = 1000;\r\n\r\n  constructor(serverUrl: string) {\r\n    super();\r\n    this.serverUrl = serverUrl;\r\n    this.localPeerId = this.generatePeerId();\r\n  }\r\n\r\n  private generatePeerId(): string {\r\n    return `peer_${Date.now().toString(36)}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  connect(): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        this.ws = new WebSocket(this.serverUrl);\r\n\r\n        this.ws.onopen = () => {\r\n          console.log('[Signaling] Connected');\r\n          this.reconnectAttempts = 0;\r\n          this.emit('connected', undefined);\r\n          resolve();\r\n        };\r\n\r\n        this.ws.onclose = () => {\r\n          console.log('[Signaling] Disconnected');\r\n          this.emit('disconnected', undefined);\r\n          this.attemptReconnect();\r\n        };\r\n\r\n        this.ws.onerror = (error) => {\r\n          console.error('[Signaling] Error:', error);\r\n          reject(error);\r\n        };\r\n\r\n        this.ws.onmessage = (event) => {\r\n          this.handleMessage(event.data);\r\n        };\r\n      } catch (e) {\r\n        reject(e);\r\n      }\r\n    });\r\n  }\r\n\r\n  private handleMessage(data: string): void {\r\n    try {\r\n      const message: SignalingMessage = JSON.parse(data);\r\n\r\n      switch (message.type) {\r\n        case 'room-created':\r\n          this.emit('roomCreated', { roomCode: message.roomCode! });\r\n          break;\r\n\r\n        case 'room-joined':\r\n          this.emit('roomJoined', {\r\n            roomCode: message.roomCode!,\r\n            peers: message.payload as string[],\r\n          });\r\n          break;\r\n\r\n        case 'peer-joined':\r\n          this.emit('peerJoined', { peerId: message.peerId! });\r\n          break;\r\n\r\n        case 'peer-left':\r\n          this.emit('peerLeft', { peerId: message.peerId! });\r\n          break;\r\n\r\n        case 'offer':\r\n          this.emit('offer', {\r\n            peerId: message.peerId!,\r\n            offer: message.payload as RTCSessionDescriptionInit,\r\n          });\r\n          break;\r\n\r\n        case 'answer':\r\n          this.emit('answer', {\r\n            peerId: message.peerId!,\r\n            answer: message.payload as RTCSessionDescriptionInit,\r\n          });\r\n          break;\r\n\r\n        case 'ice-candidate':\r\n          this.emit('iceCandidate', {\r\n            peerId: message.peerId!,\r\n            candidate: message.payload as RTCIceCandidateInit,\r\n          });\r\n          break;\r\n\r\n        case 'error':\r\n          this.emit('error', { message: message.payload as string });\r\n          break;\r\n\r\n        default:\r\n          console.warn('[Signaling] Unknown message type:', message.type);\r\n      }\r\n    } catch (e) {\r\n      console.error('[Signaling] Failed to parse message:', e);\r\n    }\r\n  }\r\n\r\n  private attemptReconnect(): void {\r\n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\r\n      console.error('[Signaling] Max reconnect attempts reached');\r\n      return;\r\n    }\r\n\r\n    this.reconnectAttempts++;\r\n    const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);\r\n\r\n    console.log(`[Signaling] Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})`);\r\n\r\n    setTimeout(() => {\r\n      this.connect().catch(() => {\r\n        // Will trigger onclose -> attemptReconnect\r\n      });\r\n    }, delay);\r\n  }\r\n\r\n  send(message: SignalingMessage): void {\r\n    if (this.ws?.readyState === WebSocket.OPEN) {\r\n      this.ws.send(JSON.stringify(message));\r\n    } else {\r\n      console.warn('[Signaling] Cannot send, not connected');\r\n    }\r\n  }\r\n\r\n  // Room operations\r\n  createRoom(): void {\r\n    this.send({\r\n      type: 'create-room',\r\n      peerId: this.localPeerId,\r\n    });\r\n  }\r\n\r\n  joinRoom(roomCode: string): void {\r\n    this.send({\r\n      type: 'join-room',\r\n      roomCode,\r\n      peerId: this.localPeerId,\r\n    });\r\n  }\r\n\r\n  leaveRoom(): void {\r\n    this.send({\r\n      type: 'leave-room',\r\n      peerId: this.localPeerId,\r\n    });\r\n  }\r\n\r\n  // Signaling operations\r\n  sendOffer(targetId: string, offer: RTCSessionDescriptionInit): void {\r\n    this.send({\r\n      type: 'offer',\r\n      peerId: this.localPeerId,\r\n      targetId,\r\n      payload: offer,\r\n    });\r\n  }\r\n\r\n  sendAnswer(targetId: string, answer: RTCSessionDescriptionInit): void {\r\n    this.send({\r\n      type: 'answer',\r\n      peerId: this.localPeerId,\r\n      targetId,\r\n      payload: answer,\r\n    });\r\n  }\r\n\r\n  sendIceCandidate(targetId: string, candidate: RTCIceCandidateInit): void {\r\n    this.send({\r\n      type: 'ice-candidate',\r\n      peerId: this.localPeerId,\r\n      targetId,\r\n      payload: candidate,\r\n    });\r\n  }\r\n\r\n  disconnect(): void {\r\n    this.ws?.close();\r\n    this.ws = null;\r\n  }\r\n\r\n  getLocalPeerId(): string {\r\n    return this.localPeerId;\r\n  }\r\n\r\n  isConnected(): boolean {\r\n    return this.ws?.readyState === WebSocket.OPEN;\r\n  }\r\n}\r\n","// ============================================================================\r\n// FIRESTORE SIGNALING - Use Firebase Firestore for WebRTC signaling\r\n// ============================================================================\r\n// No custom server needed! Firestore handles real-time message passing.\r\n\r\nimport { EventEmitter } from './EventEmitter';\r\n\r\nexport interface FirestoreSignalingEvents {\r\n  connected: void;\r\n  disconnected: void;\r\n  roomCreated: { roomCode: string };\r\n  roomJoined: { roomCode: string; peers: string[] };\r\n  peerJoined: { peerId: string };\r\n  peerLeft: { peerId: string };\r\n  offer: { peerId: string; offer: RTCSessionDescriptionInit };\r\n  answer: { peerId: string; answer: RTCSessionDescriptionInit };\r\n  iceCandidate: { peerId: string; candidate: RTCIceCandidateInit };\r\n  error: { message: string };\r\n}\r\n\r\nexport class FirestoreSignaling extends EventEmitter<FirestoreSignalingEvents> {\r\n  private db: any = null; // Firestore instance\r\n  private localPeerId: string;\r\n  private roomCode: string = '';\r\n  private unsubscribers: (() => void)[] = [];\r\n  private isConnected = false;\r\n\r\n  // Firebase modules (loaded dynamically)\r\n  private firebase: any = null;\r\n\r\n  constructor() {\r\n    super();\r\n    this.localPeerId = this.generatePeerId();\r\n  }\r\n\r\n  private generatePeerId(): string {\r\n    return `peer_${Date.now().toString(36)}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  async connect(firebaseConfig: Record<string, string>): Promise<void> {\r\n    try {\r\n      // Dynamically import Firebase\r\n      const { initializeApp, getApps, getApp } = await import('firebase/app');\r\n      const { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, deleteDoc, updateDoc, serverTimestamp, arrayUnion } = await import('firebase/firestore');\r\n\r\n      // Store firebase functions for later use\r\n      this.firebase = { \r\n        collection, doc, setDoc, getDoc, addDoc, onSnapshot, \r\n        deleteDoc, updateDoc, serverTimestamp, arrayUnion\r\n      };\r\n\r\n      // Initialize Firebase (or use existing app if already initialized)\r\n      const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();\r\n      this.db = getFirestore(app);\r\n\r\n      this.isConnected = true;\r\n      this.emit('connected', undefined);\r\n      console.log('[FirestoreSignaling] Connected to Firebase');\r\n    } catch (e) {\r\n      console.error('[FirestoreSignaling] Failed to connect:', e);\r\n      throw e;\r\n    }\r\n  }\r\n\r\n  async createRoom(): Promise<string> {\r\n    if (!this.db) throw new Error('Not connected to Firebase');\r\n\r\n    const { doc, setDoc, serverTimestamp } = this.firebase;\r\n\r\n    // Generate room code\r\n    this.roomCode = this.generateRoomCode();\r\n\r\n    // Create room document\r\n    const roomRef = doc(this.db, 'rooms', this.roomCode);\r\n    await setDoc(roomRef, {\r\n      hostId: this.localPeerId,\r\n      createdAt: serverTimestamp(),\r\n      peers: [this.localPeerId],\r\n    });\r\n\r\n    // Create our peer document in the room\r\n    const peerRef = doc(this.db, 'rooms', this.roomCode, 'peers', this.localPeerId);\r\n    await setDoc(peerRef, {\r\n      joinedAt: serverTimestamp(),\r\n      isHost: true,\r\n    });\r\n\r\n    // Listen for new peers joining\r\n    this.listenForPeers();\r\n\r\n    // Listen for signaling messages to us\r\n    this.listenForSignals();\r\n\r\n    this.emit('roomCreated', { roomCode: this.roomCode });\r\n    console.log(`[FirestoreSignaling] Room created: ${this.roomCode}`);\r\n\r\n    return this.roomCode;\r\n  }\r\n\r\n  async joinRoom(roomCode: string): Promise<void> {\r\n    if (!this.db) throw new Error('Not connected to Firebase');\r\n\r\n    const { doc, getDoc, setDoc, updateDoc, serverTimestamp, arrayUnion } = this.firebase;\r\n\r\n    this.roomCode = roomCode.toUpperCase();\r\n    console.log(`[FirestoreSignaling] Attempting to join room: ${this.roomCode} as peer: ${this.localPeerId}`);\r\n\r\n    // Check if room exists\r\n    const roomRef = doc(this.db, 'rooms', this.roomCode);\r\n    const roomSnap = await getDoc(roomRef);\r\n\r\n    if (!roomSnap.exists()) {\r\n      this.emit('error', { message: `Room ${this.roomCode} not found` });\r\n      throw new Error(`Room ${this.roomCode} not found`);\r\n    }\r\n\r\n    const roomData = roomSnap.data();\r\n    const existingPeers: string[] = roomData.peers || [];\r\n    console.log(`[FirestoreSignaling] Room exists, current peers: [${existingPeers.join(', ')}]`);\r\n\r\n    // Add ourselves to the room using arrayUnion for atomic update\r\n    try {\r\n      await updateDoc(roomRef, {\r\n        peers: arrayUnion(this.localPeerId),\r\n      });\r\n      console.log(`[FirestoreSignaling] Added self to peers array`);\r\n    } catch (e) {\r\n      console.error(`[FirestoreSignaling] Failed to update peers array:`, e);\r\n      // Fallback: try spread operator\r\n      await updateDoc(roomRef, {\r\n        peers: [...existingPeers, this.localPeerId],\r\n      });\r\n    }\r\n\r\n    // Create our peer document\r\n    const peerRef = doc(this.db, 'rooms', this.roomCode, 'peers', this.localPeerId);\r\n    await setDoc(peerRef, {\r\n      joinedAt: serverTimestamp(),\r\n      isHost: false,\r\n    });\r\n    console.log(`[FirestoreSignaling] Created peer document`);\r\n\r\n    // Listen for peers\r\n    this.listenForPeers();\r\n\r\n    // Listen for signaling messages to us\r\n    this.listenForSignals();\r\n\r\n    // Emit room joined with existing peers (excluding ourselves)\r\n    const otherPeers = existingPeers.filter(p => p !== this.localPeerId);\r\n    this.emit('roomJoined', { roomCode: this.roomCode, peers: otherPeers });\r\n\r\n    console.log(`[FirestoreSignaling] Joined room: ${this.roomCode}, will connect to peers: [${otherPeers.join(', ')}]`);\r\n  }\r\n\r\n  private listenForPeers(): void {\r\n    const { collection, onSnapshot } = this.firebase;\r\n\r\n    const peersRef = collection(this.db, 'rooms', this.roomCode, 'peers');\r\n    \r\n    const unsubscribe = onSnapshot(peersRef, (snapshot: any) => {\r\n      snapshot.docChanges().forEach((change: any) => {\r\n        const peerId = change.doc.id;\r\n        \r\n        if (peerId === this.localPeerId) return; // Ignore ourselves\r\n\r\n        if (change.type === 'added') {\r\n          console.log(`[FirestoreSignaling] Peer joined: ${peerId}`);\r\n          this.emit('peerJoined', { peerId });\r\n        } else if (change.type === 'removed') {\r\n          console.log(`[FirestoreSignaling] Peer left: ${peerId}`);\r\n          this.emit('peerLeft', { peerId });\r\n        }\r\n      });\r\n    });\r\n\r\n    this.unsubscribers.push(unsubscribe);\r\n  }\r\n\r\n  private listenForSignals(): void {\r\n    const { collection, onSnapshot, deleteDoc, doc } = this.firebase;\r\n\r\n    // Listen for signals sent TO us\r\n    const signalsRef = collection(this.db, 'rooms', this.roomCode, 'signals', this.localPeerId, 'messages');\r\n    \r\n    const unsubscribe = onSnapshot(signalsRef, (snapshot: any) => {\r\n      snapshot.docChanges().forEach(async (change: any) => {\r\n        if (change.type === 'added') {\r\n          const data = change.doc.data();\r\n          const messageId = change.doc.id;\r\n\r\n          console.log(`[FirestoreSignaling] Received signal: ${data.type} from ${data.from}`);\r\n\r\n          switch (data.type) {\r\n            case 'offer':\r\n              this.emit('offer', { \r\n                peerId: data.from, \r\n                offer: data.payload as RTCSessionDescriptionInit \r\n              });\r\n              break;\r\n            case 'answer':\r\n              this.emit('answer', { \r\n                peerId: data.from, \r\n                answer: data.payload as RTCSessionDescriptionInit \r\n              });\r\n              break;\r\n            case 'ice-candidate':\r\n              this.emit('iceCandidate', { \r\n                peerId: data.from, \r\n                candidate: data.payload as RTCIceCandidateInit \r\n              });\r\n              break;\r\n          }\r\n\r\n          // Delete the message after processing (cleanup)\r\n          const messageRef = doc(this.db, 'rooms', this.roomCode, 'signals', this.localPeerId, 'messages', messageId);\r\n          await deleteDoc(messageRef);\r\n        }\r\n      });\r\n    });\r\n\r\n    this.unsubscribers.push(unsubscribe);\r\n  }\r\n\r\n  async sendOffer(targetId: string, offer: RTCSessionDescriptionInit): Promise<void> {\r\n    await this.sendSignal(targetId, 'offer', offer);\r\n  }\r\n\r\n  async sendAnswer(targetId: string, answer: RTCSessionDescriptionInit): Promise<void> {\r\n    await this.sendSignal(targetId, 'answer', answer);\r\n  }\r\n\r\n  async sendIceCandidate(targetId: string, candidate: RTCIceCandidateInit): Promise<void> {\r\n    await this.sendSignal(targetId, 'ice-candidate', candidate);\r\n  }\r\n\r\n  private async sendSignal(targetId: string, type: string, payload: unknown): Promise<void> {\r\n    if (!this.db) return;\r\n\r\n    const { collection, addDoc, serverTimestamp } = this.firebase;\r\n\r\n    // Add message to target's signal inbox\r\n    const signalsRef = collection(this.db, 'rooms', this.roomCode, 'signals', targetId, 'messages');\r\n    \r\n    await addDoc(signalsRef, {\r\n      type,\r\n      from: this.localPeerId,\r\n      payload,\r\n      timestamp: serverTimestamp(),\r\n    });\r\n\r\n    console.log(`[FirestoreSignaling] Sent ${type} to ${targetId}`);\r\n  }\r\n\r\n  async leaveRoom(): Promise<void> {\r\n    if (!this.db || !this.roomCode) return;\r\n\r\n    const { doc, deleteDoc, getDoc, updateDoc } = this.firebase;\r\n\r\n    // Unsubscribe from all listeners\r\n    this.unsubscribers.forEach(unsub => unsub());\r\n    this.unsubscribers = [];\r\n\r\n    // Remove our peer document\r\n    const peerRef = doc(this.db, 'rooms', this.roomCode, 'peers', this.localPeerId);\r\n    await deleteDoc(peerRef);\r\n\r\n    // Remove ourselves from room's peer list\r\n    const roomRef = doc(this.db, 'rooms', this.roomCode);\r\n    const roomSnap = await getDoc(roomRef);\r\n    \r\n    if (roomSnap.exists()) {\r\n      const roomData = roomSnap.data();\r\n      const peers: string[] = roomData.peers || [];\r\n      const newPeers = peers.filter(p => p !== this.localPeerId);\r\n      \r\n      if (newPeers.length === 0) {\r\n        // Last person, delete the room\r\n        await deleteDoc(roomRef);\r\n        console.log(`[FirestoreSignaling] Room ${this.roomCode} deleted (empty)`);\r\n      } else {\r\n        await updateDoc(roomRef, { peers: newPeers });\r\n      }\r\n    }\r\n\r\n    this.roomCode = '';\r\n    console.log('[FirestoreSignaling] Left room');\r\n  }\r\n\r\n  disconnect(): void {\r\n    this.leaveRoom();\r\n    this.isConnected = false;\r\n    this.emit('disconnected', undefined);\r\n  }\r\n\r\n  private generateRoomCode(): string {\r\n    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';\r\n    let code = '';\r\n    for (let i = 0; i < 6; i++) {\r\n      code += chars.charAt(Math.floor(Math.random() * chars.length));\r\n    }\r\n    return code;\r\n  }\r\n\r\n  getLocalPeerId(): string {\r\n    return this.localPeerId;\r\n  }\r\n\r\n  getRoomCode(): string {\r\n    return this.roomCode;\r\n  }\r\n\r\n  getIsConnected(): boolean {\r\n    return this.isConnected;\r\n  }\r\n}\r\n","// ============================================================================\r\n// PACKET SERIALIZER - Binary Encoding/Decoding\r\n// ============================================================================\r\n\r\nimport { Packet, PacketType, PlayerInput, PlayerState, ProjectileState, ObjectiveState } from '@/shared/types';\r\n\r\n// Simple binary format for performance\r\n// Format: [type:u8][timestamp:f64][senderId length:u8][senderId:string][payload...]\r\n\r\nexport class PacketSerializer {\r\n  private encoder = new TextEncoder();\r\n  private decoder = new TextDecoder();\r\n\r\n  serialize(packet: Packet): ArrayBuffer {\r\n    // For now, use JSON serialization for simplicity\r\n    // Can optimize to binary later for performance\r\n    const json = JSON.stringify(packet);\r\n    return this.encoder.encode(json).buffer;\r\n  }\r\n\r\n  deserialize(buffer: ArrayBuffer): Packet {\r\n    const text = this.decoder.decode(buffer);\r\n    return JSON.parse(text);\r\n  }\r\n\r\n  // Optimized binary serialization for input packets\r\n  serializeInput(input: PlayerInput, senderId: string): ArrayBuffer {\r\n    const buffer = new ArrayBuffer(64);\r\n    const view = new DataView(buffer);\r\n    let offset = 0;\r\n\r\n    // Type\r\n    view.setUint8(offset, PacketType.Input);\r\n    offset += 1;\r\n\r\n    // Timestamp\r\n    view.setFloat64(offset, Date.now());\r\n    offset += 8;\r\n\r\n    // Sender ID length and string\r\n    const senderBytes = this.encoder.encode(senderId);\r\n    view.setUint8(offset, senderBytes.length);\r\n    offset += 1;\r\n    new Uint8Array(buffer, offset, senderBytes.length).set(senderBytes);\r\n    offset += senderBytes.length;\r\n\r\n    // Input data\r\n    view.setFloat32(offset, input.moveX);\r\n    offset += 4;\r\n    view.setFloat32(offset, input.moveY);\r\n    offset += 4;\r\n    view.setFloat32(offset, input.aimX);\r\n    offset += 4;\r\n    view.setFloat32(offset, input.aimY);\r\n    offset += 4;\r\n\r\n    // Bit flags for booleans\r\n    let flags = 0;\r\n    if (input.shoot) flags |= 1;\r\n    if (input.reload) flags |= 2;\r\n    if (input.interact) flags |= 4;\r\n    if (input.ability1) flags |= 8;\r\n    if (input.ability2) flags |= 16;\r\n    if (input.ultimate) flags |= 32;\r\n    view.setUint8(offset, flags);\r\n    offset += 1;\r\n\r\n    // Sequence\r\n    view.setUint32(offset, input.sequence);\r\n    offset += 4;\r\n\r\n    return buffer.slice(0, offset);\r\n  }\r\n\r\n  deserializeInput(buffer: ArrayBuffer): { senderId: string; input: PlayerInput; timestamp: number } | null {\r\n    try {\r\n      const view = new DataView(buffer);\r\n      let offset = 0;\r\n\r\n      // Type\r\n      const type = view.getUint8(offset);\r\n      if (type !== PacketType.Input) return null;\r\n      offset += 1;\r\n\r\n      // Timestamp\r\n      const timestamp = view.getFloat64(offset);\r\n      offset += 8;\r\n\r\n      // Sender ID\r\n      const senderLength = view.getUint8(offset);\r\n      offset += 1;\r\n      const senderId = this.decoder.decode(new Uint8Array(buffer, offset, senderLength));\r\n      offset += senderLength;\r\n\r\n      // Input data\r\n      const moveX = view.getFloat32(offset);\r\n      offset += 4;\r\n      const moveY = view.getFloat32(offset);\r\n      offset += 4;\r\n      const aimX = view.getFloat32(offset);\r\n      offset += 4;\r\n      const aimY = view.getFloat32(offset);\r\n      offset += 4;\r\n\r\n      // Flags\r\n      const flags = view.getUint8(offset);\r\n      offset += 1;\r\n\r\n      // Sequence\r\n      const sequence = view.getUint32(offset);\r\n\r\n      const input: PlayerInput = {\r\n        moveX,\r\n        moveY,\r\n        aimX,\r\n        aimY,\r\n        shoot: (flags & 1) !== 0,\r\n        reload: (flags & 2) !== 0,\r\n        interact: (flags & 4) !== 0,\r\n        ability1: (flags & 8) !== 0,\r\n        ability2: (flags & 16) !== 0,\r\n        ultimate: (flags & 32) !== 0,\r\n        weaponSlot: 0,  // TODO: serialize weapon slot when networking is implemented\r\n        sequence,\r\n      };\r\n\r\n      return { senderId, input, timestamp };\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Snapshot serialization (simplified for now)\r\n  serializeSnapshot(\r\n    tick: number,\r\n    players: PlayerState[],\r\n    projectiles: ProjectileState[],\r\n    objectives: ObjectiveState\r\n  ): ArrayBuffer {\r\n    const packet = {\r\n      type: PacketType.StateSnapshot,\r\n      timestamp: Date.now(),\r\n      senderId: 'host',\r\n      data: { tick, players, projectiles, objectives },\r\n    };\r\n    return this.serialize(packet);\r\n  }\r\n}\r\n","// ============================================================================\r\n// NETWORK MANAGER - Orchestrates P2P Connections\r\n// ============================================================================\r\n\r\nimport { EventEmitter } from './EventEmitter';\r\nimport { PeerConnection } from './PeerConnection';\r\nimport { SignalingClient } from './SignalingClient';\r\nimport { FirestoreSignaling } from './FirestoreSignaling';\r\nimport { PacketSerializer } from './PacketSerializer';\r\nimport { Packet, PacketType } from '@/shared/types';\r\n\r\nexport interface NetworkEvents {\r\n  connected: void;\r\n  disconnected: void;\r\n  roomCreated: { roomCode: string };\r\n  roomJoined: { roomCode: string };\r\n  peerConnected: { peerId: string };\r\n  peerDisconnected: { peerId: string };\r\n  packet: { peerId: string; packet: Packet };\r\n  error: { message: string };\r\n}\r\n\r\nexport interface NetworkConfig {\r\n  signalingUrl?: string;\r\n  firebaseConfig?: Record<string, string>;\r\n  useFirestore?: boolean;\r\n  isHost: boolean;\r\n}\r\n\r\nexport class NetworkManager extends EventEmitter<NetworkEvents> {\r\n  private signaling: SignalingClient | null = null;\r\n  private firestoreSignaling: FirestoreSignaling | null = null;\r\n  private peers = new Map<string, PeerConnection>();\r\n  private serializer = new PacketSerializer();\r\n  \r\n  private isHost: boolean;\r\n  private localPeerId = '';\r\n  private roomCode = '';\r\n  private useFirestore: boolean;\r\n\r\n  // Ping tracking\r\n  private pingTimes = new Map<string, number>();\r\n  private latencies = new Map<string, number>();\r\n\r\n  constructor(config: NetworkConfig) {\r\n    super();\r\n    this.isHost = config.isHost;\r\n    this.useFirestore = config.useFirestore ?? false;\r\n  }\r\n\r\n  // Connect using WebSocket signaling server\r\n  async connect(signalingUrl: string): Promise<void> {\r\n    this.signaling = new SignalingClient(signalingUrl);\r\n    this.setupSignalingListeners();\r\n    await this.signaling.connect();\r\n    this.localPeerId = this.signaling.getLocalPeerId();\r\n    this.emit('connected', undefined);\r\n  }\r\n\r\n  // Connect using Firebase Firestore (no server needed!)\r\n  async connectWithFirebase(firebaseConfig: Record<string, string>): Promise<void> {\r\n    this.useFirestore = true;\r\n    this.firestoreSignaling = new FirestoreSignaling();\r\n    this.setupFirestoreListeners();\r\n    await this.firestoreSignaling.connect(firebaseConfig);\r\n    this.localPeerId = this.firestoreSignaling.getLocalPeerId();\r\n    this.emit('connected', undefined);\r\n  }\r\n\r\n  private setupSignalingListeners(): void {\r\n    if (!this.signaling) return;\r\n\r\n    this.signaling.on('roomCreated', ({ roomCode }) => {\r\n      this.roomCode = roomCode;\r\n      console.log(`[Network] Room created: ${roomCode}`);\r\n      this.emit('roomCreated', { roomCode });\r\n    });\r\n\r\n    this.signaling.on('roomJoined', ({ roomCode, peers }) => {\r\n      this.roomCode = roomCode;\r\n      console.log(`[Network] Joined room: ${roomCode}, peers:`, peers);\r\n      this.emit('roomJoined', { roomCode });\r\n\r\n      // Initiate connections to existing peers\r\n      for (const peerId of peers) {\r\n        this.initiateConnection(peerId);\r\n      }\r\n    });\r\n\r\n    this.signaling.on('peerJoined', ({ peerId }) => {\r\n      console.log(`[Network] Peer joined: ${peerId}`);\r\n      // New peer will initiate connection to us\r\n    });\r\n\r\n    this.signaling.on('peerLeft', ({ peerId }) => {\r\n      console.log(`[Network] Peer left: ${peerId}`);\r\n      this.removePeer(peerId);\r\n    });\r\n\r\n    this.signaling.on('offer', async ({ peerId, offer }) => {\r\n      console.log(`[Network] Received offer from: ${peerId}`);\r\n      await this.handleOffer(peerId, offer);\r\n    });\r\n\r\n    this.signaling.on('answer', async ({ peerId, answer }) => {\r\n      console.log(`[Network] Received answer from: ${peerId}`);\r\n      const peer = this.peers.get(peerId);\r\n      if (peer) {\r\n        await peer.handleAnswer(answer);\r\n      }\r\n    });\r\n\r\n    this.signaling.on('iceCandidate', async ({ peerId, candidate }) => {\r\n      const peer = this.peers.get(peerId);\r\n      if (peer) {\r\n        await peer.addIceCandidate(candidate);\r\n      }\r\n    });\r\n\r\n    this.signaling.on('error', ({ message }) => {\r\n      console.error(`[Network] Signaling error: ${message}`);\r\n      this.emit('error', { message });\r\n    });\r\n\r\n    this.signaling.on('disconnected', () => {\r\n      console.log('[Network] Signaling disconnected');\r\n      this.emit('disconnected', undefined);\r\n    });\r\n  }\r\n\r\n  private setupFirestoreListeners(): void {\r\n    if (!this.firestoreSignaling) return;\r\n\r\n    this.firestoreSignaling.on('roomCreated', ({ roomCode }) => {\r\n      this.roomCode = roomCode;\r\n      console.log(`[Network] Room created (Firestore): ${roomCode}`);\r\n      this.emit('roomCreated', { roomCode });\r\n    });\r\n\r\n    this.firestoreSignaling.on('roomJoined', ({ roomCode, peers }) => {\r\n      this.roomCode = roomCode;\r\n      console.log(`[Network] Joined room (Firestore): ${roomCode}`);\r\n      console.log(`[Network] Existing peers in room: [${peers.join(', ')}]`);\r\n      this.emit('roomJoined', { roomCode });\r\n\r\n      // Initiate connections to existing peers\r\n      console.log(`[Network] Will initiate connections to ${peers.length} peer(s)`);\r\n      for (const peerId of peers) {\r\n        console.log(`[Network] Initiating connection to peer: ${peerId}`);\r\n        this.initiateConnectionFirestore(peerId);\r\n      }\r\n    });\r\n\r\n    this.firestoreSignaling.on('peerJoined', ({ peerId }) => {\r\n      console.log(`[Network] Peer joined (Firestore): ${peerId}`);\r\n      // New peer will initiate connection to us\r\n    });\r\n\r\n    this.firestoreSignaling.on('peerLeft', ({ peerId }) => {\r\n      console.log(`[Network] Peer left (Firestore): ${peerId}`);\r\n      this.removePeer(peerId);\r\n    });\r\n\r\n    this.firestoreSignaling.on('offer', async ({ peerId, offer }) => {\r\n      console.log(`[Network] Received offer (Firestore) from: ${peerId}`);\r\n      await this.handleOfferFirestore(peerId, offer);\r\n    });\r\n\r\n    this.firestoreSignaling.on('answer', async ({ peerId, answer }) => {\r\n      console.log(`[Network] Received answer (Firestore) from: ${peerId}`);\r\n      const peer = this.peers.get(peerId);\r\n      if (peer) {\r\n        await peer.handleAnswer(answer);\r\n      }\r\n    });\r\n\r\n    this.firestoreSignaling.on('iceCandidate', async ({ peerId, candidate }) => {\r\n      const peer = this.peers.get(peerId);\r\n      if (peer) {\r\n        await peer.addIceCandidate(candidate);\r\n      }\r\n    });\r\n\r\n    this.firestoreSignaling.on('error', ({ message }) => {\r\n      console.error(`[Network] Firestore signaling error: ${message}`);\r\n      this.emit('error', { message });\r\n    });\r\n\r\n    this.firestoreSignaling.on('disconnected', () => {\r\n      console.log('[Network] Firestore signaling disconnected');\r\n      this.emit('disconnected', undefined);\r\n    });\r\n  }\r\n\r\n  // WebSocket signaling connection methods\r\n  private async initiateConnection(peerId: string): Promise<void> {\r\n    const peer = new PeerConnection(peerId);\r\n    this.setupPeerListeners(peer);\r\n    this.peers.set(peerId, peer);\r\n\r\n    peer.onIceCandidate((candidate) => {\r\n      this.signaling?.sendIceCandidate(peerId, candidate.toJSON());\r\n    });\r\n\r\n    const offer = await peer.createOffer();\r\n    this.signaling?.sendOffer(peerId, offer);\r\n  }\r\n\r\n  private async handleOffer(peerId: string, offer: RTCSessionDescriptionInit): Promise<void> {\r\n    const peer = new PeerConnection(peerId);\r\n    this.setupPeerListeners(peer);\r\n    this.peers.set(peerId, peer);\r\n\r\n    peer.onIceCandidate((candidate) => {\r\n      this.signaling?.sendIceCandidate(peerId, candidate.toJSON());\r\n    });\r\n\r\n    const answer = await peer.handleOffer(offer);\r\n    this.signaling?.sendAnswer(peerId, answer);\r\n  }\r\n\r\n  // Firestore signaling connection methods\r\n  private async initiateConnectionFirestore(peerId: string): Promise<void> {\r\n    console.log(`[Network] Initiating WebRTC connection to: ${peerId}`);\r\n    const peer = new PeerConnection(peerId);\r\n    this.setupPeerListeners(peer);\r\n    this.peers.set(peerId, peer);\r\n    console.log(`[Network] Peer added to map. Total peers: ${this.peers.size}`);\r\n\r\n    peer.onIceCandidate((candidate) => {\r\n      console.log(`[Network] Sending ICE candidate to: ${peerId}`);\r\n      this.firestoreSignaling?.sendIceCandidate(peerId, candidate.toJSON());\r\n    });\r\n\r\n    try {\r\n      const offer = await peer.createOffer();\r\n      console.log(`[Network] Created offer for: ${peerId}`);\r\n      await this.firestoreSignaling?.sendOffer(peerId, offer);\r\n      console.log(`[Network] Sent offer to: ${peerId}`);\r\n    } catch (e) {\r\n      console.error(`[Network] Failed to create/send offer to ${peerId}:`, e);\r\n    }\r\n  }\r\n\r\n  private async handleOfferFirestore(peerId: string, offer: RTCSessionDescriptionInit): Promise<void> {\r\n    console.log(`[Network] Handling offer from: ${peerId}`);\r\n    const peer = new PeerConnection(peerId);\r\n    this.setupPeerListeners(peer);\r\n    this.peers.set(peerId, peer);\r\n    console.log(`[Network] Peer added to map from offer. Total peers: ${this.peers.size}`);\r\n\r\n    peer.onIceCandidate((candidate) => {\r\n      console.log(`[Network] Sending ICE candidate to: ${peerId}`);\r\n      this.firestoreSignaling?.sendIceCandidate(peerId, candidate.toJSON());\r\n    });\r\n\r\n    try {\r\n      const answer = await peer.handleOffer(offer);\r\n      console.log(`[Network] Created answer for: ${peerId}`);\r\n      await this.firestoreSignaling?.sendAnswer(peerId, answer);\r\n      console.log(`[Network] Sent answer to: ${peerId}`);\r\n    } catch (e) {\r\n      console.error(`[Network] Failed to handle offer from ${peerId}:`, e);\r\n    }\r\n  }\r\n\r\n  private setupPeerListeners(peer: PeerConnection): void {\r\n    peer.on('connected', ({ peerId }) => {\r\n      console.log(`[Network] Peer connected: ${peerId}`);\r\n      this.emit('peerConnected', { peerId });\r\n    });\r\n\r\n    peer.on('disconnected', ({ peerId }) => {\r\n      console.log(`[Network] Peer disconnected: ${peerId}`);\r\n      this.removePeer(peerId);\r\n    });\r\n\r\n    peer.on('message', ({ peerId, data }) => {\r\n      this.handleMessage(peerId, data);\r\n    });\r\n\r\n    peer.on('error', ({ peerId, error }) => {\r\n      console.error(`[Network] Peer error (${peerId}):`, error);\r\n    });\r\n  }\r\n\r\n  private handleMessage(peerId: string, data: ArrayBuffer | string): void {\r\n    try {\r\n      let packet: Packet;\r\n\r\n      if (data instanceof ArrayBuffer) {\r\n        packet = this.serializer.deserialize(data);\r\n      } else {\r\n        packet = JSON.parse(data);\r\n      }\r\n\r\n      // Handle ping/pong internally\r\n      if (packet.type === PacketType.Pong) {\r\n        const startTime = this.pingTimes.get(peerId);\r\n        if (startTime) {\r\n          const latency = performance.now() - startTime;\r\n          this.latencies.set(peerId, latency);\r\n          this.pingTimes.delete(peerId);\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (packet.type === PacketType.Ping) {\r\n        this.sendToPeer(peerId, {\r\n          type: PacketType.Pong,\r\n          timestamp: Date.now(),\r\n          senderId: this.localPeerId,\r\n          data: null,\r\n        });\r\n        return;\r\n      }\r\n\r\n      this.emit('packet', { peerId, packet });\r\n    } catch (e) {\r\n      console.error(`[Network] Failed to parse message from ${peerId}:`, e);\r\n    }\r\n  }\r\n\r\n  private removePeer(peerId: string): void {\r\n    const peer = this.peers.get(peerId);\r\n    if (peer) {\r\n      peer.close();\r\n      this.peers.delete(peerId);\r\n      this.latencies.delete(peerId);\r\n      this.pingTimes.delete(peerId);\r\n      this.emit('peerDisconnected', { peerId });\r\n    }\r\n  }\r\n\r\n  // Public API\r\n\r\n  async createRoom(): Promise<void> {\r\n    if (this.useFirestore && this.firestoreSignaling) {\r\n      await this.firestoreSignaling.createRoom();\r\n    } else {\r\n      this.signaling?.createRoom();\r\n    }\r\n  }\r\n\r\n  async joinRoom(roomCode: string): Promise<void> {\r\n    if (this.useFirestore && this.firestoreSignaling) {\r\n      await this.firestoreSignaling.joinRoom(roomCode.toUpperCase());\r\n    } else {\r\n      this.signaling?.joinRoom(roomCode.toUpperCase());\r\n    }\r\n  }\r\n\r\n  leaveRoom(): void {\r\n    for (const [peerId] of this.peers) {\r\n      this.removePeer(peerId);\r\n    }\r\n    if (this.useFirestore && this.firestoreSignaling) {\r\n      this.firestoreSignaling.leaveRoom();\r\n    } else {\r\n      this.signaling?.leaveRoom();\r\n    }\r\n    this.roomCode = '';\r\n  }\r\n\r\n  sendToPeer(peerId: string, packet: Packet): boolean {\r\n    const peer = this.peers.get(peerId);\r\n    if (!peer?.getIsConnected()) return false;\r\n\r\n    const data = this.serializer.serialize(packet);\r\n    return peer.send(data);\r\n  }\r\n\r\n  broadcast(packet: Packet): void {\r\n    const data = this.serializer.serialize(packet);\r\n    for (const [, peer] of this.peers) {\r\n      if (peer.getIsConnected()) {\r\n        peer.send(data);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Send packet as JSON (for debugging or when binary is overkill)\r\n  sendJson(peerId: string, packet: Packet): boolean {\r\n    const peer = this.peers.get(peerId);\r\n    if (!peer?.getIsConnected()) return false;\r\n    return peer.send(JSON.stringify(packet));\r\n  }\r\n\r\n  broadcastJson(packet: Packet): void {\r\n    const data = JSON.stringify(packet);\r\n    for (const [, peer] of this.peers) {\r\n      if (peer.getIsConnected()) {\r\n        peer.send(data);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Ping all peers\r\n  pingPeers(): void {\r\n    const now = performance.now();\r\n    for (const [peerId, peer] of this.peers) {\r\n      if (peer.getIsConnected()) {\r\n        this.pingTimes.set(peerId, now);\r\n        this.sendToPeer(peerId, {\r\n          type: PacketType.Ping,\r\n          timestamp: Date.now(),\r\n          senderId: this.localPeerId,\r\n          data: null,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getLatency(peerId: string): number {\r\n    return this.latencies.get(peerId) ?? -1;\r\n  }\r\n\r\n  getAverageLatency(): number {\r\n    if (this.latencies.size === 0) return -1;\r\n    let sum = 0;\r\n    for (const latency of this.latencies.values()) {\r\n      sum += latency;\r\n    }\r\n    return sum / this.latencies.size;\r\n  }\r\n\r\n  disconnect(): void {\r\n    this.leaveRoom();\r\n    if (this.useFirestore && this.firestoreSignaling) {\r\n      this.firestoreSignaling.disconnect();\r\n      this.firestoreSignaling = null;\r\n    } else {\r\n      this.signaling?.disconnect();\r\n      this.signaling = null;\r\n    }\r\n  }\r\n\r\n  // Getters\r\n  getLocalPeerId(): string {\r\n    return this.localPeerId;\r\n  }\r\n\r\n  getRoomCode(): string {\r\n    return this.roomCode;\r\n  }\r\n\r\n  getPeerIds(): string[] {\r\n    return Array.from(this.peers.keys());\r\n  }\r\n\r\n  getPeerCount(): number {\r\n    return this.peers.size;\r\n  }\r\n\r\n  getIsHost(): boolean {\r\n    return this.isHost;\r\n  }\r\n\r\n  isConnected(): boolean {\r\n    return this.signaling?.isConnected() ?? false;\r\n  }\r\n}\r\n","// ============================================================================\r\n// PLAYER ENTITY\r\n// ============================================================================\r\n\r\nimport { \r\n  EntityId, \r\n  Vector2, \r\n  PlayerState, \r\n  PlayerInput, \r\n  WeaponState, \r\n  AbilityState,\r\n  HeroId,\r\n  Team,\r\n  WeaponId\r\n} from '@/shared/types';\r\nimport { HEROES, WEAPONS, GAMEPLAY } from '@/shared/constants';\r\nimport { Vec2, generateId } from '@/shared/utils';\r\nimport { CollisionBody, ColliderType, CollisionLayers } from '@/engine/CollisionSystem';\r\n\r\nexport class Player {\r\n  // Identity\r\n  public readonly id: EntityId;\r\n  public name: string;\r\n  public peerId: string;\r\n  public team: Team;\r\n  public heroId: HeroId;\r\n\r\n  // Transform\r\n  public position: Vector2;\r\n  public velocity: Vector2;\r\n  public rotation: number;\r\n\r\n  // Previous state for interpolation\r\n  public prevPosition: Vector2;\r\n  public prevRotation: number;\r\n  \r\n  // Network interpolation target (for remote players on clients)\r\n  public targetPosition: Vector2 | null = null;\r\n  public targetRotation: number | null = null;\r\n\r\n  // Stats\r\n  public health: number;\r\n  public maxHealth: number;\r\n  public shield: number;\r\n  public maxShield: number;\r\n  public alive: boolean;\r\n  public respawnTime: number;\r\n\r\n  // Economy\r\n  public credits: number;\r\n  public kills: number;\r\n  public deaths: number;\r\n  public assists: number;\r\n\r\n  // Weapon inventory (slots 1-10)\r\n  public weaponInventory: (WeaponState | null)[];\r\n  public currentWeaponSlot: number;\r\n  public weapon: WeaponState;  // Current active weapon\r\n\r\n  // Abilities\r\n  public abilities: AbilityState[];\r\n  public ultimateCharge: number;\r\n\r\n  // Current input\r\n  public input: PlayerInput;\r\n\r\n  // Combat state\r\n  public lastDamageTime: number;\r\n  public lastAttackerId: EntityId | null;\r\n  public deathTime: number;  // Time when player died (for corpse fade)\r\n\r\n  // Network state\r\n  public isDisconnected: boolean;\r\n\r\n  // Movement modifiers\r\n  public speedMultiplier: number;\r\n  public isSlowed: boolean;\r\n  public isStunned: boolean;\r\n  public isInvisible: boolean;\r\n\r\n  // Passive modifiers (hero-specific bonuses)\r\n  public damageReduction: number;    // % damage reduction (0-1)\r\n  public damageBonus: number;        // % bonus damage dealt (0-1)\r\n  public shieldRegenBonus: number;   // % faster shield regen (0-1)\r\n  public fireRateBonus: number;      // % faster fire rate (0-1)\r\n  public isFireImmune: boolean;      // Immune to fire damage\r\n  public healingBonus: number;       // % bonus to healing received (0-1)\r\n\r\n  constructor(\r\n    peerId: string,\r\n    name: string,\r\n    team: Team,\r\n    heroId: HeroId,\r\n    spawnPosition: Vector2\r\n  ) {\r\n    this.id = generateId('player');\r\n    this.peerId = peerId;\r\n    this.name = name;\r\n    this.team = team;\r\n    this.heroId = heroId;\r\n\r\n    const heroDef = HEROES[heroId];\r\n    \r\n    // Transform\r\n    this.position = { ...spawnPosition };\r\n    this.prevPosition = { ...spawnPosition };\r\n    this.velocity = Vec2.zero();\r\n    this.rotation = 0;\r\n    this.prevRotation = 0;\r\n\r\n    // Stats\r\n    this.maxHealth = heroDef.health;\r\n    this.health = this.maxHealth;\r\n    this.maxShield = heroDef.shield;\r\n    this.shield = this.maxShield;\r\n    this.alive = true;\r\n    this.respawnTime = 0;\r\n\r\n    // Economy\r\n    this.credits = GAMEPLAY.STARTING_CREDITS;\r\n    this.kills = 0;\r\n    this.deaths = 0;\r\n    this.assists = 0;\r\n\r\n    // Weapon inventory - start with only burst pistol\r\n    const defaultWeapon = WEAPONS[WeaponId.BurstPistol];\r\n    const pistolState: WeaponState = {\r\n      weaponId: WeaponId.BurstPistol,\r\n      ammo: defaultWeapon.ammoCapacity,\r\n      maxAmmo: defaultWeapon.ammoCapacity,\r\n      reloading: false,\r\n      reloadEndTime: 0,\r\n      lastFireTime: 0,\r\n    };\r\n    \r\n    // Initialize weapon inventory (10 slots) - start with pistol only\r\n    // Other weapons are purchased through the buy menu\r\n    this.weaponInventory = [\r\n      pistolState,   // Slot 1: Burst Pistol (key 1) - always available\r\n      null,          // Slot 2: Neo SMG-9 (key 2) - buy to unlock\r\n      null,          // Slot 3: Pulse Rifle (key 3) - buy to unlock\r\n      null,          // Slot 4: Scatter Shot (key 4) - buy to unlock\r\n      null,          // Slot 5: Rail Sniper (key 5) - buy to unlock\r\n      null,          // Slot 6: Shard Launcher (key 6) - buy to unlock\r\n      null,          // Slot 7: Nano Repeater (key 7) - buy to unlock\r\n      null,          // Slot 8: Arc Welder (key 8) - buy to unlock\r\n      null,          // Slot 9: Phase Repeater (key 9) - buy to unlock\r\n      null,          // Slot 10: Plasma Cannon (key 0) - buy to unlock\r\n    ];\r\n    this.currentWeaponSlot = 0;\r\n    this.weapon = pistolState;\r\n\r\n    // Abilities\r\n    this.abilities = heroDef.abilities.map((_, index) => ({\r\n      abilityIndex: index,\r\n      cooldownEndTime: 0,\r\n      charges: heroDef.abilities[index]?.charges ?? 1,\r\n      active: false,\r\n      duration: 0,\r\n      ultimateCharge: 0,\r\n    }));\r\n    this.ultimateCharge = 0;\r\n\r\n    // Input\r\n    this.input = this.createEmptyInput();\r\n\r\n    // Combat\r\n    this.lastDamageTime = 0;\r\n    this.lastAttackerId = null;\r\n    this.deathTime = 0;\r\n\r\n    // Network\r\n    this.isDisconnected = false;\r\n\r\n    // Modifiers\r\n    this.speedMultiplier = heroDef.speed;\r\n    this.isSlowed = false;\r\n    this.isStunned = false;\r\n    this.isInvisible = false;\r\n\r\n    // Initialize passive modifiers\r\n    this.damageReduction = 0;\r\n    this.damageBonus = 0;\r\n    this.shieldRegenBonus = 0;\r\n    this.fireRateBonus = 0;\r\n    this.isFireImmune = false;\r\n    this.healingBonus = 0;\r\n\r\n    // Apply hero-specific passive abilities\r\n    this.applyHeroPassives();\r\n  }\r\n\r\n  /**\r\n   * Apply hero-specific passive bonuses based on heroId\r\n   */\r\n  private applyHeroPassives(): void {\r\n    switch (this.heroId) {\r\n      case 'spectre':\r\n        // Ghost Protocol: 10% damage reduction (stealthy = harder to pin down)\r\n        this.damageReduction = 0.10;\r\n        break;\r\n      case 'byte':\r\n        // Quick Recovery: 25% faster shield regeneration\r\n        this.shieldRegenBonus = 0.25;\r\n        break;\r\n      case 'vanta':\r\n        // Titan Armor: Already has +50 base shield, also 15% damage reduction\r\n        this.damageReduction = 0.15;\r\n        break;\r\n      case 'katana':\r\n        // Swift Strike: 15% speed boost (already in heroDef.speed = 1.15)\r\n        // Also +10% damage (assassin hits hard)\r\n        this.damageBonus = 0.10;\r\n        break;\r\n      case 'glyph':\r\n        // Keen Eyes: 10% damage bonus (precision)\r\n        this.damageBonus = 0.10;\r\n        break;\r\n      case 'spark':\r\n        // Fireproof: Immune to fire damage + 10% fire rate\r\n        this.isFireImmune = true;\r\n        this.fireRateBonus = 0.10;\r\n        break;\r\n      case 'zero':\r\n        // Steady Aim: 15% damage bonus (sniper precision)\r\n        this.damageBonus = 0.15;\r\n        break;\r\n      case 'mira':\r\n        // Combat Medic: 25% bonus healing received + given\r\n        this.healingBonus = 0.25;\r\n        break;\r\n    }\r\n  }\r\n\r\n  private createEmptyInput(): PlayerInput {\r\n    return {\r\n      moveX: 0,\r\n      moveY: 0,\r\n      aimX: 0,\r\n      aimY: 0,\r\n      shoot: false,\r\n      reload: false,\r\n      interact: false,\r\n      ability1: false,\r\n      ability2: false,\r\n      ultimate: false,\r\n      weaponSlot: 0,\r\n      sequence: 0,\r\n    };\r\n  }\r\n\r\n  update(dt: number, time: number): void {\r\n    // Store previous state\r\n    this.prevPosition = { ...this.position };\r\n    this.prevRotation = this.rotation;\r\n\r\n    if (!this.alive) return;\r\n    if (this.isStunned) return;\r\n\r\n    // Update rotation to face aim point\r\n    const aimDir = Vec2.sub(\r\n      { x: this.input.aimX, y: this.input.aimY },\r\n      this.position\r\n    );\r\n    this.rotation = Vec2.angle(aimDir);\r\n\r\n    // Update movement\r\n    this.updateMovement(dt);\r\n\r\n    // Update weapon\r\n    this.updateWeapon(time);\r\n\r\n    // Update abilities\r\n    this.updateAbilities(time);\r\n\r\n    // Regenerate shield when out of combat (apply shieldRegenBonus passive)\r\n    if (time - this.lastDamageTime > 3000 && this.shield < this.maxShield) {\r\n      const regenRate = 0.05 * (1 + this.shieldRegenBonus); // Base 5% per second + bonus\r\n      this.shield = Math.min(this.maxShield, this.shield + this.maxShield * regenRate * (dt / 1000));\r\n    }\r\n  }\r\n\r\n  private updateMovement(dt: number): void {\r\n    let speed = GAMEPLAY.BASE_SPEED * this.speedMultiplier;\r\n    \r\n    if (this.isSlowed) {\r\n      speed *= 0.6;\r\n    }\r\n\r\n    // Calculate target velocity\r\n    const moveDir = Vec2.normalize({ x: this.input.moveX, y: this.input.moveY });\r\n    const targetVelocity = Vec2.mul(moveDir, speed);\r\n\r\n    // Apply acceleration/friction\r\n    const acceleration = GAMEPLAY.ACCELERATION;\r\n    const friction = GAMEPLAY.FRICTION;\r\n\r\n    if (Vec2.length(targetVelocity) > 0) {\r\n      // Accelerate towards target\r\n      this.velocity = Vec2.lerp(this.velocity, targetVelocity, 1 - Math.exp(-acceleration * dt / 1000));\r\n    } else {\r\n      // Apply friction\r\n      const frictionFactor = 1 - Math.exp(-friction * dt / 1000);\r\n      this.velocity = Vec2.mul(this.velocity, 1 - frictionFactor);\r\n    }\r\n\r\n    // Apply velocity\r\n    this.position = Vec2.add(this.position, Vec2.mul(this.velocity, dt / 1000));\r\n  }\r\n\r\n  private updateWeapon(time: number): void {\r\n    // Check if reload is complete\r\n    if (this.weapon.reloading && time >= this.weapon.reloadEndTime) {\r\n      this.weapon.ammo = this.weapon.maxAmmo;\r\n      this.weapon.reloading = false;\r\n    }\r\n\r\n    // Start reload if requested and not already reloading\r\n    if (this.input.reload && !this.weapon.reloading && this.weapon.ammo < this.weapon.maxAmmo) {\r\n      const weaponDef = WEAPONS[this.weapon.weaponId];\r\n      this.weapon.reloading = true;\r\n      this.weapon.reloadEndTime = time + weaponDef.reloadTime;\r\n    }\r\n  }\r\n\r\n  private updateAbilities(time: number): void {\r\n    // Update active ability durations\r\n    for (const ability of this.abilities) {\r\n      if (ability.active && ability.duration > 0) {\r\n        if (time >= ability.duration) {\r\n          ability.active = false;\r\n          ability.duration = 0;\r\n        }\r\n      }\r\n\r\n      // Restore charges\r\n      const abilityDef = HEROES[this.heroId].abilities[ability.abilityIndex];\r\n      if (abilityDef && ability.charges < abilityDef.charges) {\r\n        if (time >= ability.cooldownEndTime) {\r\n          ability.charges++;\r\n          if (ability.charges < abilityDef.charges) {\r\n            ability.cooldownEndTime = time + abilityDef.chargeTime;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  getWeaponDefinition() {\r\n    return WEAPONS[this.weapon.weaponId];\r\n  }\r\n\r\n  /**\r\n   * Get effective fire rate including passive bonuses\r\n   */\r\n  getEffectiveFireRate(): number {\r\n    const weaponDef = this.getWeaponDefinition();\r\n    return weaponDef.fireRate * (1 + this.fireRateBonus);\r\n  }\r\n\r\n  /**\r\n   * Get effective damage including passive bonuses\r\n   */\r\n  getEffectiveDamage(): number {\r\n    const weaponDef = this.getWeaponDefinition();\r\n    return weaponDef.damage * (1 + this.damageBonus);\r\n  }\r\n\r\n  canFire(time: number): boolean {\r\n    if (!this.alive) return false;\r\n    if (this.weapon.reloading) return false;\r\n    if (this.weapon.ammo <= 0) return false;\r\n    if (this.isStunned) return false;\r\n\r\n    // Use effective fire rate (includes passive bonus)\r\n    const fireInterval = 1000 / this.getEffectiveFireRate();\r\n    \r\n    return time >= this.weapon.lastFireTime + fireInterval;\r\n  }\r\n\r\n  fire(time: number): void {\r\n    if (!this.canFire(time)) return;\r\n\r\n    this.weapon.lastFireTime = time;\r\n    this.weapon.ammo--;\r\n\r\n    // Auto-reload when empty\r\n    if (this.weapon.ammo <= 0) {\r\n      const weaponDef = WEAPONS[this.weapon.weaponId];\r\n      this.weapon.reloading = true;\r\n      this.weapon.reloadEndTime = time + weaponDef.reloadTime;\r\n    }\r\n  }\r\n\r\n  canUseAbility(abilityIndex: number, _time: number): boolean {\r\n    if (!this.alive) return false;\r\n    if (this.isStunned) return false;\r\n    if (abilityIndex < 0 || abilityIndex >= this.abilities.length) return false;\r\n\r\n    const ability = this.abilities[abilityIndex];\r\n    if (!ability) return false;\r\n\r\n    const abilityDef = HEROES[this.heroId].abilities[abilityIndex];\r\n    if (!abilityDef) return false;\r\n\r\n    // Check ultimate charge\r\n    if (abilityDef.isUltimate && this.ultimateCharge < abilityDef.ultimateCost) {\r\n      return false;\r\n    }\r\n\r\n    // Check charges\r\n    return ability.charges > 0;\r\n  }\r\n\r\n  useAbility(abilityIndex: number, time: number): void {\r\n    if (!this.canUseAbility(abilityIndex, time)) return;\r\n\r\n    const ability = this.abilities[abilityIndex]!;\r\n    const abilityDef = HEROES[this.heroId].abilities[abilityIndex]!;\r\n\r\n    ability.charges--;\r\n    ability.cooldownEndTime = time + abilityDef.cooldown;\r\n\r\n    if (abilityDef.duration > 0) {\r\n      ability.active = true;\r\n      ability.duration = time + abilityDef.duration;\r\n    }\r\n\r\n    if (abilityDef.isUltimate) {\r\n      this.ultimateCharge = 0;\r\n    }\r\n  }\r\n\r\n  takeDamage(amount: number, attackerId: EntityId | null, time: number, damageType?: string): number {\r\n    if (!this.alive) return 0;\r\n\r\n    // Check fire immunity\r\n    if (damageType === 'fire' && this.isFireImmune) {\r\n      return 0; // No damage taken\r\n    }\r\n\r\n    // Apply passive damage reduction\r\n    let actualDamage = amount * (1 - this.damageReduction);\r\n    \r\n    // Apply to shield first\r\n    if (this.shield > 0) {\r\n      const shieldDamage = Math.min(this.shield, actualDamage);\r\n      this.shield -= shieldDamage;\r\n      actualDamage -= shieldDamage;\r\n    }\r\n\r\n    // Apply to health\r\n    this.health = Math.max(0, this.health - actualDamage);\r\n    this.lastDamageTime = time;\r\n    this.lastAttackerId = attackerId;\r\n\r\n    if (this.health <= 0) {\r\n      this.die(time);\r\n    }\r\n\r\n    return amount - actualDamage; // Return damage absorbed by shield\r\n  }\r\n\r\n  heal(amount: number): number {\r\n    if (!this.alive) return 0;\r\n\r\n    // Apply healing bonus passive\r\n    const bonusHeal = amount * (1 + this.healingBonus);\r\n    const actualHeal = Math.min(this.maxHealth - this.health, bonusHeal);\r\n    this.health += actualHeal;\r\n    return actualHeal;\r\n  }\r\n\r\n  addShield(amount: number): number {\r\n    const actualShield = Math.min(this.maxShield - this.shield, amount);\r\n    this.shield += actualShield;\r\n    return actualShield;\r\n  }\r\n\r\n  die(time: number): void {\r\n    this.alive = false;\r\n    this.health = 0;\r\n    this.deaths++;\r\n    this.velocity = Vec2.zero();\r\n    this.deathTime = time;  // Track when death occurred\r\n    this.respawnTime = time + GAMEPLAY.ROUND_TIME; // No respawn in round-based\r\n  }\r\n\r\n  respawn(position: Vector2): void {\r\n    this.alive = true;\r\n    this.health = this.maxHealth;\r\n    this.shield = this.maxShield;\r\n    this.position = { ...position };\r\n    this.prevPosition = { ...position };\r\n    this.velocity = Vec2.zero();\r\n    this.isSlowed = false;\r\n    this.isStunned = false;\r\n    this.isInvisible = false;\r\n    \r\n    // Reset weapon\r\n    const weaponDef = WEAPONS[this.weapon.weaponId];\r\n    this.weapon.ammo = weaponDef.ammoCapacity;\r\n    this.weapon.reloading = false;\r\n  }\r\n\r\n  resetAbilities(): void {\r\n    const heroDef = HEROES[this.heroId];\r\n    for (let i = 0; i < this.abilities.length; i++) {\r\n      const ability = this.abilities[i];\r\n      const abilityDef = heroDef.abilities[i];\r\n      if (ability && abilityDef) {\r\n        ability.cooldownEndTime = 0;\r\n        ability.charges = abilityDef.charges;\r\n        ability.active = false;\r\n        ability.duration = 0;\r\n      }\r\n    }\r\n    // Keep ultimate charge across rounds (intentional game design)\r\n  }\r\n\r\n  setInput(input: PlayerInput): void {\r\n    this.input = { ...input };\r\n  }\r\n\r\n  switchToWeaponSlot(slot: number): boolean {\r\n    if (slot < 1 || slot > 10) return false;\r\n    const index = slot - 1;\r\n    \r\n    const targetWeapon = this.weaponInventory[index];\r\n    if (!targetWeapon) return false;\r\n    if (this.currentWeaponSlot === index) return false;\r\n    \r\n    // Don't switch while reloading\r\n    if (this.weapon.reloading) return false;\r\n    \r\n    this.currentWeaponSlot = index;\r\n    this.weapon = targetWeapon;\r\n    return true;\r\n  }\r\n\r\n  // Cycle to next owned weapon (mouse wheel down)\r\n  cycleWeaponNext(): boolean {\r\n    if (this.weapon.reloading) return false;\r\n    \r\n    // Find next available weapon slot\r\n    for (let i = 1; i <= 10; i++) {\r\n      const nextSlot = (this.currentWeaponSlot + i) % 10;\r\n      if (this.weaponInventory[nextSlot]) {\r\n        this.currentWeaponSlot = nextSlot;\r\n        this.weapon = this.weaponInventory[nextSlot]!;\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // Cycle to previous owned weapon (mouse wheel up)\r\n  cycleWeaponPrevious(): boolean {\r\n    if (this.weapon.reloading) return false;\r\n    \r\n    // Find previous available weapon slot\r\n    for (let i = 1; i <= 10; i++) {\r\n      const prevSlot = (this.currentWeaponSlot - i + 10) % 10;\r\n      if (this.weaponInventory[prevSlot]) {\r\n        this.currentWeaponSlot = prevSlot;\r\n        this.weapon = this.weaponInventory[prevSlot]!;\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  getWeaponSlotForId(weaponId: WeaponId): number {\r\n    // Map weapon IDs to slots\r\n    switch (weaponId) {\r\n      case WeaponId.BurstPistol: return 1;\r\n      case WeaponId.NeoSMG9: return 2;\r\n      case WeaponId.PulseRifle: return 3;\r\n      case WeaponId.ScatterShot: return 4;\r\n      case WeaponId.RailSniper: return 5;\r\n      case WeaponId.ShardLauncher: return 6;\r\n      case WeaponId.NanoRepeater: return 7;\r\n      case WeaponId.ArcWelder: return 8;\r\n      case WeaponId.PhaseRepeater: return 9;\r\n      case WeaponId.PlasmaCannon: return 10;\r\n      default: return 1;\r\n    }\r\n  }\r\n\r\n  buyWeapon(weaponId: WeaponId): boolean {\r\n    const weaponDef = WEAPONS[weaponId];\r\n    if (this.credits < weaponDef.price) return false;\r\n\r\n    this.credits -= weaponDef.price;\r\n    \r\n    const newWeapon: WeaponState = {\r\n      weaponId,\r\n      ammo: weaponDef.ammoCapacity,\r\n      maxAmmo: weaponDef.ammoCapacity,\r\n      reloading: false,\r\n      reloadEndTime: 0,\r\n      lastFireTime: 0,\r\n    };\r\n    \r\n    // Put in appropriate slot\r\n    const slot = this.getWeaponSlotForId(weaponId);\r\n    const index = slot - 1;\r\n    this.weaponInventory[index] = newWeapon;\r\n    \r\n    // Auto-switch to new weapon\r\n    this.currentWeaponSlot = index;\r\n    this.weapon = newWeapon;\r\n\r\n    return true;\r\n  }\r\n\r\n  getCollisionBody(): CollisionBody {\r\n    return {\r\n      id: this.id,\r\n      position: this.position,\r\n      velocity: this.velocity,\r\n      collider: {\r\n        type: ColliderType.Circle,\r\n        offset: { x: 0, y: 0 },\r\n        radius: 16,\r\n      },\r\n      layer: this.team === Team.Attackers ? CollisionLayers.PLAYER : CollisionLayers.ENEMY,\r\n      mask: CollisionLayers.WALL | CollisionLayers.PLAYER | CollisionLayers.ENEMY | CollisionLayers.TRIGGER,\r\n      isStatic: false,\r\n      isTrigger: false,\r\n      userData: this,\r\n    };\r\n  }\r\n\r\n  toState(): PlayerState {\r\n    return {\r\n      id: this.id,\r\n      name: this.name,\r\n      peerId: this.peerId,\r\n      team: this.team,\r\n      heroId: this.heroId,\r\n      position: { ...this.position },\r\n      velocity: { ...this.velocity },\r\n      rotation: this.rotation,\r\n      health: this.health,\r\n      maxHealth: this.maxHealth,\r\n      shield: this.shield,\r\n      maxShield: this.maxShield,\r\n      alive: this.alive,\r\n      credits: this.credits,\r\n      kills: this.kills,\r\n      deaths: this.deaths,\r\n      assists: this.assists,\r\n      weapon: { ...this.weapon },\r\n      abilities: this.abilities.map(a => ({ ...a })),\r\n      input: { ...this.input },\r\n    };\r\n  }\r\n\r\n  static fromState(state: PlayerState): Player {\r\n    const player = new Player(\r\n      state.peerId,\r\n      state.name,\r\n      state.team,\r\n      state.heroId,\r\n      state.position\r\n    );\r\n\r\n    player.velocity = { ...state.velocity };\r\n    player.rotation = state.rotation;\r\n    player.health = state.health;\r\n    player.maxHealth = state.maxHealth;\r\n    player.shield = state.shield;\r\n    player.maxShield = state.maxShield;\r\n    player.alive = state.alive;\r\n    player.credits = state.credits;\r\n    player.kills = state.kills;\r\n    player.deaths = state.deaths;\r\n    player.assists = state.assists;\r\n    player.weapon = { ...state.weapon };\r\n    player.abilities = state.abilities.map(a => ({ ...a }));\r\n    player.input = { ...state.input };\r\n\r\n    return player;\r\n  }\r\n}\r\n","// ============================================================================\r\n// PROJECTILE ENTITY (for non-hitscan weapons or abilities)\r\n// ============================================================================\r\n\r\nimport { EntityId, Vector2, ProjectileState } from '@/shared/types';\r\nimport { Vec2, generateId } from '@/shared/utils';\r\nimport { CollisionBody, ColliderType, CollisionLayers } from '@/engine/CollisionSystem';\r\n\r\nexport class Projectile {\r\n  public readonly id: EntityId;\r\n  public readonly ownerId: EntityId;\r\n  public position: Vector2;\r\n  public prevPosition: Vector2;\r\n  public velocity: Vector2;\r\n  public damage: number;\r\n  public lifetime: number;\r\n  public spawnTime: number;\r\n  public active: boolean;\r\n  public radius: number;\r\n\r\n  constructor(\r\n    ownerId: EntityId,\r\n    position: Vector2,\r\n    direction: Vector2,\r\n    speed: number,\r\n    damage: number,\r\n    lifetime: number,\r\n    spawnTime: number\r\n  ) {\r\n    this.id = generateId('proj');\r\n    this.ownerId = ownerId;\r\n    this.position = { ...position };\r\n    this.prevPosition = { ...position };\r\n    this.velocity = Vec2.mul(Vec2.normalize(direction), speed);\r\n    this.damage = damage;\r\n    this.lifetime = lifetime;\r\n    this.spawnTime = spawnTime;\r\n    this.active = true;\r\n    this.radius = 4;\r\n  }\r\n\r\n  update(dt: number, time: number): void {\r\n    if (!this.active) return;\r\n\r\n    // Store previous position\r\n    this.prevPosition = { ...this.position };\r\n\r\n    // Move\r\n    this.position = Vec2.add(this.position, Vec2.mul(this.velocity, dt / 1000));\r\n\r\n    // Check lifetime\r\n    if (time >= this.spawnTime + this.lifetime) {\r\n      this.active = false;\r\n    }\r\n  }\r\n\r\n  destroy(): void {\r\n    this.active = false;\r\n  }\r\n\r\n  getCollisionBody(): CollisionBody {\r\n    return {\r\n      id: this.id,\r\n      position: this.position,\r\n      velocity: this.velocity,\r\n      collider: {\r\n        type: ColliderType.Circle,\r\n        offset: { x: 0, y: 0 },\r\n        radius: this.radius,\r\n      },\r\n      layer: CollisionLayers.PROJECTILE,\r\n      mask: CollisionLayers.PLAYER | CollisionLayers.ENEMY | CollisionLayers.WALL,\r\n      isStatic: false,\r\n      isTrigger: true,\r\n      userData: this,\r\n    };\r\n  }\r\n\r\n  toState(): ProjectileState {\r\n    return {\r\n      id: this.id,\r\n      ownerId: this.ownerId,\r\n      position: { ...this.position },\r\n      velocity: { ...this.velocity },\r\n      damage: this.damage,\r\n      lifetime: this.lifetime,\r\n      spawnTime: this.spawnTime,\r\n    };\r\n  }\r\n\r\n  static fromState(state: ProjectileState): Projectile {\r\n    const proj = new Projectile(\r\n      state.ownerId,\r\n      state.position,\r\n      Vec2.normalize(state.velocity),\r\n      Vec2.length(state.velocity),\r\n      state.damage,\r\n      state.lifetime,\r\n      state.spawnTime\r\n    );\r\n    proj.velocity = { ...state.velocity };\r\n    return proj;\r\n  }\r\n}\r\n","// ============================================================================\r\n// GAME MAP\r\n// ============================================================================\r\n\r\nimport { MapData, Vector2, Rectangle, Team, SpawnPoint } from '@/shared/types';\r\nimport { CollisionBody, ColliderType, CollisionLayers, CollisionWorld } from '@/engine/CollisionSystem';\r\nimport { generateId } from '@/shared/utils';\r\n\r\nexport class GameMap {\r\n  public readonly data: MapData;\r\n  private collisionBodies: CollisionBody[] = [];\r\n\r\n  constructor(data: MapData) {\r\n    this.data = data;\r\n    this.buildCollision();\r\n  }\r\n\r\n  private buildCollision(): void {\r\n    // Convert tile map to collision bodies\r\n    for (let y = 0; y < this.data.tiles.length; y++) {\r\n      const row = this.data.tiles[y];\r\n      if (!row) continue;\r\n\r\n      for (let x = 0; x < row.length; x++) {\r\n        const tile = row[x];\r\n        \r\n        // 0 = empty, 1 = wall\r\n        if (tile === 1) {\r\n          const body: CollisionBody = {\r\n            id: generateId('wall'),\r\n            position: {\r\n              x: x * this.data.tileSize,\r\n              y: y * this.data.tileSize,\r\n            },\r\n            velocity: { x: 0, y: 0 },\r\n            collider: {\r\n              type: ColliderType.Box,\r\n              offset: { x: 0, y: 0 },\r\n              width: this.data.tileSize,\r\n              height: this.data.tileSize,\r\n            },\r\n            layer: CollisionLayers.WALL,\r\n            mask: CollisionLayers.ALL,\r\n            isStatic: true,\r\n            isTrigger: false,\r\n          };\r\n          this.collisionBodies.push(body);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Add prop colliders\r\n    for (const prop of this.data.props) {\r\n      if (prop.collider) {\r\n        const body: CollisionBody = {\r\n          id: generateId('prop'),\r\n          position: prop.position,\r\n          velocity: { x: 0, y: 0 },\r\n          collider: {\r\n            type: ColliderType.Box,\r\n            offset: { x: 0, y: 0 },\r\n            width: prop.collider.width,\r\n            height: prop.collider.height,\r\n          },\r\n          layer: CollisionLayers.WALL,\r\n          mask: CollisionLayers.ALL,\r\n          isStatic: true,\r\n          isTrigger: false,\r\n        };\r\n        this.collisionBodies.push(body);\r\n      }\r\n    }\r\n  }\r\n\r\n  registerCollision(world: CollisionWorld): void {\r\n    for (const body of this.collisionBodies) {\r\n      world.addBody(body);\r\n    }\r\n  }\r\n\r\n  getSpawnPoints(team: Team): SpawnPoint[] {\r\n    return this.data.spawnPoints.filter(sp => sp.team === team);\r\n  }\r\n\r\n  getSpawnPoint(team: Team, index: number): Vector2 {\r\n    const spawns = this.getSpawnPoints(team);\r\n    const spawn = spawns[index % spawns.length];\r\n    return spawn ? { ...spawn.position } : { x: 0, y: 0 };\r\n  }\r\n\r\n  getSpikeSites(): Rectangle[] {\r\n    return this.data.spikeSites;\r\n  }\r\n\r\n  isInSpikeSite(position: Vector2): number {\r\n    for (let i = 0; i < this.data.spikeSites.length; i++) {\r\n      const site = this.data.spikeSites[i]!;\r\n      if (\r\n        position.x >= site.x &&\r\n        position.x <= site.x + site.width &&\r\n        position.y >= site.y &&\r\n        position.y <= site.y + site.height\r\n      ) {\r\n        return i;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  getTileAt(worldX: number, worldY: number): number {\r\n    const tileX = Math.floor(worldX / this.data.tileSize);\r\n    const tileY = Math.floor(worldY / this.data.tileSize);\r\n\r\n    if (tileY < 0 || tileY >= this.data.tiles.length) return 1;\r\n    const row = this.data.tiles[tileY];\r\n    if (!row || tileX < 0 || tileX >= row.length) return 1;\r\n\r\n    return row[tileX] ?? 1;\r\n  }\r\n\r\n  isWalkable(worldX: number, worldY: number): boolean {\r\n    return this.getTileAt(worldX, worldY) === 0;\r\n  }\r\n\r\n  getWidth(): number {\r\n    return this.data.width;\r\n  }\r\n\r\n  getHeight(): number {\r\n    return this.data.height;\r\n  }\r\n\r\n  getTileSize(): number {\r\n    return this.data.tileSize;\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// MAP REGISTRY - All available maps\r\n// ============================================================================\r\n\r\nexport interface MapInfo {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n  hasSpikeSites: boolean;\r\n  recommended: string; // Recommended game mode\r\n}\r\n\r\n// Registry of all available maps\r\nexport const MAP_REGISTRY: MapInfo[] = [\r\n  // Deathmatch maps (no spike sites)\r\n  { id: 'neon_arena', name: 'Neon Arena', description: 'Classic symmetrical arena', hasSpikeSites: false, recommended: 'Deathmatch' },\r\n  { id: 'reactor_core', name: 'Reactor Core', description: 'Circular arena with central cover', hasSpikeSites: false, recommended: 'Deathmatch' },\r\n  { id: 'grid_maze', name: 'Grid Maze', description: 'Complex maze with many corners', hasSpikeSites: false, recommended: 'Deathmatch' },\r\n  { id: 'neon_tower', name: 'Neon Tower', description: 'Vertical tower with open floors', hasSpikeSites: false, recommended: 'Deathmatch' },\r\n  { id: 'crossfire', name: 'Crossfire', description: 'Four-way intersection battle', hasSpikeSites: false, recommended: 'Deathmatch' },\r\n  { id: 'warehouse', name: 'Warehouse', description: 'Industrial storage facility', hasSpikeSites: false, recommended: 'Deathmatch' },\r\n  // Spike maps (have spike sites)\r\n  { id: 'cyber_district', name: 'Cyber District', description: 'Urban streets with spike sites', hasSpikeSites: true, recommended: 'Data Spike' },\r\n  { id: 'helix_labs', name: 'Helix Labs', description: 'Tight corridors and open labs', hasSpikeSites: true, recommended: 'Data Spike' },\r\n  { id: 'sky_bridge', name: 'Sky Bridge', description: 'Three lanes connected by bridges', hasSpikeSites: true, recommended: 'Data Spike' },\r\n  { id: 'data_vault', name: 'Data Vault', description: 'Secure vault with multiple entries', hasSpikeSites: true, recommended: 'Data Spike' },\r\n  { id: 'server_farm', name: 'Server Farm', description: 'High-tech data center', hasSpikeSites: true, recommended: 'Data Spike' },\r\n  { id: 'nexus_hub', name: 'Nexus Hub', description: 'Central network control room', hasSpikeSites: true, recommended: 'Data Spike' },\r\n];\r\n\r\n// Get map by ID\r\nexport function getMapById(mapId: string): GameMap {\r\n  switch (mapId) {\r\n    case 'neon_arena':\r\n      return createNeonArenaMap();\r\n    case 'cyber_district':\r\n      return createCyberDistrictMap();\r\n    case 'helix_labs':\r\n      return createHelixLabsMap();\r\n    case 'reactor_core':\r\n      return createReactorCoreMap();\r\n    case 'grid_maze':\r\n      return createGridMazeMap();\r\n    case 'sky_bridge':\r\n      return createSkyBridgeMap();\r\n    case 'data_vault':\r\n      return createDataVaultMap();\r\n    case 'neon_tower':\r\n      return createNeonTowerMap();\r\n    case 'crossfire':\r\n      return createCrossfireMap();\r\n    case 'warehouse':\r\n      return createWarehouseMap();\r\n    case 'server_farm':\r\n      return createServerFarmMap();\r\n    case 'nexus_hub':\r\n      return createNexusHubMap();\r\n    default:\r\n      console.warn(`Unknown map ID: ${mapId}, falling back to neon_arena`);\r\n      return createNeonArenaMap();\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// MAP 1: NEON ARENA - Classic symmetrical deathmatch arena (no spike sites)\r\n// ============================================================================\r\n\r\nexport function createNeonArenaMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 40;\r\n  const height = 30;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Center pillars (larger)\r\n      else if (x >= 18 && x <= 21 && y >= 13 && y <= 16) {\r\n        row.push(1);\r\n      }\r\n      // Left side cover (staggered)\r\n      else if (\r\n        (x >= 6 && x <= 8 && y >= 8 && y <= 10) ||\r\n        (x >= 10 && x <= 12 && y >= 13 && y <= 16) ||\r\n        (x >= 6 && x <= 8 && y >= 19 && y <= 21)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Right side cover (mirrored)\r\n      else if (\r\n        (x >= 31 && x <= 33 && y >= 8 && y <= 10) ||\r\n        (x >= 27 && x <= 29 && y >= 13 && y <= 16) ||\r\n        (x >= 31 && x <= 33 && y >= 19 && y <= 21)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Mid lane walls\r\n      else if (\r\n        (x >= 15 && x <= 17 && y === 8) ||\r\n        (x >= 22 && x <= 24 && y === 8) ||\r\n        (x >= 15 && x <= 17 && y === 21) ||\r\n        (x >= 22 && x <= 24 && y === 21)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'neon_arena',\r\n    name: 'Neon Arena',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      // Attackers (left side)\r\n      { position: { x: 80, y: 240 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 80, y: 340 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 80, y: 440 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 80, y: 540 }, team: Team.Attackers, index: 3 },\r\n      // Defenders (right side)\r\n      { position: { x: 1200, y: 240 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: 1200, y: 340 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: 1200, y: 440 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: 1200, y: 540 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [], // No spike sites - deathmatch map\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 2: CYBER DISTRICT - Urban streets with two spike sites\r\n// ============================================================================\r\n\r\nexport function createCyberDistrictMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 45;\r\n  const height = 32;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Left spawn building\r\n      else if (x >= 2 && x <= 6 && y >= 2 && y <= 6) {\r\n        row.push(1);\r\n      }\r\n      else if (x >= 2 && x <= 6 && y >= height - 7 && y <= height - 3) {\r\n        row.push(1);\r\n      }\r\n      // Right spawn building  \r\n      else if (x >= width - 7 && x <= width - 3 && y >= 2 && y <= 6) {\r\n        row.push(1);\r\n      }\r\n      else if (x >= width - 7 && x <= width - 3 && y >= height - 7 && y <= height - 3) {\r\n        row.push(1);\r\n      }\r\n      // Site A area walls (top-right quadrant)\r\n      else if (x >= 28 && x <= 30 && y >= 4 && y <= 8) {\r\n        row.push(1);\r\n      }\r\n      else if (x >= 34 && x <= 36 && y >= 8 && y <= 10) {\r\n        row.push(1);\r\n      }\r\n      // Site B area walls (bottom-right quadrant)\r\n      else if (x >= 28 && x <= 30 && y >= height - 9 && y <= height - 5) {\r\n        row.push(1);\r\n      }\r\n      else if (x >= 34 && x <= 36 && y >= height - 11 && y <= height - 9) {\r\n        row.push(1);\r\n      }\r\n      // Middle corridor walls\r\n      else if (x >= 14 && x <= 16 && y >= 12 && y <= 14) {\r\n        row.push(1);\r\n      }\r\n      else if (x >= 14 && x <= 16 && y >= height - 15 && y <= height - 13) {\r\n        row.push(1);\r\n      }\r\n      // Central building\r\n      else if (x >= 20 && x <= 24 && y >= 13 && y <= 18) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'cyber_district',\r\n    name: 'Cyber District',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      // Attackers (left side)\r\n      { position: { x: 80, y: 300 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 80, y: 400 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 80, y: 500 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 80, y: 600 }, team: Team.Attackers, index: 3 },\r\n      // Defenders (right side, near sites)\r\n      { position: { x: width * tileSize - 100, y: 200 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 100, y: 300 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 100, y: 700 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 100, y: 800 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [\r\n      { x: 960, y: 128, width: 224, height: 160 },   // Site A (top-right)\r\n      { x: 960, y: height * tileSize - 288, width: 224, height: 160 },  // Site B (bottom-right)\r\n    ],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 3: HELIX LABS - Research facility with tight corridors\r\n// ============================================================================\r\n\r\nexport function createHelixLabsMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 50;\r\n  const height = 35;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Left wing labs\r\n      else if (\r\n        (x >= 3 && x <= 10 && y === 8) ||\r\n        (x >= 3 && x <= 10 && y === 16) ||\r\n        (x === 10 && y >= 8 && y <= 16)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Left wing bottom labs\r\n      else if (\r\n        (x >= 3 && x <= 10 && y === height - 9) ||\r\n        (x >= 3 && x <= 10 && y === height - 17) ||\r\n        (x === 10 && y >= height - 17 && y <= height - 9)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Central corridor walls\r\n      else if (\r\n        (x >= 18 && x <= 20 && y >= 10 && y <= 12) ||\r\n        (x >= 18 && x <= 20 && y >= height - 13 && y <= height - 11) ||\r\n        (x >= 29 && x <= 31 && y >= 10 && y <= 12) ||\r\n        (x >= 29 && x <= 31 && y >= height - 13 && y <= height - 11)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Central lab (large)\r\n      else if (x >= 22 && x <= 27 && y >= 15 && y <= 19) {\r\n        row.push(1);\r\n      }\r\n      // Site A enclosure (top right)\r\n      else if (\r\n        (x >= 38 && x <= 46 && y === 5) ||\r\n        (x >= 38 && x <= 46 && y === 12) ||\r\n        (x === 38 && y >= 5 && y <= 12)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Site B enclosure (bottom right)\r\n      else if (\r\n        (x >= 38 && x <= 46 && y === height - 6) ||\r\n        (x >= 38 && x <= 46 && y === height - 13) ||\r\n        (x === 38 && y >= height - 13 && y <= height - 6)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'helix_labs',\r\n    name: 'Helix Labs',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      // Attackers (left side in labs)\r\n      { position: { x: 64, y: 350 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 64, y: 450 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 64, y: 550 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 64, y: 650 }, team: Team.Attackers, index: 3 },\r\n      // Defenders (right side near sites)\r\n      { position: { x: width * tileSize - 80, y: 250 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 80, y: 350 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 80, y: 750 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 80, y: 850 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [\r\n      { x: 1248, y: 192, width: 256, height: 192 },   // Site A (top-right lab)\r\n      { x: 1248, y: height * tileSize - 384, width: 256, height: 192 },  // Site B (bottom-right lab)\r\n    ],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 4: REACTOR CORE - Circular arena with central reactor\r\n// ============================================================================\r\n\r\nexport function createReactorCoreMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 38;\r\n  const height = 38;\r\n  const centerX = Math.floor(width / 2);\r\n  const centerY = Math.floor(height / 2);\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      const dx = x - centerX;\r\n      const dy = y - centerY;\r\n      const dist = Math.sqrt(dx * dx + dy * dy);\r\n\r\n      // Outer border (circular-ish)\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Cut corners to make it more circular\r\n      else if (\r\n        (x < 4 && y < 4) || (x < 4 && y > height - 5) ||\r\n        (x > width - 5 && y < 4) || (x > width - 5 && y > height - 5)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Central reactor core (hollow circle)\r\n      else if (dist >= 4 && dist <= 6) {\r\n        // Leave gaps for entrances\r\n        const angle = Math.atan2(dy, dx);\r\n        const normalizedAngle = ((angle + Math.PI) / (2 * Math.PI)) * 360;\r\n        // Gaps at 0, 90, 180, 270\r\n        const isGap = \r\n          (normalizedAngle >= 355 || normalizedAngle <= 5) ||\r\n          (normalizedAngle >= 85 && normalizedAngle <= 95) ||\r\n          (normalizedAngle >= 175 && normalizedAngle <= 185) ||\r\n          (normalizedAngle >= 265 && normalizedAngle <= 275);\r\n        row.push(isGap ? 0 : 1);\r\n      }\r\n      // Inner ring cover\r\n      else if (dist >= 10 && dist <= 11) {\r\n        const angle = Math.atan2(dy, dx);\r\n        const normalizedAngle = ((angle + Math.PI) / (2 * Math.PI)) * 360;\r\n        // Pillars at 45, 135, 225, 315\r\n        const isPillar = \r\n          (normalizedAngle >= 40 && normalizedAngle <= 50) ||\r\n          (normalizedAngle >= 130 && normalizedAngle <= 140) ||\r\n          (normalizedAngle >= 220 && normalizedAngle <= 230) ||\r\n          (normalizedAngle >= 310 && normalizedAngle <= 320);\r\n        row.push(isPillar ? 1 : 0);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'reactor_core',\r\n    name: 'Reactor Core',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      // Attackers (left side)\r\n      { position: { x: 100, y: centerY * tileSize - 80 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 100, y: centerY * tileSize }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 100, y: centerY * tileSize + 80 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 150, y: centerY * tileSize + 160 }, team: Team.Attackers, index: 3 },\r\n      // Defenders (right side)\r\n      { position: { x: width * tileSize - 100, y: centerY * tileSize - 80 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 100, y: centerY * tileSize }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 100, y: centerY * tileSize + 80 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 150, y: centerY * tileSize + 160 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [], // No spike sites - deathmatch arena\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 5: GRID MAZE - Complex maze with many corners and ambush points\r\n// ============================================================================\r\n\r\nexport function createGridMazeMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 42;\r\n  const height = 32;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Grid pattern - vertical walls every 6 tiles with gaps\r\n      else if (x % 6 === 3 && y > 2 && y < height - 3) {\r\n        // Leave gaps at certain y positions\r\n        if ((y >= 7 && y <= 9) || (y >= 14 && y <= 16) || (y >= 22 && y <= 24)) {\r\n          row.push(0);\r\n        } else {\r\n          row.push(1);\r\n        }\r\n      }\r\n      // Horizontal walls to create maze sections\r\n      else if (y === 7 && x > 1 && x < width - 2 && x % 6 !== 0) {\r\n        row.push(1);\r\n      }\r\n      else if (y === 16 && x > 1 && x < width - 2 && x % 6 !== 3) {\r\n        row.push(1);\r\n      }\r\n      else if (y === 24 && x > 1 && x < width - 2 && x % 6 !== 0) {\r\n        row.push(1);\r\n      }\r\n      // Corner blocks for cover\r\n      else if (\r\n        (x >= 8 && x <= 10 && y >= 11 && y <= 13) ||\r\n        (x >= 20 && x <= 22 && y >= 11 && y <= 13) ||\r\n        (x >= 31 && x <= 33 && y >= 11 && y <= 13) ||\r\n        (x >= 14 && x <= 16 && y >= 19 && y <= 21) ||\r\n        (x >= 26 && x <= 28 && y >= 19 && y <= 21)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'grid_maze',\r\n    name: 'Grid Maze',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      { position: { x: 64, y: 150 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 64, y: 350 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 64, y: 550 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 64, y: 750 }, team: Team.Attackers, index: 3 },\r\n      { position: { x: width * tileSize - 64, y: 150 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 64, y: 350 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 64, y: 550 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 64, y: 750 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 6: SKY BRIDGE - Three parallel lanes with connecting bridges\r\n// ============================================================================\r\n\r\nexport function createSkyBridgeMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 48;\r\n  const height = 36;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Top lane walls (y = 8)\r\n      else if (y === 8 && x > 3 && x < width - 4) {\r\n        // Gaps for bridges at x=15, x=32\r\n        if ((x >= 14 && x <= 16) || (x >= 31 && x <= 33)) {\r\n          row.push(0);\r\n        } else {\r\n          row.push(1);\r\n        }\r\n      }\r\n      // Bottom lane walls (y = 27)\r\n      else if (y === 27 && x > 3 && x < width - 4) {\r\n        if ((x >= 14 && x <= 16) || (x >= 31 && x <= 33)) {\r\n          row.push(0);\r\n        } else {\r\n          row.push(1);\r\n        }\r\n      }\r\n      // Middle lane cover blocks\r\n      else if (\r\n        (x >= 10 && x <= 12 && y >= 16 && y <= 19) ||\r\n        (x >= 22 && x <= 25 && y >= 15 && y <= 20) ||\r\n        (x >= 35 && x <= 37 && y >= 16 && y <= 19)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Site A enclosure (top right)\r\n      else if (\r\n        (x >= 38 && x <= 44 && y === 3) ||\r\n        (x === 38 && y >= 3 && y <= 7)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Site B enclosure (bottom right)\r\n      else if (\r\n        (x >= 38 && x <= 44 && y === height - 4) ||\r\n        (x === 38 && y >= height - 8 && y <= height - 4)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Left spawn protection\r\n      else if (x === 6 && ((y >= 10 && y <= 14) || (y >= 21 && y <= 25))) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'sky_bridge',\r\n    name: 'Sky Bridge',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      { position: { x: 80, y: 180 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 80, y: 400 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 80, y: 620 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 80, y: 900 }, team: Team.Attackers, index: 3 },\r\n      { position: { x: width * tileSize - 80, y: 180 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 80, y: 400 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 80, y: 620 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 80, y: 900 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [\r\n      { x: 1248, y: 96, width: 192, height: 160 },   // Site A (top-right)\r\n      { x: 1248, y: height * tileSize - 256, width: 192, height: 160 },  // Site B (bottom-right)\r\n    ],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 7: DATA VAULT - Secure vault with multiple entry points\r\n// ============================================================================\r\n\r\nexport function createDataVaultMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 44;\r\n  const height = 34;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Outer vault walls (forms a large rectangle on right side)\r\n      else if (x === 24 && y >= 4 && y <= height - 5) {\r\n        // Entry doors at specific points\r\n        if ((y >= 8 && y <= 10) || (y >= 16 && y <= 17) || (y >= 23 && y <= 25)) {\r\n          row.push(0);\r\n        } else {\r\n          row.push(1);\r\n        }\r\n      }\r\n      else if (y === 4 && x >= 24 && x < width - 1) {\r\n        row.push(1);\r\n      }\r\n      else if (y === height - 5 && x >= 24 && x < width - 1) {\r\n        row.push(1);\r\n      }\r\n      // Inner vault walls (two secure rooms)\r\n      else if (x === 32 && y >= 6 && y <= 13) {\r\n        if (y >= 9 && y <= 10) row.push(0); // Door\r\n        else row.push(1);\r\n      }\r\n      else if (x === 32 && y >= height - 14 && y <= height - 7) {\r\n        if (y >= height - 12 && y <= height - 11) row.push(0); // Door\r\n        else row.push(1);\r\n      }\r\n      else if (y === 6 && x >= 32 && x <= 40) {\r\n        row.push(1);\r\n      }\r\n      else if (y === 13 && x >= 32 && x <= 40) {\r\n        row.push(1);\r\n      }\r\n      else if (y === height - 14 && x >= 32 && x <= 40) {\r\n        row.push(1);\r\n      }\r\n      else if (y === height - 7 && x >= 32 && x <= 40) {\r\n        row.push(1);\r\n      }\r\n      // Left side cover\r\n      else if (\r\n        (x >= 6 && x <= 8 && y >= 8 && y <= 11) ||\r\n        (x >= 12 && x <= 14 && y >= 14 && y <= 19) ||\r\n        (x >= 6 && x <= 8 && y >= 22 && y <= 25) ||\r\n        (x >= 16 && x <= 18 && y >= 8 && y <= 10) ||\r\n        (x >= 16 && x <= 18 && y >= 23 && y <= 25)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'data_vault',\r\n    name: 'Data Vault',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      { position: { x: 64, y: 200 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 64, y: 400 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 64, y: 600 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 64, y: 800 }, team: Team.Attackers, index: 3 },\r\n      { position: { x: width * tileSize - 80, y: 300 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 80, y: 450 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 80, y: 600 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 80, y: 750 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [\r\n      { x: 1056, y: 224, width: 224, height: 192 },   // Site A (top vault room)\r\n      { x: 1056, y: height * tileSize - 416, width: 224, height: 192 },  // Site B (bottom vault room)\r\n    ],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 8: NEON TOWER - Vertical feel with open platforms\r\n// ============================================================================\r\n\r\nexport function createNeonTowerMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 36;\r\n  const height = 40;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Horizontal platforms (floor-like)\r\n      else if (y === 8 && x >= 4 && x <= 14) {\r\n        row.push(1);\r\n      }\r\n      else if (y === 8 && x >= 21 && x <= 31) {\r\n        row.push(1);\r\n      }\r\n      else if (y === 16 && x >= 8 && x <= 27) {\r\n        // Gap in middle\r\n        if (x >= 16 && x <= 19) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      else if (y === 24 && x >= 4 && x <= 31) {\r\n        // Gaps for movement\r\n        if ((x >= 10 && x <= 12) || (x >= 23 && x <= 25)) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      else if (y === 32 && x >= 8 && x <= 27) {\r\n        if (x >= 16 && x <= 19) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      // Vertical pillars\r\n      else if (\r\n        (x === 8 && y >= 10 && y <= 14) ||\r\n        (x === 27 && y >= 10 && y <= 14) ||\r\n        (x === 12 && y >= 26 && y <= 30) ||\r\n        (x === 23 && y >= 26 && y <= 30)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      // Center structure\r\n      else if (x >= 15 && x <= 20 && y >= 18 && y <= 22) {\r\n        row.push(1);\r\n      }\r\n      // Corner covers\r\n      else if (\r\n        (x >= 3 && x <= 5 && y >= 3 && y <= 5) ||\r\n        (x >= width - 6 && x <= width - 4 && y >= 3 && y <= 5) ||\r\n        (x >= 3 && x <= 5 && y >= height - 6 && y <= height - 4) ||\r\n        (x >= width - 6 && x <= width - 4 && y >= height - 6 && y <= height - 4)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'neon_tower',\r\n    name: 'Neon Tower',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      { position: { x: 100, y: 100 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 200, y: 100 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 100, y: 200 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 200, y: 200 }, team: Team.Attackers, index: 3 },\r\n      { position: { x: width * tileSize - 100, y: height * tileSize - 100 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 200, y: height * tileSize - 100 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 100, y: height * tileSize - 200 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 200, y: height * tileSize - 200 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 9: CROSSFIRE - Four-way intersection with open center\r\n// ============================================================================\r\n\r\nexport function createCrossfireMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 40;\r\n  const height = 40;\r\n  const centerX = Math.floor(width / 2);\r\n  const centerY = Math.floor(height / 2);\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Four corner buildings\r\n      else if (x >= 3 && x <= 10 && y >= 3 && y <= 10) {\r\n        // Top-left building with entry\r\n        if ((x === 10 && y >= 6 && y <= 8) || (y === 10 && x >= 6 && x <= 8)) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      else if (x >= width - 11 && x <= width - 4 && y >= 3 && y <= 10) {\r\n        // Top-right building\r\n        if ((x === width - 11 && y >= 6 && y <= 8) || (y === 10 && x >= width - 9 && x <= width - 7)) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      else if (x >= 3 && x <= 10 && y >= height - 11 && y <= height - 4) {\r\n        // Bottom-left building\r\n        if ((x === 10 && y >= height - 9 && y <= height - 7) || (y === height - 11 && x >= 6 && x <= 8)) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      else if (x >= width - 11 && x <= width - 4 && y >= height - 11 && y <= height - 4) {\r\n        // Bottom-right building\r\n        if ((x === width - 11 && y >= height - 9 && y <= height - 7) || (y === height - 11 && x >= width - 9 && x <= width - 7)) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      // Center cover (small cross)\r\n      else if (\r\n        (x >= centerX - 2 && x <= centerX + 2 && y >= centerY - 1 && y <= centerY + 1) ||\r\n        (x >= centerX - 1 && x <= centerX + 1 && y >= centerY - 2 && y <= centerY + 2)\r\n      ) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'crossfire',\r\n    name: 'Crossfire',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      { position: { x: 64, y: centerY * tileSize - 50 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 64, y: centerY * tileSize + 50 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 100, y: centerY * tileSize - 100 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 100, y: centerY * tileSize + 100 }, team: Team.Attackers, index: 3 },\r\n      { position: { x: width * tileSize - 64, y: centerY * tileSize - 50 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 64, y: centerY * tileSize + 50 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 100, y: centerY * tileSize - 100 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 100, y: centerY * tileSize + 100 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 10: WAREHOUSE - Industrial storage with crates\r\n// ============================================================================\r\n\r\nexport function createWarehouseMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 44;\r\n  const height = 32;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Crate rows (staggered pattern)\r\n      else if (y >= 5 && y <= 7 && ((x >= 8 && x <= 10) || (x >= 16 && x <= 18) || (x >= 24 && x <= 26) || (x >= 32 && x <= 34))) {\r\n        row.push(1);\r\n      }\r\n      else if (y >= 12 && y <= 14 && ((x >= 5 && x <= 7) || (x >= 13 && x <= 15) || (x >= 21 && x <= 23) || (x >= 29 && x <= 31) || (x >= 37 && x <= 39))) {\r\n        row.push(1);\r\n      }\r\n      else if (y >= 19 && y <= 21 && ((x >= 8 && x <= 10) || (x >= 16 && x <= 18) || (x >= 24 && x <= 26) || (x >= 32 && x <= 34))) {\r\n        row.push(1);\r\n      }\r\n      else if (y >= 26 && y <= 28 && ((x >= 5 && x <= 7) || (x >= 13 && x <= 15) || (x >= 21 && x <= 23) || (x >= 29 && x <= 31) || (x >= 37 && x <= 39))) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'warehouse',\r\n    name: 'Warehouse',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      { position: { x: 64, y: 160 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 64, y: 320 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 64, y: 480 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 64, y: 640 }, team: Team.Attackers, index: 3 },\r\n      { position: { x: width * tileSize - 64, y: 160 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 64, y: 320 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 64, y: 480 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 64, y: 640 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 11: SERVER FARM - High-tech data center with spike sites\r\n// ============================================================================\r\n\r\nexport function createServerFarmMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 48;\r\n  const height = 36;\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Server rack rows (vertical lines)\r\n      else if (x === 10 && y >= 4 && y <= height - 5) {\r\n        if ((y >= 10 && y <= 12) || (y >= 22 && y <= 24)) row.push(0); // gaps\r\n        else row.push(1);\r\n      }\r\n      else if (x === 18 && y >= 4 && y <= height - 5) {\r\n        if ((y >= 15 && y <= 19)) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      else if (x === 28 && y >= 4 && y <= height - 5) {\r\n        if ((y >= 15 && y <= 19)) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      else if (x === 36 && y >= 4 && y <= height - 5) {\r\n        if ((y >= 10 && y <= 12) || (y >= 22 && y <= 24)) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      // Site A enclosure (top right)\r\n      else if ((y === 5 && x >= 38 && x <= 44) || (x === 38 && y >= 5 && y <= 12)) {\r\n        row.push(1);\r\n      }\r\n      // Site B enclosure (bottom right)\r\n      else if ((y === height - 6 && x >= 38 && x <= 44) || (x === 38 && y >= height - 13 && y <= height - 6)) {\r\n        row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'server_farm',\r\n    name: 'Server Farm',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      { position: { x: 80, y: 200 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 80, y: 400 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 80, y: 600 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 80, y: 800 }, team: Team.Attackers, index: 3 },\r\n      { position: { x: width * tileSize - 80, y: 280 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 80, y: 450 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 80, y: 620 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 80, y: 790 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [\r\n      { x: 1248, y: 192, width: 192, height: 192 },   // Site A (top-right)\r\n      { x: 1248, y: height * tileSize - 384, width: 192, height: 192 },  // Site B (bottom-right)\r\n    ],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// ============================================================================\r\n// MAP 12: NEXUS HUB - Central control room with spike sites\r\n// ============================================================================\r\n\r\nexport function createNexusHubMap(): GameMap {\r\n  const tileSize = 32;\r\n  const width = 46;\r\n  const height = 38;\r\n  const centerX = Math.floor(width / 2);\r\n  const centerY = Math.floor(height / 2);\r\n\r\n  const tiles: number[][] = [];\r\n  for (let y = 0; y < height; y++) {\r\n    const row: number[] = [];\r\n    for (let x = 0; x < width; x++) {\r\n      // Border walls\r\n      if (x === 0 || x === width - 1 || y === 0 || y === height - 1) {\r\n        row.push(1);\r\n      }\r\n      // Central control room (hexagon-ish)\r\n      else if (\r\n        (x >= centerX - 5 && x <= centerX + 5 && (y === centerY - 4 || y === centerY + 4)) ||\r\n        (y >= centerY - 4 && y <= centerY + 4 && (x === centerX - 5 || x === centerX + 5))\r\n      ) {\r\n        // Leave entrances\r\n        if (\r\n          (y === centerY && (x === centerX - 5 || x === centerX + 5)) ||\r\n          (x === centerX && (y === centerY - 4 || y === centerY + 4))\r\n        ) {\r\n          row.push(0);\r\n        } else {\r\n          row.push(1);\r\n        }\r\n      }\r\n      // Left spawn area cover\r\n      else if ((x >= 6 && x <= 8 && y >= 12 && y <= 14) || (x >= 6 && x <= 8 && y >= 23 && y <= 25)) {\r\n        row.push(1);\r\n      }\r\n      // Site A (top right corner room)\r\n      else if (\r\n        (x === 32 && y >= 4 && y <= 12) ||\r\n        (y === 4 && x >= 32 && x <= 42) ||\r\n        (y === 12 && x >= 32 && x <= 42)\r\n      ) {\r\n        // Entry door\r\n        if (x === 32 && y >= 7 && y <= 9) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      // Site B (bottom right corner room)\r\n      else if (\r\n        (x === 32 && y >= height - 13 && y <= height - 5) ||\r\n        (y === height - 5 && x >= 32 && x <= 42) ||\r\n        (y === height - 13 && x >= 32 && x <= 42)\r\n      ) {\r\n        // Entry door\r\n        if (x === 32 && y >= height - 10 && y <= height - 8) row.push(0);\r\n        else row.push(1);\r\n      }\r\n      else {\r\n        row.push(0);\r\n      }\r\n    }\r\n    tiles.push(row);\r\n  }\r\n\r\n  const mapData: MapData = {\r\n    id: 'nexus_hub',\r\n    name: 'Nexus Hub',\r\n    width: width * tileSize,\r\n    height: height * tileSize,\r\n    tileSize,\r\n    tiles,\r\n    spawnPoints: [\r\n      { position: { x: 80, y: 300 }, team: Team.Attackers, index: 0 },\r\n      { position: { x: 80, y: 450 }, team: Team.Attackers, index: 1 },\r\n      { position: { x: 80, y: 600 }, team: Team.Attackers, index: 2 },\r\n      { position: { x: 80, y: 750 }, team: Team.Attackers, index: 3 },\r\n      { position: { x: width * tileSize - 80, y: 250 }, team: Team.Defenders, index: 0 },\r\n      { position: { x: width * tileSize - 80, y: 400 }, team: Team.Defenders, index: 1 },\r\n      { position: { x: width * tileSize - 80, y: 700 }, team: Team.Defenders, index: 2 },\r\n      { position: { x: width * tileSize - 80, y: 850 }, team: Team.Defenders, index: 3 },\r\n    ],\r\n    spikeSites: [\r\n      { x: 1056, y: 160, width: 288, height: 224 },   // Site A (top-right room)\r\n      { x: 1056, y: height * tileSize - 384, width: 288, height: 224 },  // Site B (bottom-right room)\r\n    ],\r\n    reactorPath: [],\r\n    props: [],\r\n  };\r\n\r\n  return new GameMap(mapData);\r\n}\r\n\r\n// Legacy function for backwards compatibility\r\nexport function createTestMap(): GameMap {\r\n  return createNeonArenaMap();\r\n}\r\n","// ============================================================================\r\n// BOT CONTROLLER INTERFACE\r\n// Abstraction layer for bot AI systems (Rule-based, SLM, etc.)\r\n// ============================================================================\r\n\r\nimport { PlayerInput, ObjectiveState, Vector2 } from '@/shared/types';\r\nimport { Player } from '@/game/entities/Player';\r\nimport { GameMap } from '@/game/map/GameMap';\r\nimport { CollisionWorld } from '@/engine/CollisionSystem';\r\n\r\n/**\r\n * Bot AI Mode - determines which AI system controls bots\r\n */\r\nexport enum BotAIMode {\r\n  RuleBased = 'rule_based',   // Traditional state machine AI (current)\r\n  SLM = 'slm',                // Small Language Model AI (future)\r\n}\r\n\r\n/**\r\n * Game context provided to bot controllers each frame\r\n */\r\nexport interface BotGameContext {\r\n  dt: number;                      // Delta time in ms\r\n  time: number;                    // Current game time\r\n  allPlayers: Player[];            // All players in the game\r\n  collisionWorld: CollisionWorld;  // For raycasting and collision checks\r\n  map: GameMap;                    // Current game map\r\n  objectives?: ObjectiveState;     // Spike/objective state\r\n}\r\n\r\n/**\r\n * Simple tactical intent enum - for quick decision making\r\n */\r\nexport enum TacticalIntent {\r\n  Aggressive = 'aggressive',    // Push forward, engage enemies\r\n  Defensive = 'defensive',      // Hold position, wait for enemies\r\n  Flanking = 'flanking',        // Move around to side/behind enemies\r\n  Supporting = 'supporting',    // Follow teammates, provide backup\r\n  Objective = 'objective',      // Focus on spike plant/defuse\r\n  Retreating = 'retreating',    // Fall back to safety\r\n  Patrolling = 'patrolling',    // Move around, look for enemies\r\n}\r\n\r\n/**\r\n * Detailed tactical decision from SLM (used by SLMBotController)\r\n */\r\nexport interface TacticalDecision {\r\n  intent: TacticalIntent;          // High-level intent\r\n  target?: string;                 // Target location or player\r\n  priority: number;                // 0-1, how important this action is\r\n  reasoning?: string;              // Optional: why this decision was made (for debugging)\r\n}\r\n\r\n/**\r\n * Bot state information exposed for SLM decision making\r\n */\r\nexport interface BotStateInfo {\r\n  // Bot info\r\n  botId: string;\r\n  position: Vector2;\r\n  health: number;\r\n  shield: number;\r\n  team: string;\r\n  isAlive: boolean;\r\n  \r\n  // Weapon state\r\n  ammo: number;\r\n  maxAmmo: number;\r\n  isReloading: boolean;\r\n  weaponName: string;\r\n  \r\n  // Abilities\r\n  ability1Ready: boolean;\r\n  ability2Ready: boolean;\r\n  ultimateReady: boolean;\r\n  ultimateCharge: number;\r\n  \r\n  // Awareness\r\n  visibleEnemies: Array<{\r\n    id: string;\r\n    position: Vector2;\r\n    health: number;\r\n    distance: number;\r\n  }>;\r\n  nearbyTeammates: Array<{\r\n    id: string;\r\n    position: Vector2;\r\n    health: number;\r\n    distance: number;\r\n  }>;\r\n  \r\n  // Objectives\r\n  hasSpikeCarrier: boolean;\r\n  spikePlanted: boolean;\r\n  spikePosition?: Vector2;\r\n  inSpikeSite: boolean;\r\n  \r\n  // Map context (simplified for SLM)\r\n  nearestCoverDirection?: Vector2;\r\n  distanceToNearestWall: number;\r\n  currentZone: string;  // 'spawn', 'mid', 'site_a', 'site_b', etc.\r\n}\r\n\r\n/**\r\n * Interface for bot controllers\r\n * Both rule-based and SLM-based controllers must implement this\r\n */\r\nexport interface IBotController {\r\n  /**\r\n   * Unique identifier for this controller type\r\n   */\r\n  readonly type: BotAIMode;\r\n  \r\n  /**\r\n   * Update the bot and return input for this frame\r\n   * @param context Game context for decision making\r\n   * @returns PlayerInput to apply to the bot\r\n   */\r\n  update(context: BotGameContext): PlayerInput;\r\n  \r\n  /**\r\n   * Get the current bot state info (for SLM or debugging)\r\n   */\r\n  getStateInfo(): BotStateInfo;\r\n  \r\n  /**\r\n   * Get the player this controller is managing\r\n   */\r\n  getPlayer(): Player;\r\n  \r\n  /**\r\n   * Set a high-level tactical intent (used by SLM to override behavior)\r\n   * Rule-based AI can ignore this or use it as a hint\r\n   */\r\n  setTacticalIntent?(intent: TacticalIntent): void;\r\n  \r\n  /**\r\n   * Get current tactical intent (for debugging/visualization)\r\n   */\r\n  getTacticalIntent?(): TacticalIntent | null;\r\n  \r\n  /**\r\n   * Called when the round starts - reset state\r\n   */\r\n  onRoundStart?(): void;\r\n  \r\n  /**\r\n   * Called when the round ends - cleanup\r\n   */\r\n  onRoundEnd?(): void;\r\n  \r\n  /**\r\n   * Cleanup resources when bot is removed\r\n   */\r\n  dispose?(): void;\r\n}\r\n\r\n/**\r\n * Factory function type for creating bot controllers\r\n */\r\nexport type BotControllerFactory = (\r\n  player: Player,\r\n  difficulty: 'easy' | 'medium' | 'hard'\r\n) => IBotController;\r\n","// ============================================================================\r\n// BOT AI - Rule-based AI controller for bots (implements IBotController)\r\n// ============================================================================\r\n\r\nimport { Vector2, PlayerInput, ObjectiveState, Team } from '@/shared/types';\r\nimport { Vec2 } from '@/shared/utils';\r\nimport { Player } from '@/game/entities/Player';\r\nimport { GameMap } from '@/game/map/GameMap';\r\nimport { CollisionWorld, CollisionLayers } from '@/engine/CollisionSystem';\r\nimport { \r\n  IBotController, \r\n  BotAIMode, \r\n  BotGameContext, \r\n  BotStateInfo, \r\n  TacticalIntent \r\n} from './IBotController';\r\n\r\nexport enum BotState {\r\n  Idle = 'idle',\r\n  Patrol = 'patrol',\r\n  Chase = 'chase',\r\n  Attack = 'attack',\r\n  Retreat = 'retreat',\r\n  Defuse = 'defuse',\r\n  PlantSpike = 'plant_spike',\r\n  Follow = 'follow',  // Follow friendly player (for attacker bots)\r\n}\r\n\r\nexport interface BotConfig {\r\n  aggressionLevel: number;    // 0-1, how aggressive the bot is\r\n  reactionTime: number;       // ms delay before reacting to threats\r\n  accuracy: number;           // 0-1, how accurate shots are\r\n  patrolRadius: number;       // How far bot patrols from spawn\r\n  sightRange: number;         // How far bot can see enemies\r\n  attackRange: number;        // Range at which bot starts shooting\r\n}\r\n\r\nconst DEFAULT_BOT_CONFIG: BotConfig = {\r\n  aggressionLevel: 0.6,\r\n  reactionTime: 200,\r\n  accuracy: 0.6,\r\n  patrolRadius: 300,\r\n  sightRange: 500,\r\n  attackRange: 400,\r\n};\r\n\r\n/**\r\n * Rule-based Bot AI Controller\r\n * Uses state machines and heuristics for decision making\r\n */\r\nexport class RuleBasedBotController implements IBotController {\r\n  readonly type = BotAIMode.RuleBased;\r\n  \r\n  private player: Player;\r\n  private config: BotConfig;\r\n  private state: BotState = BotState.Patrol;\r\n  \r\n  // Current context (updated each frame)\r\n  private currentContext: BotGameContext | null = null;\r\n  private currentObjectives: ObjectiveState | undefined;\r\n  \r\n  // Navigation\r\n  private targetPosition: Vector2 | null = null;\r\n  private patrolCenter: Vector2;\r\n  private lastPatrolChange: number = 0;\r\n  private patrolInterval: number = 3000; // Change patrol point every 3s\r\n  \r\n  // Combat\r\n  private targetEnemy: Player | null = null;\r\n  private lastSeenEnemy: number = 0;\r\n  private lastStateChange: number = 0;\r\n  \r\n  // Stuck detection\r\n  private lastPosition: Vector2;\r\n  private stuckTime: number = 0;\r\n  \r\n  // Spike objectives\r\n  private spikePosition: Vector2 | null = null;\r\n  private spikeSitePosition: Vector2 | null = null;\r\n  \r\n  // Follow behavior\r\n  private followTarget: Player | null = null;\r\n  \r\n  // Collision reference for wall avoidance\r\n  private collisionWorld: CollisionWorld | null = null;\r\n  \r\n  // Separation - nearby bots to avoid\r\n  private nearbyBots: Player[] = [];\r\n  \r\n  // Individual variation (randomness)\r\n  private randomOffset: number;  // Unique offset for this bot\r\n  \r\n  // Tactical intent (can be set by SLM or external systems)\r\n  private tacticalIntent: TacticalIntent | null = null;\r\n  \r\n  // Cached visible enemies for state info\r\n  private cachedVisibleEnemies: Player[] = [];\r\n\r\n  constructor(player: Player, config: Partial<BotConfig> = {}) {\r\n    this.player = player;\r\n    this.config = { ...DEFAULT_BOT_CONFIG, ...config };\r\n    this.patrolCenter = { ...player.position };\r\n    this.lastPosition = { ...player.position };\r\n    \r\n    // Generate unique random offset for behavior variation\r\n    this.randomOffset = Math.random() * 1000;\r\n    \r\n    // Randomize patrol interval (2-5 seconds) so bots don't all move at same time\r\n    this.patrolInterval = 2000 + Math.random() * 3000;\r\n  }\r\n\r\n  // =========================================================================\r\n  // IBotController Interface Implementation\r\n  // =========================================================================\r\n  \r\n  /**\r\n   * Main update method - generates input for this frame\r\n   * Implements IBotController.update\r\n   */\r\n  update(context: BotGameContext): PlayerInput {\r\n    // Store context for other methods\r\n    this.currentContext = context;\r\n    this.currentObjectives = context.objectives;\r\n    this.collisionWorld = context.collisionWorld;\r\n    \r\n    // Legacy update logic\r\n    return this.updateInternal(\r\n      context.dt,\r\n      context.time,\r\n      context.allPlayers,\r\n      context.collisionWorld,\r\n      context.map,\r\n      context.objectives\r\n    );\r\n  }\r\n  \r\n  /**\r\n   * Get player this controller manages\r\n   */\r\n  getPlayer(): Player {\r\n    return this.player;\r\n  }\r\n  \r\n  /**\r\n   * Get current bot state for SLM or debugging\r\n   */\r\n  getStateInfo(): BotStateInfo {\r\n    const map = this.currentContext?.map;\r\n    const ability1 = this.player.abilities[1];\r\n    const ability2 = this.player.abilities[2];\r\n    \r\n    const stateInfo: BotStateInfo = {\r\n      botId: this.player.id,\r\n      position: { ...this.player.position },\r\n      health: this.player.health,\r\n      shield: this.player.shield,\r\n      team: this.player.team === Team.Attackers ? 'attackers' : 'defenders',\r\n      isAlive: this.player.alive,\r\n      \r\n      ammo: this.player.weapon.ammo,\r\n      maxAmmo: this.player.weapon.maxAmmo,\r\n      isReloading: this.player.weapon.reloading,\r\n      weaponName: this.player.weapon.weaponId,\r\n      \r\n      ability1Ready: ability1 !== undefined && ability1.charges > 0,\r\n      ability2Ready: ability2 !== undefined && ability2.charges > 0,\r\n      ultimateReady: this.player.ultimateCharge >= 100,\r\n      ultimateCharge: this.player.ultimateCharge,\r\n      \r\n      visibleEnemies: this.cachedVisibleEnemies.map(e => ({\r\n        id: e.id,\r\n        position: { ...e.position },\r\n        health: e.health,\r\n        distance: Vec2.distance(this.player.position, e.position),\r\n      })),\r\n      \r\n      nearbyTeammates: this.nearbyBots\r\n        .filter(p => p.team === this.player.team)\r\n        .map(t => ({\r\n          id: t.id,\r\n          position: { ...t.position },\r\n          health: t.health,\r\n          distance: Vec2.distance(this.player.position, t.position),\r\n        })),\r\n      \r\n      hasSpikeCarrier: this.currentObjectives?.spikeCarrierId === this.player.id,\r\n      spikePlanted: this.currentObjectives?.spikePlanted || false,\r\n      inSpikeSite: map ? map.isInSpikeSite(this.player.position) !== -1 : false,\r\n      \r\n      distanceToNearestWall: this.getDistanceToNearestWall(),\r\n      currentZone: this.getCurrentZone(),\r\n    };\r\n    \r\n    // Only add optional fields if they have values\r\n    if (this.currentObjectives?.spikePosition) {\r\n      stateInfo.spikePosition = this.currentObjectives.spikePosition;\r\n    }\r\n    \r\n    return stateInfo;\r\n  }\r\n  \r\n  /**\r\n   * Set tactical intent from external source (SLM)\r\n   */\r\n  setTacticalIntent(intent: TacticalIntent): void {\r\n    this.tacticalIntent = intent;\r\n    // Map intent to internal state\r\n    this.mapIntentToState(intent);\r\n  }\r\n  \r\n  /**\r\n   * Get current tactical intent\r\n   */\r\n  getTacticalIntent(): TacticalIntent | null {\r\n    return this.tacticalIntent;\r\n  }\r\n  \r\n  /**\r\n   * Reset on round start\r\n   */\r\n  onRoundStart(): void {\r\n    this.state = BotState.Patrol;\r\n    this.tacticalIntent = null;\r\n    this.patrolCenter = { ...this.player.position };\r\n    this.targetEnemy = null;\r\n    this.followTarget = null;\r\n  }\r\n  \r\n  /**\r\n   * Cleanup on round end\r\n   */\r\n  onRoundEnd(): void {\r\n    this.tacticalIntent = null;\r\n  }\r\n  \r\n  /**\r\n   * Dispose resources\r\n   */\r\n  dispose(): void {\r\n    // Nothing to clean up for rule-based AI\r\n  }\r\n  \r\n  // =========================================================================\r\n  // Helper Methods for State Info\r\n  // =========================================================================\r\n  \r\n  private getDistanceToNearestWall(): number {\r\n    if (!this.collisionWorld) return 999;\r\n    \r\n    // Check 8 directions\r\n    const directions = [\r\n      { x: 1, y: 0 }, { x: -1, y: 0 }, { x: 0, y: 1 }, { x: 0, y: -1 },\r\n      { x: 0.707, y: 0.707 }, { x: -0.707, y: 0.707 },\r\n      { x: 0.707, y: -0.707 }, { x: -0.707, y: -0.707 },\r\n    ];\r\n    \r\n    let minDist = 999;\r\n    for (const dir of directions) {\r\n      const hit = this.collisionWorld.raycast(\r\n        this.player.position,\r\n        dir,\r\n        200,\r\n        CollisionLayers.WALL\r\n      );\r\n      if (hit && hit.distance < minDist) {\r\n        minDist = hit.distance;\r\n      }\r\n    }\r\n    return minDist;\r\n  }\r\n  \r\n  private getCurrentZone(): string {\r\n    const map = this.currentContext?.map;\r\n    if (!map) return 'unknown';\r\n    \r\n    const siteIndex = map.isInSpikeSite(this.player.position);\r\n    if (siteIndex === 0) return 'site_a';\r\n    if (siteIndex === 1) return 'site_b';\r\n    \r\n    // Simple zone detection based on position\r\n    const width = map.getWidth();\r\n    const height = map.getHeight();\r\n    const x = this.player.position.x / width;\r\n    const y = this.player.position.y / height;\r\n    \r\n    if (x < 0.3) return 'left';\r\n    if (x > 0.7) return 'right';\r\n    if (y < 0.3) return 'top';\r\n    if (y > 0.7) return 'bottom';\r\n    return 'mid';\r\n  }\r\n  \r\n  private mapIntentToState(intent: TacticalIntent): void {\r\n    switch (intent) {\r\n      case TacticalIntent.Aggressive:\r\n        this.state = BotState.Chase;\r\n        break;\r\n      case TacticalIntent.Retreating:\r\n        this.state = BotState.Retreat;\r\n        break;\r\n      case TacticalIntent.Defensive:\r\n        this.state = BotState.Patrol;\r\n        break;\r\n      case TacticalIntent.Flanking:\r\n        this.state = BotState.Patrol; // Will patrol to a different area\r\n        break;\r\n      case TacticalIntent.Supporting:\r\n        this.state = BotState.Follow;\r\n        break;\r\n      case TacticalIntent.Objective:\r\n        // For objective, check if we should plant or defuse\r\n        if (this.player.team === Team.Attackers) {\r\n          this.state = BotState.PlantSpike;\r\n        } else {\r\n          this.state = BotState.Defuse;\r\n        }\r\n        break;\r\n      case TacticalIntent.Patrolling:\r\n      default:\r\n        this.state = BotState.Patrol;\r\n        break;\r\n    }\r\n  }\r\n  \r\n  // =========================================================================\r\n  // Internal Update Logic (Original BotAI logic)\r\n  // =========================================================================\r\n\r\n  private updateInternal(\r\n    dt: number,\r\n    time: number,\r\n    allPlayers: Player[],\r\n    collisionWorld: CollisionWorld,\r\n    _map: GameMap,\r\n    objectives?: ObjectiveState\r\n  ): PlayerInput {\r\n    // Store collision world for wall avoidance\r\n    this.collisionWorld = collisionWorld;\r\n    \r\n    // Check if stuck\r\n    this.checkStuck(dt);\r\n    \r\n    // Separate enemies and teammates\r\n    const enemies = allPlayers.filter(p => p.team !== this.player.team && p.alive);\r\n    const teammates = allPlayers.filter(p => p.team === this.player.team && p.alive && p.id !== this.player.id);\r\n    \r\n    // Track nearby bots for separation (both teams, within 80 pixels)\r\n    this.nearbyBots = allPlayers.filter(p => \r\n      p.alive && \r\n      p.id !== this.player.id && \r\n      Vec2.distance(this.player.position, p.position) < 80\r\n    );\r\n    \r\n    // Find visible enemies\r\n    const visibleEnemies = this.findVisibleEnemies(enemies, collisionWorld);\r\n    this.cachedVisibleEnemies = visibleEnemies; // Cache for getStateInfo\r\n    \r\n    // Find follow target (for friendly bots - follow nearest alive teammate)\r\n    this.findFollowTarget(teammates, objectives);\r\n    \r\n    // Check for spike-related priorities\r\n    const spikeState = this.checkSpikeState(objectives);\r\n    if (spikeState) {\r\n      this.setState(spikeState, time);\r\n    } else if (visibleEnemies.length === 0 && this.followTarget && this.player.team === Team.Attackers) {\r\n      // No enemies visible - friendly attackers should follow teammates\r\n      this.setState(BotState.Follow, time);\r\n    } else {\r\n      // Update state based on situation\r\n      this.updateState(time, visibleEnemies);\r\n    }\r\n    \r\n    // Generate input based on state\r\n    const input = this.generateInput(time, visibleEnemies, collisionWorld);\r\n    \r\n    // Store position for stuck detection\r\n    this.lastPosition = { ...this.player.position };\r\n    \r\n    return input;\r\n  }\r\n  \r\n  // Find a teammate to follow (preferably the spike carrier or nearest human)\r\n  private findFollowTarget(teammates: Player[], objectives?: ObjectiveState): void {\r\n    if (teammates.length === 0) {\r\n      this.followTarget = null;\r\n      return;\r\n    }\r\n    \r\n    // Priority 1: Follow the spike carrier if on same team\r\n    if (objectives?.spikeCarrierId) {\r\n      const spikeCarrier = teammates.find(p => p.id === objectives.spikeCarrierId);\r\n      if (spikeCarrier) {\r\n        this.followTarget = spikeCarrier;\r\n        return;\r\n      }\r\n    }\r\n    \r\n    // Priority 2: Follow nearest teammate\r\n    let nearest: Player | null = null;\r\n    let nearestDist = Infinity;\r\n    for (const teammate of teammates) {\r\n      const dist = Vec2.distance(this.player.position, teammate.position);\r\n      if (dist < nearestDist) {\r\n        nearestDist = dist;\r\n        nearest = teammate;\r\n      }\r\n    }\r\n    this.followTarget = nearest;\r\n  }\r\n\r\n  private checkStuck(dt: number): void {\r\n    const moved = Vec2.distance(this.player.position, this.lastPosition);\r\n    if (moved < 1) {\r\n      this.stuckTime += dt;\r\n      if (this.stuckTime > 1000) {\r\n        // Pick new random target to get unstuck\r\n        this.targetPosition = this.getRandomPatrolPoint();\r\n        this.stuckTime = 0;\r\n      }\r\n    } else {\r\n      this.stuckTime = 0;\r\n    }\r\n  }\r\n\r\n  private findVisibleEnemies(enemies: Player[], collisionWorld: CollisionWorld): Player[] {\r\n    const visible: Player[] = [];\r\n    \r\n    for (const enemy of enemies) {\r\n      if (!enemy.alive) continue;\r\n      if (enemy.team === this.player.team) continue;\r\n      if (enemy.isInvisible) continue;\r\n      \r\n      const dist = Vec2.distance(this.player.position, enemy.position);\r\n      if (dist > this.config.sightRange) continue;\r\n      \r\n      // Raycast to check line of sight\r\n      const direction = Vec2.normalize(Vec2.sub(enemy.position, this.player.position));\r\n      const hit = collisionWorld.raycast(\r\n        this.player.position,\r\n        direction,\r\n        dist,\r\n        CollisionLayers.WALL\r\n      );\r\n      \r\n      // If we hit a wall before reaching the enemy, they're not visible\r\n      if (hit && hit.distance < dist - 20) continue;\r\n      \r\n      visible.push(enemy);\r\n    }\r\n    \r\n    return visible;\r\n  }\r\n\r\n  private updateState(time: number, visibleEnemies: Player[]): void {\r\n    const timeSinceStateChange = time - this.lastStateChange;\r\n    \r\n    if (visibleEnemies.length > 0) {\r\n      // Sort by distance\r\n      visibleEnemies.sort((a, b) => \r\n        Vec2.distance(this.player.position, a.position) - \r\n        Vec2.distance(this.player.position, b.position)\r\n      );\r\n      \r\n      this.targetEnemy = visibleEnemies[0]!;\r\n      this.lastSeenEnemy = time;\r\n      \r\n      const dist = Vec2.distance(this.player.position, this.targetEnemy.position);\r\n      \r\n      // Decide to attack or chase\r\n      if (dist <= this.config.attackRange) {\r\n        if (this.player.health < 30 && this.config.aggressionLevel < 0.8) {\r\n          this.setState(BotState.Retreat, time);\r\n        } else {\r\n          this.setState(BotState.Attack, time);\r\n        }\r\n      } else {\r\n        if (this.config.aggressionLevel > 0.4) {\r\n          this.setState(BotState.Chase, time);\r\n        } else {\r\n          this.setState(BotState.Attack, time);\r\n        }\r\n      }\r\n    } else {\r\n      this.targetEnemy = null;\r\n      \r\n      // If recently saw enemy, stay alert\r\n      if (time - this.lastSeenEnemy < 2000) {\r\n        // Stay in current combat state briefly\r\n      } else if (timeSinceStateChange > 2000) {\r\n        this.setState(BotState.Patrol, time);\r\n      }\r\n    }\r\n  }\r\n\r\n  private setState(newState: BotState, time: number): void {\r\n    if (this.state !== newState) {\r\n      this.state = newState;\r\n      this.lastStateChange = time;\r\n    }\r\n  }\r\n\r\n  private generateInput(\r\n    time: number,\r\n    visibleEnemies: Player[],\r\n    _collisionWorld: CollisionWorld\r\n  ): PlayerInput {\r\n    const input: PlayerInput = {\r\n      moveX: 0,\r\n      moveY: 0,\r\n      aimX: this.player.position.x + Math.cos(this.player.rotation) * 100,\r\n      aimY: this.player.position.y + Math.sin(this.player.rotation) * 100,\r\n      shoot: false,\r\n      reload: false,\r\n      interact: false,\r\n      ability1: false,\r\n      ability2: false,\r\n      ultimate: false,\r\n      weaponSlot: 0,\r\n      sequence: 0,\r\n    };\r\n\r\n    switch (this.state) {\r\n      case BotState.Patrol:\r\n        this.doPatrol(time, input);\r\n        break;\r\n        \r\n      case BotState.Chase:\r\n        this.doChase(input);\r\n        break;\r\n        \r\n      case BotState.Attack:\r\n        this.doAttack(time, input, visibleEnemies);\r\n        break;\r\n        \r\n      case BotState.Retreat:\r\n        this.doRetreat(input);\r\n        break;\r\n        \r\n      case BotState.Defuse:\r\n        this.doDefuse(input, this.spikePosition);\r\n        break;\r\n        \r\n      case BotState.PlantSpike:\r\n        this.doPlantSpike(input, this.spikeSitePosition);\r\n        break;\r\n        \r\n      case BotState.Follow:\r\n        this.doFollow(input);\r\n        break;\r\n    }\r\n\r\n    // Check if need to reload\r\n    if (this.player.weapon.ammo === 0 && !this.player.weapon.reloading) {\r\n      input.reload = true;\r\n    }\r\n    \r\n    // Apply separation force to avoid overlapping with other bots\r\n    this.applySeparation(input);\r\n\r\n    return input;\r\n  }\r\n  \r\n  // Apply separation force to keep distance from nearby bots\r\n  private applySeparation(input: PlayerInput): void {\r\n    if (this.nearbyBots.length === 0) return;\r\n    \r\n    let separationX = 0;\r\n    let separationY = 0;\r\n    \r\n    for (const other of this.nearbyBots) {\r\n      const dist = Vec2.distance(this.player.position, other.position);\r\n      if (dist < 5) continue; // Avoid division by zero\r\n      \r\n      // Calculate push direction (away from other bot)\r\n      const pushDir = Vec2.normalize(Vec2.sub(this.player.position, other.position));\r\n      \r\n      // Stronger push when closer (inverse relationship)\r\n      const strength = Math.max(0, (80 - dist) / 80); // 0 at 80px, 1 at 0px\r\n      \r\n      separationX += pushDir.x * strength;\r\n      separationY += pushDir.y * strength;\r\n    }\r\n    \r\n    // Add separation to movement (blend with existing movement)\r\n    if (separationX !== 0 || separationY !== 0) {\r\n      const sepLen = Math.sqrt(separationX * separationX + separationY * separationY);\r\n      if (sepLen > 0) {\r\n        // Normalize and apply with weight (0.5 = half influence)\r\n        const weight = 0.5;\r\n        input.moveX += (separationX / sepLen) * weight;\r\n        input.moveY += (separationY / sepLen) * weight;\r\n        \r\n        // Re-normalize if over 1\r\n        const len = Math.sqrt(input.moveX * input.moveX + input.moveY * input.moveY);\r\n        if (len > 1) {\r\n          input.moveX /= len;\r\n          input.moveY /= len;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private doPatrol(time: number, input: PlayerInput): void {\r\n    // Pick new patrol point periodically\r\n    if (!this.targetPosition || time - this.lastPatrolChange > this.patrolInterval) {\r\n      this.targetPosition = this.getRandomPatrolPoint();\r\n      this.lastPatrolChange = time;\r\n    }\r\n\r\n    // Move toward patrol point\r\n    this.moveToward(this.targetPosition, input);\r\n    \r\n    // Look in movement direction\r\n    if (input.moveX !== 0 || input.moveY !== 0) {\r\n      const lookAngle = Math.atan2(input.moveY, input.moveX);\r\n      input.aimX = this.player.position.x + Math.cos(lookAngle) * 100;\r\n      input.aimY = this.player.position.y + Math.sin(lookAngle) * 100;\r\n    }\r\n  }\r\n\r\n  private doChase(input: PlayerInput): void {\r\n    if (!this.targetEnemy) return;\r\n    \r\n    // Move toward enemy\r\n    this.moveToward(this.targetEnemy.position, input);\r\n    \r\n    // Aim at enemy\r\n    input.aimX = this.targetEnemy.position.x;\r\n    input.aimY = this.targetEnemy.position.y;\r\n  }\r\n\r\n  private doAttack(time: number, input: PlayerInput, visibleEnemies: Player[]): void {\r\n    if (!this.targetEnemy || visibleEnemies.length === 0) return;\r\n    \r\n    const dist = Vec2.distance(this.player.position, this.targetEnemy.position);\r\n    \r\n    // Strafe while attacking\r\n    const strafeDir = Math.sin(time / 500) * 0.7;\r\n    const toEnemy = Vec2.normalize(Vec2.sub(this.targetEnemy.position, this.player.position));\r\n    const perpendicular = { x: -toEnemy.y, y: toEnemy.x };\r\n    \r\n    input.moveX = perpendicular.x * strafeDir;\r\n    input.moveY = perpendicular.y * strafeDir;\r\n    \r\n    // Move closer if too far, back up if too close\r\n    if (dist > this.config.attackRange * 0.8) {\r\n      input.moveX += toEnemy.x * 0.5;\r\n      input.moveY += toEnemy.y * 0.5;\r\n    } else if (dist < 100) {\r\n      input.moveX -= toEnemy.x * 0.5;\r\n      input.moveY -= toEnemy.y * 0.5;\r\n    }\r\n    \r\n    // Normalize\r\n    const moveLen = Math.sqrt(input.moveX * input.moveX + input.moveY * input.moveY);\r\n    if (moveLen > 1) {\r\n      input.moveX /= moveLen;\r\n      input.moveY /= moveLen;\r\n    }\r\n    \r\n    // Aim at enemy with some inaccuracy\r\n    const inaccuracy = (1 - this.config.accuracy) * 50;\r\n    input.aimX = this.targetEnemy.position.x + (Math.random() - 0.5) * inaccuracy;\r\n    input.aimY = this.targetEnemy.position.y + (Math.random() - 0.5) * inaccuracy;\r\n    \r\n    // Shoot if we can\r\n    if (!this.player.weapon.reloading && this.player.weapon.ammo > 0) {\r\n      // Add reaction time delay\r\n      if (time - this.lastSeenEnemy > this.config.reactionTime) {\r\n        input.shoot = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  private doRetreat(input: PlayerInput): void {\r\n    if (!this.targetEnemy) {\r\n      // Retreat to patrol center\r\n      this.moveToward(this.patrolCenter, input);\r\n    } else {\r\n      // Move away from enemy\r\n      const awayDir = Vec2.normalize(Vec2.sub(this.player.position, this.targetEnemy.position));\r\n      input.moveX = awayDir.x;\r\n      input.moveY = awayDir.y;\r\n      \r\n      // Still aim at enemy while retreating\r\n      input.aimX = this.targetEnemy.position.x;\r\n      input.aimY = this.targetEnemy.position.y;\r\n      \r\n      // Shoot while retreating\r\n      if (!this.player.weapon.reloading && this.player.weapon.ammo > 0) {\r\n        input.shoot = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  private moveToward(target: Vector2, input: PlayerInput): void {\r\n    const direction = Vec2.sub(target, this.player.position);\r\n    const dist = Vec2.length(direction);\r\n    \r\n    if (dist > 10) {\r\n      let normalized = Vec2.normalize(direction);\r\n      \r\n      // Wall avoidance - check if we're about to hit a wall\r\n      if (this.collisionWorld) {\r\n        const checkDist = 50; // Check 50 pixels ahead\r\n        const hit = this.collisionWorld.raycast(\r\n          this.player.position,\r\n          normalized,\r\n          checkDist,\r\n          CollisionLayers.WALL\r\n        );\r\n        \r\n        if (hit && hit.distance < checkDist) {\r\n          // Wall ahead! Try to find a way around\r\n          // Check left and right\r\n          const leftDir = { x: -normalized.y, y: normalized.x };\r\n          const rightDir = { x: normalized.y, y: -normalized.x };\r\n          \r\n          const leftHit = this.collisionWorld.raycast(\r\n            this.player.position,\r\n            leftDir,\r\n            checkDist,\r\n            CollisionLayers.WALL\r\n          );\r\n          const rightHit = this.collisionWorld.raycast(\r\n            this.player.position,\r\n            rightDir,\r\n            checkDist,\r\n            CollisionLayers.WALL\r\n          );\r\n          \r\n          // Pick the direction with more space\r\n          const leftDist = leftHit ? leftHit.distance : checkDist;\r\n          const rightDist = rightHit ? rightHit.distance : checkDist;\r\n          \r\n          if (leftDist > rightDist && leftDist > 20) {\r\n            // Blend left with forward direction\r\n            normalized = Vec2.normalize({\r\n              x: normalized.x * 0.3 + leftDir.x * 0.7,\r\n              y: normalized.y * 0.3 + leftDir.y * 0.7\r\n            });\r\n          } else if (rightDist > 20) {\r\n            // Blend right with forward direction\r\n            normalized = Vec2.normalize({\r\n              x: normalized.x * 0.3 + rightDir.x * 0.7,\r\n              y: normalized.y * 0.3 + rightDir.y * 0.7\r\n            });\r\n          }\r\n          // If both sides are blocked, the stuck detection will handle it\r\n        }\r\n      }\r\n      \r\n      input.moveX = normalized.x;\r\n      input.moveY = normalized.y;\r\n    }\r\n  }\r\n\r\n  private getRandomPatrolPoint(): Vector2 {\r\n    // Use bot's unique random offset for seeded variation\r\n    const timeOffset = Date.now() + this.randomOffset;\r\n    const angle = (Math.random() + (timeOffset % 1000) / 1000) * Math.PI * 2;\r\n    const radius = (Math.random() * 0.5 + 0.5) * this.config.patrolRadius; // At least 50% of patrol radius\r\n    \r\n    // Add unique offset based on bot ID to spread bots out\r\n    const idOffset = (this.player.id.charCodeAt(0) + this.player.id.charCodeAt(this.player.id.length - 1)) % 360;\r\n    const offsetAngle = angle + (idOffset * Math.PI / 180);\r\n    \r\n    return {\r\n      x: this.patrolCenter.x + Math.cos(offsetAngle) * radius,\r\n      y: this.patrolCenter.y + Math.sin(offsetAngle) * radius,\r\n    };\r\n  }\r\n\r\n  // Check if bot should prioritize spike objectives\r\n  private checkSpikeState(objectives?: ObjectiveState): BotState | null {\r\n    if (!objectives) return null;\r\n    \r\n    // Defender: If spike is planted, rush to defuse\r\n    if (this.player.team === Team.Defenders && objectives.spikePlanted && objectives.spikePosition) {\r\n      const dist = Vec2.distance(this.player.position, objectives.spikePosition);\r\n      this.spikePosition = objectives.spikePosition;\r\n      \r\n      // If close enough to defuse (within 60 pixels), defuse\r\n      if (dist <= 60) {\r\n        return BotState.Defuse;\r\n      }\r\n      // Otherwise, run toward spike (unless enemy is very close)\r\n      if (dist > 60 && (!this.targetEnemy || Vec2.distance(this.player.position, this.targetEnemy.position) > 150)) {\r\n        return BotState.Defuse; // Will move toward spike first\r\n      }\r\n    }\r\n    \r\n    // Attacker: If carrying spike, try to plant\r\n    if (this.player.team === Team.Attackers && objectives.spikeCarrierId === this.player.id) {\r\n      // Check if in a spike site - for now, just set a target position toward center of map\r\n      // The bot will need to reach a spike site to plant\r\n      this.spikeSitePosition = { x: 600, y: 400 }; // Default to approximate center\r\n      return BotState.PlantSpike;\r\n    }\r\n    \r\n    return null;\r\n  }\r\n\r\n  // Move to spike and hold E to defuse\r\n  private doDefuse(input: PlayerInput, spikePos: Vector2 | null): void {\r\n    if (!spikePos) return;\r\n    \r\n    const dist = Vec2.distance(this.player.position, spikePos);\r\n    \r\n    if (dist > 50) {\r\n      // Move toward spike\r\n      this.moveToward(spikePos, input);\r\n      \r\n      // Look toward spike\r\n      input.aimX = spikePos.x;\r\n      input.aimY = spikePos.y;\r\n    } else {\r\n      // Close enough - hold E to defuse\r\n      input.interact = true;\r\n      input.moveX = 0;\r\n      input.moveY = 0;\r\n      \r\n      // Look around for enemies while defusing\r\n      input.aimX = spikePos.x + Math.cos(Date.now() / 500) * 100;\r\n      input.aimY = spikePos.y + Math.sin(Date.now() / 500) * 100;\r\n    }\r\n  }\r\n\r\n  // Move to spike site and hold E to plant\r\n  private doPlantSpike(input: PlayerInput, sitePos: Vector2 | null): void {\r\n    if (!sitePos) return;\r\n    \r\n    const dist = Vec2.distance(this.player.position, sitePos);\r\n    \r\n    if (dist > 80) {\r\n      // Move toward spike site\r\n      this.moveToward(sitePos, input);\r\n      \r\n      // Look in movement direction\r\n      const dir = Vec2.normalize(Vec2.sub(sitePos, this.player.position));\r\n      input.aimX = this.player.position.x + dir.x * 100;\r\n      input.aimY = this.player.position.y + dir.y * 100;\r\n    } else {\r\n      // In spike site - hold E to plant\r\n      input.interact = true;\r\n      input.moveX = 0;\r\n      input.moveY = 0;\r\n    }\r\n  }\r\n  \r\n  // Follow a teammate\r\n  private doFollow(input: PlayerInput): void {\r\n    if (!this.followTarget) return;\r\n    \r\n    const dist = Vec2.distance(this.player.position, this.followTarget.position);\r\n    \r\n    // Keep some distance - don't crowd the player\r\n    if (dist > 120) {\r\n      // Move toward teammate but slightly behind/offset\r\n      const toTarget = Vec2.normalize(Vec2.sub(this.followTarget.position, this.player.position));\r\n      \r\n      // Add some offset so bots spread out\r\n      const offset = (this.player.id.charCodeAt(0) % 3 - 1) * 0.3;\r\n      const perpendicular = { x: -toTarget.y * offset, y: toTarget.x * offset };\r\n      \r\n      input.moveX = toTarget.x + perpendicular.x;\r\n      input.moveY = toTarget.y + perpendicular.y;\r\n      \r\n      // Normalize\r\n      const len = Math.sqrt(input.moveX * input.moveX + input.moveY * input.moveY);\r\n      if (len > 1) {\r\n        input.moveX /= len;\r\n        input.moveY /= len;\r\n      }\r\n      \r\n      // Look in movement direction\r\n      input.aimX = this.player.position.x + toTarget.x * 100;\r\n      input.aimY = this.player.position.y + toTarget.y * 100;\r\n    } else {\r\n      // Close enough - stop and look around for threats\r\n      input.moveX = 0;\r\n      input.moveY = 0;\r\n      \r\n      // Look in same direction as teammate\r\n      const lookDir = { \r\n        x: Math.cos(this.followTarget.rotation), \r\n        y: Math.sin(this.followTarget.rotation) \r\n      };\r\n      input.aimX = this.player.position.x + lookDir.x * 100;\r\n      input.aimY = this.player.position.y + lookDir.y * 100;\r\n    }\r\n  }\r\n}\r\n\r\n// Export alias for backward compatibility\r\nexport { RuleBasedBotController as BotAI };\r\n","// ============================================================================\r\n// SLM BOT CONTROLLER - AI controller powered by Small Language Model\r\n// ============================================================================\r\n// This is a stub implementation for future SLM integration using WebLLM\r\n// Target models: LLaMA 3.2 1B (fast micro-reasoning for real-time decisions)\r\n\r\nimport { PlayerInput, Team } from '@/shared/types';\r\nimport { Player } from '@/game/entities/Player';\r\nimport { \r\n  IBotController, \r\n  BotAIMode, \r\n  BotGameContext, \r\n  BotStateInfo, \r\n  TacticalIntent \r\n} from './IBotController';\r\n\r\n/**\r\n * SLM Bot Controller - Stub for future Small Language Model integration\r\n * \r\n * Architecture plan:\r\n * 1. Uses WebLLM runtime for browser-based inference\r\n * 2. Model: LLaMA 3.2 1B (quantized) for fast micro-reasoning\r\n * 3. Batches bot decisions to minimize inference overhead\r\n * 4. Falls back to rule-based if SLM unavailable\r\n * \r\n * Decision loop:\r\n * 1. Gather BotStateInfo from all bots\r\n * 2. Format as concise JSON prompt\r\n * 3. Query SLM for tactical decisions\r\n * 4. Parse response into TacticalIntent\r\n * 5. Execute intent via behavior trees\r\n */\r\nexport class SLMBotController implements IBotController {\r\n  readonly type = BotAIMode.SLM;\r\n  \r\n  private player: Player;\r\n  private tacticalIntent: TacticalIntent = TacticalIntent.Defensive;\r\n  \r\n  // SLM state (placeholder for WebLLM integration)\r\n  // TODO: These will be used when WebLLM is integrated\r\n  // private slmReady: boolean = false;\r\n  // private lastDecisionTime: number = 0;\r\n  // private decisionInterval: number = 500;\r\n  \r\n  constructor(player: Player) {\r\n    this.player = player;\r\n    console.log(`[SLMBotController] Created for player ${player.id} (stub mode)`);\r\n  }\r\n  \r\n  // =========================================================================\r\n  // IBotController Interface Implementation\r\n  // =========================================================================\r\n  \r\n  /**\r\n   * Main update method - generates input for this frame\r\n   * Currently falls back to basic behavior since SLM is not integrated\r\n   */\r\n  update(context: BotGameContext): PlayerInput {\r\n    // TODO: When WebLLM is integrated:\r\n    // 1. Check if enough time passed since last SLM query\r\n    // 2. If yes, gather state and queue SLM inference\r\n    // 3. Update tacticalIntent based on SLM response\r\n    // 4. Use intent to generate movement/combat decisions\r\n    \r\n    // For now, return basic idle input (fall back behavior)\r\n    return this.generateFallbackInput(context);\r\n  }\r\n  \r\n  /**\r\n   * Get player this controller manages\r\n   */\r\n  getPlayer(): Player {\r\n    return this.player;\r\n  }\r\n  \r\n  /**\r\n   * Get current bot state for SLM query\r\n   */\r\n  getStateInfo(): BotStateInfo {\r\n    // Build minimal state info for SLM prompt\r\n    return {\r\n      botId: this.player.id,\r\n      position: { ...this.player.position },\r\n      health: this.player.health,\r\n      shield: this.player.shield,\r\n      team: this.player.team === Team.Attackers ? 'attackers' : 'defenders',\r\n      isAlive: this.player.alive,\r\n      \r\n      ammo: this.player.weapon.ammo,\r\n      maxAmmo: this.player.weapon.maxAmmo,\r\n      isReloading: this.player.weapon.reloading,\r\n      weaponName: this.player.weapon.weaponId,\r\n      \r\n      ability1Ready: false,\r\n      ability2Ready: false,\r\n      ultimateReady: this.player.ultimateCharge >= 100,\r\n      ultimateCharge: this.player.ultimateCharge,\r\n      \r\n      visibleEnemies: [],\r\n      nearbyTeammates: [],\r\n      \r\n      hasSpikeCarrier: false,\r\n      spikePlanted: false,\r\n      inSpikeSite: false,\r\n      \r\n      distanceToNearestWall: 0,\r\n      currentZone: 'unknown',\r\n    };\r\n  }\r\n  \r\n  /**\r\n   * Set tactical intent (called when SLM returns a decision)\r\n   */\r\n  setTacticalIntent(intent: TacticalIntent): void {\r\n    this.tacticalIntent = intent;\r\n  }\r\n  \r\n  /**\r\n   * Get current tactical intent\r\n   */\r\n  getTacticalIntent(): TacticalIntent {\r\n    return this.tacticalIntent;\r\n  }\r\n  \r\n  /**\r\n   * Cleanup resources\r\n   */\r\n  destroy(): void {\r\n    // TODO: Release WebLLM resources when integrated\r\n    console.log(`[SLMBotController] Destroyed for player ${this.player.id}`);\r\n  }\r\n  \r\n  // =========================================================================\r\n  // SLM Integration Points (for future implementation)\r\n  // =========================================================================\r\n  \r\n  /**\r\n   * Initialize WebLLM engine\r\n   * TODO: Implement when adding WebLLM\r\n   */\r\n  async initializeSLM(): Promise<boolean> {\r\n    // Future implementation:\r\n    // 1. Load WebLLM engine\r\n    // 2. Download/cache model weights (LLaMA 3.2 1B)\r\n    // 3. Set slmReady = true\r\n    console.log('[SLMBotController] SLM initialization not yet implemented');\r\n    return false;\r\n  }\r\n  \r\n  /**\r\n   * Query SLM for tactical decision\r\n   * TODO: Implement when adding WebLLM\r\n   */\r\n  async querySLM(_stateInfo: BotStateInfo): Promise<TacticalIntent> {\r\n    // Future implementation:\r\n    // 1. Format state as JSON prompt\r\n    // 2. Query WebLLM with prompt\r\n    // 3. Parse response to TacticalIntent\r\n    return TacticalIntent.Defensive;\r\n  }\r\n  \r\n  /**\r\n   * Format bot state as SLM prompt\r\n   * This will be the interface between game state and LLM\r\n   */\r\n  formatPrompt(state: BotStateInfo): string {\r\n    // Compact JSON format for efficient inference\r\n    return JSON.stringify({\r\n      pos: [Math.round(state.position.x), Math.round(state.position.y)],\r\n      hp: state.health,\r\n      team: state.team === 'attackers' ? 'a' : 'd',\r\n      ammo: state.ammo,\r\n      enemies: state.visibleEnemies.length,\r\n      spike: state.hasSpikeCarrier ? 'carry' : state.spikePlanted ? 'planted' : 'none',\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * Parse SLM response to TacticalIntent\r\n   */\r\n  parseResponse(response: string): TacticalIntent {\r\n    // Map common responses to intents\r\n    const lower = response.toLowerCase().trim();\r\n    if (lower.includes('attack') || lower.includes('aggress')) {\r\n      return TacticalIntent.Aggressive;\r\n    } else if (lower.includes('defend') || lower.includes('hold')) {\r\n      return TacticalIntent.Defensive;\r\n    } else if (lower.includes('flank')) {\r\n      return TacticalIntent.Flanking;\r\n    } else if (lower.includes('support') || lower.includes('follow')) {\r\n      return TacticalIntent.Supporting;\r\n    } else if (lower.includes('plant') || lower.includes('defuse') || lower.includes('objective')) {\r\n      return TacticalIntent.Objective;\r\n    }\r\n    return TacticalIntent.Defensive;\r\n  }\r\n  \r\n  // =========================================================================\r\n  // Fallback Behavior (when SLM not available)\r\n  // =========================================================================\r\n  \r\n  /**\r\n   * Generate basic input when SLM is not ready\r\n   * Uses simple state-based logic as fallback\r\n   */\r\n  private generateFallbackInput(context: BotGameContext): PlayerInput {\r\n    // Very basic behavior: stand still and look around\r\n    // This encourages players to use rule-based mode until SLM is integrated\r\n    const time = context.time;\r\n    \r\n    return {\r\n      moveX: 0,\r\n      moveY: 0,\r\n      aimX: this.player.position.x + Math.cos(time * 0.001) * 100,\r\n      aimY: this.player.position.y + Math.sin(time * 0.001) * 100,\r\n      shoot: false,\r\n      reload: false,\r\n      ability1: false,\r\n      ability2: false,\r\n      ultimate: false,\r\n      interact: false,\r\n      weaponSlot: 0,\r\n      sequence: 0,\r\n    };\r\n  }\r\n}\r\n","// ============================================================================\r\n// BOT CONTROLLER FACTORY - Creates appropriate bot controllers based on mode\r\n// ============================================================================\r\n\r\nimport { Player } from '@/game/entities/Player';\r\nimport { IBotController, BotAIMode } from './IBotController';\r\nimport { RuleBasedBotController, BotConfig } from './BotAI';\r\nimport { SLMBotController } from './SLMBotController';\r\n\r\n/**\r\n * Factory for creating bot controllers\r\n * Allows runtime switching between AI modes\r\n */\r\nexport class BotControllerFactory {\r\n  private static currentMode: BotAIMode = BotAIMode.RuleBased;\r\n  private static slmAvailable: boolean = false;\r\n  \r\n  /**\r\n   * Create a bot controller for the given player\r\n   */\r\n  static create(player: Player, config?: Partial<BotConfig>): IBotController {\r\n    if (this.currentMode === BotAIMode.SLM && this.slmAvailable) {\r\n      return new SLMBotController(player);\r\n    }\r\n    // Default to rule-based\r\n    if (this.currentMode === BotAIMode.SLM) {\r\n      console.warn('[BotControllerFactory] SLM not available, falling back to rule-based');\r\n    }\r\n    return new RuleBasedBotController(player, config);\r\n  }\r\n  \r\n  /**\r\n   * Get current AI mode\r\n   */\r\n  static getMode(): BotAIMode {\r\n    return this.currentMode;\r\n  }\r\n  \r\n  /**\r\n   * Set AI mode for new bot creation\r\n   * Existing bots keep their current controller\r\n   */\r\n  static setMode(mode: BotAIMode): void {\r\n    console.log(`[BotControllerFactory] AI mode set to: ${mode}`);\r\n    this.currentMode = mode;\r\n  }\r\n  \r\n  /**\r\n   * Check if SLM is available\r\n   */\r\n  static isSLMAvailable(): boolean {\r\n    return this.slmAvailable;\r\n  }\r\n  \r\n  /**\r\n   * Mark SLM as available (called when WebLLM is ready)\r\n   */\r\n  static setSLMAvailable(available: boolean): void {\r\n    this.slmAvailable = available;\r\n    console.log(`[BotControllerFactory] SLM availability: ${available}`);\r\n  }\r\n  \r\n  /**\r\n   * Get human-readable name for current mode\r\n   */\r\n  static getModeName(): string {\r\n    switch (this.currentMode) {\r\n      case BotAIMode.SLM:\r\n        return 'SLM (AI Language Model)';\r\n      case BotAIMode.RuleBased:\r\n      default:\r\n        return 'Rule-Based (Classic)';\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Cycle to next available AI mode\r\n   */\r\n  static cycleMode(): BotAIMode {\r\n    if (this.currentMode === BotAIMode.RuleBased && this.slmAvailable) {\r\n      this.currentMode = BotAIMode.SLM;\r\n    } else {\r\n      this.currentMode = BotAIMode.RuleBased;\r\n    }\r\n    console.log(`[BotControllerFactory] Cycled to: ${this.getModeName()}`);\r\n    return this.currentMode;\r\n  }\r\n}\r\n\r\n// Re-export types for convenience\r\nexport type { IBotController, BotGameContext, BotStateInfo } from './IBotController';\r\nexport { BotAIMode, TacticalIntent } from './IBotController';\r\nexport type { BotConfig } from './BotAI';\r\nexport { RuleBasedBotController, BotAI, BotState } from './BotAI';\r\nexport { SLMBotController } from './SLMBotController';\r\n","// ============================================================================\r\n// EFFECT SYSTEM - Manages status effects, buffs, debuffs, and ability effects\r\n// ============================================================================\r\n\r\nimport { EntityId, Vector2 } from '@/shared/types';\r\nimport { generateId } from '@/shared/utils';\r\n\r\n// ----------------------------------------------------------------------------\r\n// EFFECT TYPES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport enum EffectType {\r\n  // Damage over time\r\n  Poison = 'poison',\r\n  Burn = 'burn',\r\n  Bleed = 'bleed',\r\n  \r\n  // Healing over time\r\n  Regen = 'regen',\r\n  HealBurst = 'heal_burst',\r\n  \r\n  // Crowd Control\r\n  Stun = 'stun',\r\n  Slow = 'slow',\r\n  Root = 'root',           // Cannot move but can shoot\r\n  Silence = 'silence',     // Cannot use abilities\r\n  Blind = 'blind',         // Reduced vision\r\n  \r\n  // Defensive\r\n  Shield = 'shield',\r\n  DamageReduction = 'damage_reduction',\r\n  Immunity = 'immunity',\r\n  FrontShield = 'front_shield',    // Directional damage reduction (from front only)\r\n  \r\n  // Offensive\r\n  DamageBoost = 'damage_boost',\r\n  FireRateBoost = 'fire_rate_boost',\r\n  CritBoost = 'crit_boost',\r\n  \r\n  // Movement\r\n  SpeedBoost = 'speed_boost',\r\n  SpeedReduction = 'speed_reduction',\r\n  \r\n  // Stealth\r\n  Cloak = 'cloak',\r\n  Revealed = 'revealed',\r\n  \r\n  // Special\r\n  Marked = 'marked',       // Takes bonus damage\r\n  Invulnerable = 'invulnerable',\r\n  Phased = 'phased',       // Can pass through walls\r\n}\r\n\r\nexport enum EffectCategory {\r\n  Buff = 'buff',\r\n  Debuff = 'debuff',\r\n  Neutral = 'neutral',\r\n}\r\n\r\n// How effects stack when multiple are applied\r\nexport enum StackBehavior {\r\n  None = 'none',           // Only one instance, ignore new\r\n  Refresh = 'refresh',     // Reset duration on new application\r\n  Stack = 'stack',         // Add stacks up to max\r\n  Replace = 'replace',     // Replace with new (stronger wins)\r\n  Separate = 'separate',   // Each source has separate instance\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// EFFECT DEFINITION\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface EffectDefinition {\r\n  type: EffectType;\r\n  category: EffectCategory;\r\n  stackBehavior: StackBehavior;\r\n  maxStacks: number;\r\n  priority: number;        // Higher = processed first (for conflicts)\r\n  cleansable: boolean;     // Can be removed by cleanse abilities\r\n  dispellable: boolean;    // Can be removed by dispel/purge\r\n}\r\n\r\n// Effect definitions table\r\nexport const EFFECT_DEFINITIONS: Record<EffectType, EffectDefinition> = {\r\n  // DoT effects\r\n  [EffectType.Poison]: {\r\n    type: EffectType.Poison,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Stack,\r\n    maxStacks: 5,\r\n    priority: 10,\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Burn]: {\r\n    type: EffectType.Burn,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 10,\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Bleed]: {\r\n    type: EffectType.Bleed,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Stack,\r\n    maxStacks: 3,\r\n    priority: 10,\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  \r\n  // Healing\r\n  [EffectType.Regen]: {\r\n    type: EffectType.Regen,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Replace,\r\n    maxStacks: 1,\r\n    priority: 5,\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.HealBurst]: {\r\n    type: EffectType.HealBurst,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.None,\r\n    maxStacks: 1,\r\n    priority: 100, // Process heals before damage\r\n    cleansable: false,\r\n    dispellable: false,\r\n  },\r\n  \r\n  // Crowd Control\r\n  [EffectType.Stun]: {\r\n    type: EffectType.Stun,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 90, // High priority - stops actions\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Slow]: {\r\n    type: EffectType.Slow,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Replace, // Strongest slow wins\r\n    maxStacks: 1,\r\n    priority: 50,\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Root]: {\r\n    type: EffectType.Root,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 85,\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Silence]: {\r\n    type: EffectType.Silence,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 80,\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Blind]: {\r\n    type: EffectType.Blind,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 60,\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  \r\n  // Defensive\r\n  [EffectType.Shield]: {\r\n    type: EffectType.Shield,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Replace, // Stronger shield wins\r\n    maxStacks: 1,\r\n    priority: 95, // Shields absorb before damage calc\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.DamageReduction]: {\r\n    type: EffectType.DamageReduction,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Replace,\r\n    maxStacks: 1,\r\n    priority: 94,\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Immunity]: {\r\n    type: EffectType.Immunity,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 99, // Highest - blocks all damage\r\n    cleansable: false,\r\n    dispellable: false,\r\n  },\r\n  [EffectType.FrontShield]: {\r\n    type: EffectType.FrontShield,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 93, // Directional damage reduction\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  \r\n  // Offensive\r\n  [EffectType.DamageBoost]: {\r\n    type: EffectType.DamageBoost,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Replace,\r\n    maxStacks: 1,\r\n    priority: 40,\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.FireRateBoost]: {\r\n    type: EffectType.FireRateBoost,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Replace,\r\n    maxStacks: 1,\r\n    priority: 40,\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.CritBoost]: {\r\n    type: EffectType.CritBoost,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Replace,\r\n    maxStacks: 1,\r\n    priority: 40,\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  \r\n  // Movement\r\n  [EffectType.SpeedBoost]: {\r\n    type: EffectType.SpeedBoost,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Replace,\r\n    maxStacks: 1,\r\n    priority: 50,\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.SpeedReduction]: {\r\n    type: EffectType.SpeedReduction,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Replace,\r\n    maxStacks: 1,\r\n    priority: 50,\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  \r\n  // Stealth\r\n  [EffectType.Cloak]: {\r\n    type: EffectType.Cloak,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 70,\r\n    cleansable: false,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Revealed]: {\r\n    type: EffectType.Revealed,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 75, // Higher than cloak - breaks it\r\n    cleansable: false,\r\n    dispellable: false,\r\n  },\r\n  \r\n  // Special\r\n  [EffectType.Marked]: {\r\n    type: EffectType.Marked,\r\n    category: EffectCategory.Debuff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 30,\r\n    cleansable: true,\r\n    dispellable: true,\r\n  },\r\n  [EffectType.Invulnerable]: {\r\n    type: EffectType.Invulnerable,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 100,\r\n    cleansable: false,\r\n    dispellable: false,\r\n  },\r\n  [EffectType.Phased]: {\r\n    type: EffectType.Phased,\r\n    category: EffectCategory.Buff,\r\n    stackBehavior: StackBehavior.Refresh,\r\n    maxStacks: 1,\r\n    priority: 60,\r\n    cleansable: false,\r\n    dispellable: false,\r\n  },\r\n};\r\n\r\n// ----------------------------------------------------------------------------\r\n// ACTIVE EFFECT INSTANCE\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface ActiveEffect {\r\n  id: string;\r\n  type: EffectType;\r\n  sourceId: EntityId;      // Who applied the effect\r\n  targetId: EntityId;      // Who has the effect\r\n  startTime: number;       // Game time when applied\r\n  duration: number;        // Duration in ms (0 = permanent until removed)\r\n  value: number;           // Effect strength (damage/heal per tick, % modifier, etc.)\r\n  stacks: number;          // Current stack count\r\n  tickInterval: number;    // How often to apply (for DoT/HoT), 0 = once\r\n  lastTickTime: number;    // Last time effect ticked\r\n  data: Record<string, unknown> | null; // Extra data for special effects\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// ZONE EFFECT (Area effects like poison cloud, healing field)\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface ZoneEffect {\r\n  id: string;\r\n  type: EffectType;\r\n  sourceId: EntityId;\r\n  position: Vector2;\r\n  radius: number;\r\n  startTime: number;\r\n  duration: number;\r\n  tickInterval: number;\r\n  lastTickTime: number;\r\n  value: number;\r\n  affectsAllies: boolean;\r\n  affectsEnemies: boolean;\r\n  visualType: ZoneVisualType;\r\n}\r\n\r\nexport enum ZoneVisualType {\r\n  PoisonCloud = 'poison_cloud',\r\n  FireZone = 'fire_zone',\r\n  HealingField = 'healing_field',\r\n  SlowField = 'slow_field',\r\n  ShieldDome = 'shield_dome',\r\n  StunZone = 'stun_zone',\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// EFFECT SYSTEM\r\n// ----------------------------------------------------------------------------\r\n\r\nexport class EffectSystem {\r\n  private activeEffects: Map<EntityId, ActiveEffect[]> = new Map();\r\n  private zoneEffects: ZoneEffect[] = [];\r\n  \r\n  // Callbacks for when effects are applied/removed\r\n  private onEffectApplied: ((effect: ActiveEffect) => void) | null = null;\r\n  private onEffectRemoved: ((effect: ActiveEffect) => void) | null = null;\r\n  private onEffectTick: ((effect: ActiveEffect, value: number) => void) | null = null;\r\n  private onZoneTick: ((zone: ZoneEffect, targetIds: EntityId[]) => void) | null = null;\r\n\r\n  constructor(callbacks?: {\r\n    onEffectApplied?: (effect: ActiveEffect) => void;\r\n    onEffectRemoved?: (effect: ActiveEffect) => void;\r\n    onEffectTick?: (effect: ActiveEffect, value: number) => void;\r\n    onZoneTick?: (zone: ZoneEffect, targetIds: EntityId[]) => void;\r\n  }) {\r\n    if (callbacks) {\r\n      this.onEffectApplied = callbacks.onEffectApplied ?? null;\r\n      this.onEffectRemoved = callbacks.onEffectRemoved ?? null;\r\n      this.onEffectTick = callbacks.onEffectTick ?? null;\r\n      this.onZoneTick = callbacks.onZoneTick ?? null;\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // EFFECT APPLICATION\r\n  // -------------------------------------------------------------------------\r\n\r\n  applyEffect(\r\n    type: EffectType,\r\n    sourceId: EntityId,\r\n    targetId: EntityId,\r\n    duration: number,\r\n    value: number,\r\n    tickInterval: number = 0,\r\n    data?: Record<string, unknown>\r\n  ): ActiveEffect | null {\r\n    const definition = EFFECT_DEFINITIONS[type];\r\n    if (!definition) return null;\r\n\r\n    // Get existing effects on target\r\n    let targetEffects = this.activeEffects.get(targetId);\r\n    if (!targetEffects) {\r\n      targetEffects = [];\r\n      this.activeEffects.set(targetId, targetEffects);\r\n    }\r\n\r\n    // Check for existing effect of same type\r\n    const existingIndex = targetEffects.findIndex(e => e.type === type);\r\n    const existing = existingIndex >= 0 ? targetEffects[existingIndex] : null;\r\n\r\n    // Handle stacking behavior\r\n    switch (definition.stackBehavior) {\r\n      case StackBehavior.None:\r\n        if (existing) return null; // Don't apply\r\n        break;\r\n        \r\n      case StackBehavior.Refresh:\r\n        if (existing) {\r\n          // Reset duration\r\n          existing.startTime = Date.now();\r\n          existing.duration = duration;\r\n          if (value > existing.value) existing.value = value; // Take stronger\r\n          return existing;\r\n        }\r\n        break;\r\n        \r\n      case StackBehavior.Stack:\r\n        if (existing) {\r\n          if (existing.stacks < definition.maxStacks) {\r\n            existing.stacks++;\r\n            existing.startTime = Date.now(); // Refresh duration too\r\n            existing.duration = duration;\r\n          }\r\n          return existing;\r\n        }\r\n        break;\r\n        \r\n      case StackBehavior.Replace:\r\n        if (existing) {\r\n          if (value >= existing.value) {\r\n            // Replace with stronger/equal\r\n            existing.value = value;\r\n            existing.startTime = Date.now();\r\n            existing.duration = duration;\r\n            existing.sourceId = sourceId;\r\n          }\r\n          return existing;\r\n        }\r\n        break;\r\n        \r\n      case StackBehavior.Separate:\r\n        // Allow multiple from different sources\r\n        const existingFromSource = targetEffects.find(\r\n          e => e.type === type && e.sourceId === sourceId\r\n        );\r\n        if (existingFromSource) {\r\n          existingFromSource.startTime = Date.now();\r\n          existingFromSource.duration = duration;\r\n          existingFromSource.value = value;\r\n          return existingFromSource;\r\n        }\r\n        break;\r\n    }\r\n\r\n    // Create new effect\r\n    const newEffect: ActiveEffect = {\r\n      id: generateId('effect'),\r\n      type,\r\n      sourceId,\r\n      targetId,\r\n      startTime: Date.now(),\r\n      duration,\r\n      value,\r\n      stacks: 1,\r\n      tickInterval,\r\n      lastTickTime: Date.now(),\r\n      data: data ?? null,\r\n    };\r\n\r\n    targetEffects.push(newEffect);\r\n    \r\n    // Handle effect conflicts\r\n    this.resolveConflicts(targetId);\r\n    \r\n    this.onEffectApplied?.(newEffect);\r\n    return newEffect;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // CONFLICT RESOLUTION\r\n  // -------------------------------------------------------------------------\r\n\r\n  private resolveConflicts(targetId: EntityId): void {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return;\r\n\r\n    // Revealed breaks Cloak\r\n    const hasRevealed = effects.some(e => e.type === EffectType.Revealed);\r\n    if (hasRevealed) {\r\n      const cloakIndex = effects.findIndex(e => e.type === EffectType.Cloak);\r\n      if (cloakIndex >= 0) {\r\n        const removed = effects.splice(cloakIndex, 1)[0];\r\n        if (removed) this.onEffectRemoved?.(removed);\r\n      }\r\n    }\r\n\r\n    // Immunity/Invulnerable removes debuffs (but they can't be reapplied while active)\r\n    const hasImmunity = effects.some(\r\n      e => e.type === EffectType.Immunity || e.type === EffectType.Invulnerable\r\n    );\r\n    if (hasImmunity) {\r\n      for (let i = effects.length - 1; i >= 0; i--) {\r\n        const effect = effects[i]!;\r\n        const def = EFFECT_DEFINITIONS[effect.type];\r\n        if (def.category === EffectCategory.Debuff) {\r\n          const removed = effects.splice(i, 1)[0];\r\n          if (removed) this.onEffectRemoved?.(removed);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // EFFECT REMOVAL\r\n  // -------------------------------------------------------------------------\r\n\r\n  removeEffect(targetId: EntityId, effectId: string): boolean {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return false;\r\n\r\n    const index = effects.findIndex(e => e.id === effectId);\r\n    if (index < 0) return false;\r\n\r\n    const removed = effects.splice(index, 1)[0];\r\n    if (removed) this.onEffectRemoved?.(removed);\r\n    return true;\r\n  }\r\n\r\n  removeEffectsByType(targetId: EntityId, type: EffectType): number {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return 0;\r\n\r\n    let count = 0;\r\n    for (let i = effects.length - 1; i >= 0; i--) {\r\n      if (effects[i]!.type === type) {\r\n        const removed = effects.splice(i, 1)[0];\r\n        if (removed) {\r\n          this.onEffectRemoved?.(removed);\r\n          count++;\r\n        }\r\n      }\r\n    }\r\n    return count;\r\n  }\r\n\r\n  removeAllEffects(targetId: EntityId): void {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return;\r\n\r\n    for (const effect of effects) {\r\n      this.onEffectRemoved?.(effect);\r\n    }\r\n    this.activeEffects.delete(targetId);\r\n  }\r\n\r\n  cleanse(targetId: EntityId): number {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return 0;\r\n\r\n    let count = 0;\r\n    for (let i = effects.length - 1; i >= 0; i--) {\r\n      const effect = effects[i]!;\r\n      const def = EFFECT_DEFINITIONS[effect.type];\r\n      if (def.cleansable) {\r\n        const removed = effects.splice(i, 1)[0];\r\n        if (removed) {\r\n          this.onEffectRemoved?.(removed);\r\n          count++;\r\n        }\r\n      }\r\n    }\r\n    return count;\r\n  }\r\n\r\n  dispel(targetId: EntityId): number {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return 0;\r\n\r\n    let count = 0;\r\n    for (let i = effects.length - 1; i >= 0; i--) {\r\n      const effect = effects[i]!;\r\n      const def = EFFECT_DEFINITIONS[effect.type];\r\n      if (def.dispellable) {\r\n        const removed = effects.splice(i, 1)[0];\r\n        if (removed) {\r\n          this.onEffectRemoved?.(removed);\r\n          count++;\r\n        }\r\n      }\r\n    }\r\n    return count;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // ZONE EFFECTS\r\n  // -------------------------------------------------------------------------\r\n\r\n  createZone(\r\n    type: EffectType,\r\n    sourceId: EntityId,\r\n    position: Vector2,\r\n    radius: number,\r\n    duration: number,\r\n    tickInterval: number,\r\n    value: number,\r\n    affectsAllies: boolean,\r\n    affectsEnemies: boolean,\r\n    visualType: ZoneVisualType\r\n  ): ZoneEffect {\r\n    const zone: ZoneEffect = {\r\n      id: generateId('zone'),\r\n      type,\r\n      sourceId,\r\n      position: { ...position },\r\n      radius,\r\n      startTime: Date.now(),\r\n      duration,\r\n      tickInterval,\r\n      lastTickTime: Date.now(),\r\n      value,\r\n      affectsAllies,\r\n      affectsEnemies,\r\n      visualType,\r\n    };\r\n    this.zoneEffects.push(zone);\r\n    return zone;\r\n  }\r\n\r\n  removeZone(zoneId: string): boolean {\r\n    const index = this.zoneEffects.findIndex(z => z.id === zoneId);\r\n    if (index < 0) return false;\r\n    this.zoneEffects.splice(index, 1);\r\n    return true;\r\n  }\r\n\r\n  getZones(): ZoneEffect[] {\r\n    return [...this.zoneEffects];\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // QUERIES\r\n  // -------------------------------------------------------------------------\r\n\r\n  hasEffect(targetId: EntityId, type: EffectType): boolean {\r\n    const effects = this.activeEffects.get(targetId);\r\n    return effects?.some(e => e.type === type) ?? false;\r\n  }\r\n\r\n  getEffect(targetId: EntityId, type: EffectType): ActiveEffect | undefined {\r\n    const effects = this.activeEffects.get(targetId);\r\n    return effects?.find(e => e.type === type);\r\n  }\r\n\r\n  getEffects(targetId: EntityId): ActiveEffect[] {\r\n    return this.activeEffects.get(targetId) ?? [];\r\n  }\r\n\r\n  getEffectsByCategory(targetId: EntityId, category: EffectCategory): ActiveEffect[] {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return [];\r\n    return effects.filter(e => EFFECT_DEFINITIONS[e.type].category === category);\r\n  }\r\n\r\n  // Computed modifiers from effects\r\n  getSpeedModifier(targetId: EntityId): number {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return 1;\r\n\r\n    let modifier = 1;\r\n    for (const effect of effects) {\r\n      switch (effect.type) {\r\n        case EffectType.SpeedBoost:\r\n          modifier *= 1 + effect.value / 100;\r\n          break;\r\n        case EffectType.SpeedReduction:\r\n        case EffectType.Slow:\r\n          modifier *= 1 - effect.value / 100;\r\n          break;\r\n        case EffectType.Root:\r\n        case EffectType.Stun:\r\n          modifier = 0;\r\n          break;\r\n      }\r\n    }\r\n    return Math.max(0, modifier);\r\n  }\r\n\r\n  getDamageModifier(targetId: EntityId): number {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return 1;\r\n\r\n    let modifier = 1;\r\n    for (const effect of effects) {\r\n      if (effect.type === EffectType.DamageBoost) {\r\n        modifier *= 1 + effect.value / 100;\r\n      }\r\n    }\r\n    return modifier;\r\n  }\r\n\r\n  getDamageReduction(targetId: EntityId): number {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return 0;\r\n\r\n    let reduction = 0;\r\n    for (const effect of effects) {\r\n      if (effect.type === EffectType.DamageReduction) {\r\n        reduction = Math.max(reduction, effect.value);\r\n      }\r\n      if (effect.type === EffectType.Immunity || effect.type === EffectType.Invulnerable) {\r\n        return 100; // Full immunity\r\n      }\r\n    }\r\n    return reduction;\r\n  }\r\n\r\n  getFireRateModifier(targetId: EntityId): number {\r\n    const effects = this.activeEffects.get(targetId);\r\n    if (!effects) return 1;\r\n\r\n    let modifier = 1;\r\n    for (const effect of effects) {\r\n      if (effect.type === EffectType.FireRateBoost) {\r\n        modifier *= 1 + effect.value / 100;\r\n      }\r\n      if (effect.type === EffectType.Stun) {\r\n        modifier = 0;\r\n      }\r\n    }\r\n    return modifier;\r\n  }\r\n\r\n  isStunned(targetId: EntityId): boolean {\r\n    return this.hasEffect(targetId, EffectType.Stun);\r\n  }\r\n\r\n  isRooted(targetId: EntityId): boolean {\r\n    return this.hasEffect(targetId, EffectType.Root);\r\n  }\r\n\r\n  isSilenced(targetId: EntityId): boolean {\r\n    return this.hasEffect(targetId, EffectType.Silence);\r\n  }\r\n\r\n  isCloaked(targetId: EntityId): boolean {\r\n    return this.hasEffect(targetId, EffectType.Cloak) && \r\n           !this.hasEffect(targetId, EffectType.Revealed);\r\n  }\r\n\r\n  isPhased(targetId: EntityId): boolean {\r\n    return this.hasEffect(targetId, EffectType.Phased);\r\n  }\r\n\r\n  isInvulnerable(targetId: EntityId): boolean {\r\n    return this.hasEffect(targetId, EffectType.Invulnerable) ||\r\n           this.hasEffect(targetId, EffectType.Immunity);\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // UPDATE\r\n  // -------------------------------------------------------------------------\r\n\r\n  update(_gameTime: number, getEntitiesInRadius: (pos: Vector2, radius: number) => EntityId[]): void {\r\n    const now = Date.now();\r\n\r\n    // Update active effects\r\n    for (const [targetId, effects] of this.activeEffects) {\r\n      for (let i = effects.length - 1; i >= 0; i--) {\r\n        const effect = effects[i]!;\r\n        \r\n        // Check expiration\r\n        if (effect.duration > 0 && now >= effect.startTime + effect.duration) {\r\n          const removed = effects.splice(i, 1)[0];\r\n          if (removed) this.onEffectRemoved?.(removed);\r\n          continue;\r\n        }\r\n\r\n        // Process ticks (DoT, HoT)\r\n        if (effect.tickInterval > 0 && now >= effect.lastTickTime + effect.tickInterval) {\r\n          effect.lastTickTime = now;\r\n          const tickValue = effect.value * effect.stacks;\r\n          this.onEffectTick?.(effect, tickValue);\r\n        }\r\n      }\r\n\r\n      // Clean up empty arrays\r\n      if (effects.length === 0) {\r\n        this.activeEffects.delete(targetId);\r\n      }\r\n    }\r\n\r\n    // Update zone effects\r\n    for (let i = this.zoneEffects.length - 1; i >= 0; i--) {\r\n      const zone = this.zoneEffects[i]!;\r\n      \r\n      // Check expiration\r\n      if (now >= zone.startTime + zone.duration) {\r\n        this.zoneEffects.splice(i, 1);\r\n        continue;\r\n      }\r\n\r\n      // Process zone ticks\r\n      if (now >= zone.lastTickTime + zone.tickInterval) {\r\n        zone.lastTickTime = now;\r\n        const entitiesInZone = getEntitiesInRadius(zone.position, zone.radius);\r\n        if (entitiesInZone.length > 0) {\r\n          this.onZoneTick?.(zone, entitiesInZone);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // SERIALIZATION (for network sync)\r\n  // -------------------------------------------------------------------------\r\n\r\n  getState(): { effects: Map<EntityId, ActiveEffect[]>; zones: ZoneEffect[] } {\r\n    return {\r\n      effects: new Map(this.activeEffects),\r\n      zones: [...this.zoneEffects],\r\n    };\r\n  }\r\n\r\n  setState(state: { effects: Map<EntityId, ActiveEffect[]>; zones: ZoneEffect[] }): void {\r\n    this.activeEffects = new Map(state.effects);\r\n    this.zoneEffects = [...state.zones];\r\n  }\r\n\r\n  clear(): void {\r\n    this.activeEffects.clear();\r\n    this.zoneEffects = [];\r\n  }\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// HELPER CONSTANTS\r\n// ----------------------------------------------------------------------------\r\n\r\nexport const TILE_SIZE = 32;\r\n\r\n// Convert tiles to pixels for ability ranges\r\nexport function tilesToPixels(tiles: number): number {\r\n  return tiles * TILE_SIZE;\r\n}\r\n\r\n// Convert pixels to tiles\r\nexport function pixelsToTiles(pixels: number): number {\r\n  return pixels / TILE_SIZE;\r\n}\r\n\r\n// Common ability ranges in pixels\r\nexport const ABILITY_RANGES = {\r\n  MELEE: tilesToPixels(1),        // 32px\r\n  SHORT: tilesToPixels(3),         // 96px\r\n  MEDIUM: tilesToPixels(5),        // 160px\r\n  LONG: tilesToPixels(8),          // 256px\r\n  VERY_LONG: tilesToPixels(12),    // 384px\r\n  \r\n  // Specific ability ranges\r\n  BLINK: tilesToPixels(3),\r\n  REVEAL: tilesToPixels(5),\r\n  HEAL_BURST: tilesToPixels(4),\r\n  SHOCKWAVE: tilesToPixels(4),\r\n  GRENADE: tilesToPixels(6),\r\n  TURRET_RANGE: tilesToPixels(5),\r\n  POISON_CLOUD: tilesToPixels(3),\r\n  DOME_SHIELD: tilesToPixels(4),\r\n};\r\n","// ============================================================================\r\n// ABILITY SYSTEM - Hero ability implementations\r\n// ============================================================================\r\n\r\nimport { EntityId, Vector2, HeroId, Team } from '@/shared/types';\r\nimport { Vec2, generateId } from '@/shared/utils';\r\nimport { Player } from '@/game/entities/Player';\r\nimport { \r\n  EffectSystem, \r\n  EffectType, \r\n  ZoneVisualType,\r\n  ABILITY_RANGES,\r\n  tilesToPixels \r\n} from './EffectSystem';\r\n\r\n// ----------------------------------------------------------------------------\r\n// ABILITY RESULT TYPES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface AbilityResult {\r\n  success: boolean;\r\n  effectsApplied: string[];\r\n  damage?: number;\r\n  healing?: number;\r\n  targetIds?: EntityId[];\r\n  projectiles?: ProjectileData[];\r\n  zones?: ZoneData[];\r\n  teleportTo?: Vector2;\r\n  visualEffects?: VisualEffectData[];\r\n}\r\n\r\nexport interface ProjectileData {\r\n  id: string;\r\n  ownerId: EntityId;\r\n  position: Vector2;\r\n  direction: Vector2;\r\n  speed: number;\r\n  damage: number;\r\n  lifetime: number;\r\n  isHoming?: boolean;\r\n  targetId?: EntityId;\r\n}\r\n\r\nexport interface ZoneData {\r\n  id: string;\r\n  type: ZoneVisualType;\r\n  position: Vector2;\r\n  radius: number;\r\n  duration: number;\r\n}\r\n\r\nexport interface VisualEffectData {\r\n  type: VisualEffectType;\r\n  position: Vector2;\r\n  direction?: number;\r\n  radius?: number;\r\n  duration: number;\r\n  color?: string;\r\n  targetPosition?: Vector2;\r\n  followPlayerId?: string; // If set, effect follows this player's position/rotation\r\n}\r\n\r\nexport enum VisualEffectType {\r\n  Blink = 'blink',\r\n  BlinkTrail = 'blink_trail',\r\n  Shockwave = 'shockwave',\r\n  Shield = 'shield',\r\n  DomeShield = 'dome_shield',\r\n  BarrierWall = 'barrier_wall',\r\n  Cloak = 'cloak',\r\n  Reveal = 'reveal',\r\n  HealBurst = 'heal_burst',\r\n  HealingField = 'healing_field',\r\n  PoisonCloud = 'poison_cloud',\r\n  Grenade = 'grenade',\r\n  Explosion = 'explosion',\r\n  TurretSpawn = 'turret_spawn',\r\n  DashSlash = 'dash_slash',\r\n  MinigunMode = 'minigun_mode',\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// TURRET ENTITY\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface Turret {\r\n  id: string;\r\n  ownerId: EntityId;\r\n  ownerTeam: Team;\r\n  position: Vector2;\r\n  rotation: number;\r\n  health: number;\r\n  maxHealth: number;\r\n  range: number;\r\n  damage: number;\r\n  fireRate: number;\r\n  lastFireTime: number;\r\n  spawnTime: number;\r\n  duration: number;\r\n  targetId: EntityId | null;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// ABILITY SYSTEM\r\n// ----------------------------------------------------------------------------\r\n\r\nexport class AbilitySystem {\r\n  private effectSystem: EffectSystem;\r\n  private turrets: Map<string, Turret> = new Map();\r\n  private activeMiniguns: Map<EntityId, number> = new Map(); // playerId -> endTime\r\n  \r\n  // Callbacks for game integration\r\n  private getEnemies: (team: Team) => Player[];\r\n  private getAllies: (team: Team, excludeId?: EntityId) => Player[];\r\n  private getTime: () => number;\r\n  private raycast: (start: Vector2, direction: Vector2, maxDist: number, ignorePlayers?: EntityId[]) => { point: Vector2; distance: number } | null;\r\n\r\n  constructor(\r\n    effectSystem: EffectSystem,\r\n    callbacks: {\r\n      getPlayer: (id: EntityId) => Player | undefined;\r\n      getPlayers: () => Player[];\r\n      getEnemies: (team: Team) => Player[];\r\n      getAllies: (team: Team, excludeId?: EntityId) => Player[];\r\n      getTime: () => number;\r\n      raycast: (start: Vector2, direction: Vector2, maxDist: number, ignorePlayers?: EntityId[]) => { point: Vector2; distance: number } | null;\r\n    }\r\n  ) {\r\n    this.effectSystem = effectSystem;\r\n    this.getEnemies = callbacks.getEnemies;\r\n    this.getAllies = callbacks.getAllies;\r\n    this.getTime = callbacks.getTime;\r\n    this.raycast = callbacks.raycast;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // MAIN ABILITY EXECUTION\r\n  // -------------------------------------------------------------------------\r\n\r\n  executeAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    // Check if silenced\r\n    if (this.effectSystem.isSilenced(player.id)) {\r\n      return { success: false, effectsApplied: [] };\r\n    }\r\n\r\n    switch (player.heroId) {\r\n      case HeroId.Katana: // Phantom / Assassin\r\n        return this.executePhantomAbility(player, abilityIndex);\r\n      \r\n      case HeroId.Vanta: // Titan / Tank\r\n        return this.executeTitanAbility(player, abilityIndex);\r\n      \r\n      case HeroId.Spectre: // Spectre / Recon\r\n        return this.executeSpectreAbility(player, abilityIndex);\r\n      \r\n      case HeroId.Mira: // Medic / Support\r\n        return this.executeMedicAbility(player, abilityIndex);\r\n      \r\n      case HeroId.Spark: // Havoc / Assault\r\n        return this.executeHavocAbility(player, abilityIndex);\r\n      \r\n      case HeroId.Byte: // Cipher / Tech\r\n        return this.executeCipherAbility(player, abilityIndex);\r\n      \r\n      case HeroId.Glyph: // Venom / Saboteur\r\n        return this.executeVenomAbility(player, abilityIndex);\r\n      \r\n      case HeroId.Zero: // Aegis / Guardian\r\n        return this.executeAegisAbility(player, abilityIndex);\r\n      \r\n      default:\r\n        return { success: false, effectsApplied: [] };\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // PHANTOM (Katana) - Assassin\r\n  // Passive: Wall phase | Q: Blink | E: Invisibility\r\n  // -------------------------------------------------------------------------\r\n\r\n  private executePhantomAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    const result: AbilityResult = { success: false, effectsApplied: [], visualEffects: [] };\r\n\r\n    switch (abilityIndex) {\r\n      case 0: // Passive: Wall Phase - handled in movement system\r\n        break;\r\n\r\n      case 1: // Q: Blink - teleport 3 tiles forward\r\n        {\r\n          const blinkDistance = ABILITY_RANGES.BLINK;\r\n          const direction = Vec2.fromAngle(player.rotation);\r\n          const targetPos = Vec2.add(player.position, Vec2.mul(direction, blinkDistance));\r\n          \r\n          // Check for wall collision along the path\r\n          const hit = this.raycast(player.position, direction, blinkDistance, [player.id]);\r\n          const finalPos = hit ? Vec2.sub(hit.point, Vec2.mul(direction, 20)) : targetPos;\r\n          \r\n          result.teleportTo = finalPos;\r\n          result.visualEffects!.push(\r\n            { type: VisualEffectType.Blink, position: player.position, duration: 300 },\r\n            { type: VisualEffectType.Blink, position: finalPos, duration: 300 },\r\n            { type: VisualEffectType.BlinkTrail, position: player.position, targetPosition: finalPos, duration: 200 }\r\n          );\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 2: // F: Invisibility - 4 seconds cloak\r\n        {\r\n          const duration = 4000;\r\n          this.effectSystem.applyEffect(\r\n            EffectType.Cloak,\r\n            player.id,\r\n            player.id,\r\n            duration,\r\n            100 // Full invisibility\r\n          );\r\n          result.effectsApplied.push('cloak');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.Cloak,\r\n            position: player.position,\r\n            duration\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 3: // Ultimate: Shadow Strike - teleport behind target + damage\r\n        {\r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          if (enemies.length === 0) break;\r\n          \r\n          // Find closest visible enemy\r\n          let target: Player | null = null;\r\n          let closestDist = Infinity;\r\n          \r\n          for (const enemy of enemies) {\r\n            const dist = Vec2.distance(player.position, enemy.position);\r\n            if (dist < closestDist && dist < tilesToPixels(10)) {\r\n              closestDist = dist;\r\n              target = enemy;\r\n            }\r\n          }\r\n          \r\n          if (target) {\r\n            // Teleport behind target\r\n            const behindDir = Vec2.fromAngle(target.rotation + Math.PI);\r\n            const behindPos = Vec2.add(target.position, Vec2.mul(behindDir, 40));\r\n            \r\n            result.teleportTo = behindPos;\r\n            result.damage = 75;\r\n            result.targetIds = [target.id];\r\n            result.visualEffects!.push(\r\n              { type: VisualEffectType.Blink, position: player.position, duration: 300 },\r\n              { type: VisualEffectType.DashSlash, position: behindPos, direction: target.rotation, duration: 500 }\r\n            );\r\n            result.success = true;\r\n          }\r\n        }\r\n        break;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // TITAN (Vanta) - Tank\r\n  // Passive: Spawn shield | Q: Fortify | E: Shockwave\r\n  // -------------------------------------------------------------------------\r\n\r\n  private executeTitanAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    const result: AbilityResult = { success: false, effectsApplied: [], visualEffects: [] };\r\n\r\n    switch (abilityIndex) {\r\n      case 0: // Passive: +50 shield on spawn - handled in spawn logic\r\n        break;\r\n\r\n      case 1: // Q: Energy Shield - Front-facing barrier for 3s, blocks incoming damage from front\r\n        {\r\n          const duration = 3000;\r\n          \r\n          // Apply front shield effect (provides damage reduction from frontal attacks)\r\n          this.effectSystem.applyEffect(\r\n            EffectType.FrontShield,\r\n            player.id,\r\n            player.id,\r\n            duration,\r\n            80 // 80% damage reduction from front\r\n          );\r\n          \r\n          result.effectsApplied.push('front_shield');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.BarrierWall,\r\n            position: { ...player.position },\r\n            direction: player.rotation,\r\n            duration,\r\n            color: '#0ce5f0',\r\n            followPlayerId: player.id // Barrier follows the player\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 2: // F: Shockwave Slam - AoE stun 4 tile radius, 30 damage\r\n        {\r\n          const radius = ABILITY_RANGES.SHOCKWAVE;\r\n          const damage = 30;\r\n          const stunDuration = 1500;\r\n          \r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          const hitTargets: EntityId[] = [];\r\n          \r\n          for (const enemy of enemies) {\r\n            const dist = Vec2.distance(player.position, enemy.position);\r\n            if (dist <= radius) {\r\n              // Apply stun\r\n              this.effectSystem.applyEffect(\r\n                EffectType.Stun,\r\n                player.id,\r\n                enemy.id,\r\n                stunDuration,\r\n                100\r\n              );\r\n              hitTargets.push(enemy.id);\r\n            }\r\n          }\r\n          \r\n          result.damage = damage;\r\n          result.targetIds = hitTargets;\r\n          result.effectsApplied.push('stun');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.Shockwave,\r\n            position: player.position,\r\n            radius,\r\n            duration: 500\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 3: // Ultimate: Overclock - 40% DR + fire rate for 5s\r\n        {\r\n          const duration = 5000;\r\n          \r\n          this.effectSystem.applyEffect(\r\n            EffectType.DamageReduction,\r\n            player.id,\r\n            player.id,\r\n            duration,\r\n            40\r\n          );\r\n          \r\n          this.effectSystem.applyEffect(\r\n            EffectType.FireRateBoost,\r\n            player.id,\r\n            player.id,\r\n            duration,\r\n            40\r\n          );\r\n          \r\n          result.effectsApplied.push('damage_reduction', 'fire_rate_boost');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.Shield,\r\n            position: player.position,\r\n            duration,\r\n            color: '#ff0000'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // SPECTRE - Recon\r\n  // Passive: X-ray 3 tiles | Q: Reveal 5 tiles | E: Hologram decoy\r\n  // -------------------------------------------------------------------------\r\n\r\n  private executeSpectreAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    const result: AbilityResult = { success: false, effectsApplied: [], visualEffects: [] };\r\n\r\n    switch (abilityIndex) {\r\n      case 0: // Passive: See through walls 3 tiles - handled in rendering\r\n        break;\r\n\r\n      case 1: // Q: Cloak - invisibility 2s (existing)\r\n        {\r\n          const duration = 2000;\r\n          this.effectSystem.applyEffect(\r\n            EffectType.Cloak,\r\n            player.id,\r\n            player.id,\r\n            duration,\r\n            100\r\n          );\r\n          result.effectsApplied.push('cloak');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.Cloak,\r\n            position: player.position,\r\n            duration\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 2: // F: Reveal - reveal all enemies within 5 tiles for 3s\r\n        {\r\n          const radius = ABILITY_RANGES.REVEAL;\r\n          const duration = 3000;\r\n          \r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          const revealedTargets: EntityId[] = [];\r\n          \r\n          for (const enemy of enemies) {\r\n            const dist = Vec2.distance(player.position, enemy.position);\r\n            if (dist <= radius) {\r\n              this.effectSystem.applyEffect(\r\n                EffectType.Revealed,\r\n                player.id,\r\n                enemy.id,\r\n                duration,\r\n                100\r\n              );\r\n              revealedTargets.push(enemy.id);\r\n            }\r\n          }\r\n          \r\n          result.targetIds = revealedTargets;\r\n          result.effectsApplied.push('revealed');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.Reveal,\r\n            position: player.position,\r\n            radius,\r\n            duration: 500\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 3: // Ultimate: Shadow Dive - teleport behind enemy\r\n        {\r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          if (enemies.length === 0) break;\r\n          \r\n          // Find closest enemy\r\n          let target: Player | null = null;\r\n          let closestDist = Infinity;\r\n          \r\n          for (const enemy of enemies) {\r\n            const dist = Vec2.distance(player.position, enemy.position);\r\n            if (dist < closestDist) {\r\n              closestDist = dist;\r\n              target = enemy;\r\n            }\r\n          }\r\n          \r\n          if (target) {\r\n            const behindDir = Vec2.fromAngle(target.rotation + Math.PI);\r\n            const behindPos = Vec2.add(target.position, Vec2.mul(behindDir, 50));\r\n            \r\n            result.teleportTo = behindPos;\r\n            result.visualEffects!.push(\r\n              { type: VisualEffectType.Blink, position: player.position, duration: 300 },\r\n              { type: VisualEffectType.Blink, position: behindPos, duration: 300 }\r\n            );\r\n            result.success = true;\r\n          }\r\n        }\r\n        break;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // MEDIC (Mira) - Support\r\n  // Passive: Proximity heal | Q: Heal burst 50 HP | E: Revive\r\n  // -------------------------------------------------------------------------\r\n\r\n  private executeMedicAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    const result: AbilityResult = { success: false, effectsApplied: [], visualEffects: [] };\r\n\r\n    switch (abilityIndex) {\r\n      case 0: // Passive: Heal allies 3 HP/s in 2 tile radius - handled in update\r\n        break;\r\n\r\n      case 1: // Q: Nano-Heal Field - healing zone for 4s\r\n        {\r\n          const radius = tilesToPixels(3);\r\n          const duration = 4000;\r\n          const healPerTick = 10;\r\n          const tickInterval = 500;\r\n          \r\n          this.effectSystem.createZone(\r\n            EffectType.Regen,\r\n            player.id,\r\n            player.position,\r\n            radius,\r\n            duration,\r\n            tickInterval,\r\n            healPerTick,\r\n            true, // affects allies\r\n            false, // doesn't affect enemies\r\n            ZoneVisualType.HealingField\r\n          );\r\n          \r\n          result.zones = [{\r\n            id: generateId('zone'),\r\n            type: ZoneVisualType.HealingField,\r\n            position: { ...player.position },\r\n            radius,\r\n            duration\r\n          }];\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.HealingField,\r\n            position: player.position,\r\n            radius,\r\n            duration,\r\n            color: '#00ff88'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 2: // F: Shield Burst - give 30 temp shield to nearby allies\r\n        {\r\n          const radius = ABILITY_RANGES.HEAL_BURST;\r\n          const shieldAmount = 30;\r\n          const duration = 3000;\r\n          \r\n          const allies = this.getAllies(player.team, player.id).filter(a => a.alive);\r\n          const shieldedTargets: EntityId[] = [];\r\n          \r\n          for (const ally of allies) {\r\n            const dist = Vec2.distance(player.position, ally.position);\r\n            if (dist <= radius) {\r\n              this.effectSystem.applyEffect(\r\n                EffectType.Shield,\r\n                player.id,\r\n                ally.id,\r\n                duration,\r\n                shieldAmount\r\n              );\r\n              shieldedTargets.push(ally.id);\r\n            }\r\n          }\r\n          \r\n          // Also shield self\r\n          this.effectSystem.applyEffect(\r\n            EffectType.Shield,\r\n            player.id,\r\n            player.id,\r\n            duration,\r\n            shieldAmount\r\n          );\r\n          \r\n          result.targetIds = shieldedTargets;\r\n          result.effectsApplied.push('shield');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.HealBurst,\r\n            position: player.position,\r\n            radius,\r\n            duration: 500,\r\n            color: '#00aaff'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 3: // Ultimate: Resync - instant revive ally with 50% HP\r\n        {\r\n          // Find closest dead ally\r\n          const allies = this.getAllies(player.team, player.id).filter(a => !a.alive);\r\n          if (allies.length === 0) break;\r\n          \r\n          let target: Player | null = null;\r\n          let closestDist = tilesToPixels(5); // Max revive range\r\n          \r\n          for (const ally of allies) {\r\n            const dist = Vec2.distance(player.position, ally.position);\r\n            if (dist < closestDist) {\r\n              closestDist = dist;\r\n              target = ally;\r\n            }\r\n          }\r\n          \r\n          if (target) {\r\n            result.targetIds = [target.id];\r\n            result.healing = target.maxHealth * 0.5;\r\n            result.effectsApplied.push('revive');\r\n            result.visualEffects!.push({\r\n              type: VisualEffectType.HealBurst,\r\n              position: target.position,\r\n              duration: 1000,\r\n              color: '#ffff00'\r\n            });\r\n            result.success = true;\r\n          }\r\n        }\r\n        break;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // HAVOC (Spark) - Assault\r\n  // Passive: +10% fire rate | Q: Grenade | E: Minigun mode\r\n  // -------------------------------------------------------------------------\r\n\r\n  private executeHavocAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    const result: AbilityResult = { success: false, effectsApplied: [], visualEffects: [] };\r\n\r\n    switch (abilityIndex) {\r\n      case 0: // Passive: +10% fire rate - handled in weapon system\r\n        break;\r\n\r\n      case 1: // Q: Plasma Fire Bottle - burning zone\r\n        {\r\n          const throwDistance = ABILITY_RANGES.GRENADE;\r\n          const direction = Vec2.fromAngle(player.rotation);\r\n          const targetPos = Vec2.add(player.position, Vec2.mul(direction, throwDistance));\r\n          \r\n          // Check for wall collision\r\n          const hit = this.raycast(player.position, direction, throwDistance, [player.id]);\r\n          const landingPos = hit ? hit.point : targetPos;\r\n          \r\n          const radius = tilesToPixels(2);\r\n          const duration = 4000;\r\n          const damagePerTick = 15;\r\n          const tickInterval = 500;\r\n          \r\n          this.effectSystem.createZone(\r\n            EffectType.Burn,\r\n            player.id,\r\n            landingPos,\r\n            radius,\r\n            duration,\r\n            tickInterval,\r\n            damagePerTick,\r\n            false, // doesn't affect allies\r\n            true,  // affects enemies\r\n            ZoneVisualType.FireZone\r\n          );\r\n          \r\n          result.zones = [{\r\n            id: generateId('zone'),\r\n            type: ZoneVisualType.FireZone,\r\n            position: landingPos,\r\n            radius,\r\n            duration\r\n          }];\r\n          result.visualEffects!.push(\r\n            { type: VisualEffectType.Grenade, position: player.position, targetPosition: landingPos, duration: 500 },\r\n            { type: VisualEffectType.Explosion, position: landingPos, radius, duration: 300 }\r\n          );\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 2: // F: Thermal Burst - clear smoke/holos + reveal\r\n        {\r\n          const radius = tilesToPixels(4);\r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          \r\n          for (const enemy of enemies) {\r\n            const dist = Vec2.distance(player.position, enemy.position);\r\n            if (dist <= radius) {\r\n              // Remove cloak effects\r\n              this.effectSystem.removeEffectsByType(enemy.id, EffectType.Cloak);\r\n              // Apply revealed\r\n              this.effectSystem.applyEffect(\r\n                EffectType.Revealed,\r\n                player.id,\r\n                enemy.id,\r\n                2000,\r\n                100\r\n              );\r\n            }\r\n          }\r\n          \r\n          result.effectsApplied.push('revealed');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.Shockwave,\r\n            position: player.position,\r\n            radius,\r\n            duration: 300,\r\n            color: '#ff8800'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 3: // Ultimate: Thermal Overdrive - massive fire wave\r\n        {\r\n          const radius = tilesToPixels(5);\r\n          const damage = 60;\r\n          \r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          const hitTargets: EntityId[] = [];\r\n          \r\n          for (const enemy of enemies) {\r\n            const dist = Vec2.distance(player.position, enemy.position);\r\n            if (dist <= radius) {\r\n              // Apply burn DoT\r\n              this.effectSystem.applyEffect(\r\n                EffectType.Burn,\r\n                player.id,\r\n                enemy.id,\r\n                3000,\r\n                10,\r\n                500 // tick every 500ms\r\n              );\r\n              hitTargets.push(enemy.id);\r\n            }\r\n          }\r\n          \r\n          result.damage = damage;\r\n          result.targetIds = hitTargets;\r\n          result.effectsApplied.push('burn');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.Explosion,\r\n            position: player.position,\r\n            radius,\r\n            duration: 800,\r\n            color: '#ff4400'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // CIPHER (Byte) - Tech\r\n  // Passive: Hack faster | Q: Disable abilities | E: Deploy turret\r\n  // -------------------------------------------------------------------------\r\n\r\n  private executeCipherAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    const result: AbilityResult = { success: false, effectsApplied: [], visualEffects: [] };\r\n\r\n    switch (abilityIndex) {\r\n      case 0: // Passive: Hack 50% faster - handled in interaction system\r\n        break;\r\n\r\n      case 1: // Q: EMP Pulse - disable + slow enemies in area\r\n        {\r\n          const radius = tilesToPixels(4);\r\n          const duration = 1500;\r\n          \r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          const hitTargets: EntityId[] = [];\r\n          \r\n          for (const enemy of enemies) {\r\n            const dist = Vec2.distance(player.position, enemy.position);\r\n            if (dist <= radius) {\r\n              // Silence (can't use abilities)\r\n              this.effectSystem.applyEffect(\r\n                EffectType.Silence,\r\n                player.id,\r\n                enemy.id,\r\n                duration,\r\n                100\r\n              );\r\n              // Slow\r\n              this.effectSystem.applyEffect(\r\n                EffectType.Slow,\r\n                player.id,\r\n                enemy.id,\r\n                duration,\r\n                30 // 30% slow\r\n              );\r\n              hitTargets.push(enemy.id);\r\n            }\r\n          }\r\n          \r\n          result.targetIds = hitTargets;\r\n          result.effectsApplied.push('silence', 'slow');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.Shockwave,\r\n            position: player.position,\r\n            radius,\r\n            duration: 400,\r\n            color: '#00ffff'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 2: // F: Hack Trap - slowing data field\r\n        {\r\n          const direction = Vec2.fromAngle(player.rotation);\r\n          const trapPos = Vec2.add(player.position, Vec2.mul(direction, 60));\r\n          \r\n          const radius = tilesToPixels(2);\r\n          const duration = 5000;\r\n          \r\n          this.effectSystem.createZone(\r\n            EffectType.Slow,\r\n            player.id,\r\n            trapPos,\r\n            radius,\r\n            duration,\r\n            500,\r\n            40, // 40% slow\r\n            false,\r\n            true,\r\n            ZoneVisualType.SlowField\r\n          );\r\n          \r\n          result.zones = [{\r\n            id: generateId('zone'),\r\n            type: ZoneVisualType.SlowField,\r\n            position: trapPos,\r\n            radius,\r\n            duration\r\n          }];\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.TurretSpawn,\r\n            position: trapPos,\r\n            duration: 300,\r\n            color: '#00aaff'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 3: // Ultimate: Deploy Turret - automated turret for 10s\r\n        {\r\n          const direction = Vec2.fromAngle(player.rotation);\r\n          const turretPos = Vec2.add(player.position, Vec2.mul(direction, 50));\r\n          \r\n          const turret: Turret = {\r\n            id: generateId('turret'),\r\n            ownerId: player.id,\r\n            ownerTeam: player.team,\r\n            position: turretPos,\r\n            rotation: player.rotation,\r\n            health: 100,\r\n            maxHealth: 100,\r\n            range: ABILITY_RANGES.TURRET_RANGE,\r\n            damage: 20,\r\n            fireRate: 1000, // 1 shot per second\r\n            lastFireTime: 0,\r\n            spawnTime: this.getTime(),\r\n            duration: 10000,\r\n            targetId: null,\r\n          };\r\n          \r\n          this.turrets.set(turret.id, turret);\r\n          \r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.TurretSpawn,\r\n            position: turretPos,\r\n            duration: 500\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // VENOM (Glyph) - Saboteur\r\n  // Passive: Poison on melee | Q: Toxic cloud | E: Plague (chain poison)\r\n  // -------------------------------------------------------------------------\r\n\r\n  private executeVenomAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    const result: AbilityResult = { success: false, effectsApplied: [], visualEffects: [] };\r\n\r\n    switch (abilityIndex) {\r\n      case 0: // Passive: Poison on melee - handled in melee damage\r\n        break;\r\n\r\n      case 1: // Q: Shock Drone (repurposed as Toxic Spit - ranged poison)\r\n        {\r\n          const range = ABILITY_RANGES.MEDIUM;\r\n          const direction = Vec2.fromAngle(player.rotation);\r\n          \r\n          // Find first enemy in line\r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          let target: Player | null = null;\r\n          \r\n          for (const enemy of enemies) {\r\n            const toEnemy = Vec2.sub(enemy.position, player.position);\r\n            const dist = Vec2.length(toEnemy);\r\n            if (dist > range) continue;\r\n            \r\n            const dot = Vec2.dot(Vec2.normalize(toEnemy), direction);\r\n            if (dot > 0.9) { // Within ~25 degree cone\r\n              target = enemy;\r\n              break;\r\n            }\r\n          }\r\n          \r\n          if (target) {\r\n            this.effectSystem.applyEffect(\r\n              EffectType.Poison,\r\n              player.id,\r\n              target.id,\r\n              3000,\r\n              8, // 8 damage per tick\r\n              500\r\n            );\r\n            result.targetIds = [target.id];\r\n            result.effectsApplied.push('poison');\r\n          }\r\n          \r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.DashSlash,\r\n            position: player.position,\r\n            direction: player.rotation,\r\n            duration: 300,\r\n            color: '#00ff00'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 2: // F: Toxic Cloud - poison zone\r\n        {\r\n          const direction = Vec2.fromAngle(player.rotation);\r\n          const cloudPos = Vec2.add(player.position, Vec2.mul(direction, ABILITY_RANGES.SHORT));\r\n          \r\n          const radius = ABILITY_RANGES.POISON_CLOUD;\r\n          const duration = 5000;\r\n          \r\n          this.effectSystem.createZone(\r\n            EffectType.Poison,\r\n            player.id,\r\n            cloudPos,\r\n            radius,\r\n            duration,\r\n            500,\r\n            15, // damage per tick\r\n            false,\r\n            true,\r\n            ZoneVisualType.PoisonCloud\r\n          );\r\n          \r\n          result.zones = [{\r\n            id: generateId('zone'),\r\n            type: ZoneVisualType.PoisonCloud,\r\n            position: cloudPos,\r\n            radius,\r\n            duration\r\n          }];\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.PoisonCloud,\r\n            position: cloudPos,\r\n            radius,\r\n            duration,\r\n            color: '#44ff44'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 3: // Ultimate: Nano Swarm / Plague - chain poison\r\n        {\r\n          const range = ABILITY_RANGES.MEDIUM;\r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          \r\n          // Find closest enemy to start the chain\r\n          let firstTarget: Player | null = null;\r\n          let closestDist = range;\r\n          \r\n          for (const enemy of enemies) {\r\n            const dist = Vec2.distance(player.position, enemy.position);\r\n            if (dist < closestDist) {\r\n              closestDist = dist;\r\n              firstTarget = enemy;\r\n            }\r\n          }\r\n          \r\n          if (firstTarget) {\r\n            // Apply strong poison to first target\r\n            this.effectSystem.applyEffect(\r\n              EffectType.Poison,\r\n              player.id,\r\n              firstTarget.id,\r\n              6000,\r\n              10,\r\n              500\r\n            );\r\n            \r\n            // Chain to nearby enemies\r\n            const chainRadius = tilesToPixels(2);\r\n            const infected: EntityId[] = [firstTarget.id];\r\n            \r\n            for (const enemy of enemies) {\r\n              if (enemy.id === firstTarget.id) continue;\r\n              const dist = Vec2.distance(firstTarget.position, enemy.position);\r\n              if (dist <= chainRadius && infected.length < 4) {\r\n                this.effectSystem.applyEffect(\r\n                  EffectType.Poison,\r\n                  player.id,\r\n                  enemy.id,\r\n                  6000,\r\n                  8,\r\n                  500\r\n                );\r\n                infected.push(enemy.id);\r\n              }\r\n            }\r\n            \r\n            result.targetIds = infected;\r\n            result.effectsApplied.push('poison');\r\n            result.visualEffects!.push({\r\n              type: VisualEffectType.PoisonCloud,\r\n              position: firstTarget.position,\r\n              radius: chainRadius,\r\n              duration: 1000,\r\n              color: '#00ff00'\r\n            });\r\n            result.success = true;\r\n          }\r\n        }\r\n        break;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // AEGIS (Zero) - Guardian\r\n  // Passive: Shield ally on spawn | Q: Barrier wall | E: Dome shield\r\n  // -------------------------------------------------------------------------\r\n\r\n  private executeAegisAbility(player: Player, abilityIndex: number): AbilityResult {\r\n    const result: AbilityResult = { success: false, effectsApplied: [], visualEffects: [] };\r\n\r\n    switch (abilityIndex) {\r\n      case 0: // Passive: Nearest ally gets +25 shield on spawn - handled in spawn\r\n        break;\r\n\r\n      case 1: // Q: Mark Target - tag for bonus damage\r\n        {\r\n          // Very long range for a sniper ability\r\n          const range = ABILITY_RANGES.VERY_LONG * 2; // ~768 pixels - very far\r\n          const direction = Vec2.fromAngle(player.rotation);\r\n          \r\n          console.log(`[Zero] Mark Target activated - scanning for enemies...`);\r\n          \r\n          // Find enemy in aim direction (very forgiving targeting)\r\n          const enemies = this.getEnemies(player.team).filter(e => e.alive);\r\n          let target: Player | null = null;\r\n          let bestDot = 0.5; // Minimum dot product (about 60 degrees cone - very forgiving)\r\n          let closestDist = Infinity;\r\n          \r\n          console.log(`[Zero] Found ${enemies.length} alive enemies to check`);\r\n          \r\n          for (const enemy of enemies) {\r\n            const toEnemy = Vec2.sub(enemy.position, player.position);\r\n            const dist = Vec2.length(toEnemy);\r\n            \r\n            if (dist > range) {\r\n              console.log(`[Zero] Enemy ${enemy.name} too far: ${dist.toFixed(0)} > ${range}`);\r\n              continue;\r\n            }\r\n            \r\n            const normalizedToEnemy = Vec2.normalize(toEnemy);\r\n            const dot = Vec2.dot(normalizedToEnemy, direction);\r\n            \r\n            console.log(`[Zero] Enemy ${enemy.name}: dist=${dist.toFixed(0)}, dot=${dot.toFixed(2)} (need >${bestDot})`);\r\n            \r\n            // Find the closest target within cone\r\n            if (dot > bestDot && dist < closestDist) {\r\n              closestDist = dist;\r\n              target = enemy;\r\n            }\r\n          }\r\n          \r\n          if (target) {\r\n            this.effectSystem.applyEffect(\r\n              EffectType.Marked,\r\n              player.id,\r\n              target.id,\r\n              5000,\r\n              20 // 20% bonus damage\r\n            );\r\n            result.targetIds = [target.id];\r\n            result.effectsApplied.push('marked');\r\n            \r\n            console.log(`[Zero]  MARKED: ${target.name} for 5 seconds (+20% damage)`);\r\n          } else {\r\n            console.log(`[Zero]  No target found. Make sure you're aiming at an enemy within range.`);\r\n          }\r\n          \r\n          result.success = true;\r\n        }\r\n        break;\r\n\r\n      case 2: // F: Dash Back - quick backward escape\r\n        {\r\n          const dashDistance = ABILITY_RANGES.BLINK; // Same distance as blink\r\n          // Dash BACKWARD (opposite of facing direction)\r\n          const backwardDirection = Vec2.fromAngle(player.rotation + Math.PI);\r\n          const targetPos = Vec2.add(player.position, Vec2.mul(backwardDirection, dashDistance));\r\n          \r\n          // Check for wall collision along the path\r\n          const hit = this.raycast(player.position, backwardDirection, dashDistance, [player.id]);\r\n          const finalPos = hit ? Vec2.sub(hit.point, Vec2.mul(backwardDirection, 20)) : targetPos;\r\n          \r\n          result.teleportTo = finalPos;\r\n          result.visualEffects!.push(\r\n            { type: VisualEffectType.Blink, position: player.position, duration: 300 },\r\n            { type: VisualEffectType.BlinkTrail, position: player.position, targetPosition: finalPos, duration: 200 }\r\n          );\r\n          result.success = true;\r\n          console.log(`[Zero] Dash Back executed`);\r\n        }\r\n        break;\r\n\r\n      case 3: // Ultimate: Dome Shield - protective dome for team\r\n        {\r\n          const radius = ABILITY_RANGES.DOME_SHIELD;\r\n          const duration = 5000;\r\n          \r\n          // Apply damage reduction to all allies in dome\r\n          const allies = this.getAllies(player.team);\r\n          for (const ally of allies) {\r\n            const dist = Vec2.distance(player.position, ally.position);\r\n            if (dist <= radius) {\r\n              this.effectSystem.applyEffect(\r\n                EffectType.DamageReduction,\r\n                player.id,\r\n                ally.id,\r\n                duration,\r\n                70 // 70% damage reduction\r\n              );\r\n            }\r\n          }\r\n          \r\n          // Also protect self\r\n          this.effectSystem.applyEffect(\r\n            EffectType.DamageReduction,\r\n            player.id,\r\n            player.id,\r\n            duration,\r\n            70\r\n          );\r\n          \r\n          result.effectsApplied.push('damage_reduction');\r\n          result.visualEffects!.push({\r\n            type: VisualEffectType.DomeShield,\r\n            position: player.position,\r\n            radius,\r\n            duration,\r\n            color: '#4488ff'\r\n          });\r\n          result.success = true;\r\n        }\r\n        break;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // TURRET UPDATE\r\n  // -------------------------------------------------------------------------\r\n\r\n  updateTurrets(_dt: number): Array<{ turretId: string; targetId: EntityId; damage: number; position: Vector2 }> {\r\n    const shots: Array<{ turretId: string; targetId: EntityId; damage: number; position: Vector2 }> = [];\r\n    const now = this.getTime();\r\n\r\n    for (const [id, turret] of this.turrets) {\r\n      // Check expiration\r\n      if (now >= turret.spawnTime + turret.duration) {\r\n        this.turrets.delete(id);\r\n        continue;\r\n      }\r\n\r\n      // Find target\r\n      const enemies = this.getEnemies(turret.ownerTeam).filter(e => e.alive);\r\n      let target: Player | null = null;\r\n      let closestDist = turret.range;\r\n\r\n      for (const enemy of enemies) {\r\n        const dist = Vec2.distance(turret.position, enemy.position);\r\n        if (dist < closestDist) {\r\n          closestDist = dist;\r\n          target = enemy;\r\n        }\r\n      }\r\n\r\n      if (target) {\r\n        turret.targetId = target.id;\r\n        turret.rotation = Vec2.angle(Vec2.sub(target.position, turret.position));\r\n\r\n        // Fire if ready\r\n        if (now >= turret.lastFireTime + turret.fireRate) {\r\n          turret.lastFireTime = now;\r\n          shots.push({\r\n            turretId: id,\r\n            targetId: target.id,\r\n            damage: turret.damage,\r\n            position: turret.position,\r\n          });\r\n        }\r\n      } else {\r\n        turret.targetId = null;\r\n      }\r\n    }\r\n\r\n    return shots;\r\n  }\r\n\r\n  getTurrets(): Turret[] {\r\n    return Array.from(this.turrets.values());\r\n  }\r\n\r\n  clearTurrets(): void {\r\n    this.turrets.clear();\r\n  }\r\n\r\n  damageTurret(turretId: string, damage: number): boolean {\r\n    const turret = this.turrets.get(turretId);\r\n    if (!turret) return false;\r\n\r\n    turret.health -= damage;\r\n    if (turret.health <= 0) {\r\n      this.turrets.delete(turretId);\r\n      return true; // Destroyed\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // MINIGUN MODE\r\n  // -------------------------------------------------------------------------\r\n\r\n  isInMinigunMode(playerId: EntityId): boolean {\r\n    const endTime = this.activeMiniguns.get(playerId);\r\n    if (!endTime) return false;\r\n    return this.getTime() < endTime;\r\n  }\r\n\r\n  activateMinigunMode(playerId: EntityId, duration: number): void {\r\n    this.activeMiniguns.set(playerId, this.getTime() + duration);\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // CLEANUP\r\n  // -------------------------------------------------------------------------\r\n\r\n  clear(): void {\r\n    this.turrets.clear();\r\n    this.activeMiniguns.clear();\r\n  }\r\n}\r\n","// ============================================================================\r\n// GAME WORLD - Main Game State Container\r\n// ============================================================================\r\n\r\nimport {\r\n  EntityId,\r\n  GamePhase,\r\n  GameMode,\r\n  GameState,\r\n  ObjectiveState,\r\n  PlayerInput,\r\n  Team,\r\n  HeroId,\r\n  WeaponId,\r\n  GameEventType,\r\n} from '@/shared/types';\r\nimport { WEAPONS, GAMEPLAY, HEROES } from '@/shared/constants';\r\nimport { Vec2, randomRange } from '@/shared/utils';\r\nimport { CollisionWorld, CollisionLayers } from '@/engine/CollisionSystem';\r\nimport { Player } from './entities/Player';\r\nimport { Projectile } from './entities/Projectile';\r\nimport { GameMap, getMapById } from './map/GameMap';\r\nimport { BotControllerFactory, IBotController } from './ai/BotControllerFactory';\r\nimport { EffectSystem, EffectType, ZoneEffect } from './systems/EffectSystem';\r\nimport { AbilitySystem, VisualEffectType, Turret } from './systems/AbilitySystem';\r\n\r\nexport interface GameWorldConfig {\r\n  mode: GameMode;\r\n  maxPlayers: number;\r\n  isHost: boolean;\r\n  mapId?: string;  // Map to load (defaults to neon_arena)\r\n  abilityQSlot?: 1 | 2;  // Which ability (1 or 2) is mapped to Q key input\r\n  abilityFSlot?: 1 | 2;  // Which ability (1 or 2) is mapped to F key input\r\n  totalRounds?: number;  // Best of X rounds (3, 5, 7, 9, 13)\r\n}\r\n\r\nexport class GameWorld {\r\n  // Config\r\n  private config: GameWorldConfig;\r\n  private isHost: boolean;\r\n  private abilityQSlot: 1 | 2 = 1;  // Which ability index Q key triggers\r\n  private abilityFSlot: 1 | 2 = 2;  // Which ability index F key triggers\r\n  private totalRounds: number = 5;  // Best of X\r\n  private roundsToWin: number = 3;  // First to X wins\r\n\r\n  // State\r\n  private phase: GamePhase = GamePhase.Lobby;\r\n  private tick = 0;\r\n  private time = 0;\r\n  private roundNumber = 0;\r\n  private roundStartTime = 0;\r\n  private attackerScore = 0;\r\n  private defenderScore = 0;\r\n\r\n  // Entities\r\n  private players = new Map<EntityId, Player>();\r\n  private playersByPeerId = new Map<string, Player>();\r\n  private projectiles = new Map<EntityId, Projectile>();\r\n\r\n  // Systems\r\n  private collisionWorld: CollisionWorld;\r\n  private map: GameMap;\r\n\r\n  // Objectives\r\n  private objectives: ObjectiveState;\r\n\r\n  // Events (for broadcasting)\r\n  private pendingEvents: Array<{ type: GameEventType; data: unknown }> = [];\r\n\r\n  // Recent shots for visual effects (hitscan tracers)\r\n  private recentShots: Array<{ \r\n    start: { x: number; y: number }; \r\n    end: { x: number; y: number };\r\n    shooterId: EntityId;\r\n    shooterPeerId: string;\r\n  }> = [];\r\n\r\n  // Active ability effects for visualization\r\n  private abilityEffects: Array<{\r\n    type: 'shield' | 'shockwave' | 'dash' | 'cloak';\r\n    playerId: EntityId;\r\n    position: { x: number; y: number };\r\n    direction: number;\r\n    startTime: number;\r\n    duration: number;\r\n    radius?: number;\r\n  }> = [];\r\n\r\n  // Local player reference\r\n  private localPlayerId: EntityId | null = null;\r\n\r\n  // Bot AI controllers (uses IBotController for switchable AI modes)\r\n  private bots = new Map<EntityId, IBotController>();\r\n\r\n  // Round countdown system\r\n  private countdownTime: number = 10000; // 10 seconds between rounds\r\n  private countdownPaused: boolean = false;\r\n  private countdownPausedBy: string = '';\r\n  private countdownDuration: number = 10000; // Default countdown duration\r\n\r\n  // Game pause state (tab focus sync)\r\n  private gamePaused: boolean = false;\r\n  private gamePausedBy: string = '';\r\n  private pausedPlayerPeerIds: Set<string> = new Set();\r\n\r\n  // Disconnect forfeit state\r\n  private disconnectForfeit: boolean = false;\r\n  private disconnectedPlayerName: string = '';\r\n\r\n  // Effect and Ability Systems\r\n  private effectSystem: EffectSystem;\r\n  private abilitySystem: AbilitySystem;\r\n\r\n  // Visual effect queue for rendering\r\n  private visualEffectQueue: Array<{\r\n    type: VisualEffectType;\r\n    position: { x: number; y: number };\r\n    direction?: number;\r\n    radius?: number;\r\n    duration: number;\r\n    color?: string;\r\n    targetPosition?: { x: number; y: number };\r\n    startTime: number;\r\n    followPlayerId?: string; // If set, effect follows this player's position/rotation\r\n  }> = [];\r\n\r\n  constructor(config: GameWorldConfig) {\r\n    this.config = config;\r\n    this.isHost = config.isHost;\r\n    this.abilityQSlot = config.abilityQSlot ?? 1;\r\n    this.abilityFSlot = config.abilityFSlot ?? 2;\r\n    this.totalRounds = config.totalRounds ?? 5;\r\n    this.roundsToWin = Math.ceil(this.totalRounds / 2);  // e.g., 5 -> 3, 7 -> 4\r\n\r\n    // Initialize systems\r\n    this.collisionWorld = new CollisionWorld(128);\r\n    \r\n    // Load map by ID (fallback to neon_arena)\r\n    this.map = getMapById(config.mapId || 'neon_arena');\r\n    this.map.registerCollision(this.collisionWorld);\r\n\r\n    // Initialize Effect System with callbacks\r\n    this.effectSystem = new EffectSystem({\r\n      onEffectApplied: (effect) => {\r\n        console.log(`[EffectSystem] Applied ${effect.type} to ${effect.targetId}`);\r\n      },\r\n      onEffectRemoved: (effect) => {\r\n        console.log(`[EffectSystem] Removed ${effect.type} from ${effect.targetId}`);\r\n      },\r\n      onEffectTick: (effect, value) => {\r\n        // Handle DoT/HoT ticks\r\n        const target = this.players.get(effect.targetId);\r\n        if (!target || !target.alive) return;\r\n\r\n        switch (effect.type) {\r\n          case EffectType.Poison:\r\n          case EffectType.Burn:\r\n          case EffectType.Bleed:\r\n            target.takeDamage(value, effect.sourceId, this.time);\r\n            break;\r\n          case EffectType.Regen:\r\n            target.heal(value);\r\n            break;\r\n        }\r\n      },\r\n      onZoneTick: (zone, targetIds) => {\r\n        // Handle zone effects\r\n        for (const targetId of targetIds) {\r\n          const target = this.players.get(targetId);\r\n          if (!target || !target.alive) continue;\r\n\r\n          // Check team filtering\r\n          const source = this.players.get(zone.sourceId);\r\n          if (!source) continue;\r\n\r\n          const isAlly = target.team === source.team;\r\n          const isEnemy = target.team !== source.team;\r\n\r\n          if (zone.affectsAllies && isAlly) {\r\n            this.applyZoneEffect(zone, target);\r\n          }\r\n          if (zone.affectsEnemies && isEnemy) {\r\n            this.applyZoneEffect(zone, target);\r\n          }\r\n        }\r\n      },\r\n    });\r\n\r\n    // Initialize Ability System\r\n    this.abilitySystem = new AbilitySystem(this.effectSystem, {\r\n      getPlayer: (id) => this.players.get(id),\r\n      getPlayers: () => Array.from(this.players.values()),\r\n      getEnemies: (team) => this.getPlayers().filter(p => p.team !== team && p.alive),\r\n      getAllies: (team, excludeId) => this.getPlayers().filter(p => p.team === team && p.id !== excludeId),\r\n      getTime: () => this.time,\r\n      raycast: (start, direction, maxDist, _ignorePlayers) => {\r\n        const hit = this.collisionWorld.raycast(start, direction, maxDist, CollisionLayers.WALL);\r\n        return hit ? { point: hit.point, distance: Vec2.distance(start, hit.point) } : null;\r\n      },\r\n    });\r\n\r\n    // Initialize objectives\r\n    this.objectives = {\r\n      spikeCarrierId: null,\r\n      spikePlanted: false,\r\n      spikeSite: -1,\r\n      spikePlantTime: 0,\r\n      spikeProgress: 0,\r\n      spikePosition: null,\r\n      plantingPlayerId: null,\r\n      plantingPeerId: null,\r\n      plantingProgress: 0,\r\n      defusingPlayerId: null,\r\n      defusingPeerId: null,\r\n      defusingProgress: 0,\r\n      reactorPosition: { x: 0, y: 0 },\r\n      reactorProgress: 0,\r\n      reactorContested: false,\r\n      reactorPushers: 0,\r\n    };\r\n  }\r\n\r\n  private applyZoneEffect(zone: ZoneEffect, target: Player): void {\r\n    switch (zone.type) {\r\n      case EffectType.Poison:\r\n        target.takeDamage(zone.value, zone.sourceId, this.time, 'poison');\r\n        break;\r\n      case EffectType.Burn:\r\n        // Pass 'fire' damage type for fire immunity check\r\n        target.takeDamage(zone.value, zone.sourceId, this.time, 'fire');\r\n        break;\r\n      case EffectType.Regen:\r\n        target.heal(zone.value);\r\n        break;\r\n      case EffectType.Slow:\r\n        this.effectSystem.applyEffect(\r\n          EffectType.Slow,\r\n          zone.sourceId,\r\n          target.id,\r\n          500, // Short duration, refreshed by zone\r\n          zone.value\r\n        );\r\n        break;\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Player Management\r\n  // -------------------------------------------------------------------------\r\n\r\n  addPlayer(peerId: string, name: string, team: Team, heroId: HeroId): Player {\r\n    // Check if player already exists with this peerId\r\n    const existingPlayer = this.playersByPeerId.get(peerId);\r\n    if (existingPlayer) {\r\n      console.log(`[GameWorld] Player with peerId ${peerId} already exists, returning existing`);\r\n      return existingPlayer;\r\n    }\r\n    \r\n    const spawnIndex = this.getTeamPlayerCount(team);\r\n    const spawnPos = this.map.getSpawnPoint(team, spawnIndex);\r\n\r\n    const player = new Player(peerId, name, team, heroId, spawnPos);\r\n    this.players.set(player.id, player);\r\n    this.playersByPeerId.set(peerId, player);\r\n    this.collisionWorld.addBody(player.getCollisionBody());\r\n    \r\n    console.log(`[GameWorld] Added player: ${name} (${peerId}) to team ${team}`);\r\n\r\n    return player;\r\n  }\r\n\r\n  removePlayer(playerId: EntityId): void {\r\n    const player = this.players.get(playerId);\r\n    if (player) {\r\n      this.collisionWorld.removeBody(playerId);\r\n      this.playersByPeerId.delete(player.peerId);\r\n      this.players.delete(playerId);\r\n      this.bots.delete(playerId);\r\n    }\r\n  }\r\n\r\n  getPlayer(playerId: EntityId): Player | undefined {\r\n    return this.players.get(playerId);\r\n  }\r\n\r\n  getPlayerByPeerId(peerId: string): Player | undefined {\r\n    return this.playersByPeerId.get(peerId);\r\n  }\r\n  \r\n  getPlayerByName(name: string): Player | undefined {\r\n    for (const player of this.players.values()) {\r\n      if (player.name === name) {\r\n        return player;\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n  \r\n  // Update a player's peerId (used when network connects after player creation)\r\n  updatePlayerPeerId(oldPeerId: string, newPeerId: string): void {\r\n    const player = this.playersByPeerId.get(oldPeerId);\r\n    if (player) {\r\n      this.playersByPeerId.delete(oldPeerId);\r\n      player.peerId = newPeerId;\r\n      this.playersByPeerId.set(newPeerId, player);\r\n      console.log(`[GameWorld] Updated player peerId: ${oldPeerId} -> ${newPeerId}`);\r\n    }\r\n  }\r\n\r\n  getPlayers(): Player[] {\r\n    return Array.from(this.players.values());\r\n  }\r\n\r\n  getTeamPlayers(team: Team): Player[] {\r\n    return this.getPlayers().filter(p => p.team === team);\r\n  }\r\n\r\n  getTeamPlayerCount(team: Team): number {\r\n    return this.getTeamPlayers(team).length;\r\n  }\r\n\r\n  setLocalPlayer(playerId: EntityId): void {\r\n    this.localPlayerId = playerId;\r\n  }\r\n\r\n  getLocalPlayer(): Player | undefined {\r\n    return this.localPlayerId ? this.players.get(this.localPlayerId) : undefined;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Bot Management\r\n  // -------------------------------------------------------------------------\r\n\r\n  addBot(team: Team, heroId: HeroId = HeroId.Vanta, difficulty: 'easy' | 'medium' | 'hard' = 'medium'): Player {\r\n    const botIndex = this.bots.size;\r\n    const player = this.addPlayer(\r\n      `bot_${botIndex}`,\r\n      `Bot ${botIndex + 1}`,\r\n      team,\r\n      heroId\r\n    );\r\n    \r\n    // Configure AI based on difficulty\r\n    const difficultySettings = this.getDifficultySettings(difficulty);\r\n    \r\n    // Create AI controller for this bot (using factory for switchable AI modes)\r\n    const botController = BotControllerFactory.create(player, {\r\n      aggressionLevel: difficultySettings.aggressionLevel + Math.random() * 0.1,\r\n      accuracy: difficultySettings.accuracy + Math.random() * 0.1,\r\n      reactionTime: difficultySettings.reactionTime + Math.random() * 50,\r\n    });\r\n    this.bots.set(player.id, botController);\r\n    \r\n    return player;\r\n  }\r\n\r\n  private getDifficultySettings(difficulty: 'easy' | 'medium' | 'hard'): { aggressionLevel: number; accuracy: number; reactionTime: number } {\r\n    switch (difficulty) {\r\n      case 'easy':\r\n        return { aggressionLevel: 0.3, accuracy: 0.2, reactionTime: 400 };\r\n      case 'medium':\r\n        return { aggressionLevel: 0.5, accuracy: 0.5, reactionTime: 250 };\r\n      case 'hard':\r\n        return { aggressionLevel: 0.8, accuracy: 0.8, reactionTime: 100 };\r\n      default:\r\n        return { aggressionLevel: 0.5, accuracy: 0.5, reactionTime: 250 };\r\n    }\r\n  }\r\n\r\n  spawnBots(count: number, team: Team, difficulty: 'easy' | 'medium' | 'hard' = 'medium'): void {\r\n    // Available weapons for bots (excluding pistol which they start with)\r\n    const botWeapons = [WeaponId.NeoSMG9, WeaponId.PulseRifle, WeaponId.ScatterShot, WeaponId.RailSniper];\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n      const bot = this.addBot(team, HeroId.Vanta, difficulty);\r\n      \r\n      // Give each bot a random weapon\r\n      const randomWeapon = botWeapons[Math.floor(Math.random() * botWeapons.length)]!;\r\n      bot.buyWeapon(randomWeapon);\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Game Flow\r\n  // -------------------------------------------------------------------------\r\n\r\n  startRound(): void {\r\n    this.phase = GamePhase.RoundActive;\r\n    this.roundNumber++;\r\n    this.roundStartTime = this.time;\r\n\r\n    // Reset players\r\n    for (const player of this.players.values()) {\r\n      const spawnIndex = this.getTeamPlayers(player.team).indexOf(player);\r\n      const spawnPos = this.map.getSpawnPoint(player.team, spawnIndex);\r\n      \r\n      // Check if player was dead (collision body removed)\r\n      const wasDead = !player.alive;\r\n      \r\n      player.respawn(spawnPos);\r\n      player.resetAbilities(); // Reset all ability cooldowns for new round\r\n      \r\n      // Re-add collision body if it was removed on death\r\n      if (wasDead) {\r\n        this.collisionWorld.addBody(player.getCollisionBody());\r\n      } else {\r\n        this.collisionWorld.updateBody(player.id, player.position, player.velocity);\r\n      }\r\n    }\r\n\r\n    // Clear projectiles\r\n    this.projectiles.clear();\r\n\r\n    // Clear ability effects and visual effects from previous round\r\n    this.abilityEffects = [];\r\n    this.visualEffectQueue = [];\r\n\r\n    // Clear turrets from ability system\r\n    this.abilitySystem.clearTurrets();\r\n\r\n    // Clear all status effects from previous round\r\n    this.effectSystem.clear();\r\n\r\n    // Reset objectives\r\n    this.objectives = {\r\n      spikeCarrierId: null,\r\n      spikePlanted: false,\r\n      spikeSite: -1,\r\n      spikePlantTime: 0,\r\n      spikeProgress: 0,\r\n      spikePosition: null,\r\n      plantingPlayerId: null,\r\n      plantingPeerId: null,\r\n      plantingProgress: 0,\r\n      defusingPlayerId: null,\r\n      defusingPeerId: null,\r\n      defusingProgress: 0,\r\n      reactorPosition: { x: 0, y: 0 },\r\n      reactorProgress: 0,\r\n      reactorContested: false,\r\n      reactorPushers: 0,\r\n    };\r\n\r\n    // Give spike to random attacker (for Data Spike mode)\r\n    // Prefer human players over bots\r\n    if (this.config.mode === GameMode.DataSpikeAssault) {\r\n      const attackers = this.getTeamPlayers(Team.Attackers);\r\n      // Filter to get only human players (not bots)\r\n      const humanAttackers = attackers.filter(p => !this.bots.has(p.id));\r\n      \r\n      if (humanAttackers.length > 0) {\r\n        // Give to random human player\r\n        const carrier = humanAttackers[Math.floor(Math.random() * humanAttackers.length)]!;\r\n        this.objectives.spikeCarrierId = carrier.id;\r\n        console.log(`[Spike] Spike carrier assigned to human: ${carrier.name}`);\r\n      } else if (attackers.length > 0) {\r\n        // No human attackers, give to a bot as fallback\r\n        const carrier = attackers[Math.floor(Math.random() * attackers.length)]!;\r\n        this.objectives.spikeCarrierId = carrier.id;\r\n        console.log(`[Spike] Spike carrier assigned to bot (no humans): ${carrier.name}`);\r\n      }\r\n    }\r\n  }\r\n\r\n  endRound(winningTeam: Team): void {\r\n    console.log(`[GameWorld] endRound called - Winner: ${winningTeam === Team.Attackers ? 'Attackers' : 'Defenders'}`);\r\n    \r\n    this.phase = GamePhase.RoundEnd;\r\n    \r\n    // Reset round timer so display shows 3:00 during countdown\r\n    this.roundStartTime = this.time;\r\n    \r\n    // Reset countdown for next round\r\n    this.countdownTime = this.countdownDuration;\r\n    this.countdownPaused = false;\r\n    this.countdownPausedBy = '';\r\n\r\n    if (winningTeam === Team.Attackers) {\r\n      this.attackerScore++;\r\n    } else if (winningTeam === Team.Defenders) {\r\n      this.defenderScore++;\r\n    }\r\n\r\n    // Check match end - use configured roundsToWin\r\n    if (this.attackerScore >= this.roundsToWin || this.defenderScore >= this.roundsToWin) {\r\n      this.phase = GamePhase.MatchEnd;\r\n      console.log(`[GameWorld] MATCH ENDED! Final Score: Attackers ${this.attackerScore} - Defenders ${this.defenderScore}`);\r\n    } else {\r\n      console.log(`[GameWorld] Round ended. Score: Attackers ${this.attackerScore} - Defenders ${this.defenderScore}. Countdown: ${this.countdownDuration/1000}s`);\r\n    }\r\n  }\r\n\r\n  // End match due to player disconnect (forfeit)\r\n  endMatchByDisconnect(disconnectedTeam: Team, disconnectedPlayerName: string): void {\r\n    console.log(`[GameWorld] Player ${disconnectedPlayerName} disconnected - ${disconnectedTeam === Team.Attackers ? 'Attackers' : 'Defenders'} forfeit`);\r\n    \r\n    // Set winning score for the remaining team\r\n    if (disconnectedTeam === Team.Attackers) {\r\n      this.defenderScore = this.roundsToWin;\r\n    } else {\r\n      this.attackerScore = this.roundsToWin;\r\n    }\r\n    \r\n    this.phase = GamePhase.MatchEnd;\r\n    this.disconnectForfeit = true;\r\n    this.disconnectedPlayerName = disconnectedPlayerName;\r\n    \r\n    console.log(`[GameWorld] MATCH ENDED BY DISCONNECT! ${disconnectedPlayerName} forfeited. Final Score: Attackers ${this.attackerScore} - Defenders ${this.defenderScore}`);\r\n  }\r\n\r\n  isDisconnectForfeit(): boolean {\r\n    return this.disconnectForfeit;\r\n  }\r\n\r\n  getDisconnectedPlayerName(): string {\r\n    return this.disconnectedPlayerName;\r\n  }\r\n\r\n  // Set disconnect forfeit state from network sync (for clients)\r\n  setDisconnectForfeitState(isForfeit: boolean, playerName: string): void {\r\n    this.disconnectForfeit = isForfeit;\r\n    this.disconnectedPlayerName = playerName;\r\n  }\r\n\r\n  // Pause the countdown between rounds\r\n  pauseCountdown(playerName: string): void {\r\n    if (this.phase === GamePhase.RoundEnd && !this.countdownPaused) {\r\n      this.countdownPaused = true;\r\n      this.countdownPausedBy = playerName;\r\n      console.log(`[GameWorld] Countdown paused by ${playerName} at ${(this.countdownTime/1000).toFixed(1)}s`);\r\n    }\r\n  }\r\n\r\n  // Resume the countdown between rounds\r\n  resumeCountdown(playerName: string): void {\r\n    if (this.phase === GamePhase.RoundEnd && this.countdownPaused) {\r\n      this.countdownPaused = false;\r\n      this.countdownPausedBy = '';\r\n      console.log(`[GameWorld] Countdown resumed by ${playerName} at ${(this.countdownTime/1000).toFixed(1)}s`);\r\n    }\r\n  }\r\n\r\n  // Toggle pause state\r\n  toggleCountdownPause(playerName: string): void {\r\n    if (this.countdownPaused) {\r\n      this.resumeCountdown(playerName);\r\n    } else {\r\n      this.pauseCountdown(playerName);\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Game Pause (Tab Focus Sync)\r\n  // -------------------------------------------------------------------------\r\n\r\n  // Called when a player loses tab focus\r\n  playerLostFocus(peerId: string, playerName: string): void {\r\n    this.pausedPlayerPeerIds.add(peerId);\r\n    if (!this.gamePaused) {\r\n      this.gamePaused = true;\r\n      this.gamePausedBy = playerName;\r\n      console.log(`[GameWorld] Game paused - ${playerName} lost focus (${this.pausedPlayerPeerIds.size} players paused)`);\r\n    }\r\n  }\r\n\r\n  // Called when a player regains tab focus\r\n  playerRegainedFocus(peerId: string, playerName: string): void {\r\n    this.pausedPlayerPeerIds.delete(peerId);\r\n    console.log(`[GameWorld] ${playerName} regained focus (${this.pausedPlayerPeerIds.size} players still paused)`);\r\n    \r\n    // Resume only when all players are back\r\n    if (this.pausedPlayerPeerIds.size === 0 && this.gamePaused) {\r\n      this.gamePaused = false;\r\n      this.gamePausedBy = '';\r\n      console.log(`[GameWorld] Game resumed - all players have focus`);\r\n    }\r\n  }\r\n\r\n  isGamePaused(): boolean {\r\n    return this.gamePaused;\r\n  }\r\n\r\n  getGamePausedBy(): string {\r\n    return this.gamePausedBy;\r\n  }\r\n\r\n  getPausedPlayerCount(): number {\r\n    return this.pausedPlayerPeerIds.size;\r\n  }\r\n\r\n  // Set game pause state from network sync (for clients)\r\n  setGamePauseState(isPaused: boolean, pausedBy: string): void {\r\n    this.gamePaused = isPaused;\r\n    this.gamePausedBy = pausedBy;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Update Loop (Host Only)\r\n  // -------------------------------------------------------------------------\r\n\r\n  update(dt: number): void {\r\n    if (!this.isHost) return;\r\n\r\n    // Skip all updates when game is paused (tab focus)\r\n    if (this.gamePaused) {\r\n      return;\r\n    }\r\n\r\n    this.tick++;\r\n    \r\n    // Only increment game time during active round\r\n    if (this.phase === GamePhase.RoundActive) {\r\n      this.time += dt;\r\n    }\r\n\r\n    if (this.phase !== GamePhase.RoundActive) {\r\n      // Handle round end -> countdown to next round\r\n      if (this.phase === GamePhase.RoundEnd) {\r\n        // Only countdown if not paused\r\n        if (!this.countdownPaused) {\r\n          this.countdownTime -= dt;\r\n          \r\n          if (this.countdownTime <= 0) {\r\n            console.log(`[GameWorld] Countdown finished, starting next round`);\r\n            this.startRound();\r\n            return;\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Round not active - clear all player inputs and freeze positions\r\n      for (const player of this.players.values()) {\r\n        // Set zero input\r\n        player.setInput({\r\n          moveX: 0,\r\n          moveY: 0,\r\n          aimX: player.position.x,\r\n          aimY: player.position.y,\r\n          shoot: false,\r\n          reload: false,\r\n          ability1: false,\r\n          ability2: false,\r\n          ultimate: false,\r\n          interact: false,\r\n          weaponSlot: 0,\r\n          sequence: 0,\r\n        });\r\n        // Sync prevPosition to position to stop interpolation flickering\r\n        player.prevPosition.x = player.position.x;\r\n        player.prevPosition.y = player.position.y;\r\n        // Zero out velocity\r\n        player.velocity.x = 0;\r\n        player.velocity.y = 0;\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Update bot AI - generate inputs for bots\r\n    const allPlayers = this.getPlayers();\r\n    for (const [botId, botAI] of this.bots) {\r\n      const bot = this.players.get(botId);\r\n      if (bot && bot.alive) {\r\n        const context = {\r\n          dt,\r\n          time: this.time,\r\n          allPlayers,\r\n          collisionWorld: this.collisionWorld,\r\n          map: this.map,\r\n          objectives: this.objectives,\r\n        };\r\n        const input = botAI.update(context);\r\n        bot.setInput(input);\r\n      }\r\n    }\r\n\r\n    // Update players\r\n    for (const player of this.players.values()) {\r\n      player.update(dt, this.time);\r\n      this.collisionWorld.updateBody(player.id, player.position, player.velocity);\r\n    }\r\n    // Update projectiles\r\n    for (const [id, projectile] of this.projectiles) {\r\n      projectile.update(dt, this.time);\r\n      if (!projectile.active) {\r\n        this.projectiles.delete(id);\r\n        this.collisionWorld.removeBody(id);\r\n      } else {\r\n        this.collisionWorld.updateBody(id, projectile.position, projectile.velocity);\r\n      }\r\n    }\r\n\r\n    // Detect and resolve collisions (run multiple times to handle stacking and fast movement)\r\n    for (let i = 0; i < 4; i++) {\r\n      this.collisionWorld.detectCollisions();\r\n      this.collisionWorld.resolveCollisions();\r\n    }\r\n\r\n    // Process shooting\r\n    for (const player of this.players.values()) {\r\n      if (player.input.shoot && player.canFire(this.time)) {\r\n        this.processShot(player);\r\n        player.fire(this.time);\r\n      }\r\n    }\r\n\r\n    // Process abilities\r\n    this.processAbilities();\r\n\r\n    // Process spike planting/defusing (Data Spike mode)\r\n    if (this.config.mode === GameMode.DataSpikeAssault) {\r\n      this.processSpikeInteraction(dt);\r\n    }\r\n\r\n    // Check round end conditions\r\n    this.checkRoundEnd();\r\n\r\n    // Clamp players to map boundaries (safety net)\r\n    const mapWidth = this.map.getWidth();\r\n    const mapHeight = this.map.getHeight();\r\n    const tileSize = this.map.getTileSize();\r\n    const playerRadius = 16;\r\n    const minBound = tileSize + playerRadius;\r\n    const maxBoundX = mapWidth - tileSize - playerRadius;\r\n    const maxBoundY = mapHeight - tileSize - playerRadius;\r\n\r\n    for (const player of this.players.values()) {\r\n      // Clamp position to map bounds\r\n      player.position.x = Math.max(minBound, Math.min(maxBoundX, player.position.x));\r\n      player.position.y = Math.max(minBound, Math.min(maxBoundY, player.position.y));\r\n      \r\n      // Update collision body position (keep reference intact)\r\n      this.collisionWorld.updateBody(player.id, player.position, player.velocity);\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Client-Side Prediction (for local player only on clients)\r\n  // -------------------------------------------------------------------------\r\n\r\n  updateLocalPlayerOnly(dt: number): void {\r\n    const localPlayer = this.getLocalPlayer();\r\n    \r\n    if (this.phase !== GamePhase.RoundActive) return;\r\n\r\n    // Update local player's movement and weapon (if alive)\r\n    if (localPlayer && localPlayer.alive) {\r\n      localPlayer.update(dt, this.time);\r\n      \r\n      // Update collision body\r\n      this.collisionWorld.updateBody(localPlayer.id, localPlayer.position, localPlayer.velocity);\r\n      \r\n      // Run collision detection for local player against walls\r\n      // This prevents walking through walls on client-side prediction\r\n      this.collisionWorld.detectCollisions();\r\n      this.collisionWorld.resolveCollisions();\r\n      \r\n      // Clamp to map boundaries\r\n      const mapWidth = this.map.getWidth();\r\n      const mapHeight = this.map.getHeight();\r\n      const tileSize = this.map.getTileSize();\r\n      const playerRadius = 16;\r\n      const minBound = tileSize + playerRadius;\r\n      const maxBoundX = mapWidth - tileSize - playerRadius;\r\n      const maxBoundY = mapHeight - tileSize - playerRadius;\r\n      \r\n      localPlayer.position.x = Math.max(minBound, Math.min(maxBoundX, localPlayer.position.x));\r\n      localPlayer.position.y = Math.max(minBound, Math.min(maxBoundY, localPlayer.position.y));\r\n    }\r\n    \r\n    // Smoothly interpolate remote players towards their target positions\r\n    // This makes remote player movement look smooth even with 20Hz updates\r\n    const interpSpeed = 15; // Higher = faster snap to target\r\n    for (const player of this.players.values()) {\r\n      if (player.id === this.localPlayerId) continue;\r\n      \r\n      if (player.targetPosition) {\r\n        player.prevPosition = { ...player.position };\r\n        // Lerp towards target position\r\n        const t = 1 - Math.exp(-interpSpeed * dt / 1000);\r\n        player.position.x += (player.targetPosition.x - player.position.x) * t;\r\n        player.position.y += (player.targetPosition.y - player.position.y) * t;\r\n      }\r\n      if (player.targetRotation !== null) {\r\n        player.prevRotation = player.rotation;\r\n        // Lerp towards target rotation\r\n        const t = 1 - Math.exp(-interpSpeed * dt / 1000);\r\n        player.rotation += (player.targetRotation - player.rotation) * t;\r\n      }\r\n    }\r\n    \r\n    // Also update projectiles visually (interpolate between state updates)\r\n    // This makes bullets look smooth even if state only comes 20 times/sec\r\n    for (const projectile of this.projectiles.values()) {\r\n      projectile.update(dt, this.time);\r\n    }\r\n  }\r\n\r\n  private processShot(player: Player): void {\r\n    const weapon = WEAPONS[player.weapon.weaponId];\r\n    \r\n    // Calculate shot direction with spread\r\n    const baseAngle = player.rotation;\r\n    const spread = weapon.spread;\r\n    const pellets = weapon.id === WeaponId.ScatterShot ? weapon.burstCount : 1;\r\n\r\n    for (let i = 0; i < pellets; i++) {\r\n      const angle = baseAngle + randomRange(-spread, spread);\r\n      const direction = Vec2.fromAngle(angle);\r\n      const start = Vec2.add(player.position, Vec2.mul(direction, 20)); // Start slightly in front\r\n\r\n      // Hitscan\r\n      if (weapon.projectileSpeed === 0) {\r\n        const hit = this.collisionWorld.raycast(\r\n          start,\r\n          direction,\r\n          weapon.range,\r\n          CollisionLayers.PLAYER | CollisionLayers.ENEMY | CollisionLayers.WALL\r\n        );\r\n\r\n        // Calculate end point for tracer visualization\r\n        const endPoint = hit \r\n          ? hit.point \r\n          : Vec2.add(start, Vec2.mul(direction, weapon.range));\r\n        \r\n        // Record shot for visual tracer\r\n        this.recentShots.push({\r\n          start: { x: start.x, y: start.y },\r\n          end: { x: endPoint.x, y: endPoint.y },\r\n          shooterId: player.id,\r\n          shooterPeerId: player.peerId,\r\n        });\r\n\r\n        if (hit && hit.body.userData instanceof Player) {\r\n          const target = hit.body.userData;\r\n          if (target.id !== player.id && target.team !== player.team) {\r\n            // Calculate if headshot (top 30% of hitbox)\r\n            const isHeadshot = Math.random() < GAMEPLAY.HEADSHOT_ZONE_RATIO;\r\n            // Use player's effective damage (includes passive bonus)\r\n            const baseDamage = player.getEffectiveDamage();\r\n            const damage = isHeadshot \r\n              ? baseDamage * weapon.headshotMultiplier \r\n              : baseDamage;\r\n\r\n            target.takeDamage(damage, player.id, this.time);\r\n            \r\n            // Gain ultimate charge from damage (1 point per 25 damage)\r\n            const chargeGain = damage / 25;\r\n            player.ultimateCharge = Math.min(10, player.ultimateCharge + chargeGain);\r\n\r\n            // Record damage event\r\n            this.pendingEvents.push({\r\n              type: GameEventType.PlayerDamage,\r\n              data: {\r\n                targetId: target.id,\r\n                attackerId: player.id,\r\n                damage,\r\n                position: hit.point,\r\n                isHeadshot,\r\n              },\r\n            });\r\n\r\n            // Check for kill\r\n            if (!target.alive) {\r\n              player.kills++;\r\n              player.credits += GAMEPLAY.KILL_REWARD;\r\n              player.ultimateCharge = Math.min(10, player.ultimateCharge + 2); // Bonus charge for kill\r\n\r\n              // Remove dead player's collision body so bullets pass through\r\n              this.collisionWorld.removeBody(target.id);\r\n\r\n              this.pendingEvents.push({\r\n                type: GameEventType.PlayerKill,\r\n                data: {\r\n                  victimId: target.id,\r\n                  killerId: player.id,\r\n                  weaponId: player.weapon.weaponId,\r\n                  isHeadshot,\r\n                },\r\n              });\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        // Projectile-based weapon\r\n        const projectile = new Projectile(\r\n          player.id,\r\n          start,\r\n          direction,\r\n          weapon.projectileSpeed,\r\n          weapon.damage,\r\n          2000, // 2 second lifetime\r\n          this.time\r\n        );\r\n        this.projectiles.set(projectile.id, projectile);\r\n        this.collisionWorld.addBody(projectile.getCollisionBody());\r\n      }\r\n    }\r\n  }\r\n\r\n  private processAbilities(): void {\r\n    // Clean up expired ability effects (legacy)\r\n    this.abilityEffects = this.abilityEffects.filter(\r\n      effect => this.time < effect.startTime + effect.duration\r\n    );\r\n\r\n    // Clean up expired visual effects\r\n    this.visualEffectQueue = this.visualEffectQueue.filter(\r\n      effect => this.time < effect.startTime + effect.duration\r\n    );\r\n\r\n    // Update effect system\r\n    this.effectSystem.update(this.time, (pos, radius) => {\r\n      const nearby: EntityId[] = [];\r\n      for (const player of this.players.values()) {\r\n        if (Vec2.distance(player.position, pos) <= radius) {\r\n          nearby.push(player.id);\r\n        }\r\n      }\r\n      return nearby;\r\n    });\r\n\r\n    // Update turrets\r\n    const turretShots = this.abilitySystem.updateTurrets(16); // Assuming ~60fps\r\n    for (const shot of turretShots) {\r\n      const target = this.players.get(shot.targetId);\r\n      if (target && target.alive) {\r\n        target.takeDamage(shot.damage, shot.turretId as EntityId, this.time);\r\n      }\r\n    }\r\n\r\n    // Process player ability inputs\r\n    for (const player of this.players.values()) {\r\n      if (!player.alive) continue;\r\n\r\n      // Check if this is the local player (use ability slot mapping) or a bot (use default 1/2)\r\n      const isLocalPlayer = player.id === this.localPlayerId;\r\n      const qAbilityIndex = isLocalPlayer ? this.abilityQSlot : 1;\r\n      const fAbilityIndex = isLocalPlayer ? this.abilityFSlot : 2;\r\n\r\n      // Q key - mapped ability\r\n      if (player.input.ability1 && player.canUseAbility(qAbilityIndex, this.time)) {\r\n        console.log(`[Input] Q pressed (ability1) -> executing ability index ${qAbilityIndex}`);\r\n        this.executeAbilityNew(player, qAbilityIndex);\r\n      }\r\n\r\n      // F key - mapped ability  \r\n      if (player.input.ability2 && player.canUseAbility(fAbilityIndex, this.time)) {\r\n        console.log(`[Input] F pressed (ability2) -> executing ability index ${fAbilityIndex}`);\r\n        this.executeAbilityNew(player, fAbilityIndex);\r\n      }\r\n\r\n      // Ultimate (X key)\r\n      if (player.input.ultimate) {\r\n        const canUse = player.canUseAbility(3, this.time);\r\n        const heroDef = HEROES[player.heroId];\r\n        const ultCost = heroDef?.abilities[3]?.ultimateCost || 6;\r\n        console.log(`[Input] X pressed - ultimate charge: ${player.ultimateCharge.toFixed(1)}/${ultCost}, canUse: ${canUse}`);\r\n        if (canUse) {\r\n          this.executeAbilityNew(player, 3);\r\n        }\r\n      }\r\n\r\n      // Apply effect modifiers to player\r\n      this.applyEffectModifiers(player);\r\n    }\r\n  }\r\n\r\n  private executeAbilityNew(player: Player, abilityIndex: number): void {\r\n    const heroDef = HEROES[player.heroId];\r\n    const abilityDef = heroDef?.abilities[abilityIndex];\r\n    console.log(`[Ability] Executing ability ${abilityIndex}: ${abilityDef?.name || 'Unknown'} for ${heroDef?.name || 'Unknown hero'}`);\r\n    \r\n    player.useAbility(abilityIndex, this.time);\r\n\r\n    // Execute ability through the new system\r\n    const result = this.abilitySystem.executeAbility(player, abilityIndex);\r\n    \r\n    if (!result.success) return;\r\n\r\n    // Handle teleportation\r\n    if (result.teleportTo) {\r\n      player.position = { ...result.teleportTo };\r\n      player.prevPosition = { ...result.teleportTo };\r\n      this.collisionWorld.updateBody(player.id, player.position);\r\n    }\r\n\r\n    // Handle damage to targets\r\n    if (result.damage && result.targetIds) {\r\n      for (const targetId of result.targetIds) {\r\n        const target = this.players.get(targetId);\r\n        if (target && target.alive) {\r\n          target.takeDamage(result.damage, player.id, this.time);\r\n          \r\n          if (!target.alive) {\r\n            player.kills++;\r\n            player.credits += GAMEPLAY.KILL_REWARD;\r\n            this.collisionWorld.removeBody(target.id);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Handle healing\r\n    if (result.healing && result.targetIds) {\r\n      for (const targetId of result.targetIds) {\r\n        const target = this.players.get(targetId);\r\n        if (target) {\r\n          // Revive if dead\r\n          if (!target.alive) {\r\n            target.alive = true;\r\n            target.health = result.healing;\r\n            this.collisionWorld.addBody(target.getCollisionBody());\r\n          } else {\r\n            target.heal(result.healing);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Queue visual effects\r\n    if (result.visualEffects) {\r\n      for (const vfx of result.visualEffects) {\r\n        this.visualEffectQueue.push({\r\n          ...vfx,\r\n          startTime: this.time,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Add legacy ability effects for backward compatibility\r\n    if (result.effectsApplied.includes('cloak')) {\r\n      this.abilityEffects.push({\r\n        type: 'cloak',\r\n        playerId: player.id,\r\n        position: { ...player.position },\r\n        direction: player.rotation,\r\n        startTime: this.time,\r\n        duration: 4000,\r\n      });\r\n      player.isInvisible = true;\r\n    }\r\n  }\r\n\r\n  private applyEffectModifiers(player: Player): void {\r\n    // Apply speed modifier from effects\r\n    const speedMod = this.effectSystem.getSpeedModifier(player.id);\r\n    player.speedMultiplier = speedMod;\r\n\r\n    // Check stun status\r\n    player.isStunned = this.effectSystem.isStunned(player.id);\r\n\r\n    // Check cloak status\r\n    const isCloaked = this.effectSystem.isCloaked(player.id);\r\n    player.isInvisible = isCloaked;\r\n\r\n    // Apply damage reduction when taking damage (handled in takeDamage)\r\n    // Fire rate modifier (handled in weapon system)\r\n  }\r\n\r\n  // Calculate damage with effect modifiers\r\n  calculateDamage(baseDamage: number, attackerId: EntityId, targetId: EntityId): number {\r\n    let damage = baseDamage;\r\n\r\n    // Apply attacker's damage boost\r\n    const damageBoost = this.effectSystem.getDamageModifier(attackerId);\r\n    damage *= damageBoost;\r\n\r\n    // Check if target is marked (bonus damage)\r\n    const markedEffect = this.effectSystem.getEffect(targetId, EffectType.Marked);\r\n    if (markedEffect) {\r\n      damage *= 1 + markedEffect.value / 100;\r\n    }\r\n\r\n    // Apply target's damage reduction\r\n    const reduction = this.effectSystem.getDamageReduction(targetId);\r\n    damage *= 1 - reduction / 100;\r\n\r\n    return Math.floor(damage);\r\n  }\r\n\r\n  // Get fire rate modifier for a player\r\n  getFireRateModifier(playerId: EntityId): number {\r\n    return this.effectSystem.getFireRateModifier(playerId);\r\n  }\r\n\r\n  // Get all zone effects for rendering\r\n  getZoneEffects(): ZoneEffect[] {\r\n    return this.effectSystem.getZones();\r\n  }\r\n\r\n  // Get turrets for rendering\r\n  getTurrets(): Turret[] {\r\n    return this.abilitySystem.getTurrets();\r\n  }\r\n\r\n  // Get visual effects for rendering\r\n  getVisualEffects(): typeof this.visualEffectQueue {\r\n    return [...this.visualEffectQueue];\r\n  }\r\n\r\n  getAbilityEffects(): Array<{\r\n    type: 'shield' | 'shockwave' | 'dash' | 'cloak';\r\n    playerId: EntityId;\r\n    position: { x: number; y: number };\r\n    direction: number;\r\n    startTime: number;\r\n    duration: number;\r\n    radius?: number;\r\n  }> {\r\n    return [...this.abilityEffects];\r\n  }\r\n\r\n  // Effect system accessors\r\n  getEffectSystem(): EffectSystem {\r\n    return this.effectSystem;\r\n  }\r\n\r\n  hasEffect(playerId: EntityId, type: EffectType): boolean {\r\n    return this.effectSystem.hasEffect(playerId, type);\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Spike Interaction (Data Spike Assault Mode)\r\n  // -------------------------------------------------------------------------\r\n\r\n  private processSpikeInteraction(dt: number): void {\r\n    const plantTime = GAMEPLAY.SPIKE_PLANT_TIME;\r\n    const defuseTime = GAMEPLAY.SPIKE_DEFUSE_TIME;\r\n    \r\n    // If spike is planted, handle defusing\r\n    if (this.objectives.spikePlanted) {\r\n      this.handleSpikeDefusing(dt, defuseTime);\r\n    } else {\r\n      // Spike not planted yet - handle planting\r\n      this.handleSpikePlanting(dt, plantTime);\r\n    }\r\n  }\r\n\r\n  private handleSpikePlanting(dt: number, plantTime: number): void {\r\n    const carrier = this.objectives.spikeCarrierId ? this.players.get(this.objectives.spikeCarrierId) : null;\r\n    \r\n    // Check if carrier is alive and pressing interact\r\n    if (!carrier || !carrier.alive) {\r\n      // Carrier dead - transfer spike to another attacker if possible\r\n      // Prefer human players over bots\r\n      if (this.objectives.spikeCarrierId) {\r\n        const aliveAttackers = this.getTeamPlayers(Team.Attackers).filter(p => p.alive && p.id !== this.objectives.spikeCarrierId);\r\n        const aliveHumans = aliveAttackers.filter(p => !this.bots.has(p.id));\r\n        \r\n        if (aliveHumans.length > 0) {\r\n          const newCarrier = aliveHumans[0]!;\r\n          this.objectives.spikeCarrierId = newCarrier.id;\r\n          console.log(`[Spike] Spike transferred to human: ${newCarrier.name}`);\r\n        } else if (aliveAttackers.length > 0) {\r\n          const newCarrier = aliveAttackers[0]!;\r\n          this.objectives.spikeCarrierId = newCarrier.id;\r\n          console.log(`[Spike] Spike transferred to bot: ${newCarrier.name}`);\r\n        }\r\n      }\r\n      this.objectives.plantingPlayerId = null;\r\n      this.objectives.plantingPeerId = null;\r\n      this.objectives.plantingProgress = 0;\r\n      return;\r\n    }\r\n\r\n    // Check if carrier is in a spike site\r\n    const siteIndex = this.map.isInSpikeSite(carrier.position);\r\n    if (siteIndex === -1) {\r\n      // Not in a spike site\r\n      if (this.objectives.plantingPlayerId) {\r\n        console.log(`[Spike] Planting cancelled - left spike site`);\r\n      }\r\n      this.objectives.plantingPlayerId = null;\r\n      this.objectives.plantingPeerId = null;\r\n      this.objectives.plantingProgress = 0;\r\n      return;\r\n    }\r\n\r\n    // Check if pressing interact (E key)\r\n    if (carrier.input.interact) {\r\n      // Start or continue planting\r\n      if (this.objectives.plantingPlayerId !== carrier.id) {\r\n        this.objectives.plantingPlayerId = carrier.id;\r\n        this.objectives.plantingPeerId = carrier.peerId;\r\n        this.objectives.plantingProgress = 0;\r\n        console.log(`[Spike] Starting to plant at site ${siteIndex === 0 ? 'A' : 'B'}`);\r\n      }\r\n      \r\n      // Increment progress\r\n      this.objectives.plantingProgress += dt / plantTime;\r\n      \r\n      // Check if planting complete\r\n      if (this.objectives.plantingProgress >= 1) {\r\n        this.objectives.spikePlanted = true;\r\n        this.objectives.spikeSite = siteIndex;\r\n        this.objectives.spikePlantTime = this.time;\r\n        this.objectives.spikePosition = { ...carrier.position };\r\n        this.objectives.plantingPlayerId = null;\r\n        this.objectives.plantingPeerId = null;\r\n        this.objectives.plantingProgress = 0;\r\n        console.log(`[Spike]  SPIKE PLANTED at site ${siteIndex === 0 ? 'A' : 'B'}! Defenders have ${GAMEPLAY.SPIKE_UPLOAD_TIME / 1000}s to defuse!`);\r\n      }\r\n    } else {\r\n      // Released interact - cancel planting\r\n      if (this.objectives.plantingPlayerId) {\r\n        console.log(`[Spike] Planting cancelled - released E key`);\r\n        this.objectives.plantingPlayerId = null;\r\n        this.objectives.plantingPeerId = null;\r\n        this.objectives.plantingProgress = 0;\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleSpikeDefusing(dt: number, defuseTime: number): void {\r\n    // Find defender trying to defuse\r\n    let defusingPlayer: Player | null = null;\r\n    \r\n    // Debug: Log all defenders' interact state (only when spike is planted)\r\n    if (this.tick % 20 === 0) { // Log every ~1 second to avoid spam\r\n      for (const player of this.players.values()) {\r\n        if (player.team === Team.Defenders && player.alive) {\r\n          const dist = this.objectives.spikePosition \r\n            ? Vec2.distance(player.position, this.objectives.spikePosition) \r\n            : 999;\r\n          console.log(`[Spike] Defender ${player.name} (${player.peerId}): interact=${player.input?.interact}, dist=${dist.toFixed(0)}, isBot=${this.bots.has(player.id)}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const player of this.players.values()) {\r\n      if (!player.alive || player.team !== Team.Defenders) continue;\r\n      \r\n      // Safety check: ensure player.input exists\r\n      if (!player.input) {\r\n        console.warn(`[Spike] Player ${player.name} has no input object!`);\r\n        continue;\r\n      }\r\n      \r\n      if (!player.input.interact) continue;\r\n      \r\n      // Check if close enough to spike (within 50 pixels)\r\n      if (!this.objectives.spikePosition) continue;\r\n      const dist = Vec2.distance(player.position, this.objectives.spikePosition);\r\n      if (dist <= 50) {\r\n        defusingPlayer = player;\r\n        console.log(`[Spike] Found defusing player: ${player.name} (interact=${player.input.interact}, dist=${dist.toFixed(0)})`);\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (defusingPlayer) {\r\n      // Start or continue defusing\r\n      if (this.objectives.defusingPlayerId !== defusingPlayer.id) {\r\n        this.objectives.defusingPlayerId = defusingPlayer.id;\r\n        this.objectives.defusingPeerId = defusingPlayer.peerId;\r\n        this.objectives.defusingProgress = 0;\r\n        console.log(`[Spike] ${defusingPlayer.name} started defusing!`);\r\n      }\r\n      \r\n      // Increment progress\r\n      this.objectives.defusingProgress += dt / defuseTime;\r\n      \r\n      // Check if defuse complete\r\n      if (this.objectives.defusingProgress >= 1) {\r\n        console.log(`[Spike]  SPIKE DEFUSED by ${defusingPlayer.name}! Defenders win!`);\r\n        this.endRound(Team.Defenders);\r\n      }\r\n    } else {\r\n      // No one defusing - reset progress\r\n      if (this.objectives.defusingPlayerId) {\r\n        const oldDefuser = this.players.get(this.objectives.defusingPlayerId);\r\n        console.log(`[Spike] Defuse cancelled by ${oldDefuser?.name || 'unknown'}`);\r\n      }\r\n      this.objectives.defusingPlayerId = null;\r\n      this.objectives.defusingPeerId = null;\r\n      this.objectives.defusingProgress = 0;\r\n    }\r\n  }\r\n\r\n  private checkRoundEnd(): void {\r\n    // Skip round end checks if we don't have enough players yet\r\n    const totalPlayers = this.players.size;\r\n    if (totalPlayers < 2) {\r\n      // Single player mode - don't end round\r\n      return;\r\n    }\r\n    \r\n    // Grace period: Don't check round end in the first 10 seconds\r\n    // This gives plenty of time for network players to spawn and sync properly\r\n    const roundTime = this.time - this.roundStartTime;\r\n    if (roundTime < 10000) {\r\n      return;\r\n    }\r\n\r\n    const attackerPlayers = this.getTeamPlayers(Team.Attackers);\r\n    const defenderPlayers = this.getTeamPlayers(Team.Defenders);\r\n    const attackersAlive = attackerPlayers.filter(p => p.alive).length;\r\n    const defendersAlive = defenderPlayers.filter(p => p.alive).length;\r\n    \r\n    // Debug logging - log every 2 seconds to diagnose restart issue\r\n    if (Math.floor(roundTime / 2000) !== Math.floor((roundTime - 16) / 2000)) {\r\n      console.log(`[GameWorld] Round check @ ${Math.round(roundTime)}ms - Total: ${totalPlayers}, Attackers: ${attackersAlive}/${attackerPlayers.length}, Defenders: ${defendersAlive}/${defenderPlayers.length}`);\r\n      \r\n      // Additional debug: list all players\r\n      for (const p of this.players.values()) {\r\n        console.log(`  - ${p.name} (${p.peerId}): team=${p.team}, alive=${p.alive}`);\r\n      }\r\n    }\r\n    \r\n    // SAFETY: Don't end round if a team has no players at all\r\n    // This can happen in multiplayer when waiting for players to sync\r\n    if (attackerPlayers.length === 0 || defenderPlayers.length === 0) {\r\n      // One team is empty - don't end round, wait for players to join\r\n      return;\r\n    }\r\n\r\n    // For Deathmatch, check if one team is eliminated\r\n    if (this.config.mode === GameMode.NeonDeathmatch) {\r\n      if (attackersAlive === 0 && attackerPlayers.length > 0) {\r\n        console.log(`[GameWorld] Round ending: All attackers eliminated`);\r\n        this.endRound(Team.Defenders);\r\n        return;\r\n      }\r\n      if (defendersAlive === 0 && defenderPlayers.length > 0) {\r\n        console.log(`[GameWorld] Round ending: All defenders eliminated`);\r\n        this.endRound(Team.Attackers);\r\n        return;\r\n      }\r\n    } else {\r\n      // Data Spike / Escort modes\r\n      if (attackersAlive === 0 && attackerPlayers.length > 0) {\r\n        console.log(`[GameWorld] Round ending: All attackers eliminated`);\r\n        this.endRound(Team.Defenders);\r\n        return;\r\n      }\r\n      if (defendersAlive === 0 && defenderPlayers.length > 0) {\r\n        console.log(`[GameWorld] Round ending: All defenders eliminated`);\r\n        this.endRound(Team.Attackers);\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Check time limit\r\n    if (roundTime >= GAMEPLAY.ROUND_TIME) {\r\n      // Time out - defenders win\r\n      this.endRound(Team.Defenders);\r\n      return;\r\n    }\r\n\r\n    // Check spike upload (Data Spike mode)\r\n    if (this.objectives.spikePlanted) {\r\n      const uploadTime = this.time - this.objectives.spikePlantTime;\r\n      this.objectives.spikeProgress = uploadTime / GAMEPLAY.SPIKE_UPLOAD_TIME;\r\n\r\n      if (this.objectives.spikeProgress >= 1) {\r\n        this.endRound(Team.Attackers);\r\n      }\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Input Processing\r\n  // -------------------------------------------------------------------------\r\n\r\n  processInput(peerId: string, input: PlayerInput): void {\r\n    const player = this.playersByPeerId.get(peerId);\r\n    if (player) {\r\n      player.setInput(input);\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // State Sync\r\n  // -------------------------------------------------------------------------\r\n\r\n  getState(): GameState {\r\n    return {\r\n      phase: this.phase,\r\n      mode: this.config.mode,\r\n      mapId: this.map.data.id,\r\n      tick: this.tick,\r\n      time: this.time,\r\n      roundStartTime: this.roundStartTime,\r\n      roundNumber: this.roundNumber,\r\n      maxRounds: GAMEPLAY.MAX_ROUNDS,\r\n      roundTimeLimit: GAMEPLAY.ROUND_TIME,\r\n      attackerScore: this.attackerScore,\r\n      defenderScore: this.defenderScore,\r\n      // Use peerId as key for network sync (entity IDs differ between host and client)\r\n      players: new Map(\r\n        Array.from(this.players.values()).map(p => [p.peerId, p.toState()])\r\n      ),\r\n      projectiles: new Map(\r\n        Array.from(this.projectiles.entries()).map(([id, p]) => [id, p.toState()])\r\n      ),\r\n      objectives: { ...this.objectives },\r\n      // Include recent shots for client bullet tracer visualization\r\n      recentShots: [...this.recentShots],\r\n      // Countdown state for synchronized display\r\n      countdownTime: this.countdownTime,\r\n      countdownPaused: this.countdownPaused,\r\n      countdownPausedBy: this.countdownPausedBy,\r\n    };\r\n  }\r\n\r\n  applyState(state: GameState): void {\r\n    this.phase = state.phase;\r\n    this.tick = state.tick;\r\n    this.time = state.time;\r\n    this.roundStartTime = state.roundStartTime;\r\n    this.roundNumber = state.roundNumber;\r\n    this.attackerScore = state.attackerScore;\r\n    this.defenderScore = state.defenderScore;\r\n    \r\n    // Sync countdown state\r\n    if (state.countdownTime !== undefined) {\r\n      this.countdownTime = state.countdownTime;\r\n    }\r\n    if (state.countdownPaused !== undefined) {\r\n      this.countdownPaused = state.countdownPaused;\r\n    }\r\n    if (state.countdownPausedBy !== undefined) {\r\n      this.countdownPausedBy = state.countdownPausedBy;\r\n    }\r\n    this.objectives = { ...state.objectives };\r\n\r\n    // Store local player's peerId before applying state\r\n    const localPlayer = this.getLocalPlayer();\r\n    const localPeerId = localPlayer?.peerId;\r\n\r\n    // Update players (keyed by peerId for network sync)\r\n    const seenPeerIds = new Set<string>();\r\n    for (const [peerId, playerState] of state.players) {\r\n      seenPeerIds.add(peerId);\r\n      let player = this.playersByPeerId.get(peerId);\r\n      if (!player) {\r\n        // New player from host\r\n        player = Player.fromState(playerState);\r\n        this.players.set(player.id, player);\r\n        this.playersByPeerId.set(peerId, player);\r\n        this.collisionWorld.addBody(player.getCollisionBody());\r\n        console.log(`[GameWorld] Created player from state: ${player.name} (${peerId})`);\r\n        \r\n        // If this is our local player (same peerId), update localPlayerId\r\n        if (peerId === localPeerId) {\r\n          this.localPlayerId = player.id;\r\n          console.log(`[GameWorld] Updated localPlayerId to ${player.id} for peerId ${peerId}`);\r\n        }\r\n      } else {\r\n        // Check if this is our local player - use client-side prediction\r\n        const isLocalPlayer = player.id === this.localPlayerId;\r\n        \r\n        if (isLocalPlayer) {\r\n          // For local player: only sync critical state, NOT position (client predicts movement)\r\n          // This prevents jittery movement from host overwriting local prediction\r\n          \r\n          // EXCEPTION: Sync position on respawn/round start scenarios:\r\n          // 1. Round number changed (new round started, everyone respawns)\r\n          // 2. Player just respawned (was dead, now alive)\r\n          // 3. Large distance mismatch (teleport or forced position sync)\r\n          const wasRoundReset = state.roundNumber !== this.roundNumber;\r\n          const justRespawned = !player.alive && playerState.alive;\r\n          const dx = playerState.position.x - player.position.x;\r\n          const dy = playerState.position.y - player.position.y;\r\n          const distSq = dx * dx + dy * dy;\r\n          const largeDistanceMismatch = distSq > 10000; // > 100 pixels difference\r\n          \r\n          if (wasRoundReset || justRespawned || largeDistanceMismatch) {\r\n            // Force position sync from host\r\n            player.position = { ...playerState.position };\r\n            player.prevPosition = { ...playerState.position };\r\n            player.velocity = { ...playerState.velocity };\r\n            player.rotation = playerState.rotation;\r\n            player.prevRotation = playerState.rotation;\r\n            console.log(`[GameWorld] Force synced local player position (round: ${wasRoundReset}, respawn: ${justRespawned}, dist: ${Math.sqrt(distSq).toFixed(0)})`);\r\n          }\r\n          \r\n          player.health = playerState.health;\r\n          player.shield = playerState.shield;\r\n          player.alive = playerState.alive;\r\n          player.weapon = { ...playerState.weapon };\r\n          player.abilities = playerState.abilities.map(a => ({ ...a }));\r\n          player.team = playerState.team;\r\n        } else {\r\n          // For remote players: set target for smooth interpolation\r\n          // Don't snap directly to position - interpolate smoothly\r\n          player.targetPosition = { ...playerState.position };\r\n          player.targetRotation = playerState.rotation;\r\n          player.velocity = { ...playerState.velocity };\r\n          player.health = playerState.health;\r\n          player.shield = playerState.shield;\r\n          player.alive = playerState.alive;\r\n          player.weapon = { ...playerState.weapon };\r\n          player.abilities = playerState.abilities.map(a => ({ ...a }));\r\n          player.team = playerState.team;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove players that are no longer in state (disconnected)\r\n    for (const [id, player] of this.players) {\r\n      if (!seenPeerIds.has(player.peerId)) {\r\n        // Don't remove our own local player even if host doesn't have us yet\r\n        if (id === this.localPlayerId) {\r\n          console.log(`[GameWorld] Keeping local player even though not in host state: ${player.name}`);\r\n          continue;\r\n        }\r\n        console.log(`[GameWorld] Removing player not in state: ${player.name} (${player.peerId})`);\r\n        this.removePlayer(id);\r\n      }\r\n    }\r\n\r\n    // Sync projectiles from host\r\n    const seenProjectileIds = new Set<EntityId>();\r\n    for (const [id, projState] of state.projectiles) {\r\n      seenProjectileIds.add(id);\r\n      let projectile = this.projectiles.get(id);\r\n      if (!projectile) {\r\n        // New projectile from host\r\n        projectile = Projectile.fromState(projState);\r\n        this.projectiles.set(id, projectile);\r\n      } else {\r\n        // Update existing projectile\r\n        projectile.position = { ...projState.position };\r\n        projectile.velocity = { ...projState.velocity };\r\n      }\r\n    }\r\n\r\n    // Remove projectiles that are no longer in state\r\n    for (const id of this.projectiles.keys()) {\r\n      if (!seenProjectileIds.has(id)) {\r\n        this.projectiles.delete(id);\r\n      }\r\n    }\r\n  }\r\n\r\n  getPendingEvents(): Array<{ type: GameEventType; data: unknown }> {\r\n    const events = [...this.pendingEvents];\r\n    this.pendingEvents = [];\r\n    return events;\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Getters\r\n  // -------------------------------------------------------------------------\r\n\r\n  getPhase(): GamePhase {\r\n    return this.phase;\r\n  }\r\n\r\n  getTick(): number {\r\n    return this.tick;\r\n  }\r\n\r\n  getTime(): number {\r\n    // Return time elapsed since round started\r\n    return this.time - this.roundStartTime;\r\n  }\r\n\r\n  getAbsoluteTime(): number {\r\n    // Return absolute game time (for death tracking, etc.)\r\n    return this.time;\r\n  }\r\n\r\n  getRoundNumber(): number {\r\n    return this.roundNumber;\r\n  }\r\n\r\n  getMap(): GameMap {\r\n    return this.map;\r\n  }\r\n\r\n  getProjectiles(): Projectile[] {\r\n    return Array.from(this.projectiles.values());\r\n  }\r\n\r\n  // Get recent shots for tracer visualization and clear the list\r\n  getAndClearRecentShots(): Array<{ \r\n    start: { x: number; y: number }; \r\n    end: { x: number; y: number };\r\n    shooterId: EntityId;\r\n  }> {\r\n    const shots = this.recentShots;\r\n    this.recentShots = [];\r\n    return shots;\r\n  }\r\n\r\n  // Check if a player is an enemy of the local player\r\n  isEnemyOfLocal(playerId: EntityId): boolean {\r\n    const localPlayer = this.getLocalPlayer();\r\n    const player = this.getPlayer(playerId);\r\n    if (!localPlayer || !player) return false;\r\n    return localPlayer.team !== player.team;\r\n  }\r\n\r\n  getObjectives(): ObjectiveState {\r\n    return { ...this.objectives };\r\n  }\r\n\r\n  getScore(): { attackers: number; defenders: number } {\r\n    return { attackers: this.attackerScore, defenders: this.defenderScore };\r\n  }\r\n\r\n  getAttackerScore(): number {\r\n    return this.attackerScore;\r\n  }\r\n\r\n  getDefenderScore(): number {\r\n    return this.defenderScore;\r\n  }\r\n\r\n  getRoundsToWin(): number {\r\n    return this.roundsToWin;\r\n  }\r\n\r\n  getTotalRounds(): number {\r\n    return this.totalRounds;\r\n  }\r\n\r\n  getCollisionWorld(): CollisionWorld {\r\n    return this.collisionWorld;\r\n  }\r\n\r\n  setPhase(phase: GamePhase): void {\r\n    this.phase = phase;\r\n  }\r\n\r\n  // Countdown getters\r\n  getCountdownTime(): number {\r\n    return this.countdownTime;\r\n  }\r\n\r\n  isCountdownPaused(): boolean {\r\n    return this.countdownPaused;\r\n  }\r\n\r\n  getCountdownPausedBy(): string {\r\n    return this.countdownPausedBy;\r\n  }\r\n}\r\n","// ============================================================================\r\n// PARTICLE SYSTEM - Cyberpunk-style visual effects\r\n// ============================================================================\r\n\r\nimport { Vector2 } from '@/shared/types';\r\nimport { Vec2 } from '@/shared/utils';\r\nimport { Renderer } from '@/engine/Renderer';\r\nimport { COLORS } from '@/shared/constants';\r\n\r\n// ----------------------------------------------------------------------------\r\n// PARTICLE TYPES\r\n// ----------------------------------------------------------------------------\r\n\r\nexport interface Particle {\r\n  position: Vector2;\r\n  velocity: Vector2;\r\n  acceleration: Vector2;\r\n  color: string;\r\n  size: number;\r\n  life: number;\r\n  maxLife: number;\r\n  rotation: number;\r\n  rotationSpeed: number;\r\n  type: ParticleType;\r\n  trail: Vector2[] | undefined;  // For trail effects\r\n}\r\n\r\nexport enum ParticleType {\r\n  Spark = 'spark',\r\n  Smoke = 'smoke',\r\n  Blood = 'blood',\r\n  Debris = 'debris',\r\n  Energy = 'energy',\r\n  Glitch = 'glitch',\r\n  Data = 'data',\r\n}\r\n\r\nexport interface ParticleConfig {\r\n  count: number;\r\n  position: Vector2;\r\n  direction?: number;  // Base direction in radians\r\n  spread?: number;     // Spread angle in radians\r\n  speed: { min: number; max: number };\r\n  size: { min: number; max: number };\r\n  life: { min: number; max: number };\r\n  colors: string[];\r\n  type: ParticleType;\r\n  gravity?: number;\r\n  friction?: number;\r\n  rotationSpeed?: { min: number; max: number };\r\n  trail?: boolean;\r\n}\r\n\r\n// ----------------------------------------------------------------------------\r\n// PARTICLE SYSTEM\r\n// ----------------------------------------------------------------------------\r\n\r\nexport class ParticleSystem {\r\n  private particles: Particle[] = [];\r\n  private maxParticles: number = 1000;\r\n\r\n  update(dt: number): void {\r\n    const dtSec = dt / 1000;\r\n\r\n    for (let i = this.particles.length - 1; i >= 0; i--) {\r\n      const p = this.particles[i]!;\r\n      \r\n      // Update life\r\n      p.life -= dtSec;\r\n      if (p.life <= 0) {\r\n        this.particles.splice(i, 1);\r\n        continue;\r\n      }\r\n\r\n      // Store trail position\r\n      if (p.trail) {\r\n        p.trail.push({ ...p.position });\r\n        if (p.trail.length > 10) {\r\n          p.trail.shift();\r\n        }\r\n      }\r\n\r\n      // Update velocity with acceleration\r\n      p.velocity = Vec2.add(p.velocity, Vec2.mul(p.acceleration, dtSec));\r\n      \r\n      // Update position\r\n      p.position = Vec2.add(p.position, Vec2.mul(p.velocity, dtSec));\r\n      \r\n      // Update rotation\r\n      p.rotation += p.rotationSpeed * dtSec;\r\n    }\r\n  }\r\n\r\n  render(renderer: Renderer): void {\r\n    for (const p of this.particles) {\r\n      const lifeRatio = p.life / p.maxLife;\r\n      const alpha = Math.min(1, lifeRatio * 2); // Fade out in last 50%\r\n\r\n      switch (p.type) {\r\n        case ParticleType.Spark:\r\n          this.renderSpark(renderer, p, alpha);\r\n          break;\r\n        case ParticleType.Smoke:\r\n          this.renderSmoke(renderer, p, alpha);\r\n          break;\r\n        case ParticleType.Debris:\r\n          this.renderDebris(renderer, p, alpha);\r\n          break;\r\n        case ParticleType.Energy:\r\n          this.renderEnergy(renderer, p, alpha);\r\n          break;\r\n        case ParticleType.Glitch:\r\n          this.renderGlitch(renderer, p, alpha);\r\n          break;\r\n        case ParticleType.Data:\r\n          this.renderData(renderer, p, alpha);\r\n          break;\r\n        case ParticleType.Blood:\r\n          this.renderBlood(renderer, p, alpha);\r\n          break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private renderSpark(renderer: Renderer, p: Particle, alpha: number): void {\r\n    const color = this.colorWithAlpha(p.color, alpha);\r\n    \r\n    // Draw spark line based on velocity direction\r\n    const tailLength = Vec2.length(p.velocity) * 0.03;\r\n    const tail = Vec2.normalize(p.velocity);\r\n    const tailEnd = Vec2.sub(p.position, Vec2.mul(tail, tailLength));\r\n    \r\n    renderer.drawLine(\r\n      tailEnd.x, tailEnd.y,\r\n      p.position.x, p.position.y,\r\n      { color, width: p.size }\r\n    );\r\n    \r\n    // Bright head\r\n    renderer.drawCircle(p.position.x, p.position.y, p.size * 0.5, {\r\n      fill: color,\r\n      glow: true,\r\n      glowColor: p.color,\r\n      glowSize: p.size * 2,\r\n    });\r\n  }\r\n\r\n  private renderSmoke(renderer: Renderer, p: Particle, alpha: number): void {\r\n    const size = p.size * (1 + (1 - p.life / p.maxLife) * 2);\r\n    const color = this.colorWithAlpha(p.color, alpha * 0.5);\r\n    \r\n    renderer.drawCircle(p.position.x, p.position.y, size, {\r\n      fill: color,\r\n    });\r\n  }\r\n\r\n  private renderDebris(renderer: Renderer, p: Particle, alpha: number): void {\r\n    const color = this.colorWithAlpha(p.color, alpha);\r\n    const size = p.size;\r\n    \r\n    // Draw rotating square debris\r\n    const ctx = renderer['ctx'] as CanvasRenderingContext2D;\r\n    ctx.save();\r\n    ctx.translate(p.position.x, p.position.y);\r\n    ctx.rotate(p.rotation);\r\n    ctx.fillStyle = color;\r\n    ctx.fillRect(-size / 2, -size / 2, size, size);\r\n    ctx.restore();\r\n  }\r\n\r\n  private renderEnergy(renderer: Renderer, p: Particle, alpha: number): void {\r\n    const color = this.colorWithAlpha(p.color, alpha);\r\n    \r\n    renderer.drawCircle(p.position.x, p.position.y, p.size, {\r\n      fill: color,\r\n      glow: true,\r\n      glowColor: p.color,\r\n      glowSize: p.size * 3,\r\n    });\r\n    \r\n    // Draw trail\r\n    if (p.trail && p.trail.length > 1) {\r\n      for (let i = 1; i < p.trail.length; i++) {\r\n        const prev = p.trail[i - 1]!;\r\n        const curr = p.trail[i]!;\r\n        const trailAlpha = (i / p.trail.length) * alpha * 0.5;\r\n        renderer.drawLine(\r\n          prev.x, prev.y,\r\n          curr.x, curr.y,\r\n          { color: this.colorWithAlpha(p.color, trailAlpha), width: p.size * 0.5 }\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private renderGlitch(renderer: Renderer, p: Particle, alpha: number): void {\r\n    const color = this.colorWithAlpha(p.color, alpha);\r\n    \r\n    // Glitch rectangle with offset\r\n    const offsetX = (Math.random() - 0.5) * 10;\r\n    const offsetY = (Math.random() - 0.5) * 5;\r\n    const width = p.size * 2 + Math.random() * 10;\r\n    const height = p.size * 0.5;\r\n    \r\n    const ctx = renderer['ctx'] as CanvasRenderingContext2D;\r\n    ctx.fillStyle = color;\r\n    ctx.fillRect(\r\n      p.position.x + offsetX - width / 2,\r\n      p.position.y + offsetY - height / 2,\r\n      width,\r\n      height\r\n    );\r\n  }\r\n\r\n  private renderData(renderer: Renderer, p: Particle, alpha: number): void {\r\n    const color = this.colorWithAlpha(p.color, alpha);\r\n    \r\n    // Draw random binary character\r\n    const char = Math.random() > 0.5 ? '1' : '0';\r\n    const ctx = renderer['ctx'] as CanvasRenderingContext2D;\r\n    ctx.font = `${p.size * 2}px monospace`;\r\n    ctx.fillStyle = color;\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'middle';\r\n    ctx.fillText(char, p.position.x, p.position.y);\r\n  }\r\n\r\n  private renderBlood(renderer: Renderer, p: Particle, alpha: number): void {\r\n    const size = p.size * (1 + (1 - p.life / p.maxLife) * 0.5);\r\n    const color = this.colorWithAlpha(p.color, alpha * 0.8);\r\n    \r\n    renderer.drawCircle(p.position.x, p.position.y, size, {\r\n      fill: color,\r\n    });\r\n  }\r\n\r\n  emit(config: ParticleConfig): void {\r\n    const { \r\n      count, \r\n      position, \r\n      direction = 0, \r\n      spread = Math.PI * 2, \r\n      speed, \r\n      size, \r\n      life, \r\n      colors, \r\n      type,\r\n      gravity = 0,\r\n      friction = 0,\r\n      rotationSpeed = { min: 0, max: 0 },\r\n      trail = false,\r\n    } = config;\r\n\r\n    for (let i = 0; i < count && this.particles.length < this.maxParticles; i++) {\r\n      const angle = direction + (Math.random() - 0.5) * spread;\r\n      const spd = speed.min + Math.random() * (speed.max - speed.min);\r\n      const sz = size.min + Math.random() * (size.max - size.min);\r\n      const lf = life.min + Math.random() * (life.max - life.min);\r\n      const color = colors[Math.floor(Math.random() * colors.length)]!;\r\n      const rotSpd = rotationSpeed.min + Math.random() * (rotationSpeed.max - rotationSpeed.min);\r\n\r\n      this.particles.push({\r\n        position: { ...position },\r\n        velocity: Vec2.mul(Vec2.fromAngle(angle), spd),\r\n        acceleration: { x: friction * -1, y: gravity },\r\n        color,\r\n        size: sz,\r\n        life: lf,\r\n        maxLife: lf,\r\n        rotation: Math.random() * Math.PI * 2,\r\n        rotationSpeed: rotSpd,\r\n        type,\r\n        trail: trail ? [] : undefined,\r\n      });\r\n    }\r\n  }\r\n\r\n  // ----------------------------------------------------------------------------\r\n  // PRESET EFFECTS\r\n  // ----------------------------------------------------------------------------\r\n\r\n  bulletImpact(position: Vector2, normal: Vector2): void {\r\n    const angle = Math.atan2(normal.y, normal.x);\r\n    \r\n    // Sparks\r\n    this.emit({\r\n      count: 8,\r\n      position,\r\n      direction: angle,\r\n      spread: Math.PI * 0.6,\r\n      speed: { min: 100, max: 300 },\r\n      size: { min: 1, max: 3 },\r\n      life: { min: 0.1, max: 0.3 },\r\n      colors: [COLORS.CYAN, COLORS.YELLOW, '#ffffff'],\r\n      type: ParticleType.Spark,\r\n      gravity: 300,\r\n    });\r\n\r\n    // Small smoke puff\r\n    this.emit({\r\n      count: 3,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 20, max: 50 },\r\n      size: { min: 3, max: 6 },\r\n      life: { min: 0.2, max: 0.4 },\r\n      colors: ['#666666', '#888888', '#aaaaaa'],\r\n      type: ParticleType.Smoke,\r\n      gravity: -50,\r\n    });\r\n  }\r\n\r\n  bulletHitPlayer(position: Vector2, direction: Vector2): void {\r\n    const angle = Math.atan2(direction.y, direction.x);\r\n    \r\n    // Energy sparks\r\n    this.emit({\r\n      count: 12,\r\n      position,\r\n      direction: angle + Math.PI,\r\n      spread: Math.PI * 0.8,\r\n      speed: { min: 80, max: 200 },\r\n      size: { min: 2, max: 4 },\r\n      life: { min: 0.15, max: 0.35 },\r\n      colors: [COLORS.MAGENTA, COLORS.CYAN, '#ff4488'],\r\n      type: ParticleType.Energy,\r\n      gravity: 100,\r\n      trail: true,\r\n    });\r\n  }\r\n\r\n  playerDeath(position: Vector2): void {\r\n    // Cyberpunk death explosion!\r\n    \r\n    // Energy burst\r\n    this.emit({\r\n      count: 30,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 150, max: 400 },\r\n      size: { min: 3, max: 8 },\r\n      life: { min: 0.3, max: 0.8 },\r\n      colors: [COLORS.CYAN, COLORS.MAGENTA, '#ff4488', '#44ffaa'],\r\n      type: ParticleType.Energy,\r\n      gravity: 200,\r\n      trail: true,\r\n    });\r\n\r\n    // Glitch rectangles\r\n    this.emit({\r\n      count: 20,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 50, max: 150 },\r\n      size: { min: 4, max: 12 },\r\n      life: { min: 0.2, max: 0.5 },\r\n      colors: [COLORS.CYAN, COLORS.MAGENTA, '#ffffff'],\r\n      type: ParticleType.Glitch,\r\n    });\r\n\r\n    // Data fragments (binary)\r\n    this.emit({\r\n      count: 15,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 100, max: 250 },\r\n      size: { min: 6, max: 12 },\r\n      life: { min: 0.4, max: 1.0 },\r\n      colors: [COLORS.CYAN, '#00ff88', COLORS.MAGENTA],\r\n      type: ParticleType.Data,\r\n      gravity: 150,\r\n    });\r\n\r\n    // Debris\r\n    this.emit({\r\n      count: 15,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 100, max: 300 },\r\n      size: { min: 3, max: 8 },\r\n      life: { min: 0.3, max: 0.7 },\r\n      colors: ['#333344', '#444455', '#555566', '#2a2a3a'],\r\n      type: ParticleType.Debris,\r\n      gravity: 500,\r\n      rotationSpeed: { min: -10, max: 10 },\r\n    });\r\n  }\r\n\r\n  weaponSwitch(position: Vector2): void {\r\n    // Subtle energy effect\r\n    this.emit({\r\n      count: 8,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 30, max: 80 },\r\n      size: { min: 2, max: 4 },\r\n      life: { min: 0.15, max: 0.3 },\r\n      colors: [COLORS.CYAN, COLORS.YELLOW],\r\n      type: ParticleType.Energy,\r\n    });\r\n  }\r\n\r\n  muzzleFlashParticles(position: Vector2, direction: number): void {\r\n    // Hot sparks from muzzle\r\n    this.emit({\r\n      count: 5,\r\n      position,\r\n      direction,\r\n      spread: Math.PI * 0.3,\r\n      speed: { min: 200, max: 400 },\r\n      size: { min: 1, max: 2 },\r\n      life: { min: 0.05, max: 0.15 },\r\n      colors: [COLORS.YELLOW, '#ffaa00', '#ffffff'],\r\n      type: ParticleType.Spark,\r\n      gravity: 300,\r\n    });\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // ABILITY EFFECTS\r\n  // -------------------------------------------------------------------------\r\n\r\n  /** Blink/teleport effect - flash at position */\r\n  blinkEffect(position: Vector2): void {\r\n    // Bright flash\r\n    this.emit({\r\n      count: 20,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 100, max: 300 },\r\n      size: { min: 3, max: 8 },\r\n      life: { min: 0.2, max: 0.5 },\r\n      colors: [COLORS.CYAN, COLORS.MAGENTA, '#ffffff'],\r\n      type: ParticleType.Energy,\r\n    });\r\n    \r\n    // Data fragments\r\n    this.emit({\r\n      count: 10,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 50, max: 150 },\r\n      size: { min: 4, max: 8 },\r\n      life: { min: 0.3, max: 0.6 },\r\n      colors: [COLORS.CYAN, '#00ffaa'],\r\n      type: ParticleType.Data,\r\n    });\r\n  }\r\n\r\n  /** Trail between two points for blink */\r\n  blinkTrail(start: Vector2, end: Vector2): void {\r\n    const dist = Vec2.distance(start, end);\r\n    const count = Math.floor(dist / 20);\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n      const t = i / count;\r\n      const pos = Vec2.lerp(start, end, t);\r\n      this.emit({\r\n        count: 2,\r\n        position: pos,\r\n        spread: Math.PI * 2,\r\n        speed: { min: 20, max: 50 },\r\n        size: { min: 2, max: 4 },\r\n        life: { min: 0.1, max: 0.3 },\r\n        colors: [COLORS.CYAN, COLORS.MAGENTA],\r\n        type: ParticleType.Energy,\r\n      });\r\n    }\r\n  }\r\n\r\n  /** Shockwave expanding ring effect */\r\n  shockwaveEffect(position: Vector2, radius: number, color: string = COLORS.CYAN): void {\r\n    const particleCount = Math.floor(radius / 5);\r\n    \r\n    for (let i = 0; i < particleCount; i++) {\r\n      const angle = (i / particleCount) * Math.PI * 2;\r\n      const edgePos = {\r\n        x: position.x + Math.cos(angle) * radius * 0.8,\r\n        y: position.y + Math.sin(angle) * radius * 0.8,\r\n      };\r\n      \r\n      this.emit({\r\n        count: 1,\r\n        position: edgePos,\r\n        direction: angle,\r\n        spread: 0.2,\r\n        speed: { min: 50, max: 100 },\r\n        size: { min: 4, max: 8 },\r\n        life: { min: 0.2, max: 0.4 },\r\n        colors: [color, '#ffffff'],\r\n        type: ParticleType.Energy,\r\n      });\r\n    }\r\n  }\r\n\r\n  /** Shield/barrier effect */\r\n  shieldEffect(position: Vector2, color: string = '#00aaff'): void {\r\n    this.emit({\r\n      count: 15,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 20, max: 60 },\r\n      size: { min: 3, max: 6 },\r\n      life: { min: 0.5, max: 1.0 },\r\n      colors: [color, '#ffffff'],\r\n      type: ParticleType.Energy,\r\n    });\r\n  }\r\n\r\n  /** Cloak/invisibility shimmer */\r\n  cloakEffect(position: Vector2): void {\r\n    this.emit({\r\n      count: 12,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 10, max: 40 },\r\n      size: { min: 4, max: 8 },\r\n      life: { min: 0.3, max: 0.6 },\r\n      colors: ['#4444ff', '#8888ff', '#aaaaff'],\r\n      type: ParticleType.Glitch,\r\n    });\r\n  }\r\n\r\n  /** Reveal/scan pulse effect */\r\n  revealEffect(position: Vector2, radius: number): void {\r\n    this.shockwaveEffect(position, radius, COLORS.YELLOW);\r\n    \r\n    this.emit({\r\n      count: 8,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 30, max: 80 },\r\n      size: { min: 3, max: 5 },\r\n      life: { min: 0.4, max: 0.8 },\r\n      colors: [COLORS.YELLOW, '#ffaa00'],\r\n      type: ParticleType.Data,\r\n    });\r\n  }\r\n\r\n  /** Healing burst effect */\r\n  healBurstEffect(position: Vector2, color: string = '#00ff88'): void {\r\n    // Rising heal particles\r\n    this.emit({\r\n      count: 20,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 40, max: 100 },\r\n      size: { min: 3, max: 6 },\r\n      life: { min: 0.5, max: 1.0 },\r\n      colors: [color, '#00ffaa', '#88ffaa'],\r\n      type: ParticleType.Energy,\r\n      gravity: -100, // Float upward\r\n    });\r\n    \r\n    // Cross/plus symbols (energy particles)\r\n    this.emit({\r\n      count: 8,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 20, max: 60 },\r\n      size: { min: 6, max: 10 },\r\n      life: { min: 0.6, max: 1.2 },\r\n      colors: [color, '#ffffff'],\r\n      type: ParticleType.Data,\r\n      gravity: -50,\r\n    });\r\n  }\r\n\r\n  /** Poison cloud effect */\r\n  poisonCloudEffect(position: Vector2, radius: number): void {\r\n    const count = Math.floor(radius / 8);\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n      const angle = Math.random() * Math.PI * 2;\r\n      const dist = Math.random() * radius * 0.8;\r\n      const particlePos = {\r\n        x: position.x + Math.cos(angle) * dist,\r\n        y: position.y + Math.sin(angle) * dist,\r\n      };\r\n      \r\n      this.emit({\r\n        count: 2,\r\n        position: particlePos,\r\n        spread: Math.PI * 2,\r\n        speed: { min: 5, max: 20 },\r\n        size: { min: 8, max: 16 },\r\n        life: { min: 0.8, max: 1.5 },\r\n        colors: ['#44ff44', '#22aa22', '#116611'],\r\n        type: ParticleType.Smoke,\r\n        gravity: -30, // Slowly rise\r\n      });\r\n    }\r\n  }\r\n\r\n  /** Fire/explosion effect */\r\n  explosionEffect(position: Vector2, radius: number, color: string = '#ff4400'): void {\r\n    // Scale particle count based on radius\r\n    const scale = Math.max(1, radius / 50);\r\n    \r\n    // Core explosion\r\n    this.emit({\r\n      count: Math.floor(30 * scale),\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 100, max: 300 },\r\n      size: { min: 4, max: 12 },\r\n      life: { min: 0.2, max: 0.5 },\r\n      colors: [color, '#ff8800', '#ffff00', '#ffffff'],\r\n      type: ParticleType.Spark,\r\n      gravity: 100,\r\n    });\r\n    \r\n    // Smoke\r\n    this.emit({\r\n      count: Math.floor(15 * scale),\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 30, max: 80 },\r\n      size: { min: 10, max: 20 },\r\n      life: { min: 0.5, max: 1.0 },\r\n      colors: ['#333333', '#444444', '#222222'],\r\n      type: ParticleType.Smoke,\r\n      gravity: -50,\r\n    });\r\n    \r\n    // Debris\r\n    this.emit({\r\n      count: Math.floor(10 * scale),\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 150, max: 400 },\r\n      size: { min: 2, max: 5 },\r\n      life: { min: 0.3, max: 0.7 },\r\n      colors: ['#666666', '#888888', '#444444'],\r\n      type: ParticleType.Debris,\r\n      gravity: 400,\r\n    });\r\n  }\r\n\r\n  /** Grenade arc trail */\r\n  grenadeTrail(position: Vector2): void {\r\n    this.emit({\r\n      count: 3,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 10, max: 30 },\r\n      size: { min: 2, max: 4 },\r\n      life: { min: 0.1, max: 0.2 },\r\n      colors: ['#888888', '#666666'],\r\n      type: ParticleType.Smoke,\r\n    });\r\n  }\r\n\r\n  /** Turret spawn effect */\r\n  turretSpawnEffect(position: Vector2): void {\r\n    this.emit({\r\n      count: 20,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 50, max: 150 },\r\n      size: { min: 3, max: 6 },\r\n      life: { min: 0.3, max: 0.6 },\r\n      colors: [COLORS.CYAN, '#00ffaa', '#ffffff'],\r\n      type: ParticleType.Energy,\r\n    });\r\n    \r\n    // Assembly sparks\r\n    this.emit({\r\n      count: 10,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 100, max: 200 },\r\n      size: { min: 1, max: 3 },\r\n      life: { min: 0.1, max: 0.3 },\r\n      colors: [COLORS.YELLOW, '#ffaa00'],\r\n      type: ParticleType.Spark,\r\n      gravity: 200,\r\n    });\r\n  }\r\n\r\n  /** Dash slash effect */\r\n  dashSlashEffect(position: Vector2, direction: number, color: string = COLORS.CYAN): void {\r\n    // Arc of energy\r\n    for (let i = -3; i <= 3; i++) {\r\n      const angle = direction + (i * 0.15);\r\n      const edgePos = {\r\n        x: position.x + Math.cos(angle) * 40,\r\n        y: position.y + Math.sin(angle) * 40,\r\n      };\r\n      \r\n      this.emit({\r\n        count: 3,\r\n        position: edgePos,\r\n        direction: angle,\r\n        spread: 0.3,\r\n        speed: { min: 100, max: 200 },\r\n        size: { min: 3, max: 6 },\r\n        life: { min: 0.1, max: 0.25 },\r\n        colors: [color, '#ffffff'],\r\n        type: ParticleType.Energy,\r\n      });\r\n    }\r\n  }\r\n\r\n  /** Dome shield ambient particles */\r\n  domeShieldEffect(position: Vector2, radius: number, color: string = '#4488ff'): void {\r\n    // Particles along the dome edge\r\n    const count = 12;\r\n    for (let i = 0; i < count; i++) {\r\n      const angle = (i / count) * Math.PI * 2;\r\n      const edgePos = {\r\n        x: position.x + Math.cos(angle) * radius,\r\n        y: position.y + Math.sin(angle) * radius,\r\n      };\r\n      \r\n      this.emit({\r\n        count: 2,\r\n        position: edgePos,\r\n        direction: angle + Math.PI / 2,\r\n        spread: 0.5,\r\n        speed: { min: 20, max: 50 },\r\n        size: { min: 3, max: 6 },\r\n        life: { min: 0.4, max: 0.8 },\r\n        colors: [color, '#ffffff'],\r\n        type: ParticleType.Energy,\r\n      });\r\n    }\r\n  }\r\n\r\n  /** Fire zone continuous effect */\r\n  fireZoneEffect(position: Vector2, radius: number): void {\r\n    const count = Math.floor(radius / 15);\r\n    \r\n    for (let i = 0; i < count; i++) {\r\n      const angle = Math.random() * Math.PI * 2;\r\n      const dist = Math.random() * radius * 0.8;\r\n      const particlePos = {\r\n        x: position.x + Math.cos(angle) * dist,\r\n        y: position.y + Math.sin(angle) * dist,\r\n      };\r\n      \r\n      this.emit({\r\n        count: 2,\r\n        position: particlePos,\r\n        spread: 0.5,\r\n        speed: { min: 30, max: 80 },\r\n        size: { min: 4, max: 10 },\r\n        life: { min: 0.2, max: 0.5 },\r\n        colors: ['#ff4400', '#ff8800', '#ffaa00'],\r\n        type: ParticleType.Spark,\r\n        gravity: -100, // Flames rise\r\n      });\r\n    }\r\n  }\r\n\r\n  /** Stun/EMP effect */\r\n  stunEffect(position: Vector2): void {\r\n    this.emit({\r\n      count: 15,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 50, max: 150 },\r\n      size: { min: 2, max: 5 },\r\n      life: { min: 0.2, max: 0.4 },\r\n      colors: ['#ffff00', '#ffffff', '#ffff88'],\r\n      type: ParticleType.Spark,\r\n    });\r\n    \r\n    // Electric arcs (glitch particles)\r\n    this.emit({\r\n      count: 8,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 20, max: 60 },\r\n      size: { min: 4, max: 8 },\r\n      life: { min: 0.3, max: 0.6 },\r\n      colors: ['#00ffff', '#88ffff'],\r\n      type: ParticleType.Glitch,\r\n    });\r\n  }\r\n\r\n  /** Marked target indicator */\r\n  markedEffect(position: Vector2): void {\r\n    this.emit({\r\n      count: 6,\r\n      position,\r\n      spread: Math.PI * 2,\r\n      speed: { min: 10, max: 30 },\r\n      size: { min: 3, max: 5 },\r\n      life: { min: 0.5, max: 1.0 },\r\n      colors: ['#ff0000', '#ff4444'],\r\n      type: ParticleType.Energy,\r\n      gravity: -20,\r\n    });\r\n  }\r\n\r\n  clear(): void {\r\n    this.particles = [];\r\n  }\r\n\r\n  getParticleCount(): number {\r\n    return this.particles.length;\r\n  }\r\n\r\n  private colorWithAlpha(hex: string, alpha: number): string {\r\n    // Handle hex colors\r\n    if (hex.startsWith('#')) {\r\n      const r = parseInt(hex.slice(1, 3), 16);\r\n      const g = parseInt(hex.slice(3, 5), 16);\r\n      const b = parseInt(hex.slice(5, 7), 16);\r\n      return `rgba(${r}, ${g}, ${b}, ${alpha})`;\r\n    }\r\n    // Handle existing rgba\r\n    if (hex.startsWith('rgba')) {\r\n      return hex.replace(/[\\d.]+\\)$/, `${alpha})`);\r\n    }\r\n    return hex;\r\n  }\r\n}\r\n","// ============================================================================\r\n// GAME RENDERER - Draws the game world\r\n// ============================================================================\r\n\r\nimport { Renderer } from '@/engine/Renderer';\r\nimport { GameWorld } from '@/game/GameWorld';\r\nimport { Player } from '@/game/entities/Player';\r\nimport { Projectile } from '@/game/entities/Projectile';\r\nimport { COLORS, HEROES } from '@/shared/constants';\r\nimport { lerp, formatTime } from '@/shared/utils';\r\nimport { Team, GamePhase, Vector2 } from '@/shared/types';\r\nimport { ParticleSystem } from '@/game/effects/ParticleSystem';\r\nimport { VisualEffectType } from '@/game/systems/AbilitySystem';\r\nimport { EffectType } from '@/game/systems/EffectSystem';\r\n\r\n// Track muzzle flashes for visual feedback\r\ninterface MuzzleFlash {\r\n  position: Vector2;\r\n  direction: number;\r\n  time: number;\r\n}\r\n\r\n// Track bullet tracers (for hitscan visualization)\r\ninterface BulletTracer {\r\n  start: Vector2;\r\n  end: Vector2;\r\n  time: number;\r\n  isEnemy: boolean;\r\n}\r\n\r\n// Confetti particle for victory celebration\r\ninterface ConfettiParticle {\r\n  x: number;\r\n  y: number;\r\n  vx: number;\r\n  vy: number;\r\n  rotation: number;\r\n  rotationSpeed: number;\r\n  width: number;\r\n  height: number;\r\n  color: string;\r\n  life: number;\r\n  maxLife: number;\r\n}\r\n\r\nexport class GameRenderer {\r\n  private renderer: Renderer;\r\n  private world: GameWorld;\r\n  private muzzleFlashes: MuzzleFlash[] = [];\r\n  private bulletTracers: BulletTracer[] = [];\r\n  private particleSystem: ParticleSystem;\r\n  \r\n  // Match end celebration/defeat effects\r\n  private matchEndConfetti: ConfettiParticle[] = [];\r\n  private matchEndStartTime: number = 0;\r\n  private lastMatchEndPhase: boolean = false;\r\n  \r\n  // App version\r\n  private appVersion: string;\r\n\r\n  constructor(renderer: Renderer, world: GameWorld, appVersion: string) {\r\n    this.renderer = renderer;\r\n    this.world = world;\r\n    this.appVersion = appVersion;\r\n    this.particleSystem = new ParticleSystem();\r\n  }\r\n\r\n  render(alpha: number): void {\r\n    this.renderer.beginFrame();\r\n\r\n    // Camera follows local player\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    if (localPlayer) {\r\n      // Interpolate camera position\r\n      const interpX = lerp(localPlayer.prevPosition.x, localPlayer.position.x, alpha);\r\n      const interpY = lerp(localPlayer.prevPosition.y, localPlayer.position.y, alpha);\r\n      this.renderer.setCamera(interpX, interpY, 1);\r\n    } else {\r\n      // Center on map\r\n      this.renderer.setCamera(\r\n        this.world.getMap().getWidth() / 2,\r\n        this.world.getMap().getHeight() / 2,\r\n        0.8\r\n      );\r\n    }\r\n\r\n    // Begin world-space rendering\r\n    this.renderer.beginWorld();\r\n\r\n    // Draw map\r\n    this.renderMap();\r\n\r\n    // Draw ability effects (below players) - old system\r\n    this.renderAbilityEffects();\r\n    \r\n    // Draw new visual effects from AbilitySystem\r\n    this.renderVisualEffects(alpha);\r\n\r\n    // Draw players\r\n    for (const player of this.world.getPlayers()) {\r\n      this.renderPlayer(player, alpha, player.id === localPlayer?.id);\r\n    }\r\n\r\n    // Draw projectiles\r\n    for (const projectile of this.world.getProjectiles()) {\r\n      this.renderProjectile(projectile, alpha);\r\n    }\r\n\r\n    // Draw bullet tracers (for hitscan weapons)\r\n    this.renderBulletTracers();\r\n\r\n    // Draw muzzle flashes\r\n    this.renderMuzzleFlashes();\r\n\r\n    // Draw particles\r\n    this.particleSystem.render(this.renderer);\r\n\r\n    this.renderer.endWorld();\r\n\r\n    // Draw UI (screen-space)\r\n    this.renderUI();\r\n\r\n    this.renderer.endFrame();\r\n  }\r\n\r\n  private renderMap(): void {\r\n    const map = this.world.getMap();\r\n    const tileSize = map.getTileSize();\r\n    const tiles = map.data.tiles;\r\n\r\n    // Get visible area\r\n    const offset = this.renderer.getCameraOffset();\r\n    const zoom = this.renderer.getCameraZoom();\r\n    const viewWidth = this.renderer.getWidth() / zoom;\r\n    const viewHeight = this.renderer.getHeight() / zoom;\r\n\r\n    const startX = Math.max(0, Math.floor(offset.x / tileSize));\r\n    const startY = Math.max(0, Math.floor(offset.y / tileSize));\r\n    const endX = Math.min(tiles[0]?.length ?? 0, Math.ceil((offset.x + viewWidth) / tileSize) + 1);\r\n    const endY = Math.min(tiles.length, Math.ceil((offset.y + viewHeight) / tileSize) + 1);\r\n\r\n    // Draw floor\r\n    this.renderer.drawRect(\r\n      0, 0,\r\n      map.getWidth(), map.getHeight(),\r\n      { fill: '#151520' }\r\n    );\r\n\r\n    // Draw grid\r\n    this.renderer.drawDebugGrid(tileSize, '#1a1a2a');\r\n\r\n    // Draw walls\r\n    for (let y = startY; y < endY; y++) {\r\n      const row = tiles[y];\r\n      if (!row) continue;\r\n      \r\n      for (let x = startX; x < endX; x++) {\r\n        const tile = row[x];\r\n        if (tile === 1) {\r\n          this.renderer.drawRect(\r\n            x * tileSize,\r\n            y * tileSize,\r\n            tileSize,\r\n            tileSize,\r\n            { fill: '#2a2a3a', stroke: '#3a3a4a', strokeWidth: 1 }\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    // Draw spike sites\r\n    for (let i = 0; i < map.data.spikeSites.length; i++) {\r\n      const site = map.data.spikeSites[i]!;\r\n      this.renderer.drawNeonRect(\r\n        site,\r\n        i === 0 ? COLORS.CYAN : COLORS.MAGENTA,\r\n        0.5\r\n      );\r\n      \r\n      this.renderer.drawText(\r\n        `SITE ${String.fromCharCode(65 + i)}`,\r\n        site.x + site.width / 2,\r\n        site.y + site.height / 2,\r\n        { color: '#fff', align: 'center', baseline: 'middle', size: 16 }\r\n      );\r\n    }\r\n\r\n    // Draw planted spike\r\n    const objectives = this.world.getObjectives();\r\n    if (objectives.spikePlanted && objectives.spikePosition) {\r\n      const spikeX = objectives.spikePosition.x;\r\n      const spikeY = objectives.spikePosition.y;\r\n      const pulse = Math.sin(this.world.getAbsoluteTime() * 0.01) * 0.3 + 0.7;\r\n      \r\n      // Outer glow\r\n      this.renderer.drawCircle(spikeX, spikeY, 25 + pulse * 5, {\r\n        fill: `rgba(255, 50, 50, ${pulse * 0.3})`,\r\n        glow: true,\r\n        glowColor: '#ff0000',\r\n        glowSize: 20,\r\n      });\r\n      \r\n      // Spike device (hexagon-ish)\r\n      this.renderer.drawCircle(spikeX, spikeY, 15, {\r\n        fill: '#ff2222',\r\n        stroke: '#ff6666',\r\n        strokeWidth: 3,\r\n        glow: true,\r\n        glowColor: '#ff0000',\r\n        glowSize: 15,\r\n      });\r\n      \r\n      // Inner core\r\n      this.renderer.drawCircle(spikeX, spikeY, 6, {\r\n        fill: '#ffffff',\r\n        glow: true,\r\n        glowColor: '#ff0000',\r\n        glowSize: 8,\r\n      });\r\n      \r\n      // \"SPIKE\" text\r\n      this.renderer.drawText(\r\n        ' SPIKE',\r\n        spikeX, spikeY - 35,\r\n        { color: '#ff4444', align: 'center', size: 12 }\r\n      );\r\n      \r\n      // Upload progress bar\r\n      const barWidth = 60;\r\n      const barHeight = 8;\r\n      const barX = spikeX - barWidth / 2;\r\n      const barY = spikeY + 25;\r\n      \r\n      // Background\r\n      this.renderer.drawRect(barX, barY, barWidth, barHeight, {\r\n        fill: 'rgba(0, 0, 0, 0.7)',\r\n        stroke: '#ff4444',\r\n        strokeWidth: 1,\r\n      });\r\n      \r\n      // Progress fill\r\n      const progress = objectives.spikeProgress;\r\n      if (progress > 0) {\r\n        this.renderer.drawRect(barX + 1, barY + 1, (barWidth - 2) * progress, barHeight - 2, {\r\n          fill: progress > 0.7 ? '#ff0000' : '#ff4444',\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  private renderPlayer(player: Player, alpha: number, isLocal: boolean): void {\r\n    // Interpolate position\r\n    const x = lerp(player.prevPosition.x, player.position.x, alpha);\r\n    const y = lerp(player.prevPosition.y, player.position.y, alpha);\r\n    const rotation = player.rotation; // TODO: interpolate rotation\r\n\r\n    // Player body color based on team\r\n    const bodyColor = player.team === Team.Attackers ? COLORS.ATTACKER : COLORS.DEFENDER;\r\n    const glowColor = isLocal ? COLORS.CYAN : bodyColor;\r\n\r\n    // Handle invisibility (cloak)\r\n    const isInvisible = player.isInvisible && !isLocal;\r\n    if (isInvisible) {\r\n      // Don't render invisible enemies\r\n      return;\r\n    }\r\n\r\n    // Handle dead players - fade out corpse after death\r\n    if (!player.alive) {\r\n      const timeSinceDeath = this.world.getAbsoluteTime() - player.deathTime;\r\n      const fadeOutDuration = 1000; // 1 second fade out\r\n      \r\n      // Don't render if fully faded\r\n      if (timeSinceDeath > fadeOutDuration) {\r\n        return;\r\n      }\r\n      \r\n      // Calculate fade alpha\r\n      const fadeAlpha = 1 - (timeSinceDeath / fadeOutDuration);\r\n      const corpseColor = `rgba(51, 51, 51, ${fadeAlpha})`;\r\n      \r\n      // Draw fading corpse\r\n      this.renderer.drawCircle(x, y, 16, {\r\n        fill: corpseColor,\r\n        stroke: `rgba(100, 100, 100, ${fadeAlpha * 0.5})`,\r\n        strokeWidth: 2,\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Draw player circle (alive)\r\n    this.renderer.drawCircle(x, y, 16, {\r\n      fill: player.isInvisible ? `${bodyColor}4D` : bodyColor,\r\n      stroke: player.isInvisible ? `${glowColor}4D` : glowColor,\r\n      strokeWidth: isLocal ? 3 : 2,\r\n      glow: isLocal && !player.isInvisible,\r\n      glowColor: glowColor,\r\n      glowSize: 10,\r\n    });\r\n\r\n    // Draw facing direction\r\n    if (player.alive) {\r\n      const facingX = x + Math.cos(rotation) * 20;\r\n      const facingY = y + Math.sin(rotation) * 20;\r\n      \r\n      this.renderer.drawLine(x, y, facingX, facingY, {\r\n        color: player.isInvisible ? 'rgba(255,255,255,0.3)' : '#fff',\r\n        width: 2,\r\n      });\r\n\r\n      // Draw weapon aim indicator\r\n      const aimX = x + Math.cos(rotation) * 30;\r\n      const aimY = y + Math.sin(rotation) * 30;\r\n      \r\n      this.renderer.drawCircle(aimX, aimY, 4, {\r\n        fill: player.isInvisible ? `${COLORS.CYAN}4D` : COLORS.CYAN,\r\n        glow: !player.isInvisible,\r\n        glowColor: COLORS.CYAN,\r\n        glowSize: 5,\r\n      });\r\n\r\n      // Draw stun indicator\r\n      if (player.isStunned) {\r\n        this.renderer.drawCircle(x, y - 25, 8, {\r\n          fill: 'rgba(255, 255, 0, 0.8)',\r\n          glow: true,\r\n          glowColor: COLORS.YELLOW,\r\n          glowSize: 10,\r\n        });\r\n      }\r\n\r\n      // Draw marked indicator (target symbol) - for enemies marked by Zero\r\n      const markedEffect = this.world.getEffectSystem().getEffect(player.id, EffectType.Marked);\r\n      if (markedEffect) {\r\n        const pulse = Math.sin(this.world.getAbsoluteTime() * 0.01) * 0.3 + 0.7;\r\n        \r\n        // Draw pulsing red ring around the marked player\r\n        this.renderer.drawCircle(x, y, 28 + pulse * 5, {\r\n          stroke: `rgba(255, 50, 50, ${pulse})`,\r\n          strokeWidth: 3,\r\n          glow: true,\r\n          glowColor: '#ff0000',\r\n          glowSize: 15,\r\n        });\r\n        \r\n        // Draw crosshair/target above player\r\n        const targetY = y - 55;\r\n        this.renderer.drawCircle(x, targetY, 10, {\r\n          stroke: '#ff4444',\r\n          strokeWidth: 2,\r\n          glow: true,\r\n          glowColor: '#ff0000',\r\n          glowSize: 10,\r\n        });\r\n        // Crosshair lines\r\n        this.renderer.drawLine(x - 16, targetY, x - 6, targetY, { color: '#ff4444', width: 2 });\r\n        this.renderer.drawLine(x + 6, targetY, x + 16, targetY, { color: '#ff4444', width: 2 });\r\n        this.renderer.drawLine(x, targetY - 16, x, targetY - 6, { color: '#ff4444', width: 2 });\r\n        this.renderer.drawLine(x, targetY + 6, x, targetY + 16, { color: '#ff4444', width: 2 });\r\n        \r\n        // Draw \"MARKED\" text\r\n        this.renderer.drawText(\r\n          ' MARKED',\r\n          x, y - 72,\r\n          { color: '#ff4444', align: 'center', size: 10 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Draw health bar above player\r\n    this.renderer.drawHealthBar(\r\n      x - 20, y - 30,\r\n      40, 6,\r\n      player.health, player.maxHealth,\r\n      player.shield, player.maxShield\r\n    );\r\n\r\n    // Draw name\r\n    this.renderer.drawText(\r\n      player.name,\r\n      x, y - 40,\r\n      { color: '#fff', align: 'center', size: 10 }\r\n    );\r\n\r\n    // Draw hero icon/indicator\r\n    const heroDef = HEROES[player.heroId];\r\n    this.renderer.drawText(\r\n      heroDef.name.charAt(0),\r\n      x, y,\r\n      { \r\n        color: '#fff', \r\n        align: 'center', \r\n        baseline: 'middle', \r\n        size: 14,\r\n        glow: true,\r\n        glowColor: '#000',\r\n        glowSize: 2,\r\n      }\r\n    );\r\n\r\n    // Draw spike carrier indicator (Data Spike mode)\r\n    const objectives = this.world.getObjectives();\r\n    if (objectives.spikeCarrierId === player.id && !objectives.spikePlanted) {\r\n      const pulse = Math.sin(this.world.getAbsoluteTime() * 0.008) * 0.2 + 0.8;\r\n      \r\n      // Spike icon above player\r\n      this.renderer.drawText(\r\n        '',\r\n        x + 25, y - 10,\r\n        { color: '#ff4444', align: 'center', size: 14 }\r\n      );\r\n      \r\n      // Glow ring to indicate carrier\r\n      this.renderer.drawCircle(x, y, 22, {\r\n        stroke: `rgba(255, 100, 50, ${pulse})`,\r\n        strokeWidth: 2,\r\n      });\r\n    }\r\n\r\n    // Draw planting progress bar\r\n    // Use peerId for comparison since entity IDs differ between host and client\r\n    const isPlanting = (objectives.plantingPeerId === player.peerId || objectives.plantingPlayerId === player.id) && objectives.plantingProgress > 0;\r\n    if (isPlanting) {\r\n      const barWidth = 50;\r\n      const barHeight = 6;\r\n      const barX = x - barWidth / 2;\r\n      const barY = y + 30;\r\n      \r\n      // Background\r\n      this.renderer.drawRect(barX, barY, barWidth, barHeight, {\r\n        fill: 'rgba(0, 0, 0, 0.8)',\r\n        stroke: '#ff8800',\r\n        strokeWidth: 1,\r\n      });\r\n      \r\n      // Progress\r\n      this.renderer.drawRect(barX + 1, barY + 1, (barWidth - 2) * objectives.plantingProgress, barHeight - 2, {\r\n        fill: '#ff8800',\r\n      });\r\n      \r\n      // Label\r\n      this.renderer.drawText(\r\n        'PLANTING...',\r\n        x, barY + barHeight + 10,\r\n        { color: '#ff8800', align: 'center', size: 8 }\r\n      );\r\n    }\r\n\r\n    // Draw defusing progress bar\r\n    // Use peerId for comparison since entity IDs differ between host and client\r\n    const isDefusing = (objectives.defusingPeerId === player.peerId || objectives.defusingPlayerId === player.id) && objectives.defusingProgress > 0;\r\n    if (isDefusing) {\r\n      const barWidth = 50;\r\n      const barHeight = 6;\r\n      const barX = x - barWidth / 2;\r\n      const barY = y + 30;\r\n      \r\n      // Background\r\n      this.renderer.drawRect(barX, barY, barWidth, barHeight, {\r\n        fill: 'rgba(0, 0, 0, 0.8)',\r\n        stroke: '#00ff88',\r\n        strokeWidth: 1,\r\n      });\r\n      \r\n      // Progress\r\n      this.renderer.drawRect(barX + 1, barY + 1, (barWidth - 2) * objectives.defusingProgress, barHeight - 2, {\r\n        fill: '#00ff88',\r\n      });\r\n      \r\n      // Label\r\n      this.renderer.drawText(\r\n        'DEFUSING...',\r\n        x, barY + barHeight + 10,\r\n        { color: '#00ff88', align: 'center', size: 8 }\r\n      );\r\n    }\r\n  }\r\n\r\n  private renderProjectile(projectile: Projectile, _alpha: number): void {\r\n    const x = projectile.position.x;\r\n    const y = projectile.position.y;\r\n\r\n    // Draw projectile as a glowing circle\r\n    this.renderer.drawCircle(x, y, 4, {\r\n      fill: COLORS.YELLOW,\r\n      glow: true,\r\n      glowColor: COLORS.YELLOW,\r\n      glowSize: 8,\r\n    });\r\n\r\n    // Draw trail\r\n    const trailX = x - projectile.velocity.x * 0.02;\r\n    const trailY = y - projectile.velocity.y * 0.02;\r\n    this.renderer.drawLine(trailX, trailY, x, y, {\r\n      color: COLORS.YELLOW,\r\n      width: 2,\r\n    });\r\n  }\r\n\r\n  private renderMuzzleFlashes(): void {\r\n    const now = performance.now();\r\n    \r\n    // Filter out old flashes (older than 100ms)\r\n    this.muzzleFlashes = this.muzzleFlashes.filter(flash => now - flash.time < 100);\r\n\r\n    for (const flash of this.muzzleFlashes) {\r\n      const age = now - flash.time;\r\n      const alpha = 1 - (age / 100);\r\n      const size = 15 + age * 0.2;\r\n\r\n      // Draw muzzle flash\r\n      this.renderer.drawCircle(\r\n        flash.position.x + Math.cos(flash.direction) * 25,\r\n        flash.position.y + Math.sin(flash.direction) * 25,\r\n        size * alpha,\r\n        {\r\n          fill: `rgba(255, 200, 100, ${alpha * 0.8})`,\r\n          glow: true,\r\n          glowColor: COLORS.YELLOW,\r\n          glowSize: 15 * alpha,\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  private renderAbilityEffects(): void {\r\n    const effects = this.world.getAbilityEffects();\r\n    const currentTime = this.world.getTime();\r\n\r\n    for (const effect of effects) {\r\n      const elapsed = currentTime - effect.startTime;\r\n      const progress = elapsed / effect.duration;\r\n      const alpha = 1 - progress;\r\n\r\n      switch (effect.type) {\r\n        case 'shield':\r\n          this.renderShieldEffect(effect, alpha);\r\n          break;\r\n        case 'shockwave':\r\n          this.renderShockwaveEffect(effect, progress);\r\n          break;\r\n        case 'dash':\r\n          this.renderDashEffect(effect, alpha);\r\n          break;\r\n        case 'cloak':\r\n          // Cloak is handled in player rendering\r\n          break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private renderShieldEffect(effect: { position: { x: number; y: number }; direction: number; radius?: number }, alpha: number): void {\r\n    const { position, direction, radius = 60 } = effect;\r\n    \r\n    // Draw arc shield in front of player\r\n    const arcStart = direction - Math.PI / 3;\r\n    const arcEnd = direction + Math.PI / 3;\r\n    \r\n    // Draw multiple arcs for shield effect\r\n    for (let i = 0; i < 3; i++) {\r\n      const r = radius + i * 8;\r\n      const a = alpha * (1 - i * 0.2);\r\n      \r\n      this.renderer.drawArc(\r\n        position.x,\r\n        position.y,\r\n        r,\r\n        arcStart,\r\n        arcEnd,\r\n        {\r\n          stroke: `rgba(100, 200, 255, ${a * 0.8})`,\r\n          strokeWidth: 4 - i,\r\n          glow: true,\r\n          glowColor: COLORS.CYAN,\r\n          glowSize: 10,\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  private renderShockwaveEffect(effect: { position: { x: number; y: number }; radius?: number }, progress: number): void {\r\n    const { position, radius = 120 } = effect;\r\n    \r\n    // Expanding ring\r\n    const currentRadius = radius * progress;\r\n    const alpha = 1 - progress;\r\n    \r\n    this.renderer.drawCircle(\r\n      position.x,\r\n      position.y,\r\n      currentRadius,\r\n      {\r\n        stroke: `rgba(255, 150, 50, ${alpha * 0.9})`,\r\n        strokeWidth: 6 * (1 - progress),\r\n        glow: true,\r\n        glowColor: '#ff9933',\r\n        glowSize: 20 * alpha,\r\n      }\r\n    );\r\n\r\n    // Inner flash\r\n    if (progress < 0.3) {\r\n      const flashAlpha = 1 - (progress / 0.3);\r\n      this.renderer.drawCircle(\r\n        position.x,\r\n        position.y,\r\n        radius * 0.3,\r\n        {\r\n          fill: `rgba(255, 200, 100, ${flashAlpha * 0.5})`,\r\n          glow: true,\r\n          glowColor: COLORS.YELLOW,\r\n          glowSize: 30 * flashAlpha,\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  private renderDashEffect(effect: { position: { x: number; y: number }; direction: number; radius?: number }, alpha: number): void {\r\n    const { position, direction, radius = 100 } = effect;\r\n    \r\n    // Trail effect\r\n    const trailEnd = {\r\n      x: position.x - Math.cos(direction) * radius,\r\n      y: position.y - Math.sin(direction) * radius,\r\n    };\r\n\r\n    this.renderer.drawLine(\r\n      trailEnd.x,\r\n      trailEnd.y,\r\n      position.x,\r\n      position.y,\r\n      {\r\n        color: `rgba(255, 100, 100, ${alpha * 0.8})`,\r\n        width: 8,\r\n        glow: true,\r\n        glowColor: COLORS.MAGENTA,\r\n        glowSize: 15,\r\n      }\r\n    );\r\n  }\r\n\r\n  private renderVisualEffects(interpAlpha: number): void {\r\n    const effects = this.world.getVisualEffects();\r\n    const currentTime = this.world.getTime();\r\n\r\n    // Debug: Check if there are multiple barrier effects\r\n    const barrierEffects = effects.filter(e => e.type === VisualEffectType.BarrierWall);\r\n    if (barrierEffects.length > 1) {\r\n      console.warn(`[VFX] Multiple barrier effects: ${barrierEffects.length}`);\r\n    }\r\n\r\n    for (const effect of effects) {\r\n      const elapsed = currentTime - effect.startTime;\r\n      const progress = Math.max(0, Math.min(1, elapsed / effect.duration));\r\n      const fadeAlpha = Math.max(0, Math.min(1, 1 - progress));\r\n\r\n      // Get position and direction - follow player if followPlayerId is set\r\n      let effectPosition = effect.position;\r\n      let effectDirection = effect.direction || 0;\r\n      \r\n      if (effect.followPlayerId) {\r\n        const player = this.world.getPlayer(effect.followPlayerId);\r\n        if (player && player.alive) {\r\n          // Use interpolated position for smooth movement (same as player rendering)\r\n          effectPosition = {\r\n            x: lerp(player.prevPosition.x, player.position.x, interpAlpha),\r\n            y: lerp(player.prevPosition.y, player.position.y, interpAlpha)\r\n          };\r\n          effectDirection = player.rotation;\r\n        }\r\n      }\r\n\r\n      switch (effect.type) {\r\n        case VisualEffectType.Blink:\r\n        case VisualEffectType.BlinkTrail:\r\n          this.renderBlinkEffect(effectPosition, fadeAlpha);\r\n          break;\r\n\r\n        case VisualEffectType.Shockwave:\r\n          this.renderNewShockwaveEffect(effectPosition, progress, effect.radius || 128);\r\n          break;\r\n\r\n        case VisualEffectType.Shield:\r\n          this.renderNewShieldEffect(effectPosition, fadeAlpha, effect.color || COLORS.CYAN);\r\n          break;\r\n\r\n        case VisualEffectType.DomeShield:\r\n          this.renderDomeShieldEffect(effectPosition, fadeAlpha, effect.radius || 160);\r\n          break;\r\n\r\n        case VisualEffectType.BarrierWall:\r\n          this.renderBarrierWallEffect(effectPosition, effectDirection, fadeAlpha, effect.color || COLORS.CYAN);\r\n          break;\r\n\r\n        case VisualEffectType.HealBurst:\r\n        case VisualEffectType.HealingField:\r\n          this.renderHealingEffect(effectPosition, progress, effect.radius || 160);\r\n          break;\r\n\r\n        case VisualEffectType.PoisonCloud:\r\n          this.renderPoisonCloudEffect(effect.position, fadeAlpha, effect.radius || 128);\r\n          break;\r\n\r\n        case VisualEffectType.Explosion:\r\n          this.renderExplosionEffect(effect.position, progress, effect.radius || 80);\r\n          break;\r\n\r\n        case VisualEffectType.DashSlash:\r\n          this.renderDashSlashEffect(effect.position, effect.direction || 0, fadeAlpha);\r\n          break;\r\n\r\n        case VisualEffectType.TurretSpawn:\r\n          this.renderTurretSpawnEffect(effect.position, fadeAlpha);\r\n          break;\r\n\r\n        case VisualEffectType.Cloak:\r\n          // Cloak is handled in player rendering\r\n          break;\r\n\r\n        case VisualEffectType.Reveal:\r\n          this.renderRevealEffect(effect.position, progress);\r\n          break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private renderBlinkEffect(position: Vector2, alpha: number): void {\r\n    // Teleport flash effect\r\n    this.renderer.drawCircle(position.x, position.y, 30 * alpha, {\r\n      fill: `rgba(100, 200, 255, ${alpha * 0.5})`,\r\n      stroke: `rgba(150, 230, 255, ${alpha})`,\r\n      strokeWidth: 3,\r\n      glow: true,\r\n      glowColor: COLORS.CYAN,\r\n      glowSize: 20 * alpha,\r\n    });\r\n    \r\n    // Particles\r\n    for (let i = 0; i < 8; i++) {\r\n      const angle = (i / 8) * Math.PI * 2;\r\n      const dist = 20 + (1 - alpha) * 40;\r\n      const px = position.x + Math.cos(angle) * dist;\r\n      const py = position.y + Math.sin(angle) * dist;\r\n      this.renderer.drawCircle(px, py, 4 * alpha, {\r\n        fill: COLORS.CYAN,\r\n        glow: true,\r\n        glowColor: COLORS.CYAN,\r\n        glowSize: 5,\r\n      });\r\n    }\r\n  }\r\n\r\n  private renderNewShockwaveEffect(position: Vector2, progress: number, maxRadius: number): void {\r\n    const radius = maxRadius * progress;\r\n    const alpha = 1 - progress;\r\n    \r\n    // Expanding ring\r\n    this.renderer.drawCircle(position.x, position.y, radius, {\r\n      stroke: `rgba(255, 150, 50, ${alpha * 0.9})`,\r\n      strokeWidth: 8 * (1 - progress),\r\n      glow: true,\r\n      glowColor: '#ff9933',\r\n      glowSize: 20 * alpha,\r\n    });\r\n    \r\n    // Secondary inner ring\r\n    if (progress < 0.5) {\r\n      const innerAlpha = 1 - (progress / 0.5);\r\n      this.renderer.drawCircle(position.x, position.y, radius * 0.6, {\r\n        stroke: `rgba(255, 200, 100, ${innerAlpha * 0.7})`,\r\n        strokeWidth: 4,\r\n      });\r\n    }\r\n  }\r\n\r\n  private renderNewShieldEffect(position: Vector2, alpha: number, color: string): void {\r\n    // Shield bubble\r\n    this.renderer.drawCircle(position.x, position.y, 35, {\r\n      fill: `rgba(100, 200, 255, ${alpha * 0.2})`,\r\n      stroke: color,\r\n      strokeWidth: 3 * alpha,\r\n      glow: true,\r\n      glowColor: color,\r\n      glowSize: 15 * alpha,\r\n    });\r\n  }\r\n\r\n  private renderDomeShieldEffect(position: Vector2, alpha: number, radius: number): void {\r\n    // Large dome shield\r\n    this.renderer.drawCircle(position.x, position.y, radius, {\r\n      fill: `rgba(100, 200, 255, ${alpha * 0.15})`,\r\n      stroke: `rgba(150, 230, 255, ${alpha * 0.8})`,\r\n      strokeWidth: 4,\r\n      glow: true,\r\n      glowColor: COLORS.CYAN,\r\n      glowSize: 25 * alpha,\r\n    });\r\n    \r\n    // Hexagonal pattern overlay\r\n    for (let i = 0; i < 6; i++) {\r\n      const angle = (i / 6) * Math.PI * 2;\r\n      const px = position.x + Math.cos(angle) * radius * 0.7;\r\n      const py = position.y + Math.sin(angle) * radius * 0.7;\r\n      this.renderer.drawCircle(px, py, 8, {\r\n        stroke: `rgba(200, 240, 255, ${alpha * 0.5})`,\r\n        strokeWidth: 2,\r\n      });\r\n    }\r\n  }\r\n\r\n  private renderBarrierWallEffect(position: Vector2, direction: number, alpha: number, color: string): void {\r\n    // Ensure alpha is clamped (defensive)\r\n    const safeAlpha = Math.max(0, Math.min(1, alpha));\r\n    \r\n    // Front-facing arc shield (120 degree arc in front of player)\r\n    const radius = 45;\r\n    const arcAngle = Math.PI * (2/3); // 120 degrees\r\n    const startAngle = direction - arcAngle / 2;\r\n    const endAngle = direction + arcAngle / 2;\r\n    \r\n    const ctx = this.renderer.getContext();\r\n    ctx.save();\r\n    \r\n    // Draw the arc shield\r\n    ctx.beginPath();\r\n    ctx.arc(position.x, position.y, radius, startAngle, endAngle);\r\n    ctx.strokeStyle = color;\r\n    ctx.lineWidth = 8 * safeAlpha;\r\n    ctx.lineCap = 'round';\r\n    \r\n    // Glow effect\r\n    ctx.shadowColor = color;\r\n    ctx.shadowBlur = 20 * safeAlpha;\r\n    ctx.stroke();\r\n    \r\n    // Inner lighter arc\r\n    ctx.beginPath();\r\n    ctx.arc(position.x, position.y, radius - 4, startAngle + 0.1, endAngle - 0.1);\r\n    ctx.strokeStyle = `rgba(255, 255, 255, ${safeAlpha * 0.6})`;\r\n    ctx.lineWidth = 3 * safeAlpha;\r\n    ctx.stroke();\r\n    \r\n    // Add small energy nodes at ends of arc\r\n    for (const angle of [startAngle, endAngle]) {\r\n      const nx = position.x + Math.cos(angle) * radius;\r\n      const ny = position.y + Math.sin(angle) * radius;\r\n      ctx.beginPath();\r\n      ctx.arc(nx, ny, 6 * safeAlpha, 0, Math.PI * 2);\r\n      ctx.fillStyle = color;\r\n      ctx.fill();\r\n    }\r\n    \r\n    // Add energy segments along the arc\r\n    const segments = 5;\r\n    for (let i = 1; i < segments; i++) {\r\n      const segAngle = startAngle + (arcAngle * i / segments);\r\n      const sx = position.x + Math.cos(segAngle) * radius;\r\n      const sy = position.y + Math.sin(segAngle) * radius;\r\n      ctx.beginPath();\r\n      ctx.arc(sx, sy, 3 * safeAlpha, 0, Math.PI * 2);\r\n      ctx.fillStyle = `rgba(255, 255, 255, ${safeAlpha * 0.8})`;\r\n      ctx.fill();\r\n    }\r\n    \r\n    ctx.restore();\r\n  }\r\n\r\n  private renderHealingEffect(position: Vector2, progress: number, radius: number): void {\r\n    const alpha = 1 - progress * 0.5; // Fade slower\r\n    \r\n    // Healing field circle\r\n    this.renderer.drawCircle(position.x, position.y, radius, {\r\n      fill: `rgba(100, 255, 150, ${alpha * 0.1})`,\r\n      stroke: `rgba(100, 255, 150, ${alpha * 0.6})`,\r\n      strokeWidth: 2,\r\n    });\r\n    \r\n    // Rising heal particles\r\n    const particleCount = 6;\r\n    for (let i = 0; i < particleCount; i++) {\r\n      const angle = (i / particleCount) * Math.PI * 2 + progress * 2;\r\n      const dist = radius * 0.5;\r\n      const px = position.x + Math.cos(angle) * dist;\r\n      const py = position.y + Math.sin(angle) * dist - progress * 30;\r\n      this.renderer.drawText('+', px, py, {\r\n        color: `rgba(100, 255, 150, ${alpha})`,\r\n        size: 16,\r\n        align: 'center',\r\n        baseline: 'middle',\r\n      });\r\n    }\r\n  }\r\n\r\n  private renderPoisonCloudEffect(position: Vector2, alpha: number, radius: number): void {\r\n    // Toxic cloud\r\n    this.renderer.drawCircle(position.x, position.y, radius, {\r\n      fill: `rgba(100, 200, 50, ${alpha * 0.3})`,\r\n      stroke: `rgba(150, 220, 80, ${alpha * 0.6})`,\r\n      strokeWidth: 3,\r\n    });\r\n    \r\n    // Bubbling particles\r\n    for (let i = 0; i < 5; i++) {\r\n      const angle = (i / 5) * Math.PI * 2;\r\n      const dist = radius * (0.3 + Math.random() * 0.5);\r\n      const px = position.x + Math.cos(angle) * dist;\r\n      const py = position.y + Math.sin(angle) * dist;\r\n      this.renderer.drawCircle(px, py, 5 + Math.random() * 10, {\r\n        fill: `rgba(120, 200, 60, ${alpha * 0.4})`,\r\n      });\r\n    }\r\n  }\r\n\r\n  private renderExplosionEffect(position: Vector2, progress: number, radius: number): void {\r\n    const currentRadius = radius * progress;\r\n    const alpha = 1 - progress;\r\n    \r\n    // Main explosion\r\n    this.renderer.drawCircle(position.x, position.y, currentRadius, {\r\n      fill: `rgba(255, 150, 50, ${alpha * 0.6})`,\r\n      glow: true,\r\n      glowColor: '#ff6600',\r\n      glowSize: 30 * alpha,\r\n    });\r\n    \r\n    // Core\r\n    if (progress < 0.3) {\r\n      const coreAlpha = 1 - (progress / 0.3);\r\n      this.renderer.drawCircle(position.x, position.y, currentRadius * 0.5, {\r\n        fill: `rgba(255, 255, 200, ${coreAlpha})`,\r\n      });\r\n    }\r\n  }\r\n\r\n  private renderDashSlashEffect(position: Vector2, direction: number, alpha: number): void {\r\n    // Slash arc\r\n    const arcStart = direction - Math.PI / 4;\r\n    const arcEnd = direction + Math.PI / 4;\r\n    \r\n    this.renderer.drawArc(position.x, position.y, 40, arcStart, arcEnd, {\r\n      stroke: `rgba(255, 100, 100, ${alpha})`,\r\n      strokeWidth: 6 * alpha,\r\n      glow: true,\r\n      glowColor: COLORS.MAGENTA,\r\n      glowSize: 15 * alpha,\r\n    });\r\n  }\r\n\r\n  private renderTurretSpawnEffect(position: Vector2, alpha: number): void {\r\n    // Spawn ring\r\n    this.renderer.drawCircle(position.x, position.y, 25, {\r\n      stroke: `rgba(255, 200, 100, ${alpha})`,\r\n      strokeWidth: 3,\r\n      glow: true,\r\n      glowColor: COLORS.YELLOW,\r\n      glowSize: 10 * alpha,\r\n    });\r\n    \r\n    // Holographic grid\r\n    for (let i = -1; i <= 1; i++) {\r\n      this.renderer.drawLine(\r\n        position.x - 20, position.y + i * 10,\r\n        position.x + 20, position.y + i * 10,\r\n        { color: `rgba(255, 200, 100, ${alpha * 0.5})`, width: 1 }\r\n      );\r\n      this.renderer.drawLine(\r\n        position.x + i * 10, position.y - 20,\r\n        position.x + i * 10, position.y + 20,\r\n        { color: `rgba(255, 200, 100, ${alpha * 0.5})`, width: 1 }\r\n      );\r\n    }\r\n  }\r\n\r\n  private renderRevealEffect(position: Vector2, progress: number): void {\r\n    const radius = 50 + progress * 100;\r\n    const alpha = 1 - progress;\r\n    \r\n    this.renderer.drawCircle(position.x, position.y, radius, {\r\n      stroke: `rgba(255, 50, 50, ${alpha * 0.8})`,\r\n      strokeWidth: 2,\r\n    });\r\n  }\r\n\r\n  private renderBulletTracers(): void {\r\n    const now = performance.now();\r\n    \r\n    // Filter out old tracers (older than 200ms)\r\n    this.bulletTracers = this.bulletTracers.filter(tracer => now - tracer.time < 200);\r\n\r\n    for (const tracer of this.bulletTracers) {\r\n      const age = now - tracer.time;\r\n      const alpha = 1 - (age / 200);\r\n      \r\n      // Different colors for player vs enemy\r\n      const tracerColor = tracer.isEnemy \r\n        ? `rgba(255, 80, 80, ${alpha * 0.9})`   // Red for enemies\r\n        : `rgba(100, 255, 255, ${alpha * 0.9})`; // Cyan for player\r\n      const impactColor = tracer.isEnemy\r\n        ? `rgba(255, 100, 100, ${alpha * 0.8})`\r\n        : `rgba(100, 255, 200, ${alpha * 0.8})`;\r\n      const glowColor = tracer.isEnemy ? COLORS.ATTACKER : COLORS.CYAN;\r\n      \r\n      // Draw tracer line\r\n      this.renderer.drawLine(\r\n        tracer.start.x, tracer.start.y,\r\n        tracer.end.x, tracer.end.y,\r\n        {\r\n          color: tracerColor,\r\n          width: 2,\r\n        }\r\n      );\r\n      \r\n      // Draw impact point\r\n      this.renderer.drawCircle(tracer.end.x, tracer.end.y, 5 * alpha, {\r\n        fill: impactColor,\r\n        glow: true,\r\n        glowColor: glowColor,\r\n        glowSize: 10 * alpha,\r\n      });\r\n    }\r\n  }\r\n\r\n  addMuzzleFlash(position: Vector2, direction: number): void {\r\n    this.muzzleFlashes.push({\r\n      position: { ...position },\r\n      direction,\r\n      time: performance.now(),\r\n    });\r\n    // Add muzzle flash particles\r\n    this.particleSystem.muzzleFlashParticles(position, direction);\r\n  }\r\n\r\n  addBulletTracer(start: Vector2, end: Vector2, isEnemy: boolean = false): void {\r\n    this.bulletTracers.push({\r\n      start: { ...start },\r\n      end: { ...end },\r\n      time: performance.now(),\r\n      isEnemy,\r\n    });\r\n    // Add bullet impact particles at end point\r\n    const direction = { x: end.x - start.x, y: end.y - start.y };\r\n    const len = Math.sqrt(direction.x * direction.x + direction.y * direction.y);\r\n    if (len > 0) {\r\n      const normal = { x: -direction.x / len, y: -direction.y / len };\r\n      this.particleSystem.bulletImpact(end, normal);\r\n    }\r\n  }\r\n\r\n  // Particle effect methods\r\n  addPlayerDeath(position: Vector2): void {\r\n    this.particleSystem.playerDeath(position);\r\n  }\r\n\r\n  addPlayerHit(position: Vector2, direction: Vector2): void {\r\n    this.particleSystem.bulletHitPlayer(position, direction);\r\n  }\r\n\r\n  addWeaponSwitch(position: Vector2): void {\r\n    this.particleSystem.weaponSwitch(position);\r\n  }\r\n\r\n  updateParticles(dt: number): void {\r\n    this.particleSystem.update(dt);\r\n  }\r\n\r\n  private renderUI(): void {\r\n    const width = this.renderer.getWidth();\r\n    const height = this.renderer.getHeight();\r\n    const localPlayer = this.world.getLocalPlayer();\r\n\r\n    // Game pause overlay (tab focus sync)\r\n    if (this.world.isGamePaused()) {\r\n      this.renderGamePauseOverlay(width, height);\r\n    }\r\n\r\n    // Top bar - Score and time\r\n    this.renderTopBar(width);\r\n\r\n    // Bottom bar - Health, ammo, abilities\r\n    if (localPlayer && localPlayer.alive) {\r\n      this.renderBottomBar(localPlayer, width, height);\r\n    }\r\n\r\n    // Crosshair\r\n    this.renderCrosshair(width, height);\r\n\r\n    // Round state overlay\r\n    if (this.world.getPhase() !== GamePhase.RoundActive) {\r\n      this.renderPhaseOverlay(width, height);\r\n    }\r\n  }\r\n\r\n  private renderGamePauseOverlay(width: number, height: number): void {\r\n    const pausedBy = this.world.getGamePausedBy();\r\n    \r\n    // Semi-transparent dark overlay\r\n    this.renderer.drawRect(0, 0, width, height, { fill: 'rgba(0, 0, 0, 0.7)' });\r\n    \r\n    // Pause icon (two vertical bars)\r\n    const iconX = width / 2;\r\n    const iconY = height / 2 - 60;\r\n    const barWidth = 12;\r\n    const barHeight = 40;\r\n    const gap = 10;\r\n    \r\n    this.renderer.drawRect(iconX - gap - barWidth, iconY - barHeight / 2, barWidth, barHeight, {\r\n      fill: COLORS.YELLOW,\r\n      glow: true,\r\n      glowColor: COLORS.YELLOW,\r\n      glowSize: 10,\r\n    });\r\n    this.renderer.drawRect(iconX + gap, iconY - barHeight / 2, barWidth, barHeight, {\r\n      fill: COLORS.YELLOW,\r\n      glow: true,\r\n      glowColor: COLORS.YELLOW,\r\n      glowSize: 10,\r\n    });\r\n    \r\n    // Paused text\r\n    this.renderer.drawText(\r\n      'GAME PAUSED',\r\n      width / 2, height / 2,\r\n      {\r\n        color: COLORS.YELLOW,\r\n        align: 'center',\r\n        baseline: 'middle',\r\n        size: 32,\r\n        glow: true,\r\n        glowColor: COLORS.YELLOW,\r\n        glowSize: 15,\r\n      }\r\n    );\r\n    \r\n    // Who paused\r\n    this.renderer.drawText(\r\n      `${pausedBy} is away`,\r\n      width / 2, height / 2 + 40,\r\n      { color: '#aaa', align: 'center', baseline: 'middle', size: 18 }\r\n    );\r\n    \r\n    // Instructions\r\n    this.renderer.drawText(\r\n      'Waiting for all players to return...',\r\n      width / 2, height / 2 + 70,\r\n      { color: '#666', align: 'center', baseline: 'middle', size: 14 }\r\n    );\r\n  }\r\n\r\n  private renderTopBar(width: number): void {\r\n    const score = this.world.getScore();\r\n    const roundTime = this.world.getTime();\r\n    const roundTimeLimit = 180000; // 3 minutes\r\n    const remaining = Math.max(0, roundTimeLimit - roundTime);\r\n    const objectives = this.world.getObjectives();\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    const map = this.world.getMap();\r\n\r\n    // Background\r\n    this.renderer.drawRect(0, 0, width, 40, { fill: 'rgba(0,0,0,0.7)' });\r\n\r\n    // Map name and Hero name on the left side\r\n    this.renderer.drawText(\r\n      `Map: ${map.data.name}`,\r\n      15, 14,\r\n      { color: '#888', align: 'left', baseline: 'middle', size: 11 }\r\n    );\r\n    \r\n    if (localPlayer) {\r\n      const heroDef = HEROES[localPlayer.heroId];\r\n      this.renderer.drawText(\r\n        heroDef.name,\r\n        15, 28,\r\n        { color: COLORS.CYAN, align: 'left', baseline: 'middle', size: 12 }\r\n      );\r\n    }\r\n\r\n    // Attackers score\r\n    this.renderer.drawText(\r\n      `${score.attackers}`,\r\n      width / 2 - 60, 20,\r\n      { color: COLORS.ATTACKER, align: 'center', baseline: 'middle', size: 24 }\r\n    );\r\n\r\n    // Timer\r\n    this.renderer.drawText(\r\n      formatTime(remaining),\r\n      width / 2, 20,\r\n      { color: COLORS.CYAN, align: 'center', baseline: 'middle', size: 20 }\r\n    );\r\n\r\n    // Defenders score\r\n    this.renderer.drawText(\r\n      `${score.defenders}`,\r\n      width / 2 + 60, 20,\r\n      { color: COLORS.DEFENDER, align: 'center', baseline: 'middle', size: 24 }\r\n    );\r\n\r\n    // Version info (below top bar, right side - avoid spike status box)\r\n    this.renderer.drawText(\r\n      `v${this.appVersion}`,\r\n      width - 10, 48,\r\n      { color: 'rgba(255,255,255,0.4)', align: 'right', baseline: 'middle', size: 9 }\r\n    );\r\n\r\n    // Round number\r\n    this.renderer.drawText(\r\n      `Round ${this.world.getRoundNumber()}`,\r\n      width / 2, 35,\r\n      { color: '#888', align: 'center', baseline: 'middle', size: 10 }\r\n    );\r\n\r\n    // Spike status (Data Spike mode)\r\n    if (objectives.spikeCarrierId || objectives.spikePlanted) {\r\n      const spikeX = width - 150;\r\n      \r\n      if (objectives.spikePlanted) {\r\n        // Spike is planted - show upload countdown\r\n        const uploadRemaining = Math.max(0, 45000 - (this.world.getAbsoluteTime() - objectives.spikePlantTime));\r\n        const pulse = Math.sin(this.world.getAbsoluteTime() * 0.015) * 0.3 + 0.7;\r\n        \r\n        // Flashing background for urgency\r\n        this.renderer.drawRect(spikeX - 10, 5, 160, 30, {\r\n          fill: `rgba(255, 0, 0, ${pulse * 0.3})`,\r\n          stroke: '#ff4444',\r\n          strokeWidth: 2,\r\n        });\r\n        \r\n        this.renderer.drawText(\r\n          ` SPIKE PLANTED`,\r\n          spikeX + 70, 13,\r\n          { color: '#ff4444', align: 'center', size: 12 }\r\n        );\r\n        \r\n        this.renderer.drawText(\r\n          `${(uploadRemaining / 1000).toFixed(1)}s`,\r\n          spikeX + 70, 27,\r\n          { color: '#ffffff', align: 'center', size: 14 }\r\n        );\r\n      } else if (objectives.spikeCarrierId) {\r\n        // Spike not planted - show carrier status\r\n        const carrier = this.world.getPlayers().find(p => p.id === objectives.spikeCarrierId);\r\n        const isLocalCarrier = localPlayer && objectives.spikeCarrierId === localPlayer.id;\r\n        \r\n        this.renderer.drawRect(spikeX - 10, 5, 160, 30, {\r\n          fill: 'rgba(0, 0, 0, 0.5)',\r\n          stroke: isLocalCarrier ? '#ff8800' : '#666',\r\n          strokeWidth: 1,\r\n        });\r\n        \r\n        if (isLocalCarrier) {\r\n          this.renderer.drawText(\r\n            ` YOU HAVE SPIKE`,\r\n            spikeX + 70, 13,\r\n            { color: '#ff8800', align: 'center', size: 11 }\r\n          );\r\n          this.renderer.drawText(\r\n            `Hold E in site to plant`,\r\n            spikeX + 70, 27,\r\n            { color: '#aaa', align: 'center', size: 9 }\r\n          );\r\n        } else if (carrier) {\r\n          this.renderer.drawText(\r\n            ` ${carrier.name}`,\r\n            spikeX + 70, 20,\r\n            { color: '#888', align: 'center', size: 11 }\r\n          );\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private renderBottomBar(player: Player, width: number, height: number): void {\r\n    const barHeight = 80;\r\n    const y = height - barHeight;\r\n\r\n    // Background\r\n    this.renderer.drawRect(0, y, width, barHeight, { fill: 'rgba(0,0,0,0.7)' });\r\n\r\n    // Health bar (left side)\r\n    this.renderer.drawHealthBar(\r\n      20, y + 20,\r\n      200, 20,\r\n      player.health, player.maxHealth,\r\n      player.shield, player.maxShield\r\n    );\r\n\r\n    // Health number with dark color for visibility over shield\r\n    this.renderer.drawText(\r\n      `${Math.ceil(player.health)}`,\r\n      120, y + 30,\r\n      { color: '#222', align: 'center', baseline: 'middle', size: 14 }\r\n    );\r\n\r\n    // Weapon inventory slots (1-10) - positioned next to health bar\r\n    const slotSize = 28;\r\n    const slotGap = 4;\r\n    const slotsStartX = 240; // Right after health bar (20 + 200 + 20 margin)\r\n    \r\n    for (let i = 0; i < 10; i++) {\r\n      const slotX = slotsStartX + i * (slotSize + slotGap);\r\n      const slotY = y + 15;\r\n      const hasWeapon = player.weaponInventory[i] !== null;\r\n      const isActive = player.currentWeaponSlot === i;\r\n      \r\n      // Slot background\r\n      this.renderer.drawRect(slotX, slotY, slotSize, slotSize, {\r\n        fill: isActive ? 'rgba(12, 229, 240, 0.3)' : 'rgba(30, 30, 40, 0.8)',\r\n        stroke: isActive ? COLORS.CYAN : (hasWeapon ? '#555' : '#333'),\r\n        strokeWidth: isActive ? 2 : 1,\r\n      });\r\n      \r\n      // Slot number (1-9, then 0 for slot 10)\r\n      const displayNumber = i === 9 ? 0 : i + 1;\r\n      this.renderer.drawText(\r\n        `${displayNumber}`,\r\n        slotX + slotSize / 2,\r\n        slotY + slotSize / 2,\r\n        { \r\n          color: hasWeapon ? (isActive ? COLORS.CYAN : '#aaa') : '#444', \r\n          align: 'center', \r\n          baseline: 'middle', \r\n          size: 11 \r\n        }\r\n      );\r\n      \r\n      // Weapon icon (first letter of weapon name)\r\n      if (hasWeapon) {\r\n        const weaponState = player.weaponInventory[i]!;\r\n        const initial = weaponState.weaponId.charAt(0).toUpperCase();\r\n        this.renderer.drawText(\r\n          initial,\r\n          slotX + slotSize / 2,\r\n          slotY + slotSize + 8,\r\n          { color: '#666', align: 'center', size: 8 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Current weapon info (positioned between weapon slots and credits)\r\n    const weaponInfoX = 600;\r\n    this.renderer.drawText(\r\n      player.weapon.weaponId.toUpperCase().replace('_', ' '),\r\n      weaponInfoX, y + 20,\r\n      { color: '#fff', align: 'left', size: 14 }\r\n    );\r\n\r\n    const ammoText = player.weapon.reloading \r\n      ? 'RELOADING...'\r\n      : `${player.weapon.ammo} / ${player.weapon.maxAmmo}`;\r\n    \r\n    this.renderer.drawText(\r\n      ammoText,\r\n      weaponInfoX, y + 45,\r\n      { color: player.weapon.reloading ? COLORS.YELLOW : COLORS.CYAN, align: 'left', size: 18 }\r\n    );\r\n\r\n    // Abilities UI - Enhanced with icons and better visuals\r\n    this.renderAbilities(player, width, y);\r\n  }\r\n\r\n  private renderCrosshair(width: number, height: number): void {\r\n    const cx = width / 2;\r\n    const cy = height / 2;\r\n    const size = 10;\r\n    const gap = 4;\r\n\r\n    // Crosshair lines\r\n    this.renderer.drawLine(cx - size, cy, cx - gap, cy, { color: COLORS.CYAN, width: 2 });\r\n    this.renderer.drawLine(cx + gap, cy, cx + size, cy, { color: COLORS.CYAN, width: 2 });\r\n    this.renderer.drawLine(cx, cy - size, cx, cy - gap, { color: COLORS.CYAN, width: 2 });\r\n    this.renderer.drawLine(cx, cy + gap, cx, cy + size, { color: COLORS.CYAN, width: 2 });\r\n\r\n    // Center dot\r\n    this.renderer.drawCircle(cx, cy, 2, { fill: COLORS.CYAN });\r\n  }\r\n\r\n  private renderAbilities(player: Player, width: number, barY: number): void {\r\n    const heroDef = HEROES[player.heroId];\r\n    const now = this.world.getTime();\r\n    \r\n    // Ability icons/symbols for each hero\r\n    // Order: [Passive, Q ability (index 1), F ability (index 2), Ultimate (index 3)]\r\n    const abilityIcons: Record<string, string[]> = {\r\n      'Spectre': ['', '', '', ''],   // Ghost Steps, Cloak, Sensor Jammer, Shadow Dive\r\n      'Byte': ['', '', '', ''],       // QuickJack, EMP Pulse, Hack Trap, Override\r\n      'Vanta': ['', '', '', ''],      // Titan Armor, Fortify(Q), Shockwave(F), Overclock\r\n      'Katana': ['', '', '', ''],    // Sprint Boost, Dash Slash, Shuriken Burst, Blade Storm\r\n      'Glyph': ['', '', '', ''],      // Recon Drone, Shock Drone, Ping Pulse, Nano Swarm\r\n      'Spark': ['', '', '', ''],      // Fireproof, Plasma Fire, Thermal Burst, Thermal Overdrive\r\n      'Zero': ['', '', '', ''],      // Scoped Precision, Mark Target, Dash Back, Rail Beam\r\n      'Mira': ['', '', '', ''],      // Auto-Heal, Nano-Heal, Shield, Revive\r\n    };\r\n    \r\n    const icons = abilityIcons[heroDef.name] || ['', '', '', ''];\r\n    const keys = ['', 'Q', 'F', 'X'];  // Index 0 = Passive (no key), 1 = Q, 2 = F, 3 = X (Ultimate)\r\n    \r\n    // Layout constants\r\n    const abilitySize = 48;\r\n    const abilityGap = 8;\r\n    const totalWidth = 4 * abilitySize + 3 * abilityGap;\r\n    const startX = width - totalWidth - 20;\r\n    const ay = barY + 16;\r\n    \r\n    // Credits display - left of abilities\r\n    const creditsX = startX - 70;\r\n    this.renderer.drawRect(creditsX - 30, ay + 8, 60, 32, {\r\n      fill: 'rgba(30, 30, 40, 0.8)',\r\n      stroke: COLORS.YELLOW,\r\n      strokeWidth: 1,\r\n    });\r\n    this.renderer.drawText(\r\n      `$${player.credits}`,\r\n      creditsX, ay + 24,\r\n      { color: COLORS.YELLOW, align: 'center', baseline: 'middle', size: 16 }\r\n    );\r\n    \r\n    for (let i = 0; i < 4; i++) {\r\n      const ability = player.abilities[i];\r\n      const abilityDef = heroDef.abilities[i];\r\n      if (!ability || !abilityDef) continue;\r\n      \r\n      const ax = startX + i * (abilitySize + abilityGap);\r\n      const isPassive = i === 0;\r\n      const isUltimate = i === 3;\r\n      \r\n      // Calculate cooldown\r\n      const cooldownRemaining = Math.max(0, ability.cooldownEndTime - now);\r\n      const cooldownPercent = abilityDef.cooldown > 0 ? cooldownRemaining / abilityDef.cooldown : 0;\r\n      const isReady = cooldownRemaining === 0;\r\n      const hasCharges = ability.charges > 0;\r\n      \r\n      // Background shape - hexagon for ultimate, rounded rect for others\r\n      if (isUltimate) {\r\n        this.drawHexagon(ax + abilitySize / 2, ay + abilitySize / 2, abilitySize / 2, {\r\n          fill: isReady ? 'rgba(255, 200, 0, 0.3)' : 'rgba(30, 30, 40, 0.9)',\r\n          stroke: isReady ? COLORS.YELLOW : '#444',\r\n          strokeWidth: 2,\r\n        });\r\n      } else if (isPassive) {\r\n        // Passive - always active, dimmer style\r\n        this.renderer.drawRect(ax, ay, abilitySize, abilitySize, {\r\n          fill: 'rgba(50, 80, 50, 0.6)',\r\n          stroke: '#4a4',\r\n          strokeWidth: 1,\r\n        });\r\n      } else {\r\n        // Regular ability\r\n        this.renderer.drawRect(ax, ay, abilitySize, abilitySize, {\r\n          fill: isReady && hasCharges ? 'rgba(12, 229, 240, 0.2)' : 'rgba(30, 30, 40, 0.9)',\r\n          stroke: isReady && hasCharges ? COLORS.CYAN : '#444',\r\n          strokeWidth: isReady && hasCharges ? 2 : 1,\r\n        });\r\n      }\r\n      \r\n      // Cooldown overlay (pie chart style)\r\n      if (cooldownPercent > 0 && !isPassive) {\r\n        const cx = ax + abilitySize / 2;\r\n        const cy = ay + abilitySize / 2;\r\n        const radius = abilitySize / 2 - 2;\r\n        \r\n        this.renderer.getContext().save();\r\n        this.renderer.getContext().globalAlpha = 0.7;\r\n        this.renderer.getContext().fillStyle = '#000';\r\n        this.renderer.getContext().beginPath();\r\n        this.renderer.getContext().moveTo(cx, cy);\r\n        this.renderer.getContext().arc(\r\n          cx, cy, radius,\r\n          -Math.PI / 2,\r\n          -Math.PI / 2 + Math.PI * 2 * cooldownPercent,\r\n          false\r\n        );\r\n        this.renderer.getContext().closePath();\r\n        this.renderer.getContext().fill();\r\n        this.renderer.getContext().restore();\r\n        \r\n        // Cooldown time remaining text\r\n        const secondsLeft = Math.ceil(cooldownRemaining / 1000);\r\n        this.renderer.drawText(\r\n          `${secondsLeft}`,\r\n          ax + abilitySize / 2,\r\n          ay + abilitySize / 2,\r\n          { color: '#fff', align: 'center', baseline: 'middle', size: 16 }\r\n        );\r\n      } else {\r\n        // Ability icon\r\n        this.renderer.drawText(\r\n          icons[i] ?? '',\r\n          ax + abilitySize / 2,\r\n          ay + abilitySize / 2,\r\n          { color: '#fff', align: 'center', baseline: 'middle', size: 20 }\r\n        );\r\n      }\r\n      \r\n      // Key binding (top-left corner)\r\n      const keyColor = isPassive ? '#4a4' : (isReady && hasCharges ? COLORS.CYAN : '#666');\r\n      this.renderer.drawText(\r\n        keys[i] ?? '',\r\n        ax + 8,\r\n        ay + 10,\r\n        { color: keyColor, align: 'center', baseline: 'middle', size: 10 }\r\n      );\r\n      \r\n      // Charges indicator (if more than 1 max charge)\r\n      if (abilityDef.charges > 1) {\r\n        const chargeText = `${ability.charges}/${abilityDef.charges}`;\r\n        this.renderer.drawText(\r\n          chargeText,\r\n          ax + abilitySize - 8,\r\n          ay + abilitySize - 6,\r\n          { color: ability.charges > 0 ? COLORS.CYAN : '#666', align: 'center', baseline: 'middle', size: 9 }\r\n        );\r\n      }\r\n      \r\n      // Ultimate charge indicator\r\n      if (isUltimate) {\r\n        const ultCharge = ability.ultimateCharge || 0;\r\n        const ultCost = abilityDef.ultimateCost || 6;\r\n        const ultPercent = Math.min(1, ultCharge / ultCost);\r\n        \r\n        // Draw charge bar under ultimate\r\n        const barWidth = abilitySize - 4;\r\n        const barHeight = 4;\r\n        const barX = ax + 2;\r\n        const barYPos = ay + abilitySize + 2;\r\n        \r\n        // Background\r\n        this.renderer.drawRect(barX, barYPos, barWidth, barHeight, { fill: '#222' });\r\n        \r\n        // Fill\r\n        const ultReady = ultCharge >= ultCost;\r\n        this.renderer.drawRect(barX, barYPos, barWidth * ultPercent, barHeight, { \r\n          fill: ultReady ? COLORS.YELLOW : COLORS.CYAN \r\n        });\r\n        \r\n        // Charge text\r\n        if (!ultReady) {\r\n          this.renderer.drawText(\r\n            `${Math.floor(ultCharge)}/${ultCost}`,\r\n            ax + abilitySize / 2,\r\n            barYPos + barHeight + 8,\r\n            { color: '#888', align: 'center', baseline: 'middle', size: 8 }\r\n          );\r\n        } else {\r\n          this.renderer.drawText(\r\n            'READY',\r\n            ax + abilitySize / 2,\r\n            barYPos + barHeight + 8,\r\n            { color: COLORS.YELLOW, align: 'center', baseline: 'middle', size: 8 }\r\n          );\r\n        }\r\n      }\r\n      \r\n      // Ability name - always show under each ability (except ultimate which has charge bar)\r\n      if (!isUltimate) {\r\n        // Truncate long names\r\n        const displayName = abilityDef.name.length > 10 \r\n          ? abilityDef.name.substring(0, 9) + '' \r\n          : abilityDef.name;\r\n        this.renderer.drawText(\r\n          displayName,\r\n          ax + abilitySize / 2,\r\n          ay + abilitySize + 8,\r\n          { color: isPassive ? '#4a4' : '#888', align: 'center', baseline: 'middle', size: 7 }\r\n        );\r\n      }\r\n    }\r\n    \r\n    // Hero name display\r\n    this.renderer.drawText(\r\n      heroDef.name.toUpperCase(),\r\n      startX + totalWidth / 2,\r\n      ay - 8,\r\n      { color: COLORS.CYAN, align: 'center', baseline: 'middle', size: 12 }\r\n    );\r\n  }\r\n  \r\n  private drawHexagon(cx: number, cy: number, radius: number, options: { fill?: string; stroke?: string; strokeWidth?: number }): void {\r\n    const ctx = this.renderer.getContext();\r\n    ctx.save();\r\n    ctx.beginPath();\r\n    for (let i = 0; i < 6; i++) {\r\n      const angle = (Math.PI / 3) * i - Math.PI / 2;\r\n      const x = cx + radius * Math.cos(angle);\r\n      const y = cy + radius * Math.sin(angle);\r\n      if (i === 0) {\r\n        ctx.moveTo(x, y);\r\n      } else {\r\n        ctx.lineTo(x, y);\r\n      }\r\n    }\r\n    ctx.closePath();\r\n    \r\n    if (options.fill) {\r\n      ctx.fillStyle = options.fill;\r\n      ctx.fill();\r\n    }\r\n    if (options.stroke) {\r\n      ctx.strokeStyle = options.stroke;\r\n      ctx.lineWidth = options.strokeWidth || 1;\r\n      ctx.stroke();\r\n    }\r\n    ctx.restore();\r\n  }\r\n\r\n  private renderPhaseOverlay(width: number, height: number): void {\r\n    const phase = this.world.getPhase();\r\n    const isMatchEnd = phase === GamePhase.MatchEnd;\r\n    let text = '';\r\n    let subtext = '';\r\n    let isVictory = false;\r\n    let isDefeat = false;\r\n\r\n    // Check if local player won or lost\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    if (isMatchEnd && localPlayer) {\r\n      const score = this.world.getScore();\r\n      const attackersWon = score.attackers > score.defenders;\r\n      isVictory = (localPlayer.team === Team.Attackers && attackersWon) || \r\n                  (localPlayer.team === Team.Defenders && !attackersWon);\r\n      isDefeat = !isVictory;\r\n    }\r\n\r\n    // Trigger confetti on match end transition\r\n    if (isMatchEnd && !this.lastMatchEndPhase) {\r\n      this.matchEndStartTime = Date.now();\r\n      if (isVictory) {\r\n        this.spawnVictoryConfetti(width, height);\r\n      }\r\n    }\r\n    this.lastMatchEndPhase = isMatchEnd;\r\n\r\n    switch (phase) {\r\n      case GamePhase.Lobby:\r\n        text = 'WAITING FOR PLAYERS';\r\n        subtext = 'Press SPACE to start when ready';\r\n        break;\r\n      case GamePhase.BuyPhase:\r\n        text = 'BUY PHASE';\r\n        subtext = 'Purchase weapons and abilities';\r\n        break;\r\n      case GamePhase.RoundEnd:\r\n        const score = this.world.getScore();\r\n        text = 'ROUND OVER';\r\n        subtext = `Attackers: ${score.attackers} - Defenders: ${score.defenders}`;\r\n        break;\r\n      case GamePhase.MatchEnd:\r\n        const finalScore = this.world.getScore();\r\n        if (isVictory) {\r\n          text = ' VICTORY! ';\r\n        } else if (isDefeat) {\r\n          text = ' DEFEAT ';\r\n        } else {\r\n          text = finalScore.attackers > finalScore.defenders ? 'ATTACKERS WIN' : 'DEFENDERS WIN';\r\n        }\r\n        subtext = `Final Score: ${finalScore.attackers} - ${finalScore.defenders}`;\r\n        break;\r\n    }\r\n\r\n    // Darken background - different colors for victory/defeat\r\n    if (isMatchEnd && isVictory) {\r\n      this.renderer.drawRect(0, 0, width, height, { fill: 'rgba(0,40,0,0.6)' });\r\n    } else if (isMatchEnd && isDefeat) {\r\n      this.renderer.drawRect(0, 0, width, height, { fill: 'rgba(40,0,0,0.6)' });\r\n    } else {\r\n      this.renderer.drawRect(0, 0, width, height, { fill: 'rgba(0,0,0,0.5)' });\r\n    }\r\n\r\n    // Render confetti for victory\r\n    if (isMatchEnd && isVictory) {\r\n      this.updateAndRenderConfetti(width, height);\r\n    }\r\n\r\n    // Render defeat particles\r\n    if (isMatchEnd && isDefeat) {\r\n      this.renderDefeatEffect(width, height);\r\n    }\r\n\r\n    // Choose colors based on victory/defeat\r\n    let mainColor: string = COLORS.CYAN;\r\n    let glowSize = 20;\r\n    if (isMatchEnd) {\r\n      if (isVictory) {\r\n        mainColor = '#ffd700'; // Gold\r\n        glowSize = 30;\r\n      } else if (isDefeat) {\r\n        mainColor = '#ff4444'; // Red\r\n        glowSize = 15;\r\n      }\r\n    }\r\n\r\n    // Main text\r\n    this.renderer.drawText(\r\n      text,\r\n      width / 2, height / 2 - 40,\r\n      { \r\n        color: mainColor, \r\n        align: 'center', \r\n        baseline: 'middle', \r\n        size: isMatchEnd ? 48 : 36,\r\n        glow: true,\r\n        glowColor: mainColor,\r\n        glowSize: glowSize,\r\n      }\r\n    );\r\n\r\n    // Subtext\r\n    this.renderer.drawText(\r\n      subtext,\r\n      width / 2, height / 2,\r\n      { color: '#888', align: 'center', baseline: 'middle', size: 16 }\r\n    );\r\n\r\n    // Show countdown during RoundEnd phase\r\n    if (phase === GamePhase.RoundEnd) {\r\n      const countdownTime = this.world.getCountdownTime();\r\n      const isPaused = this.world.isCountdownPaused();\r\n      const pausedBy = this.world.getCountdownPausedBy();\r\n      const seconds = Math.ceil(countdownTime / 1000);\r\n      \r\n      const countdownText = isPaused \r\n        ? `PAUSED by ${pausedBy}` \r\n        : `Next round in ${seconds}s`;\r\n      \r\n      const countdownColor = isPaused ? COLORS.YELLOW : COLORS.CYAN;\r\n      \r\n      this.renderer.drawText(\r\n        countdownText,\r\n        width / 2, height / 2 + 40,\r\n        { \r\n          color: countdownColor, \r\n          align: 'center', \r\n          baseline: 'middle', \r\n          size: 24,\r\n          glow: true,\r\n          glowColor: countdownColor,\r\n          glowSize: 10,\r\n        }\r\n      );\r\n\r\n      // Instructions\r\n      const instructionText = isPaused \r\n        ? 'Press P to resume' \r\n        : 'Press P to pause countdown';\r\n      \r\n      this.renderer.drawText(\r\n        instructionText,\r\n        width / 2, height / 2 + 70,\r\n        { color: '#666', align: 'center', baseline: 'middle', size: 12 }\r\n      );\r\n    }\r\n  }\r\n\r\n  // Spawn confetti particles for victory celebration\r\n  private spawnVictoryConfetti(width: number, _height: number): void {\r\n    const confettiColors = [\r\n      '#ffd700', // Gold\r\n      '#ff6b6b', // Red\r\n      '#4ecdc4', // Teal\r\n      '#45b7d1', // Blue\r\n      '#96ceb4', // Green\r\n      '#ffeaa7', // Yellow\r\n      '#dfe6e9', // White\r\n      '#a29bfe', // Purple\r\n      '#fd79a8', // Pink\r\n      '#00b894', // Emerald\r\n    ];\r\n\r\n    // Spawn confetti from top\r\n    for (let i = 0; i < 150; i++) {\r\n      this.matchEndConfetti.push({\r\n        x: Math.random() * width,\r\n        y: -20 - Math.random() * 200,\r\n        vx: (Math.random() - 0.5) * 200,\r\n        vy: Math.random() * 300 + 100,\r\n        rotation: Math.random() * Math.PI * 2,\r\n        rotationSpeed: (Math.random() - 0.5) * 10,\r\n        width: Math.random() * 8 + 4,\r\n        height: Math.random() * 12 + 6,\r\n        color: confettiColors[Math.floor(Math.random() * confettiColors.length)]!,\r\n        life: 5 + Math.random() * 3,\r\n        maxLife: 5 + Math.random() * 3,\r\n      });\r\n    }\r\n  }\r\n\r\n  // Update and render confetti particles\r\n  private updateAndRenderConfetti(width: number, _height: number): void {\r\n    const ctx = this.renderer.getContext();\r\n    const dt = 1 / 60; // Approximate frame time\r\n\r\n    for (let i = this.matchEndConfetti.length - 1; i >= 0; i--) {\r\n      const p = this.matchEndConfetti[i]!;\r\n      \r\n      // Update life\r\n      p.life -= dt;\r\n      if (p.life <= 0) {\r\n        this.matchEndConfetti.splice(i, 1);\r\n        continue;\r\n      }\r\n\r\n      // Apply gravity and wind\r\n      p.vy += 400 * dt; // Gravity\r\n      p.vx += Math.sin(Date.now() / 500 + p.x / 100) * 50 * dt; // Gentle wind sway\r\n\r\n      // Update position\r\n      p.x += p.vx * dt;\r\n      p.y += p.vy * dt;\r\n      p.rotation += p.rotationSpeed * dt;\r\n\r\n      // Air resistance\r\n      p.vx *= 0.99;\r\n      p.vy *= 0.995;\r\n\r\n      // Wrap around horizontally\r\n      if (p.x < -20) p.x = width + 20;\r\n      if (p.x > width + 20) p.x = -20;\r\n\r\n      // Render confetti\r\n      const alpha = Math.min(1, p.life / (p.maxLife * 0.3));\r\n      ctx.save();\r\n      ctx.translate(p.x, p.y);\r\n      ctx.rotate(p.rotation);\r\n      ctx.fillStyle = p.color;\r\n      ctx.globalAlpha = alpha;\r\n      ctx.fillRect(-p.width / 2, -p.height / 2, p.width, p.height);\r\n      ctx.restore();\r\n    }\r\n    ctx.globalAlpha = 1;\r\n\r\n    // Continuously spawn more confetti\r\n    const timeSinceStart = Date.now() - this.matchEndStartTime;\r\n    if (timeSinceStart < 5000 && Math.random() < 0.3) {\r\n      const confettiColors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7'];\r\n      this.matchEndConfetti.push({\r\n        x: Math.random() * width,\r\n        y: -10,\r\n        vx: (Math.random() - 0.5) * 150,\r\n        vy: Math.random() * 200 + 100,\r\n        rotation: Math.random() * Math.PI * 2,\r\n        rotationSpeed: (Math.random() - 0.5) * 8,\r\n        width: Math.random() * 8 + 4,\r\n        height: Math.random() * 12 + 6,\r\n        color: confettiColors[Math.floor(Math.random() * confettiColors.length)]!,\r\n        life: 4 + Math.random() * 2,\r\n        maxLife: 4 + Math.random() * 2,\r\n      });\r\n    }\r\n  }\r\n\r\n  // Render defeat effect (falling/fading particles)\r\n  private renderDefeatEffect(width: number, height: number): void {\r\n    const ctx = this.renderer.getContext();\r\n    const time = Date.now() - this.matchEndStartTime;\r\n    \r\n    // Pulsing red vignette\r\n    const pulseIntensity = 0.3 + Math.sin(time / 500) * 0.1;\r\n    const gradient = ctx.createRadialGradient(\r\n      width / 2, height / 2, 0,\r\n      width / 2, height / 2, Math.max(width, height) * 0.7\r\n    );\r\n    gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');\r\n    gradient.addColorStop(0.5, 'rgba(80, 0, 0, 0.2)');\r\n    gradient.addColorStop(1, `rgba(100, 0, 0, ${pulseIntensity})`);\r\n    \r\n    ctx.fillStyle = gradient;\r\n    ctx.fillRect(0, 0, width, height);\r\n\r\n    // Falling skull particles (simplified)\r\n    const numSkulls = 8;\r\n    for (let i = 0; i < numSkulls; i++) {\r\n      const baseX = (width / numSkulls) * i + width / numSkulls / 2;\r\n      const y = ((time / 20 + i * 100) % (height + 100)) - 50;\r\n      const alpha = 0.3 + Math.sin(time / 300 + i) * 0.1;\r\n      const size = 20 + Math.sin(i * 1.5) * 5;\r\n      \r\n      ctx.save();\r\n      ctx.globalAlpha = alpha;\r\n      ctx.font = `${size}px Arial`;\r\n      ctx.textAlign = 'center';\r\n      ctx.textBaseline = 'middle';\r\n      ctx.fillStyle = '#444';\r\n      ctx.fillText('', baseX + Math.sin(time / 400 + i * 2) * 20, y);\r\n      ctx.restore();\r\n    }\r\n    ctx.globalAlpha = 1;\r\n\r\n    // Cracked screen effect (static lines)\r\n    ctx.strokeStyle = 'rgba(60, 0, 0, 0.3)';\r\n    ctx.lineWidth = 2;\r\n    ctx.beginPath();\r\n    ctx.moveTo(width * 0.3, 0);\r\n    ctx.lineTo(width * 0.4, height * 0.3);\r\n    ctx.lineTo(width * 0.35, height * 0.5);\r\n    ctx.lineTo(width * 0.45, height);\r\n    ctx.stroke();\r\n    \r\n    ctx.beginPath();\r\n    ctx.moveTo(width * 0.7, 0);\r\n    ctx.lineTo(width * 0.6, height * 0.4);\r\n    ctx.lineTo(width * 0.65, height * 0.7);\r\n    ctx.lineTo(width * 0.55, height);\r\n    ctx.stroke();\r\n  }\r\n\r\n  updateWorld(world: GameWorld): void {\r\n    this.world = world;\r\n  }\r\n}\r\n","/**\r\n * GameAudio - Game-specific audio handling\r\n * Wraps the engine AudioManager with game sounds\r\n */\r\n\r\nimport { AudioManager } from '@/engine';\r\n\r\n// All game sound effects\r\nexport enum SFX {\r\n  // Weapons\r\n  PulsePistolShoot = 'weapon_pulse_pistol_shoot',\r\n  PlasmaRifleShoot = 'weapon_plasma_rifle_shoot',\r\n  ScatterGunShoot = 'weapon_scatter_gun_shoot',\r\n  FusionCannonShoot = 'weapon_fusion_cannon_shoot',\r\n  WeaponReload = 'weapon_reload',\r\n  WeaponEmpty = 'weapon_empty',\r\n  WeaponSwitch = 'weapon_switch',\r\n  \r\n  // Player\r\n  FootstepMetal = 'player_footstep',\r\n  PlayerDamage = 'player_damage',\r\n  PlayerDeath = 'player_death',\r\n  PlayerRespawn = 'player_respawn',\r\n  \r\n  // Combat\r\n  BulletImpactWall = 'combat_impact_wall',\r\n  BulletImpactPlayer = 'combat_impact_player',\r\n  Headshot = 'combat_headshot',\r\n  KillConfirmed = 'combat_kill',\r\n  \r\n  // Abilities\r\n  AbilityCast = 'ability_cast',\r\n  Explosion = 'ability_explosion',\r\n  Teleport = 'ability_teleport',\r\n  \r\n  // Game State\r\n  RoundStart = 'game_round_start',\r\n  RoundEnd = 'game_round_end',\r\n  MatchWin = 'game_match_win',\r\n  MatchLose = 'game_match_lose',\r\n  CountdownTick = 'game_countdown_tick',\r\n  CountdownGo = 'game_countdown_go',\r\n  \r\n  // UI\r\n  UIClick = 'ui_click',\r\n  UIHover = 'ui_hover',\r\n  UISuccess = 'ui_success',\r\n  UIError = 'ui_error',\r\n}\r\n\r\n// Music tracks\r\nexport enum Music {\r\n  MenuTheme = 'music_menu',\r\n  GameplayLoop = 'music_gameplay',\r\n  VictoryTheme = 'music_victory',\r\n  DefeatTheme = 'music_defeat',\r\n}\r\n\r\n// Sound file mappings\r\nconst SOUND_FILES: Record<string, string> = {\r\n  // Weapons\r\n  [SFX.PulsePistolShoot]: './assets/audio/weapons/pulse_pistol_shoot.mp3',\r\n  [SFX.PlasmaRifleShoot]: './assets/audio/weapons/plasma_rifle_shoot.mp3',\r\n  [SFX.ScatterGunShoot]: './assets/audio/weapons/scatter_gun_shoot.mp3',\r\n  [SFX.FusionCannonShoot]: './assets/audio/weapons/fusion_cannon_shoot.mp3',\r\n  [SFX.WeaponReload]: './assets/audio/weapons/reload.mp3',\r\n  [SFX.WeaponEmpty]: './assets/audio/weapons/empty_click.mp3',\r\n  [SFX.WeaponSwitch]: './assets/audio/weapons/weapon_switch.mp3',\r\n  \r\n  // Player\r\n  [SFX.FootstepMetal]: './assets/audio/player/footstep_metal.mp3',\r\n  [SFX.PlayerDamage]: './assets/audio/player/damage.mp3',\r\n  [SFX.PlayerDeath]: './assets/audio/player/death.mp3',\r\n  [SFX.PlayerRespawn]: './assets/audio/player/respawn.mp3',\r\n  \r\n  // Combat\r\n  [SFX.BulletImpactWall]: './assets/audio/combat/impact_wall.mp3',\r\n  [SFX.BulletImpactPlayer]: './assets/audio/combat/impact_player.mp3',\r\n  [SFX.Headshot]: './assets/audio/combat/headshot.mp3',\r\n  [SFX.KillConfirmed]: './assets/audio/combat/kill_confirmed.mp3',\r\n  \r\n  // Abilities\r\n  [SFX.AbilityCast]: './assets/audio/abilities/cast.mp3',\r\n  [SFX.Explosion]: './assets/audio/abilities/explosion.mp3',\r\n  [SFX.Teleport]: './assets/audio/abilities/teleport.mp3',\r\n  \r\n  // Game State\r\n  [SFX.RoundStart]: './assets/audio/game/round_start.mp3',\r\n  [SFX.RoundEnd]: './assets/audio/game/round_end.mp3',\r\n  [SFX.MatchWin]: './assets/audio/game/match_win.mp3',\r\n  [SFX.MatchLose]: './assets/audio/game/match_lose.mp3',\r\n  [SFX.CountdownTick]: './assets/audio/game/countdown_tick.mp3',\r\n  [SFX.CountdownGo]: './assets/audio/game/countdown_go.mp3',\r\n  \r\n  // UI\r\n  [SFX.UIClick]: './assets/audio/ui/click.mp3',\r\n  [SFX.UIHover]: './assets/audio/ui/hover.mp3',\r\n  [SFX.UISuccess]: './assets/audio/ui/success.mp3',\r\n  [SFX.UIError]: './assets/audio/ui/error.mp3',\r\n  \r\n  // Music\r\n  [Music.MenuTheme]: './assets/audio/music/menu_theme.mp3',\r\n  [Music.GameplayLoop]: './assets/audio/music/gameplay_loop.mp3',\r\n  [Music.VictoryTheme]: './assets/audio/music/victory_theme.mp3',\r\n  [Music.DefeatTheme]: './assets/audio/music/defeat_theme.mp3',\r\n};\r\n\r\n// Sound categories for volume control\r\nexport enum AudioCategory {\r\n  Master = 'master',\r\n  Music = 'music',\r\n  SFX = 'sfx',\r\n  UI = 'ui',\r\n  Voice = 'voice',\r\n}\r\n\r\n// Map sounds to their categories\r\nconst SOUND_CATEGORIES: Record<string, AudioCategory> = {\r\n  // Weapons -> SFX\r\n  [SFX.PulsePistolShoot]: AudioCategory.SFX,\r\n  [SFX.PlasmaRifleShoot]: AudioCategory.SFX,\r\n  [SFX.ScatterGunShoot]: AudioCategory.SFX,\r\n  [SFX.FusionCannonShoot]: AudioCategory.SFX,\r\n  [SFX.WeaponReload]: AudioCategory.SFX,\r\n  [SFX.WeaponEmpty]: AudioCategory.SFX,\r\n  [SFX.WeaponSwitch]: AudioCategory.SFX,\r\n  // Player -> SFX\r\n  [SFX.FootstepMetal]: AudioCategory.SFX,\r\n  [SFX.PlayerDamage]: AudioCategory.SFX,\r\n  [SFX.PlayerDeath]: AudioCategory.SFX,\r\n  [SFX.PlayerRespawn]: AudioCategory.SFX,\r\n  // Combat -> SFX\r\n  [SFX.BulletImpactWall]: AudioCategory.SFX,\r\n  [SFX.BulletImpactPlayer]: AudioCategory.SFX,\r\n  [SFX.Headshot]: AudioCategory.SFX,\r\n  [SFX.KillConfirmed]: AudioCategory.SFX,\r\n  // Abilities -> SFX\r\n  [SFX.AbilityCast]: AudioCategory.SFX,\r\n  [SFX.Explosion]: AudioCategory.SFX,\r\n  [SFX.Teleport]: AudioCategory.SFX,\r\n  // Game State -> Voice (announcer-style)\r\n  [SFX.RoundStart]: AudioCategory.Voice,\r\n  [SFX.RoundEnd]: AudioCategory.Voice,\r\n  [SFX.MatchWin]: AudioCategory.Voice,\r\n  [SFX.MatchLose]: AudioCategory.Voice,\r\n  [SFX.CountdownTick]: AudioCategory.Voice,\r\n  [SFX.CountdownGo]: AudioCategory.Voice,\r\n  // UI -> UI\r\n  [SFX.UIClick]: AudioCategory.UI,\r\n  [SFX.UIHover]: AudioCategory.UI,\r\n  [SFX.UISuccess]: AudioCategory.UI,\r\n  [SFX.UIError]: AudioCategory.UI,\r\n  // Music -> Music\r\n  [Music.MenuTheme]: AudioCategory.Music,\r\n  [Music.GameplayLoop]: AudioCategory.Music,\r\n  [Music.VictoryTheme]: AudioCategory.Music,\r\n  [Music.DefeatTheme]: AudioCategory.Music,\r\n};\r\n\r\n// Default volumes for specific sounds (relative to category)\r\nconst SOUND_VOLUMES: Partial<Record<string, number>> = {\r\n  [SFX.FootstepMetal]: 0.3,\r\n  [SFX.UIHover]: 0.4,\r\n  [SFX.BulletImpactWall]: 0.5,\r\n};\r\n\r\n// Audio settings interface\r\nexport interface AudioSettings {\r\n  masterVolume: number;    // 0-100\r\n  musicVolume: number;     // 0-100\r\n  sfxVolume: number;       // 0-100\r\n  uiVolume: number;        // 0-100\r\n  voiceVolume: number;     // 0-100\r\n  masterEnabled: boolean;\r\n  musicEnabled: boolean;\r\n  sfxEnabled: boolean;\r\n  uiEnabled: boolean;\r\n  voiceEnabled: boolean;\r\n}\r\n\r\nconst DEFAULT_AUDIO_SETTINGS: AudioSettings = {\r\n  masterVolume: 80,\r\n  musicVolume: 50,\r\n  sfxVolume: 80,\r\n  uiVolume: 70,\r\n  voiceVolume: 100,\r\n  masterEnabled: true,\r\n  musicEnabled: true,\r\n  sfxEnabled: true,\r\n  uiEnabled: true,\r\n  voiceEnabled: true,\r\n};\r\n\r\nexport class GameAudio {\r\n  private audioManager: AudioManager;\r\n  private loadedSounds: Set<string> = new Set();\r\n  private settings: AudioSettings;\r\n  \r\n  constructor() {\r\n    this.audioManager = new AudioManager();\r\n    this.settings = { ...DEFAULT_AUDIO_SETTINGS };\r\n    this.loadSettings();\r\n  }\r\n  \r\n  /**\r\n   * Load audio settings from localStorage\r\n   */\r\n  private loadSettings(): void {\r\n    try {\r\n      const saved = localStorage.getItem('cybergrid_audioSettings');\r\n      if (saved) {\r\n        this.settings = { ...DEFAULT_AUDIO_SETTINGS, ...JSON.parse(saved) };\r\n      }\r\n    } catch {\r\n      // Use defaults\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Save audio settings to localStorage\r\n   */\r\n  saveSettings(): void {\r\n    try {\r\n      localStorage.setItem('cybergrid_audioSettings', JSON.stringify(this.settings));\r\n    } catch {\r\n      // Ignore save errors\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Get current audio settings\r\n   */\r\n  getSettings(): AudioSettings {\r\n    return { ...this.settings };\r\n  }\r\n  \r\n  /**\r\n   * Update audio settings\r\n   */\r\n  updateSettings(newSettings: Partial<AudioSettings>): void {\r\n    this.settings = { ...this.settings, ...newSettings };\r\n    this.applySettings();\r\n    this.saveSettings();\r\n  }\r\n  \r\n  /**\r\n   * Apply current settings to audio manager\r\n   */\r\n  private applySettings(): void {\r\n    // Master volume affects everything\r\n    this.audioManager.setMasterVolume(this.settings.masterEnabled ? this.settings.masterVolume / 100 : 0);\r\n    this.audioManager.setMusicVolume(this.settings.musicEnabled ? this.settings.musicVolume / 100 : 0);\r\n  }\r\n  \r\n  /**\r\n   * Get effective volume for a sound based on its category\r\n   */\r\n  private getEffectiveVolume(soundKey: string, volumeMultiplier: number): number {\r\n    if (!this.settings.masterEnabled) return 0;\r\n    \r\n    const category = SOUND_CATEGORIES[soundKey] || AudioCategory.SFX;\r\n    let categoryVolume = 1;\r\n    let categoryEnabled = true;\r\n    \r\n    switch (category) {\r\n      case AudioCategory.Music:\r\n        categoryVolume = this.settings.musicVolume / 100;\r\n        categoryEnabled = this.settings.musicEnabled;\r\n        break;\r\n      case AudioCategory.SFX:\r\n        categoryVolume = this.settings.sfxVolume / 100;\r\n        categoryEnabled = this.settings.sfxEnabled;\r\n        break;\r\n      case AudioCategory.UI:\r\n        categoryVolume = this.settings.uiVolume / 100;\r\n        categoryEnabled = this.settings.uiEnabled;\r\n        break;\r\n      case AudioCategory.Voice:\r\n        categoryVolume = this.settings.voiceVolume / 100;\r\n        categoryEnabled = this.settings.voiceEnabled;\r\n        break;\r\n    }\r\n    \r\n    if (!categoryEnabled) return 0;\r\n    \r\n    const baseVolume = SOUND_VOLUMES[soundKey] ?? 1;\r\n    const masterVolume = this.settings.masterVolume / 100;\r\n    \r\n    return baseVolume * volumeMultiplier * categoryVolume * masterVolume;\r\n  }\r\n  \r\n  /**\r\n   * Check if a category is enabled\r\n   */\r\n  private isCategoryEnabled(soundKey: string): boolean {\r\n    if (!this.settings.masterEnabled) return false;\r\n    \r\n    const category = SOUND_CATEGORIES[soundKey] || AudioCategory.SFX;\r\n    \r\n    switch (category) {\r\n      case AudioCategory.Music: return this.settings.musicEnabled;\r\n      case AudioCategory.SFX: return this.settings.sfxEnabled;\r\n      case AudioCategory.UI: return this.settings.uiEnabled;\r\n      case AudioCategory.Voice: return this.settings.voiceEnabled;\r\n      default: return true;\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Initialize audio system\r\n   */\r\n  async init(): Promise<void> {\r\n    await this.audioManager.init();\r\n    this.applySettings();\r\n    console.log('[GameAudio] Initialized');\r\n  }\r\n  \r\n  /**\r\n   * Load all game sounds (call during loading screen)\r\n   */\r\n  async loadAllSounds(): Promise<void> {\r\n    const loadPromises: Promise<void>[] = [];\r\n    \r\n    for (const [key, url] of Object.entries(SOUND_FILES)) {\r\n      loadPromises.push(\r\n        this.audioManager.loadSound(key, url)\r\n          .then(() => {\r\n            this.loadedSounds.add(key);\r\n          })\r\n          .catch(() => {\r\n            console.warn(`[GameAudio] Failed to load: ${key}`);\r\n          })\r\n      );\r\n    }\r\n    \r\n    // Wait for all with timeout\r\n    await Promise.race([\r\n      Promise.allSettled(loadPromises),\r\n      new Promise(resolve => setTimeout(resolve, 10000)),\r\n    ]);\r\n    \r\n    console.log(`[GameAudio] Loaded ${this.loadedSounds.size}/${Object.keys(SOUND_FILES).length} sounds`);\r\n  }\r\n  \r\n  /**\r\n   * Load essential sounds only (for faster startup)\r\n   */\r\n  async loadEssentialSounds(): Promise<void> {\r\n    const essential = [\r\n      // All weapon sounds\r\n      SFX.PulsePistolShoot,\r\n      SFX.PlasmaRifleShoot,\r\n      SFX.ScatterGunShoot,\r\n      SFX.FusionCannonShoot,\r\n      // Player sounds\r\n      SFX.PlayerDamage,\r\n      SFX.PlayerDeath,\r\n      // Combat sounds\r\n      SFX.KillConfirmed,\r\n      // Game sounds\r\n      SFX.RoundStart,\r\n      SFX.CountdownTick,\r\n      // UI sounds\r\n      SFX.UIClick,\r\n      SFX.UIHover,\r\n    ];\r\n    \r\n    for (const key of essential) {\r\n      const url = SOUND_FILES[key];\r\n      if (url) {\r\n        try {\r\n          await this.audioManager.loadSound(key, url);\r\n          this.loadedSounds.add(key);\r\n        } catch {\r\n          // Ignore load errors for optional sounds\r\n        }\r\n      }\r\n    }\r\n    \r\n    console.log(`[GameAudio] Loaded ${this.loadedSounds.size} essential sounds`);\r\n  }\r\n  \r\n  /**\r\n   * Play a sound effect\r\n   */\r\n  play(sound: SFX, volumeMultiplier: number = 1): string | null {\r\n    if (!this.isCategoryEnabled(sound)) return null;\r\n    \r\n    const volume = this.getEffectiveVolume(sound, volumeMultiplier);\r\n    if (volume <= 0) return null;\r\n    \r\n    return this.audioManager.play(sound, { volume });\r\n  }\r\n  \r\n  /**\r\n   * Play a sound effect starting at a specific offset (for syncing)\r\n   */\r\n  playAtOffset(sound: SFX, offsetSeconds: number, volumeMultiplier: number = 1): string | null {\r\n    if (!this.isCategoryEnabled(sound)) return null;\r\n    \r\n    const volume = this.getEffectiveVolume(sound, volumeMultiplier);\r\n    if (volume <= 0) return null;\r\n    \r\n    return this.audioManager.play(sound, { volume, offset: offsetSeconds });\r\n  }\r\n  \r\n  /**\r\n   * Get duration of a sound in seconds\r\n   */\r\n  getSoundDuration(sound: SFX): number {\r\n    return this.audioManager.getSoundDuration(sound);\r\n  }\r\n  \r\n  /**\r\n   * Play a sound with pitch variation (good for footsteps, shots)\r\n   */\r\n  playWithVariation(sound: SFX, volumeMultiplier: number = 1): string | null {\r\n    if (!this.isCategoryEnabled(sound)) return null;\r\n    \r\n    const volume = this.getEffectiveVolume(sound, volumeMultiplier);\r\n    if (volume <= 0) return null;\r\n    \r\n    const pitchVariation = 0.9 + Math.random() * 0.2; // 0.9 - 1.1\r\n    \r\n    return this.audioManager.play(sound, { volume, pitch: pitchVariation });\r\n  }\r\n  \r\n  /**\r\n   * Stop a specific sound\r\n   */\r\n  stop(id: string): void {\r\n    this.audioManager.stop(id);\r\n  }\r\n  \r\n  /**\r\n   * Play background music\r\n   */\r\n  playMusic(music: Music, fadeIn: number = 1): void {\r\n    if (!this.settings.masterEnabled || !this.settings.musicEnabled) return;\r\n    this.audioManager.playMusic(music, fadeIn);\r\n  }\r\n  \r\n  /**\r\n   * Stop background music\r\n   */\r\n  stopMusic(fadeOut: number = 0.5): void {\r\n    this.audioManager.stopMusic(fadeOut);\r\n  }\r\n  \r\n  /**\r\n   * Stop all audio\r\n   */\r\n  stopAll(): void {\r\n    this.audioManager.stopAll();\r\n  }\r\n  \r\n  /**\r\n   * Check if audio is enabled\r\n   */\r\n  isEnabled(): boolean {\r\n    return this.settings.masterEnabled;\r\n  }\r\n  \r\n  /**\r\n   * Resume audio context (call after user interaction)\r\n   */\r\n  async resume(): Promise<void> {\r\n    await this.audioManager.resume();\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nlet gameAudioInstance: GameAudio | null = null;\r\n\r\nexport function getGameAudio(): GameAudio {\r\n  if (!gameAudioInstance) {\r\n    gameAudioInstance = new GameAudio();\r\n  }\r\n  return gameAudioInstance;\r\n}\r\n","// ============================================================================\r\n// FIREBASE CONFIGURATION\r\n// ============================================================================\r\n// Replace these values with your Firebase project config.\r\n// Get this from: Firebase Console > Project Settings > Your Apps > Config\r\n\r\nexport const FIREBASE_CONFIG = {\r\n  apiKey: \"AIzaSyBaF85KsT8rIfVSXkyO_815TvxtgauSLRQ\",\r\n  authDomain: \"cybergrid-assult.firebaseapp.com\",\r\n  projectId: \"cybergrid-assult\",\r\n  storageBucket: \"cybergrid-assult.firebasestorage.app\",\r\n  messagingSenderId: \"576758568996\",\r\n  appId: \"1:576758568996:web:f6faf029bb1fe37b4b20b1\",\r\n  measurementId: \"G-QNLH88NB94\"\r\n};\r\n\r\n// To set up Firebase:\r\n// 1. Go to https://console.firebase.google.com/\r\n// 2. Create a new project (or use existing)\r\n// 3. Go to Project Settings > General > Your apps\r\n// 4. Click \"Add app\" > Web (</>)\r\n// 5. Register app and copy the config values above\r\n// 6. Go to Firestore Database > Create database\r\n// 7. Start in test mode (for development)\r\n// 8. Set up security rules for production (see below)\r\n\r\n/*\r\nFIRESTORE SECURITY RULES (for production):\r\n\r\nrules_version = '2';\r\nservice cloud.firestore {\r\n  match /databases/{database}/documents {\r\n    // Rooms collection (WebRTC signaling)\r\n    match /rooms/{roomCode} {\r\n      allow read, write: if true; // For development\r\n      // For production, add authentication:\r\n      // allow read, write: if request.auth != null;\r\n      \r\n      // Peers subcollection\r\n      match /peers/{peerId} {\r\n        allow read, write: if true;\r\n      }\r\n      \r\n      // Signals subcollection (for WebRTC signaling)\r\n      match /signals/{peerId}/messages/{messageId} {\r\n        allow read, write: if true;\r\n      }\r\n    }\r\n    \r\n    // Public Lobbies collection (for lobby browser)\r\n    match /publicLobbies/{roomCode} {\r\n      allow read: if true;   // Anyone can browse lobbies\r\n      allow write: if true;  // For development\r\n      // For production: validate lobby data structure\r\n    }\r\n    \r\n    // Player Stats collection\r\n    match /playerStats/{playerId} {\r\n      allow read: if true;  // Anyone can read stats (for leaderboards)\r\n      allow write: if true; // For development\r\n      // For production with auth:\r\n      // allow write: if request.auth != null && request.auth.uid == playerId;\r\n    }\r\n    \r\n    // Global Stats (aggregate statistics)\r\n    match /globalStats/{docId} {\r\n      allow read: if true;   // Anyone can read global stats (for webpage)\r\n      allow write: if true;  // For development\r\n      // For production: use Cloud Functions to update\r\n    }\r\n  }\r\n}\r\n*/\r\n","// ============================================================================\r\n// PLAYER STATS SERVICE - Track player statistics in Firebase\r\n// ============================================================================\r\n// Tracks: unique players, playtime, wins, country, and more\r\n\r\nimport { FIREBASE_CONFIG } from '../config/firebase.config';\r\n\r\n// Player statistics stored in Firestore\r\nexport interface PlayerStats {\r\n  odplayerId: string;          // Unique player identifier (generated or from auth)\r\n  callsign: string;           // Current player name\r\n  country: string;            // ISO country code (e.g., \"US\", \"TR\")\r\n  countryName: string;        // Full country name\r\n  \r\n  // Lifetime stats\r\n  totalPlayTimeSeconds: number;\r\n  gamesPlayed: number;\r\n  gamesWon: number;\r\n  gamesLost: number;\r\n  totalKills: number;\r\n  totalDeaths: number;\r\n  totalAssists: number;\r\n  \r\n  // Hero preferences\r\n  favoriteHero: string;\r\n  heroStats: Record<string, HeroPlayStats>;\r\n  \r\n  // Timestamps\r\n  firstSeenAt: any;           // Firestore Timestamp\r\n  lastSeenAt: any;            // Firestore Timestamp\r\n  lastSessionStart: any;      // For calculating session duration\r\n}\r\n\r\nexport interface HeroPlayStats {\r\n  gamesPlayed: number;\r\n  gamesWon: number;\r\n  kills: number;\r\n  deaths: number;\r\n  playTimeSeconds: number;\r\n}\r\n\r\n// Session data for current play session\r\nexport interface SessionData {\r\n  sessionId: string;\r\n  startTime: number;\r\n  heroId: string;\r\n  gamesPlayed: number;\r\n  gamesWon: number;\r\n  kills: number;\r\n  deaths: number;\r\n  assists: number;\r\n}\r\n\r\n// Global statistics for the webpage\r\nexport interface GlobalStats {\r\n  totalUniquePlayers: number;\r\n  totalGamesPlayed: number;\r\n  totalPlayTimeHours: number;\r\n  playersByCountry: Record<string, number>;\r\n  lastUpdated: any;\r\n}\r\n\r\nclass PlayerStatsServiceClass {\r\n  private db: any = null;\r\n  private firebase: any = null;\r\n  private playerId: string = '';\r\n  private currentSession: SessionData | null = null;\r\n  private isInitialized = false;\r\n  private countryInfo: { code: string; name: string } = { code: 'XX', name: 'Unknown' };\r\n  \r\n  private static readonly UNSAVED_PLAYTIME_KEY = 'cybergrid_unsavedPlayTime';\r\n\r\n  // Generate or retrieve persistent player ID\r\n  private getOrCreatePlayerId(): string {\r\n    const storageKey = 'cybergrid_playerId';\r\n    let playerId = localStorage.getItem(storageKey);\r\n    \r\n    if (!playerId) {\r\n      playerId = `player_${Date.now().toString(36)}_${Math.random().toString(36).substr(2, 9)}`;\r\n      localStorage.setItem(storageKey, playerId);\r\n    }\r\n    \r\n    return playerId;\r\n  }\r\n\r\n  // Detect country from IP using free API\r\n  private async detectCountry(): Promise<{ code: string; name: string }> {\r\n    try {\r\n      // Using ipapi.co (free, no API key required, 1000 requests/day)\r\n      const response = await fetch('https://ipapi.co/json/', {\r\n        method: 'GET',\r\n        headers: { 'Accept': 'application/json' }\r\n      });\r\n      \r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        return {\r\n          code: data.country_code || 'XX',\r\n          name: data.country_name || 'Unknown'\r\n        };\r\n      }\r\n    } catch (e) {\r\n      console.warn('[PlayerStats] Country detection failed:', e);\r\n    }\r\n    \r\n    return { code: 'XX', name: 'Unknown' };\r\n  }\r\n\r\n  // Initialize the service\r\n  async initialize(): Promise<void> {\r\n    if (this.isInitialized) return;\r\n\r\n    try {\r\n      // Get player ID\r\n      this.playerId = this.getOrCreatePlayerId();\r\n      \r\n      // Detect country (async, don't block)\r\n      this.detectCountry().then(info => {\r\n        this.countryInfo = info;\r\n        console.log(`[PlayerStats] Country detected: ${info.name} (${info.code})`);\r\n      });\r\n\r\n      // Initialize Firebase\r\n      const { initializeApp, getApps, getApp } = await import('firebase/app');\r\n      const { \r\n        getFirestore, collection, doc, setDoc, getDoc, updateDoc, \r\n        increment, serverTimestamp, arrayUnion \r\n      } = await import('firebase/firestore');\r\n\r\n      this.firebase = { \r\n        collection, doc, setDoc, getDoc, updateDoc, \r\n        increment, serverTimestamp, arrayUnion \r\n      };\r\n\r\n      const app = getApps().length === 0 ? initializeApp(FIREBASE_CONFIG) : getApp();\r\n      this.db = getFirestore(app);\r\n\r\n      this.isInitialized = true;\r\n      console.log(`[PlayerStats] Initialized with player ID: ${this.playerId}`);\r\n    } catch (e) {\r\n      console.error('[PlayerStats] Initialization failed:', e);\r\n    }\r\n  }\r\n\r\n  // Start a new play session\r\n  async startSession(callsign: string, heroId: string): Promise<void> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    // Recover any unsaved play time from previous session\r\n    await this.recoverUnsavedPlayTime();\r\n\r\n    const { doc, getDoc, setDoc, updateDoc, serverTimestamp } = this.firebase;\r\n\r\n    this.currentSession = {\r\n      sessionId: `session_${Date.now()}`,\r\n      startTime: Date.now(),\r\n      heroId,\r\n      gamesPlayed: 0,\r\n      gamesWon: 0,\r\n      kills: 0,\r\n      deaths: 0,\r\n      assists: 0\r\n    };\r\n\r\n    try {\r\n      const playerRef = doc(this.db, 'playerStats', this.playerId);\r\n      const playerDoc = await getDoc(playerRef);\r\n\r\n      if (playerDoc.exists()) {\r\n        // Update existing player\r\n        await updateDoc(playerRef, {\r\n          callsign,\r\n          country: this.countryInfo.code,\r\n          countryName: this.countryInfo.name,\r\n          lastSeenAt: serverTimestamp(),\r\n          lastSessionStart: serverTimestamp()\r\n        });\r\n      } else {\r\n        // Create new player record\r\n        const newPlayer: Partial<PlayerStats> = {\r\n          odplayerId: this.playerId,\r\n          callsign,\r\n          country: this.countryInfo.code,\r\n          countryName: this.countryInfo.name,\r\n          totalPlayTimeSeconds: 0,\r\n          gamesPlayed: 0,\r\n          gamesWon: 0,\r\n          gamesLost: 0,\r\n          totalKills: 0,\r\n          totalDeaths: 0,\r\n          totalAssists: 0,\r\n          favoriteHero: heroId,\r\n          heroStats: {},\r\n          firstSeenAt: serverTimestamp(),\r\n          lastSeenAt: serverTimestamp(),\r\n          lastSessionStart: serverTimestamp()\r\n        };\r\n        await setDoc(playerRef, newPlayer);\r\n\r\n        // Update global stats - new unique player\r\n        await this.incrementGlobalStat('totalUniquePlayers', 1);\r\n        await this.updateCountryStats(this.countryInfo.code, 1);\r\n      }\r\n\r\n      console.log(`[PlayerStats] Session started for ${callsign}`);\r\n    } catch (e) {\r\n      console.error('[PlayerStats] Failed to start session:', e);\r\n    }\r\n  }\r\n\r\n  // Record a game result\r\n  async recordGameResult(won: boolean, kills: number, deaths: number, assists: number, heroId: string): Promise<void> {\r\n    if (!this.isInitialized || !this.currentSession) return;\r\n\r\n    const { doc, updateDoc, increment, serverTimestamp } = this.firebase;\r\n\r\n    // Update session data\r\n    this.currentSession.gamesPlayed++;\r\n    if (won) this.currentSession.gamesWon++;\r\n    this.currentSession.kills += kills;\r\n    this.currentSession.deaths += deaths;\r\n    this.currentSession.assists += assists;\r\n\r\n    try {\r\n      const playerRef = doc(this.db, 'playerStats', this.playerId);\r\n      \r\n      // Update player stats\r\n      await updateDoc(playerRef, {\r\n        gamesPlayed: increment(1),\r\n        gamesWon: increment(won ? 1 : 0),\r\n        gamesLost: increment(won ? 0 : 1),\r\n        totalKills: increment(kills),\r\n        totalDeaths: increment(deaths),\r\n        totalAssists: increment(assists),\r\n        lastSeenAt: serverTimestamp(),\r\n        [`heroStats.${heroId}.gamesPlayed`]: increment(1),\r\n        [`heroStats.${heroId}.gamesWon`]: increment(won ? 1 : 0),\r\n        [`heroStats.${heroId}.kills`]: increment(kills),\r\n        [`heroStats.${heroId}.deaths`]: increment(deaths)\r\n      });\r\n\r\n      // Update global stats\r\n      await this.incrementGlobalStat('totalGamesPlayed', 1);\r\n\r\n      console.log(`[PlayerStats] Game recorded: ${won ? 'WIN' : 'LOSS'} - K:${kills} D:${deaths} A:${assists}`);\r\n    } catch (e) {\r\n      console.error('[PlayerStats] Failed to record game:', e);\r\n    }\r\n  }\r\n\r\n  // End the current session and record playtime\r\n  async endSession(): Promise<void> {\r\n    if (!this.isInitialized || !this.currentSession) return;\r\n\r\n    const { doc, updateDoc, increment, serverTimestamp } = this.firebase;\r\n\r\n    const sessionDuration = Math.floor((Date.now() - this.currentSession.startTime) / 1000);\r\n\r\n    try {\r\n      const playerRef = doc(this.db, 'playerStats', this.playerId);\r\n      \r\n      await updateDoc(playerRef, {\r\n        totalPlayTimeSeconds: increment(sessionDuration),\r\n        lastSeenAt: serverTimestamp(),\r\n        [`heroStats.${this.currentSession.heroId}.playTimeSeconds`]: increment(sessionDuration)\r\n      });\r\n\r\n      // Update global playtime (in hours for display)\r\n      await this.incrementGlobalStat('totalPlayTimeHours', sessionDuration / 3600);\r\n\r\n      console.log(`[PlayerStats] Session ended. Duration: ${Math.floor(sessionDuration / 60)} minutes`);\r\n    } catch (e) {\r\n      console.error('[PlayerStats] Failed to end session:', e);\r\n      // If Firebase update fails, save to localStorage as fallback\r\n      this.saveUnsavedPlayTime(sessionDuration, this.currentSession.heroId);\r\n    }\r\n\r\n    this.currentSession = null;\r\n  }\r\n\r\n  // Save unsaved play time to localStorage (called on page unload when Firebase might not complete)\r\n  saveUnsavedPlayTimeSync(): void {\r\n    if (!this.currentSession) return;\r\n    \r\n    const sessionDuration = Math.floor((Date.now() - this.currentSession.startTime) / 1000);\r\n    if (sessionDuration < 5) return; // Skip very short sessions (< 5 seconds)\r\n    \r\n    this.saveUnsavedPlayTime(sessionDuration, this.currentSession.heroId);\r\n    console.log(`[PlayerStats] Saved unsaved play time to localStorage: ${sessionDuration}s`);\r\n  }\r\n\r\n  // Save unsaved play time to localStorage\r\n  private saveUnsavedPlayTime(seconds: number, heroId: string): void {\r\n    try {\r\n      const existing = localStorage.getItem(PlayerStatsServiceClass.UNSAVED_PLAYTIME_KEY);\r\n      const data = existing ? JSON.parse(existing) : { totalSeconds: 0, heroSeconds: {} };\r\n      \r\n      data.totalSeconds = (data.totalSeconds || 0) + seconds;\r\n      data.heroSeconds = data.heroSeconds || {};\r\n      data.heroSeconds[heroId] = (data.heroSeconds[heroId] || 0) + seconds;\r\n      data.playerId = this.playerId;\r\n      data.timestamp = Date.now();\r\n      \r\n      localStorage.setItem(PlayerStatsServiceClass.UNSAVED_PLAYTIME_KEY, JSON.stringify(data));\r\n    } catch (e) {\r\n      console.warn('[PlayerStats] Failed to save unsaved play time:', e);\r\n    }\r\n  }\r\n\r\n  // Recover and sync any unsaved play time from localStorage\r\n  private async recoverUnsavedPlayTime(): Promise<void> {\r\n    try {\r\n      const saved = localStorage.getItem(PlayerStatsServiceClass.UNSAVED_PLAYTIME_KEY);\r\n      if (!saved) return;\r\n      \r\n      const data = JSON.parse(saved);\r\n      \r\n      // Verify this is for the same player\r\n      if (data.playerId !== this.playerId) {\r\n        localStorage.removeItem(PlayerStatsServiceClass.UNSAVED_PLAYTIME_KEY);\r\n        return;\r\n      }\r\n      \r\n      // Skip if data is too old (> 7 days)\r\n      if (Date.now() - data.timestamp > 7 * 24 * 60 * 60 * 1000) {\r\n        localStorage.removeItem(PlayerStatsServiceClass.UNSAVED_PLAYTIME_KEY);\r\n        return;\r\n      }\r\n      \r\n      const { doc, updateDoc, increment, serverTimestamp } = this.firebase;\r\n      const playerRef = doc(this.db, 'playerStats', this.playerId);\r\n      \r\n      // Build update object\r\n      const updates: any = {\r\n        totalPlayTimeSeconds: increment(data.totalSeconds),\r\n        lastSeenAt: serverTimestamp()\r\n      };\r\n      \r\n      // Add hero-specific play time\r\n      for (const [heroId, seconds] of Object.entries(data.heroSeconds || {})) {\r\n        updates[`heroStats.${heroId}.playTimeSeconds`] = increment(seconds as number);\r\n      }\r\n      \r\n      await updateDoc(playerRef, updates);\r\n      \r\n      // Update global playtime\r\n      await this.incrementGlobalStat('totalPlayTimeHours', data.totalSeconds / 3600);\r\n      \r\n      // Clear saved data\r\n      localStorage.removeItem(PlayerStatsServiceClass.UNSAVED_PLAYTIME_KEY);\r\n      console.log(`[PlayerStats] Recovered ${Math.floor(data.totalSeconds / 60)} minutes of unsaved play time`);\r\n    } catch (e) {\r\n      console.warn('[PlayerStats] Failed to recover unsaved play time:', e);\r\n    }\r\n  }\r\n\r\n  // Increment a global statistic\r\n  private async incrementGlobalStat(field: string, value: number): Promise<void> {\r\n    const { doc, getDoc, setDoc, updateDoc, increment, serverTimestamp } = this.firebase;\r\n\r\n    try {\r\n      const globalRef = doc(this.db, 'globalStats', 'stats');\r\n      const globalDoc = await getDoc(globalRef);\r\n\r\n      if (globalDoc.exists()) {\r\n        await updateDoc(globalRef, {\r\n          [field]: increment(value),\r\n          lastUpdated: serverTimestamp()\r\n        });\r\n      } else {\r\n        // Create initial global stats document\r\n        await setDoc(globalRef, {\r\n          totalUniquePlayers: field === 'totalUniquePlayers' ? value : 0,\r\n          totalGamesPlayed: field === 'totalGamesPlayed' ? value : 0,\r\n          totalPlayTimeHours: field === 'totalPlayTimeHours' ? value : 0,\r\n          playersByCountry: {},\r\n          lastUpdated: serverTimestamp()\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.error('[PlayerStats] Failed to update global stat:', e);\r\n    }\r\n  }\r\n\r\n  // Update country player count\r\n  private async updateCountryStats(countryCode: string, delta: number): Promise<void> {\r\n    const { doc, updateDoc, increment, serverTimestamp } = this.firebase;\r\n\r\n    try {\r\n      const globalRef = doc(this.db, 'globalStats', 'stats');\r\n      await updateDoc(globalRef, {\r\n        [`playersByCountry.${countryCode}`]: increment(delta),\r\n        lastUpdated: serverTimestamp()\r\n      });\r\n    } catch (e) {\r\n      console.error('[PlayerStats] Failed to update country stats:', e);\r\n    }\r\n  }\r\n\r\n  // Get current player's stats (for display)\r\n  async getMyStats(): Promise<PlayerStats | null> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    const { doc, getDoc } = this.firebase;\r\n\r\n    try {\r\n      const playerRef = doc(this.db, 'playerStats', this.playerId);\r\n      const playerDoc = await getDoc(playerRef);\r\n      \r\n      if (playerDoc.exists()) {\r\n        return playerDoc.data() as PlayerStats;\r\n      }\r\n    } catch (e) {\r\n      console.error('[PlayerStats] Failed to get stats:', e);\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  // Get global stats (for webpage display)\r\n  async getGlobalStats(): Promise<GlobalStats | null> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    const { doc, getDoc } = this.firebase;\r\n\r\n    try {\r\n      const globalRef = doc(this.db, 'globalStats', 'stats');\r\n      const globalDoc = await getDoc(globalRef);\r\n      \r\n      if (globalDoc.exists()) {\r\n        return globalDoc.data() as GlobalStats;\r\n      }\r\n    } catch (e) {\r\n      console.error('[PlayerStats] Failed to get global stats:', e);\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  // Get player ID (for external use)\r\n  getPlayerId(): string {\r\n    return this.playerId;\r\n  }\r\n\r\n  // Check if session is active\r\n  hasActiveSession(): boolean {\r\n    return this.currentSession !== null;\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const PlayerStatsService = new PlayerStatsServiceClass();\r\n","// ============================================================================\r\n// GOOGLE ANALYTICS 4 SERVICE - Track user engagement and game events\r\n// ============================================================================\r\n// Provides automatic tracking for page views, sessions, countries\r\n// Plus custom events for game-specific metrics\r\n\r\n// Declare gtag function type\r\ndeclare global {\r\n  interface Window {\r\n    gtag: (...args: any[]) => void;\r\n    dataLayer: any[];\r\n  }\r\n}\r\n\r\n// GA4 Measurement ID (from Firebase config)\r\nconst GA_MEASUREMENT_ID = 'G-QNLH88NB94';\r\n\r\n// Custom event names for the game\r\nexport enum GameAnalyticsEvent {\r\n  // Session events\r\n  GameStart = 'game_start',\r\n  GameEnd = 'game_end',\r\n  \r\n  // Match events\r\n  MatchStart = 'match_start',\r\n  MatchEnd = 'match_end',\r\n  RoundStart = 'round_start',\r\n  RoundEnd = 'round_end',\r\n  \r\n  // Player events\r\n  PlayerJoin = 'player_join',\r\n  PlayerLeave = 'player_leave',\r\n  HeroSelect = 'hero_select',\r\n  \r\n  // Gameplay events\r\n  Kill = 'player_kill',\r\n  Death = 'player_death',\r\n  AbilityUse = 'ability_use',\r\n  WeaponPurchase = 'weapon_purchase',\r\n  \r\n  // UI events\r\n  SettingsOpen = 'settings_open',\r\n  HowToPlayOpen = 'how_to_play_open',\r\n  BuyMenuOpen = 'buy_menu_open',\r\n}\r\n\r\nclass AnalyticsServiceClass {\r\n  private initialized = false;\r\n\r\n  // Check if gtag is available\r\n  private isAvailable(): boolean {\r\n    return typeof window !== 'undefined' && typeof window.gtag === 'function';\r\n  }\r\n\r\n  // Initialize analytics (called on page load)\r\n  initialize(): void {\r\n    if (this.initialized) return;\r\n    \r\n    if (this.isAvailable()) {\r\n      this.initialized = true;\r\n      console.log('[Analytics] GA4 initialized');\r\n    } else {\r\n      console.warn('[Analytics] gtag not available - analytics disabled');\r\n    }\r\n  }\r\n\r\n  // Track a custom event\r\n  trackEvent(eventName: string | GameAnalyticsEvent, params?: Record<string, any>): void {\r\n    if (!this.isAvailable()) return;\r\n\r\n    try {\r\n      window.gtag('event', eventName, {\r\n        ...params,\r\n        send_to: GA_MEASUREMENT_ID,\r\n      });\r\n      \r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log(`[Analytics] Event: ${eventName}`, params);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Analytics] Failed to track event:', e);\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Game-specific tracking methods\r\n  // -------------------------------------------------------------------------\r\n\r\n  // Track when a player starts hosting or joining\r\n  trackGameStart(mode: 'host' | 'join', callsign: string): void {\r\n    this.trackEvent(GameAnalyticsEvent.GameStart, {\r\n      mode,\r\n      callsign_length: callsign.length, // Don't send actual name for privacy\r\n    });\r\n  }\r\n\r\n  // Track when player leaves the game\r\n  trackGameEnd(durationSeconds: number, gamesPlayed: number): void {\r\n    this.trackEvent(GameAnalyticsEvent.GameEnd, {\r\n      duration_seconds: durationSeconds,\r\n      games_played: gamesPlayed,\r\n    });\r\n  }\r\n\r\n  // Track match start\r\n  trackMatchStart(params: {\r\n    gameMode: string;\r\n    mapId: string;\r\n    playerCount: number;\r\n    botCount: number;\r\n    isHost: boolean;\r\n  }): void {\r\n    this.trackEvent(GameAnalyticsEvent.MatchStart, {\r\n      game_mode: params.gameMode,\r\n      map_id: params.mapId,\r\n      player_count: params.playerCount,\r\n      bot_count: params.botCount,\r\n      is_host: params.isHost,\r\n    });\r\n  }\r\n\r\n  // Track match end\r\n  trackMatchEnd(params: {\r\n    gameMode: string;\r\n    mapId: string;\r\n    won: boolean;\r\n    durationSeconds: number;\r\n    kills: number;\r\n    deaths: number;\r\n    assists: number;\r\n    heroId: string;\r\n  }): void {\r\n    this.trackEvent(GameAnalyticsEvent.MatchEnd, {\r\n      game_mode: params.gameMode,\r\n      map_id: params.mapId,\r\n      won: params.won,\r\n      duration_seconds: params.durationSeconds,\r\n      kills: params.kills,\r\n      deaths: params.deaths,\r\n      assists: params.assists,\r\n      hero_id: params.heroId,\r\n      kd_ratio: params.deaths > 0 ? (params.kills / params.deaths).toFixed(2) : params.kills,\r\n    });\r\n  }\r\n\r\n  // Track hero selection\r\n  trackHeroSelect(heroId: string): void {\r\n    this.trackEvent(GameAnalyticsEvent.HeroSelect, {\r\n      hero_id: heroId,\r\n    });\r\n  }\r\n\r\n  // Track ability usage\r\n  trackAbilityUse(heroId: string, abilityName: string, abilitySlot: string): void {\r\n    this.trackEvent(GameAnalyticsEvent.AbilityUse, {\r\n      hero_id: heroId,\r\n      ability_name: abilityName,\r\n      ability_slot: abilitySlot,\r\n    });\r\n  }\r\n\r\n  // Track weapon purchase\r\n  trackWeaponPurchase(weaponId: string, price: number): void {\r\n    this.trackEvent(GameAnalyticsEvent.WeaponPurchase, {\r\n      weapon_id: weaponId,\r\n      price,\r\n    });\r\n  }\r\n\r\n  // Track UI interactions\r\n  trackUIOpen(element: 'settings' | 'how_to_play' | 'buy_menu'): void {\r\n    const eventMap = {\r\n      settings: GameAnalyticsEvent.SettingsOpen,\r\n      how_to_play: GameAnalyticsEvent.HowToPlayOpen,\r\n      buy_menu: GameAnalyticsEvent.BuyMenuOpen,\r\n    };\r\n    this.trackEvent(eventMap[element]);\r\n  }\r\n\r\n  // Track round completion\r\n  trackRoundEnd(params: {\r\n    roundNumber: number;\r\n    won: boolean;\r\n    teamScore: number;\r\n    enemyScore: number;\r\n  }): void {\r\n    this.trackEvent(GameAnalyticsEvent.RoundEnd, {\r\n      round_number: params.roundNumber,\r\n      won: params.won,\r\n      team_score: params.teamScore,\r\n      enemy_score: params.enemyScore,\r\n    });\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // User properties (set once per session)\r\n  // -------------------------------------------------------------------------\r\n\r\n  setUserProperties(props: {\r\n    preferredHero?: string;\r\n    gamesPlayed?: number;\r\n    totalPlayTime?: number;\r\n  }): void {\r\n    if (!this.isAvailable()) return;\r\n\r\n    try {\r\n      window.gtag('set', 'user_properties', props);\r\n    } catch (e) {\r\n      console.warn('[Analytics] Failed to set user properties:', e);\r\n    }\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const AnalyticsService = new AnalyticsServiceClass();\r\n\r\n// Auto-initialize when module loads\r\nif (typeof window !== 'undefined') {\r\n  // Wait for gtag to be available\r\n  if (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', () => {\r\n      AnalyticsService.initialize();\r\n    });\r\n  } else {\r\n    AnalyticsService.initialize();\r\n  }\r\n}\r\n","// ============================================================================\r\n// MAIN GAME CLASS - Orchestrates all systems\r\n// ============================================================================\r\n\r\nimport { GameLoop, InputManager, Renderer } from '@/engine';\r\nimport { NetworkManager } from '@/network';\r\nimport { GameWorld } from '@/game/GameWorld';\r\nimport { GameRenderer } from '@/game/GameRenderer';\r\nimport { GameAudio, getGameAudio, SFX } from '@/game/GameAudio';\r\nimport { BotControllerFactory, BotAIMode } from '@/game/ai/BotControllerFactory';\r\nimport { \r\n  GameMode, \r\n  GamePhase, \r\n  Team, \r\n  HeroId, \r\n  PacketType, \r\n  PlayerInput,\r\n  Packet,\r\n  GameEventType,\r\n  GameState,\r\n  PlayerState,\r\n  ProjectileState,\r\n  ObjectiveState,\r\n  EntityId,\r\n} from '@/shared/types';\r\nimport { NETWORK, HEROES } from '@/shared/constants';\r\nimport { DEFAULT_CONFIG } from '@/shared/types';\r\nimport { FIREBASE_CONFIG } from '@/config/firebase.config';\r\nimport { PlayerStatsService } from '@/services/PlayerStatsService';\r\nimport { AnalyticsService } from '@/services/AnalyticsService';\r\n\r\nexport interface GameSettings {\r\n  enemyBotCount: number;\r\n  friendlyBotCount: number;\r\n  botDifficulty: 'easy' | 'medium' | 'hard';\r\n  gameMode: 'deathmatch' | 'spike';\r\n  mapId: string;\r\n  playerHero: string;\r\n  abilityQSlot: 1 | 2;  // Which ability (1 or 2) is assigned to Q key\r\n  abilityFSlot: 1 | 2;  // Which ability (1 or 2) is assigned to F key\r\n  totalRounds: number;  // Best of X (3, 5, 7, 9, 13)\r\n  aiMode?: 'rule_based' | 'slm';  // Bot AI mode (optional, defaults to rule_based)\r\n}\r\n\r\nexport interface LobbyPlayer {\r\n  id: string;  // peerId\r\n  name: string;\r\n  isHost: boolean;\r\n}\r\n\r\nexport interface GameOptions {\r\n  canvas: HTMLCanvasElement;\r\n  playerName: string;\r\n  settings?: GameSettings;\r\n  network?: NetworkManager;  // Existing network connection from lobby\r\n  lobbyPlayers?: LobbyPlayer[];  // Players from lobby with their names\r\n  appVersion?: string;  // Application version\r\n}\r\n\r\n// JSON-serializable version of GameState for network transmission\r\ninterface SerializedGameState {\r\n  phase: GamePhase;\r\n  mode: GameMode;\r\n  mapId: string;\r\n  tick: number;\r\n  time: number;\r\n  roundStartTime: number;\r\n  roundNumber: number;\r\n  maxRounds: number;\r\n  roundTimeLimit: number;\r\n  attackerScore: number;\r\n  defenderScore: number;\r\n  players: Array<[EntityId, PlayerState]>;\r\n  projectiles: Array<[EntityId, ProjectileState]>;\r\n  objectives: ObjectiveState;\r\n  recentShots?: Array<{\r\n    start: { x: number; y: number };\r\n    end: { x: number; y: number };\r\n    shooterId: EntityId;\r\n    shooterPeerId: string;\r\n  }>;\r\n  countdownTime?: number;\r\n  countdownPaused?: boolean;\r\n  countdownPausedBy?: string;\r\n  // Game pause state (tab focus sync)\r\n  gamePaused?: boolean;\r\n  gamePausedBy?: string;\r\n  // Disconnect forfeit state\r\n  disconnectForfeit?: boolean;\r\n  disconnectedPlayerName?: string;\r\n}\r\n\r\nconst DEFAULT_SETTINGS: GameSettings = {\r\n  enemyBotCount: 3,\r\n  friendlyBotCount: 0,\r\n  botDifficulty: 'medium',\r\n  gameMode: 'deathmatch',\r\n  playerHero: 'vanta',\r\n  abilityQSlot: 1,\r\n  abilityFSlot: 2,\r\n  totalRounds: 5,\r\n  mapId: 'neon_arena',\r\n};\r\n\r\nexport class Game {\r\n  // Core systems\r\n  private gameLoop: GameLoop;\r\n  private inputManager: InputManager;\r\n  private renderer: Renderer;\r\n  private audio: GameAudio;\r\n\r\n  // Game state\r\n  private world: GameWorld;\r\n  private gameRenderer: GameRenderer;\r\n\r\n  // Networking\r\n  private network: NetworkManager | null = null;\r\n  private existingNetwork: NetworkManager | null = null;  // From lobby\r\n  private lobbyPlayers: LobbyPlayer[] = [];  // Players from lobby\r\n  private isHost = false;\r\n  private localPeerId = '';\r\n  private debugBroadcastStarted = false;  // Debug flag for first broadcast\r\n\r\n  // Config\r\n  private playerName: string;\r\n  private canvas: HTMLCanvasElement;\r\n  private settings: GameSettings;\r\n\r\n  // State\r\n  private initialized = false;\r\n  private lastInputSendTime = 0;\r\n  private lastPingTime = 0;\r\n  private lastLocalFireTime = 0; // Track local player shooting for muzzle flash\r\n  private lastStateBroadcastTime = 0; // Track state broadcast for network sync\r\n\r\n  // Debug\r\n  private debugInfo: HTMLElement | null = null;\r\n  private debugLoggedNoPlayer = false; // Only log missing player warning once\r\n  private debugReceivedState = false; // Track if we've received state from host\r\n  \r\n  // Show FPS/Debug info (controlled from settings)\r\n  private showFPS = true;\r\n  \r\n  // Phase tracking for audio\r\n  private lastPhase: GamePhase = GamePhase.RoundActive;\r\n  private countdownSoundId: string | null = null; // Track countdown sound for pause/resume\r\n  private lastCountdownPaused: boolean = false; // Track pause state changes\r\n\r\n  // Hero tutorial system\r\n  private heroTutorialShown = false;\r\n  private heroTutorialOverlay: HTMLElement | null = null;\r\n\r\n  constructor(options: GameOptions) {\r\n    this.canvas = options.canvas;\r\n    this.playerName = options.playerName;\r\n    this.settings = options.settings || DEFAULT_SETTINGS;\r\n    this.existingNetwork = options.network || null;  // Accept existing network from lobby\r\n    this.lobbyPlayers = options.lobbyPlayers || [];  // Store lobby players\r\n    \r\n    console.log(`[Game] Constructor - existingNetwork: ${!!this.existingNetwork}, lobbyPlayers: ${this.lobbyPlayers.length}`);\r\n    console.log(`[Game] Ability settings - Q slot: ${this.settings.abilityQSlot}, F slot: ${this.settings.abilityFSlot}`);\r\n    if (this.existingNetwork) {\r\n      console.log(`[Game] Constructor - existing network has ${this.existingNetwork.getPeerIds().length} peers`);\r\n    }\r\n    \r\n    // Set bot AI mode from settings\r\n    if (this.settings.aiMode === 'slm') {\r\n      BotControllerFactory.setMode(BotAIMode.SLM);\r\n    } else {\r\n      BotControllerFactory.setMode(BotAIMode.RuleBased);\r\n    }\r\n    console.log(`[Game] Bot AI mode: ${BotControllerFactory.getModeName()}`);\r\n\r\n    // Initialize renderer\r\n    this.renderer = new Renderer(\r\n      this.canvas,\r\n      DEFAULT_CONFIG.canvasWidth,\r\n      DEFAULT_CONFIG.canvasHeight\r\n    );\r\n\r\n    // Initialize input\r\n    this.inputManager = new InputManager(this.canvas);\r\n\r\n    // Initialize audio (singleton)\r\n    this.audio = getGameAudio();\r\n\r\n    // Determine game mode from settings\r\n    const gameMode = this.settings.gameMode === 'spike' \r\n      ? GameMode.DataSpikeAssault \r\n      : GameMode.NeonDeathmatch;\r\n\r\n    // Initialize game world\r\n    this.world = new GameWorld({\r\n      mode: gameMode,\r\n      maxPlayers: 8,\r\n      isHost: true, // Start as host, change when joining\r\n      abilityQSlot: this.settings.abilityQSlot,\r\n      abilityFSlot: this.settings.abilityFSlot,\r\n      totalRounds: this.settings.totalRounds,\r\n      mapId: this.settings.mapId,\r\n    });\r\n\r\n    // Initialize game renderer\r\n    const version = options.appVersion || '0.0.0';\r\n    this.gameRenderer = new GameRenderer(this.renderer, this.world, version);\r\n\r\n    // Initialize game loop\r\n    this.gameLoop = new GameLoop(\r\n      DEFAULT_CONFIG.tickRate,\r\n      this.update.bind(this),\r\n      this.render.bind(this)\r\n    );\r\n\r\n    // Debug\r\n    this.debugInfo = document.getElementById('debug-info');\r\n  }\r\n\r\n  async init(): Promise<void> {\r\n    if (this.initialized) return;\r\n\r\n    // Initialize audio and load essential sounds\r\n    await this.audio.init();\r\n    await this.audio.loadEssentialSounds();\r\n\r\n    // Load assets (placeholder for now)\r\n    // await this.assetManager.loadAssets([...]);\r\n\r\n    this.initialized = true;\r\n    console.log('[Game] Initialized');\r\n  }\r\n\r\n  start(): void {\r\n    if (!this.initialized) {\r\n      console.error('[Game] Not initialized');\r\n      return;\r\n    }\r\n\r\n    this.gameLoop.start();\r\n    console.log('[Game] Started');\r\n    \r\n    // Show hero tutorial on first game with this hero\r\n    this.checkAndShowHeroTutorial();\r\n  }\r\n\r\n  stop(): void {\r\n    // Stop countdown sound if playing\r\n    if (this.countdownSoundId) {\r\n      this.audio.stop(this.countdownSoundId);\r\n      this.countdownSoundId = null;\r\n    }\r\n    this.gameLoop.stop();\r\n    console.log('[Game] Stopped');\r\n  }\r\n\r\n  pause(): void {\r\n    this.gameLoop.stop();\r\n    console.log('[Game] Paused');\r\n  }\r\n\r\n  resume(): void {\r\n    this.gameLoop.start();\r\n    console.log('[Game] Resumed');\r\n  }\r\n\r\n  isPaused(): boolean {\r\n    return !this.gameLoop.isRunning();\r\n  }\r\n\r\n  restartGame(): void {\r\n    if (!this.isHost) return;\r\n    \r\n    // Determine game mode from settings\r\n    const gameMode = this.settings.gameMode === 'spike' \r\n      ? GameMode.DataSpikeAssault \r\n      : GameMode.NeonDeathmatch;\r\n    \r\n    // Create fresh world\r\n    this.world = new GameWorld({\r\n      mode: gameMode,\r\n      maxPlayers: 8,\r\n      isHost: true,\r\n      abilityQSlot: this.settings.abilityQSlot,\r\n      abilityFSlot: this.settings.abilityFSlot,\r\n      totalRounds: this.settings.totalRounds,\r\n      mapId: this.settings.mapId,\r\n    });\r\n    this.gameRenderer.updateWorld(this.world);\r\n\r\n    // Get hero from settings\r\n    const heroId = this.getHeroFromSettings();\r\n\r\n    // Re-add local player with correct peerId\r\n    const player = this.world.addPlayer(\r\n      this.localPeerId || 'local',\r\n      this.playerName,\r\n      Team.Attackers,\r\n      heroId\r\n    );\r\n    this.world.setLocalPlayer(player.id);\r\n    \r\n    // Re-add connected remote players (multiplayer mode)\r\n    // Check if we have actual connected peers (not just a network for room display)\r\n    const connectedPeers = this.network?.getPeerCount() || 0;\r\n    const isMultiplayerGame = this.network !== null && connectedPeers > 0;\r\n    \r\n    if (isMultiplayerGame) {\r\n      const peerIds = this.network!.getPeerIds();\r\n      console.log(`[Game] Restart: Re-adding ${peerIds.length} connected peers to Defenders`);\r\n      for (const peerId of peerIds) {\r\n        // Try to find name from lobby players\r\n        const lobbyPlayer = this.lobbyPlayers.find(p => p.id === peerId);\r\n        const playerName = lobbyPlayer?.name || `Player ${peerId.slice(-4)}`;\r\n        this.world.addPlayer(peerId, playerName, Team.Defenders, HeroId.Vanta);\r\n      }\r\n      // In multiplayer, never spawn bots\r\n    } else {\r\n      // No connected peers - this is single player, add bots\r\n      const botCount = this.settings.enemyBotCount;\r\n      const difficulty = this.settings.botDifficulty;\r\n      if (botCount > 0) {\r\n        this.world.spawnBots(botCount, Team.Defenders, difficulty);\r\n        console.log(`[Game] Restart: Spawning ${botCount} enemy bots for single player`);\r\n      }\r\n      // Add friendly bots to player's team (Attackers)\r\n      const friendlyBotCount = this.settings.friendlyBotCount;\r\n      if (friendlyBotCount > 0) {\r\n        this.world.spawnBots(friendlyBotCount, Team.Attackers, difficulty);\r\n        console.log(`[Game] Restart: Spawning ${friendlyBotCount} friendly bots`);\r\n      }\r\n    }\r\n\r\n    // Start the round\r\n    this.world.setPhase(GamePhase.RoundActive);\r\n    this.world.startRound();\r\n\r\n    console.log('[Game] Restarted');\r\n  }\r\n\r\n  nextRound(): void {\r\n    if (!this.isHost) return;\r\n    \r\n    // Start the next round without resetting scores\r\n    this.world.setPhase(GamePhase.RoundActive);\r\n    this.world.startRound();\r\n\r\n    console.log('[Game] Next round started');\r\n  }\r\n\r\n  // Get round end info for UI\r\n  getRoundEndInfo(): { \r\n    isRoundOver: boolean; \r\n    isMatchOver: boolean;\r\n    winningTeam: 'attackers' | 'defenders'; \r\n    attackerScore: number; \r\n    defenderScore: number;\r\n    roundsToWin: number;\r\n    totalRounds: number;\r\n    isForfeit: boolean;\r\n    forfeitPlayerName: string;\r\n  } | null {\r\n    const phase = this.world.getPhase();\r\n    if (phase !== GamePhase.RoundEnd && phase !== GamePhase.MatchEnd) {\r\n      return null;\r\n    }\r\n    \r\n    const attackerScore = this.world.getAttackerScore();\r\n    const defenderScore = this.world.getDefenderScore();\r\n    const winningTeam = attackerScore > defenderScore ? 'attackers' : 'defenders';\r\n    \r\n    return {\r\n      isRoundOver: true,\r\n      isMatchOver: phase === GamePhase.MatchEnd,\r\n      winningTeam,\r\n      attackerScore,\r\n      defenderScore,\r\n      roundsToWin: this.world.getRoundsToWin(),\r\n      totalRounds: this.world.getTotalRounds(),\r\n      isForfeit: this.world.isDisconnectForfeit(),\r\n      forfeitPlayerName: this.world.getDisconnectedPlayerName(),\r\n    };\r\n  }\r\n\r\n  // Get countdown info for UI\r\n  getCountdownInfo(): {\r\n    countdownTime: number;\r\n    isPaused: boolean;\r\n    pausedBy: string;\r\n  } | null {\r\n    const phase = this.world.getPhase();\r\n    if (phase !== GamePhase.RoundEnd) {\r\n      return null;\r\n    }\r\n    \r\n    return {\r\n      countdownTime: this.world.getCountdownTime(),\r\n      isPaused: this.world.isCountdownPaused(),\r\n      pausedBy: this.world.getCountdownPausedBy(),\r\n    };\r\n  }\r\n\r\n  // Check if round is currently active\r\n  isRoundActive(): boolean {\r\n    return this.world.getPhase() === GamePhase.RoundActive;\r\n  }\r\n\r\n  // Get local player's current stats\r\n  getLocalPlayerStats(): { kills: number; deaths: number; assists: number; team: Team } | null {\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    if (!localPlayer) return null;\r\n    \r\n    return {\r\n      kills: localPlayer.kills,\r\n      deaths: localPlayer.deaths,\r\n      assists: localPlayer.assists,\r\n      team: localPlayer.team,\r\n    };\r\n  }\r\n\r\n  // Check if local player's team won the match\r\n  didLocalPlayerWin(): boolean {\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    if (!localPlayer) return false;\r\n    \r\n    const attackerScore = this.world.getAttackerScore();\r\n    const defenderScore = this.world.getDefenderScore();\r\n    \r\n    if (localPlayer.team === Team.Attackers) {\r\n      return attackerScore > defenderScore;\r\n    } else {\r\n      return defenderScore > attackerScore;\r\n    }\r\n  }\r\n\r\n  // Track session start time for duration calculation\r\n  private sessionStartTime: number = 0;\r\n  private gamesPlayedThisSession: number = 0;\r\n\r\n  // Start player stats session (call when game starts)\r\n  async startStatsSession(): Promise<void> {\r\n    this.sessionStartTime = Date.now();\r\n    this.gamesPlayedThisSession = 0;\r\n    \r\n    try {\r\n      await PlayerStatsService.startSession(this.playerName, this.settings.playerHero);\r\n      console.log('[Game] Stats session started');\r\n    } catch (e) {\r\n      console.warn('[Game] Failed to start stats session:', e);\r\n    }\r\n    \r\n    // Track in GA4\r\n    AnalyticsService.trackHeroSelect(this.settings.playerHero);\r\n  }\r\n\r\n  // Record match result to player stats and GA4\r\n  async recordMatchResult(): Promise<void> {\r\n    const stats = this.getLocalPlayerStats();\r\n    if (!stats) return;\r\n    \r\n    const won = this.didLocalPlayerWin();\r\n    this.gamesPlayedThisSession++;\r\n    \r\n    // Record to Firebase\r\n    try {\r\n      await PlayerStatsService.recordGameResult(\r\n        won,\r\n        stats.kills,\r\n        stats.deaths,\r\n        stats.assists,\r\n        this.settings.playerHero\r\n      );\r\n      console.log(`[Game] Match result recorded: ${won ? 'WIN' : 'LOSS'}`);\r\n    } catch (e) {\r\n      console.warn('[Game] Failed to record match result:', e);\r\n    }\r\n    \r\n    // Track in GA4\r\n    AnalyticsService.trackMatchEnd({\r\n      gameMode: this.settings.gameMode,\r\n      mapId: this.settings.mapId,\r\n      won,\r\n      durationSeconds: Math.floor((Date.now() - this.sessionStartTime) / 1000),\r\n      kills: stats.kills,\r\n      deaths: stats.deaths,\r\n      assists: stats.assists,\r\n      heroId: this.settings.playerHero,\r\n    });\r\n  }\r\n\r\n  // End player stats session (call when quitting to menu)\r\n  async endStatsSession(): Promise<void> {\r\n    const durationSeconds = Math.floor((Date.now() - this.sessionStartTime) / 1000);\r\n    \r\n    // End Firebase session\r\n    try {\r\n      await PlayerStatsService.endSession();\r\n      console.log('[Game] Stats session ended');\r\n    } catch (e) {\r\n      console.warn('[Game] Failed to end stats session:', e);\r\n    }\r\n    \r\n    // Track in GA4\r\n    AnalyticsService.trackGameEnd(durationSeconds, this.gamesPlayedThisSession);\r\n  }\r\n\r\n  // Synchronous version for page unload (saves to localStorage for later recovery)\r\n  saveStatsOnUnload(): void {\r\n    PlayerStatsService.saveUnsavedPlayTimeSync();\r\n    console.log('[Game] Stats saved to localStorage for recovery');\r\n  }\r\n\r\n  // Track match start (call when match begins)\r\n  trackMatchStart(): void {\r\n    const playerCount = this.lobbyPlayers.length || 1;\r\n    const botCount = this.settings.enemyBotCount + this.settings.friendlyBotCount;\r\n    \r\n    AnalyticsService.trackMatchStart({\r\n      gameMode: this.settings.gameMode,\r\n      mapId: this.settings.mapId,\r\n      playerCount,\r\n      botCount,\r\n      isHost: this.isHost,\r\n    });\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Networking\r\n  // -------------------------------------------------------------------------\r\n\r\n  async hostGame(roomCode?: string): Promise<string> {\r\n    this.isHost = true;\r\n    \r\n    console.log(`[Game] hostGame() called - existingNetwork: ${!!this.existingNetwork}`);\r\n    if (this.existingNetwork) {\r\n      console.log(`[Game] hostGame() - existingNetwork peers: ${this.existingNetwork.getPeerIds().length}`);\r\n    }\r\n    \r\n    // Determine game mode from settings\r\n    const gameMode = this.settings.gameMode === 'spike' \r\n      ? GameMode.DataSpikeAssault \r\n      : GameMode.NeonDeathmatch;\r\n    \r\n    // Create new world as host\r\n    this.world = new GameWorld({\r\n      mode: gameMode,\r\n      maxPlayers: 8,\r\n      isHost: true,\r\n      abilityQSlot: this.settings.abilityQSlot,\r\n      abilityFSlot: this.settings.abilityFSlot,\r\n      totalRounds: this.settings.totalRounds,\r\n      mapId: this.settings.mapId,\r\n    });\r\n    this.gameRenderer.updateWorld(this.world);\r\n\r\n    // Get hero from settings\r\n    const heroId = this.getHeroFromSettings();\r\n\r\n    // Use provided room code or generate one\r\n    let code = roomCode || this.generateRoomCode();\r\n    \r\n    // IMPORTANT: Add local player FIRST before network setup\r\n    // This ensures remote players go to the opposite team\r\n    this.localPeerId = 'local'; // Temporary, will be updated if network connects\r\n    \r\n    // Add local player to Attackers first\r\n    const player = this.world.addPlayer(\r\n      'local',  // Temporary peerId\r\n      this.playerName,\r\n      Team.Attackers,\r\n      heroId\r\n    );\r\n    this.world.setLocalPlayer(player.id);\r\n    \r\n    // Use existing network from lobby if available, otherwise create new\r\n    if (this.existingNetwork) {\r\n      console.log(`[Game] Using existing network from lobby`);\r\n      this.network = this.existingNetwork;\r\n      this.existingNetwork = null;\r\n      \r\n      // Debug: show peer info\r\n      const peerIds = this.network.getPeerIds();\r\n      const peerCount = this.network.getPeerCount();\r\n      console.log(`[Game] Network has ${peerCount} peers: [${peerIds.join(', ')}]`);\r\n      console.log(`[Game] Lobby players passed to game:`, this.lobbyPlayers);\r\n      \r\n      // Update local player's peerId to the real network peer ID\r\n      const realPeerId = this.network.getLocalPeerId();\r\n      this.localPeerId = realPeerId;\r\n      player.peerId = realPeerId;\r\n      this.world.updatePlayerPeerId('local', realPeerId);\r\n      \r\n      this.setupNetworkListeners();\r\n      // Room already created in lobby, use that room code\r\n      code = this.network.getRoomCode() || code;\r\n      console.log(`[Game] Using existing room: ${code}`);\r\n      \r\n      // IMPORTANT: Add players for peers that are ALREADY connected from the lobby\r\n      // These peers won't fire 'peerConnected' because they were connected before setupNetworkListeners\r\n      for (const peerId of peerIds) {\r\n        const lobbyPlayer = this.lobbyPlayers.find(p => p.id === peerId);\r\n        const playerName = lobbyPlayer?.name || `Player ${peerId.slice(-4)}`;\r\n        \r\n        // Add to Defenders (host is Attackers)\r\n        this.world.addPlayer(peerId, playerName, Team.Defenders, HeroId.Vanta);\r\n        console.log(`[Game] Added lobby player to game: ${playerName} (${peerId}) as Defender`);\r\n      }\r\n    } else {\r\n      // No existing network, create new (for single player or direct host)\r\n      try {\r\n        // Check if Firebase is configured\r\n        if (FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY') {\r\n          this.network = new NetworkManager({ isHost: true, useFirestore: true });\r\n          await this.network.connectWithFirebase(FIREBASE_CONFIG);\r\n          \r\n          // Update local player's peerId\r\n          const realPeerId = this.network.getLocalPeerId();\r\n          this.localPeerId = realPeerId;\r\n          player.peerId = realPeerId;\r\n          this.world.updatePlayerPeerId('local', realPeerId);\r\n          \r\n          this.setupNetworkListeners();\r\n          await this.network.createRoom();\r\n          console.log(`[Game] Connected to Firebase, hosting room: ${code}`);\r\n        } else {\r\n          // Fallback to WebSocket signaling server\r\n          this.network = new NetworkManager({ isHost: true });\r\n          await this.network.connect(NETWORK.SIGNALING_SERVER);\r\n          \r\n          // Update local player's peerId\r\n          const realPeerId = this.network.getLocalPeerId();\r\n          this.localPeerId = realPeerId;\r\n          player.peerId = realPeerId;\r\n          this.world.updatePlayerPeerId('local', realPeerId);\r\n          \r\n          this.setupNetworkListeners();\r\n          await this.network.createRoom();\r\n          console.log(`[Game] Connected to signaling server, hosting room: ${code}`);\r\n        }\r\n      } catch (e) {\r\n        console.log('[Game] Networking not available, running in local-only mode');\r\n        this.network = null;\r\n      }\r\n    }\r\n\r\n    // Check if this is a multiplayer game (we have network with actual peers connected)\r\n    // Solo play might have a network for room code display, but no connected peers\r\n    const connectedPeers = this.network?.getPeerCount() || 0;\r\n    const isMultiplayerGame = this.network !== null && connectedPeers > 0;\r\n    \r\n    // Only spawn bots if playing solo (no connected peers)\r\n    if (!isMultiplayerGame && this.settings.enemyBotCount > 0) {\r\n      const botCount = this.settings.enemyBotCount;\r\n      const difficulty = this.settings.botDifficulty;\r\n      this.world.spawnBots(botCount, Team.Defenders, difficulty);\r\n      console.log(`[Game] Solo mode: Spawning ${botCount} ${difficulty} enemy bots`);\r\n    } else if (isMultiplayerGame) {\r\n      console.log(`[Game] Multiplayer mode: No bots will be spawned (${connectedPeers} peers connected)`);\r\n    }\r\n    \r\n    // Add friendly bots to player's team (Attackers) in solo mode\r\n    if (!isMultiplayerGame && this.settings.friendlyBotCount > 0) {\r\n      const friendlyBotCount = this.settings.friendlyBotCount;\r\n      const difficulty = this.settings.botDifficulty;\r\n      this.world.spawnBots(friendlyBotCount, Team.Attackers, difficulty);\r\n      console.log(`[Game] Solo mode: Spawning ${friendlyBotCount} ${difficulty} friendly bots`);\r\n    }\r\n\r\n    // Start the game\r\n    this.world.setPhase(GamePhase.RoundActive);\r\n    this.world.startRound();\r\n    \r\n    // Play round start sound\r\n    this.audio.play(SFX.RoundStart);\r\n\r\n    // Debug: Log team composition\r\n    const attackers = this.world.getTeamPlayers(Team.Attackers);\r\n    const defenders = this.world.getTeamPlayers(Team.Defenders);\r\n    console.log(`[Game] Team composition - Attackers: ${attackers.length} (${attackers.map(p => `${p.name}/${p.peerId}/${p.alive}`).join(', ')})`);\r\n    console.log(`[Game] Team composition - Defenders: ${defenders.length} (${defenders.map(p => `${p.name}/${p.peerId}/${p.alive}`).join(', ')})`);\r\n    \r\n    if (defenders.length === 0 && isMultiplayerGame) {\r\n      console.warn(`[Game] WARNING: No defenders but this is a multiplayer game! Waiting for peers...`);\r\n    }\r\n\r\n    console.log(`[Game] Hosting game: ${code}, hero: ${heroId}`);\r\n    return code;\r\n  }\r\n\r\n  private generateRoomCode(): string {\r\n    const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; // No I, O to avoid confusion\r\n    const digits = '0123456789';\r\n    \r\n    let code = '';\r\n    for (let i = 0; i < 4; i++) {\r\n      code += letters.charAt(Math.floor(Math.random() * letters.length));\r\n    }\r\n    for (let i = 0; i < 2; i++) {\r\n      code += digits.charAt(Math.floor(Math.random() * digits.length));\r\n    }\r\n    \r\n    return code;\r\n  }\r\n\r\n  private getHeroFromSettings(): HeroId {\r\n    switch (this.settings.playerHero) {\r\n      case 'vanta': return HeroId.Vanta;\r\n      case 'spectre': return HeroId.Spectre;\r\n      case 'byte': return HeroId.Byte;\r\n      case 'katana': return HeroId.Katana;\r\n      case 'glyph': return HeroId.Glyph;\r\n      case 'spark': return HeroId.Spark;\r\n      case 'zero': return HeroId.Zero;\r\n      case 'mira': return HeroId.Mira;\r\n      default: return HeroId.Vanta;\r\n    }\r\n  }\r\n\r\n  async joinGame(roomCode: string): Promise<void> {\r\n    this.isHost = false;\r\n    \r\n    // Determine game mode from settings\r\n    const gameMode = this.settings.gameMode === 'spike' \r\n      ? GameMode.DataSpikeAssault \r\n      : GameMode.NeonDeathmatch;\r\n    \r\n    // Create world as client (will receive state from host)\r\n    this.world = new GameWorld({\r\n      mode: gameMode,\r\n      maxPlayers: 8,\r\n      isHost: false,\r\n      abilityQSlot: this.settings.abilityQSlot,\r\n      abilityFSlot: this.settings.abilityFSlot,\r\n      totalRounds: this.settings.totalRounds,\r\n      mapId: this.settings.mapId,\r\n    });\r\n    this.gameRenderer.updateWorld(this.world);\r\n\r\n    // Use existing network from lobby if available\r\n    if (this.existingNetwork) {\r\n      console.log(`[Game] Using existing network from lobby for joining`);\r\n      this.network = this.existingNetwork;\r\n      this.existingNetwork = null;\r\n      this.setupNetworkListeners();\r\n      this.localPeerId = this.network.getLocalPeerId();\r\n    } else {\r\n      // No existing network, create new connection\r\n      try {\r\n        if (FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY') {\r\n          this.network = new NetworkManager({ isHost: false, useFirestore: true });\r\n          await this.network.connectWithFirebase(FIREBASE_CONFIG);\r\n          console.log(`[Game] Connected to Firebase for joining`);\r\n        } else {\r\n          this.network = new NetworkManager({ isHost: false });\r\n          await this.network.connect(NETWORK.SIGNALING_SERVER);\r\n          console.log(`[Game] Connected to signaling server for joining`);\r\n        }\r\n        \r\n        this.setupNetworkListeners();\r\n        \r\n        // Join the room\r\n        await this.network.joinRoom(roomCode);\r\n        console.log(`[Game] Joining room: ${roomCode}`);\r\n        \r\n        this.localPeerId = this.network.getLocalPeerId();\r\n      } catch (e) {\r\n        console.error('[Game] Failed to join game:', e);\r\n        throw new Error('Could not connect. Make sure Firebase is configured or the signaling server is running.');\r\n      }\r\n    }\r\n    \r\n    // Get hero from settings\r\n    const heroId = this.getHeroFromSettings();\r\n    \r\n    // Add local player (will be synced with host)\r\n    const player = this.world.addPlayer(\r\n      this.localPeerId,\r\n      this.playerName,\r\n      Team.Defenders, // Will be assigned by host\r\n      heroId\r\n    );\r\n    this.world.setLocalPlayer(player.id);\r\n    \r\n    // Notify host that we've joined with our info\r\n    if (this.network) {\r\n      this.network.broadcast({\r\n        type: PacketType.PlayerJoin,\r\n        timestamp: Date.now(),\r\n        senderId: this.localPeerId,\r\n        data: {\r\n          name: this.playerName,\r\n          heroId: heroId,\r\n        },\r\n      });\r\n      console.log(`[Game] Sent PlayerJoin to host`);\r\n    }\r\n    \r\n    // Wait for connection to host\r\n    console.log(`[Game] Waiting for connection to host...`);\r\n  }\r\n\r\n  leaveGame(): void {\r\n    this.network?.disconnect();\r\n    this.network = null;\r\n    this.world.setPhase(GamePhase.Lobby);\r\n  }\r\n\r\n  // Called when networking is set up\r\n  protected setupNetworkListeners(): void {\r\n    if (!this.network) return;\r\n\r\n    this.network.on('peerConnected', ({ peerId }) => {\r\n      console.log(`[Game] Peer connected: ${peerId}`);\r\n      \r\n      if (this.isHost) {\r\n        // Check if player already exists (from lobby or previous connection)\r\n        const existingPlayer = this.world.getPlayerByPeerId(peerId);\r\n        if (!existingPlayer) {\r\n          // Try to find name from lobby players\r\n          const lobbyPlayer = this.lobbyPlayers.find(p => p.id === peerId);\r\n          const playerName = lobbyPlayer?.name || `Player ${peerId.slice(-4)}`;\r\n          \r\n          // Remote players go to Defenders (host is always Attackers)\r\n          this.world.addPlayer(peerId, playerName, Team.Defenders, HeroId.Vanta);\r\n          console.log(`[Game] Added new player ${peerId} to Defenders: \"${playerName}\"`);\r\n          \r\n          // If this is a late-joiner (not from lobby), require PlayerJoin within 10 seconds\r\n          if (!lobbyPlayer) {\r\n            setTimeout(() => {\r\n              const p = this.world.getPlayerByPeerId(peerId);\r\n              // If player still has placeholder name, they never sent PlayerJoin - remove them\r\n              if (p && p.name === playerName && p.name.startsWith('Player ')) {\r\n                console.log(`[Game] Removing unverified player ${peerId} (no PlayerJoin received)`);\r\n                this.world.removePlayer(p.id);\r\n              }\r\n            }, 10000);\r\n          }\r\n        } else {\r\n          // Player reconnected - clear disconnected flag\r\n          if (existingPlayer.isDisconnected) {\r\n            existingPlayer.isDisconnected = false;\r\n            console.log(`[Game] Player ${peerId} reconnected: ${existingPlayer.name}`);\r\n          } else {\r\n            console.log(`[Game] Player ${peerId} already exists: ${existingPlayer.name}`);\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    this.network.on('peerDisconnected', ({ peerId }) => {\r\n      console.log(`[Game] Peer disconnected: ${peerId}`);\r\n      \r\n      const player = this.world.getPlayerByPeerId(peerId);\r\n      if (player && this.isHost) {\r\n        // Check if this is a human player (not a bot) in a multiplayer match\r\n        const humanPlayers = this.world.getPlayers().filter(p => !p.peerId.startsWith('bot_'));\r\n        const remainingHumans = humanPlayers.filter(p => p.peerId !== peerId && !p.isDisconnected);\r\n        \r\n        console.log(`[Game] Player ${player.name} disconnected. Remaining human players: ${remainingHumans.length}`);\r\n        \r\n        // If the match is still active and this leaves only the host\r\n        if (this.world.getPhase() !== GamePhase.MatchEnd && remainingHumans.length <= 1) {\r\n          // End the match - disconnected player forfeits\r\n          this.world.endMatchByDisconnect(player.team, player.name);\r\n          console.log(`[Game] Match ended - ${player.name} forfeited by disconnecting`);\r\n        } else {\r\n          // Mark as disconnected but don't end match (might be bots remaining or multiple players)\r\n          player.isDisconnected = true;\r\n          console.log(`[Game] Marked player ${player.name} (${peerId}) as disconnected`);\r\n          \r\n          // Remove after a timeout if they don't reconnect\r\n          setTimeout(() => {\r\n            const p = this.world.getPlayerByPeerId(peerId);\r\n            if (p && p.isDisconnected) {\r\n              console.log(`[Game] Removing disconnected player ${p.name} (${peerId}) after timeout`);\r\n              this.world.removePlayer(p.id);\r\n            }\r\n          }, 30000); // 30 second grace period\r\n        }\r\n      }\r\n    });\r\n\r\n    this.network.on('packet', ({ peerId, packet }) => {\r\n      this.handlePacket(peerId, packet);\r\n    });\r\n    \r\n    // Handle peers that were already connected from lobby\r\n    // (their peerConnected event fired before we set up these listeners)\r\n    if (this.isHost) {\r\n      const existingPeers = this.network.getPeerIds();\r\n      console.log(`[Game] Found ${existingPeers.length} existing peers from lobby`);\r\n      console.log(`[Game] Lobby players:`, this.lobbyPlayers);\r\n      \r\n      for (const peerId of existingPeers) {\r\n        // Remote players always go to Defenders team (opposite of host who is Attackers)\r\n        const existingPlayer = this.world.getPlayerByPeerId(peerId);\r\n        if (!existingPlayer) {\r\n          // Try to find name from lobby players\r\n          const lobbyPlayer = this.lobbyPlayers.find(p => p.id === peerId);\r\n          const playerName = lobbyPlayer?.name || `Player ${peerId.slice(-4)}`;\r\n          \r\n          this.world.addPlayer(peerId, playerName, Team.Defenders, HeroId.Vanta);\r\n          console.log(`[Game] Added remote player ${peerId} to Defenders: \"${playerName}\"`);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private handlePacket(peerId: string, packet: Packet): void {\r\n    switch (packet.type) {\r\n      case PacketType.PlayerJoin:\r\n        if (this.isHost) {\r\n          // A player joined - update their info\r\n          const data = packet.data as { name: string; heroId: HeroId };\r\n          console.log(`[Game] Received PlayerJoin from ${peerId}: name=${data.name}, hero=${data.heroId}`);\r\n          \r\n          // Check if player already exists by peerId\r\n          let player = this.world.getPlayerByPeerId(peerId);\r\n          if (player) {\r\n            // Update existing player info with real name and hero\r\n            const oldName = player.name;\r\n            player.name = data.name;\r\n            if (data.heroId) {\r\n              player.heroId = data.heroId;\r\n            }\r\n            console.log(`[Game] Updated player ${peerId}: \"${oldName}\" -> \"${data.name}\"`);\r\n          } else {\r\n            // Check if there's a disconnected player with the same name (reconnecting with new peerId)\r\n            const existingByName = this.world.getPlayerByName(data.name);\r\n            if (existingByName && existingByName.isDisconnected) {\r\n              // This is a reconnection with a new peerId - update the old player\r\n              const oldPeerId = existingByName.peerId;\r\n              this.world.updatePlayerPeerId(oldPeerId, peerId);\r\n              existingByName.isDisconnected = false;\r\n              if (data.heroId) {\r\n                existingByName.heroId = data.heroId;\r\n              }\r\n              console.log(`[Game] Reconnected player ${data.name}: ${oldPeerId} -> ${peerId}`);\r\n            } else if (existingByName) {\r\n              // Player with same name already exists and is connected - this is a duplicate\r\n              // Remove the placeholder player we just added for this peerId\r\n              const placeholderPlayer = this.world.getPlayerByPeerId(peerId);\r\n              if (placeholderPlayer) {\r\n                console.log(`[Game] Removing duplicate player ${peerId} (${data.name} already exists)`);\r\n                this.world.removePlayer(placeholderPlayer.id);\r\n              }\r\n            } else {\r\n              // Genuinely new player\r\n              player = this.world.addPlayer(peerId, data.name, Team.Defenders, data.heroId || HeroId.Vanta);\r\n              console.log(`[Game] Created player ${peerId}: \"${data.name}\"`);\r\n            }\r\n          }\r\n        }\r\n        break;\r\n        \r\n      case PacketType.Input:\r\n        if (this.isHost) {\r\n          // Handle input from remote player\r\n          const inputData = packet.data as PlayerInput;\r\n          const player = this.world.getPlayerByPeerId(peerId);\r\n          if (player && player.alive) {\r\n            player.setInput(inputData);\r\n            // Debug: log interact input from remote players\r\n            if (inputData.interact) {\r\n              console.log(`[Game] Input from ${player.name} (${peerId}): interact=true`);\r\n            }\r\n            // Debug: log when input has movement\r\n            if (inputData.moveX !== 0 || inputData.moveY !== 0) {\r\n              console.log(`[Game] Input from ${player.name}: move(${inputData.moveX.toFixed(1)}, ${inputData.moveY.toFixed(1)})`);\r\n            }\r\n          } else if (!player) {\r\n            console.log(`[Game] Input from unknown peer: ${peerId}`);\r\n          }\r\n        }\r\n        break;\r\n\r\n      case PacketType.StateSnapshot:\r\n        if (!this.isHost) {\r\n          // Apply state from host\r\n          const stateData = packet.data as SerializedGameState;\r\n          \r\n          // Debug: log first state received\r\n          if (!this.debugReceivedState) {\r\n            console.log(`[Game] First state received from host - phase: ${stateData.phase}, players: ${stateData.players?.length || 0}`);\r\n            this.debugReceivedState = true;\r\n          }\r\n          \r\n          this.applySerializedState(stateData);\r\n        }\r\n        break;\r\n\r\n      case PacketType.CountdownPause:\r\n        if (this.isHost) {\r\n          // Client requested pause\r\n          const player = this.world.getPlayerByPeerId(peerId);\r\n          const playerName = player?.name || 'Unknown';\r\n          this.world.pauseCountdown(playerName);\r\n        }\r\n        break;\r\n\r\n      case PacketType.CountdownResume:\r\n        if (this.isHost) {\r\n          // Client requested resume\r\n          const player = this.world.getPlayerByPeerId(peerId);\r\n          const playerName = player?.name || 'Unknown';\r\n          this.world.resumeCountdown(playerName);\r\n        }\r\n        break;\r\n\r\n      case PacketType.GamePause:\r\n        if (this.isHost) {\r\n          // Client lost tab focus\r\n          const player = this.world.getPlayerByPeerId(peerId);\r\n          const playerName = player?.name || 'Unknown';\r\n          this.world.playerLostFocus(peerId, playerName);\r\n        }\r\n        break;\r\n\r\n      case PacketType.GameResume:\r\n        if (this.isHost) {\r\n          // Client regained tab focus\r\n          const player = this.world.getPlayerByPeerId(peerId);\r\n          const playerName = player?.name || 'Unknown';\r\n          this.world.playerRegainedFocus(peerId, playerName);\r\n        }\r\n        break;\r\n    }\r\n  }\r\n  \r\n  // Convert GameState to JSON-serializable format\r\n  private serializeState(): SerializedGameState {\r\n    const state = this.world.getState();\r\n    return {\r\n      phase: state.phase,\r\n      mode: state.mode,\r\n      mapId: state.mapId,\r\n      tick: state.tick,\r\n      time: state.time,\r\n      roundStartTime: state.roundStartTime,\r\n      roundNumber: state.roundNumber,\r\n      maxRounds: state.maxRounds,\r\n      roundTimeLimit: state.roundTimeLimit,\r\n      attackerScore: state.attackerScore,\r\n      defenderScore: state.defenderScore,\r\n      players: Array.from(state.players.entries()),\r\n      projectiles: Array.from(state.projectiles.entries()),\r\n      objectives: state.objectives,\r\n      recentShots: state.recentShots || [],\r\n      countdownTime: state.countdownTime ?? 10000,\r\n      countdownPaused: state.countdownPaused ?? false,\r\n      countdownPausedBy: state.countdownPausedBy ?? '',\r\n      gamePaused: this.world.isGamePaused(),\r\n      gamePausedBy: this.world.getGamePausedBy(),\r\n      disconnectForfeit: this.world.isDisconnectForfeit(),\r\n      disconnectedPlayerName: this.world.getDisconnectedPlayerName(),\r\n    };\r\n  }\r\n  \r\n  // Apply serialized state from network\r\n  private applySerializedState(data: SerializedGameState): void {\r\n    // Convert arrays back to Maps\r\n    const state: GameState = {\r\n      phase: data.phase,\r\n      mode: data.mode,\r\n      mapId: data.mapId,\r\n      tick: data.tick,\r\n      time: data.time,\r\n      roundStartTime: data.roundStartTime,\r\n      roundNumber: data.roundNumber,\r\n      maxRounds: data.maxRounds,\r\n      roundTimeLimit: data.roundTimeLimit,\r\n      attackerScore: data.attackerScore,\r\n      defenderScore: data.defenderScore,\r\n      players: new Map(data.players),\r\n      projectiles: new Map(data.projectiles),\r\n      objectives: data.objectives,\r\n      recentShots: data.recentShots || [],\r\n      countdownTime: data.countdownTime ?? 10000,\r\n      countdownPaused: data.countdownPaused ?? false,\r\n      countdownPausedBy: data.countdownPausedBy ?? '',\r\n    };\r\n    \r\n    this.world.applyState(state);\r\n    \r\n    // Apply game pause state from host (for clients)\r\n    if (data.gamePaused !== undefined) {\r\n      this.world.setGamePauseState(data.gamePaused, data.gamePausedBy ?? '');\r\n    }\r\n    \r\n    // Apply disconnect forfeit state from host (for clients)\r\n    if (data.disconnectForfeit !== undefined) {\r\n      this.world.setDisconnectForfeitState(data.disconnectForfeit, data.disconnectedPlayerName ?? '');\r\n    }\r\n    \r\n    // Add bullet tracers from host for visualization\r\n    // Skip local player's shots - they're already shown via client-side prediction\r\n    if (state.recentShots) {\r\n      const localPlayer = this.world.getLocalPlayer();\r\n      for (const shot of state.recentShots) {\r\n        // Skip our own shots (already predicted locally)\r\n        // Compare by peerId since entity IDs differ between host and client\r\n        if (localPlayer && shot.shooterPeerId === localPlayer.peerId) {\r\n          continue;\r\n        }\r\n        const isEnemy = this.world.isEnemyOfLocal(shot.shooterId);\r\n        this.gameRenderer.addBulletTracer(shot.start, shot.end, isEnemy);\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Toggle countdown pause (can be called by any player)\r\n  toggleCountdownPause(): void {\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    const playerName = localPlayer?.name || 'Unknown';\r\n    \r\n    if (this.isHost) {\r\n      // Host can toggle directly\r\n      this.world.toggleCountdownPause(playerName);\r\n    } else if (this.network) {\r\n      // Client sends request to host\r\n      const isPaused = this.world.isCountdownPaused();\r\n      this.network.broadcast({\r\n        type: isPaused ? PacketType.CountdownResume : PacketType.CountdownPause,\r\n        timestamp: Date.now(),\r\n        senderId: this.network.getLocalPeerId(),\r\n        data: { playerName },\r\n      });\r\n    }\r\n  }\r\n\r\n  // Called when player's tab loses focus (for multiplayer pause sync)\r\n  onTabBlur(): void {\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    const playerName = localPlayer?.name || 'Unknown';\r\n    const peerId = localPlayer?.peerId || this.localPeerId;\r\n    \r\n    if (this.isHost) {\r\n      // Host can pause directly\r\n      this.world.playerLostFocus(peerId, playerName);\r\n    } else if (this.network) {\r\n      // Client sends pause request to host\r\n      this.network.broadcast({\r\n        type: PacketType.GamePause,\r\n        timestamp: Date.now(),\r\n        senderId: this.network.getLocalPeerId(),\r\n        data: { playerName },\r\n      });\r\n    }\r\n    console.log(`[Game] Tab blur - requesting game pause for ${playerName}`);\r\n  }\r\n\r\n  // Called when player's tab regains focus (for multiplayer pause sync)\r\n  onTabFocus(): void {\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    const playerName = localPlayer?.name || 'Unknown';\r\n    const peerId = localPlayer?.peerId || this.localPeerId;\r\n    \r\n    if (this.isHost) {\r\n      // Host can resume directly\r\n      this.world.playerRegainedFocus(peerId, playerName);\r\n    } else if (this.network) {\r\n      // Client sends resume request to host\r\n      this.network.broadcast({\r\n        type: PacketType.GameResume,\r\n        timestamp: Date.now(),\r\n        senderId: this.network.getLocalPeerId(),\r\n        data: { playerName },\r\n      });\r\n    }\r\n    console.log(`[Game] Tab focus - requesting game resume for ${playerName}`);\r\n  }\r\n\r\n  // Check if game is paused due to tab focus\r\n  isGamePausedByFocus(): boolean {\r\n    return this.world.isGamePaused();\r\n  }\r\n\r\n  getGamePausedInfo(): { isPaused: boolean; pausedBy: string; pausedCount: number } {\r\n    return {\r\n      isPaused: this.world.isGamePaused(),\r\n      pausedBy: this.world.getGamePausedBy(),\r\n      pausedCount: this.world.getPausedPlayerCount(),\r\n    };\r\n  }\r\n  \r\n  // Get current audio settings\r\n  getAudioSettings(): ReturnType<typeof this.audio.getSettings> {\r\n    return this.audio.getSettings();\r\n  }\r\n  \r\n  // Update audio settings\r\n  updateAudioSettings(settings: Parameters<typeof this.audio.updateSettings>[0]): void {\r\n    this.audio.updateSettings(settings);\r\n  }\r\n  \r\n  // Broadcast game state to all clients\r\n  private broadcastState(): void {\r\n    if (!this.network || !this.isHost) return;\r\n    \r\n    // Debug: log first broadcast\r\n    if (!this.debugBroadcastStarted) {\r\n      console.log(`[Game] Starting state broadcasts to ${this.network.getPeerCount()} peers`);\r\n      this.debugBroadcastStarted = true;\r\n    }\r\n    \r\n    const serializedState = this.serializeState();\r\n    this.network.broadcast({\r\n      type: PacketType.StateSnapshot,\r\n      timestamp: Date.now(),\r\n      senderId: this.localPeerId,\r\n      data: serializedState,\r\n    });\r\n  }\r\n\r\n  private handleGameEvent(event: { type: GameEventType; data: unknown }): void {\r\n    switch (event.type) {\r\n      case GameEventType.PlayerKill: {\r\n        const data = event.data as { victimId: string; killerId: string };\r\n        const victim = this.world.getPlayer(data.victimId);\r\n        const localPlayer = this.world.getLocalPlayer();\r\n        if (victim) {\r\n          this.gameRenderer.addPlayerDeath(victim.position);\r\n          // Play death sound for everyone\r\n          this.audio.play(SFX.PlayerDeath);\r\n          // Play kill confirmed only for the killer (with slight delay so it's not masked)\r\n          if (localPlayer && data.killerId === localPlayer.id) {\r\n            setTimeout(() => {\r\n              this.audio.play(SFX.KillConfirmed, 1.0);\r\n            }, 200);\r\n          }\r\n        }\r\n        break;\r\n      }\r\n      case GameEventType.PlayerDamage: {\r\n        const data = event.data as { targetId: string; position?: { x: number; y: number } };\r\n        const target = this.world.getPlayer(data.targetId);\r\n        if (target && data.position) {\r\n          const direction = {\r\n            x: target.position.x - data.position.x,\r\n            y: target.position.y - data.position.y,\r\n          };\r\n          this.gameRenderer.addPlayerHit(data.position, direction);\r\n          // Play damage sound\r\n          this.audio.playWithVariation(SFX.PlayerDamage, 0.8);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Play weapon shooting sound based on weapon ID\r\n   */\r\n  private playWeaponSound(weaponId: string): void {\r\n    switch (weaponId) {\r\n      case 'burst_pistol':\r\n        this.audio.playWithVariation(SFX.PulsePistolShoot);\r\n        break;\r\n      case 'neo_smg9':\r\n      case 'pulse_rifle':\r\n        this.audio.playWithVariation(SFX.PlasmaRifleShoot);\r\n        break;\r\n      case 'scatter_shot':\r\n        this.audio.playWithVariation(SFX.ScatterGunShoot);\r\n        break;\r\n      case 'rail_sniper':\r\n        this.audio.playWithVariation(SFX.FusionCannonShoot);\r\n        break;\r\n      default:\r\n        // Default to pulse pistol sound\r\n        this.audio.playWithVariation(SFX.PulsePistolShoot);\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Game Loop\r\n  // -------------------------------------------------------------------------\r\n\r\n  private update(dt: number, _time: number): void {\r\n    // Update input\r\n    this.inputManager.update();\r\n    this.updateCameraInput();\r\n\r\n    // Only process player input during active gameplay\r\n    const currentPhase = this.world.getPhase();\r\n    const isRoundActive = currentPhase === GamePhase.RoundActive;\r\n    \r\n    // Detect phase transitions for audio cues\r\n    if (currentPhase !== this.lastPhase) {\r\n      // Round just ended - play countdown sound synced with timer\r\n      if (currentPhase === GamePhase.RoundEnd && this.lastPhase === GamePhase.RoundActive) {\r\n        // Stop any existing countdown sound\r\n        if (this.countdownSoundId) {\r\n          this.audio.stop(this.countdownSoundId);\r\n        }\r\n        // Play countdown sound - assumes sound file starts immediately with \"10\"\r\n        const countdownTime = this.world.getCountdownTime();\r\n        const soundDuration = this.audio.getSoundDuration(SFX.CountdownTick);\r\n        // Calculate offset based on remaining countdown time\r\n        const offset = Math.max(0, soundDuration - (countdownTime / 1000));\r\n        this.countdownSoundId = this.audio.playAtOffset(SFX.CountdownTick, offset);\r\n        this.lastCountdownPaused = false;\r\n      }\r\n      // Round just started - stop countdown sound and play round start sound\r\n      if (currentPhase === GamePhase.RoundActive && this.lastPhase === GamePhase.RoundEnd) {\r\n        if (this.countdownSoundId) {\r\n          this.audio.stop(this.countdownSoundId);\r\n          this.countdownSoundId = null;\r\n        }\r\n        this.audio.play(SFX.RoundStart);\r\n        \r\n        // Reset all inputs to prevent held buttons from carrying over between rounds\r\n        this.inputManager.resetAllInputs();\r\n      }\r\n      this.lastPhase = currentPhase;\r\n    }\r\n    \r\n    // Handle countdown pause/resume\r\n    if (currentPhase === GamePhase.RoundEnd) {\r\n      const isPaused = this.world.isCountdownPaused();\r\n      if (isPaused !== this.lastCountdownPaused) {\r\n        if (isPaused) {\r\n          // Pause - stop the sound\r\n          if (this.countdownSoundId) {\r\n            this.audio.stop(this.countdownSoundId);\r\n            this.countdownSoundId = null;\r\n          }\r\n        } else {\r\n          // Resume - restart sound from current position\r\n          const countdownTime = this.world.getCountdownTime();\r\n          const soundDuration = this.audio.getSoundDuration(SFX.CountdownTick);\r\n          const offset = Math.max(0, soundDuration - (countdownTime / 1000));\r\n          this.countdownSoundId = this.audio.playAtOffset(SFX.CountdownTick, offset);\r\n        }\r\n        this.lastCountdownPaused = isPaused;\r\n      }\r\n    }\r\n\r\n    // Get local player input\r\n    const localPlayer = this.world.getLocalPlayer();\r\n    \r\n    // Debug: log once if local player is missing\r\n    if (!localPlayer && isRoundActive && !this.debugLoggedNoPlayer) {\r\n      console.log(`[Game] WARNING: No local player found! isHost=${this.isHost}, localPlayerId=${this.world['localPlayerId']}`);\r\n      this.debugLoggedNoPlayer = true;\r\n    }\r\n    \r\n    if (localPlayer && isRoundActive) {\r\n      const inputState = this.inputManager.getState();\r\n      const playerInput: PlayerInput = {\r\n        moveX: inputState.moveX,\r\n        moveY: inputState.moveY,\r\n        aimX: inputState.aimX,\r\n        aimY: inputState.aimY,\r\n        shoot: inputState.shoot,\r\n        reload: inputState.reload,\r\n        interact: inputState.interact,\r\n        ability1: inputState.ability1,\r\n        ability2: inputState.ability2,\r\n        ultimate: inputState.ultimate,\r\n        weaponSlot: inputState.weaponSlot,\r\n        sequence: this.inputManager.getNextSequence(),\r\n      };\r\n\r\n      // Apply input locally\r\n      localPlayer.setInput(playerInput);\r\n\r\n      // Handle weapon switching (1-5 keys or mouse wheel)\r\n      if (inputState.weaponSlot !== 0 && localPlayer.alive) {\r\n        let switched = false;\r\n        if (inputState.weaponSlot === -1) {\r\n          // Mouse wheel down = next weapon\r\n          switched = localPlayer.cycleWeaponNext();\r\n        } else if (inputState.weaponSlot === -2) {\r\n          // Mouse wheel up = previous weapon\r\n          switched = localPlayer.cycleWeaponPrevious();\r\n        } else if (inputState.weaponSlot > 0) {\r\n          // Number key = direct slot selection\r\n          switched = localPlayer.switchToWeaponSlot(inputState.weaponSlot);\r\n        }\r\n        if (switched) {\r\n          this.gameRenderer.addWeaponSwitch(localPlayer.position);\r\n        }\r\n      }\r\n\r\n      // Add muzzle flash and bullet tracer when shooting (client-side prediction)\r\n      if (inputState.shoot && localPlayer.alive && localPlayer.canFire(this.world.getTime() + this.world.getRoundNumber() * 200000)) {\r\n        const now = performance.now();\r\n        if (now - this.lastLocalFireTime > 50) { // Limit flash rate\r\n          this.gameRenderer.addMuzzleFlash(localPlayer.position, localPlayer.rotation);\r\n          \r\n          // Play shooting sound based on weapon\r\n          this.playWeaponSound(localPlayer.weapon.weaponId);\r\n          \r\n          // Client-side predicted bullet tracer (so player sees their own shots immediately)\r\n          if (!this.isHost) {\r\n            // Calculate where the bullet would go with wall collision\r\n            const weapon = localPlayer.getWeaponDefinition();\r\n            if (weapon && weapon.projectileSpeed === 0) { // Hitscan weapon\r\n              const direction = {\r\n                x: Math.cos(localPlayer.rotation),\r\n                y: Math.sin(localPlayer.rotation)\r\n              };\r\n              const start = {\r\n                x: localPlayer.position.x + direction.x * 20,\r\n                y: localPlayer.position.y + direction.y * 20\r\n              };\r\n              \r\n              // Simple raycast to find wall collision - use proper collision system\r\n              const collisionWorld = this.world.getCollisionWorld();\r\n              const hit = collisionWorld.raycast(\r\n                start,\r\n                direction,\r\n                weapon.range,\r\n                0xFFFF // All layers (walls + players)\r\n              );\r\n              \r\n              const end = hit \r\n                ? hit.point\r\n                : { x: start.x + direction.x * weapon.range, y: start.y + direction.y * weapon.range };\r\n              this.gameRenderer.addBulletTracer(start, end, false);\r\n            }\r\n          }\r\n          \r\n          this.lastLocalFireTime = now;\r\n        }\r\n      }\r\n\r\n      // Send input to host\r\n      if (!this.isHost && this.network) {\r\n        const now = performance.now();\r\n        if (now - this.lastInputSendTime >= 1000 / NETWORK.INPUT_RATE) {\r\n          this.network.broadcast({\r\n            type: PacketType.Input,\r\n            timestamp: Date.now(),\r\n            senderId: this.localPeerId,\r\n            data: playerInput,\r\n          });\r\n          this.lastInputSendTime = now;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update world\r\n    if (this.isHost) {\r\n      // Host: full simulation\r\n      this.world.update(dt);\r\n\r\n      // Broadcast state to clients periodically (20 times per second)\r\n      // Do this BEFORE clearing recent shots so they're included in the state\r\n      if (this.network && this.network.getPeerCount() > 0) {\r\n        const now = performance.now();\r\n        if (now - this.lastStateBroadcastTime >= 50) { // 50ms = 20Hz\r\n          this.broadcastState();\r\n          this.lastStateBroadcastTime = now;\r\n        }\r\n      }\r\n\r\n      // Process recent shots for tracer visualization (after broadcast)\r\n      const recentShots = this.world.getAndClearRecentShots();\r\n      for (const shot of recentShots) {\r\n        const isEnemy = this.world.isEnemyOfLocal(shot.shooterId);\r\n        this.gameRenderer.addBulletTracer(shot.start, shot.end, isEnemy);\r\n      }\r\n\r\n      // Process game events for visual effects\r\n      const events = this.world.getPendingEvents();\r\n      for (const event of events) {\r\n        this.handleGameEvent(event);\r\n      }\r\n    } else {\r\n      // Client: update local player for client-side prediction (smooth movement)\r\n      // The host is authoritative, but we predict locally for responsiveness\r\n      this.world.updateLocalPlayerOnly(dt);\r\n    }\r\n\r\n    // Update particle system\r\n    this.gameRenderer.updateParticles(dt);\r\n\r\n    // Ping peers periodically\r\n    if (this.network) {\r\n      const now = performance.now();\r\n      if (now - this.lastPingTime >= NETWORK.PING_INTERVAL) {\r\n        this.network.pingPeers();\r\n        this.lastPingTime = now;\r\n      }\r\n    }\r\n  }\r\n\r\n  private updateCameraInput(): void {\r\n    const cameraOffset = this.renderer.getCameraOffset();\r\n    const cameraZoom = this.renderer.getCameraZoom();\r\n    this.inputManager.updateCamera(cameraOffset, cameraZoom);\r\n  }\r\n\r\n  private render(alpha: number): void {\r\n    this.gameRenderer.render(alpha);\r\n\r\n    // Debug/FPS info (controlled from settings)\r\n    if (this.showFPS && this.debugInfo) {\r\n      const fps = this.gameLoop.getFPS();\r\n      const tps = this.gameLoop.getTPS();\r\n      const playerCount = this.world.getPlayers().length;\r\n      const phase = this.world.getPhase();\r\n      const latency = this.network?.getAverageLatency() ?? 0;\r\n\r\n      this.debugInfo.innerHTML = `\r\n        FPS: ${fps} | TPS: ${tps}<br>\r\n        Phase: ${phase}<br>\r\n        Players: ${playerCount}<br>\r\n        Tick: ${this.world.getTick()}<br>\r\n        ${this.network ? `Latency: ${latency.toFixed(1)}ms<br>` : ''}\r\n        ${this.isHost ? 'HOST' : 'CLIENT'}\r\n      `;\r\n      this.debugInfo.style.display = 'block';\r\n    } else if (this.debugInfo) {\r\n      this.debugInfo.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  // -------------------------------------------------------------------------\r\n  // Public API\r\n  // -------------------------------------------------------------------------\r\n\r\n  setPlayerName(name: string): void {\r\n    this.playerName = name;\r\n  }\r\n\r\n  getPlayerName(): string {\r\n    return this.playerName;\r\n  }\r\n\r\n  isRunning(): boolean {\r\n    return this.gameLoop.isRunning();\r\n  }\r\n\r\n  getWorld(): GameWorld {\r\n    return this.world;\r\n  }\r\n\r\n  // FPS/Debug info visibility\r\n  setShowFPS(show: boolean): void {\r\n    this.showFPS = show;\r\n    if (this.debugInfo && !show) {\r\n      this.debugInfo.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  getShowFPS(): boolean {\r\n    return this.showFPS;\r\n  }\r\n\r\n  // Hero Tutorial System\r\n  private showHeroTutorial(heroId: string): void {\r\n    // Check if already shown for this hero\r\n    const shownTutorials = JSON.parse(localStorage.getItem('cybergrid_tutorials') || '[]');\r\n    if (shownTutorials.includes(heroId)) {\r\n      return;\r\n    }\r\n\r\n    const heroDef = HEROES[heroId as HeroId];\r\n    if (!heroDef) return;\r\n\r\n    // Create overlay\r\n    this.heroTutorialOverlay = document.createElement('div');\r\n    this.heroTutorialOverlay.id = 'hero-tutorial-overlay';\r\n    this.heroTutorialOverlay.innerHTML = `\r\n      <div class=\"tutorial-content\">\r\n        <h2>Playing as ${heroDef.name}</h2>\r\n        <p class=\"hero-role\">${heroDef.role}</p>\r\n        \r\n        <div class=\"abilities-list\">\r\n          <div class=\"ability-item passive\">\r\n            <span class=\"key\">PASSIVE</span>\r\n            <span class=\"name\">${heroDef.abilities[0]?.name || 'Unknown'}</span>\r\n            <span class=\"desc\">${heroDef.abilities[0]?.description || ''}</span>\r\n          </div>\r\n          <div class=\"ability-item\">\r\n            <span class=\"key\">Q</span>\r\n            <span class=\"name\">${heroDef.abilities[1]?.name || 'Unknown'}</span>\r\n            <span class=\"desc\">${heroDef.abilities[1]?.description || ''}</span>\r\n          </div>\r\n          <div class=\"ability-item\">\r\n            <span class=\"key\">F</span>\r\n            <span class=\"name\">${heroDef.abilities[2]?.name || 'Unknown'}</span>\r\n            <span class=\"desc\">${heroDef.abilities[2]?.description || ''}</span>\r\n          </div>\r\n          <div class=\"ability-item ultimate\">\r\n            <span class=\"key\">X</span>\r\n            <span class=\"name\">${heroDef.abilities[3]?.name || 'Unknown'}</span>\r\n            <span class=\"desc\">${heroDef.abilities[3]?.description || ''}</span>\r\n          </div>\r\n        </div>\r\n        \r\n        <button id=\"tutorial-dismiss\">Got it! (Click or press any key)</button>\r\n      </div>\r\n    `;\r\n\r\n    // Add styles\r\n    const style = document.createElement('style');\r\n    style.textContent = `\r\n      #hero-tutorial-overlay {\r\n        position: fixed;\r\n        top: 0;\r\n        left: 0;\r\n        width: 100%;\r\n        height: 100%;\r\n        background: rgba(0, 0, 0, 0.85);\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        z-index: 10000;\r\n        animation: fadeIn 0.3s ease;\r\n      }\r\n      @keyframes fadeIn {\r\n        from { opacity: 0; }\r\n        to { opacity: 1; }\r\n      }\r\n      .tutorial-content {\r\n        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\r\n        border: 2px solid #0ce5f0;\r\n        border-radius: 12px;\r\n        padding: 30px 40px;\r\n        max-width: 500px;\r\n        text-align: center;\r\n        box-shadow: 0 0 30px rgba(12, 229, 240, 0.3);\r\n      }\r\n      .tutorial-content h2 {\r\n        color: #0ce5f0;\r\n        margin: 0 0 5px 0;\r\n        font-size: 28px;\r\n        text-transform: uppercase;\r\n        letter-spacing: 2px;\r\n      }\r\n      .hero-role {\r\n        color: #888;\r\n        margin: 0 0 20px 0;\r\n        font-size: 14px;\r\n      }\r\n      .abilities-list {\r\n        text-align: left;\r\n        margin: 20px 0;\r\n      }\r\n      .ability-item {\r\n        display: grid;\r\n        grid-template-columns: 60px 1fr;\r\n        grid-template-rows: auto auto;\r\n        gap: 2px 10px;\r\n        padding: 10px;\r\n        margin: 8px 0;\r\n        background: rgba(255,255,255,0.05);\r\n        border-radius: 6px;\r\n        border-left: 3px solid #0ce5f0;\r\n      }\r\n      .ability-item.passive {\r\n        border-left-color: #4a4;\r\n      }\r\n      .ability-item.ultimate {\r\n        border-left-color: #ffcc00;\r\n        background: rgba(255, 200, 0, 0.1);\r\n      }\r\n      .ability-item .key {\r\n        grid-row: span 2;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        background: rgba(12, 229, 240, 0.2);\r\n        color: #0ce5f0;\r\n        font-weight: bold;\r\n        font-size: 18px;\r\n        border-radius: 4px;\r\n      }\r\n      .ability-item.passive .key {\r\n        background: rgba(68, 170, 68, 0.2);\r\n        color: #4a4;\r\n        font-size: 10px;\r\n      }\r\n      .ability-item.ultimate .key {\r\n        background: rgba(255, 200, 0, 0.2);\r\n        color: #ffcc00;\r\n      }\r\n      .ability-item .name {\r\n        color: #fff;\r\n        font-weight: bold;\r\n        font-size: 14px;\r\n      }\r\n      .ability-item .desc {\r\n        color: #aaa;\r\n        font-size: 12px;\r\n      }\r\n      #tutorial-dismiss {\r\n        background: linear-gradient(135deg, #0ce5f0 0%, #0891b2 100%);\r\n        border: none;\r\n        color: #000;\r\n        padding: 12px 30px;\r\n        font-size: 14px;\r\n        font-weight: bold;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        margin-top: 20px;\r\n        transition: transform 0.2s, box-shadow 0.2s;\r\n      }\r\n      #tutorial-dismiss:hover {\r\n        transform: scale(1.05);\r\n        box-shadow: 0 0 20px rgba(12, 229, 240, 0.5);\r\n      }\r\n    `;\r\n    document.head.appendChild(style);\r\n    document.body.appendChild(this.heroTutorialOverlay);\r\n\r\n    // Dismiss handler\r\n    const dismiss = () => {\r\n      if (this.heroTutorialOverlay) {\r\n        this.heroTutorialOverlay.remove();\r\n        this.heroTutorialOverlay = null;\r\n      }\r\n      // Save that we've shown this tutorial\r\n      shownTutorials.push(heroId);\r\n      localStorage.setItem('cybergrid_tutorials', JSON.stringify(shownTutorials));\r\n      this.heroTutorialShown = true;\r\n      \r\n      // Remove event listeners\r\n      document.removeEventListener('keydown', dismiss);\r\n      document.removeEventListener('click', dismiss);\r\n    };\r\n\r\n    // Dismiss on click or any key\r\n    document.getElementById('tutorial-dismiss')?.addEventListener('click', dismiss);\r\n    setTimeout(() => {\r\n      document.addEventListener('keydown', dismiss, { once: true });\r\n    }, 500); // Small delay to prevent immediate dismissal\r\n  }\r\n\r\n  checkAndShowHeroTutorial(): void {\r\n    if (this.heroTutorialShown) return;\r\n    \r\n    const heroId = this.settings.playerHero;\r\n    this.showHeroTutorial(heroId);\r\n  }\r\n\r\n  // Show hero info card on demand (H key shortcut)\r\n  showHeroInfo(): void {\r\n    // If already showing, dismiss it\r\n    if (this.heroTutorialOverlay) {\r\n      this.heroTutorialOverlay.remove();\r\n      this.heroTutorialOverlay = null;\r\n      return;\r\n    }\r\n\r\n    const heroId = this.settings.playerHero;\r\n    const heroDef = HEROES[heroId as HeroId];\r\n    if (!heroDef) return;\r\n\r\n    // Create overlay\r\n    this.heroTutorialOverlay = document.createElement('div');\r\n    this.heroTutorialOverlay.id = 'hero-tutorial-overlay';\r\n    this.heroTutorialOverlay.innerHTML = `\r\n      <div class=\"tutorial-content\">\r\n        <div class=\"info-columns\">\r\n          <div class=\"hero-column\">\r\n            <h2>${heroDef.name}</h2>\r\n            <p class=\"hero-role\">${heroDef.role}</p>\r\n            <p class=\"hero-stats\">HP: ${heroDef.health} | Shield: ${heroDef.shield} | Speed: ${Math.round(heroDef.speed * 100)}%</p>\r\n            \r\n            <div class=\"abilities-list\">\r\n              <div class=\"ability-item passive\">\r\n                <span class=\"key\">PASSIVE</span>\r\n                <span class=\"name\">${heroDef.abilities[0]?.name || 'Unknown'}</span>\r\n                <span class=\"desc\">${heroDef.abilities[0]?.description || ''}</span>\r\n              </div>\r\n              <div class=\"ability-item\">\r\n                <span class=\"key\">Q</span>\r\n                <span class=\"name\">${heroDef.abilities[1]?.name || 'Unknown'}</span>\r\n                <span class=\"desc\">${heroDef.abilities[1]?.description || ''}</span>\r\n                <span class=\"cooldown\">${(heroDef.abilities[1]?.cooldown || 0) / 1000}s cooldown</span>\r\n              </div>\r\n              <div class=\"ability-item\">\r\n                <span class=\"key\">F</span>\r\n                <span class=\"name\">${heroDef.abilities[2]?.name || 'Unknown'}</span>\r\n                <span class=\"desc\">${heroDef.abilities[2]?.description || ''}</span>\r\n                <span class=\"cooldown\">${(heroDef.abilities[2]?.cooldown || 0) / 1000}s cooldown</span>\r\n              </div>\r\n              <div class=\"ability-item ultimate\">\r\n                <span class=\"key\">X</span>\r\n                <span class=\"name\">${heroDef.abilities[3]?.name || 'Unknown'}</span>\r\n                <span class=\"desc\">${heroDef.abilities[3]?.description || ''}</span>\r\n                <span class=\"cooldown\">${heroDef.abilities[3]?.ultimateCost || 0} charge cost</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          \r\n          <div class=\"controls-column\">\r\n            <h3>Controls</h3>\r\n            <div class=\"controls-list\">\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">WASD</span><span class=\"ctrl-action\">Move</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">Mouse</span><span class=\"ctrl-action\">Aim</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">Left Click</span><span class=\"ctrl-action\">Shoot</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">Right Click</span><span class=\"ctrl-action\">Reload</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">R</span><span class=\"ctrl-action\">Reload</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">Wheel</span><span class=\"ctrl-action\">Switch Weapon</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">1-5</span><span class=\"ctrl-action\">Select Weapon</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">Q</span><span class=\"ctrl-action\">Ability 1</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">F</span><span class=\"ctrl-action\">Ability 2</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">X</span><span class=\"ctrl-action\">Ultimate</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">B</span><span class=\"ctrl-action\">Buy Menu</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">P</span><span class=\"ctrl-action\">Pause Countdown</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">ESC</span><span class=\"ctrl-action\">Pause/Menu</span></div>\r\n              <div class=\"control-item\"><span class=\"ctrl-key\">H</span><span class=\"ctrl-action\">This Help</span></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        \r\n        <p class=\"dismiss-hint\">Press H or click anywhere to close</p>\r\n      </div>\r\n    `;\r\n\r\n    // Add styles if not already present\r\n    if (!document.getElementById('hero-info-styles')) {\r\n      const style = document.createElement('style');\r\n      style.id = 'hero-info-styles';\r\n      style.textContent = `\r\n        #hero-tutorial-overlay {\r\n          position: fixed;\r\n          top: 0;\r\n          left: 0;\r\n          width: 100%;\r\n          height: 100%;\r\n          background: rgba(0, 0, 0, 0.85);\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n          z-index: 10000;\r\n          animation: fadeIn 0.2s ease;\r\n        }\r\n        @keyframes fadeIn {\r\n          from { opacity: 0; }\r\n          to { opacity: 1; }\r\n        }\r\n        .tutorial-content {\r\n          background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\r\n          border: 2px solid #0ce5f0;\r\n          border-radius: 12px;\r\n          padding: 30px 40px;\r\n          max-width: 850px;\r\n          text-align: center;\r\n          box-shadow: 0 0 30px rgba(12, 229, 240, 0.3);\r\n        }\r\n        .info-columns {\r\n          display: flex;\r\n          gap: 30px;\r\n          text-align: left;\r\n        }\r\n        .hero-column {\r\n          flex: 1;\r\n          min-width: 320px;\r\n        }\r\n        .controls-column {\r\n          flex: 0 0 220px;\r\n          border-left: 1px solid #333;\r\n          padding-left: 30px;\r\n        }\r\n        .controls-column h3 {\r\n          color: #0ce5f0;\r\n          margin: 0 0 15px 0;\r\n          font-size: 18px;\r\n          text-transform: uppercase;\r\n          letter-spacing: 1px;\r\n        }\r\n        .controls-list {\r\n          display: flex;\r\n          flex-direction: column;\r\n          gap: 6px;\r\n        }\r\n        .control-item {\r\n          display: flex;\r\n          justify-content: space-between;\r\n          align-items: center;\r\n          padding: 4px 0;\r\n        }\r\n        .ctrl-key {\r\n          background: #333;\r\n          color: #0ce5f0;\r\n          padding: 3px 8px;\r\n          border-radius: 4px;\r\n          font-size: 11px;\r\n          font-weight: bold;\r\n          min-width: 60px;\r\n          text-align: center;\r\n        }\r\n        .ctrl-action {\r\n          color: #aaa;\r\n          font-size: 12px;\r\n        }\r\n        .tutorial-content h2 {\r\n          color: #0ce5f0;\r\n          margin: 0 0 5px 0;\r\n          font-size: 28px;\r\n          text-transform: uppercase;\r\n          letter-spacing: 2px;\r\n        }\r\n        .hero-role {\r\n          color: #888;\r\n          margin: 0 0 5px 0;\r\n          font-style: italic;\r\n        }\r\n        .hero-stats {\r\n          color: #6af;\r\n          margin: 0 0 20px 0;\r\n          font-size: 14px;\r\n        }\r\n        .abilities-list {\r\n          text-align: left;\r\n          margin: 20px 0;\r\n        }\r\n        .ability-item {\r\n          display: grid;\r\n          grid-template-columns: 70px 1fr;\r\n          grid-template-rows: auto auto;\r\n          gap: 2px 10px;\r\n          padding: 10px;\r\n          margin: 8px 0;\r\n          background: rgba(255, 255, 255, 0.05);\r\n          border-radius: 6px;\r\n          border-left: 3px solid #0ce5f0;\r\n        }\r\n        .ability-item.passive {\r\n          border-left-color: #4a4;\r\n          opacity: 0.8;\r\n        }\r\n        .ability-item.ultimate {\r\n          border-left-color: #f0c020;\r\n          background: rgba(240, 192, 32, 0.1);\r\n        }\r\n        .ability-item .key {\r\n          grid-row: 1 / 3;\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n          background: #0ce5f0;\r\n          color: #000;\r\n          font-weight: bold;\r\n          font-size: 16px;\r\n          border-radius: 4px;\r\n          padding: 5px;\r\n        }\r\n        .ability-item.passive .key {\r\n          background: #4a4;\r\n          font-size: 10px;\r\n        }\r\n        .ability-item.ultimate .key {\r\n          background: #f0c020;\r\n        }\r\n        .ability-item .name {\r\n          color: #fff;\r\n          font-weight: bold;\r\n          font-size: 14px;\r\n        }\r\n        .ability-item .desc {\r\n          color: #aaa;\r\n          font-size: 12px;\r\n        }\r\n        .ability-item .cooldown {\r\n          grid-column: 2;\r\n          color: #0ce5f0;\r\n          font-size: 11px;\r\n          margin-top: 2px;\r\n        }\r\n        .dismiss-hint {\r\n          color: #666;\r\n          font-size: 12px;\r\n          margin-top: 15px;\r\n        }\r\n      `;\r\n      document.head.appendChild(style);\r\n    }\r\n    \r\n    document.body.appendChild(this.heroTutorialOverlay);\r\n\r\n    // Dismiss handler\r\n    const dismiss = (e: Event) => {\r\n      // Don't dismiss if clicking inside the content (except for clicking overlay background)\r\n      if (e.type === 'click' && e.target !== this.heroTutorialOverlay) {\r\n        return;\r\n      }\r\n      if (this.heroTutorialOverlay) {\r\n        this.heroTutorialOverlay.remove();\r\n        this.heroTutorialOverlay = null;\r\n      }\r\n      document.removeEventListener('click', dismiss);\r\n    };\r\n\r\n    // Dismiss on clicking background\r\n    setTimeout(() => {\r\n      this.heroTutorialOverlay?.addEventListener('click', dismiss);\r\n    }, 100);\r\n  }\r\n\r\n  isHeroInfoVisible(): boolean {\r\n    return this.heroTutorialOverlay !== null;\r\n  }\r\n}\r\n","// ============================================================================\r\n// LOBBY BROWSER SERVICE - Find and list public game lobbies\r\n// ============================================================================\r\n// Allows players to browse and join public games without a room code\r\n\r\nimport { FIREBASE_CONFIG } from '../config/firebase.config';\r\n\r\nexport interface PublicLobby {\r\n  roomCode: string;\r\n  hostName: string;\r\n  hostId: string;\r\n  gameMode: 'deathmatch' | 'spike';\r\n  mapId: string;\r\n  currentPlayers: number;\r\n  maxPlayers: number;\r\n  createdAt: number;\r\n  isPublic: boolean;\r\n  status: 'waiting' | 'starting' | 'playing' | 'finished';\r\n}\r\n\r\nclass LobbyBrowserServiceClass {\r\n  private db: any = null;\r\n  private firebase: any = null;\r\n  private isInitialized = false;\r\n  private unsubscribe: (() => void) | null = null;\r\n\r\n  // Initialize Firebase connection\r\n  async initialize(): Promise<void> {\r\n    if (this.isInitialized) return;\r\n\r\n    try {\r\n      const { initializeApp, getApps, getApp } = await import('firebase/app');\r\n      const { \r\n        getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc,\r\n        query, where, orderBy, limit, getDocs, onSnapshot, serverTimestamp\r\n      } = await import('firebase/firestore');\r\n\r\n      this.firebase = { \r\n        collection, doc, setDoc, getDoc, updateDoc, deleteDoc,\r\n        query, where, orderBy, limit, getDocs, onSnapshot, serverTimestamp\r\n      };\r\n\r\n      const app = getApps().length === 0 ? initializeApp(FIREBASE_CONFIG) : getApp();\r\n      this.db = getFirestore(app);\r\n\r\n      this.isInitialized = true;\r\n      console.log('[LobbyBrowser] Initialized');\r\n    } catch (e) {\r\n      console.error('[LobbyBrowser] Initialization failed:', e);\r\n    }\r\n  }\r\n\r\n  // Create or update a public lobby listing\r\n  async createPublicLobby(params: {\r\n    roomCode: string;\r\n    hostId: string;\r\n    hostName: string;\r\n    gameMode: 'deathmatch' | 'spike';\r\n    mapId: string;\r\n    maxPlayers: number;\r\n  }): Promise<void> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    const { doc, setDoc, serverTimestamp } = this.firebase;\r\n\r\n    try {\r\n      const lobbyRef = doc(this.db, 'publicLobbies', params.roomCode);\r\n      await setDoc(lobbyRef, {\r\n        roomCode: params.roomCode,\r\n        hostId: params.hostId,\r\n        hostName: params.hostName,\r\n        gameMode: params.gameMode,\r\n        mapId: params.mapId,\r\n        currentPlayers: 1,\r\n        maxPlayers: params.maxPlayers,\r\n        isPublic: true,\r\n        status: 'waiting',\r\n        createdAt: serverTimestamp(),\r\n        lastUpdated: serverTimestamp(),\r\n      });\r\n\r\n      console.log(`[LobbyBrowser] Public lobby created: ${params.roomCode}`);\r\n    } catch (e) {\r\n      console.error('[LobbyBrowser] Failed to create public lobby:', e);\r\n    }\r\n  }\r\n\r\n  // Update player count in a public lobby\r\n  async updateLobbyPlayerCount(roomCode: string, currentPlayers: number): Promise<void> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    const { doc, updateDoc, serverTimestamp } = this.firebase;\r\n\r\n    try {\r\n      const lobbyRef = doc(this.db, 'publicLobbies', roomCode);\r\n      await updateDoc(lobbyRef, {\r\n        currentPlayers,\r\n        lastUpdated: serverTimestamp(),\r\n      });\r\n    } catch (e) {\r\n      console.warn('[LobbyBrowser] Failed to update player count:', e);\r\n    }\r\n  }\r\n\r\n  // Update lobby status (waiting, starting, playing, finished)\r\n  async updateLobbyStatus(roomCode: string, status: PublicLobby['status']): Promise<void> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    const { doc, updateDoc, deleteDoc, serverTimestamp } = this.firebase;\r\n\r\n    try {\r\n      const lobbyRef = doc(this.db, 'publicLobbies', roomCode);\r\n      \r\n      if (status === 'playing' || status === 'finished') {\r\n        // Remove from public listings when game starts or ends\r\n        await deleteDoc(lobbyRef);\r\n        console.log(`[LobbyBrowser] Lobby removed: ${roomCode}`);\r\n      } else {\r\n        await updateDoc(lobbyRef, {\r\n          status,\r\n          lastUpdated: serverTimestamp(),\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.warn('[LobbyBrowser] Failed to update lobby status:', e);\r\n    }\r\n  }\r\n\r\n  // Remove a public lobby\r\n  async removeLobby(roomCode: string): Promise<void> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    const { doc, deleteDoc } = this.firebase;\r\n\r\n    try {\r\n      const lobbyRef = doc(this.db, 'publicLobbies', roomCode);\r\n      await deleteDoc(lobbyRef);\r\n      console.log(`[LobbyBrowser] Lobby removed: ${roomCode}`);\r\n    } catch (e) {\r\n      console.warn('[LobbyBrowser] Failed to remove lobby:', e);\r\n    }\r\n  }\r\n\r\n  // Fetch list of available public lobbies\r\n  async getPublicLobbies(): Promise<PublicLobby[]> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    const { collection, query, limit, getDocs } = this.firebase;\r\n\r\n    try {\r\n      console.log('[LobbyBrowser] Querying publicLobbies collection...');\r\n      \r\n      // Simpler query - filter in code to avoid composite index requirement\r\n      const q = query(\r\n        collection(this.db, 'publicLobbies'),\r\n        limit(50)\r\n      );\r\n\r\n      const snapshot = await getDocs(q);\r\n      console.log(`[LobbyBrowser] Query returned ${snapshot.size} documents`);\r\n      \r\n      const lobbies: PublicLobby[] = [];\r\n\r\n      snapshot.forEach((doc: any) => {\r\n        const data = doc.data();\r\n        console.log('[LobbyBrowser] Lobby data:', data);\r\n        \r\n        // Filter for waiting, public lobbies that aren't full\r\n        if (data.status === 'waiting' && \r\n            data.isPublic === true && \r\n            data.currentPlayers < data.maxPlayers) {\r\n          lobbies.push({\r\n            roomCode: data.roomCode,\r\n            hostName: data.hostName,\r\n            hostId: data.hostId,\r\n            gameMode: data.gameMode,\r\n            mapId: data.mapId,\r\n            currentPlayers: data.currentPlayers,\r\n            maxPlayers: data.maxPlayers,\r\n            createdAt: data.createdAt?.toMillis?.() || Date.now(),\r\n            isPublic: data.isPublic,\r\n            status: data.status,\r\n          });\r\n        }\r\n      });\r\n\r\n      // Sort by creation time (newest first)\r\n      lobbies.sort((a, b) => b.createdAt - a.createdAt);\r\n\r\n      console.log(`[LobbyBrowser] Found ${lobbies.length} public lobbies`);\r\n      return lobbies;\r\n    } catch (e) {\r\n      console.error('[LobbyBrowser] Failed to fetch lobbies:', e);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Subscribe to real-time lobby updates\r\n  subscribeToLobbies(callback: (lobbies: PublicLobby[]) => void): () => void {\r\n    if (!this.isInitialized) {\r\n      console.warn('[LobbyBrowser] Not initialized - call initialize() first');\r\n      return () => {};\r\n    }\r\n    \r\n    // Clean up existing subscription if any\r\n    if (this.unsubscribe) {\r\n      this.unsubscribe();\r\n      this.unsubscribe = null;\r\n    }\r\n\r\n    const { collection, query, limit, onSnapshot } = this.firebase;\r\n\r\n    try {\r\n      console.log('[LobbyBrowser] Setting up real-time subscription...');\r\n      \r\n      // Simpler query - filter in code to avoid composite index requirement\r\n      const q = query(\r\n        collection(this.db, 'publicLobbies'),\r\n        limit(50)\r\n      );\r\n\r\n      const unsubscribe = onSnapshot(q, (snapshot: any) => {\r\n        const lobbies: PublicLobby[] = [];\r\n\r\n        snapshot.forEach((doc: any) => {\r\n          const data = doc.data();\r\n          // Filter for waiting, public lobbies that aren't full\r\n          if (data.status === 'waiting' && \r\n              data.isPublic === true && \r\n              data.currentPlayers < data.maxPlayers) {\r\n            lobbies.push({\r\n              roomCode: data.roomCode,\r\n              hostName: data.hostName,\r\n              hostId: data.hostId,\r\n              gameMode: data.gameMode,\r\n              mapId: data.mapId,\r\n              currentPlayers: data.currentPlayers,\r\n              maxPlayers: data.maxPlayers,\r\n              createdAt: data.createdAt?.toMillis?.() || Date.now(),\r\n              isPublic: data.isPublic,\r\n              status: data.status,\r\n            });\r\n          }\r\n        });\r\n\r\n        // Sort by creation time (newest first)\r\n        lobbies.sort((a, b) => b.createdAt - a.createdAt);\r\n        \r\n        callback(lobbies);\r\n      }, (error: any) => {\r\n        console.error('[LobbyBrowser] Subscription error:', error);\r\n      });\r\n\r\n      this.unsubscribe = unsubscribe;\r\n      return unsubscribe;\r\n    } catch (e) {\r\n      console.error('[LobbyBrowser] Failed to subscribe to lobbies:', e);\r\n      return () => {};\r\n    }\r\n  }\r\n\r\n  // Stop listening for lobby updates\r\n  unsubscribeFromLobbies(): void {\r\n    if (this.unsubscribe) {\r\n      this.unsubscribe();\r\n      this.unsubscribe = null;\r\n    }\r\n  }\r\n\r\n  // Clean up stale lobbies (older than 10 minutes)\r\n  async cleanupStaleLobbies(): Promise<number> {\r\n    if (!this.isInitialized) await this.initialize();\r\n\r\n    const { collection, query, getDocs, deleteDoc, doc, limit } = this.firebase;\r\n\r\n    try {\r\n      const tenMinutesAgo = Date.now() - 10 * 60 * 1000;\r\n      \r\n      // Simple query, filter in code\r\n      const q = query(\r\n        collection(this.db, 'publicLobbies'),\r\n        limit(100)\r\n      );\r\n\r\n      const snapshot = await getDocs(q);\r\n      let cleaned = 0;\r\n\r\n      for (const docSnap of snapshot.docs) {\r\n        const data = docSnap.data();\r\n        const createdAt = data.createdAt?.toMillis?.() || 0;\r\n        \r\n        if (createdAt < tenMinutesAgo && data.status === 'waiting') {\r\n          await deleteDoc(doc(this.db, 'publicLobbies', docSnap.id));\r\n          cleaned++;\r\n        }\r\n      }\r\n\r\n      if (cleaned > 0) {\r\n        console.log(`[LobbyBrowser] Cleaned up ${cleaned} stale lobbies`);\r\n      }\r\n\r\n      return cleaned;\r\n    } catch (e) {\r\n      console.warn('[LobbyBrowser] Failed to cleanup stale lobbies:', e);\r\n      return 0;\r\n    }\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const LobbyBrowserService = new LobbyBrowserServiceClass();\r\n","// ============================================================================\r\n// VOICE CHAT SERVICE - WebRTC Voice Communication\r\n// ============================================================================\r\n\r\nexport class VoiceChatService {\r\n  private static instance: VoiceChatService | null = null;\r\n  \r\n  private localStream: MediaStream | null = null;\r\n  private micEnabled = false;\r\n  private peerConnections = new Map<string, RTCPeerConnection>();\r\n  private audioElements = new Map<string, HTMLAudioElement>();\r\n  \r\n  // Team-based communication\r\n  private allowedPeers = new Set<string>(); // Peers we can talk to\r\n\r\n  private constructor() {}\r\n\r\n  static getInstance(): VoiceChatService {\r\n    if (!VoiceChatService.instance) {\r\n      VoiceChatService.instance = new VoiceChatService();\r\n    }\r\n    return VoiceChatService.instance;\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    console.log('[VoiceChat] Initialized');\r\n  }\r\n\r\n  async enableMicrophone(): Promise<boolean> {\r\n    if (this.micEnabled) return true;\r\n\r\n    try {\r\n      this.localStream = await navigator.mediaDevices.getUserMedia({ \r\n        audio: {\r\n          echoCancellation: true,\r\n          noiseSuppression: true,\r\n          autoGainControl: true\r\n        } \r\n      });\r\n      this.micEnabled = true;\r\n      console.log('[VoiceChat] Microphone enabled');\r\n      \r\n      // Add tracks to existing peer connections\r\n      this.updatePeerTracks();\r\n      \r\n      return true;\r\n    } catch (e) {\r\n      console.error('[VoiceChat] Failed to enable microphone:', e);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  disableMicrophone(): void {\r\n    if (!this.micEnabled) return;\r\n\r\n    if (this.localStream) {\r\n      this.localStream.getTracks().forEach(track => track.stop());\r\n      this.localStream = null;\r\n    }\r\n    \r\n    this.micEnabled = false;\r\n    console.log('[VoiceChat] Microphone disabled');\r\n    \r\n    // Remove tracks from peer connections\r\n    this.updatePeerTracks();\r\n  }\r\n\r\n  async toggleMicrophone(): Promise<boolean> {\r\n    if (this.micEnabled) {\r\n      this.disableMicrophone();\r\n      return false;\r\n    } else {\r\n      return await this.enableMicrophone();\r\n    }\r\n  }\r\n\r\n  isMicrophoneEnabled(): boolean {\r\n    return this.micEnabled;\r\n  }\r\n\r\n  setAllowedPeers(peerIds: string[]): void {\r\n    this.allowedPeers.clear();\r\n    peerIds.forEach(id => this.allowedPeers.add(id));\r\n    console.log('[VoiceChat] Allowed peers:', peerIds);\r\n  }\r\n\r\n  addPeerConnection(peerId: string, pc: RTCPeerConnection): void {\r\n    // Only add if peer is allowed (same team or 1v1)\r\n    if (!this.allowedPeers.has(peerId)) {\r\n      console.log('[VoiceChat] Peer not allowed:', peerId);\r\n      return;\r\n    }\r\n\r\n    this.peerConnections.set(peerId, pc);\r\n    \r\n    // Add local audio track if mic is enabled\r\n    if (this.localStream && this.micEnabled) {\r\n      const audioTrack = this.localStream.getAudioTracks()[0];\r\n      if (audioTrack) {\r\n        pc.addTrack(audioTrack, this.localStream);\r\n      }\r\n    }\r\n\r\n    // Handle incoming audio\r\n    pc.ontrack = (event) => {\r\n      console.log('[VoiceChat] Received track from:', peerId);\r\n      const remoteStream = event.streams[0];\r\n      \r\n      let audio = this.audioElements.get(peerId);\r\n      if (!audio) {\r\n        audio = new Audio();\r\n        audio.autoplay = true;\r\n        this.audioElements.set(peerId, audio);\r\n      }\r\n      audio.srcObject = remoteStream as any;\r\n    };\r\n\r\n    console.log('[VoiceChat] Added peer connection:', peerId);\r\n  }\r\n\r\n  removePeerConnection(peerId: string): void {\r\n    this.peerConnections.delete(peerId);\r\n    \r\n    const audio = this.audioElements.get(peerId);\r\n    if (audio) {\r\n      audio.srcObject = null;\r\n      this.audioElements.delete(peerId);\r\n    }\r\n    \r\n    console.log('[VoiceChat] Removed peer connection:', peerId);\r\n  }\r\n\r\n  private updatePeerTracks(): void {\r\n    this.peerConnections.forEach((pc) => {\r\n      // Remove existing audio tracks\r\n      const senders = pc.getSenders();\r\n      senders.forEach(sender => {\r\n        if (sender.track?.kind === 'audio') {\r\n          pc.removeTrack(sender);\r\n        }\r\n      });\r\n\r\n      // Add new track if mic is enabled\r\n      if (this.localStream && this.micEnabled) {\r\n        const audioTrack = this.localStream.getAudioTracks()[0];\r\n        if (audioTrack) {\r\n          pc.addTrack(audioTrack, this.localStream);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  cleanup(): void {\r\n    this.disableMicrophone();\r\n    \r\n    this.peerConnections.forEach((pc) => pc.close());\r\n    this.peerConnections.clear();\r\n    \r\n    this.audioElements.forEach((audio) => {\r\n      audio.srcObject = null;\r\n    });\r\n    this.audioElements.clear();\r\n    \r\n    this.allowedPeers.clear();\r\n    \r\n    console.log('[VoiceChat] Cleaned up');\r\n  }\r\n}\r\n","// ============================================================================\r\n// CYBERGRID ASSAULT - Main Entry Point\r\n// ============================================================================\r\n\r\nimport { Game, GameSettings } from '@/game/Game';\r\nimport { NetworkManager } from '@/network/NetworkManager';\r\nimport { FIREBASE_CONFIG } from '@/config/firebase.config';\r\nimport { PacketType } from '@/shared/types';\r\nimport { MAP_REGISTRY } from '@/game/map/GameMap';\r\nimport { AnalyticsService } from '@/services/AnalyticsService';\r\nimport { PlayerStatsService } from '@/services/PlayerStatsService';\r\nimport { LobbyBrowserService, PublicLobby } from '@/services/LobbyBrowserService';\r\nimport { VoiceChatService } from '@/services/VoiceChatService';\r\n\r\n// ============================================================================\r\n// UI Audio System (standalone for menu/lobby sounds)\r\n// ============================================================================\r\nclass UIAudio {\r\n  private context: AudioContext | null = null;\r\n  private sounds = new Map<string, AudioBuffer>();\r\n  private initialized = false;\r\n  private loading = false;\r\n  private enabled = true;\r\n  private volume = 0.7; // Default UI volume\r\n\r\n  async init(): Promise<void> {\r\n    if (this.initialized || this.loading) return;\r\n    this.loading = true;\r\n    try {\r\n      this.context = new AudioContext();\r\n      // Load UI sounds\r\n      await Promise.all([\r\n        this.loadSound('hover', './assets/audio/ui/hover.mp3'),\r\n        this.loadSound('click', './assets/audio/ui/click.mp3'),\r\n      ]);\r\n      this.initialized = true;\r\n      console.log('[UIAudio] Initialized with', this.sounds.size, 'sounds');\r\n    } catch (e) {\r\n      console.warn('[UIAudio] Failed to initialize:', e);\r\n    }\r\n    this.loading = false;\r\n  }\r\n\r\n  private async loadSound(key: string, url: string): Promise<void> {\r\n    if (!this.context) return;\r\n    try {\r\n      const response = await fetch(url);\r\n      const arrayBuffer = await response.arrayBuffer();\r\n      const audioBuffer = await this.context.decodeAudioData(arrayBuffer);\r\n      this.sounds.set(key, audioBuffer);\r\n      console.log(`[UIAudio] Loaded: ${key}`);\r\n    } catch (e) {\r\n      console.warn(`[UIAudio] Failed to load ${key}:`, e);\r\n    }\r\n  }\r\n\r\n  play(key: string, volume = 0.5): void {\r\n    if (!this.enabled || !this.context || !this.sounds.has(key)) {\r\n      // Try to init if not ready\r\n      if (!this.initialized && !this.loading) {\r\n        this.init();\r\n      }\r\n      return;\r\n    }\r\n    // Resume context if suspended (browser autoplay policy)\r\n    if (this.context.state === 'suspended') {\r\n      this.context.resume();\r\n    }\r\n    const buffer = this.sounds.get(key)!;\r\n    const source = this.context.createBufferSource();\r\n    source.buffer = buffer;\r\n    const gainNode = this.context.createGain();\r\n    gainNode.gain.value = volume * this.volume;\r\n    source.connect(gainNode);\r\n    gainNode.connect(this.context.destination);\r\n    source.start(0);\r\n  }\r\n\r\n  playHover(): void {\r\n    this.play('hover', 0.3);\r\n  }\r\n\r\n  playClick(): void {\r\n    this.play('click', 0.5);\r\n  }\r\n\r\n  setEnabled(enabled: boolean): void {\r\n    this.enabled = enabled;\r\n  }\r\n  \r\n  setVolume(volume: number): void {\r\n    this.volume = Math.max(0, Math.min(1, volume));\r\n  }\r\n}\r\n\r\nconst uiAudio = new UIAudio();\r\n\r\n// Initialize UI audio on first user interaction (for browser autoplay policy)\r\nconst initUIAudio = () => {\r\n  uiAudio.init();\r\n  document.removeEventListener('click', initUIAudio);\r\n  document.removeEventListener('keydown', initUIAudio);\r\n  document.removeEventListener('mousemove', initUIAudio);\r\n};\r\ndocument.addEventListener('click', initUIAudio);\r\ndocument.addEventListener('keydown', initUIAudio);\r\ndocument.addEventListener('mousemove', initUIAudio); // Init on mouse move so sounds are ready for hover\r\n\r\n// Network manager for lobby (before game starts)\r\nlet lobbyNetwork: NetworkManager | null = null;\r\n\r\n// Version from package.json (injected by Vite)\r\ndeclare const __APP_VERSION__: string;\r\n\r\n// DOM Elements\r\nconst canvas = document.getElementById('game-canvas') as HTMLCanvasElement;\r\nconst connectionUI = document.getElementById('connection-ui') as HTMLDivElement;\r\nconst versionBadge = document.getElementById('version-badge') as HTMLDivElement;\r\nconst playerNameInput = document.getElementById('player-name') as HTMLInputElement;\r\nconst hostButton = document.getElementById('btn-host') as HTMLButtonElement;\r\nconst joinButton = document.getElementById('btn-join') as HTMLButtonElement;\r\nconst roomCodeInput = document.getElementById('room-code') as HTMLInputElement;\r\nconst connectButton = document.getElementById('btn-connect') as HTMLButtonElement;\r\nconst backButton = document.getElementById('btn-back') as HTMLButtonElement;\r\nconst joinButtons = document.getElementById('join-buttons') as HTMLDivElement;\r\n\r\n// Game Setup Settings Elements (main menu)\r\nconst settingsButton = document.getElementById('btn-settings') as HTMLButtonElement;\r\nconst settingsPanel = document.getElementById('settings-panel') as HTMLDivElement;\r\nconst howToPlayButton = document.getElementById('btn-how-to-play') as HTMLButtonElement;\r\nconst howToPlayModal = document.getElementById('how-to-play-modal') as HTMLDivElement;\r\nconst howToPlayCloseButton = document.getElementById('btn-how-to-play-close') as HTMLButtonElement;\r\nconst statsButton = document.getElementById('btn-stats') as HTMLButtonElement;\r\nconst statsModal = document.getElementById('stats-modal') as HTMLDivElement;\r\nconst statsCloseButton = document.getElementById('btn-stats-close') as HTMLButtonElement;\r\nconst micToggleButton = document.getElementById('btn-mic-toggle') as HTMLButtonElement;\r\nconst botCountSlider = document.getElementById('setting-bot-count') as HTMLInputElement;\r\nconst botCountValue = document.getElementById('bot-count-value') as HTMLSpanElement;\r\nconst botDifficultySelect = document.getElementById('setting-bot-difficulty') as HTMLSelectElement;\r\nconst friendlyBotsSlider = document.getElementById('setting-friendly-bots') as HTMLInputElement;\r\nconst friendlyBotsValue = document.getElementById('friendly-bot-count-value') as HTMLSpanElement;\r\nconst aiModeSelect = document.getElementById('setting-ai-mode') as HTMLSelectElement;\r\nconst gameModeSelect = document.getElementById('setting-game-mode') as HTMLSelectElement;\r\nconst mapSelect = document.getElementById('setting-map') as HTMLSelectElement;\r\nconst mapHint = document.getElementById('map-hint') as HTMLSpanElement;\r\nconst heroSelect = document.getElementById('setting-hero') as HTMLSelectElement;\r\nconst abilityQSelect = document.getElementById('setting-ability-q') as HTMLSelectElement;\r\nconst abilityFSelect = document.getElementById('setting-ability-f') as HTMLSelectElement;\r\nconst abilityQName = document.getElementById('ability-q-name') as HTMLSpanElement;\r\nconst abilityFName = document.getElementById('ability-f-name') as HTMLSpanElement;\r\nconst settingsSaveButton = document.getElementById('btn-settings-save') as HTMLButtonElement;\r\nconst settingsCloseButton = document.getElementById('btn-settings-close') as HTMLButtonElement;\r\n\r\n// Audio Settings Elements (in settings panel - main menu)\r\nconst settingsAudioMasterVolume = document.getElementById('settings-audio-master-volume') as HTMLInputElement;\r\nconst settingsAudioMasterEnabled = document.getElementById('settings-audio-master-enabled') as HTMLInputElement;\r\nconst settingsAudioMasterValue = document.getElementById('settings-audio-master-value') as HTMLSpanElement;\r\nconst settingsAudioMusicVolume = document.getElementById('settings-audio-music-volume') as HTMLInputElement;\r\nconst settingsAudioMusicEnabled = document.getElementById('settings-audio-music-enabled') as HTMLInputElement;\r\nconst settingsAudioMusicValue = document.getElementById('settings-audio-music-value') as HTMLSpanElement;\r\nconst settingsAudioSfxVolume = document.getElementById('settings-audio-sfx-volume') as HTMLInputElement;\r\nconst settingsAudioSfxEnabled = document.getElementById('settings-audio-sfx-enabled') as HTMLInputElement;\r\nconst settingsAudioSfxValue = document.getElementById('settings-audio-sfx-value') as HTMLSpanElement;\r\nconst settingsAudioVoiceVolume = document.getElementById('settings-audio-voice-volume') as HTMLInputElement;\r\nconst settingsAudioVoiceEnabled = document.getElementById('settings-audio-voice-enabled') as HTMLInputElement;\r\nconst settingsAudioVoiceValue = document.getElementById('settings-audio-voice-value') as HTMLSpanElement;\r\nconst settingsAudioUiVolume = document.getElementById('settings-audio-ui-volume') as HTMLInputElement;\r\nconst settingsAudioUiEnabled = document.getElementById('settings-audio-ui-enabled') as HTMLInputElement;\r\nconst settingsAudioUiValue = document.getElementById('settings-audio-ui-value') as HTMLSpanElement;\r\n\r\n// Pause Menu Elements (in-game)\r\nconst pauseMenu = document.getElementById('pause-menu') as HTMLDivElement;\r\nconst resumeButton = document.getElementById('btn-resume') as HTMLButtonElement;\r\nconst quitButton = document.getElementById('btn-quit') as HTMLButtonElement;\r\nconst sensitivitySlider = document.getElementById('setting-sensitivity') as HTMLInputElement;\r\nconst sensitivityValue = document.getElementById('sensitivity-value') as HTMLSpanElement;\r\nconst fpsCheckbox = document.getElementById('setting-fps') as HTMLInputElement;\r\n\r\n// Audio Settings Elements (in pause menu)\r\nconst audioMasterVolume = document.getElementById('audio-master-volume') as HTMLInputElement;\r\nconst audioMasterEnabled = document.getElementById('audio-master-enabled') as HTMLInputElement;\r\nconst audioMasterValue = document.getElementById('audio-master-value') as HTMLSpanElement;\r\nconst audioMusicVolume = document.getElementById('audio-music-volume') as HTMLInputElement;\r\nconst audioMusicEnabled = document.getElementById('audio-music-enabled') as HTMLInputElement;\r\nconst audioMusicValue = document.getElementById('audio-music-value') as HTMLSpanElement;\r\nconst audioSfxVolume = document.getElementById('audio-sfx-volume') as HTMLInputElement;\r\nconst audioSfxEnabled = document.getElementById('audio-sfx-enabled') as HTMLInputElement;\r\nconst audioSfxValue = document.getElementById('audio-sfx-value') as HTMLSpanElement;\r\nconst audioVoiceVolume = document.getElementById('audio-voice-volume') as HTMLInputElement;\r\nconst audioVoiceEnabled = document.getElementById('audio-voice-enabled') as HTMLInputElement;\r\nconst audioVoiceValue = document.getElementById('audio-voice-value') as HTMLSpanElement;\r\nconst audioUiVolume = document.getElementById('audio-ui-volume') as HTMLInputElement;\r\nconst audioUiEnabled = document.getElementById('audio-ui-enabled') as HTMLInputElement;\r\nconst audioUiValue = document.getElementById('audio-ui-value') as HTMLSpanElement;\r\n\r\n// Help Panel Element\r\nconst helpPanel = document.getElementById('help-panel') as HTMLDivElement;\r\nlet helpPanelVisible = false;\r\nlet helpAutoHideTimer: number | null = null;\r\n\r\n// Buy Menu Elements\r\nconst buyMenu = document.getElementById('buy-menu') as HTMLDivElement;\r\nconst buyCredits = document.getElementById('buy-credits') as HTMLSpanElement;\r\nconst weaponItems = buyMenu.querySelectorAll('.weapon-item') as NodeListOf<HTMLDivElement>;\r\n\r\n// Round Over Panel Elements\r\nconst roundOverPanel = document.getElementById('round-over-panel') as HTMLDivElement;\r\nconst winnerText = document.getElementById('winner-text') as HTMLDivElement;\r\nconst matchInfo = document.getElementById('match-info') as HTMLDivElement;\r\nconst scoreAttackers = document.getElementById('score-attackers') as HTMLDivElement;\r\nconst scoreDefenders = document.getElementById('score-defenders') as HTMLDivElement;\r\nconst playAgainButton = document.getElementById('btn-play-again') as HTMLButtonElement;\r\nconst mainMenuButton = document.getElementById('btn-main-menu') as HTMLButtonElement;\r\nconst countdownDisplay = document.getElementById('countdown-display') as HTMLDivElement;\r\nconst countdownText = document.getElementById('countdown-text') as HTMLDivElement;\r\nconst pauseCountdownButton = document.getElementById('btn-pause-countdown') as HTMLButtonElement;\r\n\r\n// Room Code Display Elements\r\nconst roomCodeDisplay = document.getElementById('room-code-display') as HTMLDivElement;\r\nconst roomCodeText = document.getElementById('room-code-text') as HTMLSpanElement;\r\nconst copyCodeButton = document.getElementById('btn-copy-code') as HTMLButtonElement;\r\n\r\n// Lobby Screen Elements\r\nconst lobbyScreen = document.getElementById('lobby-screen') as HTMLDivElement;\r\nconst lobbyRoomCode = document.getElementById('lobby-room-code') as HTMLDivElement;\r\nconst hostSettings = document.getElementById('host-settings') as HTMLDivElement;\r\nconst lobbyPlayerCountSelect = document.getElementById('lobby-player-count') as HTMLSelectElement;\r\nconst lobbyRoundCountSelect = document.getElementById('lobby-round-count') as HTMLSelectElement;\r\nconst lobbyCurrentPlayers = document.getElementById('lobby-current-players') as HTMLSpanElement;\r\nconst lobbyMaxPlayers = document.getElementById('lobby-max-players') as HTMLSpanElement;\r\nconst lobbyPlayerList = document.getElementById('lobby-player-list') as HTMLDivElement;\r\nconst lobbyWaitingText = document.getElementById('lobby-waiting-text') as HTMLDivElement;\r\nconst lobbyCountdown = document.getElementById('lobby-countdown') as HTMLDivElement;\r\nconst leaveLobbyButton = document.getElementById('btn-leave-lobby') as HTMLButtonElement;\r\nconst copyLobbyCodeButton = document.getElementById('btn-copy-lobby-code') as HTMLButtonElement;\r\nconst startGameButton = document.getElementById('btn-start-game') as HTMLButtonElement;\r\nconst lobbyMakePublicCheckbox = document.getElementById('lobby-make-public') as HTMLInputElement;\r\n\r\n// Lobby Browser Elements\r\nconst findMatchButton = document.getElementById('btn-find-match') as HTMLButtonElement;\r\nconst lobbyBrowserModal = document.getElementById('lobby-browser-modal') as HTMLDivElement;\r\nconst lobbyBrowserCloseButton = document.getElementById('btn-lobby-browser-close') as HTMLButtonElement;\r\nconst refreshLobbiesButton = document.getElementById('btn-refresh-lobbies') as HTMLButtonElement;\r\nconst lobbyList = document.getElementById('lobby-list') as HTMLDivElement;\r\nconst lobbyEmpty = document.getElementById('lobby-empty') as HTMLDivElement;\r\n\r\n// Game instance\r\nlet game: Game | null = null;\r\n\r\n// Hero ability names for UI display\r\nconst HERO_ABILITIES: Record<string, { ability1: string; ability2: string }> = {\r\n  vanta: { ability1: 'Energy Shield', ability2: 'Shockwave Slam' },\r\n  spectre: { ability1: 'Cloak', ability2: 'Reveal Pulse' },\r\n  katana: { ability1: 'Blink', ability2: 'Invisibility' },\r\n  byte: { ability1: 'EMP Pulse', ability2: 'Shock Trap' },\r\n  glyph: { ability1: 'Poison Cloud', ability2: 'Turret Deploy' },\r\n  spark: { ability1: 'Fire Bottle', ability2: 'Minigun Mode' },\r\n  zero: { ability1: 'Mark Target', ability2: 'Dash Back' },\r\n  mira: { ability1: 'Heal Field', ability2: 'Shield Burst' },\r\n};\r\n\r\n// Game settings\r\nlet gameSettings: GameSettings = {\r\n  enemyBotCount: 3,\r\n  friendlyBotCount: 0,\r\n  botDifficulty: 'medium',\r\n  gameMode: 'deathmatch',\r\n  mapId: 'neon_arena',\r\n  playerHero: 'vanta',\r\n  abilityQSlot: 1,  // Which ability (1 or 2) is on Q key\r\n  abilityFSlot: 2,  // Which ability (1 or 2) is on F key\r\n  totalRounds: 5,   // Best of X rounds\r\n  aiMode: 'rule_based',  // Bot AI mode (rule_based or slm)\r\n};\r\n\r\n// Map info for hints\r\n// Populate map dropdown based on game mode\r\nfunction populateMapDropdown(gameMode: string): void {\r\n  const currentMapId = mapSelect.value;\r\n  mapSelect.innerHTML = '';\r\n  \r\n  // Filter maps based on game mode\r\n  const filteredMaps = MAP_REGISTRY.filter(map => {\r\n    if (gameMode === 'spike') {\r\n      return map.hasSpikeSites; // Only show maps with spike sites\r\n    } else {\r\n      return !map.hasSpikeSites; // Only show deathmatch maps\r\n    }\r\n  });\r\n  \r\n  // Add options\r\n  for (const map of filteredMaps) {\r\n    const option = document.createElement('option');\r\n    option.value = map.id;\r\n    option.textContent = `${map.name} - ${map.description}`;\r\n    mapSelect.appendChild(option);\r\n  }\r\n  \r\n  // Try to keep current selection if valid, otherwise select first\r\n  const validIds = filteredMaps.map(m => m.id);\r\n  if (validIds.includes(currentMapId)) {\r\n    mapSelect.value = currentMapId;\r\n  } else if (filteredMaps.length > 0) {\r\n    mapSelect.value = filteredMaps[0]!.id;\r\n  }\r\n  \r\n  updateMapHint();\r\n}\r\n\r\n// Update map hint based on selection\r\nfunction updateMapHint(): void {\r\n  const mapId = mapSelect.value;\r\n  const mapInfo = MAP_REGISTRY.find(m => m.id === mapId);\r\n  if (mapInfo) {\r\n    const gameMode = gameModeSelect.value;\r\n    if (gameMode === 'spike' && !mapInfo.hasSpikeSites) {\r\n      mapHint.textContent = ' This map has no spike sites!';\r\n      mapHint.style.color = '#ff6b6b';\r\n    } else if (gameMode === 'deathmatch' && mapInfo.hasSpikeSites) {\r\n      mapHint.textContent = ' Spike sites available but unused in Deathmatch';\r\n      mapHint.style.color = '#4ecdc4';\r\n    } else {\r\n      mapHint.textContent = ` ${mapInfo.description}`;\r\n      mapHint.style.color = '#2ecc71';\r\n    }\r\n  } else {\r\n    mapHint.textContent = '';\r\n  }\r\n}\r\n\r\n// Update ability name displays based on hero and slot selections\r\nfunction updateAbilityNames(): void {\r\n  const hero = heroSelect.value;\r\n  const abilities = HERO_ABILITIES[hero] || { ability1: 'Ability 1', ability2: 'Ability 2' };\r\n  \r\n  const qSlot = parseInt(abilityQSelect.value);\r\n  const fSlot = parseInt(abilityFSelect.value);\r\n  \r\n  abilityQName.textContent = qSlot === 1 ? abilities.ability1 : abilities.ability2;\r\n  abilityFName.textContent = fSlot === 1 ? abilities.ability1 : abilities.ability2;\r\n}\r\n\r\n// -------------------------------------------------------------------------\r\n// Stats Modal Functions\r\n// -------------------------------------------------------------------------\r\n\r\n// Country code to flag emoji\r\nfunction countryFlag(code: string): string {\r\n  if (!code || code === 'XX') return '';\r\n  return code.toUpperCase().replace(/./g, c => \r\n    String.fromCodePoint(0x1F1E6 - 65 + c.charCodeAt(0))\r\n  );\r\n}\r\n\r\n// Format large numbers\r\nfunction formatStatNumber(num: number): string {\r\n  if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';\r\n  if (num >= 1000) return (num / 1000).toFixed(1) + 'K';\r\n  return num.toString();\r\n}\r\n\r\n// Load stats modal data\r\nasync function loadStatsModal(): Promise<void> {\r\n  // Initialize PlayerStatsService if not already\r\n  await PlayerStatsService.initialize();\r\n  \r\n  // Get DOM elements\r\n  const totalPlayersEl = document.getElementById('stats-total-players');\r\n  const totalGamesEl = document.getElementById('stats-total-games');\r\n  const totalHoursEl = document.getElementById('stats-total-hours');\r\n  const myStatsEl = document.getElementById('stats-my-stats');\r\n  const countriesEl = document.getElementById('stats-countries');\r\n  const leaderboardEl = document.getElementById('stats-leaderboard');\r\n  \r\n  // Load global stats\r\n  try {\r\n    const globalStats = await PlayerStatsService.getGlobalStats();\r\n    if (globalStats) {\r\n      if (totalPlayersEl) totalPlayersEl.textContent = formatStatNumber(globalStats.totalUniquePlayers || 0);\r\n      if (totalGamesEl) totalGamesEl.textContent = formatStatNumber(globalStats.totalGamesPlayed || 0);\r\n      if (totalHoursEl) totalHoursEl.textContent = formatStatNumber(Math.floor(globalStats.totalPlayTimeHours || 0));\r\n      \r\n      // Countries\r\n      if (countriesEl && globalStats.playersByCountry) {\r\n        const sorted = Object.entries(globalStats.playersByCountry)\r\n          .sort((a, b) => (b[1] as number) - (a[1] as number))\r\n          .slice(0, 8);\r\n        \r\n        if (sorted.length === 0) {\r\n          countriesEl.innerHTML = '<span class=\"stats-loading\">No country data yet</span>';\r\n        } else {\r\n          countriesEl.innerHTML = sorted\r\n            .map(([code, count]) => `\r\n              <span class=\"country-tag\">\r\n                ${countryFlag(code)} ${code}\r\n                <span class=\"count\">${count}</span>\r\n              </span>\r\n            `)\r\n            .join('');\r\n        }\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.warn('[Stats] Failed to load global stats:', e);\r\n  }\r\n  \r\n  // Load my stats\r\n  try {\r\n    const myStats = await PlayerStatsService.getMyStats();\r\n    if (myStatsEl) {\r\n      if (myStats) {\r\n        const winRate = myStats.gamesPlayed > 0 \r\n          ? Math.round((myStats.gamesWon / myStats.gamesPlayed) * 100) \r\n          : 0;\r\n        const kd = myStats.totalDeaths > 0 \r\n          ? (myStats.totalKills / myStats.totalDeaths).toFixed(2) \r\n          : myStats.totalKills.toString();\r\n        \r\n        myStatsEl.innerHTML = `\r\n          <div class=\"my-stat\">\r\n            <span class=\"my-stat-label\">Games Played</span>\r\n            <span class=\"my-stat-value\">${myStats.gamesPlayed}</span>\r\n          </div>\r\n          <div class=\"my-stat\">\r\n            <span class=\"my-stat-label\">Wins</span>\r\n            <span class=\"my-stat-value\">${myStats.gamesWon} (${winRate}%)</span>\r\n          </div>\r\n          <div class=\"my-stat\">\r\n            <span class=\"my-stat-label\">Total Kills</span>\r\n            <span class=\"my-stat-value\">${myStats.totalKills}</span>\r\n          </div>\r\n          <div class=\"my-stat\">\r\n            <span class=\"my-stat-label\">K/D Ratio</span>\r\n            <span class=\"my-stat-value\">${kd}</span>\r\n          </div>\r\n          <div class=\"my-stat\">\r\n            <span class=\"my-stat-label\">Play Time</span>\r\n            <span class=\"my-stat-value\">${Math.floor(myStats.totalPlayTimeSeconds / 60)} min</span>\r\n          </div>\r\n          <div class=\"my-stat\">\r\n            <span class=\"my-stat-label\">Country</span>\r\n            <span class=\"my-stat-value\">${countryFlag(myStats.country)} ${myStats.countryName || 'Unknown'}</span>\r\n          </div>\r\n        `;\r\n      } else {\r\n        myStatsEl.innerHTML = '<div class=\"stats-loading\">Play a game to see your stats!</div>';\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.warn('[Stats] Failed to load my stats:', e);\r\n    if (myStatsEl) myStatsEl.innerHTML = '<div class=\"stats-loading\">Play a game to see your stats!</div>';\r\n  }\r\n  \r\n  // Load leaderboard\r\n  try {\r\n    const topPlayers = await loadLeaderboardData();\r\n    if (leaderboardEl) {\r\n      if (topPlayers.length === 0) {\r\n        leaderboardEl.innerHTML = '<li class=\"stats-loading\">No players yet</li>';\r\n      } else {\r\n        leaderboardEl.innerHTML = topPlayers\r\n          .map((player, index) => {\r\n            const winRate = player.gamesPlayed > 0 \r\n              ? Math.round((player.gamesWon / player.gamesPlayed) * 100) \r\n              : 0;\r\n            return `\r\n              <li>\r\n                <span class=\"rank\">#${index + 1}</span>\r\n                <span class=\"name\">${player.callsign || 'Unknown'}</span>\r\n                <span class=\"wins\">${player.gamesWon || 0} wins (${winRate}%)</span>\r\n              </li>\r\n            `;\r\n          })\r\n          .join('');\r\n      }\r\n    }\r\n  } catch (e) {\r\n    console.warn('[Stats] Failed to load leaderboard:', e);\r\n    if (leaderboardEl) leaderboardEl.innerHTML = '<li class=\"stats-loading\">Failed to load</li>';\r\n  }\r\n}\r\n\r\n// Load leaderboard data from Firestore\r\nasync function loadLeaderboardData(): Promise<any[]> {\r\n  try {\r\n    const { getFirestore, collection, query, orderBy, limit, getDocs } = await import('firebase/firestore');\r\n    const { initializeApp, getApps, getApp } = await import('firebase/app');\r\n    \r\n    const app = getApps().length === 0 ? initializeApp(FIREBASE_CONFIG) : getApp();\r\n    const db = getFirestore(app);\r\n    \r\n    const q = query(\r\n      collection(db, 'playerStats'),\r\n      orderBy('gamesWon', 'desc'),\r\n      limit(5)\r\n    );\r\n    \r\n    const snapshot = await getDocs(q);\r\n    return snapshot.docs.map(doc => doc.data());\r\n  } catch (e) {\r\n    console.warn('[Stats] Failed to query leaderboard:', e);\r\n    return [];\r\n  }\r\n}\r\n\r\n// -------------------------------------------------------------------------\r\n// Lobby Browser Functions\r\n// -------------------------------------------------------------------------\r\n\r\nlet lobbyBrowserUnsubscribe: (() => void) | null = null;\r\n\r\nasync function openLobbyBrowser(): Promise<void> {\r\n  console.log('[LobbyBrowser] Opening lobby browser...');\r\n  \r\n  // Validate player name first\r\n  const playerName = playerNameInput.value.trim();\r\n  if (!playerName) {\r\n    console.log('[LobbyBrowser] No player name entered');\r\n    playerNameInput.focus();\r\n    playerNameInput.style.borderColor = '#ff4444';\r\n    setTimeout(() => { playerNameInput.style.borderColor = ''; }, 2000);\r\n    return;\r\n  }\r\n  \r\n  lobbyBrowserModal.classList.remove('hidden');\r\n  connectionUI.classList.add('hidden');\r\n  \r\n  try {\r\n    // Unsubscribe from any existing subscription first\r\n    if (lobbyBrowserUnsubscribe) {\r\n      lobbyBrowserUnsubscribe();\r\n      lobbyBrowserUnsubscribe = null;\r\n    }\r\n    \r\n    // Initialize service and fetch lobbies\r\n    console.log('[LobbyBrowser] Initializing service...');\r\n    await LobbyBrowserService.initialize();\r\n    \r\n    // Clean up stale lobbies first\r\n    console.log('[LobbyBrowser] Cleaning stale lobbies...');\r\n    await LobbyBrowserService.cleanupStaleLobbies();\r\n    \r\n    // Subscribe to real-time updates (this will immediately fire with current data)\r\n    console.log('[LobbyBrowser] Subscribing to lobbies...');\r\n    lobbyBrowserUnsubscribe = LobbyBrowserService.subscribeToLobbies((lobbies) => {\r\n      console.log('[LobbyBrowser] Real-time update:', lobbies.length, 'lobbies');\r\n      renderLobbies(lobbies);\r\n    });\r\n    \r\n    console.log('[LobbyBrowser] Lobby browser ready');\r\n  } catch (e) {\r\n    console.error('[LobbyBrowser] Error opening lobby browser:', e);\r\n  }\r\n}\r\n\r\nfunction closeLobbyBrowser(): void {\r\n  lobbyBrowserModal.classList.add('hidden');\r\n  connectionUI.classList.remove('hidden');\r\n  \r\n  // Unsubscribe from updates\r\n  if (lobbyBrowserUnsubscribe) {\r\n    lobbyBrowserUnsubscribe();\r\n    lobbyBrowserUnsubscribe = null;\r\n  }\r\n}\r\n\r\nasync function refreshLobbies(): Promise<void> {\r\n  // Add spinning animation to refresh button\r\n  refreshLobbiesButton.classList.add('spinning');\r\n  \r\n  try {\r\n    const lobbies = await LobbyBrowserService.getPublicLobbies();\r\n    renderLobbies(lobbies);\r\n  } catch (e) {\r\n    console.error('[LobbyBrowser] Failed to refresh lobbies:', e);\r\n  }\r\n  \r\n  // Remove spinning animation after short delay\r\n  setTimeout(() => {\r\n    refreshLobbiesButton.classList.remove('spinning');\r\n  }, 500);\r\n}\r\n\r\nfunction renderLobbies(lobbies: PublicLobby[]): void {\r\n  // Clear existing lobby items (but not the empty state)\r\n  const existingItems = lobbyList.querySelectorAll('.lobby-item');\r\n  existingItems.forEach(item => item.remove());\r\n  \r\n  if (lobbies.length === 0) {\r\n    lobbyEmpty.style.display = 'block';\r\n    return;\r\n  }\r\n  \r\n  lobbyEmpty.style.display = 'none';\r\n  \r\n  for (const lobby of lobbies) {\r\n    const item = document.createElement('div');\r\n    item.className = 'lobby-item';\r\n    \r\n    const modeLabel = lobby.gameMode === 'spike' ? ' Spike' : ' Deathmatch';\r\n    const mapInfo = MAP_REGISTRY.find(m => m.id === lobby.mapId);\r\n    const mapName = mapInfo?.name || lobby.mapId;\r\n    \r\n    item.innerHTML = `\r\n      <div class=\"lobby-info\">\r\n        <div class=\"lobby-host\">${escapeHtml(lobby.hostName)}</div>\r\n        <div class=\"lobby-details\">\r\n          <span>${modeLabel}</span>\r\n          <span> ${mapName}</span>\r\n        </div>\r\n      </div>\r\n      <span class=\"lobby-players\">${lobby.currentPlayers}/${lobby.maxPlayers}</span>\r\n      <button class=\"join-btn\" data-room-code=\"${lobby.roomCode}\">Join</button>\r\n    `;\r\n    \r\n    // Add click handler for join button\r\n    const joinBtn = item.querySelector('.join-btn') as HTMLButtonElement;\r\n    joinBtn.addEventListener('click', () => {\r\n      joinPublicLobby(lobby.roomCode);\r\n    });\r\n    \r\n    lobbyList.insertBefore(item, lobbyEmpty);\r\n  }\r\n}\r\n\r\nfunction escapeHtml(text: string): string {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\nasync function joinPublicLobby(roomCode: string): Promise<void> {\r\n  // Close the lobby browser\r\n  closeLobbyBrowser();\r\n  \r\n  // Set the room code and trigger the join flow\r\n  roomCodeInput.value = roomCode;\r\n  \r\n  // Trigger the same flow as manual join\r\n  await handleConnect();\r\n}\r\n\r\n// Load saved settings\r\nfunction loadSettings(): void {\r\n  const saved = localStorage.getItem('cybergrid_settings');\r\n  if (saved) {\r\n    try {\r\n      const parsed = JSON.parse(saved);\r\n      gameSettings = { ...gameSettings, ...parsed };\r\n      \r\n      // Validate ability slot settings - must be 1 or 2, and different from each other\r\n      if (gameSettings.abilityQSlot !== 1 && gameSettings.abilityQSlot !== 2) {\r\n        gameSettings.abilityQSlot = 1;\r\n      }\r\n      if (gameSettings.abilityFSlot !== 1 && gameSettings.abilityFSlot !== 2) {\r\n        gameSettings.abilityFSlot = 2;\r\n      }\r\n      // If both are the same, reset to defaults\r\n      if (gameSettings.abilityQSlot === gameSettings.abilityFSlot) {\r\n        gameSettings.abilityQSlot = 1;\r\n        gameSettings.abilityFSlot = 2;\r\n      }\r\n      \r\n      console.log('[Settings] Loaded:', gameSettings);\r\n    } catch (e) {\r\n      console.warn('Failed to load settings:', e);\r\n    }\r\n  }\r\n  \r\n  // Apply to UI\r\n  botCountSlider.value = String(gameSettings.enemyBotCount);\r\n  botCountValue.textContent = String(gameSettings.enemyBotCount);\r\n  friendlyBotsSlider.value = String(gameSettings.friendlyBotCount);\r\n  friendlyBotsValue.textContent = String(gameSettings.friendlyBotCount);\r\n  botDifficultySelect.value = gameSettings.botDifficulty;\r\n  aiModeSelect.value = gameSettings.aiMode || 'rule_based';\r\n  gameModeSelect.value = gameSettings.gameMode;\r\n  \r\n  // Populate maps based on game mode, then set saved map\r\n  populateMapDropdown(gameSettings.gameMode);\r\n  if (gameSettings.mapId) {\r\n    mapSelect.value = gameSettings.mapId;\r\n  }\r\n  \r\n  heroSelect.value = gameSettings.playerHero;\r\n  abilityQSelect.value = String(gameSettings.abilityQSlot);\r\n  abilityFSelect.value = String(gameSettings.abilityFSlot);\r\n  updateAbilityNames();\r\n  updateMapHint();\r\n}\r\n\r\nfunction saveSettings(): void {\r\n  gameSettings = {\r\n    enemyBotCount: parseInt(botCountSlider.value),\r\n    friendlyBotCount: parseInt(friendlyBotsSlider.value),\r\n    botDifficulty: botDifficultySelect.value as 'easy' | 'medium' | 'hard',\r\n    gameMode: gameModeSelect.value as 'deathmatch' | 'spike',\r\n    mapId: mapSelect.value,\r\n    playerHero: heroSelect.value,\r\n    abilityQSlot: parseInt(abilityQSelect.value) as 1 | 2,\r\n    abilityFSlot: parseInt(abilityFSelect.value) as 1 | 2,\r\n    totalRounds: gameSettings.totalRounds,  // Preserve from lobby setting\r\n    aiMode: aiModeSelect.value as 'rule_based' | 'slm',\r\n  };\r\n  localStorage.setItem('cybergrid_settings', JSON.stringify(gameSettings));\r\n  settingsPanel.classList.add('hidden');\r\n}\r\n\r\n// Gameplay settings (saved separately)\r\ninterface GameplaySettings {\r\n  volume: number;\r\n  sensitivity: number;\r\n  showFps: boolean;\r\n}\r\n\r\n// Audio settings interface\r\ninterface AudioSettingsStorage {\r\n  masterVolume: number;\r\n  masterEnabled: boolean;\r\n  musicVolume: number;\r\n  musicEnabled: boolean;\r\n  sfxVolume: number;\r\n  sfxEnabled: boolean;\r\n  voiceVolume: number;\r\n  voiceEnabled: boolean;\r\n  uiVolume: number;\r\n  uiEnabled: boolean;\r\n}\r\n\r\nlet gameplaySettings: GameplaySettings = {\r\n  volume: 100,\r\n  sensitivity: 1.0,\r\n  showFps: true,\r\n};\r\n\r\nlet audioSettings: AudioSettingsStorage = {\r\n  masterVolume: 80,\r\n  masterEnabled: true,\r\n  musicVolume: 50,\r\n  musicEnabled: true,\r\n  sfxVolume: 80,\r\n  sfxEnabled: true,\r\n  voiceVolume: 100,\r\n  voiceEnabled: true,\r\n  uiVolume: 70,\r\n  uiEnabled: true,\r\n};\r\n\r\nfunction loadAudioSettings(): void {\r\n  const saved = localStorage.getItem('cybergrid_audio');\r\n  if (saved) {\r\n    try {\r\n      audioSettings = { ...audioSettings, ...JSON.parse(saved) };\r\n    } catch (e) {\r\n      console.warn('Failed to load audio settings:', e);\r\n    }\r\n  }\r\n  // Apply to UI (both panels)\r\n  updateAudioSettingsUI();\r\n  // Apply to uiAudio for menu sounds\r\n  const masterVol = audioSettings.masterVolume / 100;\r\n  const uiVol = audioSettings.uiVolume / 100;\r\n  uiAudio.setVolume(masterVol * uiVol);\r\n  uiAudio.setEnabled(audioSettings.masterEnabled && audioSettings.uiEnabled);\r\n}\r\n\r\nfunction saveAudioSettings(): void {\r\n  localStorage.setItem('cybergrid_audio', JSON.stringify(audioSettings));\r\n}\r\n\r\nfunction updateAudioSettingsUI(): void {\r\n  // Update pause menu audio controls\r\n  audioMasterVolume.value = String(audioSettings.masterVolume);\r\n  audioMasterEnabled.checked = audioSettings.masterEnabled;\r\n  audioMasterValue.textContent = `${audioSettings.masterVolume}%`;\r\n  audioMasterVolume.disabled = !audioSettings.masterEnabled;\r\n  \r\n  audioMusicVolume.value = String(audioSettings.musicVolume);\r\n  audioMusicEnabled.checked = audioSettings.musicEnabled;\r\n  audioMusicValue.textContent = `${audioSettings.musicVolume}%`;\r\n  audioMusicVolume.disabled = !audioSettings.musicEnabled;\r\n  \r\n  audioSfxVolume.value = String(audioSettings.sfxVolume);\r\n  audioSfxEnabled.checked = audioSettings.sfxEnabled;\r\n  audioSfxValue.textContent = `${audioSettings.sfxVolume}%`;\r\n  audioSfxVolume.disabled = !audioSettings.sfxEnabled;\r\n  \r\n  audioVoiceVolume.value = String(audioSettings.voiceVolume);\r\n  audioVoiceEnabled.checked = audioSettings.voiceEnabled;\r\n  audioVoiceValue.textContent = `${audioSettings.voiceVolume}%`;\r\n  audioVoiceVolume.disabled = !audioSettings.voiceEnabled;\r\n  \r\n  audioUiVolume.value = String(audioSettings.uiVolume);\r\n  audioUiEnabled.checked = audioSettings.uiEnabled;\r\n  audioUiValue.textContent = `${audioSettings.uiVolume}%`;\r\n  audioUiVolume.disabled = !audioSettings.uiEnabled;\r\n  \r\n  // Update settings panel audio controls\r\n  settingsAudioMasterVolume.value = String(audioSettings.masterVolume);\r\n  settingsAudioMasterEnabled.checked = audioSettings.masterEnabled;\r\n  settingsAudioMasterValue.textContent = `${audioSettings.masterVolume}%`;\r\n  settingsAudioMasterVolume.disabled = !audioSettings.masterEnabled;\r\n  \r\n  settingsAudioMusicVolume.value = String(audioSettings.musicVolume);\r\n  settingsAudioMusicEnabled.checked = audioSettings.musicEnabled;\r\n  settingsAudioMusicValue.textContent = `${audioSettings.musicVolume}%`;\r\n  settingsAudioMusicVolume.disabled = !audioSettings.musicEnabled;\r\n  \r\n  settingsAudioSfxVolume.value = String(audioSettings.sfxVolume);\r\n  settingsAudioSfxEnabled.checked = audioSettings.sfxEnabled;\r\n  settingsAudioSfxValue.textContent = `${audioSettings.sfxVolume}%`;\r\n  settingsAudioSfxVolume.disabled = !audioSettings.sfxEnabled;\r\n  \r\n  settingsAudioVoiceVolume.value = String(audioSettings.voiceVolume);\r\n  settingsAudioVoiceEnabled.checked = audioSettings.voiceEnabled;\r\n  settingsAudioVoiceValue.textContent = `${audioSettings.voiceVolume}%`;\r\n  settingsAudioVoiceVolume.disabled = !audioSettings.voiceEnabled;\r\n  \r\n  settingsAudioUiVolume.value = String(audioSettings.uiVolume);\r\n  settingsAudioUiEnabled.checked = audioSettings.uiEnabled;\r\n  settingsAudioUiValue.textContent = `${audioSettings.uiVolume}%`;\r\n  settingsAudioUiVolume.disabled = !audioSettings.uiEnabled;\r\n}\r\n\r\nfunction loadGameplaySettings(): void {\r\n  const saved = localStorage.getItem('cybergrid_gameplay');\r\n  if (saved) {\r\n    try {\r\n      gameplaySettings = { ...gameplaySettings, ...JSON.parse(saved) };\r\n    } catch (e) {\r\n      console.warn('Failed to load gameplay settings:', e);\r\n    }\r\n  }\r\n  updatePauseMenuUI();\r\n}\r\n\r\nfunction saveGameplaySettings(): void {\r\n  gameplaySettings = {\r\n    volume: 100, // Deprecated, now using audio categories\r\n    sensitivity: parseFloat(sensitivitySlider.value) / 10,\r\n    showFps: fpsCheckbox.checked,\r\n  };\r\n  localStorage.setItem('cybergrid_gameplay', JSON.stringify(gameplaySettings));\r\n}\r\n\r\nfunction updatePauseMenuUI(): void {\r\n  sensitivitySlider.value = String(Math.round(gameplaySettings.sensitivity * 10));\r\n  sensitivityValue.textContent = gameplaySettings.sensitivity.toFixed(1);\r\n  fpsCheckbox.checked = gameplaySettings.showFps;\r\n  \r\n  // Update audio settings UI from game if available\r\n  if (game) {\r\n    const audioSettings = game.getAudioSettings();\r\n    if (audioSettings) {\r\n      audioMasterVolume.value = String(audioSettings.masterVolume);\r\n      audioMasterEnabled.checked = audioSettings.masterEnabled;\r\n      audioMasterValue.textContent = `${audioSettings.masterVolume}%`;\r\n      audioMasterVolume.disabled = !audioSettings.masterEnabled;\r\n      \r\n      audioMusicVolume.value = String(audioSettings.musicVolume);\r\n      audioMusicEnabled.checked = audioSettings.musicEnabled;\r\n      audioMusicValue.textContent = `${audioSettings.musicVolume}%`;\r\n      audioMusicVolume.disabled = !audioSettings.musicEnabled;\r\n      \r\n      audioSfxVolume.value = String(audioSettings.sfxVolume);\r\n      audioSfxEnabled.checked = audioSettings.sfxEnabled;\r\n      audioSfxValue.textContent = `${audioSettings.sfxVolume}%`;\r\n      audioSfxVolume.disabled = !audioSettings.sfxEnabled;\r\n      \r\n      audioVoiceVolume.value = String(audioSettings.voiceVolume);\r\n      audioVoiceEnabled.checked = audioSettings.voiceEnabled;\r\n      audioVoiceValue.textContent = `${audioSettings.voiceVolume}%`;\r\n      audioVoiceVolume.disabled = !audioSettings.voiceEnabled;\r\n      \r\n      audioUiVolume.value = String(audioSettings.uiVolume);\r\n      audioUiEnabled.checked = audioSettings.uiEnabled;\r\n      audioUiValue.textContent = `${audioSettings.uiVolume}%`;\r\n      audioUiVolume.disabled = !audioSettings.uiEnabled;\r\n    }\r\n  }\r\n}\r\n\r\n// -------------------------------------------------------------------------\r\n// Buy Menu Functions\r\n// -------------------------------------------------------------------------\r\n\r\nconst WEAPON_PRICES: Record<string, number> = {\r\n  'burst_pistol': 0,\r\n  'neo_smg9': 1100,\r\n  'pulse_rifle': 1500,\r\n  'scatter_shot': 1400,\r\n  'rail_sniper': 2100,\r\n  'shard_launcher': 600,\r\n  'nano_repeater': 900,\r\n  'arc_welder': 1300,\r\n  'phase_repeater': 1800,\r\n  'plasma_cannon': 2800,\r\n};\r\n\r\n// Help Panel Functions\r\nfunction showHelpPanel(autoHide: boolean = false): void {\r\n  helpPanelVisible = true;\r\n  helpPanel.classList.add('visible');\r\n  \r\n  // Clear any existing auto-hide timer\r\n  if (helpAutoHideTimer !== null) {\r\n    clearTimeout(helpAutoHideTimer);\r\n    helpAutoHideTimer = null;\r\n  }\r\n  \r\n  // Auto-hide after 5 seconds if requested\r\n  if (autoHide) {\r\n    helpAutoHideTimer = window.setTimeout(() => {\r\n      hideHelpPanel();\r\n    }, 5000);\r\n  }\r\n}\r\n\r\nfunction hideHelpPanel(): void {\r\n  if (!helpPanelVisible) return; // Already hidden\r\n  helpPanelVisible = false;\r\n  helpPanel.classList.remove('visible');\r\n  if (helpAutoHideTimer !== null) {\r\n    clearTimeout(helpAutoHideTimer);\r\n    helpAutoHideTimer = null;\r\n  }\r\n}\r\n\r\nfunction openBuyMenu(): void {\r\n  if (!game) return;\r\n  const player = game.getWorld().getLocalPlayer();\r\n  if (!player || !player.alive) return;\r\n  \r\n  updateBuyMenuUI();\r\n  buyMenu.classList.remove('hidden');\r\n}\r\n\r\nfunction closeBuyMenu(): void {\r\n  buyMenu.classList.add('hidden');\r\n}\r\n\r\nfunction updateBuyMenuUI(): void {\r\n  if (!game) return;\r\n  const player = game.getWorld().getLocalPlayer();\r\n  if (!player) return;\r\n  \r\n  // Update credits display\r\n  buyCredits.textContent = String(player.credits);\r\n  \r\n  // Update weapon item states\r\n  weaponItems.forEach(item => {\r\n    const weaponId = item.dataset.weapon || '';\r\n    const slotStr = item.dataset.slot || '1';\r\n    const slot = parseInt(slotStr) - 1;\r\n    const price = WEAPON_PRICES[weaponId] || 0;\r\n    \r\n    // Check if player owns this weapon\r\n    const owned = player.weaponInventory[slot] !== null;\r\n    const canAfford = player.credits >= price;\r\n    \r\n    // Reset classes\r\n    item.classList.remove('owned', 'cant-afford');\r\n    \r\n    if (owned) {\r\n      item.classList.add('owned');\r\n      const priceEl = item.querySelector('.weapon-price');\r\n      if (priceEl) priceEl.textContent = 'OWNED';\r\n    } else if (!canAfford && price > 0) {\r\n      item.classList.add('cant-afford');\r\n    }\r\n  });\r\n}\r\n\r\nfunction tryBuyWeapon(weaponId: string): void {\r\n  if (!game) return;\r\n  const player = game.getWorld().getLocalPlayer();\r\n  if (!player || !player.alive) return;\r\n  \r\n  // Map string to WeaponId enum\r\n  const weaponIdMap: Record<string, import('@/shared/types').WeaponId> = {\r\n    'burst_pistol': 'burst_pistol' as import('@/shared/types').WeaponId,\r\n    'neo_smg9': 'neo_smg9' as import('@/shared/types').WeaponId,\r\n    'pulse_rifle': 'pulse_rifle' as import('@/shared/types').WeaponId,\r\n    'scatter_shot': 'scatter_shot' as import('@/shared/types').WeaponId,\r\n    'rail_sniper': 'rail_sniper' as import('@/shared/types').WeaponId,\r\n    'shard_launcher': 'shard_launcher' as import('@/shared/types').WeaponId,\r\n    'nano_repeater': 'nano_repeater' as import('@/shared/types').WeaponId,\r\n    'arc_welder': 'arc_welder' as import('@/shared/types').WeaponId,\r\n    'phase_repeater': 'phase_repeater' as import('@/shared/types').WeaponId,\r\n    'plasma_cannon': 'plasma_cannon' as import('@/shared/types').WeaponId,\r\n  };\r\n  \r\n  const enumWeaponId = weaponIdMap[weaponId];\r\n  if (!enumWeaponId) return;\r\n  \r\n  // Check if already owned\r\n  const slot = player.getWeaponSlotForId(enumWeaponId) - 1;\r\n  if (player.weaponInventory[slot] !== null) {\r\n    // Already owned - just switch to it\r\n    player.switchToWeaponSlot(slot + 1);\r\n    closeBuyMenu();\r\n    return;\r\n  }\r\n  \r\n  // Try to buy\r\n  const success = player.buyWeapon(enumWeaponId);\r\n  if (success) {\r\n    updateBuyMenuUI();\r\n    // Play purchase sound or effect here\r\n  }\r\n}\r\n\r\nfunction pauseGame(): void {\r\n  if (!game) return;\r\n  game.pause();\r\n  pauseMenu.classList.remove('hidden');\r\n}\r\n\r\nfunction resumeGame(): void {\r\n  if (!game) return;\r\n  pauseMenu.classList.add('hidden');\r\n  saveGameplaySettings();\r\n  game.resume();\r\n}\r\n\r\nfunction quitToMenu(): void {\r\n  if (!game) return;\r\n  \r\n  // End stats session before stopping game\r\n  game.endStatsSession();\r\n  \r\n  // Cleanup voice chat\r\n  cleanupVoiceChat();\r\n  \r\n  game.stop();\r\n  game = null;\r\n  gameStarted = false; // Reset so Start Game button works again\r\n  stopRoundEndPolling();\r\n  stopLobbyCountdown();\r\n  \r\n  // Hide all game UI\r\n  canvas.classList.add('hidden');\r\n  pauseMenu.classList.add('hidden');\r\n  roundOverPanel.classList.add('hidden');\r\n  roomCodeDisplay.classList.add('hidden');\r\n  lobbyScreen.classList.add('hidden');\r\n  helpPanel.classList.remove('visible');\r\n  buyMenu.classList.add('hidden');\r\n  \r\n  // Show main menu UI\r\n  connectionUI.classList.remove('hidden');\r\n  settingsButton.classList.remove('hidden');\r\n  \r\n  // Reset join UI\r\n  hostButton.classList.remove('hidden');\r\n  joinButton.classList.remove('hidden');\r\n  roomCodeInput.classList.add('hidden');\r\n  joinButtons.classList.add('hidden');\r\n  roomCodeInput.value = '';\r\n  \r\n  // Reset lobby state\r\n  lobbyState.isHost = false;\r\n  lobbyState.players = [];\r\n  lobbyState.roomCode = '';\r\n  lobbyState.isPublic = false;\r\n  gameStarted = false;\r\n  \r\n  // Disconnect network if still connected\r\n  if (lobbyNetwork) {\r\n    lobbyNetwork.disconnect();\r\n    lobbyNetwork = null;\r\n  }\r\n}\r\n\r\n// -------------------------------------------------------------------------\r\n// Lobby System\r\n// -------------------------------------------------------------------------\r\n\r\ninterface LobbyPlayer {\r\n  id: string;\r\n  name: string;\r\n  isHost: boolean;\r\n}\r\n\r\ninterface LobbyState {\r\n  isHost: boolean;\r\n  roomCode: string;\r\n  players: LobbyPlayer[];\r\n  maxPlayers: number;\r\n  countdownActive: boolean;\r\n  countdownValue: number;\r\n  isPublic: boolean;\r\n}\r\n\r\nconst lobbyState: LobbyState = {\r\n  isHost: false,\r\n  roomCode: '',\r\n  players: [],\r\n  maxPlayers: 2,\r\n  countdownActive: false,\r\n  countdownValue: 5,\r\n  isPublic: false,\r\n};\r\n\r\nlet lobbyCountdownInterval: number | null = null;\r\n\r\nfunction generateRoomCode(): string {\r\n  const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ';\r\n  const digits = '0123456789';\r\n  \r\n  let code = '';\r\n  for (let i = 0; i < 4; i++) {\r\n    code += letters.charAt(Math.floor(Math.random() * letters.length));\r\n  }\r\n  for (let i = 0; i < 2; i++) {\r\n    code += digits.charAt(Math.floor(Math.random() * digits.length));\r\n  }\r\n  \r\n  return code;\r\n}\r\n\r\nfunction showLobby(isHost: boolean, roomCode: string, playerName: string): void {\r\n  // Reset game started flag so Start Game button works\r\n  gameStarted = false;\r\n  \r\n  lobbyState.isHost = isHost;\r\n  lobbyState.roomCode = roomCode;\r\n  lobbyState.maxPlayers = parseInt(lobbyPlayerCountSelect.value);\r\n  lobbyState.countdownActive = false;\r\n  lobbyState.isPublic = isHost ? lobbyMakePublicCheckbox.checked : false;\r\n  \r\n  // Add self as first player\r\n  lobbyState.players = [{\r\n    id: 'local',\r\n    name: playerName,\r\n    isHost: isHost,\r\n  }];\r\n  \r\n  // Update UI\r\n  lobbyRoomCode.textContent = roomCode;\r\n  lobbyMaxPlayers.textContent = String(lobbyState.maxPlayers);\r\n  \r\n  // Show/hide host controls - ONLY host sees these\r\n  hostSettings.style.display = isHost ? 'block' : 'none';\r\n  startGameButton.style.display = isHost ? 'block' : 'none';\r\n  \r\n  // Update waiting text based on role\r\n  if (isHost) {\r\n    lobbyWaitingText.innerHTML = 'Waiting for players<span class=\"dots\">...</span>';\r\n  } else {\r\n    lobbyWaitingText.innerHTML = 'Connecting to host<span class=\"dots\">...</span>';\r\n  }\r\n  \r\n  // Hide connection UI, show lobby\r\n  connectionUI.classList.add('hidden');\r\n  settingsPanel.classList.add('hidden');\r\n  settingsButton.classList.add('hidden');\r\n  lobbyScreen.classList.remove('hidden');\r\n  \r\n  // If host, sync the Make Public checkbox state with lobbyState\r\n  // Don't auto-create here - let the checkbox change handler do it\r\n  // This prevents duplicate lobby creation\r\n  if (isHost) {\r\n    lobbyMakePublicCheckbox.checked = lobbyState.isPublic;\r\n    console.log('[Lobby] isHost:', isHost, 'isPublic:', lobbyState.isPublic);\r\n  }\r\n  \r\n  updateLobbyUI();\r\n}\r\n\r\nfunction updateLobbyUI(): void {\r\n  // Update player count\r\n  lobbyCurrentPlayers.textContent = String(lobbyState.players.length);\r\n  lobbyMaxPlayers.textContent = String(lobbyState.maxPlayers);\r\n  \r\n  // Update player list\r\n  lobbyPlayerList.innerHTML = '';\r\n  for (const player of lobbyState.players) {\r\n    const item = document.createElement('div');\r\n    item.className = `player-item${player.isHost ? ' host' : ''}`;\r\n    item.innerHTML = `\r\n      <span class=\"name\">${player.name}</span>\r\n      ${player.isHost ? '<span class=\"tag\">Host</span>' : ''}\r\n    `;\r\n    lobbyPlayerList.appendChild(item);\r\n  }\r\n  \r\n  // Update start button state (host only)\r\n  if (lobbyState.isHost) {\r\n    const canStart = lobbyState.players.length >= lobbyState.maxPlayers || lobbyState.maxPlayers === 1;\r\n    startGameButton.disabled = !canStart;\r\n    \r\n    if (canStart && !lobbyState.countdownActive) {\r\n      lobbyWaitingText.textContent = 'All players ready!';\r\n    } else if (!lobbyState.countdownActive) {\r\n      lobbyWaitingText.innerHTML = 'Waiting for players<span class=\"dots\">...</span>';\r\n    }\r\n    \r\n    // Update public lobby player count\r\n    if (lobbyState.isPublic) {\r\n      LobbyBrowserService.updateLobbyPlayerCount(lobbyState.roomCode, lobbyState.players.length);\r\n    }\r\n  } else {\r\n    // Joiner - show different message based on connection state\r\n    const hasHost = lobbyState.players.some(p => p.isHost && p.id !== 'local');\r\n    if (hasHost) {\r\n      lobbyWaitingText.innerHTML = 'Waiting for host to start<span class=\"dots\">...</span>';\r\n    } else {\r\n      lobbyWaitingText.innerHTML = 'Connecting to host<span class=\"dots\">...</span>';\r\n    }\r\n  }\r\n  \r\n  // Auto-start countdown when full\r\n  if (lobbyState.players.length >= lobbyState.maxPlayers && !lobbyState.countdownActive && lobbyState.maxPlayers > 1) {\r\n    startLobbyCountdown();\r\n  }\r\n}\r\n\r\nfunction startLobbyCountdown(): void {\r\n  if (lobbyState.countdownActive) return;\r\n  \r\n  lobbyState.countdownActive = true;\r\n  lobbyState.countdownValue = 5;\r\n  \r\n  lobbyWaitingText.classList.add('hidden');\r\n  lobbyCountdown.classList.remove('hidden');\r\n  lobbyCountdown.textContent = String(lobbyState.countdownValue);\r\n  \r\n  lobbyCountdownInterval = window.setInterval(() => {\r\n    lobbyState.countdownValue--;\r\n    lobbyCountdown.textContent = String(lobbyState.countdownValue);\r\n    \r\n    if (lobbyState.countdownValue <= 0) {\r\n      stopLobbyCountdown();\r\n      startGameFromLobby();\r\n    }\r\n  }, 1000);\r\n}\r\n\r\nfunction stopLobbyCountdown(): void {\r\n  if (lobbyCountdownInterval !== null) {\r\n    clearInterval(lobbyCountdownInterval);\r\n    lobbyCountdownInterval = null;\r\n  }\r\n  lobbyState.countdownActive = false;\r\n  lobbyCountdown.classList.add('hidden');\r\n  lobbyWaitingText.classList.remove('hidden');\r\n}\r\n\r\nlet gameStarted = false; // Prevent double start\r\n\r\nfunction leaveLobby(): void {\r\n  stopLobbyCountdown();\r\n  lobbyScreen.classList.add('hidden');\r\n  connectionUI.classList.remove('hidden');\r\n  settingsButton.classList.remove('hidden');\r\n  \r\n  // Remove from public lobby listings if host\r\n  if (lobbyState.isHost && lobbyState.isPublic) {\r\n    LobbyBrowserService.removeLobby(lobbyState.roomCode);\r\n  }\r\n  \r\n  // Reset join UI\r\n  hostButton.classList.remove('hidden');\r\n  joinButton.classList.remove('hidden');\r\n  roomCodeInput.classList.add('hidden');\r\n  joinButtons.classList.add('hidden');\r\n  roomCodeInput.value = '';\r\n  \r\n  // Reset lobby state\r\n  lobbyState.isHost = false;\r\n  lobbyState.players = [];\r\n  lobbyState.roomCode = '';\r\n  lobbyState.isPublic = false;\r\n  gameStarted = false; // Reset game started flag\r\n  \r\n  // Disconnect lobby network if exists\r\n  if (lobbyNetwork) {\r\n    lobbyNetwork.disconnect();\r\n    lobbyNetwork = null;\r\n  }\r\n}\r\n\r\nasync function startGameFromLobby(): Promise<void> {\r\n  // Prevent double execution\r\n  if (gameStarted) {\r\n    console.log(`[Main] startGameFromLobby already called, ignoring`);\r\n    return;\r\n  }\r\n  gameStarted = true;\r\n  \r\n  const playerName = playerNameInput.value.trim() || 'Player';\r\n  \r\n  // Hide lobby\r\n  lobbyScreen.classList.add('hidden');\r\n  \r\n  // Remove from public lobby listings (game is starting)\r\n  if (lobbyState.isHost && lobbyState.isPublic) {\r\n    LobbyBrowserService.removeLobby(lobbyState.roomCode);\r\n  }\r\n  \r\n  // Update settings with lobby values\r\n  gameSettings.totalRounds = parseInt(lobbyRoundCountSelect.value);\r\n  \r\n  // Get the network to pass to the game (don't disconnect it!)\r\n  const networkToPass = lobbyNetwork;\r\n  lobbyNetwork = null;  // Transfer ownership to game\r\n  \r\n  // Remove lobby event listeners - Game will set up its own\r\n  if (networkToPass) {\r\n    networkToPass.removeAllListeners();\r\n    console.log(`[Main] Removed lobby listeners from network`);\r\n  }\r\n  \r\n  // If host, broadcast game start to all peers BEFORE transferring network\r\n  if (lobbyState.isHost && networkToPass) {\r\n    console.log(`[Main] Broadcasting GameStart to all peers`);\r\n    networkToPass.broadcast({\r\n      type: PacketType.GameStart,\r\n      timestamp: Date.now(),\r\n      senderId: networkToPass.getLocalPeerId(),\r\n      data: {\r\n        roomCode: lobbyState.roomCode,\r\n        totalRounds: gameSettings.totalRounds,\r\n        mapId: gameSettings.mapId,\r\n        gameMode: gameSettings.gameMode,\r\n      },\r\n    });\r\n  }\r\n  \r\n  // Create game with settings and existing network connection\r\n  // Pass lobby players so game knows their names\r\n  console.log(`[Main] lobbyState.players RAW:`, JSON.stringify(lobbyState.players));\r\n  const lobbyPlayersForGame = lobbyState.players.map(p => ({\r\n    id: p.id,\r\n    name: p.name,\r\n    isHost: p.isHost,\r\n  }));\r\n  \r\n  console.log(`[Main] Passing ${lobbyPlayersForGame.length} lobby players to game:`, JSON.stringify(lobbyPlayersForGame));\r\n  console.log(`[Main] networkToPass exists: ${!!networkToPass}, peers: ${networkToPass?.getPeerIds().length || 0}`);\r\n  \r\n  if (networkToPass) {\r\n    console.log(`[Main] Creating Game with EXISTING network (${networkToPass.getPeerIds().length} peers)`);\r\n    game = new Game({\r\n      canvas,\r\n      playerName,\r\n      settings: gameSettings,\r\n      network: networkToPass,  // Pass existing lobby network\r\n      lobbyPlayers: lobbyPlayersForGame,  // Pass lobby players with names\r\n      appVersion: __APP_VERSION__,\r\n    });\r\n  } else {\r\n    console.log(`[Main] Creating Game WITHOUT network (will create new)`);\r\n    game = new Game({\r\n      canvas,\r\n      playerName,\r\n      settings: gameSettings,\r\n      lobbyPlayers: lobbyPlayersForGame,\r\n      appVersion: __APP_VERSION__,\r\n    });\r\n  }\r\n\r\n  await game.init();\r\n  \r\n  // Apply gameplay settings to game\r\n  game.setShowFPS(gameplaySettings.showFps);\r\n  \r\n  // Apply audio settings to game\r\n  game.updateAudioSettings(audioSettings);\r\n\r\n  // Host game with the lobby's room code (game will use passed network)\r\n  if (lobbyState.isHost) {\r\n    const roomCode = await game.hostGame(lobbyState.roomCode);\r\n    console.log(`[Main] Starting game as HOST: ${roomCode} (Best of ${gameSettings.totalRounds})`);\r\n  } else {\r\n    // Joining player - use joinGame instead\r\n    await game.joinGame(lobbyState.roomCode);\r\n    console.log(`[Main] Joined game: ${lobbyState.roomCode}`);\r\n  }\r\n  \r\n  // Hide room code display during gameplay (only needed in lobby)\r\n  roomCodeDisplay.classList.add('hidden');\r\n  \r\n  // Show game canvas\r\n  canvas.classList.remove('hidden');\r\n\r\n  // Start game loop\r\n  game.start();\r\n  \r\n  // Start player stats tracking session\r\n  game.startStatsSession();\r\n  \r\n  // Track match start in analytics\r\n  game.trackMatchStart();\r\n  \r\n  // Show help panel briefly for new players\r\n  showHelpPanel(true);\r\n  \r\n  // Start polling for round end\r\n  startRoundEndPolling();\r\n  \r\n  // Initialize and show voice chat\r\n  initVoiceChat();\r\n}\r\n\r\n// Round Over functions\r\nlet roundEndPollingId: number | null = null;\r\nlet roundOverShown = false;\r\nlet idleTimeoutId: number | null = null;\r\nlet lastInteractionTime: number = Date.now();\r\n\r\nfunction showRoundOver(\r\n  winningTeam: 'attackers' | 'defenders', \r\n  attackerScore: number, \r\n  defenderScore: number,\r\n  isMatchOver: boolean,\r\n  roundsToWin: number,\r\n  isForfeit: boolean = false,\r\n  forfeitPlayerName: string = ''\r\n): void {\r\n  // Get the round over panel header\r\n  const header = roundOverPanel.querySelector('h2');\r\n  \r\n  // Update match info\r\n  matchInfo.textContent = `First to ${roundsToWin} wins`;\r\n  \r\n  if (isMatchOver) {\r\n    // Match is over - show match winner and Play Again button\r\n    if (isForfeit) {\r\n      if (header) header.textContent = ' Player Disconnected';\r\n      winnerText.textContent = `${forfeitPlayerName} has left the match`;\r\n      winnerText.className = 'winner-text';\r\n      matchInfo.textContent = 'Opponent forfeited - You Win!';\r\n    } else if (winningTeam === 'attackers') {\r\n      if (header) header.textContent = ' Match Over!';\r\n      winnerText.textContent = ' ATTACKERS WIN THE MATCH!';\r\n      winnerText.className = 'winner-text attackers';\r\n    } else {\r\n      if (header) header.textContent = ' Match Over!';\r\n      winnerText.textContent = ' DEFENDERS WIN THE MATCH!';\r\n      winnerText.className = 'winner-text defenders';\r\n    }\r\n    \r\n    if (!isForfeit) {\r\n      matchInfo.textContent = 'Match Complete!';\r\n    }\r\n    \r\n    // Show Play Again and Main Menu buttons, hide countdown\r\n    playAgainButton.classList.remove('hidden');\r\n    playAgainButton.textContent = 'Play Again';\r\n    mainMenuButton.classList.remove('hidden');\r\n    countdownDisplay.classList.add('hidden');\r\n    \r\n    // Record match result to player stats\r\n    if (game) {\r\n      game.recordMatchResult();\r\n    }\r\n    \r\n    // Start idle timeout (60 seconds of no interaction)\r\n    startIdleTimeout();\r\n  } else {\r\n    // Round is over - show round winner and countdown\r\n    if (header) header.textContent = ' Round Over';\r\n    if (winningTeam === 'attackers') {\r\n      winnerText.textContent = ' Attackers Win Round!';\r\n      winnerText.className = 'winner-text attackers';\r\n    } else {\r\n      winnerText.textContent = ' Defenders Win Round!';\r\n      winnerText.className = 'winner-text defenders';\r\n    }\r\n    \r\n    // Show countdown, hide Play Again and Main Menu buttons\r\n    countdownDisplay.classList.remove('hidden');\r\n    playAgainButton.classList.add('hidden');\r\n    mainMenuButton.classList.add('hidden');\r\n  }\r\n  \r\n  // Update scores\r\n  scoreAttackers.textContent = String(attackerScore);\r\n  scoreDefenders.textContent = String(defenderScore);\r\n  \r\n  // Show panel\r\n  roundOverPanel.classList.remove('hidden');\r\n  roundOverShown = true;\r\n}\r\n\r\nfunction updateCountdownDisplay(): void {\r\n  if (!game) return;\r\n  \r\n  const countdownInfo = game.getCountdownInfo();\r\n  if (!countdownInfo) return;\r\n  \r\n  const seconds = Math.ceil(countdownInfo.countdownTime / 1000);\r\n  \r\n  if (countdownInfo.isPaused) {\r\n    countdownText.textContent = `PAUSED by ${countdownInfo.pausedBy}`;\r\n    countdownText.classList.add('paused');\r\n    pauseCountdownButton.textContent = ' Resume';\r\n    pauseCountdownButton.classList.add('paused');\r\n  } else {\r\n    countdownText.textContent = `Next round in ${seconds}s`;\r\n    countdownText.classList.remove('paused');\r\n    pauseCountdownButton.textContent = ' Pause';\r\n    pauseCountdownButton.classList.remove('paused');\r\n  }\r\n}\r\n\r\nfunction startRoundEndPolling(): void {\r\n  roundOverShown = false;\r\n  \r\n  // Poll every 100ms\r\n  roundEndPollingId = window.setInterval(() => {\r\n    if (!game) {\r\n      stopRoundEndPolling();\r\n      return;\r\n    }\r\n    \r\n    const info = game.getRoundEndInfo();\r\n    if (info && !roundOverShown) {\r\n      showRoundOver(\r\n        info.winningTeam, \r\n        info.attackerScore, \r\n        info.defenderScore,\r\n        info.isMatchOver,\r\n        info.roundsToWin,\r\n        info.isForfeit,\r\n        info.forfeitPlayerName\r\n      );\r\n    }\r\n    \r\n    // Update countdown display while round over panel is shown\r\n    if (roundOverShown && info && !info.isMatchOver) {\r\n      updateCountdownDisplay();\r\n    }\r\n    \r\n    // Hide round over panel when round becomes active again\r\n    if (roundOverShown && game.isRoundActive()) {\r\n      roundOverPanel.classList.add('hidden');\r\n      roundOverShown = false;\r\n    }\r\n  }, 100);\r\n}\r\n\r\nfunction stopRoundEndPolling(): void {\r\n  if (roundEndPollingId !== null) {\r\n    clearInterval(roundEndPollingId);\r\n    roundEndPollingId = null;\r\n  }\r\n  \r\n  // Clear idle timeout if active\r\n  clearIdleTimeout();\r\n}\r\n\r\nfunction startIdleTimeout(): void {\r\n  // Clear any existing timeout\r\n  clearIdleTimeout();\r\n  \r\n  // Reset last interaction time\r\n  lastInteractionTime = Date.now();\r\n  \r\n  // Start checking for idle (every second)\r\n  idleTimeoutId = window.setInterval(() => {\r\n    const idleTime = Date.now() - lastInteractionTime;\r\n    \r\n    // If idle for 60 seconds, return to menu\r\n    if (idleTime >= 60000) {\r\n      console.log('[Main] 60 seconds idle - returning to menu');\r\n      clearIdleTimeout();\r\n      quitToMenu();\r\n    }\r\n  }, 1000);\r\n}\r\n\r\nfunction clearIdleTimeout(): void {\r\n  if (idleTimeoutId !== null) {\r\n    clearInterval(idleTimeoutId);\r\n    idleTimeoutId = null;\r\n  }\r\n}\r\n\r\nfunction resetIdleTimer(): void {\r\n  lastInteractionTime = Date.now();\r\n}\r\n\r\nfunction playAgain(): void {\r\n  if (!game) return;\r\n  \r\n  // User interaction - reset idle timer\r\n  resetIdleTimer();\r\n  clearIdleTimeout();\r\n  \r\n  // Check if this is match over\r\n  const info = game.getRoundEndInfo();\r\n  \r\n  if (info?.isMatchOver) {\r\n    // Match is over - full restart\r\n    roundOverPanel.classList.add('hidden');\r\n    roundOverShown = false;\r\n    game.restartGame();\r\n  }\r\n  // Note: For round over, the countdown handles starting the next round automatically\r\n}\r\n\r\nfunction toggleCountdownPause(): void {\r\n  if (!game) return;\r\n  game.toggleCountdownPause();\r\n}\r\n\r\n// ============================================================================\r\n// Voice Chat Functions\r\n// ============================================================================\r\n\r\nfunction initVoiceChat(): void {\r\n  const voiceChat = VoiceChatService.getInstance();\r\n  voiceChat.initialize();\r\n  \r\n  // Show microphone button during gameplay\r\n  if (micToggleButton) {\r\n    micToggleButton.classList.add('show');\r\n    updateMicButtonUI(false);\r\n  }\r\n  \r\n  // Set up voice chat based on game configuration\r\n  if (game) {\r\n    const localPlayer = game.getWorld().getLocalPlayer();\r\n    if (localPlayer) {\r\n      // Get all players and filter by team (or all if 1v1)\r\n      const allPlayers = game.getWorld().getPlayers();\r\n      const is1v1 = allPlayers.length === 2;\r\n      \r\n      if (is1v1) {\r\n        // In 1v1, allow communication with the other player\r\n        const allowedPeers = allPlayers\r\n          .filter((p) => p.id !== localPlayer.id)\r\n          .map((p) => p.peerId);\r\n        voiceChat.setAllowedPeers(allowedPeers);\r\n      } else {\r\n        // In team games, only allow communication with teammates\r\n        const allowedPeers = allPlayers\r\n          .filter((p) => p.team === localPlayer.team && p.id !== localPlayer.id)\r\n          .map((p) => p.peerId);\r\n        voiceChat.setAllowedPeers(allowedPeers);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction cleanupVoiceChat(): void {\r\n  const voiceChat = VoiceChatService.getInstance();\r\n  voiceChat.cleanup();\r\n  \r\n  // Hide microphone button\r\n  if (micToggleButton) {\r\n    micToggleButton.classList.remove('show');\r\n  }\r\n}\r\n\r\nfunction updateMicButtonUI(enabled: boolean): void {\r\n  if (!micToggleButton) return;\r\n  \r\n  if (enabled) {\r\n    micToggleButton.classList.add('active');\r\n    micToggleButton.classList.remove('muted');\r\n    micToggleButton.innerHTML = '';\r\n    micToggleButton.title = 'Microphone ON (click to mute)';\r\n  } else {\r\n    micToggleButton.classList.remove('active');\r\n    micToggleButton.classList.add('muted');\r\n    micToggleButton.innerHTML = '';\r\n    micToggleButton.title = 'Microphone OFF (click to enable)';\r\n  }\r\n}\r\n\r\n// Initialize\r\nasync function init(): Promise<void> {\r\n  // Set canvas size\r\n  canvas.width = 1280;\r\n  canvas.height = 720;\r\n\r\n  // Display version\r\n  if (versionBadge) {\r\n    versionBadge.textContent = `v${__APP_VERSION__}`;\r\n  }\r\n\r\n  // Load saved player name\r\n  const savedName = localStorage.getItem('cybergrid_playerName');\r\n  if (savedName) {\r\n    playerNameInput.value = savedName;\r\n  }\r\n\r\n  // Load settings\r\n  loadSettings();\r\n\r\n  // Event listeners\r\n  hostButton.addEventListener('click', handleHost);\r\n  joinButton.addEventListener('click', handleJoinClick);\r\n  connectButton.addEventListener('click', handleConnect);\r\n  backButton.addEventListener('click', handleBack);\r\n\r\n  playerNameInput.addEventListener('input', () => {\r\n    localStorage.setItem('cybergrid_playerName', playerNameInput.value);\r\n  });\r\n\r\n  // Settings listeners\r\n  settingsButton.addEventListener('click', () => {\r\n    settingsPanel.classList.toggle('hidden');\r\n    if (!settingsPanel.classList.contains('hidden')) {\r\n      AnalyticsService.trackUIOpen('settings');\r\n    }\r\n  });\r\n  \r\n  settingsCloseButton.addEventListener('click', () => {\r\n    loadSettings(); // Reset to saved values\r\n    settingsPanel.classList.add('hidden');\r\n  });\r\n  \r\n  settingsSaveButton.addEventListener('click', saveSettings);\r\n  \r\n  // How to Play modal listeners\r\n  howToPlayButton.addEventListener('click', () => {\r\n    howToPlayModal.classList.toggle('hidden');\r\n    if (!howToPlayModal.classList.contains('hidden')) {\r\n      AnalyticsService.trackUIOpen('how_to_play');\r\n    }\r\n  });\r\n  \r\n  howToPlayCloseButton.addEventListener('click', () => {\r\n    howToPlayModal.classList.add('hidden');\r\n  });\r\n  \r\n  // Stats modal listeners\r\n  statsButton.addEventListener('click', () => {\r\n    statsModal.classList.toggle('hidden');\r\n    if (!statsModal.classList.contains('hidden')) {\r\n      loadStatsModal();\r\n    }\r\n  });\r\n  \r\n  statsCloseButton.addEventListener('click', () => {\r\n    statsModal.classList.add('hidden');\r\n  });\r\n  \r\n  // Microphone toggle button listener\r\n  micToggleButton.addEventListener('click', async () => {\r\n    uiAudio.playClick();\r\n    const voiceChat = VoiceChatService.getInstance();\r\n    const newState = await voiceChat.toggleMicrophone();\r\n    updateMicButtonUI(newState);\r\n  });\r\n  \r\n  micToggleButton.addEventListener('mouseenter', () => {\r\n    uiAudio.playHover();\r\n  });\r\n  \r\n  // Lobby browser listeners\r\n  findMatchButton.addEventListener('click', () => {\r\n    openLobbyBrowser();\r\n  });\r\n  \r\n  lobbyBrowserCloseButton.addEventListener('click', () => {\r\n    closeLobbyBrowser();\r\n  });\r\n  \r\n  refreshLobbiesButton.addEventListener('click', () => {\r\n    refreshLobbies();\r\n  });\r\n  \r\n  // Make Public toggle - create/remove public lobby when toggled\r\n  lobbyMakePublicCheckbox.addEventListener('change', async () => {\r\n    if (!lobbyState.isHost) return;\r\n    \r\n    lobbyState.isPublic = lobbyMakePublicCheckbox.checked;\r\n    const playerName = playerNameInput.value.trim() || 'Player';\r\n    \r\n    if (lobbyState.isPublic) {\r\n      console.log('[Lobby] Making lobby public...');\r\n      try {\r\n        await LobbyBrowserService.initialize();\r\n        await LobbyBrowserService.createPublicLobby({\r\n          roomCode: lobbyState.roomCode,\r\n          hostId: 'local',\r\n          hostName: playerName,\r\n          gameMode: gameSettings.gameMode as 'deathmatch' | 'spike',\r\n          mapId: gameSettings.mapId,\r\n          maxPlayers: lobbyState.maxPlayers,\r\n        });\r\n        console.log('[Lobby] Lobby is now public');\r\n      } catch (e) {\r\n        console.error('[Lobby] Failed to make lobby public:', e);\r\n      }\r\n    } else {\r\n      console.log('[Lobby] Making lobby private...');\r\n      try {\r\n        await LobbyBrowserService.removeLobby(lobbyState.roomCode);\r\n        console.log('[Lobby] Lobby is now private');\r\n      } catch (e) {\r\n        console.error('[Lobby] Failed to make lobby private:', e);\r\n      }\r\n    }\r\n  });\r\n  \r\n  // Update displayed values when sliders change\r\n  botCountSlider.addEventListener('input', () => {\r\n    botCountValue.textContent = botCountSlider.value;\r\n  });\r\n  \r\n  friendlyBotsSlider.addEventListener('input', () => {\r\n    friendlyBotsValue.textContent = friendlyBotsSlider.value;\r\n  });\r\n  \r\n  // Game mode selection listener - filter maps when mode changes\r\n  gameModeSelect.addEventListener('change', () => {\r\n    populateMapDropdown(gameModeSelect.value);\r\n  });\r\n  \r\n  // Map selection listener - update hint when map changes\r\n  mapSelect.addEventListener('change', updateMapHint);\r\n  \r\n  // Hero selection listener - update ability names when hero changes\r\n  heroSelect.addEventListener('change', updateAbilityNames);\r\n  \r\n  // Ability slot selection listeners - update ability names when slots change\r\n  abilityQSelect.addEventListener('change', updateAbilityNames);\r\n  abilityFSelect.addEventListener('change', updateAbilityNames);\r\n\r\n  // Pause menu listeners\r\n  resumeButton.addEventListener('click', resumeGame);\r\n  quitButton.addEventListener('click', quitToMenu);\r\n  \r\n  // Round over panel listeners\r\n  playAgainButton.addEventListener('click', playAgain);\r\n  mainMenuButton.addEventListener('click', () => {\r\n    resetIdleTimer();\r\n    clearIdleTimeout();\r\n    quitToMenu();\r\n  });\r\n  pauseCountdownButton.addEventListener('click', toggleCountdownPause);\r\n  \r\n  // Track interactions on round over panel to reset idle timer\r\n  roundOverPanel.addEventListener('mousemove', resetIdleTimer);\r\n  roundOverPanel.addEventListener('keydown', resetIdleTimer);\r\n  roundOverPanel.addEventListener('click', resetIdleTimer);\r\n  \r\n  // Room code copy button\r\n  copyCodeButton.addEventListener('click', () => {\r\n    const code = roomCodeText.textContent || '';\r\n    navigator.clipboard.writeText(code).then(() => {\r\n      copyCodeButton.textContent = 'Copied!';\r\n      copyCodeButton.classList.add('copied');\r\n      setTimeout(() => {\r\n        copyCodeButton.textContent = 'Copy';\r\n        copyCodeButton.classList.remove('copied');\r\n      }, 2000);\r\n    }).catch(() => {\r\n      // Fallback for older browsers\r\n      alert(`Room Code: ${code}`);\r\n    });\r\n  });\r\n  \r\n  // Lobby listeners\r\n  leaveLobbyButton.addEventListener('click', leaveLobby);\r\n  \r\n  startGameButton.addEventListener('click', () => {\r\n    if (lobbyState.isHost) {\r\n      startGameFromLobby();\r\n    }\r\n  });\r\n  \r\n  // Helper function to copy lobby room code\r\n  const copyLobbyCode = () => {\r\n    const code = lobbyRoomCode.textContent || '';\r\n    navigator.clipboard.writeText(code).then(() => {\r\n      // Visual feedback - just flash the color, don't change text\r\n      lobbyRoomCode.classList.add('copied');\r\n      copyLobbyCodeButton.textContent = ' Copied!';\r\n      setTimeout(() => {\r\n        lobbyRoomCode.classList.remove('copied');\r\n        copyLobbyCodeButton.textContent = ' Copy Code';\r\n      }, 1500);\r\n    }).catch(() => {\r\n      alert(`Room Code: ${code}`);\r\n    });\r\n  };\r\n\r\n  copyLobbyCodeButton.addEventListener('click', copyLobbyCode);\r\n  \r\n  // Click on room code to copy\r\n  lobbyRoomCode.addEventListener('click', copyLobbyCode);\r\n  \r\n  lobbyPlayerCountSelect.addEventListener('change', () => {\r\n    lobbyState.maxPlayers = parseInt(lobbyPlayerCountSelect.value);\r\n    updateLobbyUI();\r\n  });\r\n  \r\n  // Audio settings listeners - unified function for both panels\r\n  const setupAudioSlider = (\r\n    slider: HTMLInputElement, \r\n    enabled: HTMLInputElement, \r\n    valueDisplay: HTMLSpanElement,\r\n    settingKey: string,\r\n    isSettingsPanel: boolean = false\r\n  ) => {\r\n    slider.addEventListener('input', () => {\r\n      const value = parseInt(slider.value);\r\n      valueDisplay.textContent = `${value}%`;\r\n      \r\n      // Update audioSettings storage\r\n      (audioSettings as unknown as Record<string, number | boolean>)[settingKey] = value;\r\n      saveAudioSettings();\r\n      \r\n      // Sync to other panel\r\n      if (isSettingsPanel) {\r\n        // Sync to pause menu panel\r\n        if (settingKey === 'masterVolume') { audioMasterVolume.value = slider.value; audioMasterValue.textContent = `${value}%`; }\r\n        if (settingKey === 'musicVolume') { audioMusicVolume.value = slider.value; audioMusicValue.textContent = `${value}%`; }\r\n        if (settingKey === 'sfxVolume') { audioSfxVolume.value = slider.value; audioSfxValue.textContent = `${value}%`; }\r\n        if (settingKey === 'voiceVolume') { audioVoiceVolume.value = slider.value; audioVoiceValue.textContent = `${value}%`; }\r\n        if (settingKey === 'uiVolume') { audioUiVolume.value = slider.value; audioUiValue.textContent = `${value}%`; }\r\n      } else {\r\n        // Sync to settings panel\r\n        if (settingKey === 'masterVolume') { settingsAudioMasterVolume.value = slider.value; settingsAudioMasterValue.textContent = `${value}%`; }\r\n        if (settingKey === 'musicVolume') { settingsAudioMusicVolume.value = slider.value; settingsAudioMusicValue.textContent = `${value}%`; }\r\n        if (settingKey === 'sfxVolume') { settingsAudioSfxVolume.value = slider.value; settingsAudioSfxValue.textContent = `${value}%`; }\r\n        if (settingKey === 'voiceVolume') { settingsAudioVoiceVolume.value = slider.value; settingsAudioVoiceValue.textContent = `${value}%`; }\r\n        if (settingKey === 'uiVolume') { settingsAudioUiVolume.value = slider.value; settingsAudioUiValue.textContent = `${value}%`; }\r\n      }\r\n      \r\n      // Update game audio if running\r\n      if (game) {\r\n        game.updateAudioSettings({ [settingKey]: value });\r\n      }\r\n      \r\n      // Update standalone UI audio for menu sounds\r\n      if (settingKey === 'uiVolume' || settingKey === 'masterVolume') {\r\n        const masterVol = audioSettings.masterVolume / 100;\r\n        const uiVol = audioSettings.uiVolume / 100;\r\n        uiAudio.setVolume(masterVol * uiVol);\r\n      }\r\n    });\r\n    \r\n    enabled.addEventListener('change', () => {\r\n      const isEnabled = enabled.checked;\r\n      slider.disabled = !isEnabled;\r\n      \r\n      // Update audioSettings storage\r\n      const enabledKey = settingKey.replace('Volume', 'Enabled');\r\n      (audioSettings as unknown as Record<string, number | boolean>)[enabledKey] = isEnabled;\r\n      saveAudioSettings();\r\n      \r\n      // Sync to other panel\r\n      if (isSettingsPanel) {\r\n        if (settingKey === 'masterVolume') { audioMasterEnabled.checked = isEnabled; audioMasterVolume.disabled = !isEnabled; }\r\n        if (settingKey === 'musicVolume') { audioMusicEnabled.checked = isEnabled; audioMusicVolume.disabled = !isEnabled; }\r\n        if (settingKey === 'sfxVolume') { audioSfxEnabled.checked = isEnabled; audioSfxVolume.disabled = !isEnabled; }\r\n        if (settingKey === 'voiceVolume') { audioVoiceEnabled.checked = isEnabled; audioVoiceVolume.disabled = !isEnabled; }\r\n        if (settingKey === 'uiVolume') { audioUiEnabled.checked = isEnabled; audioUiVolume.disabled = !isEnabled; }\r\n      } else {\r\n        if (settingKey === 'masterVolume') { settingsAudioMasterEnabled.checked = isEnabled; settingsAudioMasterVolume.disabled = !isEnabled; }\r\n        if (settingKey === 'musicVolume') { settingsAudioMusicEnabled.checked = isEnabled; settingsAudioMusicVolume.disabled = !isEnabled; }\r\n        if (settingKey === 'sfxVolume') { settingsAudioSfxEnabled.checked = isEnabled; settingsAudioSfxVolume.disabled = !isEnabled; }\r\n        if (settingKey === 'voiceVolume') { settingsAudioVoiceEnabled.checked = isEnabled; settingsAudioVoiceVolume.disabled = !isEnabled; }\r\n        if (settingKey === 'uiVolume') { settingsAudioUiEnabled.checked = isEnabled; settingsAudioUiVolume.disabled = !isEnabled; }\r\n      }\r\n      \r\n      // Update game audio if running\r\n      if (game) {\r\n        game.updateAudioSettings({ [enabledKey]: isEnabled });\r\n      }\r\n      \r\n      // Update standalone UI audio for menu sounds\r\n      if (settingKey === 'uiVolume' || settingKey === 'masterVolume') {\r\n        uiAudio.setEnabled(audioSettings.masterEnabled && audioSettings.uiEnabled);\r\n      }\r\n    });\r\n  };\r\n  \r\n  // Setup pause menu audio sliders\r\n  setupAudioSlider(audioMasterVolume, audioMasterEnabled, audioMasterValue, 'masterVolume');\r\n  setupAudioSlider(audioMusicVolume, audioMusicEnabled, audioMusicValue, 'musicVolume');\r\n  setupAudioSlider(audioSfxVolume, audioSfxEnabled, audioSfxValue, 'sfxVolume');\r\n  setupAudioSlider(audioVoiceVolume, audioVoiceEnabled, audioVoiceValue, 'voiceVolume');\r\n  setupAudioSlider(audioUiVolume, audioUiEnabled, audioUiValue, 'uiVolume');\r\n  \r\n  // Setup settings panel audio sliders\r\n  setupAudioSlider(settingsAudioMasterVolume, settingsAudioMasterEnabled, settingsAudioMasterValue, 'masterVolume', true);\r\n  setupAudioSlider(settingsAudioMusicVolume, settingsAudioMusicEnabled, settingsAudioMusicValue, 'musicVolume', true);\r\n  setupAudioSlider(settingsAudioSfxVolume, settingsAudioSfxEnabled, settingsAudioSfxValue, 'sfxVolume', true);\r\n  setupAudioSlider(settingsAudioVoiceVolume, settingsAudioVoiceEnabled, settingsAudioVoiceValue, 'voiceVolume', true);\r\n  setupAudioSlider(settingsAudioUiVolume, settingsAudioUiEnabled, settingsAudioUiValue, 'uiVolume', true);\r\n  \r\n  // Other pause menu slider listeners\r\n  sensitivitySlider.addEventListener('input', () => {\r\n    sensitivityValue.textContent = (parseFloat(sensitivitySlider.value) / 10).toFixed(1);\r\n  });\r\n  \r\n  fpsCheckbox.addEventListener('change', () => {\r\n    // Update the game's debug/FPS display immediately\r\n    if (game) {\r\n      game.setShowFPS(fpsCheckbox.checked);\r\n    }\r\n  });\r\n\r\n  // Load gameplay settings\r\n  loadGameplaySettings();\r\n  \r\n  // Load audio settings\r\n  loadAudioSettings();\r\n\r\n  // Keyboard shortcuts\r\n  window.addEventListener('keydown', (e) => {\r\n    if (e.code === 'Escape') {\r\n      // Close settings panel if open (main menu)\r\n      if (!settingsPanel.classList.contains('hidden')) {\r\n        settingsPanel.classList.add('hidden');\r\n        return;\r\n      }\r\n      \r\n      // Close buy menu if open\r\n      if (!buyMenu.classList.contains('hidden')) {\r\n        closeBuyMenu();\r\n        return;\r\n      }\r\n      \r\n      // In-game pause toggle\r\n      if (game) {\r\n        if (!pauseMenu.classList.contains('hidden')) {\r\n          // Resume game\r\n          resumeGame();\r\n        } else {\r\n          // Pause game\r\n          pauseGame();\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Buy menu toggle (B key)\r\n    if (e.code === 'KeyB' && game && !pauseMenu.classList.contains('hidden') === false) {\r\n      if (!buyMenu.classList.contains('hidden')) {\r\n        closeBuyMenu();\r\n      } else if (pauseMenu.classList.contains('hidden')) {\r\n        openBuyMenu();\r\n      }\r\n    }\r\n    \r\n    // Help panel toggle (H key) - shows hero info card\r\n    if (e.code === 'KeyH' && game && pauseMenu.classList.contains('hidden') && buyMenu.classList.contains('hidden')) {\r\n      game.showHeroInfo();\r\n    }\r\n    \r\n    // Countdown pause toggle (P key) - between rounds\r\n    if (e.code === 'KeyP' && game) {\r\n      game.toggleCountdownPause();\r\n    }\r\n  });\r\n\r\n  // Tab focus/blur detection for multiplayer pause sync\r\n  document.addEventListener('visibilitychange', () => {\r\n    if (!game || !gameStarted) return;\r\n    \r\n    if (document.hidden) {\r\n      // Tab is hidden (user switched tabs or minimized)\r\n      game.onTabBlur();\r\n    } else {\r\n      // Tab is visible again\r\n      game.onTabFocus();\r\n    }\r\n  });\r\n\r\n  // Also handle window blur/focus for alt-tabbing within same browser\r\n  window.addEventListener('blur', () => {\r\n    if (!game || !gameStarted) return;\r\n    game.onTabBlur();\r\n  });\r\n\r\n  window.addEventListener('focus', () => {\r\n    if (!game || !gameStarted) return;\r\n    game.onTabFocus();\r\n  });\r\n\r\n  // Save play time when page is about to unload (closing tab, navigating away, etc.)\r\n  // Using both beforeunload and pagehide for maximum browser coverage\r\n  const handlePageUnload = () => {\r\n    if (game) {\r\n      // Use synchronous localStorage save - async Firebase won't complete during unload\r\n      // The saved data will be recovered and synced on next session start\r\n      try {\r\n        game.saveStatsOnUnload();\r\n      } catch (e) {\r\n        console.warn('[Main] Failed to save stats on unload:', e);\r\n      }\r\n    }\r\n  };\r\n\r\n  window.addEventListener('beforeunload', handlePageUnload);\r\n  window.addEventListener('pagehide', handlePageUnload);\r\n  \r\n  // Buy menu weapon click handlers\r\n  weaponItems.forEach(item => {\r\n    item.addEventListener('click', () => {\r\n      const weaponId = item.dataset.weapon;\r\n      if (weaponId && game) {\r\n        tryBuyWeapon(weaponId);\r\n      }\r\n    });\r\n  });\r\n\r\n  // Add UI sounds to all buttons\r\n  const addButtonSounds = () => {\r\n    const buttons = document.querySelectorAll('button, .btn, .lobby-player-count-option, .weapon-item');\r\n    buttons.forEach(button => {\r\n      button.addEventListener('mouseenter', () => uiAudio.playHover());\r\n      button.addEventListener('mousedown', () => uiAudio.playClick());\r\n    });\r\n  };\r\n  addButtonSounds();\r\n\r\n  console.log('[Main] CyberGrid Assault initialized');\r\n  console.log('[Main] Press HOST to start a local game');\r\n}\r\n\r\nasync function handleHost(): Promise<void> {\r\n  const playerName = playerNameInput.value.trim() || 'Player';\r\n  \r\n  if (!playerName) {\r\n    alert('Please enter your callsign');\r\n    return;\r\n  }\r\n  \r\n  // Track game start in analytics\r\n  AnalyticsService.trackGameStart('host', playerName);\r\n  \r\n  // Generate room code\r\n  const roomCode = generateRoomCode();\r\n  \r\n  // For single player (1 player setting), go directly to lobby without networking\r\n  const requiredPlayers = parseInt(lobbyPlayerCountSelect.value);\r\n  if (requiredPlayers === 1) {\r\n    showLobby(true, roomCode, playerName);\r\n    return;\r\n  }\r\n  \r\n  // For multiplayer, connect to Firebase and create room in lobby\r\n  connectionUI.classList.add('hidden');\r\n  \r\n  try {\r\n    // Create network manager for lobby\r\n    lobbyNetwork = new NetworkManager({ isHost: true, useFirestore: true });\r\n    await lobbyNetwork.connectWithFirebase(FIREBASE_CONFIG);\r\n    \r\n    // Set up listeners for peers joining\r\n    lobbyNetwork.on('peerConnected', ({ peerId }) => {\r\n      console.log(`[Lobby] Peer connected (WebRTC ready): ${peerId}`);\r\n      // Add player to lobby with placeholder name (will be updated via PlayerJoin packet)\r\n      lobbyState.players.push({\r\n        id: peerId,\r\n        name: `Connecting...`,\r\n        isHost: false,\r\n      });\r\n      updateLobbyUI();\r\n    });\r\n    \r\n    lobbyNetwork.on('peerDisconnected', ({ peerId }) => {\r\n      console.log(`[Lobby Host] Peer disconnected: ${peerId}`);\r\n      console.log(`[Lobby Host] Players BEFORE filter:`, JSON.stringify(lobbyState.players));\r\n      lobbyState.players = lobbyState.players.filter(p => p.id !== peerId);\r\n      console.log(`[Lobby Host] Players AFTER filter:`, JSON.stringify(lobbyState.players));\r\n      updateLobbyUI();\r\n    });\r\n    \r\n    // Listen for packets - handle PlayerJoin to get real names\r\n    lobbyNetwork.on('packet', ({ peerId, packet }) => {\r\n      console.log(`[Lobby Host] Received packet from ${peerId}:`, packet.type);\r\n      \r\n      // Handle PlayerJoin packet to get real player name\r\n      if (packet.type === PacketType.PlayerJoin) {\r\n        const data = packet.data as { name: string };\r\n        console.log(`[Lobby Host] Player ${peerId} name: ${data.name}`);\r\n        \r\n        // Update player name in lobby\r\n        const player = lobbyState.players.find(p => p.id === peerId);\r\n        if (player) {\r\n          player.name = data.name;\r\n          updateLobbyUI();\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Create room in Firebase\r\n    await lobbyNetwork.createRoom();\r\n    const actualRoomCode = lobbyNetwork.getRoomCode();\r\n    \r\n    console.log(`[Main] Room created in Firebase: ${actualRoomCode}`);\r\n    \r\n    // Show lobby with the Firebase room code\r\n    showLobby(true, actualRoomCode, playerName);\r\n    \r\n  } catch (e) {\r\n    console.error('[Main] Failed to create room:', e);\r\n    alert('Failed to create game room. Check console for details.');\r\n    connectionUI.classList.remove('hidden');\r\n    lobbyNetwork = null;\r\n  }\r\n}\r\n\r\nfunction handleJoinClick(): void {\r\n  // Show room code input and join buttons (connect + back)\r\n  hostButton.classList.add('hidden');\r\n  joinButton.classList.add('hidden');\r\n  roomCodeInput.classList.remove('hidden');\r\n  joinButtons.classList.remove('hidden');\r\n  roomCodeInput.focus();\r\n}\r\n\r\nfunction handleBack(): void {\r\n  // Go back to main menu options\r\n  roomCodeInput.classList.add('hidden');\r\n  joinButtons.classList.add('hidden');\r\n  roomCodeInput.value = '';\r\n  hostButton.classList.remove('hidden');\r\n  joinButton.classList.remove('hidden');\r\n}\r\n\r\nasync function handleConnect(): Promise<void> {\r\n  const roomCode = roomCodeInput.value.trim().toUpperCase();\r\n  if (!roomCode) {\r\n    alert('Please enter a room code');\r\n    return;\r\n  }\r\n\r\n  const playerName = playerNameInput.value.trim() || 'Player';\r\n  \r\n  if (!playerName) {\r\n    alert('Please enter your callsign');\r\n    return;\r\n  }\r\n\r\n  // Track game start in analytics\r\n  AnalyticsService.trackGameStart('join', playerName);\r\n\r\n  // Hide connection UI\r\n  connectionUI.classList.add('hidden');\r\n  roomCodeInput.classList.add('hidden');\r\n  joinButtons.classList.add('hidden');\r\n  \r\n  try {\r\n    // Create network manager for lobby\r\n    lobbyNetwork = new NetworkManager({ isHost: false, useFirestore: true });\r\n    await lobbyNetwork.connectWithFirebase(FIREBASE_CONFIG);\r\n    \r\n    // Set up listeners for peers\r\n    lobbyNetwork.on('peerConnected', ({ peerId }) => {\r\n      console.log(`[Lobby Joiner] Peer connected: ${peerId}`);\r\n      // This is the host connecting to us\r\n      lobbyState.players.push({\r\n        id: peerId,\r\n        name: `Host`,\r\n        isHost: true,\r\n      });\r\n      updateLobbyUI();\r\n      \r\n      // Send our name to the host\r\n      console.log(`[Lobby Joiner] Sending our name to host: ${playerName}`);\r\n      lobbyNetwork?.broadcast({\r\n        type: PacketType.PlayerJoin,\r\n        timestamp: Date.now(),\r\n        senderId: lobbyNetwork.getLocalPeerId(),\r\n        data: { name: playerName },\r\n      });\r\n    });\r\n    \r\n    lobbyNetwork.on('peerDisconnected', ({ peerId }) => {\r\n      console.log(`[Lobby] Peer disconnected: ${peerId}`);\r\n      lobbyState.players = lobbyState.players.filter(p => p.id !== peerId);\r\n      updateLobbyUI();\r\n    });\r\n    \r\n    // Listen for GameStart packet from host\r\n    lobbyNetwork.on('packet', ({ peerId, packet }) => {\r\n      console.log(`[Lobby Joiner] Received packet from ${peerId}:`, packet.type);\r\n      if (packet.type === PacketType.GameStart) {\r\n        console.log(`[Lobby] Host started the game!`);\r\n        // Host started the game - apply host's settings and start\r\n        const data = packet.data as { \r\n          roomCode: string; \r\n          totalRounds: number;\r\n          mapId?: string;\r\n          gameMode?: string;\r\n        };\r\n        if (data.totalRounds) {\r\n          gameSettings.totalRounds = data.totalRounds;\r\n        }\r\n        if (data.mapId) {\r\n          gameSettings.mapId = data.mapId;\r\n          console.log(`[Lobby Joiner] Using host's map: ${data.mapId}`);\r\n        }\r\n        if (data.gameMode) {\r\n          gameSettings.gameMode = data.gameMode as 'deathmatch' | 'spike';\r\n          console.log(`[Lobby Joiner] Using host's game mode: ${data.gameMode}`);\r\n        }\r\n        startGameFromLobby();\r\n      }\r\n    });\r\n    \r\n    // Join the room in Firebase\r\n    await lobbyNetwork.joinRoom(roomCode);\r\n    \r\n    console.log(`[Main] Joined room in Firebase: ${roomCode}`);\r\n    \r\n    // Show lobby as non-host\r\n    showLobby(false, roomCode, playerName);\r\n    \r\n  } catch (e) {\r\n    console.error('[Main] Failed to join room:', e);\r\n    alert('Failed to join game. Make sure the room code is correct and the host is online.');\r\n    \r\n    // Show connection UI again\r\n    connectionUI.classList.remove('hidden');\r\n    hostButton.classList.remove('hidden');\r\n    joinButton.classList.remove('hidden');\r\n    lobbyNetwork = null;\r\n  }\r\n}\r\n\r\n// Weapon slot tooltip system\r\nconst weaponTooltip = document.getElementById('weapon-tooltip') as HTMLDivElement;\r\nconst weaponNames: Record<number, string> = {\r\n  1: 'Burst Pistol',\r\n  2: 'Neo SMG-9',\r\n  3: 'Pulse Rifle',\r\n  4: 'Scatter Shot',\r\n  5: 'Rail Sniper',\r\n  6: 'Shard Launcher',\r\n  7: 'Nano Repeater',\r\n  8: 'Arc Welder',\r\n  9: 'Phase Repeater',\r\n  10: 'Plasma Cannon'\r\n};\r\n\r\n// Show weapon name on key press\r\ndocument.addEventListener('keydown', (e) => {\r\n  if (!game || !game.isRunning()) return;\r\n  \r\n  // Map key to slot number\r\n  let slotNumber = 0;\r\n  if (e.code === 'Digit1') slotNumber = 1;\r\n  else if (e.code === 'Digit2') slotNumber = 2;\r\n  else if (e.code === 'Digit3') slotNumber = 3;\r\n  else if (e.code === 'Digit4') slotNumber = 4;\r\n  else if (e.code === 'Digit5') slotNumber = 5;\r\n  else if (e.code === 'Digit6') slotNumber = 6;\r\n  else if (e.code === 'Digit7') slotNumber = 7;\r\n  else if (e.code === 'Digit8') slotNumber = 8;\r\n  else if (e.code === 'Digit9') slotNumber = 9;\r\n  else if (e.code === 'Digit0') slotNumber = 10;\r\n  \r\n  if (slotNumber > 0) {\r\n    const weaponName = weaponNames[slotNumber];\r\n    if (weaponName) {\r\n      weaponTooltip.textContent = weaponName;\r\n      weaponTooltip.classList.add('visible');\r\n      \r\n      // Hide after 1.5 seconds\r\n      setTimeout(() => {\r\n        weaponTooltip.classList.remove('visible');\r\n      }, 1500);\r\n    }\r\n  }\r\n});\r\n\r\n// Start\r\ninit().catch(console.error);\r\n"],"file":"assets/index-CSN0XLTV.js"}