const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index.esm-OOYOW6k3.js","./index.esm-Dm3ezxcN.js","./index.esm-DbUeHnob.js"])))=>i.map(i=>d[i]);
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();const ss="modulepreload",os=function(l,e){return new URL(l,e).href},Ei={},Se=function(e,t,i){let o=Promise.resolve();if(t&&t.length>0){const n=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),r=a?.nonce||a?.getAttribute("nonce");o=Promise.allSettled(t.map(c=>{if(c=os(c,i),c in Ei)return;Ei[c]=!0;const d=c.endsWith(".css"),h=d?'[rel="stylesheet"]':"";if(!!i)for(let p=n.length-1;p>=0;p--){const w=n[p];if(w.href===c&&(!d||w.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${h}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":ss,d||(u.as="script"),u.crossOrigin="",u.href=c,r&&u.setAttribute("nonce",r),document.head.appendChild(u),d)return new Promise((p,w)=>{u.addEventListener("load",p),u.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return o.then(n=>{for(const a of n||[])a.status==="rejected"&&s(a.reason);return e().catch(s)})};class ns{running=!1;lastTime=0;accumulator=0;frameId=0;fixedDeltaTime;maxFrameTime;onUpdate;onRender;fps=0;frameCount=0;fpsTimer=0;tickCount=0;tps=0;constructor(e,t,i){this.fixedDeltaTime=1e3/e,this.maxFrameTime=this.fixedDeltaTime*5,this.onUpdate=t,this.onRender=i}start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.accumulator=0,this.frameCount=0,this.tickCount=0,this.fpsTimer=this.lastTime,this.loop())}stop(){this.running=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0)}loop=()=>{if(!this.running)return;const e=performance.now();let t=e-this.lastTime;for(this.lastTime=e,t>this.maxFrameTime&&(t=this.maxFrameTime),this.accumulator+=t;this.accumulator>=this.fixedDeltaTime;)this.onUpdate(this.fixedDeltaTime,e),this.accumulator-=this.fixedDeltaTime,this.tickCount++;const i=this.accumulator/this.fixedDeltaTime;this.onRender(i),this.frameCount++,e-this.fpsTimer>=1e3&&(this.fps=this.frameCount,this.tps=this.tickCount,this.frameCount=0,this.tickCount=0,this.fpsTimer=e),this.frameId=requestAnimationFrame(this.loop)};getFPS(){return this.fps}getTPS(){return this.tps}isRunning(){return this.running}getFixedDeltaTime(){return this.fixedDeltaTime}}const as=[{action:"reload",key:"KeyR",type:"press"},{action:"interact",key:"KeyE",type:"hold"},{action:"throwGrenade",key:"KeyG",type:"press"},{action:"useBombCall",key:"KeyV",type:"press"},{action:"useMissileStrike",key:"KeyJ",type:"press"},{action:"ability1",key:"KeyQ",type:"press"},{action:"ability2",key:"KeyF",type:"press"},{action:"ultimate",key:"KeyX",type:"press"},{action:"menu",key:"Escape",type:"press"},{action:"scoreboard",key:"Tab",type:"hold"},{action:"buyMenu",key:"KeyB",type:"press"}];class rs{canvas;keysDown=new Set;keysPressed=new Set;mouseDown=new Set;mousePressed=new Set;mousePosition={x:0,y:0};mouseWorldPosition={x:0,y:0};mouseWheelDelta=0;currentState;previousState;cameraOffset={x:0,y:0};cameraZoom=1;bindings;sequence=0;constructor(e){this.canvas=e,this.bindings=[...as],this.currentState=this.createEmptyState(),this.previousState=this.createEmptyState(),this.setupListeners()}createEmptyState(){return{moveX:0,moveY:0,aimX:0,aimY:0,shoot:!1,reload:!1,interact:!1,throwGrenade:!1,useBombCall:!1,useMissileStrike:!1,ability1:!1,ability2:!1,ultimate:!1,weaponSlot:0,menu:!1,scoreboard:!1,buyMenu:!1}}setupListeners(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.canvas.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("mousemove",this.onMouseMove),this.canvas.addEventListener("wheel",this.onMouseWheel,{passive:!1}),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("keydown",e=>{e.code==="Tab"&&e.preventDefault()})}onKeyDown=e=>{this.keysDown.has(e.code)||this.keysPressed.add(e.code),this.keysDown.add(e.code)};onKeyUp=e=>{this.keysDown.delete(e.code)};onMouseDown=e=>{this.mouseDown.has(e.button)||this.mousePressed.add(e.button),this.mouseDown.add(e.button)};onMouseUp=e=>{this.mouseDown.delete(e.button)};onMouseWheel=e=>{e.preventDefault(),this.mouseWheelDelta=e.deltaY};onMouseMove=e=>{const t=this.canvas.getBoundingClientRect();this.mousePosition={x:e.clientX-t.left,y:e.clientY-t.top},this.mouseWorldPosition={x:this.mousePosition.x/this.cameraZoom+this.cameraOffset.x,y:this.mousePosition.y/this.cameraZoom+this.cameraOffset.y}};update(){this.previousState={...this.currentState},this.currentState=this.createEmptyState(),(this.keysDown.has("KeyW")||this.keysDown.has("ArrowUp"))&&(this.currentState.moveY-=1),(this.keysDown.has("KeyS")||this.keysDown.has("ArrowDown"))&&(this.currentState.moveY+=1),(this.keysDown.has("KeyA")||this.keysDown.has("ArrowLeft"))&&(this.currentState.moveX-=1),(this.keysDown.has("KeyD")||this.keysDown.has("ArrowRight"))&&(this.currentState.moveX+=1);const e=Math.sqrt(this.currentState.moveX*this.currentState.moveX+this.currentState.moveY*this.currentState.moveY);e>1&&(this.currentState.moveX/=e,this.currentState.moveY/=e),this.currentState.aimX=this.mouseWorldPosition.x,this.currentState.aimY=this.mouseWorldPosition.y,this.currentState.shoot=this.mouseDown.has(0),this.mousePressed.has(2)&&(this.currentState.reload=!0);for(const t of this.bindings)t.type==="press"?this.keysPressed.has(t.key)&&(this.currentState[t.action]=!0):this.keysDown.has(t.key)&&(this.currentState[t.action]=!0);this.keysPressed.has("Digit1")?this.currentState.weaponSlot=1:this.keysPressed.has("Digit2")?this.currentState.weaponSlot=2:this.keysPressed.has("Digit3")?this.currentState.weaponSlot=3:this.keysPressed.has("Digit4")?this.currentState.weaponSlot=4:this.keysPressed.has("Digit5")?this.currentState.weaponSlot=5:this.keysPressed.has("Digit6")?this.currentState.weaponSlot=6:this.keysPressed.has("Digit7")?this.currentState.weaponSlot=7:this.keysPressed.has("Digit8")?this.currentState.weaponSlot=8:this.keysPressed.has("Digit9")?this.currentState.weaponSlot=9:this.keysPressed.has("Digit0")?this.currentState.weaponSlot=10:this.mouseWheelDelta!==0&&(this.currentState.weaponSlot=this.mouseWheelDelta>0?-1:-2,this.mouseWheelDelta=0),this.keysPressed.clear(),this.mousePressed.clear()}getState(){return{...this.currentState}}wasPressed(e){return this.currentState[e]===!0&&this.previousState[e]===!1}wasReleased(e){return this.currentState[e]===!1&&this.previousState[e]===!0}isDown(e){return this.currentState[e]===!0}getMousePosition(){return{...this.mousePosition}}getMouseWorldPosition(){return{...this.mouseWorldPosition}}updateCamera(e,t){this.cameraOffset=e,this.cameraZoom=t,this.mouseWorldPosition={x:this.mousePosition.x/this.cameraZoom+this.cameraOffset.x,y:this.mousePosition.y/this.cameraZoom+this.cameraOffset.y}}getNextSequence(){return++this.sequence}setBindings(e){this.bindings=e}resetAllInputs(){this.keysDown.clear(),this.keysPressed.clear(),this.mouseDown.clear(),this.mousePressed.clear(),this.mouseWheelDelta=0,this.currentState=this.createEmptyState(),this.previousState=this.createEmptyState()}destroy(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),this.canvas.removeEventListener("mousedown",this.onMouseDown),this.canvas.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("mousemove",this.onMouseMove)}}var M=(l=>(l.Spectre="spectre",l.Byte="byte",l.Vanta="vanta",l.Katana="katana",l.Glyph="glyph",l.Spark="spark",l.Zero="zero",l.Mira="mira",l.Phantom="katana",l.Titan="vanta",l.Medic="mira",l.Havoc="spark",l.Cipher="byte",l.Venom="glyph",l.Aegis="zero",l))(M||{}),g=(l=>(l[l.None=0]="None",l[l.Attackers=1]="Attackers",l[l.Defenders=2]="Defenders",l))(g||{}),P=(l=>(l.BurstPistol="burst_pistol",l.NeoSMG9="neo_smg9",l.PulseRifle="pulse_rifle",l.ScatterShot="scatter_shot",l.RailSniper="rail_sniper",l.ShardLauncher="shard_launcher",l.NanoRepeater="nano_repeater",l.ArcWelder="arc_welder",l.PhaseRepeater="phase_repeater",l.PlasmaCannon="plasma_cannon",l))(P||{}),A=(l=>(l.Lobby="lobby",l.HeroSelect="hero_select",l.BuyPhase="buy_phase",l.RoundActive="round_active",l.RoundEnd="round_end",l.MatchEnd="match_end",l))(A||{}),Q=(l=>(l.DataSpikeAssault="data_spike",l.ReactorEscort="reactor_escort",l.NeonDeathmatch="deathmatch",l))(Q||{}),_=(l=>(l[l.Handshake=0]="Handshake",l[l.HandshakeAck=1]="HandshakeAck",l[l.Disconnect=2]="Disconnect",l[l.Ping=3]="Ping",l[l.Pong=4]="Pong",l[l.LobbyState=10]="LobbyState",l[l.PlayerJoin=11]="PlayerJoin",l[l.PlayerLeave=12]="PlayerLeave",l[l.PlayerReady=13]="PlayerReady",l[l.TeamChange=14]="TeamChange",l[l.HeroSelect=15]="HeroSelect",l[l.GameStart=16]="GameStart",l[l.Input=20]="Input",l[l.StateSnapshot=21]="StateSnapshot",l[l.StateDelta=22]="StateDelta",l[l.Event=23]="Event",l[l.PlayerDamage=30]="PlayerDamage",l[l.PlayerKill=31]="PlayerKill",l[l.AbilityUse=32]="AbilityUse",l[l.WeaponFire=33]="WeaponFire",l[l.Reload=34]="Reload",l[l.SpikePlant=35]="SpikePlant",l[l.SpikeDefuse=36]="SpikeDefuse",l[l.RoundEnd=37]="RoundEnd",l[l.CountdownPause=40]="CountdownPause",l[l.CountdownResume=41]="CountdownResume",l[l.GamePause=50]="GamePause",l[l.GameResume=51]="GameResume",l))(_||{}),G=(l=>(l.PlayerDamage="player_damage",l.PlayerKill="player_kill",l.PlayerRespawn="player_respawn",l.AbilityUsed="ability_used",l.WeaponFired="weapon_fired",l.SpikePlanted="spike_planted",l.SpikeDefused="spike_defused",l.RoundStarted="round_started",l.RoundEnded="round_ended",l))(G||{});const Ut={canvasWidth:1280,canvasHeight:720,tickRate:20},y={CYAN:"#0CE5F0",MAGENTA:"#F02BFF",YELLOW:"#FFE500",BACKGROUND:"#0a0a12",ATTACKER:"#FF4444",DEFENDER:"#44AAFF",HEALTH:"#44FF44",SHIELD:"#44AAFF",TEXT_PRIMARY:"#FFFFFF"},Pe={[P.BurstPistol]:{id:P.BurstPistol,name:"Burst Pistol",price:0,damage:25,spread:.02,fireRate:4,range:800,ammoCapacity:15,reloadTime:1500,burstCount:3,burstDelay:60,projectileSpeed:0,headshotMultiplier:1.5},[P.NeoSMG9]:{id:P.NeoSMG9,name:"Neo SMG-9",price:1100,damage:18,spread:.06,fireRate:12,range:600,ammoCapacity:30,reloadTime:1800,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:1.3},[P.PulseRifle]:{id:P.PulseRifle,name:"Pulse Rifle",price:1500,damage:35,spread:.03,fireRate:6,range:1e3,ammoCapacity:25,reloadTime:2e3,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:2},[P.ScatterShot]:{id:P.ScatterShot,name:"Scatter Shot",price:1400,damage:15,spread:.15,fireRate:1.2,range:300,ammoCapacity:6,reloadTime:2500,burstCount:8,burstDelay:0,projectileSpeed:0,headshotMultiplier:1.5},[P.RailSniper]:{id:P.RailSniper,name:"Rail Sniper",price:2100,damage:120,spread:.005,fireRate:.8,range:2e3,ammoCapacity:5,reloadTime:3e3,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:2.5},[P.ShardLauncher]:{id:P.ShardLauncher,name:"Shard Launcher",price:600,damage:40,spread:.01,fireRate:3,range:900,ammoCapacity:12,reloadTime:1800,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:1.8},[P.NanoRepeater]:{id:P.NanoRepeater,name:"Nano Repeater",price:900,damage:22,spread:.05,fireRate:10,range:750,ammoCapacity:35,reloadTime:2200,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:1.4},[P.ArcWelder]:{id:P.ArcWelder,name:"Arc Welder",price:1300,damage:20,spread:0,fireRate:15,range:400,ammoCapacity:100,reloadTime:2500,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:1.2},[P.PhaseRepeater]:{id:P.PhaseRepeater,name:"Phase Repeater",price:1800,damage:28,spread:.025,fireRate:7,range:1200,ammoCapacity:28,reloadTime:2300,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:1.6},[P.PlasmaCannon]:{id:P.PlasmaCannon,name:"Plasma Cannon",price:2800,damage:80,spread:.01,fireRate:1.5,range:800,ammoCapacity:8,reloadTime:3500,burstCount:1,burstDelay:0,projectileSpeed:600,headshotMultiplier:1}},ee={[M.Spectre]:{id:M.Spectre,name:"Spectre",faction:"Vanta Syndicate",role:"Flanker / Scout",health:100,shield:0,speed:1,abilities:[{name:"Ghost Protocol",description:"10% damage reduction",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Cloak",description:"Invisible for 2s",cooldown:1e4,duration:2e3,charges:1,chargeTime:1e4,isUltimate:!1,ultimateCost:0},{name:"Reveal Pulse",description:"Reveal enemies nearby 3s",cooldown:14e3,duration:3e3,charges:1,chargeTime:14e3,isUltimate:!1,ultimateCost:0},{name:"Shadow Dive",description:"Teleport behind enemy + 75 dmg",cooldown:5e4,duration:0,charges:1,chargeTime:5e4,isUltimate:!0,ultimateCost:6}]},[M.Byte]:{id:M.Byte,name:"Byte",faction:"Collapse Unit",role:"Control Specialist",health:100,shield:25,speed:.95,abilities:[{name:"Quick Recovery",description:"+25% shield regen speed",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"EMP Pulse",description:"AOE stun + slow 1.5s",cooldown:12e3,duration:1500,charges:1,chargeTime:12e3,isUltimate:!1,ultimateCost:0},{name:"Shock Trap",description:"Slowing zone 5s",cooldown:15e3,duration:5e3,charges:1,chargeTime:15e3,isUltimate:!1,ultimateCost:0},{name:"System Crash",description:"Large AOE stun + slow",cooldown:6e4,duration:3e3,charges:1,chargeTime:6e4,isUltimate:!0,ultimateCost:7}]},[M.Vanta]:{id:M.Vanta,name:"Vanta",faction:"HelixCorp",role:"Tank / Frontline",health:120,shield:50,speed:.85,abilities:[{name:"Titan Armor",description:"+50 shield, 15% damage reduction",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Energy Shield",description:"Front barrier 3s, blocks bullets",cooldown:1e4,duration:3e3,charges:1,chargeTime:1e4,isUltimate:!1,ultimateCost:0},{name:"Shockwave Slam",description:"AOE stun + 30 dmg",cooldown:14e3,duration:1e3,charges:1,chargeTime:14e3,isUltimate:!1,ultimateCost:0},{name:"Overclock",description:"40% DR + fire rate 5s",cooldown:55e3,duration:4e3,charges:1,chargeTime:55e3,isUltimate:!0,ultimateCost:6}]},[M.Katana]:{id:M.Katana,name:"Katana",faction:"ArcLight Initiative",role:"Burst Assassin",health:90,shield:0,speed:1.15,abilities:[{name:"Swift Strike",description:"+15% speed, +10% damage",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Blink",description:"Teleport 3 tiles forward",cooldown:8e3,duration:200,charges:2,chargeTime:8e3,isUltimate:!1,ultimateCost:0},{name:"Invisibility",description:"Cloak for 4 seconds",cooldown:12e3,duration:4e3,charges:1,chargeTime:12e3,isUltimate:!1,ultimateCost:0},{name:"Shadow Strike",description:"Teleport behind enemy + 75 dmg",cooldown:5e4,duration:0,charges:1,chargeTime:5e4,isUltimate:!0,ultimateCost:6}]},[M.Glyph]:{id:M.Glyph,name:"Glyph",faction:"ArcLight Initiative",role:"Vision / Utility",health:100,shield:25,speed:1,abilities:[{name:"Keen Eyes",description:"+10% damage (precision)",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Poison Cloud",description:"DOT zone 15dmg/tick 4s",cooldown:1e4,duration:4e3,charges:1,chargeTime:1e4,isUltimate:!1,ultimateCost:0},{name:"Turret Deploy",description:"Auto-attack turret 10s",cooldown:14e3,duration:1e4,charges:1,chargeTime:14e3,isUltimate:!1,ultimateCost:0},{name:"Toxic Storm",description:"Massive poison zone 5s",cooldown:55e3,duration:5e3,charges:1,chargeTime:55e3,isUltimate:!0,ultimateCost:7}]},[M.Spark]:{id:M.Spark,name:"Spark",faction:"HelixCorp",role:"Area Denial",health:100,shield:25,speed:.95,abilities:[{name:"Fireproof",description:"Fire immune, +10% fire rate",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Fire Bottle",description:"Burning zone 15dmg/tick",cooldown:12e3,duration:4e3,charges:2,chargeTime:12e3,isUltimate:!1,ultimateCost:0},{name:"Minigun Mode",description:"+50% fire rate 4s",cooldown:15e3,duration:4e3,charges:1,chargeTime:15e3,isUltimate:!1,ultimateCost:0},{name:"Napalm Strike",description:"Huge fire zone 6s",cooldown:55e3,duration:6e3,charges:1,chargeTime:55e3,isUltimate:!0,ultimateCost:7}]},[M.Zero]:{id:M.Zero,name:"Zero",faction:"Collapse Unit",role:"Sniper / Scout",health:90,shield:0,speed:1,abilities:[{name:"Steady Aim",description:"+15% damage (sniper)",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Mark Target",description:"Reveal + 20% bonus dmg 5s",cooldown:8e3,duration:5e3,charges:1,chargeTime:8e3,isUltimate:!1,ultimateCost:0},{name:"Dash Back",description:"Quick backward escape",cooldown:12e3,duration:200,charges:1,chargeTime:12e3,isUltimate:!1,ultimateCost:0},{name:"Dome Shield",description:"Team protection dome 3s",cooldown:6e4,duration:3e3,charges:1,chargeTime:6e4,isUltimate:!0,ultimateCost:8}]},[M.Mira]:{id:M.Mira,name:"Mira",faction:"Independent",role:"Medic / Support",health:100,shield:25,speed:1,abilities:[{name:"Combat Medic",description:"+25% healing received/given",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Heal Field",description:"Healing zone 10HP/tick 4s",cooldown:1e4,duration:4e3,charges:1,chargeTime:1e4,isUltimate:!1,ultimateCost:0},{name:"Shield Burst",description:"+30 shields to allies",cooldown:14e3,duration:3e3,charges:1,chargeTime:14e3,isUltimate:!1,ultimateCost:0},{name:"Resync",description:"Revive ally at 50% HP",cooldown:6e4,duration:0,charges:1,chargeTime:6e4,isUltimate:!0,ultimateCost:8}]}},dt={SIGNALING_SERVER:"ws://localhost:8080",TICK_RATE:20,SNAPSHOT_RATE:10,INPUT_RATE:20,PING_INTERVAL:1e3,TIMEOUT_MS:1e4,INPUT_BUFFER_SIZE:64,SNAPSHOT_BUFFER_SIZE:32,INTERPOLATION_DELAY:100},U={ROUND_TIME:18e4,MAX_ROUNDS:13,SPIKE_PLANT_TIME:3e3,SPIKE_DEFUSE_TIME:5e3,SPIKE_UPLOAD_TIME:45e3,STARTING_CREDITS:800,KILL_REWARD:300,HEADSHOT_ZONE_RATIO:.3,BASE_SPEED:200};class ls{canvas;ctx;cameraX=0;cameraY=0;cameraZoom=1;cameraShake={x:0,y:0};viewportWidth;viewportHeight;constructor(e,t,i){this.canvas=e,this.viewportWidth=t,this.viewportHeight=i;const o=e.getContext("2d");if(!o)throw new Error("Failed to get 2D context");this.ctx=o,this.resize(t,i),this.ctx.imageSmoothingEnabled=!1}resize(e,t){const i=window.devicePixelRatio||1;this.canvas.width=e*i,this.canvas.height=t*i,this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`,this.ctx.scale(i,i),this.viewportWidth=e,this.viewportHeight=t}setCamera(e,t,i=1){this.cameraX=e,this.cameraY=t,this.cameraZoom=i}setCameraShake(e,t){this.cameraShake={x:e,y:t}}getCameraOffset(){return{x:this.cameraX-this.viewportWidth/2/this.cameraZoom+this.cameraShake.x,y:this.cameraY-this.viewportHeight/2/this.cameraZoom+this.cameraShake.y}}getCameraZoom(){return this.cameraZoom}worldToScreen(e){const t=this.getCameraOffset();return{x:(e.x-t.x)*this.cameraZoom,y:(e.y-t.y)*this.cameraZoom}}screenToWorld(e){const t=this.getCameraOffset();return{x:e.x/this.cameraZoom+t.x,y:e.y/this.cameraZoom+t.y}}isInView(e,t,i=100){const o=this.worldToScreen({x:e,y:t});return o.x>=-i&&o.x<=this.viewportWidth+i&&o.y>=-i&&o.y<=this.viewportHeight+i}beginFrame(){this.ctx.save(),this.clear()}endFrame(){this.ctx.restore()}beginWorld(){this.ctx.save();const e=this.getCameraOffset();this.ctx.scale(this.cameraZoom,this.cameraZoom),this.ctx.translate(-e.x,-e.y)}endWorld(){this.ctx.restore()}clear(e=y.BACKGROUND){this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.viewportWidth,this.viewportHeight)}drawRect(e,t,i,o,s={}){const{fill:n,stroke:a,strokeWidth:r=1,glow:c=!1,glowColor:d=y.CYAN,glowSize:h=10,cornerRadius:m=0}=s;this.ctx.save(),c&&(this.ctx.shadowColor=d,this.ctx.shadowBlur=h),m>0?(this.ctx.beginPath(),this.ctx.roundRect(e,t,i,o,m),n&&(this.ctx.fillStyle=n,this.ctx.fill()),a&&(this.ctx.strokeStyle=a,this.ctx.lineWidth=r,this.ctx.stroke())):(n&&(this.ctx.fillStyle=n,this.ctx.fillRect(e,t,i,o)),a&&(this.ctx.strokeStyle=a,this.ctx.lineWidth=r,this.ctx.strokeRect(e,t,i,o))),this.ctx.restore()}drawCircle(e,t,i,o={}){const{fill:s,stroke:n,strokeWidth:a=1,glow:r=!1,glowColor:c=y.CYAN,glowSize:d=10}=o;this.ctx.save(),r&&(this.ctx.shadowColor=c,this.ctx.shadowBlur=d),this.ctx.beginPath(),this.ctx.arc(e,t,i,0,Math.PI*2),s&&(this.ctx.fillStyle=s,this.ctx.fill()),n&&(this.ctx.strokeStyle=n,this.ctx.lineWidth=a,this.ctx.stroke()),this.ctx.restore()}drawArc(e,t,i,o,s,n={}){const{fill:a,stroke:r,strokeWidth:c=1,glow:d=!1,glowColor:h=y.CYAN,glowSize:m=10}=n;this.ctx.save(),d&&(this.ctx.shadowColor=h,this.ctx.shadowBlur=m),this.ctx.beginPath(),this.ctx.arc(e,t,i,o,s),a&&(this.ctx.fillStyle=a,this.ctx.fill()),r&&(this.ctx.strokeStyle=r,this.ctx.lineWidth=c,this.ctx.stroke()),this.ctx.restore()}drawLine(e,t,i,o,s={}){const{color:n=y.CYAN,width:a=1,glow:r=!1,glowColor:c=y.CYAN,glowSize:d=10,dash:h=[]}=s;this.ctx.save(),r&&(this.ctx.shadowColor=c,this.ctx.shadowBlur=d),this.ctx.strokeStyle=n,this.ctx.lineWidth=a,this.ctx.setLineDash(h),this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(i,o),this.ctx.stroke(),this.ctx.restore()}drawPolygon(e,t={}){if(e.length<3)return;const{fill:i,stroke:o,strokeWidth:s=1,glow:n=!1,glowColor:a=y.CYAN,glowSize:r=10}=t;this.ctx.save(),n&&(this.ctx.shadowColor=a,this.ctx.shadowBlur=r),this.ctx.beginPath(),this.ctx.moveTo(e[0].x,e[0].y);for(let c=1;c<e.length;c++)this.ctx.lineTo(e[c].x,e[c].y);this.ctx.closePath(),i&&(this.ctx.fillStyle=i,this.ctx.fill()),o&&(this.ctx.strokeStyle=o,this.ctx.lineWidth=s,this.ctx.stroke()),this.ctx.restore()}drawText(e,t,i,o={}){const{font:s="Segoe UI",size:n=14,color:a=y.TEXT_PRIMARY,align:r="left",baseline:c="top",glow:d=!1,glowColor:h=y.CYAN,glowSize:m=10}=o;this.ctx.save(),d&&(this.ctx.shadowColor=h,this.ctx.shadowBlur=m),this.ctx.font=`${n}px ${s}`,this.ctx.fillStyle=a,this.ctx.textAlign=r,this.ctx.textBaseline=c,this.ctx.fillText(e,t,i),this.ctx.restore()}measureText(e,t,i){this.ctx.save(),this.ctx.font=`${i}px ${t}`;const o=this.ctx.measureText(e);return this.ctx.restore(),o}drawSprite(e,t,i,o,s){const n=o??e.width,a=s??e.height;this.ctx.drawImage(e.image,e.x,e.y,e.width,e.height,t,i,n,a)}drawImage(e,t,i,o,s,n=0){const a=o??e.width,r=s??e.height;this.ctx.save(),this.ctx.translate(t+a/2,i+r/2),this.ctx.rotate(n),this.ctx.drawImage(e,-a/2,-r/2,a,r),this.ctx.restore()}drawNeonRect(e,t,i=1){const{x:o,y:s,width:n,height:a}=e;this.drawRect(o,s,n,a,{stroke:t,strokeWidth:2,glow:!0,glowColor:t,glowSize:15*i}),this.drawRect(o+2,s+2,n-4,a-4,{fill:`${t}22`})}drawHealthBar(e,t,i,o,s,n,a=0,r=0){const c=Math.max(0,s/n),d=r>0?Math.max(0,a/r):0;if(this.drawRect(e,t,i,o,{fill:"#000000AA",stroke:"#333",strokeWidth:1}),c>0){const h=(i-2)*c;this.drawRect(e+1,t+1,h,o-2,{fill:y.HEALTH})}if(d>0){const h=(i-2)*d;this.drawRect(e+1,t+1,h,o-2,{fill:y.SHIELD})}}drawAbilityCooldown(e,t,i,o,s){if(this.drawCircle(e,t,i,{fill:"#222",stroke:y.CYAN,strokeWidth:2}),s){const n=i*1.4;this.drawImage(s,e-n/2,t-n/2,n,n)}o>0&&(this.ctx.save(),this.ctx.globalAlpha=.7,this.ctx.fillStyle="#000",this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.arc(e,t,i,-Math.PI/2,-Math.PI/2+Math.PI*2*o,!1),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore())}drawDebugGrid(e,t="#333"){const i=this.getCameraOffset(),o=Math.floor(i.x/e)*e,s=Math.floor(i.y/e)*e,n=i.x+this.viewportWidth/this.cameraZoom+e,a=i.y+this.viewportHeight/this.cameraZoom+e;this.ctx.save(),this.ctx.strokeStyle=t,this.ctx.lineWidth=.5;for(let r=o;r<=n;r+=e)this.drawLine(r,s,r,a,{color:t,width:.5});for(let r=s;r<=a;r+=e)this.drawLine(o,r,n,r,{color:t,width:.5});this.ctx.restore()}drawDebugPoint(e,t,i=y.CYAN,o){this.drawCircle(e,t,4,{fill:i}),o&&this.drawText(o,e+8,t-8,{color:i,size:10})}drawDebugRect(e,t=y.CYAN,i){this.drawRect(e.x,e.y,e.width,e.height,{stroke:t,strokeWidth:1}),i&&this.drawText(i,e.x,e.y-14,{color:t,size:10})}getWidth(){return this.viewportWidth}getHeight(){return this.viewportHeight}getContext(){return this.ctx}}class cs{context=null;masterVolume=1;sfxVolume=1;musicVolume=.5;sounds=new Map;activeSources=new Map;activeGains=new Map;currentMusic=null;currentMusicKey=null;initialized=!1;async init(){if(!this.initialized)try{this.context=new AudioContext,this.initialized=!0}catch(e){console.warn("Web Audio API not supported:",e)}}async loadSound(e,t){if(this.context)try{const o=await(await fetch(t)).arrayBuffer(),s=await this.context.decodeAudioData(o);this.sounds.set(e,s)}catch(i){console.warn(`Failed to load sound: ${e}`,i)}}play(e,t={}){if(!this.context||!this.sounds.has(e))return null;const i=this.sounds.get(e),o=this.context.createBufferSource();o.buffer=i;const s=this.context.createGain();s.gain.value=(t.volume??1)*this.sfxVolume*this.masterVolume,o.connect(s),s.connect(this.context.destination),o.loop=t.loop??!1,t.pitch&&(o.playbackRate.value=t.pitch);const n=`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;this.activeSources.set(n,o),this.activeGains.set(n,s),o.onended=()=>{this.activeSources.delete(n),this.activeGains.delete(n)};const a=t.offset??0;return o.start(0,a),n}stop(e){const t=this.activeSources.get(e);t&&(t.stop(),this.activeSources.delete(e),this.activeGains.delete(e))}getSoundDuration(e){const t=this.sounds.get(e);return t?t.duration:0}playMusic(e,t=0){if(!this.context||!this.sounds.has(e)||this.currentMusicKey===e)return;this.stopMusic(.5);const i=this.sounds.get(e),o=this.context.createBufferSource();o.buffer=i,o.loop=!0;const s=this.context.createGain();t>0?(s.gain.value=0,s.gain.linearRampToValueAtTime(this.musicVolume*this.masterVolume,this.context.currentTime+t)):s.gain.value=this.musicVolume*this.masterVolume,o.connect(s),s.connect(this.context.destination),o.start(0),this.currentMusic=o,this.currentMusicKey=e}stopMusic(e=0){if(!this.currentMusic||!this.context)return;const t=this.currentMusic;if(e>0){const i=this.context.createGain();t.disconnect(),t.connect(i),i.connect(this.context.destination),i.gain.linearRampToValueAtTime(0,this.context.currentTime+e),setTimeout(()=>{try{t.stop()}catch{}},e*1e3)}else t.stop();this.currentMusic=null,this.currentMusicKey=null}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e))}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}setMusicVolume(e){this.musicVolume=Math.max(0,Math.min(1,e))}async resume(){this.context?.state==="suspended"&&await this.context.resume()}suspend(){this.context?.suspend()}stopAll(){for(const[e]of this.activeSources)this.stop(e);this.stopMusic()}isInitialized(){return this.initialized}}const f={create(l=0,e=0){return{x:l,y:e}},clone(l){return{x:l.x,y:l.y}},add(l,e){return{x:l.x+e.x,y:l.y+e.y}},sub(l,e){return{x:l.x-e.x,y:l.y-e.y}},mul(l,e){return{x:l.x*e,y:l.y*e}},div(l,e){return e===0?{x:0,y:0}:{x:l.x/e,y:l.y/e}},dot(l,e){return l.x*e.x+l.y*e.y},cross(l,e){return l.x*e.y-l.y*e.x},length(l){return Math.sqrt(l.x*l.x+l.y*l.y)},lengthSquared(l){return l.x*l.x+l.y*l.y},normalize(l){const e=f.length(l);return e===0?{x:0,y:0}:{x:l.x/e,y:l.y/e}},distance(l,e){const t=e.x-l.x,i=e.y-l.y;return Math.sqrt(t*t+i*i)},distanceSquared(l,e){const t=e.x-l.x,i=e.y-l.y;return t*t+i*i},angle(l){return Math.atan2(l.y,l.x)},fromAngle(l,e=1){return{x:Math.cos(l)*e,y:Math.sin(l)*e}},rotate(l,e){const t=Math.cos(e),i=Math.sin(e);return{x:l.x*t-l.y*i,y:l.x*i+l.y*t}},lerp(l,e,t){return{x:l.x+(e.x-l.x)*t,y:l.y+(e.y-l.y)*t}},clamp(l,e){return f.length(l)<=e?{x:l.x,y:l.y}:f.mul(f.normalize(l),e)},equals(l,e,t=1e-4){return Math.abs(l.x-e.x)<t&&Math.abs(l.y-e.y)<t},zero(){return{x:0,y:0}}},Mi={pointInRect(l,e){return l.x>=e.x&&l.x<=e.x+e.width&&l.y>=e.y&&l.y<=e.y+e.height},pointInCircle(l,e){const t=l.x-e.x,i=l.y-e.y;return t*t+i*i<=e.radius*e.radius},rectIntersect(l,e){return l.x<e.x+e.width&&l.x+l.width>e.x&&l.y<e.y+e.height&&l.y+l.height>e.y},circleIntersect(l,e){const t=e.x-l.x,i=e.y-l.y,o=l.radius+e.radius;return t*t+i*i<=o*o},circleRectIntersect(l,e){const t=Math.max(e.x,Math.min(l.x,e.x+e.width)),i=Math.max(e.y,Math.min(l.y,e.y+e.height)),o=l.x-t,s=l.y-i;return o*o+s*s<=l.radius*l.radius},lineIntersect(l,e,t,i){const o=(i.y-t.y)*(e.x-l.x)-(i.x-t.x)*(e.y-l.y);if(Math.abs(o)<1e-4)return null;const s=((i.x-t.x)*(l.y-t.y)-(i.y-t.y)*(l.x-t.x))/o,n=((e.x-l.x)*(l.y-t.y)-(e.y-l.y)*(l.x-t.x))/o;return s>=0&&s<=1&&n>=0&&n<=1?{x:l.x+s*(e.x-l.x),y:l.y+s*(e.y-l.y)}:null},lineRectIntersect(l,e,t){const i=[{p1:{x:t.x,y:t.y},p2:{x:t.x+t.width,y:t.y}},{p1:{x:t.x+t.width,y:t.y},p2:{x:t.x+t.width,y:t.y+t.height}},{p1:{x:t.x+t.width,y:t.y+t.height},p2:{x:t.x,y:t.y+t.height}},{p1:{x:t.x,y:t.y+t.height},p2:{x:t.x,y:t.y}}];let o=null,s=1/0;for(const n of i){const a=this.lineIntersect(l,e,n.p1,n.p2);if(a){const r=f.distanceSquared(l,a);r<s&&(s=r,o=a)}}return o}};let ds=0;function K(l="e"){return`${l}_${Date.now().toString(36)}_${(ds++).toString(36)}`}function Ge(l,e,t){return l+(e-l)*t}function hs(l,e){return l+Math.random()*(e-l)}function us(l){const e=Math.floor(l/1e3),t=Math.floor(e/60),i=e%60;return`${t}:${i.toString().padStart(2,"0")}`}var me=(l=>(l.Circle="circle",l.Box="box",l))(me||{});const D={PLAYER:1,ENEMY:2,PROJECTILE:4,WALL:8,TRIGGER:16,ALL:4294967295};class ms{cellSize;cells=new Map;bodyPositions=new Map;constructor(e=128){this.cellSize=e}getCellsForBody(e){const t=this.getBodyBounds(e),i=[],o=Math.floor(t.x/this.cellSize),s=Math.floor(t.y/this.cellSize),n=Math.floor((t.x+t.width)/this.cellSize),a=Math.floor((t.y+t.height)/this.cellSize);for(let r=o;r<=n;r++)for(let c=s;c<=a;c++)i.push(`${r},${c}`);return i}getBodyBounds(e){if(e.collider.type==="circle"){const t=e.collider;return{x:e.position.x+t.offset.x-t.radius,y:e.position.y+t.offset.y-t.radius,width:t.radius*2,height:t.radius*2}}else{const t=e.collider;return{x:e.position.x+t.offset.x,y:e.position.y+t.offset.y,width:t.width,height:t.height}}}insert(e){this.remove(e.id);const t=this.getCellsForBody(e);this.bodyPositions.set(e.id,t);for(const i of t)this.cells.has(i)||this.cells.set(i,new Set),this.cells.get(i).add(e.id)}remove(e){const t=this.bodyPositions.get(e);if(t){for(const i of t)this.cells.get(i)?.delete(e);this.bodyPositions.delete(e)}}update(e){this.insert(e)}query(e){const t=new Set,i=Math.floor(e.x/this.cellSize),o=Math.floor(e.y/this.cellSize),s=Math.floor((e.x+e.width)/this.cellSize),n=Math.floor((e.y+e.height)/this.cellSize);for(let a=i;a<=s;a++)for(let r=o;r<=n;r++){const c=this.cells.get(`${a},${r}`);if(c)for(const d of c)t.add(d)}return t}getNearby(e){const t=this.getBodyBounds(e);t.x-=this.cellSize,t.y-=this.cellSize,t.width+=this.cellSize*2,t.height+=this.cellSize*2;const i=this.query(t);return i.delete(e.id),i}clear(){this.cells.clear(),this.bodyPositions.clear()}}class ps{bodies=new Map;spatialHash;collisions=[];constructor(e=128){this.spatialHash=new ms(e)}addBody(e){this.bodies.set(e.id,e),this.spatialHash.insert(e)}removeBody(e){this.bodies.delete(e),this.spatialHash.remove(e)}getBody(e){return this.bodies.get(e)}updateBody(e,t,i){const o=this.bodies.get(e);o&&(o.position=t,i&&(o.velocity=i),this.spatialHash.update(o))}detectCollisions(){this.collisions=[];for(const[e,t]of this.bodies){const i=this.spatialHash.getNearby(t);for(const o of i){if(o<=e)continue;const s=this.bodies.get(o);if(!s||!(t.layer&s.mask)&&!(s.layer&t.mask))continue;const n=this.checkCollision(t,s);n&&this.collisions.push(n)}}return this.collisions}checkCollision(e,t){const i=e.collider,o=t.collider,s=f.add(e.position,i.offset),n=f.add(t.position,o.offset);if(i.type==="circle"&&o.type==="circle"){const a=i.radius+o.radius,r=f.distance(s,n);if(r<a){const c=f.normalize(f.sub(n,s)),d=a-r,h=f.add(s,f.mul(c,i.radius));return{bodyA:e,bodyB:t,normal:c,depth:d,point:h}}}if(i.type==="box"&&o.type==="box"){const a={x:s.x,y:s.y,width:i.width,height:i.height},r={x:n.x,y:n.y,width:o.width,height:o.height};if(Mi.rectIntersect(a,r)){const c=Math.min(a.x+a.width,r.x+r.width)-Math.max(a.x,r.x),d=Math.min(a.y+a.height,r.y+r.height)-Math.max(a.y,r.y),h={x:s.x+i.width/2,y:s.y+i.height/2},m={x:n.x+o.width/2,y:n.y+o.height/2},u=f.sub(m,h);let p,w;c<d?(p={x:u.x>0?1:-1,y:0},w=c):(p={x:0,y:u.y>0?1:-1},w=d);const x={x:h.x+p.x*(i.width/2),y:h.y+p.y*(i.height/2)};return{bodyA:e,bodyB:t,normal:p,depth:w,point:x}}}if(i.type==="circle"&&o.type==="box"||i.type==="box"&&o.type==="circle"){const a=i.type==="circle"?e:t,r=i.type==="box"?e:t,c=a.collider,d=r.collider,h=f.add(a.position,c.offset),m=f.add(r.position,d.offset),u={x:m.x,y:m.y,width:d.width,height:d.height},p=Math.max(u.x,Math.min(h.x,u.x+u.width)),w=Math.max(u.y,Math.min(h.y,u.y+u.height)),x=h.x-p,S=h.y-w,k=x*x+S*S,I=c.radius*c.radius;if(h.x>=u.x&&h.x<=u.x+u.width&&h.y>=u.y&&h.y<=u.y+u.height){const R=h.x-u.x,W=u.x+u.width-h.x,$=h.y-u.y,Y=u.y+u.height-h.y,Z=Math.min(R,W,$,Y);let N,O;return Z===R?(N={x:-1,y:0},O=R+c.radius):Z===W?(N={x:1,y:0},O=W+c.radius):Z===$?(N={x:0,y:-1},O=$+c.radius):(N={x:0,y:1},O=Y+c.radius),{bodyA:a,bodyB:r,normal:N,depth:O,point:{x:p,y:w}}}else if(k<I){const R=Math.sqrt(k),W=c.radius-R,$=R>1e-4?{x:x/R,y:S/R}:{x:1,y:0};return{bodyA:a,bodyB:r,normal:$,depth:W,point:{x:p,y:w}}}}return null}resolveCollisions(){const e=[...this.collisions].sort((t,i)=>{const o=t.bodyA.isStatic||t.bodyB.isStatic,s=i.bodyA.isStatic||i.bodyB.isStatic;return o&&!s?-1:!o&&s?1:0});for(const t of e){const{bodyA:i,bodyB:o,normal:s,depth:n}=t;if(!(i.isTrigger||o.isTrigger)&&!(n<=0||!isFinite(n))){if(i.isStatic&&!o.isStatic){o.position.x-=s.x*n,o.position.y-=s.y*n;const a=o.velocity.x*s.x+o.velocity.y*s.y;a>0&&(o.velocity.x-=s.x*a,o.velocity.y-=s.y*a)}else if(o.isStatic&&!i.isStatic){i.position.x+=s.x*n,i.position.y+=s.y*n;const a=i.velocity.x*s.x+i.velocity.y*s.y;a<0&&(i.velocity.x-=s.x*a,i.velocity.y-=s.y*a)}else if(!i.isStatic&&!o.isStatic){const a=n/2,r=.8;i.position.x+=s.x*a*r,i.position.y+=s.y*a*r,o.position.x-=s.x*a*r,o.position.y-=s.y*a*r}this.spatialHash.update(i),this.spatialHash.update(o)}}}raycast(e,t,i,o=D.ALL){const s=f.normalize(t),n=f.add(e,f.mul(s,i));let a=null;for(const[,r]of this.bodies){if(!(r.layer&o))continue;const c=r.collider,d=f.add(r.position,c.offset);let h=null;if(c.type==="box"){const m={x:d.x,y:d.y,width:c.width,height:c.height};h=Mi.lineRectIntersect(e,n,m)}else c.type==="circle"&&(h=this.lineCircleIntersection(e,n,d,c.radius));if(h){const m=f.distance(e,h);(!a||m<a.distance)&&(a={body:r,point:h,distance:m})}}return a}lineCircleIntersection(e,t,i,o){const s=f.sub(t,e),n=f.sub(e,i),a=f.dot(s,s),r=2*f.dot(n,s),c=f.dot(n,n)-o*o;let d=r*r-4*a*c;if(d<0)return null;d=Math.sqrt(d);const h=(-r-d)/(2*a),m=(-r+d)/(2*a);return h>=0&&h<=1?f.add(e,f.mul(s,h)):m>=0&&m<=1?f.add(e,f.mul(s,m)):null}getCollisions(){return this.collisions}clear(){this.bodies.clear(),this.spatialHash.clear(),this.collisions=[]}}class Wt{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){this.listeners.get(e)?.delete(t)}emit(e,t){const i=this.listeners.get(e);if(i)for(const o of i)try{o(t)}catch(s){console.error(`Error in event handler for ${String(e)}:`,s)}}once(e,t){const i=o=>{this.off(e,i),t(o)};this.on(e,i)}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}}const fs=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}];class ht extends Wt{peerId;connection;dataChannel=null;isConnected=!1;constructor(e,t){super(),this.peerId=e,this.connection=new RTCPeerConnection({iceServers:t?.iceServers??fs}),this.setupConnectionListeners()}setupConnectionListeners(){this.connection.oniceconnectionstatechange=()=>{const e=this.connection.iceConnectionState;console.log(`[Peer ${this.peerId}] ICE state: ${e}`),e==="connected"?this.isConnected||(this.isConnected=!0,this.emit("connected",{peerId:this.peerId})):(e==="disconnected"||e==="failed"||e==="closed")&&(this.isConnected=!1,this.emit("disconnected",{peerId:this.peerId}))},this.connection.ondatachannel=e=>{this.setupDataChannel(e.channel)}}setupDataChannel(e){this.dataChannel=e,this.dataChannel.binaryType="arraybuffer",this.dataChannel.onopen=()=>{console.log(`[Peer ${this.peerId}] Data channel opened`)},this.dataChannel.onclose=()=>{console.log(`[Peer ${this.peerId}] Data channel closed`)},this.dataChannel.onmessage=t=>{this.emit("message",{peerId:this.peerId,data:t.data})},this.dataChannel.onerror=t=>{this.emit("error",{peerId:this.peerId,error:new Error("Data channel error")}),console.error(`[Peer ${this.peerId}] Data channel error:`,t)}}async createOffer(){const e=this.connection.createDataChannel("game",{ordered:!1,maxRetransmits:0});this.setupDataChannel(e);const t=await this.connection.createOffer();return await this.connection.setLocalDescription(t),t}async handleOffer(e){await this.connection.setRemoteDescription(e);const t=await this.connection.createAnswer();return await this.connection.setLocalDescription(t),t}async handleAnswer(e){await this.connection.setRemoteDescription(e)}async addIceCandidate(e){try{await this.connection.addIceCandidate(e)}catch(t){console.warn(`[Peer ${this.peerId}] Failed to add ICE candidate:`,t)}}onIceCandidate(e){this.connection.onicecandidate=t=>{t.candidate&&e(t.candidate)}}send(e){if(!this.dataChannel||this.dataChannel.readyState!=="open")return!1;try{return typeof e=="string"?this.dataChannel.send(e):this.dataChannel.send(new Uint8Array(e)),!0}catch(t){return console.error(`[Peer ${this.peerId}] Send failed:`,t),!1}}sendIfReady(e){return!this.dataChannel||this.dataChannel.readyState!=="open"?!1:this.dataChannel.bufferedAmount>65536?(console.warn(`[Peer ${this.peerId}] Buffer full, skipping send`),!1):this.send(e)}close(){this.dataChannel?.close(),this.connection.close(),this.isConnected=!1}getPeerId(){return this.peerId}getIsConnected(){return this.isConnected&&this.dataChannel?.readyState==="open"}getStats(){return this.connection.getStats()}}class gs extends Wt{ws=null;serverUrl;localPeerId;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=1e3;constructor(e){super(),this.serverUrl=e,this.localPeerId=this.generatePeerId()}generatePeerId(){return`peer_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}connect(){return new Promise((e,t)=>{try{this.ws=new WebSocket(this.serverUrl),this.ws.onopen=()=>{console.log("[Signaling] Connected"),this.reconnectAttempts=0,this.emit("connected",void 0),e()},this.ws.onclose=()=>{console.log("[Signaling] Disconnected"),this.emit("disconnected",void 0),this.attemptReconnect()},this.ws.onerror=i=>{console.error("[Signaling] Error:",i),t(i)},this.ws.onmessage=i=>{this.handleMessage(i.data)}}catch(i){t(i)}})}handleMessage(e){try{const t=JSON.parse(e);switch(t.type){case"room-created":this.emit("roomCreated",{roomCode:t.roomCode});break;case"room-joined":this.emit("roomJoined",{roomCode:t.roomCode,peers:t.payload});break;case"peer-joined":this.emit("peerJoined",{peerId:t.peerId});break;case"peer-left":this.emit("peerLeft",{peerId:t.peerId});break;case"offer":this.emit("offer",{peerId:t.peerId,offer:t.payload});break;case"answer":this.emit("answer",{peerId:t.peerId,answer:t.payload});break;case"ice-candidate":this.emit("iceCandidate",{peerId:t.peerId,candidate:t.payload});break;case"error":this.emit("error",{message:t.payload});break;default:console.warn("[Signaling] Unknown message type:",t.type)}}catch(t){console.error("[Signaling] Failed to parse message:",t)}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("[Signaling] Max reconnect attempts reached");return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`[Signaling] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.connect().catch(()=>{})},e)}send(e){this.ws?.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.warn("[Signaling] Cannot send, not connected")}createRoom(){this.send({type:"create-room",peerId:this.localPeerId})}joinRoom(e){this.send({type:"join-room",roomCode:e,peerId:this.localPeerId})}leaveRoom(){this.send({type:"leave-room",peerId:this.localPeerId})}sendOffer(e,t){this.send({type:"offer",peerId:this.localPeerId,targetId:e,payload:t})}sendAnswer(e,t){this.send({type:"answer",peerId:this.localPeerId,targetId:e,payload:t})}sendIceCandidate(e,t){this.send({type:"ice-candidate",peerId:this.localPeerId,targetId:e,payload:t})}disconnect(){this.ws?.close(),this.ws=null}getLocalPeerId(){return this.localPeerId}isConnected(){return this.ws?.readyState===WebSocket.OPEN}}class ys extends Wt{db=null;localPeerId;roomCode="";unsubscribers=[];isConnected=!1;firebase=null;constructor(){super(),this.localPeerId=this.generatePeerId()}generatePeerId(){return`peer_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}async connect(e){try{const{initializeApp:t,getApps:i,getApp:o}=await Se(async()=>{const{initializeApp:S,getApps:k,getApp:I}=await import("./index.esm-OOYOW6k3.js");return{initializeApp:S,getApps:k,getApp:I}},__vite__mapDeps([0,1]),import.meta.url),{getFirestore:s,collection:n,doc:a,setDoc:r,getDoc:c,addDoc:d,onSnapshot:h,deleteDoc:m,updateDoc:u,serverTimestamp:p,arrayUnion:w}=await Se(async()=>{const{getFirestore:S,collection:k,doc:I,setDoc:T,getDoc:R,addDoc:W,onSnapshot:$,deleteDoc:Y,updateDoc:Z,serverTimestamp:N,arrayUnion:O}=await import("./index.esm-DbUeHnob.js");return{getFirestore:S,collection:k,doc:I,setDoc:T,getDoc:R,addDoc:W,onSnapshot:$,deleteDoc:Y,updateDoc:Z,serverTimestamp:N,arrayUnion:O}},__vite__mapDeps([2,1]),import.meta.url);this.firebase={collection:n,doc:a,setDoc:r,getDoc:c,addDoc:d,onSnapshot:h,deleteDoc:m,updateDoc:u,serverTimestamp:p,arrayUnion:w};const x=i().length===0?t(e):o();this.db=s(x),this.isConnected=!0,this.emit("connected",void 0),console.log("[FirestoreSignaling] Connected to Firebase")}catch(t){throw console.error("[FirestoreSignaling] Failed to connect:",t),t}}async createRoom(){if(!this.db)throw new Error("Not connected to Firebase");const{doc:e,setDoc:t,serverTimestamp:i}=this.firebase;this.roomCode=this.generateRoomCode();const o=e(this.db,"rooms",this.roomCode);await t(o,{hostId:this.localPeerId,createdAt:i(),peers:[this.localPeerId]});const s=e(this.db,"rooms",this.roomCode,"peers",this.localPeerId);return await t(s,{joinedAt:i(),isHost:!0}),this.listenForPeers(),this.listenForSignals(),this.emit("roomCreated",{roomCode:this.roomCode}),console.log(`[FirestoreSignaling] Room created: ${this.roomCode}`),this.roomCode}async joinRoom(e){if(!this.db)throw new Error("Not connected to Firebase");const{doc:t,getDoc:i,setDoc:o,updateDoc:s,serverTimestamp:n,arrayUnion:a}=this.firebase;this.roomCode=e.toUpperCase(),console.log(`[FirestoreSignaling] Attempting to join room: ${this.roomCode} as peer: ${this.localPeerId}`);const r=t(this.db,"rooms",this.roomCode),c=await i(r);if(!c.exists())throw this.emit("error",{message:`Room ${this.roomCode} not found`}),new Error(`Room ${this.roomCode} not found`);const h=c.data().peers||[];console.log(`[FirestoreSignaling] Room exists, current peers: [${h.join(", ")}]`);try{await s(r,{peers:a(this.localPeerId)}),console.log("[FirestoreSignaling] Added self to peers array")}catch(p){console.error("[FirestoreSignaling] Failed to update peers array:",p),await s(r,{peers:[...h,this.localPeerId]})}const m=t(this.db,"rooms",this.roomCode,"peers",this.localPeerId);await o(m,{joinedAt:n(),isHost:!1}),console.log("[FirestoreSignaling] Created peer document"),this.listenForPeers(),this.listenForSignals();const u=h.filter(p=>p!==this.localPeerId);this.emit("roomJoined",{roomCode:this.roomCode,peers:u}),console.log(`[FirestoreSignaling] Joined room: ${this.roomCode}, will connect to peers: [${u.join(", ")}]`)}listenForPeers(){const{collection:e,onSnapshot:t}=this.firebase,i=e(this.db,"rooms",this.roomCode,"peers"),o=t(i,s=>{s.docChanges().forEach(n=>{const a=n.doc.id;a!==this.localPeerId&&(n.type==="added"?(console.log(`[FirestoreSignaling] Peer joined: ${a}`),this.emit("peerJoined",{peerId:a})):n.type==="removed"&&(console.log(`[FirestoreSignaling] Peer left: ${a}`),this.emit("peerLeft",{peerId:a})))})});this.unsubscribers.push(o)}listenForSignals(){const{collection:e,onSnapshot:t,deleteDoc:i,doc:o}=this.firebase,s=e(this.db,"rooms",this.roomCode,"signals",this.localPeerId,"messages"),n=t(s,a=>{a.docChanges().forEach(async r=>{if(r.type==="added"){const c=r.doc.data(),d=r.doc.id;switch(console.log(`[FirestoreSignaling] Received signal: ${c.type} from ${c.from}`),c.type){case"offer":this.emit("offer",{peerId:c.from,offer:c.payload});break;case"answer":this.emit("answer",{peerId:c.from,answer:c.payload});break;case"ice-candidate":this.emit("iceCandidate",{peerId:c.from,candidate:c.payload});break}const h=o(this.db,"rooms",this.roomCode,"signals",this.localPeerId,"messages",d);await i(h)}})});this.unsubscribers.push(n)}async sendOffer(e,t){await this.sendSignal(e,"offer",t)}async sendAnswer(e,t){await this.sendSignal(e,"answer",t)}async sendIceCandidate(e,t){await this.sendSignal(e,"ice-candidate",t)}async sendSignal(e,t,i){if(!this.db)return;const{collection:o,addDoc:s,serverTimestamp:n}=this.firebase,a=o(this.db,"rooms",this.roomCode,"signals",e,"messages");await s(a,{type:t,from:this.localPeerId,payload:i,timestamp:n()}),console.log(`[FirestoreSignaling] Sent ${t} to ${e}`)}async leaveRoom(){if(!this.db||!this.roomCode)return;const{doc:e,deleteDoc:t,getDoc:i,updateDoc:o}=this.firebase;this.unsubscribers.forEach(r=>r()),this.unsubscribers=[];const s=e(this.db,"rooms",this.roomCode,"peers",this.localPeerId);await t(s);const n=e(this.db,"rooms",this.roomCode),a=await i(n);if(a.exists()){const d=(a.data().peers||[]).filter(h=>h!==this.localPeerId);d.length===0?(await t(n),console.log(`[FirestoreSignaling] Room ${this.roomCode} deleted (empty)`)):await o(n,{peers:d})}this.roomCode="",console.log("[FirestoreSignaling] Left room")}disconnect(){this.leaveRoom(),this.isConnected=!1,this.emit("disconnected",void 0)}generateRoomCode(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let t="";for(let i=0;i<6;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}getLocalPeerId(){return this.localPeerId}getRoomCode(){return this.roomCode}getIsConnected(){return this.isConnected}}class ws{encoder=new TextEncoder;decoder=new TextDecoder;serialize(e){const t=JSON.stringify(e);return this.encoder.encode(t).buffer}deserialize(e){const t=this.decoder.decode(e);return JSON.parse(t)}serializeInput(e,t){const i=new ArrayBuffer(64),o=new DataView(i);let s=0;o.setUint8(s,_.Input),s+=1,o.setFloat64(s,Date.now()),s+=8;const n=this.encoder.encode(t);o.setUint8(s,n.length),s+=1,new Uint8Array(i,s,n.length).set(n),s+=n.length,o.setFloat32(s,e.moveX),s+=4,o.setFloat32(s,e.moveY),s+=4,o.setFloat32(s,e.aimX),s+=4,o.setFloat32(s,e.aimY),s+=4;let a=0;return e.shoot&&(a|=1),e.reload&&(a|=2),e.interact&&(a|=4),e.ability1&&(a|=8),e.ability2&&(a|=16),e.ultimate&&(a|=32),o.setUint8(s,a),s+=1,o.setUint32(s,e.sequence),s+=4,i.slice(0,s)}deserializeInput(e){try{const t=new DataView(e);let i=0;if(t.getUint8(i)!==_.Input)return null;i+=1;const s=t.getFloat64(i);i+=8;const n=t.getUint8(i);i+=1;const a=this.decoder.decode(new Uint8Array(e,i,n));i+=n;const r=t.getFloat32(i);i+=4;const c=t.getFloat32(i);i+=4;const d=t.getFloat32(i);i+=4;const h=t.getFloat32(i);i+=4;const m=t.getUint8(i);i+=1;const u=t.getUint32(i),p={moveX:r,moveY:c,aimX:d,aimY:h,shoot:(m&1)!==0,reload:(m&2)!==0,interact:(m&4)!==0,throwGrenade:(m&64)!==0,useBombCall:!1,useMissileStrike:!1,ability1:(m&8)!==0,ability2:(m&16)!==0,ultimate:(m&32)!==0,weaponSlot:0,sequence:u};return{senderId:a,input:p,timestamp:s}}catch{return null}}serializeSnapshot(e,t,i,o){const s={type:_.StateSnapshot,timestamp:Date.now(),senderId:"host",data:{tick:e,players:t,projectiles:i,objectives:o}};return this.serialize(s)}}class He extends Wt{signaling=null;firestoreSignaling=null;peers=new Map;serializer=new ws;isHost;localPeerId="";roomCode="";useFirestore;pingTimes=new Map;latencies=new Map;constructor(e){super(),this.isHost=e.isHost,this.useFirestore=e.useFirestore??!1}async connect(e){this.signaling=new gs(e),this.setupSignalingListeners(),await this.signaling.connect(),this.localPeerId=this.signaling.getLocalPeerId(),this.emit("connected",void 0)}async connectWithFirebase(e){this.useFirestore=!0,this.firestoreSignaling=new ys,this.setupFirestoreListeners(),await this.firestoreSignaling.connect(e),this.localPeerId=this.firestoreSignaling.getLocalPeerId(),this.emit("connected",void 0)}setupSignalingListeners(){this.signaling&&(this.signaling.on("roomCreated",({roomCode:e})=>{this.roomCode=e,console.log(`[Network] Room created: ${e}`),this.emit("roomCreated",{roomCode:e})}),this.signaling.on("roomJoined",({roomCode:e,peers:t})=>{this.roomCode=e,console.log(`[Network] Joined room: ${e}, peers:`,t),this.emit("roomJoined",{roomCode:e});for(const i of t)this.initiateConnection(i)}),this.signaling.on("peerJoined",({peerId:e})=>{console.log(`[Network] Peer joined: ${e}`)}),this.signaling.on("peerLeft",({peerId:e})=>{console.log(`[Network] Peer left: ${e}`),this.removePeer(e)}),this.signaling.on("offer",async({peerId:e,offer:t})=>{console.log(`[Network] Received offer from: ${e}`),await this.handleOffer(e,t)}),this.signaling.on("answer",async({peerId:e,answer:t})=>{console.log(`[Network] Received answer from: ${e}`);const i=this.peers.get(e);i&&await i.handleAnswer(t)}),this.signaling.on("iceCandidate",async({peerId:e,candidate:t})=>{const i=this.peers.get(e);i&&await i.addIceCandidate(t)}),this.signaling.on("error",({message:e})=>{console.error(`[Network] Signaling error: ${e}`),this.emit("error",{message:e})}),this.signaling.on("disconnected",()=>{console.log("[Network] Signaling disconnected"),this.emit("disconnected",void 0)}))}setupFirestoreListeners(){this.firestoreSignaling&&(this.firestoreSignaling.on("roomCreated",({roomCode:e})=>{this.roomCode=e,console.log(`[Network] Room created (Firestore): ${e}`),this.emit("roomCreated",{roomCode:e})}),this.firestoreSignaling.on("roomJoined",({roomCode:e,peers:t})=>{this.roomCode=e,console.log(`[Network] Joined room (Firestore): ${e}`),console.log(`[Network] Existing peers in room: [${t.join(", ")}]`),this.emit("roomJoined",{roomCode:e}),console.log(`[Network] Will initiate connections to ${t.length} peer(s)`);for(const i of t)console.log(`[Network] Initiating connection to peer: ${i}`),this.initiateConnectionFirestore(i)}),this.firestoreSignaling.on("peerJoined",({peerId:e})=>{console.log(`[Network] Peer joined (Firestore): ${e}`)}),this.firestoreSignaling.on("peerLeft",({peerId:e})=>{console.log(`[Network] Peer left (Firestore): ${e}`),this.removePeer(e)}),this.firestoreSignaling.on("offer",async({peerId:e,offer:t})=>{console.log(`[Network] Received offer (Firestore) from: ${e}`),await this.handleOfferFirestore(e,t)}),this.firestoreSignaling.on("answer",async({peerId:e,answer:t})=>{console.log(`[Network] Received answer (Firestore) from: ${e}`);const i=this.peers.get(e);i&&await i.handleAnswer(t)}),this.firestoreSignaling.on("iceCandidate",async({peerId:e,candidate:t})=>{const i=this.peers.get(e);i&&await i.addIceCandidate(t)}),this.firestoreSignaling.on("error",({message:e})=>{console.error(`[Network] Firestore signaling error: ${e}`),this.emit("error",{message:e})}),this.firestoreSignaling.on("disconnected",()=>{console.log("[Network] Firestore signaling disconnected"),this.emit("disconnected",void 0)}))}async initiateConnection(e){const t=new ht(e);this.setupPeerListeners(t),this.peers.set(e,t),t.onIceCandidate(o=>{this.signaling?.sendIceCandidate(e,o.toJSON())});const i=await t.createOffer();this.signaling?.sendOffer(e,i)}async handleOffer(e,t){const i=new ht(e);this.setupPeerListeners(i),this.peers.set(e,i),i.onIceCandidate(s=>{this.signaling?.sendIceCandidate(e,s.toJSON())});const o=await i.handleOffer(t);this.signaling?.sendAnswer(e,o)}async initiateConnectionFirestore(e){console.log(`[Network] Initiating WebRTC connection to: ${e}`);const t=new ht(e);this.setupPeerListeners(t),this.peers.set(e,t),console.log(`[Network] Peer added to map. Total peers: ${this.peers.size}`),t.onIceCandidate(i=>{console.log(`[Network] Sending ICE candidate to: ${e}`),this.firestoreSignaling?.sendIceCandidate(e,i.toJSON())});try{const i=await t.createOffer();console.log(`[Network] Created offer for: ${e}`),await this.firestoreSignaling?.sendOffer(e,i),console.log(`[Network] Sent offer to: ${e}`)}catch(i){console.error(`[Network] Failed to create/send offer to ${e}:`,i)}}async handleOfferFirestore(e,t){console.log(`[Network] Handling offer from: ${e}`);const i=new ht(e);this.setupPeerListeners(i),this.peers.set(e,i),console.log(`[Network] Peer added to map from offer. Total peers: ${this.peers.size}`),i.onIceCandidate(o=>{console.log(`[Network] Sending ICE candidate to: ${e}`),this.firestoreSignaling?.sendIceCandidate(e,o.toJSON())});try{const o=await i.handleOffer(t);console.log(`[Network] Created answer for: ${e}`),await this.firestoreSignaling?.sendAnswer(e,o),console.log(`[Network] Sent answer to: ${e}`)}catch(o){console.error(`[Network] Failed to handle offer from ${e}:`,o)}}setupPeerListeners(e){e.on("connected",({peerId:t})=>{console.log(`[Network] Peer connected: ${t}`),this.emit("peerConnected",{peerId:t})}),e.on("disconnected",({peerId:t})=>{console.log(`[Network] Peer disconnected: ${t}`),this.removePeer(t)}),e.on("message",({peerId:t,data:i})=>{this.handleMessage(t,i)}),e.on("error",({peerId:t,error:i})=>{console.error(`[Network] Peer error (${t}):`,i)})}handleMessage(e,t){try{let i;if(t instanceof ArrayBuffer?i=this.serializer.deserialize(t):i=JSON.parse(t),i.type===_.Pong){const o=this.pingTimes.get(e);if(o){const s=performance.now()-o;this.latencies.set(e,s),this.pingTimes.delete(e)}return}if(i.type===_.Ping){this.sendToPeer(e,{type:_.Pong,timestamp:Date.now(),senderId:this.localPeerId,data:null});return}this.emit("packet",{peerId:e,packet:i})}catch(i){console.error(`[Network] Failed to parse message from ${e}:`,i)}}removePeer(e){const t=this.peers.get(e);t&&(t.close(),this.peers.delete(e),this.latencies.delete(e),this.pingTimes.delete(e),this.emit("peerDisconnected",{peerId:e}))}async createRoom(){this.useFirestore&&this.firestoreSignaling?await this.firestoreSignaling.createRoom():this.signaling?.createRoom()}async joinRoom(e){this.useFirestore&&this.firestoreSignaling?await this.firestoreSignaling.joinRoom(e.toUpperCase()):this.signaling?.joinRoom(e.toUpperCase())}leaveRoom(){for(const[e]of this.peers)this.removePeer(e);this.useFirestore&&this.firestoreSignaling?this.firestoreSignaling.leaveRoom():this.signaling?.leaveRoom(),this.roomCode=""}sendToPeer(e,t){const i=this.peers.get(e);if(!i?.getIsConnected())return!1;const o=this.serializer.serialize(t);return i.send(o)}broadcast(e){const t=this.serializer.serialize(e);for(const[,i]of this.peers)i.getIsConnected()&&i.send(t)}sendJson(e,t){const i=this.peers.get(e);return i?.getIsConnected()?i.send(JSON.stringify(t)):!1}broadcastJson(e){const t=JSON.stringify(e);for(const[,i]of this.peers)i.getIsConnected()&&i.send(t)}pingPeers(){const e=performance.now();for(const[t,i]of this.peers)i.getIsConnected()&&(this.pingTimes.set(t,e),this.sendToPeer(t,{type:_.Ping,timestamp:Date.now(),senderId:this.localPeerId,data:null}))}getLatency(e){return this.latencies.get(e)??-1}getAverageLatency(){if(this.latencies.size===0)return-1;let e=0;for(const t of this.latencies.values())e+=t;return e/this.latencies.size}disconnect(){this.leaveRoom(),this.useFirestore&&this.firestoreSignaling?(this.firestoreSignaling.disconnect(),this.firestoreSignaling=null):(this.signaling?.disconnect(),this.signaling=null)}getLocalPeerId(){return this.localPeerId}getRoomCode(){return this.roomCode}getPeerIds(){return Array.from(this.peers.keys())}getPeerCount(){return this.peers.size}getIsHost(){return this.isHost}isConnected(){return this.signaling?.isConnected()??!1}}class Oe{id;name;peerId;team;heroId;position;velocity;rotation;prevPosition;prevRotation;targetPosition=null;targetRotation=null;health;maxHealth;shield;maxShield;alive;respawnTime;credits;kills;deaths;assists;grenadeCount;lastGrenadeThrowTime;bombCallCount;missileStrikeCount;weaponInventory;currentWeaponSlot;weapon;abilities;ultimateCharge;input;lastDamageTime;lastAttackerId;deathTime;isDisconnected;speedMultiplier;isSlowed;isStunned;isInvisible;damageReduction;damageBonus;shieldRegenBonus;fireRateBonus;isFireImmune;healingBonus;constructor(e,t,i,o,s){this.id=K("player"),this.peerId=e,this.name=t,this.team=i,this.heroId=o;const n=ee[o];this.position={...s},this.prevPosition={...s},this.velocity=f.zero(),this.rotation=0,this.prevRotation=0,this.maxHealth=n.health,this.health=this.maxHealth,this.maxShield=n.shield,this.shield=this.maxShield,this.alive=!0,this.respawnTime=0,this.credits=U.STARTING_CREDITS,this.kills=0,this.deaths=0,this.assists=0,this.grenadeCount=0,this.lastGrenadeThrowTime=0,this.bombCallCount=0,this.missileStrikeCount=0;const a=Pe[P.BurstPistol],r={weaponId:P.BurstPistol,ammo:a.ammoCapacity,maxAmmo:a.ammoCapacity,reloading:!1,reloadEndTime:0,lastFireTime:0};this.weaponInventory=[r,null,null,null,null,null,null,null,null,null],this.currentWeaponSlot=0,this.weapon=r,this.abilities=n.abilities.map((c,d)=>({abilityIndex:d,cooldownEndTime:0,charges:n.abilities[d]?.charges??1,active:!1,duration:0,ultimateCharge:0})),this.ultimateCharge=0,this.input=this.createEmptyInput(),this.lastDamageTime=0,this.lastAttackerId=null,this.deathTime=0,this.isDisconnected=!1,this.speedMultiplier=n.speed,this.isSlowed=!1,this.isStunned=!1,this.isInvisible=!1,this.damageReduction=0,this.damageBonus=0,this.shieldRegenBonus=0,this.fireRateBonus=0,this.isFireImmune=!1,this.healingBonus=0,this.applyHeroPassives()}applyHeroPassives(){switch(this.heroId){case"spectre":this.damageReduction=.1;break;case"byte":this.shieldRegenBonus=.25;break;case"vanta":this.damageReduction=.15;break;case"katana":this.damageBonus=.1;break;case"glyph":this.damageBonus=.1;break;case"spark":this.isFireImmune=!0,this.fireRateBonus=.1;break;case"zero":this.damageBonus=.15;break;case"mira":this.healingBonus=.25;break}}createEmptyInput(){return{moveX:0,moveY:0,aimX:0,aimY:0,shoot:!1,reload:!1,interact:!1,throwGrenade:!1,useBombCall:!1,useMissileStrike:!1,ability1:!1,ability2:!1,ultimate:!1,weaponSlot:0,sequence:0}}update(e,t){if(this.prevPosition={...this.position},this.prevRotation=this.rotation,!this.alive||this.isStunned)return;const i=f.sub({x:this.input.aimX,y:this.input.aimY},this.position);if(this.rotation=f.angle(i),this.updateMovement(e),this.updateWeapon(t),this.updateAbilities(t),t-this.lastDamageTime>3e3&&this.shield<this.maxShield){const o=.05*(1+this.shieldRegenBonus);this.shield=Math.min(this.maxShield,this.shield+this.maxShield*o*(e/1e3))}}updateMovement(e){let t=U.BASE_SPEED*this.speedMultiplier;this.isSlowed&&(t*=.6);const i=f.normalize({x:this.input.moveX,y:this.input.moveY}),o=f.mul(i,t);if(f.length(o)>0)this.velocity=f.lerp(this.velocity,o,1-Math.exp(-1500*e/1e3));else{const s=1-Math.exp(-800*e/1e3);this.velocity=f.mul(this.velocity,1-s)}this.position=f.add(this.position,f.mul(this.velocity,e/1e3))}updateWeapon(e){if(this.weapon.reloading&&e>=this.weapon.reloadEndTime&&(this.weapon.ammo=this.weapon.maxAmmo,this.weapon.reloading=!1),this.input.reload&&!this.weapon.reloading&&this.weapon.ammo<this.weapon.maxAmmo){const t=Pe[this.weapon.weaponId];this.weapon.reloading=!0,this.weapon.reloadEndTime=e+t.reloadTime}}updateAbilities(e){for(const t of this.abilities){t.active&&t.duration>0&&e>=t.duration&&(t.active=!1,t.duration=0);const i=ee[this.heroId].abilities[t.abilityIndex];i&&t.charges<i.charges&&e>=t.cooldownEndTime&&(t.charges++,t.charges<i.charges&&(t.cooldownEndTime=e+i.chargeTime))}}getWeaponDefinition(){return Pe[this.weapon.weaponId]}getEffectiveFireRate(){return this.getWeaponDefinition().fireRate*(1+this.fireRateBonus)}getEffectiveDamage(){return this.getWeaponDefinition().damage*(1+this.damageBonus)}canFire(e){if(!this.alive||this.weapon.reloading||this.weapon.ammo<=0||this.isStunned)return!1;const t=1e3/this.getEffectiveFireRate();return e>=this.weapon.lastFireTime+t}fire(e){if(this.canFire(e)&&(this.weapon.lastFireTime=e,this.weapon.ammo--,this.weapon.ammo<=0)){const t=Pe[this.weapon.weaponId];this.weapon.reloading=!0,this.weapon.reloadEndTime=e+t.reloadTime}}canUseAbility(e,t){if(!this.alive||this.isStunned||e<0||e>=this.abilities.length)return!1;const i=this.abilities[e];if(!i)return!1;const o=ee[this.heroId].abilities[e];return!o||o.isUltimate&&this.ultimateCharge<o.ultimateCost?!1:i.charges>0}useAbility(e,t){if(!this.canUseAbility(e,t))return;const i=this.abilities[e],o=ee[this.heroId].abilities[e];i.charges--,i.cooldownEndTime=t+o.cooldown,o.duration>0&&(i.active=!0,i.duration=t+o.duration),o.isUltimate&&(this.ultimateCharge=0)}takeDamage(e,t,i,o){if(!this.alive||o==="fire"&&this.isFireImmune)return 0;let s=e*(1-this.damageReduction);if(this.shield>0){const n=Math.min(this.shield,s);this.shield-=n,s-=n}return this.health=Math.max(0,this.health-s),this.lastDamageTime=i,this.lastAttackerId=t,this.health<=0&&this.die(i),e-s}heal(e){if(!this.alive)return 0;const t=e*(1+this.healingBonus),i=Math.min(this.maxHealth-this.health,t);return this.health+=i,i}addShield(e){const t=Math.min(this.maxShield-this.shield,e);return this.shield+=t,t}die(e){this.alive=!1,this.health=0,this.deaths++,this.velocity=f.zero(),this.deathTime=e,this.respawnTime=e+U.ROUND_TIME}respawn(e){this.alive=!0,this.health=this.maxHealth,this.shield=this.maxShield,this.position={...e},this.prevPosition={...e},this.velocity=f.zero(),this.isSlowed=!1,this.isStunned=!1,this.isInvisible=!1;const t=Pe[this.weapon.weaponId];this.weapon.ammo=t.ammoCapacity,this.weapon.reloading=!1}resetAbilities(){const e=ee[this.heroId];for(let t=0;t<this.abilities.length;t++){const i=this.abilities[t],o=e.abilities[t];i&&o&&(i.cooldownEndTime=0,i.charges=o.charges,i.active=!1,i.duration=0)}}setInput(e){this.input={...e}}switchToWeaponSlot(e){if(e<1||e>10)return!1;const t=e-1,i=this.weaponInventory[t];return!i||this.currentWeaponSlot===t||this.weapon.reloading?!1:(this.currentWeaponSlot=t,this.weapon=i,!0)}cycleWeaponNext(){if(this.weapon.reloading)return!1;for(let e=1;e<=10;e++){const t=(this.currentWeaponSlot+e)%10;if(this.weaponInventory[t])return this.currentWeaponSlot=t,this.weapon=this.weaponInventory[t],!0}return!1}cycleWeaponPrevious(){if(this.weapon.reloading)return!1;for(let e=1;e<=10;e++){const t=(this.currentWeaponSlot-e+10)%10;if(this.weaponInventory[t])return this.currentWeaponSlot=t,this.weapon=this.weaponInventory[t],!0}return!1}getWeaponSlotForId(e){switch(e){case P.BurstPistol:return 1;case P.NeoSMG9:return 2;case P.PulseRifle:return 3;case P.ScatterShot:return 4;case P.RailSniper:return 5;case P.ShardLauncher:return 6;case P.NanoRepeater:return 7;case P.ArcWelder:return 8;case P.PhaseRepeater:return 9;case P.PlasmaCannon:return 10;default:return 1}}buyWeapon(e,t=!1){const i=Pe[e];if(!t){if(this.credits<i.price)return!1;this.credits-=i.price}const o={weaponId:e,ammo:i.ammoCapacity,maxAmmo:i.ammoCapacity,reloading:!1,reloadEndTime:0,lastFireTime:0},n=this.getWeaponSlotForId(e)-1;return this.weaponInventory[n]=o,this.currentWeaponSlot=n,this.weapon=o,!0}getCollisionBody(){return{id:this.id,position:this.position,velocity:this.velocity,collider:{type:me.Circle,offset:{x:0,y:0},radius:16},layer:this.team===g.Attackers?D.PLAYER:D.ENEMY,mask:D.WALL|D.PLAYER|D.ENEMY|D.TRIGGER,isStatic:!1,isTrigger:!1,userData:this}}toState(){return{id:this.id,name:this.name,peerId:this.peerId,team:this.team,heroId:this.heroId,position:{...this.position},velocity:{...this.velocity},rotation:this.rotation,health:this.health,maxHealth:this.maxHealth,shield:this.shield,maxShield:this.maxShield,alive:this.alive,credits:this.credits,kills:this.kills,deaths:this.deaths,assists:this.assists,grenadeCount:this.grenadeCount,bombCallCount:this.bombCallCount,missileStrikeCount:this.missileStrikeCount,weapon:{...this.weapon},weaponInventory:this.weaponInventory.map(e=>e?{...e}:null),currentWeaponSlot:this.currentWeaponSlot,abilities:this.abilities.map(e=>({...e})),input:{...this.input}}}static fromState(e){const t=new Oe(e.peerId,e.name,e.team,e.heroId,e.position);return t.velocity={...e.velocity},t.rotation=e.rotation,t.health=e.health,t.maxHealth=e.maxHealth,t.shield=e.shield,t.maxShield=e.maxShield,t.alive=e.alive,t.credits=e.credits,t.kills=e.kills,t.deaths=e.deaths,t.assists=e.assists,t.grenadeCount=e.grenadeCount||0,t.bombCallCount=e.bombCallCount||0,t.missileStrikeCount=e.missileStrikeCount||0,t.weapon={...e.weapon},t.weaponInventory=e.weaponInventory?.map(i=>i?{...i}:null)||t.weaponInventory,t.currentWeaponSlot=e.currentWeaponSlot??t.currentWeaponSlot,t.abilities=e.abilities.map(i=>({...i})),t.input={...e.input},t}}class Ce{id;ownerId;position;prevPosition;velocity;damage;lifetime;spawnTime;active;radius;constructor(e,t,i,o,s,n,a){this.id=K("proj"),this.ownerId=e,this.position={...t},this.prevPosition={...t},this.velocity=f.mul(f.normalize(i),o),this.damage=s,this.lifetime=n,this.spawnTime=a,this.active=!0,this.radius=4}update(e,t){this.active&&(this.prevPosition={...this.position},this.position=f.add(this.position,f.mul(this.velocity,e/1e3)),t>=this.spawnTime+this.lifetime&&(this.active=!1))}destroy(){this.active=!1}getCollisionBody(){return{id:this.id,position:this.position,velocity:this.velocity,collider:{type:me.Circle,offset:{x:0,y:0},radius:this.radius},layer:D.PROJECTILE,mask:D.PLAYER|D.ENEMY|D.WALL,isStatic:!1,isTrigger:!0,userData:this}}toState(){return{id:this.id,ownerId:this.ownerId,position:{...this.position},velocity:{...this.velocity},damage:this.damage,lifetime:this.lifetime,spawnTime:this.spawnTime}}static fromState(e){const t=new Ce(e.ownerId,e.position,f.normalize(e.velocity),f.length(e.velocity),e.damage,e.lifetime,e.spawnTime);return t.velocity={...e.velocity},t}}class wi{id;ownerId;position;velocity;rotation;rotationSpeed;fuseTime;active;exploded;bounceCount;GRAVITY=3e-4;BOUNCE_DAMPING=.6;FRICTION=.98;FUSE_DURATION=3e3;constructor(e,t,i,o){this.id=K("grenade"),this.ownerId=e,this.position={...t},this.velocity=f.mul(i,o),this.rotation=0,this.rotationSpeed=(Math.random()-.5)*.02,this.fuseTime=this.FUSE_DURATION,this.active=!0,this.exploded=!1,this.bounceCount=0}update(e,t,i,o){if(!this.active||this.exploded)return!1;if(this.fuseTime-=e,this.fuseTime<=0)return this.exploded=!0,this.active=!1,!0;this.velocity.y+=this.GRAVITY*e,this.position.x+=this.velocity.x*e,this.position.y+=this.velocity.y*e,this.rotation+=this.rotationSpeed*e,this.velocity.x*=this.FRICTION,this.velocity.y*=this.FRICTION;const s=50;return this.position.x<s?(this.position.x=s,this.velocity.x=Math.abs(this.velocity.x)*this.BOUNCE_DAMPING,this.bounceCount++):this.position.x>i-s&&(this.position.x=i-s,this.velocity.x=-Math.abs(this.velocity.x)*this.BOUNCE_DAMPING,this.bounceCount++),this.position.y<s?(this.position.y=s,this.velocity.y=Math.abs(this.velocity.y)*this.BOUNCE_DAMPING,this.bounceCount++):this.position.y>o-s&&(this.position.y=o-s,this.velocity.y=-Math.abs(this.velocity.y)*this.BOUNCE_DAMPING,this.bounceCount++),Math.abs(this.velocity.x)<.01&&Math.abs(this.velocity.y)<.01&&(this.velocity.x=0,this.velocity.y=0),!1}getCollisionBody(){const e={type:me.Circle,offset:{x:0,y:0},radius:8};return{id:this.id,position:this.position,velocity:this.velocity,collider:e,layer:D.PROJECTILE,mask:D.WALL,isStatic:!1,isTrigger:!1,userData:this}}toState(){return{id:this.id,ownerId:this.ownerId,position:this.position,velocity:this.velocity,rotation:this.rotation,fuseTime:this.fuseTime,active:this.active,exploded:this.exploded}}static fromState(e){const t=new wi(e.ownerId,e.position,f.normalize(e.velocity),f.length(e.velocity));return t.rotation=e.rotation,t.fuseTime=e.fuseTime,t.active=e.active,t.exploded=e.exploded,t}}class St{id;ownerId;position;velocity;altitude;active;exploded;launchPosition;targetPosition;launchTime;trail=[];incomingSoundPlayed=!1;FALL_SPEED=.4;MISSILE_FLIGHT_TIME=3e3;constructor(e,t,i,o){this.id=K("bomb"),this.ownerId=e,this.position={...t},this.velocity={...i},this.altitude=o,this.active=!0,this.exploded=!1}update(e,t){if(!this.active||this.exploded)return!1;if(this.launchPosition&&this.targetPosition&&this.launchTime!==void 0){const o=t-this.launchTime;if(o<0)return!1;const s=Math.min(1,o/this.MISSILE_FLIGHT_TIME);s>0&&s<.05&&console.log(`[Missile] ${this.id} started moving: progress=${s.toFixed(3)} pos=(${this.position.x.toFixed(0)},${this.position.y.toFixed(0)}) altitude=${this.altitude.toFixed(0)}`),s>=.33&&!this.incomingSoundPlayed&&(this.incomingSoundPlayed=!0);const n=this.trail[this.trail.length-1];(this.trail.length===0||n&&f.distance(n,this.position)>5)&&(this.trail.push({...this.position}),this.trail.length>20&&this.trail.shift());const a=this.launchPosition.x,r=this.launchPosition.y,c=this.targetPosition.x,d=this.targetPosition.y,h=a+(c-a)*s,m=r+(d-r)*s,u=350*Math.sin(s*Math.PI);if(this.position.x=h,this.position.y=m,this.altitude=u,s>=1)return this.altitude=0,this.exploded=!0,this.active=!1,!0}else if(this.altitude-=this.FALL_SPEED*e,(Math.abs(this.velocity.x)>.01||Math.abs(this.velocity.y)>.01)&&(this.position.x+=this.velocity.x*e,this.position.y+=this.velocity.y*e),this.altitude<=0)return this.altitude=0,this.exploded=!0,this.active=!1,!0;return!1}getCollisionBody(){const e={type:me.Circle,offset:{x:0,y:0},radius:6};return{id:this.id,position:this.position,velocity:this.velocity,collider:e,layer:D.PROJECTILE,mask:D.WALL,isStatic:!1,isTrigger:!0,userData:this}}toState(){const e={id:this.id,ownerId:this.ownerId,position:this.position,velocity:this.velocity,altitude:this.altitude,active:this.active,exploded:this.exploded};return this.launchPosition&&(e.launchPosition=this.launchPosition),this.targetPosition&&(e.targetPosition=this.targetPosition),this.launchTime!==void 0&&(e.launchTime=this.launchTime),e}static fromState(e){const t=new St(e.ownerId,e.position,e.velocity,e.altitude);return t.altitude=e.altitude,t.active=e.active,t.exploded=e.exploded,e.launchPosition&&(t.launchPosition=e.launchPosition),e.targetPosition&&(t.targetPosition=e.targetPosition),e.launchTime!==void 0&&(t.launchTime=e.launchTime),t}}var ge=(l=>(l.SupplyDrop="supply_drop",l.Bomber="bomber",l))(ge||{});class et{id;type;position;prevPosition;startPosition;targetPosition;speed;altitude;active;hasDropped;dropTime;bombsDropped;direction;constructor(e,t,i,o,s,n="supply_drop"){this.id=K("aircraft"),this.type=n,this.position={...e},this.prevPosition={...e},this.startPosition={...e},this.targetPosition={...t},this.speed=i,this.altitude=o,this.active=!0,this.hasDropped=!1,this.dropTime=null,this.bombsDropped=0;const a=f.sub(t,e);this.direction=f.normalize(a)}update(e,t){if(!this.active)return;this.prevPosition={...this.position};const i=f.mul(this.direction,this.speed*e/1e3);this.position=f.add(this.position,i),f.distance(this.position,this.targetPosition)<this.speed*e/1e3&&(this.active=!1)}getRotation(){return Math.atan2(this.direction.y,this.direction.x)}getVelocity(){return f.mul(this.direction,this.speed/1e3)}toState(){return{id:this.id,type:this.type,position:this.position,targetPosition:this.targetPosition,speed:this.speed,altitude:this.altitude,active:this.active,hasDropped:this.hasDropped,dropTime:this.dropTime,bombsDropped:this.bombsDropped}}static fromState(e,t){const i=new et(e.position,e.targetPosition,e.speed,e.altitude,t,e.type);return i.hasDropped=e.hasDropped,i.dropTime=e.dropTime,i.bombsDropped=e.bombsDropped,i.active=e.active,i}}var B=(l=>(l.Weapon="weapon",l.HealthKit="health_kit",l.Credits="credits",l.Shield="shield",l.Grenade="grenade",l.BombCall="bomb_call",l.MissileStrike="missile_strike",l))(B||{});class vt{id;position;prevPosition;supplyType;weaponId;amount;active;claimed;dropTime;landTime;parachuteActive;altitude;fallSpeed=50;size=30;constructor(e,t,i,o,s,n){this.id=K("crate"),this.position={...e},this.prevPosition={...e},this.supplyType=t,s!==void 0&&(this.weaponId=s),n!==void 0&&(this.amount=n),this.active=!0,this.claimed=!1,this.dropTime=i,this.landTime=null,this.parachuteActive=!0,this.altitude=o}update(e,t){return!this.active||this.claimed?!1:(this.prevPosition={...this.position},this.parachuteActive&&this.altitude>0&&(this.altitude-=this.fallSpeed*e/1e3,this.altitude<=0)?(this.altitude=0,this.parachuteActive=!1,this.landTime=t,!0):!1)}claim(){this.claimed=!0,this.active=!1}isLanded(){return this.altitude<=0&&!this.parachuteActive}getCollisionBody(){return this.isLanded()?{id:this.id,position:this.position,velocity:{x:0,y:0},collider:{type:me.Circle,offset:{x:0,y:0},radius:this.size/2},layer:D.PROJECTILE,mask:D.PLAYER,isStatic:!0,isTrigger:!0,userData:this}:{id:this.id,position:this.position,velocity:{x:0,y:0},collider:{type:me.Circle,offset:{x:0,y:0},radius:0},layer:D.PROJECTILE,mask:0,isStatic:!0,isTrigger:!0,userData:this}}toState(){const e={id:this.id,position:this.position,supplyType:this.supplyType,active:this.active,claimed:this.claimed,dropTime:this.dropTime,landTime:this.landTime,parachuteActive:this.parachuteActive,altitude:this.altitude};return this.weaponId!==void 0&&(e.weaponId=this.weaponId),this.amount!==void 0&&(e.amount=this.amount),e}static fromState(e){const t=new vt(e.position,e.supplyType,e.dropTime,e.altitude,e.weaponId,e.amount);return t.active=e.active,t.claimed=e.claimed,t.landTime=e.landTime,t.parachuteActive=e.parachuteActive,t}}class te{data;collisionBodies=[];constructor(e){this.data=e,this.buildCollision()}buildCollision(){for(let e=0;e<this.data.tiles.length;e++){const t=this.data.tiles[e];if(t){for(let i=0;i<t.length;i++)if(t[i]===1){const s={id:K("wall"),position:{x:i*this.data.tileSize,y:e*this.data.tileSize},velocity:{x:0,y:0},collider:{type:me.Box,offset:{x:0,y:0},width:this.data.tileSize,height:this.data.tileSize},layer:D.WALL,mask:D.ALL,isStatic:!0,isTrigger:!1};this.collisionBodies.push(s)}}}for(const e of this.data.props)if(e.collider){const t={id:K("prop"),position:e.position,velocity:{x:0,y:0},collider:{type:me.Box,offset:{x:0,y:0},width:e.collider.width,height:e.collider.height},layer:D.WALL,mask:D.ALL,isStatic:!0,isTrigger:!1};this.collisionBodies.push(t)}}registerCollision(e){for(const t of this.collisionBodies)e.addBody(t)}getSpawnPoints(e){return this.data.spawnPoints.filter(t=>t.team===e)}getSpawnPoint(e,t){const i=this.getSpawnPoints(e),o=i[t%i.length];return o?{...o.position}:{x:0,y:0}}getSpikeSites(){return this.data.spikeSites}isInSpikeSite(e){for(let t=0;t<this.data.spikeSites.length;t++){const i=this.data.spikeSites[t];if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return t}return-1}getTileAt(e,t){const i=Math.floor(e/this.data.tileSize),o=Math.floor(t/this.data.tileSize);if(o<0||o>=this.data.tiles.length)return 1;const s=this.data.tiles[o];return!s||i<0||i>=s.length?1:s[i]??1}isWalkable(e,t){return this.getTileAt(e,t)===0}getWidth(){return this.data.width}getHeight(){return this.data.height}getTileSize(){return this.data.tileSize}}const bi=[{id:"neon_arena",name:"Neon Arena",description:"Classic symmetrical arena",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"reactor_core",name:"Reactor Core",description:"Circular arena with central cover",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"grid_maze",name:"Grid Maze",description:"Complex maze with many corners",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"neon_tower",name:"Neon Tower",description:"Vertical tower with open floors",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"crossfire",name:"Crossfire",description:"Four-way intersection battle",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"warehouse",name:"Warehouse",description:"Industrial storage facility",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"cyber_district",name:"Cyber District",description:"Urban streets with spike sites",hasSpikeSites:!0,recommended:"Data Spike"},{id:"helix_labs",name:"Helix Labs",description:"Tight corridors and open labs",hasSpikeSites:!0,recommended:"Data Spike"},{id:"sky_bridge",name:"Sky Bridge",description:"Three lanes connected by bridges",hasSpikeSites:!0,recommended:"Data Spike"},{id:"data_vault",name:"Data Vault",description:"Secure vault with multiple entries",hasSpikeSites:!0,recommended:"Data Spike"},{id:"server_farm",name:"Server Farm",description:"High-tech data center",hasSpikeSites:!0,recommended:"Data Spike"},{id:"nexus_hub",name:"Nexus Hub",description:"Central network control room",hasSpikeSites:!0,recommended:"Data Spike"}];function bs(l){switch(l){case"neon_arena":return Ai();case"cyber_district":return xs();case"helix_labs":return Ss();case"reactor_core":return vs();case"grid_maze":return ks();case"sky_bridge":return Ps();case"data_vault":return Cs();case"neon_tower":return Is();case"crossfire":return Es();case"warehouse":return Ms();case"server_farm":return As();case"nexus_hub":return Ts();default:return console.warn(`Unknown map ID: ${l}, falling back to neon_arena`),Ai()}}function Ai(){const i=[];for(let s=0;s<30;s++){const n=[];for(let a=0;a<40;a++)a===0||a===39||s===0||s===29||a>=18&&a<=21&&s>=13&&s<=16||a>=6&&a<=8&&s>=8&&s<=10||a>=10&&a<=12&&s>=13&&s<=16||a>=6&&a<=8&&s>=19&&s<=21||a>=31&&a<=33&&s>=8&&s<=10||a>=27&&a<=29&&s>=13&&s<=16||a>=31&&a<=33&&s>=19&&s<=21||a>=15&&a<=17&&s===8||a>=22&&a<=24&&s===8||a>=15&&a<=17&&s===21||a>=22&&a<=24&&s===21?n.push(1):n.push(0);i.push(n)}const o={id:"neon_arena",name:"Neon Arena",width:40*32,height:30*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:80,y:240},team:g.Attackers,index:0},{position:{x:80,y:340},team:g.Attackers,index:1},{position:{x:80,y:440},team:g.Attackers,index:2},{position:{x:80,y:540},team:g.Attackers,index:3},{position:{x:1200,y:240},team:g.Defenders,index:0},{position:{x:1200,y:340},team:g.Defenders,index:1},{position:{x:1200,y:440},team:g.Defenders,index:2},{position:{x:1200,y:540},team:g.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new te(o)}function xs(){const i=[];for(let s=0;s<32;s++){const n=[];for(let a=0;a<45;a++)a===0||a===44||s===0||s===31||a>=2&&a<=6&&s>=2&&s<=6||a>=2&&a<=6&&s>=25&&s<=29||a>=38&&a<=42&&s>=2&&s<=6||a>=38&&a<=42&&s>=25&&s<=29||a>=28&&a<=30&&s>=4&&s<=8||a>=34&&a<=36&&s>=8&&s<=10||a>=28&&a<=30&&s>=23&&s<=27||a>=34&&a<=36&&s>=21&&s<=23||a>=14&&a<=16&&s>=12&&s<=14||a>=14&&a<=16&&s>=17&&s<=19||a>=20&&a<=24&&s>=13&&s<=18?n.push(1):n.push(0);i.push(n)}const o={id:"cyber_district",name:"Cyber District",width:45*32,height:32*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:80,y:300},team:g.Attackers,index:0},{position:{x:80,y:400},team:g.Attackers,index:1},{position:{x:80,y:500},team:g.Attackers,index:2},{position:{x:80,y:600},team:g.Attackers,index:3},{position:{x:45*32-100,y:200},team:g.Defenders,index:0},{position:{x:45*32-100,y:300},team:g.Defenders,index:1},{position:{x:45*32-100,y:700},team:g.Defenders,index:2},{position:{x:45*32-100,y:800},team:g.Defenders,index:3}],spikeSites:[{x:960,y:128,width:224,height:160},{x:960,y:32*32-288,width:224,height:160}],reactorPath:[],props:[]};return new te(o)}function Ss(){const i=[];for(let s=0;s<35;s++){const n=[];for(let a=0;a<50;a++)a===0||a===49||s===0||s===34||a>=3&&a<=10&&s===8||a>=3&&a<=10&&s===16||a===10&&s>=8&&s<=16||a>=3&&a<=10&&s===26||a>=3&&a<=10&&s===18||a===10&&s>=18&&s<=26||a>=18&&a<=20&&s>=10&&s<=12||a>=18&&a<=20&&s>=22&&s<=24||a>=29&&a<=31&&s>=10&&s<=12||a>=29&&a<=31&&s>=22&&s<=24||a>=22&&a<=27&&s>=15&&s<=19||a>=38&&a<=46&&s===5||a>=38&&a<=46&&s===12||a===38&&s>=5&&s<=12||a>=38&&a<=46&&s===29||a>=38&&a<=46&&s===22||a===38&&s>=22&&s<=29?n.push(1):n.push(0);i.push(n)}const o={id:"helix_labs",name:"Helix Labs",width:50*32,height:35*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:64,y:350},team:g.Attackers,index:0},{position:{x:64,y:450},team:g.Attackers,index:1},{position:{x:64,y:550},team:g.Attackers,index:2},{position:{x:64,y:650},team:g.Attackers,index:3},{position:{x:50*32-80,y:250},team:g.Defenders,index:0},{position:{x:50*32-80,y:350},team:g.Defenders,index:1},{position:{x:50*32-80,y:750},team:g.Defenders,index:2},{position:{x:50*32-80,y:850},team:g.Defenders,index:3}],spikeSites:[{x:1248,y:192,width:256,height:192},{x:1248,y:35*32-384,width:256,height:192}],reactorPath:[],props:[]};return new te(o)}function vs(){const i=Math.floor(19),o=Math.floor(38/2),s=[];for(let a=0;a<38;a++){const r=[];for(let c=0;c<38;c++){const d=c-i,h=a-o,m=Math.sqrt(d*d+h*h);if(c===0||c===37||a===0||a===37)r.push(1);else if(c<4&&a<4||c<4&&a>33||c>33&&a<4||c>33&&a>33)r.push(1);else if(m>=4&&m<=6){const p=(Math.atan2(h,d)+Math.PI)/(2*Math.PI)*360,w=p>=355||p<=5||p>=85&&p<=95||p>=175&&p<=185||p>=265&&p<=275;r.push(w?0:1)}else if(m>=10&&m<=11){const p=(Math.atan2(h,d)+Math.PI)/(2*Math.PI)*360,w=p>=40&&p<=50||p>=130&&p<=140||p>=220&&p<=230||p>=310&&p<=320;r.push(w?1:0)}else r.push(0)}s.push(r)}const n={id:"reactor_core",name:"Reactor Core",width:38*32,height:38*32,tileSize:32,tiles:s,spawnPoints:[{position:{x:100,y:o*32-80},team:g.Attackers,index:0},{position:{x:100,y:o*32},team:g.Attackers,index:1},{position:{x:100,y:o*32+80},team:g.Attackers,index:2},{position:{x:150,y:o*32+160},team:g.Attackers,index:3},{position:{x:38*32-100,y:o*32-80},team:g.Defenders,index:0},{position:{x:38*32-100,y:o*32},team:g.Defenders,index:1},{position:{x:38*32-100,y:o*32+80},team:g.Defenders,index:2},{position:{x:38*32-150,y:o*32+160},team:g.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new te(n)}function ks(){const i=[];for(let s=0;s<32;s++){const n=[];for(let a=0;a<42;a++)a===0||a===41||s===0||s===31?n.push(1):a%6===3&&s>2&&s<29?s>=7&&s<=9||s>=14&&s<=16||s>=22&&s<=24?n.push(0):n.push(1):s===7&&a>1&&a<40&&a%6!==0||s===16&&a>1&&a<40&&a%6!==3||s===24&&a>1&&a<40&&a%6!==0||a>=8&&a<=10&&s>=11&&s<=13||a>=20&&a<=22&&s>=11&&s<=13||a>=31&&a<=33&&s>=11&&s<=13||a>=14&&a<=16&&s>=19&&s<=21||a>=26&&a<=28&&s>=19&&s<=21?n.push(1):n.push(0);i.push(n)}const o={id:"grid_maze",name:"Grid Maze",width:42*32,height:32*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:64,y:150},team:g.Attackers,index:0},{position:{x:64,y:350},team:g.Attackers,index:1},{position:{x:64,y:550},team:g.Attackers,index:2},{position:{x:64,y:750},team:g.Attackers,index:3},{position:{x:42*32-64,y:150},team:g.Defenders,index:0},{position:{x:42*32-64,y:350},team:g.Defenders,index:1},{position:{x:42*32-64,y:550},team:g.Defenders,index:2},{position:{x:42*32-64,y:750},team:g.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new te(o)}function Ps(){const i=[];for(let s=0;s<36;s++){const n=[];for(let a=0;a<48;a++)a===0||a===47||s===0||s===35?n.push(1):s===8&&a>3&&a<44||s===27&&a>3&&a<44?a>=14&&a<=16||a>=31&&a<=33?n.push(0):n.push(1):a>=10&&a<=12&&s>=16&&s<=19||a>=22&&a<=25&&s>=15&&s<=20||a>=35&&a<=37&&s>=16&&s<=19||a>=38&&a<=44&&s===3||a===38&&s>=3&&s<=7||a>=38&&a<=44&&s===32||a===38&&s>=28&&s<=32||a===6&&(s>=10&&s<=14||s>=21&&s<=25)?n.push(1):n.push(0);i.push(n)}const o={id:"sky_bridge",name:"Sky Bridge",width:48*32,height:36*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:80,y:180},team:g.Attackers,index:0},{position:{x:80,y:400},team:g.Attackers,index:1},{position:{x:80,y:620},team:g.Attackers,index:2},{position:{x:80,y:900},team:g.Attackers,index:3},{position:{x:48*32-80,y:180},team:g.Defenders,index:0},{position:{x:48*32-80,y:400},team:g.Defenders,index:1},{position:{x:48*32-80,y:620},team:g.Defenders,index:2},{position:{x:48*32-80,y:900},team:g.Defenders,index:3}],spikeSites:[{x:1248,y:96,width:192,height:160},{x:1248,y:36*32-256,width:192,height:160}],reactorPath:[],props:[]};return new te(o)}function Cs(){const i=[];for(let s=0;s<34;s++){const n=[];for(let a=0;a<44;a++)a===0||a===43||s===0||s===33?n.push(1):a===24&&s>=4&&s<=29?s>=8&&s<=10||s>=16&&s<=17||s>=23&&s<=25?n.push(0):n.push(1):s===4&&a>=24&&a<43||s===29&&a>=24&&a<43?n.push(1):a===32&&s>=6&&s<=13?s>=9&&s<=10?n.push(0):n.push(1):a===32&&s>=20&&s<=27?s>=22&&s<=23?n.push(0):n.push(1):s===6&&a>=32&&a<=40||s===13&&a>=32&&a<=40||s===20&&a>=32&&a<=40||s===27&&a>=32&&a<=40||a>=6&&a<=8&&s>=8&&s<=11||a>=12&&a<=14&&s>=14&&s<=19||a>=6&&a<=8&&s>=22&&s<=25||a>=16&&a<=18&&s>=8&&s<=10||a>=16&&a<=18&&s>=23&&s<=25?n.push(1):n.push(0);i.push(n)}const o={id:"data_vault",name:"Data Vault",width:44*32,height:34*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:64,y:200},team:g.Attackers,index:0},{position:{x:64,y:400},team:g.Attackers,index:1},{position:{x:64,y:600},team:g.Attackers,index:2},{position:{x:64,y:800},team:g.Attackers,index:3},{position:{x:44*32-80,y:300},team:g.Defenders,index:0},{position:{x:44*32-80,y:450},team:g.Defenders,index:1},{position:{x:44*32-80,y:600},team:g.Defenders,index:2},{position:{x:44*32-80,y:750},team:g.Defenders,index:3}],spikeSites:[{x:1056,y:224,width:224,height:192},{x:1056,y:34*32-416,width:224,height:192}],reactorPath:[],props:[]};return new te(o)}function Is(){const i=[];for(let s=0;s<40;s++){const n=[];for(let a=0;a<36;a++)a===0||a===35||s===0||s===39||s===8&&a>=4&&a<=14||s===8&&a>=21&&a<=31?n.push(1):s===16&&a>=8&&a<=27?a>=16&&a<=19?n.push(0):n.push(1):s===24&&a>=4&&a<=31?a>=10&&a<=12||a>=23&&a<=25?n.push(0):n.push(1):s===32&&a>=8&&a<=27?a>=16&&a<=19?n.push(0):n.push(1):a===8&&s>=10&&s<=14||a===27&&s>=10&&s<=14||a===12&&s>=26&&s<=30||a===23&&s>=26&&s<=30||a>=15&&a<=20&&s>=18&&s<=22||a>=3&&a<=5&&s>=3&&s<=5||a>=30&&a<=32&&s>=3&&s<=5||a>=3&&a<=5&&s>=34&&s<=36||a>=30&&a<=32&&s>=34&&s<=36?n.push(1):n.push(0);i.push(n)}const o={id:"neon_tower",name:"Neon Tower",width:36*32,height:40*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:100,y:100},team:g.Attackers,index:0},{position:{x:200,y:100},team:g.Attackers,index:1},{position:{x:100,y:200},team:g.Attackers,index:2},{position:{x:200,y:200},team:g.Attackers,index:3},{position:{x:36*32-100,y:40*32-100},team:g.Defenders,index:0},{position:{x:36*32-200,y:40*32-100},team:g.Defenders,index:1},{position:{x:36*32-100,y:40*32-200},team:g.Defenders,index:2},{position:{x:36*32-200,y:40*32-200},team:g.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new te(o)}function Es(){const i=Math.floor(20),o=Math.floor(40/2),s=[];for(let a=0;a<40;a++){const r=[];for(let c=0;c<40;c++)c===0||c===39||a===0||a===39?r.push(1):c>=3&&c<=10&&a>=3&&a<=10?c===10&&a>=6&&a<=8||a===10&&c>=6&&c<=8?r.push(0):r.push(1):c>=29&&c<=36&&a>=3&&a<=10?c===29&&a>=6&&a<=8||a===10&&c>=31&&c<=33?r.push(0):r.push(1):c>=3&&c<=10&&a>=29&&a<=36?c===10&&a>=31&&a<=33||a===29&&c>=6&&c<=8?r.push(0):r.push(1):c>=29&&c<=36&&a>=29&&a<=36?c===29&&a>=31&&a<=33||a===29&&c>=31&&c<=33?r.push(0):r.push(1):c>=i-2&&c<=i+2&&a>=o-1&&a<=o+1||c>=i-1&&c<=i+1&&a>=o-2&&a<=o+2?r.push(1):r.push(0);s.push(r)}const n={id:"crossfire",name:"Crossfire",width:40*32,height:40*32,tileSize:32,tiles:s,spawnPoints:[{position:{x:64,y:o*32-50},team:g.Attackers,index:0},{position:{x:64,y:o*32+50},team:g.Attackers,index:1},{position:{x:100,y:o*32-100},team:g.Attackers,index:2},{position:{x:100,y:o*32+100},team:g.Attackers,index:3},{position:{x:40*32-64,y:o*32-50},team:g.Defenders,index:0},{position:{x:40*32-64,y:o*32+50},team:g.Defenders,index:1},{position:{x:40*32-100,y:o*32-100},team:g.Defenders,index:2},{position:{x:40*32-100,y:o*32+100},team:g.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new te(n)}function Ms(){const i=[];for(let s=0;s<32;s++){const n=[];for(let a=0;a<44;a++)a===0||a===43||s===0||s===31||s>=5&&s<=7&&(a>=8&&a<=10||a>=16&&a<=18||a>=24&&a<=26||a>=32&&a<=34)||s>=12&&s<=14&&(a>=5&&a<=7||a>=13&&a<=15||a>=21&&a<=23||a>=29&&a<=31||a>=37&&a<=39)||s>=19&&s<=21&&(a>=8&&a<=10||a>=16&&a<=18||a>=24&&a<=26||a>=32&&a<=34)||s>=26&&s<=28&&(a>=5&&a<=7||a>=13&&a<=15||a>=21&&a<=23||a>=29&&a<=31||a>=37&&a<=39)?n.push(1):n.push(0);i.push(n)}const o={id:"warehouse",name:"Warehouse",width:44*32,height:32*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:64,y:160},team:g.Attackers,index:0},{position:{x:64,y:320},team:g.Attackers,index:1},{position:{x:64,y:480},team:g.Attackers,index:2},{position:{x:64,y:640},team:g.Attackers,index:3},{position:{x:44*32-64,y:160},team:g.Defenders,index:0},{position:{x:44*32-64,y:320},team:g.Defenders,index:1},{position:{x:44*32-64,y:480},team:g.Defenders,index:2},{position:{x:44*32-64,y:640},team:g.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new te(o)}function As(){const i=[];for(let s=0;s<36;s++){const n=[];for(let a=0;a<48;a++)a===0||a===47||s===0||s===35?n.push(1):a===10&&s>=4&&s<=31?s>=10&&s<=12||s>=22&&s<=24?n.push(0):n.push(1):a===18&&s>=4&&s<=31||a===28&&s>=4&&s<=31?s>=15&&s<=19?n.push(0):n.push(1):a===36&&s>=4&&s<=31?s>=10&&s<=12||s>=22&&s<=24?n.push(0):n.push(1):s===5&&a>=38&&a<=44||a===38&&s>=5&&s<=12||s===30&&a>=38&&a<=44||a===38&&s>=23&&s<=30?n.push(1):n.push(0);i.push(n)}const o={id:"server_farm",name:"Server Farm",width:48*32,height:36*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:80,y:200},team:g.Attackers,index:0},{position:{x:80,y:400},team:g.Attackers,index:1},{position:{x:80,y:600},team:g.Attackers,index:2},{position:{x:80,y:800},team:g.Attackers,index:3},{position:{x:48*32-80,y:280},team:g.Defenders,index:0},{position:{x:48*32-80,y:450},team:g.Defenders,index:1},{position:{x:48*32-80,y:620},team:g.Defenders,index:2},{position:{x:48*32-80,y:790},team:g.Defenders,index:3}],spikeSites:[{x:1248,y:192,width:192,height:192},{x:1248,y:36*32-384,width:192,height:192}],reactorPath:[],props:[]};return new te(o)}function Ts(){const i=Math.floor(23),o=Math.floor(38/2),s=[];for(let a=0;a<38;a++){const r=[];for(let c=0;c<46;c++)c===0||c===45||a===0||a===37?r.push(1):c>=i-5&&c<=i+5&&(a===o-4||a===o+4)||a>=o-4&&a<=o+4&&(c===i-5||c===i+5)?a===o&&(c===i-5||c===i+5)||c===i&&(a===o-4||a===o+4)?r.push(0):r.push(1):c>=6&&c<=8&&a>=12&&a<=14||c>=6&&c<=8&&a>=23&&a<=25?r.push(1):c===32&&a>=4&&a<=12||a===4&&c>=32&&c<=42||a===12&&c>=32&&c<=42?c===32&&a>=7&&a<=9?r.push(0):r.push(1):c===32&&a>=25&&a<=33||a===33&&c>=32&&c<=42||a===25&&c>=32&&c<=42?c===32&&a>=28&&a<=30?r.push(0):r.push(1):r.push(0);s.push(r)}const n={id:"nexus_hub",name:"Nexus Hub",width:46*32,height:38*32,tileSize:32,tiles:s,spawnPoints:[{position:{x:80,y:300},team:g.Attackers,index:0},{position:{x:80,y:450},team:g.Attackers,index:1},{position:{x:80,y:600},team:g.Attackers,index:2},{position:{x:80,y:750},team:g.Attackers,index:3},{position:{x:46*32-80,y:250},team:g.Defenders,index:0},{position:{x:46*32-80,y:400},team:g.Defenders,index:1},{position:{x:46*32-80,y:700},team:g.Defenders,index:2},{position:{x:46*32-80,y:850},team:g.Defenders,index:3}],spikeSites:[{x:1056,y:160,width:288,height:224},{x:1056,y:38*32-384,width:288,height:224}],reactorPath:[],props:[]};return new te(n)}var q=(l=>(l.RuleBased="rule_based",l.SLM="slm",l))(q||{}),j=(l=>(l.Aggressive="aggressive",l.Defensive="defensive",l.Flanking="flanking",l.Supporting="supporting",l.Objective="objective",l.Retreating="retreating",l.Patrolling="patrolling",l))(j||{});const Ls={aggressionLevel:.6,reactionTime:200,accuracy:.6,patrolRadius:300,sightRange:500,attackRange:400};class Ds{type=q.RuleBased;player;config;state="patrol";currentContext=null;currentObjectives;targetPosition=null;patrolCenter;lastPatrolChange=0;patrolInterval=3e3;targetEnemy=null;lastSeenEnemy=0;lastStateChange=0;lastPosition;stuckTime=0;spikePosition=null;spikeSitePosition=null;followTarget=null;collisionWorld=null;nearbyBots=[];randomOffset;tacticalIntent=null;cachedVisibleEnemies=[];constructor(e,t={}){this.player=e,this.config={...Ls,...t},this.patrolCenter={...e.position},this.lastPosition={...e.position},this.randomOffset=Math.random()*1e3,this.patrolInterval=2e3+Math.random()*3e3}update(e){return this.currentContext=e,this.currentObjectives=e.objectives,this.collisionWorld=e.collisionWorld,this.updateInternal(e.dt,e.time,e.allPlayers,e.collisionWorld,e.map,e.objectives)}getPlayer(){return this.player}getStateInfo(){const e=this.currentContext?.map,t=this.player.abilities[1],i=this.player.abilities[2],o={botId:this.player.id,position:{...this.player.position},health:this.player.health,shield:this.player.shield,team:this.player.team===g.Attackers?"attackers":"defenders",isAlive:this.player.alive,ammo:this.player.weapon.ammo,maxAmmo:this.player.weapon.maxAmmo,isReloading:this.player.weapon.reloading,weaponName:this.player.weapon.weaponId,ability1Ready:t!==void 0&&t.charges>0,ability2Ready:i!==void 0&&i.charges>0,ultimateReady:this.player.ultimateCharge>=100,ultimateCharge:this.player.ultimateCharge,visibleEnemies:this.cachedVisibleEnemies.map(s=>({id:s.id,position:{...s.position},health:s.health,distance:f.distance(this.player.position,s.position)})),nearbyTeammates:this.nearbyBots.filter(s=>s.team===this.player.team).map(s=>({id:s.id,position:{...s.position},health:s.health,distance:f.distance(this.player.position,s.position)})),hasSpikeCarrier:this.currentObjectives?.spikeCarrierId===this.player.id,spikePlanted:this.currentObjectives?.spikePlanted||!1,inSpikeSite:e?e.isInSpikeSite(this.player.position)!==-1:!1,distanceToNearestWall:this.getDistanceToNearestWall(),currentZone:this.getCurrentZone()};return this.currentObjectives?.spikePosition&&(o.spikePosition=this.currentObjectives.spikePosition),o}setTacticalIntent(e){this.tacticalIntent=e,this.mapIntentToState(e)}getTacticalIntent(){return this.tacticalIntent}onRoundStart(){this.state="patrol",this.tacticalIntent=null,this.patrolCenter={...this.player.position},this.targetEnemy=null,this.followTarget=null}onRoundEnd(){this.tacticalIntent=null}dispose(){}getDistanceToNearestWall(){if(!this.collisionWorld)return 999;const e=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:.707,y:.707},{x:-.707,y:.707},{x:.707,y:-.707},{x:-.707,y:-.707}];let t=999;for(const i of e){const o=this.collisionWorld.raycast(this.player.position,i,200,D.WALL);o&&o.distance<t&&(t=o.distance)}return t}getCurrentZone(){const e=this.currentContext?.map;if(!e)return"unknown";const t=e.isInSpikeSite(this.player.position);if(t===0)return"site_a";if(t===1)return"site_b";const i=e.getWidth(),o=e.getHeight(),s=this.player.position.x/i,n=this.player.position.y/o;return s<.3?"left":s>.7?"right":n<.3?"top":n>.7?"bottom":"mid"}mapIntentToState(e){switch(e){case j.Aggressive:this.state="chase";break;case j.Retreating:this.state="retreat";break;case j.Defensive:this.state="patrol";break;case j.Flanking:this.state="patrol";break;case j.Supporting:this.state="follow";break;case j.Objective:this.player.team===g.Attackers?this.state="plant_spike":this.state="defuse";break;case j.Patrolling:default:this.state="patrol";break}}updateInternal(e,t,i,o,s,n){this.collisionWorld=o,this.checkStuck(e);const a=i.filter(m=>m.team!==this.player.team&&m.alive),r=i.filter(m=>m.team===this.player.team&&m.alive&&m.id!==this.player.id);this.nearbyBots=i.filter(m=>m.alive&&m.id!==this.player.id&&f.distance(this.player.position,m.position)<80);const c=this.findVisibleEnemies(a,o);this.cachedVisibleEnemies=c,this.findFollowTarget(r,n);const d=this.checkSpikeState(n);d?this.setState(d,t):c.length===0&&this.followTarget&&this.player.team===g.Attackers?this.setState("follow",t):this.updateState(t,c);const h=this.generateInput(t,c,o);return this.lastPosition={...this.player.position},h}findFollowTarget(e,t){if(e.length===0){this.followTarget=null;return}if(t?.spikeCarrierId){const s=e.find(n=>n.id===t.spikeCarrierId);if(s){this.followTarget=s;return}}let i=null,o=1/0;for(const s of e){const n=f.distance(this.player.position,s.position);n<o&&(o=n,i=s)}this.followTarget=i}checkStuck(e){f.distance(this.player.position,this.lastPosition)<1?(this.stuckTime+=e,this.stuckTime>1e3&&(this.targetPosition=this.getRandomPatrolPoint(),this.stuckTime=0)):this.stuckTime=0}findVisibleEnemies(e,t){const i=[];for(const o of e){if(!o.alive||o.team===this.player.team||o.isInvisible)continue;const s=f.distance(this.player.position,o.position);if(s>this.config.sightRange)continue;const n=f.normalize(f.sub(o.position,this.player.position)),a=t.raycast(this.player.position,n,s,D.WALL);a&&a.distance<s-20||i.push(o)}return i}updateState(e,t){const i=e-this.lastStateChange;t.length>0?(t.sort((s,n)=>f.distance(this.player.position,s.position)-f.distance(this.player.position,n.position)),this.targetEnemy=t[0],this.lastSeenEnemy=e,f.distance(this.player.position,this.targetEnemy.position)<=this.config.attackRange?this.player.health<30&&this.config.aggressionLevel<.8?this.setState("retreat",e):this.setState("attack",e):this.config.aggressionLevel>.4?this.setState("chase",e):this.setState("attack",e)):(this.targetEnemy=null,e-this.lastSeenEnemy<2e3||i>2e3&&this.setState("patrol",e))}setState(e,t){this.state!==e&&(this.state=e,this.lastStateChange=t)}generateInput(e,t,i){const o={moveX:0,moveY:0,aimX:this.player.position.x+Math.cos(this.player.rotation)*100,aimY:this.player.position.y+Math.sin(this.player.rotation)*100,shoot:!1,reload:!1,interact:!1,throwGrenade:!1,useBombCall:!1,useMissileStrike:!1,ability1:!1,ability2:!1,ultimate:!1,weaponSlot:0,sequence:0};switch(this.state){case"patrol":this.doPatrol(e,o);break;case"chase":this.doChase(o);break;case"attack":this.doAttack(e,o,t);break;case"retreat":this.doRetreat(o);break;case"defuse":this.doDefuse(o,this.spikePosition);break;case"plant_spike":this.doPlantSpike(o,this.spikeSitePosition);break;case"follow":this.doFollow(o);break}return this.player.weapon.ammo===0&&!this.player.weapon.reloading&&(o.reload=!0),this.applySeparation(o),o}applySeparation(e){if(this.nearbyBots.length===0)return;let t=0,i=0;for(const o of this.nearbyBots){const s=f.distance(this.player.position,o.position);if(s<5)continue;const n=f.normalize(f.sub(this.player.position,o.position)),a=Math.max(0,(80-s)/80);t+=n.x*a,i+=n.y*a}if(t!==0||i!==0){const o=Math.sqrt(t*t+i*i);if(o>0){e.moveX+=t/o*.5,e.moveY+=i/o*.5;const n=Math.sqrt(e.moveX*e.moveX+e.moveY*e.moveY);n>1&&(e.moveX/=n,e.moveY/=n)}}}doPatrol(e,t){if((!this.targetPosition||e-this.lastPatrolChange>this.patrolInterval)&&(this.targetPosition=this.getRandomPatrolPoint(),this.lastPatrolChange=e),this.moveToward(this.targetPosition,t),t.moveX!==0||t.moveY!==0){const i=Math.atan2(t.moveY,t.moveX);t.aimX=this.player.position.x+Math.cos(i)*100,t.aimY=this.player.position.y+Math.sin(i)*100}}doChase(e){this.targetEnemy&&(this.moveToward(this.targetEnemy.position,e),e.aimX=this.targetEnemy.position.x,e.aimY=this.targetEnemy.position.y)}doAttack(e,t,i){if(!this.targetEnemy||i.length===0)return;const o=f.distance(this.player.position,this.targetEnemy.position),s=Math.sin(e/500)*.7,n=f.normalize(f.sub(this.targetEnemy.position,this.player.position)),a={x:-n.y,y:n.x};t.moveX=a.x*s,t.moveY=a.y*s,o>this.config.attackRange*.8?(t.moveX+=n.x*.5,t.moveY+=n.y*.5):o<100&&(t.moveX-=n.x*.5,t.moveY-=n.y*.5);const r=Math.sqrt(t.moveX*t.moveX+t.moveY*t.moveY);r>1&&(t.moveX/=r,t.moveY/=r);const c=(1-this.config.accuracy)*50;t.aimX=this.targetEnemy.position.x+(Math.random()-.5)*c,t.aimY=this.targetEnemy.position.y+(Math.random()-.5)*c,!this.player.weapon.reloading&&this.player.weapon.ammo>0&&e-this.lastSeenEnemy>this.config.reactionTime&&(t.shoot=!0)}doRetreat(e){if(!this.targetEnemy)this.moveToward(this.patrolCenter,e);else{const t=f.normalize(f.sub(this.player.position,this.targetEnemy.position));e.moveX=t.x,e.moveY=t.y,e.aimX=this.targetEnemy.position.x,e.aimY=this.targetEnemy.position.y,!this.player.weapon.reloading&&this.player.weapon.ammo>0&&(e.shoot=!0)}}moveToward(e,t){const i=f.sub(e,this.player.position);if(f.length(i)>10){let s=f.normalize(i);if(this.collisionWorld){const a=this.collisionWorld.raycast(this.player.position,s,50,D.WALL);if(a&&a.distance<50){const r={x:-s.y,y:s.x},c={x:s.y,y:-s.x},d=this.collisionWorld.raycast(this.player.position,r,50,D.WALL),h=this.collisionWorld.raycast(this.player.position,c,50,D.WALL),m=d?d.distance:50,u=h?h.distance:50;m>u&&m>20?s=f.normalize({x:s.x*.3+r.x*.7,y:s.y*.3+r.y*.7}):u>20&&(s=f.normalize({x:s.x*.3+c.x*.7,y:s.y*.3+c.y*.7}))}}t.moveX=s.x,t.moveY=s.y}}getRandomPatrolPoint(){const e=Date.now()+this.randomOffset,t=(Math.random()+e%1e3/1e3)*Math.PI*2,i=(Math.random()*.5+.5)*this.config.patrolRadius,o=(this.player.id.charCodeAt(0)+this.player.id.charCodeAt(this.player.id.length-1))%360,s=t+o*Math.PI/180;return{x:this.patrolCenter.x+Math.cos(s)*i,y:this.patrolCenter.y+Math.sin(s)*i}}checkSpikeState(e){if(!e)return null;if(this.player.team===g.Defenders&&e.spikePlanted&&e.spikePosition){const t=f.distance(this.player.position,e.spikePosition);if(this.spikePosition=e.spikePosition,t<=60||t>60&&(!this.targetEnemy||f.distance(this.player.position,this.targetEnemy.position)>150))return"defuse"}return this.player.team===g.Attackers&&e.spikeCarrierId===this.player.id?(this.spikeSitePosition={x:600,y:400},"plant_spike"):null}doDefuse(e,t){if(!t)return;f.distance(this.player.position,t)>50?(this.moveToward(t,e),e.aimX=t.x,e.aimY=t.y):(e.interact=!0,e.moveX=0,e.moveY=0,e.aimX=t.x+Math.cos(Date.now()/500)*100,e.aimY=t.y+Math.sin(Date.now()/500)*100)}doPlantSpike(e,t){if(!t)return;if(f.distance(this.player.position,t)>80){this.moveToward(t,e);const o=f.normalize(f.sub(t,this.player.position));e.aimX=this.player.position.x+o.x*100,e.aimY=this.player.position.y+o.y*100}else e.interact=!0,e.moveX=0,e.moveY=0}doFollow(e){if(!this.followTarget)return;if(f.distance(this.player.position,this.followTarget.position)>120){const i=f.normalize(f.sub(this.followTarget.position,this.player.position)),o=(this.player.id.charCodeAt(0)%3-1)*.3,s={x:-i.y*o,y:i.x*o};e.moveX=i.x+s.x,e.moveY=i.y+s.y;const n=Math.sqrt(e.moveX*e.moveX+e.moveY*e.moveY);n>1&&(e.moveX/=n,e.moveY/=n),e.aimX=this.player.position.x+i.x*100,e.aimY=this.player.position.y+i.y*100}else{e.moveX=0,e.moveY=0;const i={x:Math.cos(this.followTarget.rotation),y:Math.sin(this.followTarget.rotation)};e.aimX=this.player.position.x+i.x*100,e.aimY=this.player.position.y+i.y*100}}}class Rs{type=q.SLM;player;tacticalIntent=j.Defensive;constructor(e){this.player=e,console.log(`[SLMBotController] Created for player ${e.id} (stub mode)`)}update(e){return this.generateFallbackInput(e)}getPlayer(){return this.player}getStateInfo(){return{botId:this.player.id,position:{...this.player.position},health:this.player.health,shield:this.player.shield,team:this.player.team===g.Attackers?"attackers":"defenders",isAlive:this.player.alive,ammo:this.player.weapon.ammo,maxAmmo:this.player.weapon.maxAmmo,isReloading:this.player.weapon.reloading,weaponName:this.player.weapon.weaponId,ability1Ready:!1,ability2Ready:!1,ultimateReady:this.player.ultimateCharge>=100,ultimateCharge:this.player.ultimateCharge,visibleEnemies:[],nearbyTeammates:[],hasSpikeCarrier:!1,spikePlanted:!1,inSpikeSite:!1,distanceToNearestWall:0,currentZone:"unknown"}}setTacticalIntent(e){this.tacticalIntent=e}getTacticalIntent(){return this.tacticalIntent}destroy(){console.log(`[SLMBotController] Destroyed for player ${this.player.id}`)}async initializeSLM(){return console.log("[SLMBotController] SLM initialization not yet implemented"),!1}async querySLM(e){return j.Defensive}formatPrompt(e){return JSON.stringify({pos:[Math.round(e.position.x),Math.round(e.position.y)],hp:e.health,team:e.team==="attackers"?"a":"d",ammo:e.ammo,enemies:e.visibleEnemies.length,spike:e.hasSpikeCarrier?"carry":e.spikePlanted?"planted":"none"})}parseResponse(e){const t=e.toLowerCase().trim();return t.includes("attack")||t.includes("aggress")?j.Aggressive:t.includes("defend")||t.includes("hold")?j.Defensive:t.includes("flank")?j.Flanking:t.includes("support")||t.includes("follow")?j.Supporting:t.includes("plant")||t.includes("defuse")||t.includes("objective")?j.Objective:j.Defensive}generateFallbackInput(e){const t=e.time;return{moveX:0,moveY:0,aimX:this.player.position.x+Math.cos(t*.001)*100,aimY:this.player.position.y+Math.sin(t*.001)*100,shoot:!1,reload:!1,throwGrenade:!1,useBombCall:!1,useMissileStrike:!1,ability1:!1,ability2:!1,ultimate:!1,interact:!1,weaponSlot:0,sequence:0}}}class pt{static currentMode=q.RuleBased;static slmAvailable=!1;static create(e,t){return this.currentMode===q.SLM&&this.slmAvailable?new Rs(e):(this.currentMode===q.SLM&&console.warn("[BotControllerFactory] SLM not available, falling back to rule-based"),new Ds(e,t))}static getMode(){return this.currentMode}static setMode(e){console.log(`[BotControllerFactory] AI mode set to: ${e}`),this.currentMode=e}static isSLMAvailable(){return this.slmAvailable}static setSLMAvailable(e){this.slmAvailable=e,console.log(`[BotControllerFactory] SLM availability: ${e}`)}static getModeName(){switch(this.currentMode){case q.SLM:return"SLM (AI Language Model)";case q.RuleBased:default:return"Rule-Based (Classic)"}}static cycleMode(){return this.currentMode===q.RuleBased&&this.slmAvailable?this.currentMode=q.SLM:this.currentMode=q.RuleBased,console.log(`[BotControllerFactory] Cycled to: ${this.getModeName()}`),this.currentMode}}var L=(l=>(l.Poison="poison",l.Burn="burn",l.Bleed="bleed",l.Regen="regen",l.HealBurst="heal_burst",l.Stun="stun",l.Slow="slow",l.Root="root",l.Silence="silence",l.Blind="blind",l.Shield="shield",l.DamageReduction="damage_reduction",l.Immunity="immunity",l.FrontShield="front_shield",l.DamageBoost="damage_boost",l.FireRateBoost="fire_rate_boost",l.CritBoost="crit_boost",l.SpeedBoost="speed_boost",l.SpeedReduction="speed_reduction",l.Cloak="cloak",l.Revealed="revealed",l.Marked="marked",l.Invulnerable="invulnerable",l.Phased="phased",l))(L||{});const Ke={poison:{type:"poison",category:"debuff",stackBehavior:"stack",maxStacks:5,priority:10,cleansable:!0,dispellable:!0},burn:{type:"burn",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:10,cleansable:!0,dispellable:!0},bleed:{type:"bleed",category:"debuff",stackBehavior:"stack",maxStacks:3,priority:10,cleansable:!1,dispellable:!0},regen:{type:"regen",category:"buff",stackBehavior:"replace",maxStacks:1,priority:5,cleansable:!1,dispellable:!0},heal_burst:{type:"heal_burst",category:"buff",stackBehavior:"none",maxStacks:1,priority:100,cleansable:!1,dispellable:!1},stun:{type:"stun",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:90,cleansable:!0,dispellable:!0},slow:{type:"slow",category:"debuff",stackBehavior:"replace",maxStacks:1,priority:50,cleansable:!0,dispellable:!0},root:{type:"root",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:85,cleansable:!0,dispellable:!0},silence:{type:"silence",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:80,cleansable:!0,dispellable:!0},blind:{type:"blind",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:60,cleansable:!0,dispellable:!0},shield:{type:"shield",category:"buff",stackBehavior:"replace",maxStacks:1,priority:95,cleansable:!1,dispellable:!0},damage_reduction:{type:"damage_reduction",category:"buff",stackBehavior:"replace",maxStacks:1,priority:94,cleansable:!1,dispellable:!0},immunity:{type:"immunity",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:99,cleansable:!1,dispellable:!1},front_shield:{type:"front_shield",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:93,cleansable:!1,dispellable:!0},damage_boost:{type:"damage_boost",category:"buff",stackBehavior:"replace",maxStacks:1,priority:40,cleansable:!1,dispellable:!0},fire_rate_boost:{type:"fire_rate_boost",category:"buff",stackBehavior:"replace",maxStacks:1,priority:40,cleansable:!1,dispellable:!0},crit_boost:{type:"crit_boost",category:"buff",stackBehavior:"replace",maxStacks:1,priority:40,cleansable:!1,dispellable:!0},speed_boost:{type:"speed_boost",category:"buff",stackBehavior:"replace",maxStacks:1,priority:50,cleansable:!1,dispellable:!0},speed_reduction:{type:"speed_reduction",category:"debuff",stackBehavior:"replace",maxStacks:1,priority:50,cleansable:!0,dispellable:!0},cloak:{type:"cloak",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:70,cleansable:!1,dispellable:!0},revealed:{type:"revealed",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:75,cleansable:!1,dispellable:!1},marked:{type:"marked",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:30,cleansable:!0,dispellable:!0},invulnerable:{type:"invulnerable",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:100,cleansable:!1,dispellable:!1},phased:{type:"phased",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:60,cleansable:!1,dispellable:!1}};var le=(l=>(l.PoisonCloud="poison_cloud",l.FireZone="fire_zone",l.HealingField="healing_field",l.SlowField="slow_field",l.ShieldDome="shield_dome",l.StunZone="stun_zone",l))(le||{});class Bs{activeEffects=new Map;zoneEffects=[];onEffectApplied=null;onEffectRemoved=null;onEffectTick=null;onZoneTick=null;constructor(e){e&&(this.onEffectApplied=e.onEffectApplied??null,this.onEffectRemoved=e.onEffectRemoved??null,this.onEffectTick=e.onEffectTick??null,this.onZoneTick=e.onZoneTick??null)}applyEffect(e,t,i,o,s,n=0,a){const r=Ke[e];if(!r)return null;let c=this.activeEffects.get(i);c||(c=[],this.activeEffects.set(i,c));const d=c.findIndex(u=>u.type===e),h=d>=0?c[d]:null;switch(r.stackBehavior){case"none":if(h)return null;break;case"refresh":if(h)return h.startTime=Date.now(),h.duration=o,s>h.value&&(h.value=s),h;break;case"stack":if(h)return h.stacks<r.maxStacks&&(h.stacks++,h.startTime=Date.now(),h.duration=o),h;break;case"replace":if(h)return s>=h.value&&(h.value=s,h.startTime=Date.now(),h.duration=o,h.sourceId=t),h;break;case"separate":const u=c.find(p=>p.type===e&&p.sourceId===t);if(u)return u.startTime=Date.now(),u.duration=o,u.value=s,u;break}const m={id:K("effect"),type:e,sourceId:t,targetId:i,startTime:Date.now(),duration:o,value:s,stacks:1,tickInterval:n,lastTickTime:Date.now(),data:a??null};return c.push(m),this.resolveConflicts(i),this.onEffectApplied?.(m),m}resolveConflicts(e){const t=this.activeEffects.get(e);if(!t)return;if(t.some(s=>s.type==="revealed")){const s=t.findIndex(n=>n.type==="cloak");if(s>=0){const n=t.splice(s,1)[0];n&&this.onEffectRemoved?.(n)}}if(t.some(s=>s.type==="immunity"||s.type==="invulnerable"))for(let s=t.length-1;s>=0;s--){const n=t[s];if(Ke[n.type].category==="debuff"){const r=t.splice(s,1)[0];r&&this.onEffectRemoved?.(r)}}}removeEffect(e,t){const i=this.activeEffects.get(e);if(!i)return!1;const o=i.findIndex(n=>n.id===t);if(o<0)return!1;const s=i.splice(o,1)[0];return s&&this.onEffectRemoved?.(s),!0}removeEffectsByType(e,t){const i=this.activeEffects.get(e);if(!i)return 0;let o=0;for(let s=i.length-1;s>=0;s--)if(i[s].type===t){const n=i.splice(s,1)[0];n&&(this.onEffectRemoved?.(n),o++)}return o}removeAllEffects(e){const t=this.activeEffects.get(e);if(t){for(const i of t)this.onEffectRemoved?.(i);this.activeEffects.delete(e)}}cleanse(e){const t=this.activeEffects.get(e);if(!t)return 0;let i=0;for(let o=t.length-1;o>=0;o--){const s=t[o];if(Ke[s.type].cleansable){const a=t.splice(o,1)[0];a&&(this.onEffectRemoved?.(a),i++)}}return i}dispel(e){const t=this.activeEffects.get(e);if(!t)return 0;let i=0;for(let o=t.length-1;o>=0;o--){const s=t[o];if(Ke[s.type].dispellable){const a=t.splice(o,1)[0];a&&(this.onEffectRemoved?.(a),i++)}}return i}createZone(e,t,i,o,s,n,a,r,c,d){const h={id:K("zone"),type:e,sourceId:t,position:{...i},radius:o,startTime:Date.now(),duration:s,tickInterval:n,lastTickTime:Date.now(),value:a,affectsAllies:r,affectsEnemies:c,visualType:d};return this.zoneEffects.push(h),h}removeZone(e){const t=this.zoneEffects.findIndex(i=>i.id===e);return t<0?!1:(this.zoneEffects.splice(t,1),!0)}getZones(){return[...this.zoneEffects]}hasEffect(e,t){return this.activeEffects.get(e)?.some(o=>o.type===t)??!1}getEffect(e,t){return this.activeEffects.get(e)?.find(o=>o.type===t)}getEffects(e){return this.activeEffects.get(e)??[]}getEffectsByCategory(e,t){const i=this.activeEffects.get(e);return i?i.filter(o=>Ke[o.type].category===t):[]}getSpeedModifier(e){const t=this.activeEffects.get(e);if(!t)return 1;let i=1;for(const o of t)switch(o.type){case"speed_boost":i*=1+o.value/100;break;case"speed_reduction":case"slow":i*=1-o.value/100;break;case"root":case"stun":i=0;break}return Math.max(0,i)}getDamageModifier(e){const t=this.activeEffects.get(e);if(!t)return 1;let i=1;for(const o of t)o.type==="damage_boost"&&(i*=1+o.value/100);return i}getDamageReduction(e){const t=this.activeEffects.get(e);if(!t)return 0;let i=0;for(const o of t)if(o.type==="damage_reduction"&&(i=Math.max(i,o.value)),o.type==="immunity"||o.type==="invulnerable")return 100;return i}getFireRateModifier(e){const t=this.activeEffects.get(e);if(!t)return 1;let i=1;for(const o of t)o.type==="fire_rate_boost"&&(i*=1+o.value/100),o.type==="stun"&&(i=0);return i}isStunned(e){return this.hasEffect(e,"stun")}isRooted(e){return this.hasEffect(e,"root")}isSilenced(e){return this.hasEffect(e,"silence")}isCloaked(e){return this.hasEffect(e,"cloak")&&!this.hasEffect(e,"revealed")}isPhased(e){return this.hasEffect(e,"phased")}isInvulnerable(e){return this.hasEffect(e,"invulnerable")||this.hasEffect(e,"immunity")}update(e,t){const i=Date.now();for(const[o,s]of this.activeEffects){for(let n=s.length-1;n>=0;n--){const a=s[n];if(a.duration>0&&i>=a.startTime+a.duration){const r=s.splice(n,1)[0];r&&this.onEffectRemoved?.(r);continue}if(a.tickInterval>0&&i>=a.lastTickTime+a.tickInterval){a.lastTickTime=i;const r=a.value*a.stacks;this.onEffectTick?.(a,r)}}s.length===0&&this.activeEffects.delete(o)}for(let o=this.zoneEffects.length-1;o>=0;o--){const s=this.zoneEffects[o];if(i>=s.startTime+s.duration){this.zoneEffects.splice(o,1);continue}if(i>=s.lastTickTime+s.tickInterval){s.lastTickTime=i;const n=t(s.position,s.radius);n.length>0&&this.onZoneTick?.(s,n)}}}getState(){return{effects:new Map(this.activeEffects),zones:[...this.zoneEffects]}}setState(e){this.activeEffects=new Map(e.effects),this.zoneEffects=[...e.zones]}clear(){this.activeEffects.clear(),this.zoneEffects=[]}}const _s=32;function H(l){return l*_s}const J={SHORT:H(3),MEDIUM:H(5),VERY_LONG:H(12),BLINK:H(3),REVEAL:H(5),HEAL_BURST:H(4),SHOCKWAVE:H(4),GRENADE:H(6),TURRET_RANGE:H(5),POISON_CLOUD:H(3),DOME_SHIELD:H(4)};var V=(l=>(l.Blink="blink",l.BlinkTrail="blink_trail",l.Shockwave="shockwave",l.Shield="shield",l.DomeShield="dome_shield",l.BarrierWall="barrier_wall",l.Cloak="cloak",l.Reveal="reveal",l.HealBurst="heal_burst",l.HealingField="healing_field",l.PoisonCloud="poison_cloud",l.Grenade="grenade",l.Explosion="explosion",l.TurretSpawn="turret_spawn",l.DashSlash="dash_slash",l.MinigunMode="minigun_mode",l))(V||{});class $s{effectSystem;turrets=new Map;activeMiniguns=new Map;getEnemies;getAllies;getTime;raycast;constructor(e,t){this.effectSystem=e,this.getEnemies=t.getEnemies,this.getAllies=t.getAllies,this.getTime=t.getTime,this.raycast=t.raycast}executeAbility(e,t){if(this.effectSystem.isSilenced(e.id))return{success:!1,effectsApplied:[]};switch(e.heroId){case M.Katana:return this.executePhantomAbility(e,t);case M.Vanta:return this.executeTitanAbility(e,t);case M.Spectre:return this.executeSpectreAbility(e,t);case M.Mira:return this.executeMedicAbility(e,t);case M.Spark:return this.executeHavocAbility(e,t);case M.Byte:return this.executeCipherAbility(e,t);case M.Glyph:return this.executeVenomAbility(e,t);case M.Zero:return this.executeAegisAbility(e,t);default:return{success:!1,effectsApplied:[]}}}executePhantomAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=J.BLINK,s=f.fromAngle(e.rotation),n=f.add(e.position,f.mul(s,o)),a=this.raycast(e.position,s,o,[e.id]),r=a?f.sub(a.point,f.mul(s,20)):n;i.teleportTo=r,i.visualEffects.push({type:"blink",position:e.position,duration:300},{type:"blink",position:r,duration:300},{type:"blink_trail",position:e.position,targetPosition:r,duration:200}),i.success=!0}break;case 2:this.effectSystem.applyEffect(L.Cloak,e.id,e.id,4e3,100),i.effectsApplied.push("cloak"),i.visualEffects.push({type:"cloak",position:e.position,duration:4e3}),i.success=!0;break;case 3:{const o=this.getEnemies(e.team).filter(a=>a.alive);if(o.length===0)break;let s=null,n=1/0;for(const a of o){const r=f.distance(e.position,a.position);r<n&&r<H(10)&&(n=r,s=a)}if(s){const a=f.fromAngle(s.rotation+Math.PI),r=f.add(s.position,f.mul(a,40));i.teleportTo=r,i.damage=75,i.targetIds=[s.id],i.visualEffects.push({type:"blink",position:e.position,duration:300},{type:"dash_slash",position:r,direction:s.rotation,duration:500}),i.success=!0}}break}return i}executeTitanAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:this.effectSystem.applyEffect(L.FrontShield,e.id,e.id,3e3,80),i.effectsApplied.push("front_shield"),i.visualEffects.push({type:"barrier_wall",position:{...e.position},direction:e.rotation,duration:3e3,color:"#0ce5f0",followPlayerId:e.id}),i.success=!0;break;case 2:{const o=J.SHOCKWAVE,s=30,n=1500,a=this.getEnemies(e.team).filter(c=>c.alive),r=[];for(const c of a)f.distance(e.position,c.position)<=o&&(this.effectSystem.applyEffect(L.Stun,e.id,c.id,n,100),r.push(c.id));i.damage=s,i.targetIds=r,i.effectsApplied.push("stun"),i.visualEffects.push({type:"shockwave",position:e.position,radius:o,duration:500}),i.success=!0}break;case 3:this.effectSystem.applyEffect(L.DamageReduction,e.id,e.id,5e3,40),this.effectSystem.applyEffect(L.FireRateBoost,e.id,e.id,5e3,40),i.effectsApplied.push("damage_reduction","fire_rate_boost"),i.visualEffects.push({type:"shield",position:e.position,duration:5e3,color:"#ff0000"}),i.success=!0;break}return i}executeSpectreAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:this.effectSystem.applyEffect(L.Cloak,e.id,e.id,2e3,100),i.effectsApplied.push("cloak"),i.visualEffects.push({type:"cloak",position:e.position,duration:2e3}),i.success=!0;break;case 2:{const o=J.REVEAL,s=3e3,n=this.getEnemies(e.team).filter(r=>r.alive),a=[];for(const r of n)f.distance(e.position,r.position)<=o&&(this.effectSystem.applyEffect(L.Revealed,e.id,r.id,s,100),a.push(r.id));i.targetIds=a,i.effectsApplied.push("revealed"),i.visualEffects.push({type:"reveal",position:e.position,radius:o,duration:500}),i.success=!0}break;case 3:{const o=this.getEnemies(e.team).filter(a=>a.alive);if(o.length===0)break;let s=null,n=1/0;for(const a of o){const r=f.distance(e.position,a.position);r<n&&(n=r,s=a)}if(s){const a=f.fromAngle(s.rotation+Math.PI),r=f.add(s.position,f.mul(a,50));i.teleportTo=r,i.visualEffects.push({type:"blink",position:e.position,duration:300},{type:"blink",position:r,duration:300}),i.success=!0}}break}return i}executeMedicAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=H(3),s=4e3;this.effectSystem.createZone(L.Regen,e.id,e.position,o,s,500,10,!0,!1,le.HealingField),i.zones=[{id:K("zone"),type:le.HealingField,position:{...e.position},radius:o,duration:s}],i.visualEffects.push({type:"healing_field",position:e.position,radius:o,duration:s,color:"#00ff88"}),i.success=!0}break;case 2:{const o=J.HEAL_BURST,s=30,n=3e3,a=this.getAllies(e.team,e.id).filter(c=>c.alive),r=[];for(const c of a)f.distance(e.position,c.position)<=o&&(this.effectSystem.applyEffect(L.Shield,e.id,c.id,n,s),r.push(c.id));this.effectSystem.applyEffect(L.Shield,e.id,e.id,n,s),i.targetIds=r,i.effectsApplied.push("shield"),i.visualEffects.push({type:"heal_burst",position:e.position,radius:o,duration:500,color:"#00aaff"}),i.success=!0}break;case 3:{const o=this.getAllies(e.team,e.id).filter(a=>!a.alive);if(o.length===0)break;let s=null,n=H(5);for(const a of o){const r=f.distance(e.position,a.position);r<n&&(n=r,s=a)}s&&(i.targetIds=[s.id],i.healing=s.maxHealth*.5,i.effectsApplied.push("revive"),i.visualEffects.push({type:"heal_burst",position:s.position,duration:1e3,color:"#ffff00"}),i.success=!0)}break}return i}executeHavocAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=J.GRENADE,s=f.fromAngle(e.rotation),n=f.add(e.position,f.mul(s,o)),a=this.raycast(e.position,s,o,[e.id]),r=a?a.point:n,c=H(2),d=4e3;this.effectSystem.createZone(L.Burn,e.id,r,c,d,500,15,!1,!0,le.FireZone),i.zones=[{id:K("zone"),type:le.FireZone,position:r,radius:c,duration:d}],i.visualEffects.push({type:"grenade",position:e.position,targetPosition:r,duration:500},{type:"explosion",position:r,radius:c,duration:300}),i.success=!0}break;case 2:{const o=H(4),s=this.getEnemies(e.team).filter(n=>n.alive);for(const n of s)f.distance(e.position,n.position)<=o&&(this.effectSystem.removeEffectsByType(n.id,L.Cloak),this.effectSystem.applyEffect(L.Revealed,e.id,n.id,2e3,100));i.effectsApplied.push("revealed"),i.visualEffects.push({type:"shockwave",position:e.position,radius:o,duration:300,color:"#ff8800"}),i.success=!0}break;case 3:{const o=H(5),s=60,n=this.getEnemies(e.team).filter(r=>r.alive),a=[];for(const r of n)f.distance(e.position,r.position)<=o&&(this.effectSystem.applyEffect(L.Burn,e.id,r.id,3e3,10,500),a.push(r.id));i.damage=s,i.targetIds=a,i.effectsApplied.push("burn"),i.visualEffects.push({type:"explosion",position:e.position,radius:o,duration:800,color:"#ff4400"}),i.success=!0}break}return i}executeCipherAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=H(4),s=1500,n=this.getEnemies(e.team).filter(r=>r.alive),a=[];for(const r of n)f.distance(e.position,r.position)<=o&&(this.effectSystem.applyEffect(L.Silence,e.id,r.id,s,100),this.effectSystem.applyEffect(L.Slow,e.id,r.id,s,30),a.push(r.id));i.targetIds=a,i.effectsApplied.push("silence","slow"),i.visualEffects.push({type:"shockwave",position:e.position,radius:o,duration:400,color:"#00ffff"}),i.success=!0}break;case 2:{const o=f.fromAngle(e.rotation),s=f.add(e.position,f.mul(o,60)),n=H(2),a=5e3;this.effectSystem.createZone(L.Slow,e.id,s,n,a,500,40,!1,!0,le.SlowField),i.zones=[{id:K("zone"),type:le.SlowField,position:s,radius:n,duration:a}],i.visualEffects.push({type:"turret_spawn",position:s,duration:300,color:"#00aaff"}),i.success=!0}break;case 3:{const o=f.fromAngle(e.rotation),s=f.add(e.position,f.mul(o,50)),n={id:K("turret"),ownerId:e.id,ownerTeam:e.team,position:s,rotation:e.rotation,health:100,maxHealth:100,range:J.TURRET_RANGE,damage:20,fireRate:1e3,lastFireTime:0,spawnTime:this.getTime(),duration:1e4,targetId:null};this.turrets.set(n.id,n),i.visualEffects.push({type:"turret_spawn",position:s,duration:500}),i.success=!0}break}return i}executeVenomAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=J.MEDIUM,s=f.fromAngle(e.rotation),n=this.getEnemies(e.team).filter(r=>r.alive);let a=null;for(const r of n){const c=f.sub(r.position,e.position);if(f.length(c)>o)continue;if(f.dot(f.normalize(c),s)>.9){a=r;break}}a&&(this.effectSystem.applyEffect(L.Poison,e.id,a.id,3e3,8,500),i.targetIds=[a.id],i.effectsApplied.push("poison")),i.visualEffects.push({type:"dash_slash",position:e.position,direction:e.rotation,duration:300,color:"#00ff00"}),i.success=!0}break;case 2:{const o=f.fromAngle(e.rotation),s=f.add(e.position,f.mul(o,J.SHORT)),n=J.POISON_CLOUD,a=5e3;this.effectSystem.createZone(L.Poison,e.id,s,n,a,500,15,!1,!0,le.PoisonCloud),i.zones=[{id:K("zone"),type:le.PoisonCloud,position:s,radius:n,duration:a}],i.visualEffects.push({type:"poison_cloud",position:s,radius:n,duration:a,color:"#44ff44"}),i.success=!0}break;case 3:{const o=J.MEDIUM,s=this.getEnemies(e.team).filter(r=>r.alive);let n=null,a=o;for(const r of s){const c=f.distance(e.position,r.position);c<a&&(a=c,n=r)}if(n){this.effectSystem.applyEffect(L.Poison,e.id,n.id,6e3,10,500);const r=H(2),c=[n.id];for(const d of s){if(d.id===n.id)continue;f.distance(n.position,d.position)<=r&&c.length<4&&(this.effectSystem.applyEffect(L.Poison,e.id,d.id,6e3,8,500),c.push(d.id))}i.targetIds=c,i.effectsApplied.push("poison"),i.visualEffects.push({type:"poison_cloud",position:n.position,radius:r,duration:1e3,color:"#00ff00"}),i.success=!0}}break}return i}executeAegisAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=J.VERY_LONG*2,s=f.fromAngle(e.rotation);console.log("[Zero] Mark Target activated - scanning for enemies...");const n=this.getEnemies(e.team).filter(d=>d.alive);let a=null,r=.5,c=1/0;console.log(`[Zero] Found ${n.length} alive enemies to check`);for(const d of n){const h=f.sub(d.position,e.position),m=f.length(h);if(m>o){console.log(`[Zero] Enemy ${d.name} too far: ${m.toFixed(0)} > ${o}`);continue}const u=f.normalize(h),p=f.dot(u,s);console.log(`[Zero] Enemy ${d.name}: dist=${m.toFixed(0)}, dot=${p.toFixed(2)} (need >${r})`),p>r&&m<c&&(c=m,a=d)}a?(this.effectSystem.applyEffect(L.Marked,e.id,a.id,5e3,20),i.targetIds=[a.id],i.effectsApplied.push("marked"),console.log(`[Zero]  MARKED: ${a.name} for 5 seconds (+20% damage)`)):console.log("[Zero]  No target found. Make sure you're aiming at an enemy within range."),i.success=!0}break;case 2:{const o=J.BLINK,s=f.fromAngle(e.rotation+Math.PI),n=f.add(e.position,f.mul(s,o)),a=this.raycast(e.position,s,o,[e.id]),r=a?f.sub(a.point,f.mul(s,20)):n;i.teleportTo=r,i.visualEffects.push({type:"blink",position:e.position,duration:300},{type:"blink_trail",position:e.position,targetPosition:r,duration:200}),i.success=!0,console.log("[Zero] Dash Back executed")}break;case 3:{const o=J.DOME_SHIELD,s=5e3,n=this.getAllies(e.team);for(const a of n)f.distance(e.position,a.position)<=o&&this.effectSystem.applyEffect(L.DamageReduction,e.id,a.id,s,70);this.effectSystem.applyEffect(L.DamageReduction,e.id,e.id,s,70),i.effectsApplied.push("damage_reduction"),i.visualEffects.push({type:"dome_shield",position:e.position,radius:o,duration:s,color:"#4488ff"}),i.success=!0}break}return i}updateTurrets(e){const t=[],i=this.getTime();for(const[o,s]of this.turrets){if(i>=s.spawnTime+s.duration){this.turrets.delete(o);continue}const n=this.getEnemies(s.ownerTeam).filter(c=>c.alive);let a=null,r=s.range;for(const c of n){const d=f.distance(s.position,c.position);d<r&&(r=d,a=c)}a?(s.targetId=a.id,s.rotation=f.angle(f.sub(a.position,s.position)),i>=s.lastFireTime+s.fireRate&&(s.lastFireTime=i,t.push({turretId:o,targetId:a.id,damage:s.damage,position:s.position}))):s.targetId=null}return t}getTurrets(){return Array.from(this.turrets.values())}clearTurrets(){this.turrets.clear()}damageTurret(e,t){const i=this.turrets.get(e);return i?(i.health-=t,i.health<=0?(this.turrets.delete(e),!0):!1):!1}isInMinigunMode(e){const t=this.activeMiniguns.get(e);return t?this.getTime()<t:!1}activateMinigunMode(e,t){this.activeMiniguns.set(e,this.getTime()+t)}clear(){this.turrets.clear(),this.activeMiniguns.clear()}}class ut{config;isHost;abilityQSlot=1;abilityFSlot=2;totalRounds=5;roundsToWin=3;phase=A.Lobby;tick=0;time=0;roundNumber=0;roundStartTime=0;attackerScore=0;defenderScore=0;players=new Map;playersByPeerId=new Map;projectiles=new Map;grenades=new Map;bombs=new Map;aircraft=new Map;supplyCrates=new Map;collisionWorld;map;objectives;pendingEvents=[];recentShots=[];abilityEffects=[];localPlayerId=null;bots=new Map;countdownTime=1e4;countdownPaused=!1;countdownPausedBy="";countdownDuration=1e4;gamePaused=!1;gamePausedBy="";pausedPlayerPeerIds=new Set;disconnectForfeit=!1;disconnectedPlayerName="";effectSystem;abilitySystem;visualEffectQueue=[];aircraftSpawnedThisRound=0;aircraftPerRound=5;radioCallState=new Map;constructor(e){this.config=e,this.isHost=e.isHost,this.abilityQSlot=e.abilityQSlot??1,this.abilityFSlot=e.abilityFSlot??2,this.totalRounds=e.totalRounds??5,this.roundsToWin=Math.ceil(this.totalRounds/2),this.collisionWorld=new ps(128),this.map=bs(e.mapId||"neon_arena"),this.map.registerCollision(this.collisionWorld),this.effectSystem=new Bs({onEffectApplied:t=>{console.log(`[EffectSystem] Applied ${t.type} to ${t.targetId}`)},onEffectRemoved:t=>{console.log(`[EffectSystem] Removed ${t.type} from ${t.targetId}`)},onEffectTick:(t,i)=>{const o=this.players.get(t.targetId);if(!(!o||!o.alive))switch(t.type){case L.Poison:case L.Burn:case L.Bleed:o.takeDamage(i,t.sourceId,this.time);break;case L.Regen:o.heal(i);break}},onZoneTick:(t,i)=>{for(const o of i){const s=this.players.get(o);if(!s||!s.alive)continue;const n=this.players.get(t.sourceId);if(!n)continue;const a=s.team===n.team,r=s.team!==n.team;t.affectsAllies&&a&&this.applyZoneEffect(t,s),t.affectsEnemies&&r&&this.applyZoneEffect(t,s)}}}),this.abilitySystem=new $s(this.effectSystem,{getPlayer:t=>this.players.get(t),getPlayers:()=>Array.from(this.players.values()),getEnemies:t=>this.getPlayers().filter(i=>i.team!==t&&i.alive),getAllies:(t,i)=>this.getPlayers().filter(o=>o.team===t&&o.id!==i),getTime:()=>this.time,raycast:(t,i,o,s)=>{const n=this.collisionWorld.raycast(t,i,o,D.WALL);return n?{point:n.point,distance:f.distance(t,n.point)}:null}}),this.objectives={spikeCarrierId:null,spikePlanted:!1,spikeSite:-1,spikePlantTime:0,spikeProgress:0,spikePosition:null,plantingPlayerId:null,plantingPeerId:null,plantingProgress:0,defusingPlayerId:null,defusingPeerId:null,defusingProgress:0,reactorPosition:{x:0,y:0},reactorProgress:0,reactorContested:!1,reactorPushers:0}}applyZoneEffect(e,t){switch(e.type){case L.Poison:t.takeDamage(e.value,e.sourceId,this.time,"poison");break;case L.Burn:t.takeDamage(e.value,e.sourceId,this.time,"fire");break;case L.Regen:t.heal(e.value);break;case L.Slow:this.effectSystem.applyEffect(L.Slow,e.sourceId,t.id,500,e.value);break}}addPlayer(e,t,i,o){const s=this.playersByPeerId.get(e);if(s)return console.log(`[GameWorld] Player with peerId ${e} already exists, returning existing`),s;const n=this.getTeamPlayerCount(i),a=this.map.getSpawnPoint(i,n),r=new Oe(e,t,i,o,a);return this.players.set(r.id,r),this.playersByPeerId.set(e,r),this.collisionWorld.addBody(r.getCollisionBody()),console.log(`[GameWorld] Added player: ${t} (${e}) to team ${i}`),r}removePlayer(e){const t=this.players.get(e);t&&(this.collisionWorld.removeBody(e),this.playersByPeerId.delete(t.peerId),this.players.delete(e),this.bots.delete(e))}getPlayer(e){return this.players.get(e)}getPlayerByPeerId(e){return this.playersByPeerId.get(e)}getPlayerByName(e){for(const t of this.players.values())if(t.name===e)return t}updatePlayerPeerId(e,t){const i=this.playersByPeerId.get(e);i&&(this.playersByPeerId.delete(e),i.peerId=t,this.playersByPeerId.set(t,i),console.log(`[GameWorld] Updated player peerId: ${e} -> ${t}`))}getPlayers(){return Array.from(this.players.values())}getTeamPlayers(e){return this.getPlayers().filter(t=>t.team===e)}getTeamPlayerCount(e){return this.getTeamPlayers(e).length}setLocalPlayer(e){this.localPlayerId=e}getLocalPlayer(){return this.localPlayerId?this.players.get(this.localPlayerId):void 0}addBot(e,t=M.Vanta,i="medium"){const o=this.bots.size,s=this.addPlayer(`bot_${o}`,`Bot ${o+1}`,e,t),n=this.getDifficultySettings(i),a=pt.create(s,{aggressionLevel:n.aggressionLevel+Math.random()*.1,accuracy:n.accuracy+Math.random()*.1,reactionTime:n.reactionTime+Math.random()*50});return this.bots.set(s.id,a),s}getDifficultySettings(e){switch(e){case"easy":return{aggressionLevel:.3,accuracy:.2,reactionTime:400};case"medium":return{aggressionLevel:.5,accuracy:.5,reactionTime:250};case"hard":return{aggressionLevel:.8,accuracy:.8,reactionTime:100};default:return{aggressionLevel:.5,accuracy:.5,reactionTime:250}}}spawnBots(e,t,i="medium"){const o=[P.NeoSMG9,P.PulseRifle,P.ScatterShot,P.RailSniper];for(let s=0;s<e;s++){const n=this.addBot(t,M.Vanta,i),a=o[Math.floor(Math.random()*o.length)];n.buyWeapon(a)}}startRound(){this.phase=A.RoundActive,this.roundNumber++,this.roundStartTime=this.time;for(const t of this.players.values()){const i=this.getTeamPlayers(t.team).indexOf(t),o=this.map.getSpawnPoint(t.team,i),s=!t.alive;t.respawn(o),t.resetAbilities(),s?this.collisionWorld.addBody(t.getCollisionBody()):this.collisionWorld.updateBody(t.id,t.position,t.velocity)}this.projectiles.clear(),this.aircraft.clear(),this.supplyCrates.clear(),this.aircraftSpawnedThisRound=0;const e=[B.Weapon,B.Weapon,B.MissileStrike,B.MissileStrike,B.MissileStrike];for(let t=0;t<this.aircraftPerRound;t++){const i=5e3+Math.random()*55e3,o=e[t];setTimeout(()=>{this.phase===A.RoundActive&&this.isHost&&this.spawnAircraft(o)},i)}if(this.abilityEffects=[],this.visualEffectQueue=[],this.abilitySystem.clearTurrets(),this.effectSystem.clear(),this.objectives={spikeCarrierId:null,spikePlanted:!1,spikeSite:-1,spikePlantTime:0,spikeProgress:0,spikePosition:null,plantingPlayerId:null,plantingPeerId:null,plantingProgress:0,defusingPlayerId:null,defusingPeerId:null,defusingProgress:0,reactorPosition:{x:0,y:0},reactorProgress:0,reactorContested:!1,reactorPushers:0},this.config.mode===Q.DataSpikeAssault){const t=this.getTeamPlayers(g.Attackers),i=t.filter(o=>!this.bots.has(o.id));if(i.length>0){const o=i[Math.floor(Math.random()*i.length)];this.objectives.spikeCarrierId=o.id,console.log(`[Spike] Spike carrier assigned to human: ${o.name}`)}else if(t.length>0){const o=t[Math.floor(Math.random()*t.length)];this.objectives.spikeCarrierId=o.id,console.log(`[Spike] Spike carrier assigned to bot (no humans): ${o.name}`)}}}endRound(e){console.log(`[GameWorld] endRound called - Winner: ${e===g.Attackers?"Attackers":"Defenders"}`),this.phase=A.RoundEnd,this.roundStartTime=this.time,this.countdownTime=this.countdownDuration,this.countdownPaused=!1,this.countdownPausedBy="",e===g.Attackers?this.attackerScore++:e===g.Defenders&&this.defenderScore++,this.attackerScore>=this.roundsToWin||this.defenderScore>=this.roundsToWin?(this.phase=A.MatchEnd,console.log(`[GameWorld] MATCH ENDED! Final Score: Attackers ${this.attackerScore} - Defenders ${this.defenderScore}`)):console.log(`[GameWorld] Round ended. Score: Attackers ${this.attackerScore} - Defenders ${this.defenderScore}. Countdown: ${this.countdownDuration/1e3}s`)}endMatchByDisconnect(e,t){console.log(`[GameWorld] Player ${t} disconnected - ${e===g.Attackers?"Attackers":"Defenders"} forfeit`),e===g.Attackers?this.defenderScore=this.roundsToWin:this.attackerScore=this.roundsToWin,this.phase=A.MatchEnd,this.disconnectForfeit=!0,this.disconnectedPlayerName=t,console.log(`[GameWorld] MATCH ENDED BY DISCONNECT! ${t} forfeited. Final Score: Attackers ${this.attackerScore} - Defenders ${this.defenderScore}`)}isDisconnectForfeit(){return this.disconnectForfeit}getDisconnectedPlayerName(){return this.disconnectedPlayerName}setDisconnectForfeitState(e,t){this.disconnectForfeit=e,this.disconnectedPlayerName=t}pauseCountdown(e){this.phase===A.RoundEnd&&!this.countdownPaused&&(this.countdownPaused=!0,this.countdownPausedBy=e,console.log(`[GameWorld] Countdown paused by ${e} at ${(this.countdownTime/1e3).toFixed(1)}s`))}resumeCountdown(e){this.phase===A.RoundEnd&&this.countdownPaused&&(this.countdownPaused=!1,this.countdownPausedBy="",console.log(`[GameWorld] Countdown resumed by ${e} at ${(this.countdownTime/1e3).toFixed(1)}s`))}toggleCountdownPause(e){this.countdownPaused?this.resumeCountdown(e):this.pauseCountdown(e)}playerLostFocus(e,t){this.pausedPlayerPeerIds.add(e),this.gamePaused||(this.gamePaused=!0,this.gamePausedBy=t,console.log(`[GameWorld] Game paused - ${t} lost focus (${this.pausedPlayerPeerIds.size} players paused)`))}playerRegainedFocus(e,t){this.pausedPlayerPeerIds.delete(e),console.log(`[GameWorld] ${t} regained focus (${this.pausedPlayerPeerIds.size} players still paused)`),this.pausedPlayerPeerIds.size===0&&this.gamePaused&&(this.gamePaused=!1,this.gamePausedBy="",console.log("[GameWorld] Game resumed - all players have focus"))}isGamePaused(){return this.gamePaused}getGamePausedBy(){return this.gamePausedBy}getPausedPlayerCount(){return this.pausedPlayerPeerIds.size}setGamePauseState(e,t){this.gamePaused=e,this.gamePausedBy=t}update(e){if(!this.isHost||this.gamePaused)return;if(this.tick++,this.phase===A.RoundActive&&(this.time+=e),this.phase!==A.RoundActive){if(this.phase===A.RoundEnd&&!this.countdownPaused&&(this.countdownTime-=e,this.countdownTime<=0)){console.log("[GameWorld] Countdown finished, starting next round"),this.startRound();return}for(const d of this.players.values())d.setInput({moveX:0,moveY:0,aimX:d.position.x,aimY:d.position.y,shoot:!1,reload:!1,ability1:!1,ability2:!1,ultimate:!1,interact:!1,throwGrenade:!1,useBombCall:!1,useMissileStrike:!1,weaponSlot:0,sequence:0}),d.prevPosition.x=d.position.x,d.prevPosition.y=d.position.y,d.velocity.x=0,d.velocity.y=0;return}const t=this.getPlayers();for(const[d,h]of this.bots){const m=this.players.get(d);if(m&&m.alive){const u={dt:e,time:this.time,allPlayers:t,collisionWorld:this.collisionWorld,map:this.map,objectives:this.objectives},p=h.update(u);m.setInput(p)}}for(const d of this.players.values())d.update(e,this.time),this.collisionWorld.updateBody(d.id,d.position,d.velocity);for(const[d,h]of this.projectiles)h.update(e,this.time),h.active?this.collisionWorld.updateBody(d,h.position,h.velocity):(this.projectiles.delete(d),this.collisionWorld.removeBody(d));for(let d=0;d<4;d++){const h=this.collisionWorld.detectCollisions();if(this.collisionWorld.resolveCollisions(),d===0)for(const m of h){const{bodyA:u,bodyB:p}=m,w=u.userData instanceof Ce?u:p.userData instanceof Ce?p:null,x=w===u?p:u;if(w&&w.userData instanceof Ce){const S=w.userData;if(x.layer&(D.PLAYER|D.ENEMY|D.WALL)){if(x.userData instanceof Oe){const k=x.userData,I=this.players.get(S.ownerId);if(I&&k.team!==I.team){k.takeDamage(S.damage,S.ownerId,this.time);const T=S.damage/25;I.ultimateCharge=Math.min(10,I.ultimateCharge+T),this.pendingEvents.push({type:G.PlayerDamage,data:{targetId:k.id,attackerId:S.ownerId,damage:S.damage,position:S.position,isHeadshot:!1}}),k.alive||(I.kills++,I.credits+=U.KILL_REWARD,I.ultimateCharge=Math.min(10,I.ultimateCharge+2),this.collisionWorld.removeBody(k.id),this.pendingEvents.push({type:G.PlayerKill,data:{victimId:k.id,killerId:I.id,weaponId:I.weapon.weaponId,isHeadshot:!1}}))}}S.destroy()}}}}for(const d of this.players.values())d.input.shoot&&d.canFire(this.time)&&(this.processShot(d),d.fire(this.time));for(const d of this.players.values())d.input.throwGrenade&&d.grenadeCount>0&&this.time-d.lastGrenadeThrowTime>=1e3&&(this.throwGrenade(d),d.grenadeCount--,d.lastGrenadeThrowTime=this.time);for(const d of this.players.values()){if(d.input.useBombCall&&d.bombCallCount>0){const h=this.radioCallState.get(d.id)||{type:null,firstClick:null,awaitingSecondClick:!1};if(!h.awaitingSecondClick)h.type="bomb",h.firstClick={x:d.input.aimX,y:d.input.aimY},h.awaitingSecondClick=!0,this.radioCallState.set(d.id,h),console.log(`[Radio] ${d.name} activated bomb call - awaiting second click`);else if(h.type==="bomb"&&h.firstClick){const m={x:d.input.aimX,y:d.input.aimY};this.spawnBomberOnPath(h.firstClick,m),d.bombCallCount=0,this.radioCallState.delete(d.id),console.log(`[Radio] ${d.name} called B-52 bomber strike`)}}if(d.input.useMissileStrike&&d.missileStrikeCount>0){const h=this.radioCallState.get(d.id)||{type:null,firstClick:null,awaitingSecondClick:!1};if(!h.awaitingSecondClick)h.type="missile",h.firstClick={x:d.input.aimX,y:d.input.aimY},h.awaitingSecondClick=!0,this.radioCallState.set(d.id,h),console.log(`[Radio] ${d.name} targeting missile strike - awaiting confirmation`);else if(h.type==="missile"){const m={x:d.input.aimX,y:d.input.aimY};this.spawnMissileStrike(m,d.id),d.missileStrikeCount--,this.radioCallState.delete(d.id),console.log(`[Radio] ${d.name} called missile strike at (${m.x.toFixed(0)}, ${m.y.toFixed(0)})`)}}}for(const[d,h]of this.grenades)h.update(e,this.time,this.map.getWidth(),this.map.getHeight())?(this.handleGrenadeExplosion(h),this.grenades.delete(d)):h.active||this.grenades.delete(d);this.processAbilities(),this.config.mode===Q.DataSpikeAssault&&this.processSpikeInteraction(e),this.updateSupplyDropSystem(e),this.checkRoundEnd();const i=this.map.getWidth(),o=this.map.getHeight(),s=this.map.getTileSize(),n=16,a=s+n,r=i-s-n,c=o-s-n;for(const d of this.players.values())d.position.x=Math.max(a,Math.min(r,d.position.x)),d.position.y=Math.max(a,Math.min(c,d.position.y)),this.collisionWorld.updateBody(d.id,d.position,d.velocity)}updateLocalPlayerOnly(e){const t=this.getLocalPlayer();if(this.phase===A.RoundActive){if(t&&t.alive){t.update(e,this.time),this.collisionWorld.updateBody(t.id,t.position,t.velocity),this.collisionWorld.detectCollisions(),this.collisionWorld.resolveCollisions();const i=this.map.getWidth(),o=this.map.getHeight(),s=this.map.getTileSize(),n=16,a=s+n,r=i-s-n,c=o-s-n;t.position.x=Math.max(a,Math.min(r,t.position.x)),t.position.y=Math.max(a,Math.min(c,t.position.y))}for(const i of this.players.values())if(i.id!==this.localPlayerId){if(i.targetPosition){i.prevPosition={...i.position};const o=1-Math.exp(-15*e/1e3);i.position.x+=(i.targetPosition.x-i.position.x)*o,i.position.y+=(i.targetPosition.y-i.position.y)*o}if(i.targetRotation!==null){i.prevRotation=i.rotation;const o=1-Math.exp(-15*e/1e3);i.rotation+=(i.targetRotation-i.rotation)*o}}for(const i of this.projectiles.values())i.update(e,this.time)}}processShot(e){const t=Pe[e.weapon.weaponId],i=e.rotation,o=t.spread,s=t.id===P.ScatterShot?t.burstCount:1;for(let n=0;n<s;n++){const a=i+hs(-o,o),r=f.fromAngle(a),c=f.add(e.position,f.mul(r,20));if(t.projectileSpeed===0){const d=this.collisionWorld.raycast(c,r,t.range,D.PLAYER|D.ENEMY|D.WALL),h=d?d.point:f.add(c,f.mul(r,t.range));if(this.recentShots.push({start:{x:c.x,y:c.y},end:{x:h.x,y:h.y},shooterId:e.id,shooterPeerId:e.peerId}),d&&d.body.userData instanceof Oe){const m=d.body.userData;if(m.id!==e.id&&m.team!==e.team){const u=Math.random()<U.HEADSHOT_ZONE_RATIO,p=e.getEffectiveDamage(),w=u?p*t.headshotMultiplier:p;m.takeDamage(w,e.id,this.time);const x=w/25;e.ultimateCharge=Math.min(10,e.ultimateCharge+x),this.pendingEvents.push({type:G.PlayerDamage,data:{targetId:m.id,attackerId:e.id,damage:w,position:d.point,isHeadshot:u}}),m.alive||(e.kills++,e.credits+=U.KILL_REWARD,e.ultimateCharge=Math.min(10,e.ultimateCharge+2),this.collisionWorld.removeBody(m.id),this.pendingEvents.push({type:G.PlayerKill,data:{victimId:m.id,killerId:e.id,weaponId:e.weapon.weaponId,isHeadshot:u}}))}}}else{const d=new Ce(e.id,c,r,t.projectileSpeed,t.damage,2e3,this.time);this.projectiles.set(d.id,d),this.collisionWorld.addBody(d.getCollisionBody())}}}throwGrenade(e){const t=f.normalize({x:e.input.aimX-e.position.x,y:e.input.aimY-e.position.y}),i=30,o={x:e.position.x+t.x*i,y:e.position.y+t.y*i},s=.5,n=new wi(e.id,o,t,s);this.grenades.set(n.id,n),this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"grenade_throw",playerId:e.id,position:o}}),console.log(`[Grenade] ${e.name} threw grenade (${e.grenadeCount} remaining)`)}handleGrenadeExplosion(e){for(const o of this.players.values()){if(!o.alive)continue;const s=f.distance(o.position,e.position);if(s<=150){const n=1-s/150,a=Math.floor(80*n);if(a>0&&(o.takeDamage(a,e.ownerId,this.time),this.pendingEvents.push({type:G.PlayerDamage,data:{targetId:o.id,attackerId:e.ownerId,damage:a,position:e.position,isHeadshot:!1}}),!o.alive)){const r=this.players.get(e.ownerId);r&&(r.kills++,r.credits+=U.KILL_REWARD,r.ultimateCharge=Math.min(10,r.ultimateCharge+2)),this.collisionWorld.removeBody(o.id),this.pendingEvents.push({type:G.PlayerKill,data:{victimId:o.id,killerId:e.ownerId,weaponId:"grenade",isHeadshot:!1}})}}}this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"grenade_explosion",position:e.position,radius:150}}),console.log(`[Grenade] Explosion at (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`)}processAbilities(){this.abilityEffects=this.abilityEffects.filter(t=>this.time<t.startTime+t.duration),this.visualEffectQueue=this.visualEffectQueue.filter(t=>this.time<t.startTime+t.duration),this.effectSystem.update(this.time,(t,i)=>{const o=[];for(const s of this.players.values())f.distance(s.position,t)<=i&&o.push(s.id);return o});const e=this.abilitySystem.updateTurrets(16);for(const t of e){const i=this.players.get(t.targetId);i&&i.alive&&i.takeDamage(t.damage,t.turretId,this.time)}for(const t of this.players.values()){if(!t.alive)continue;const i=t.id===this.localPlayerId,o=i?this.abilityQSlot:1,s=i?this.abilityFSlot:2;if(t.input.ability1&&t.canUseAbility(o,this.time)&&(console.log(`[Input] Q pressed (ability1) -> executing ability index ${o}`),this.executeAbilityNew(t,o)),t.input.ability2&&t.canUseAbility(s,this.time)&&(console.log(`[Input] F pressed (ability2) -> executing ability index ${s}`),this.executeAbilityNew(t,s)),t.input.ultimate){const n=t.canUseAbility(3,this.time),r=ee[t.heroId]?.abilities[3]?.ultimateCost||6;console.log(`[Input] X pressed - ultimate charge: ${t.ultimateCharge.toFixed(1)}/${r}, canUse: ${n}`),n&&this.executeAbilityNew(t,3)}this.applyEffectModifiers(t)}}executeAbilityNew(e,t){const i=ee[e.heroId],o=i?.abilities[t];console.log(`[Ability] Executing ability ${t}: ${o?.name||"Unknown"} for ${i?.name||"Unknown hero"}`),e.useAbility(t,this.time);const s=this.abilitySystem.executeAbility(e,t);if(s.success){if(s.teleportTo&&(e.position={...s.teleportTo},e.prevPosition={...s.teleportTo},this.collisionWorld.updateBody(e.id,e.position)),s.damage&&s.targetIds)for(const n of s.targetIds){const a=this.players.get(n);a&&a.alive&&(a.takeDamage(s.damage,e.id,this.time),a.alive||(e.kills++,e.credits+=U.KILL_REWARD,this.collisionWorld.removeBody(a.id)))}if(s.healing&&s.targetIds)for(const n of s.targetIds){const a=this.players.get(n);a&&(a.alive?a.heal(s.healing):(a.alive=!0,a.health=s.healing,this.collisionWorld.addBody(a.getCollisionBody())))}if(s.visualEffects)for(const n of s.visualEffects)this.visualEffectQueue.push({...n,startTime:this.time});s.effectsApplied.includes("cloak")&&(this.abilityEffects.push({type:"cloak",playerId:e.id,position:{...e.position},direction:e.rotation,startTime:this.time,duration:4e3}),e.isInvisible=!0)}}applyEffectModifiers(e){const t=this.effectSystem.getSpeedModifier(e.id);e.speedMultiplier=t,e.isStunned=this.effectSystem.isStunned(e.id);const i=this.effectSystem.isCloaked(e.id);e.isInvisible=i}calculateDamage(e,t,i){let o=e;const s=this.effectSystem.getDamageModifier(t);o*=s;const n=this.effectSystem.getEffect(i,L.Marked);n&&(o*=1+n.value/100);const a=this.effectSystem.getDamageReduction(i);return o*=1-a/100,Math.floor(o)}getFireRateModifier(e){return this.effectSystem.getFireRateModifier(e)}getZoneEffects(){return this.effectSystem.getZones()}getTurrets(){return this.abilitySystem.getTurrets()}getVisualEffects(){return[...this.visualEffectQueue]}getAbilityEffects(){return[...this.abilityEffects]}getEffectSystem(){return this.effectSystem}hasEffect(e,t){return this.effectSystem.hasEffect(e,t)}processSpikeInteraction(e){const t=U.SPIKE_PLANT_TIME,i=U.SPIKE_DEFUSE_TIME;this.objectives.spikePlanted?this.handleSpikeDefusing(e,i):this.handleSpikePlanting(e,t)}handleSpikePlanting(e,t){const i=this.objectives.spikeCarrierId?this.players.get(this.objectives.spikeCarrierId):null;if(!i||!i.alive){if(this.objectives.spikeCarrierId){const s=this.getTeamPlayers(g.Attackers).filter(a=>a.alive&&a.id!==this.objectives.spikeCarrierId),n=s.filter(a=>!this.bots.has(a.id));if(n.length>0){const a=n[0];this.objectives.spikeCarrierId=a.id,console.log(`[Spike] Spike transferred to human: ${a.name}`)}else if(s.length>0){const a=s[0];this.objectives.spikeCarrierId=a.id,console.log(`[Spike] Spike transferred to bot: ${a.name}`)}}this.objectives.plantingPlayerId=null,this.objectives.plantingPeerId=null,this.objectives.plantingProgress=0;return}const o=this.map.isInSpikeSite(i.position);if(o===-1){this.objectives.plantingPlayerId&&console.log("[Spike] Planting cancelled - left spike site"),this.objectives.plantingPlayerId=null,this.objectives.plantingPeerId=null,this.objectives.plantingProgress=0;return}i.input.interact?(this.objectives.plantingPlayerId!==i.id&&(this.objectives.plantingPlayerId=i.id,this.objectives.plantingPeerId=i.peerId,this.objectives.plantingProgress=0,console.log(`[Spike] Starting to plant at site ${o===0?"A":"B"}`)),this.objectives.plantingProgress+=e/t,this.objectives.plantingProgress>=1&&(this.objectives.spikePlanted=!0,this.objectives.spikeSite=o,this.objectives.spikePlantTime=this.time,this.objectives.spikePosition={...i.position},this.objectives.plantingPlayerId=null,this.objectives.plantingPeerId=null,this.objectives.plantingProgress=0,console.log(`[Spike]  SPIKE PLANTED at site ${o===0?"A":"B"}! Defenders have ${U.SPIKE_UPLOAD_TIME/1e3}s to defuse!`))):this.objectives.plantingPlayerId&&(console.log("[Spike] Planting cancelled - released E key"),this.objectives.plantingPlayerId=null,this.objectives.plantingPeerId=null,this.objectives.plantingProgress=0)}handleSpikeDefusing(e,t){let i=null;if(this.tick%20===0){for(const o of this.players.values())if(o.team===g.Defenders&&o.alive){const s=this.objectives.spikePosition?f.distance(o.position,this.objectives.spikePosition):999;console.log(`[Spike] Defender ${o.name} (${o.peerId}): interact=${o.input?.interact}, dist=${s.toFixed(0)}, isBot=${this.bots.has(o.id)}`)}}for(const o of this.players.values()){if(!o.alive||o.team!==g.Defenders)continue;if(!o.input){console.warn(`[Spike] Player ${o.name} has no input object!`);continue}if(!o.input.interact||!this.objectives.spikePosition)continue;const s=f.distance(o.position,this.objectives.spikePosition);if(s<=50){i=o,console.log(`[Spike] Found defusing player: ${o.name} (interact=${o.input.interact}, dist=${s.toFixed(0)})`);break}}if(i)this.objectives.defusingPlayerId!==i.id&&(this.objectives.defusingPlayerId=i.id,this.objectives.defusingPeerId=i.peerId,this.objectives.defusingProgress=0,console.log(`[Spike] ${i.name} started defusing!`)),this.objectives.defusingProgress+=e/t,this.objectives.defusingProgress>=1&&(console.log(`[Spike]  SPIKE DEFUSED by ${i.name}! Defenders win!`),this.endRound(g.Defenders));else{if(this.objectives.defusingPlayerId){const o=this.players.get(this.objectives.defusingPlayerId);console.log(`[Spike] Defuse cancelled by ${o?.name||"unknown"}`)}this.objectives.defusingPlayerId=null,this.objectives.defusingPeerId=null,this.objectives.defusingProgress=0}}updateSupplyDropSystem(e){for(const[t,i]of this.aircraft){if(i.update(e,this.time),i.type===ge.SupplyDrop){if(!i.hasDropped&&i.active){const o=f.distance(i.prevPosition,i.targetPosition)/f.distance(i.position,i.targetPosition);if(!i.dropTime&&o>.3&&Math.random()<.01){i.dropTime=this.time,i.hasDropped=!0;const s=i.getRotation(),n=80,a={x:i.position.x-Math.cos(s)*n,y:i.position.y-Math.sin(s)*n},r=i.forcedDropType;this.spawnSupplyCrate(a,r)}}}else if(i.type===ge.Bomber){const n=f.distance(i.prevPosition,i.position);if(i.bombsDropped<8&&n>0){const a=f.distance(i.startPosition,i.targetPosition),r=f.distance(i.startPosition,i.position);r>a*.2&&Math.floor((r-a*.2)/200)>i.bombsDropped&&(this.dropBomb(i),i.bombsDropped++)}}i.active||this.aircraft.delete(t)}for(const[t,i]of this.bombs){const o=i.update(e,this.time);i.incomingSoundPlayed&&i.launchPosition&&i.targetPosition&&(this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"missile_incoming",bombId:i.id,position:i.targetPosition}}),i.incomingSoundPlayed=!1),o?(this.handleBombExplosion(i),this.bombs.delete(t)):i.active||this.bombs.delete(t)}for(const[t,i]of this.supplyCrates){if(i.update(e,this.time)&&this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"parachute_landed",crateId:i.id}}),i.isLanded()&&!i.claimed)for(const s of this.players.values()){if(!s.alive)continue;if(f.distance(s.position,i.position)<=40){this.handleCratePickup(s,i);break}}(i.claimed||i.landTime&&this.time-i.landTime>6e4)&&(this.supplyCrates.delete(t),this.collisionWorld.removeBody(t))}}spawnAircraft(e){const t=this.map.getWidth(),i=this.map.getHeight(),o=200,s=Math.floor(Math.random()*4),n=(s+2)%4;let a,r;switch(s){case 0:a={x:Math.random()*t,y:-o};break;case 1:a={x:t+o,y:Math.random()*i};break;case 2:a={x:Math.random()*t,y:i+o};break;default:a={x:-o,y:Math.random()*i};break}switch(n){case 0:r={x:Math.random()*t,y:-o};break;case 1:r={x:t+o,y:Math.random()*i};break;case 2:r={x:Math.random()*t,y:i+o};break;default:r={x:-o,y:Math.random()*i};break}const c=ge.SupplyDrop,d=150,h=400,m=new et(a,r,d,h,this.time,c);m.forcedDropType=e,this.aircraft.set(m.id,m),this.aircraftSpawnedThisRound++,this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"aircraft_spawn",aircraftId:m.id,aircraftType:c}}),console.log(`[Aircraft] SupplyDrop ${this.aircraftSpawnedThisRound}/${this.aircraftPerRound} spawned, flying from edge ${s} to ${n}`)}spawnBomberOnPath(e,t){const i=this.map.getWidth(),o=this.map.getHeight(),s=200,n=t.x-e.x,a=t.y-e.y,r=Math.sqrt(n*n+a*a);if(r<100){console.log("[Radio] Bomber path too short, ignoring");return}const c=n/r,d=a/r,h={x:Math.max(-s,Math.min(i+s,e.x-c*300)),y:Math.max(-s,Math.min(o+s,e.y-d*300))},m={x:Math.max(-s,Math.min(i+s,t.x+c*300)),y:Math.max(-s,Math.min(o+s,t.y+d*300))},u=new et(h,m,100,1200,this.time,ge.Bomber);this.aircraft.set(u.id,u),this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"aircraft_spawn",aircraftId:u.id,aircraftType:ge.Bomber}}),console.log("[Radio] B-52 Bomber spawned on custom path")}spawnMissileStrike(e,t){const i=5+Math.floor(Math.random()*3),o=200,s=this.map.getWidth(),n=this.map.getHeight(),a=-300,r=-300;for(let c=0;c<i;c++){const h=(c-i/2)*(150/i),m={x:a+h,y:r+h*.5},u=Math.random()*Math.PI*2,p=Math.random()*o,w={x:e.x+Math.cos(u)*p,y:e.y+Math.sin(u)*p};w.x=Math.max(50,Math.min(s-50,w.x)),w.y=Math.max(50,Math.min(n-50,w.y));const x=new St(t,{...m},{x:0,y:0},0);x.launchPosition=m,x.targetPosition=w,x.launchTime=this.time+c*150,console.log(`[Missile] Created missile ${c+1}/${i}: launch=(${m.x.toFixed(0)},${m.y.toFixed(0)}) target=(${w.x.toFixed(0)},${w.y.toFixed(0)}) launchTime=${x.launchTime.toFixed(0)}`),this.bombs.set(x.id,x),this.collisionWorld.addBody(x.getCollisionBody())}this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"missile_strike",position:e,radius:o}}),console.log(`[Radio] Missile strike spawned ${i} missiles at (${e.x.toFixed(0)}, ${e.y.toFixed(0)})`)}spawnSupplyCrate(e,t){const i=this.map.getWidth(),o=this.map.getHeight(),s=100;let n={x:Math.max(s,Math.min(i-s,e.x)),y:Math.max(s,Math.min(o-s,e.y))},a=0;const r=10;for(;a<r;){const u=Math.floor(n.x/this.map.getTileSize()),p=Math.floor(n.y/this.map.getTileSize()),w=this.map.data.tiles;if(w[p]&&w[p][u]!==1)break;n={x:Math.max(s,Math.min(i-s,e.x+(Math.random()-.5)*200)),y:Math.max(s,Math.min(o-s,e.y+(Math.random()-.5)*200))},a++}let c,d,h;if(t==="random")c=Math.random()<.5?B.BombCall:B.MissileStrike,h=1;else if(t)if(c=t,c===B.Grenade)h=1;else if(c===B.Weapon){const u=[P.NeoSMG9,P.PulseRifle,P.ScatterShot,P.RailSniper,P.ShardLauncher,P.NanoRepeater,P.ArcWelder,P.PhaseRepeater,P.PlasmaCannon];d=u[Math.floor(Math.random()*u.length)]}else(c===B.BombCall||c===B.MissileStrike)&&(h=1);else{const u=Math.random();if(u<.3){c=B.Weapon;const p=[P.NeoSMG9,P.PulseRifle,P.ScatterShot,P.RailSniper,P.ShardLauncher,P.NanoRepeater,P.ArcWelder,P.PhaseRepeater,P.PlasmaCannon];d=p[Math.floor(Math.random()*p.length)]}else if(u<.48)c=B.HealthKit,h=50;else if(u<.63)c=B.Shield,h=50;else if(u<.78){c=B.Credits;const p=Math.random();p<.3?h=100:p<.5?h=200:p<.65?h=300:p<.77?h=400:p<.86?h=500:p<.92?h=800:p<.96?h=1e3:p<.98?h=1500:p<.99?h=2e3:h=2500}else u<.88?(c=B.Grenade,h=1):u<.94?(c=B.BombCall,h=1):(c=B.MissileStrike,h=1)}const m=new vt(n,c,this.time,200,d,h);this.supplyCrates.set(m.id,m),this.collisionWorld.addBody(m.getCollisionBody()),console.log(`[SupplyDrop] Crate dropped at (${n.x.toFixed(0)}, ${n.y.toFixed(0)}): ${c}`)}dropBomb(e){const t=e.getRotation(),i=-50,o={x:e.position.x+Math.cos(t)*i,y:e.position.y+Math.sin(t)*i},s=e.getVelocity(),n={x:s.x*.25,y:s.y*.25},a=new St(e.id,o,n,1200);this.bombs.set(a.id,a),this.collisionWorld.addBody(a.getCollisionBody()),console.log(`[Bomber] Bomb dropped at (${o.x.toFixed(0)}, ${o.y.toFixed(0)}) with altitude 1200`)}handleBombExplosion(e){for(const o of this.players.values()){if(!o.alive)continue;const s=f.distance(o.position,e.position);if(s<=200){const n=1-s/200,a=Math.floor(120*n);if(a>0&&(o.takeDamage(a,e.ownerId,this.time),this.pendingEvents.push({type:G.PlayerDamage,data:{targetId:o.id,attackerId:e.ownerId,damage:a,position:e.position,isHeadshot:!1}}),!o.alive)){const r=this.players.get(e.ownerId);r&&(r.kills++,r.credits+=U.KILL_REWARD,r.ultimateCharge=Math.min(10,r.ultimateCharge+2)),this.collisionWorld.removeBody(o.id),this.pendingEvents.push({type:G.PlayerKill,data:{victimId:o.id,killerId:e.ownerId,weaponId:"bomb",isHeadshot:!1}})}}}this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"bomb_explosion",position:e.position,radius:200}}),console.log(`[Bomber] Bomb exploded at (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)}) with radius 200`)}handleCratePickup(e,t){let i="item",o="";switch(t.supplyType){case B.Weapon:if(t.weaponId){const d=e.buyWeapon(t.weaponId,!0);o=t.weaponId.replace(/_/g," ").toUpperCase(),console.log(`[SupplyDrop] ${e.name} picked up ${t.weaponId} - Added to inventory: ${d}`),i="weapon"}break;case B.HealthKit:const s=t.amount||50;e.health=Math.min(e.maxHealth,e.health+s),o=`+${s} HP`,console.log(`[SupplyDrop] ${e.name} healed ${s} HP`),i="health";break;case B.Shield:const n=t.amount||50;e.shield=Math.min(e.maxShield,e.shield+n),o=`+${n} SHIELD`,console.log(`[SupplyDrop] ${e.name} gained ${n} shield`),i="item";break;case B.Credits:const a=t.amount||1e3;e.credits+=a,o=`+$${a}`,console.log(`[SupplyDrop] ${e.name} gained $${a}`),i="item";break;case B.Grenade:const r=t.amount||1,c=e.grenadeCount;e.grenadeCount=Math.min(9,e.grenadeCount+r),o=`+${r} GRENADE${r>1?"S":""}`,console.log(`[SupplyDrop] ${e.name} picked up ${r} grenade(s) - Before: ${c}, After: ${e.grenadeCount}`),i="item";break;case B.BombCall:e.bombCallCount<1?(e.bombCallCount=1,o="B-52 BOMBER CALL",console.log(`[SupplyDrop] ${e.name} picked up Bomb Call Radio`),i="weapon"):(o="RADIO FULL",console.log(`[SupplyDrop] ${e.name} already has Bomb Call Radio`),i="item");break;case B.MissileStrike:e.missileStrikeCount<1?(e.missileStrikeCount=1,o="MISSILE STRIKE CALL",console.log(`[SupplyDrop] ${e.name} picked up Missile Strike Radio`),i="weapon"):(o="RADIO FULL",console.log(`[SupplyDrop] ${e.name} already has Missile Strike Radio`),i="item");break}t.claim(),console.log(`[SupplyDrop] Emitting pickup event - sound type: ${i}, message: ${o}`),this.pendingEvents.push({type:G.RoundStarted,data:{eventType:"crate_pickup",playerId:e.id,pickupSound:i,pickupMessage:o}})}checkRoundEnd(){const e=this.players.size;if(e<2)return;const t=this.time-this.roundStartTime;if(t<1e4)return;const i=this.getTeamPlayers(g.Attackers),o=this.getTeamPlayers(g.Defenders),s=i.filter(a=>a.alive).length,n=o.filter(a=>a.alive).length;if(Math.floor(t/2e3)!==Math.floor((t-16)/2e3)){console.log(`[GameWorld] Round check @ ${Math.round(t)}ms - Total: ${e}, Attackers: ${s}/${i.length}, Defenders: ${n}/${o.length}`);for(const a of this.players.values())console.log(`  - ${a.name} (${a.peerId}): team=${a.team}, alive=${a.alive}`)}if(!(i.length===0||o.length===0)){if(this.config.mode===Q.NeonDeathmatch){if(s===0&&i.length>0){console.log("[GameWorld] Round ending: All attackers eliminated"),this.endRound(g.Defenders);return}if(n===0&&o.length>0){console.log("[GameWorld] Round ending: All defenders eliminated"),this.endRound(g.Attackers);return}}else{if(s===0&&i.length>0){console.log("[GameWorld] Round ending: All attackers eliminated"),this.endRound(g.Defenders);return}if(n===0&&o.length>0){console.log("[GameWorld] Round ending: All defenders eliminated"),this.endRound(g.Attackers);return}}if(t>=U.ROUND_TIME){this.endRound(g.Defenders);return}if(this.objectives.spikePlanted){const a=this.time-this.objectives.spikePlantTime;this.objectives.spikeProgress=a/U.SPIKE_UPLOAD_TIME,this.objectives.spikeProgress>=1&&this.endRound(g.Attackers)}}}processInput(e,t){const i=this.playersByPeerId.get(e);i&&i.setInput(t)}getState(){return{phase:this.phase,mode:this.config.mode,mapId:this.map.data.id,tick:this.tick,time:this.time,roundStartTime:this.roundStartTime,roundNumber:this.roundNumber,maxRounds:U.MAX_ROUNDS,roundTimeLimit:U.ROUND_TIME,attackerScore:this.attackerScore,defenderScore:this.defenderScore,players:new Map(Array.from(this.players.values()).map(e=>[e.peerId,e.toState()])),projectiles:new Map(Array.from(this.projectiles.entries()).map(([e,t])=>[e,t.toState()])),objectives:{...this.objectives},recentShots:[...this.recentShots],countdownTime:this.countdownTime,countdownPaused:this.countdownPaused,countdownPausedBy:this.countdownPausedBy,aircraft:new Map(Array.from(this.aircraft.entries()).map(([e,t])=>[e,t.toState()])),supplyCrates:new Map(Array.from(this.supplyCrates.entries()).map(([e,t])=>[e,t.toState()]))}}applyState(e){this.phase=e.phase,this.tick=e.tick,this.time=e.time,this.roundStartTime=e.roundStartTime,this.roundNumber=e.roundNumber,this.attackerScore=e.attackerScore,this.defenderScore=e.defenderScore,e.countdownTime!==void 0&&(this.countdownTime=e.countdownTime),e.countdownPaused!==void 0&&(this.countdownPaused=e.countdownPaused),e.countdownPausedBy!==void 0&&(this.countdownPausedBy=e.countdownPausedBy),this.objectives={...e.objectives};const i=this.getLocalPlayer()?.peerId,o=new Set;for(const[n,a]of e.players){o.add(n);let r=this.playersByPeerId.get(n);if(!r)r=Oe.fromState(a),this.players.set(r.id,r),this.playersByPeerId.set(n,r),this.collisionWorld.addBody(r.getCollisionBody()),console.log(`[GameWorld] Created player from state: ${r.name} (${n})`),n===i&&(this.localPlayerId=r.id,console.log(`[GameWorld] Updated localPlayerId to ${r.id} for peerId ${n}`));else if(r.id===this.localPlayerId){const d=e.roundNumber!==this.roundNumber,h=!r.alive&&a.alive,m=a.position.x-r.position.x,u=a.position.y-r.position.y,p=m*m+u*u,w=p>1e4;(d||h||w)&&(r.position={...a.position},r.prevPosition={...a.position},r.velocity={...a.velocity},r.rotation=a.rotation,r.prevRotation=a.rotation,console.log(`[GameWorld] Force synced local player position (round: ${d}, respawn: ${h}, dist: ${Math.sqrt(p).toFixed(0)})`)),r.health=a.health,r.shield=a.shield,r.alive=a.alive,r.weapon={...a.weapon},r.abilities=a.abilities.map(x=>({...x})),r.team=a.team}else r.targetPosition={...a.position},r.targetRotation=a.rotation,r.velocity={...a.velocity},r.health=a.health,r.shield=a.shield,r.alive=a.alive,r.weapon={...a.weapon},r.abilities=a.abilities.map(d=>({...d})),r.team=a.team}for(const[n,a]of this.players)if(!o.has(a.peerId)){if(n===this.localPlayerId){console.log(`[GameWorld] Keeping local player even though not in host state: ${a.name}`);continue}console.log(`[GameWorld] Removing player not in state: ${a.name} (${a.peerId})`),this.removePlayer(n)}const s=new Set;for(const[n,a]of e.projectiles){s.add(n);let r=this.projectiles.get(n);r?(r.position={...a.position},r.velocity={...a.velocity}):(r=Ce.fromState(a),this.projectiles.set(n,r))}for(const n of this.projectiles.keys())s.has(n)||this.projectiles.delete(n);if(e.aircraft){const n=new Set;for(const[a,r]of e.aircraft){n.add(a);let c=this.aircraft.get(a);c?(c.position={...r.position},c.active=r.active,c.hasDropped=r.hasDropped):(c=et.fromState(r,this.time),this.aircraft.set(a,c))}for(const a of this.aircraft.keys())n.has(a)||this.aircraft.delete(a)}if(e.supplyCrates){const n=new Set;for(const[a,r]of e.supplyCrates){n.add(a);let c=this.supplyCrates.get(a);c?(c.position={...r.position},c.altitude=r.altitude,c.parachuteActive=r.parachuteActive,c.claimed=r.claimed,c.active=r.active):(c=vt.fromState(r),this.supplyCrates.set(a,c))}for(const a of this.supplyCrates.keys())n.has(a)||(this.supplyCrates.delete(a),this.collisionWorld.removeBody(a))}}getPendingEvents(){const e=[...this.pendingEvents];return this.pendingEvents=[],e}getPhase(){return this.phase}getTick(){return this.tick}getTime(){return this.time-this.roundStartTime}getAbsoluteTime(){return this.time}getRoundNumber(){return this.roundNumber}getMap(){return this.map}getProjectiles(){return Array.from(this.projectiles.values())}getGrenades(){return Array.from(this.grenades.values())}getAircraft(){return Array.from(this.aircraft.values())}getSupplyCrates(){return Array.from(this.supplyCrates.values())}getBombs(){return Array.from(this.bombs.values())}getRadioCallState(e){return this.radioCallState.get(e)||null}getAndClearRecentShots(){const e=this.recentShots;return this.recentShots=[],e}isEnemyOfLocal(e){const t=this.getLocalPlayer(),i=this.getPlayer(e);return!t||!i?!1:t.team!==i.team}getObjectives(){return{...this.objectives}}getScore(){return{attackers:this.attackerScore,defenders:this.defenderScore}}getAttackerScore(){return this.attackerScore}getDefenderScore(){return this.defenderScore}getRoundsToWin(){return this.roundsToWin}getTotalRounds(){return this.totalRounds}getCollisionWorld(){return this.collisionWorld}setPhase(e){this.phase=e}getCountdownTime(){return this.countdownTime}isCountdownPaused(){return this.countdownPaused}getCountdownPausedBy(){return this.countdownPausedBy}}class zs{particles=[];maxParticles=1e3;update(e){const t=e/1e3;for(let i=this.particles.length-1;i>=0;i--){const o=this.particles[i];if(o.life-=t,o.life<=0){this.particles.splice(i,1);continue}o.trail&&(o.trail.push({...o.position}),o.trail.length>10&&o.trail.shift()),o.velocity=f.add(o.velocity,f.mul(o.acceleration,t)),o.position=f.add(o.position,f.mul(o.velocity,t)),o.rotation+=o.rotationSpeed*t}}render(e){for(const t of this.particles){const i=t.life/t.maxLife,o=Math.min(1,i*2);switch(t.type){case"spark":this.renderSpark(e,t,o);break;case"smoke":this.renderSmoke(e,t,o);break;case"debris":this.renderDebris(e,t,o);break;case"energy":this.renderEnergy(e,t,o);break;case"glitch":this.renderGlitch(e,t,o);break;case"data":this.renderData(e,t,o);break;case"blood":this.renderBlood(e,t,o);break}}}renderSpark(e,t,i){const o=this.colorWithAlpha(t.color,i),s=f.length(t.velocity)*.03,n=f.normalize(t.velocity),a=f.sub(t.position,f.mul(n,s));e.drawLine(a.x,a.y,t.position.x,t.position.y,{color:o,width:t.size}),e.drawCircle(t.position.x,t.position.y,t.size*.5,{fill:o,glow:!0,glowColor:t.color,glowSize:t.size*2})}renderSmoke(e,t,i){const o=t.size*(1+(1-t.life/t.maxLife)*2),s=this.colorWithAlpha(t.color,i*.5);e.drawCircle(t.position.x,t.position.y,o,{fill:s})}renderDebris(e,t,i){const o=this.colorWithAlpha(t.color,i),s=t.size,n=e.ctx;n.save(),n.translate(t.position.x,t.position.y),n.rotate(t.rotation),n.fillStyle=o,n.fillRect(-s/2,-s/2,s,s),n.restore()}renderEnergy(e,t,i){const o=this.colorWithAlpha(t.color,i);if(e.drawCircle(t.position.x,t.position.y,t.size,{fill:o,glow:!0,glowColor:t.color,glowSize:t.size*3}),t.trail&&t.trail.length>1)for(let s=1;s<t.trail.length;s++){const n=t.trail[s-1],a=t.trail[s],r=s/t.trail.length*i*.5;e.drawLine(n.x,n.y,a.x,a.y,{color:this.colorWithAlpha(t.color,r),width:t.size*.5})}}renderGlitch(e,t,i){const o=this.colorWithAlpha(t.color,i),s=(Math.random()-.5)*10,n=(Math.random()-.5)*5,a=t.size*2+Math.random()*10,r=t.size*.5,c=e.ctx;c.fillStyle=o,c.fillRect(t.position.x+s-a/2,t.position.y+n-r/2,a,r)}renderData(e,t,i){const o=this.colorWithAlpha(t.color,i),s=Math.random()>.5?"1":"0",n=e.ctx;n.font=`${t.size*2}px monospace`,n.fillStyle=o,n.textAlign="center",n.textBaseline="middle",n.fillText(s,t.position.x,t.position.y)}renderBlood(e,t,i){const o=t.size*(1+(1-t.life/t.maxLife)*.5),s=this.colorWithAlpha(t.color,i*.8);e.drawCircle(t.position.x,t.position.y,o,{fill:s})}emit(e){const{count:t,position:i,direction:o=0,spread:s=Math.PI*2,speed:n,size:a,life:r,colors:c,type:d,gravity:h=0,friction:m=0,rotationSpeed:u={min:0,max:0},trail:p=!1}=e;for(let w=0;w<t&&this.particles.length<this.maxParticles;w++){const x=o+(Math.random()-.5)*s,S=n.min+Math.random()*(n.max-n.min),k=a.min+Math.random()*(a.max-a.min),I=r.min+Math.random()*(r.max-r.min),T=c[Math.floor(Math.random()*c.length)],R=u.min+Math.random()*(u.max-u.min);this.particles.push({position:{...i},velocity:f.mul(f.fromAngle(x),S),acceleration:{x:m*-1,y:h},color:T,size:k,life:I,maxLife:I,rotation:Math.random()*Math.PI*2,rotationSpeed:R,type:d,trail:p?[]:void 0})}}bulletImpact(e,t){const i=Math.atan2(t.y,t.x);this.emit({count:8,position:e,direction:i,spread:Math.PI*.6,speed:{min:100,max:300},size:{min:1,max:3},life:{min:.1,max:.3},colors:[y.CYAN,y.YELLOW,"#ffffff"],type:"spark",gravity:300}),this.emit({count:3,position:e,spread:Math.PI*2,speed:{min:20,max:50},size:{min:3,max:6},life:{min:.2,max:.4},colors:["#666666","#888888","#aaaaaa"],type:"smoke",gravity:-50})}bulletHitPlayer(e,t){const i=Math.atan2(t.y,t.x);this.emit({count:12,position:e,direction:i+Math.PI,spread:Math.PI*.8,speed:{min:80,max:200},size:{min:2,max:4},life:{min:.15,max:.35},colors:[y.MAGENTA,y.CYAN,"#ff4488"],type:"energy",gravity:100,trail:!0})}playerDeath(e){this.emit({count:30,position:e,spread:Math.PI*2,speed:{min:150,max:400},size:{min:3,max:8},life:{min:.3,max:.8},colors:[y.CYAN,y.MAGENTA,"#ff4488","#44ffaa"],type:"energy",gravity:200,trail:!0}),this.emit({count:20,position:e,spread:Math.PI*2,speed:{min:50,max:150},size:{min:4,max:12},life:{min:.2,max:.5},colors:[y.CYAN,y.MAGENTA,"#ffffff"],type:"glitch"}),this.emit({count:15,position:e,spread:Math.PI*2,speed:{min:100,max:250},size:{min:6,max:12},life:{min:.4,max:1},colors:[y.CYAN,"#00ff88",y.MAGENTA],type:"data",gravity:150}),this.emit({count:15,position:e,spread:Math.PI*2,speed:{min:100,max:300},size:{min:3,max:8},life:{min:.3,max:.7},colors:["#333344","#444455","#555566","#2a2a3a"],type:"debris",gravity:500,rotationSpeed:{min:-10,max:10}})}weaponSwitch(e){this.emit({count:8,position:e,spread:Math.PI*2,speed:{min:30,max:80},size:{min:2,max:4},life:{min:.15,max:.3},colors:[y.CYAN,y.YELLOW],type:"energy"})}muzzleFlashParticles(e,t){this.emit({count:5,position:e,direction:t,spread:Math.PI*.3,speed:{min:200,max:400},size:{min:1,max:2},life:{min:.05,max:.15},colors:[y.YELLOW,"#ffaa00","#ffffff"],type:"spark",gravity:300})}blinkEffect(e){this.emit({count:20,position:e,spread:Math.PI*2,speed:{min:100,max:300},size:{min:3,max:8},life:{min:.2,max:.5},colors:[y.CYAN,y.MAGENTA,"#ffffff"],type:"energy"}),this.emit({count:10,position:e,spread:Math.PI*2,speed:{min:50,max:150},size:{min:4,max:8},life:{min:.3,max:.6},colors:[y.CYAN,"#00ffaa"],type:"data"})}blinkTrail(e,t){const i=f.distance(e,t),o=Math.floor(i/20);for(let s=0;s<o;s++){const n=s/o,a=f.lerp(e,t,n);this.emit({count:2,position:a,spread:Math.PI*2,speed:{min:20,max:50},size:{min:2,max:4},life:{min:.1,max:.3},colors:[y.CYAN,y.MAGENTA],type:"energy"})}}shockwaveEffect(e,t,i=y.CYAN){const o=Math.floor(t/5);for(let s=0;s<o;s++){const n=s/o*Math.PI*2,a={x:e.x+Math.cos(n)*t*.8,y:e.y+Math.sin(n)*t*.8};this.emit({count:1,position:a,direction:n,spread:.2,speed:{min:50,max:100},size:{min:4,max:8},life:{min:.2,max:.4},colors:[i,"#ffffff"],type:"energy"})}}shieldEffect(e,t="#00aaff"){this.emit({count:15,position:e,spread:Math.PI*2,speed:{min:20,max:60},size:{min:3,max:6},life:{min:.5,max:1},colors:[t,"#ffffff"],type:"energy"})}cloakEffect(e){this.emit({count:12,position:e,spread:Math.PI*2,speed:{min:10,max:40},size:{min:4,max:8},life:{min:.3,max:.6},colors:["#4444ff","#8888ff","#aaaaff"],type:"glitch"})}revealEffect(e,t){this.shockwaveEffect(e,t,y.YELLOW),this.emit({count:8,position:e,spread:Math.PI*2,speed:{min:30,max:80},size:{min:3,max:5},life:{min:.4,max:.8},colors:[y.YELLOW,"#ffaa00"],type:"data"})}healBurstEffect(e,t="#00ff88"){this.emit({count:20,position:e,spread:Math.PI*2,speed:{min:40,max:100},size:{min:3,max:6},life:{min:.5,max:1},colors:[t,"#00ffaa","#88ffaa"],type:"energy",gravity:-100}),this.emit({count:8,position:e,spread:Math.PI*2,speed:{min:20,max:60},size:{min:6,max:10},life:{min:.6,max:1.2},colors:[t,"#ffffff"],type:"data",gravity:-50})}poisonCloudEffect(e,t){const i=Math.floor(t/8);for(let o=0;o<i;o++){const s=Math.random()*Math.PI*2,n=Math.random()*t*.8,a={x:e.x+Math.cos(s)*n,y:e.y+Math.sin(s)*n};this.emit({count:2,position:a,spread:Math.PI*2,speed:{min:5,max:20},size:{min:8,max:16},life:{min:.8,max:1.5},colors:["#44ff44","#22aa22","#116611"],type:"smoke",gravity:-30})}}explosionEffect(e,t,i="#ff4400"){const o=Math.max(1,t/50);this.emit({count:Math.floor(30*o),position:e,spread:Math.PI*2,speed:{min:100,max:300},size:{min:4,max:12},life:{min:.2,max:.5},colors:[i,"#ff8800","#ffff00","#ffffff"],type:"spark",gravity:100}),this.emit({count:Math.floor(15*o),position:e,spread:Math.PI*2,speed:{min:30,max:80},size:{min:10,max:20},life:{min:.5,max:1},colors:["#333333","#444444","#222222"],type:"smoke",gravity:-50}),this.emit({count:Math.floor(10*o),position:e,spread:Math.PI*2,speed:{min:150,max:400},size:{min:2,max:5},life:{min:.3,max:.7},colors:["#666666","#888888","#444444"],type:"debris",gravity:400})}grenadeTrail(e){this.emit({count:3,position:e,spread:Math.PI*2,speed:{min:10,max:30},size:{min:2,max:4},life:{min:.1,max:.2},colors:["#888888","#666666"],type:"smoke"})}turretSpawnEffect(e){this.emit({count:20,position:e,spread:Math.PI*2,speed:{min:50,max:150},size:{min:3,max:6},life:{min:.3,max:.6},colors:[y.CYAN,"#00ffaa","#ffffff"],type:"energy"}),this.emit({count:10,position:e,spread:Math.PI*2,speed:{min:100,max:200},size:{min:1,max:3},life:{min:.1,max:.3},colors:[y.YELLOW,"#ffaa00"],type:"spark",gravity:200})}dashSlashEffect(e,t,i=y.CYAN){for(let o=-3;o<=3;o++){const s=t+o*.15,n={x:e.x+Math.cos(s)*40,y:e.y+Math.sin(s)*40};this.emit({count:3,position:n,direction:s,spread:.3,speed:{min:100,max:200},size:{min:3,max:6},life:{min:.1,max:.25},colors:[i,"#ffffff"],type:"energy"})}}domeShieldEffect(e,t,i="#4488ff"){for(let s=0;s<12;s++){const n=s/12*Math.PI*2,a={x:e.x+Math.cos(n)*t,y:e.y+Math.sin(n)*t};this.emit({count:2,position:a,direction:n+Math.PI/2,spread:.5,speed:{min:20,max:50},size:{min:3,max:6},life:{min:.4,max:.8},colors:[i,"#ffffff"],type:"energy"})}}fireZoneEffect(e,t){const i=Math.floor(t/15);for(let o=0;o<i;o++){const s=Math.random()*Math.PI*2,n=Math.random()*t*.8,a={x:e.x+Math.cos(s)*n,y:e.y+Math.sin(s)*n};this.emit({count:2,position:a,spread:.5,speed:{min:30,max:80},size:{min:4,max:10},life:{min:.2,max:.5},colors:["#ff4400","#ff8800","#ffaa00"],type:"spark",gravity:-100})}}stunEffect(e){this.emit({count:15,position:e,spread:Math.PI*2,speed:{min:50,max:150},size:{min:2,max:5},life:{min:.2,max:.4},colors:["#ffff00","#ffffff","#ffff88"],type:"spark"}),this.emit({count:8,position:e,spread:Math.PI*2,speed:{min:20,max:60},size:{min:4,max:8},life:{min:.3,max:.6},colors:["#00ffff","#88ffff"],type:"glitch"})}markedEffect(e){this.emit({count:6,position:e,spread:Math.PI*2,speed:{min:10,max:30},size:{min:3,max:5},life:{min:.5,max:1},colors:["#ff0000","#ff4444"],type:"energy",gravity:-20})}clear(){this.particles=[]}getParticleCount(){return this.particles.length}colorWithAlpha(e,t){if(e.startsWith("#")){const i=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16);return`rgba(${i}, ${o}, ${s}, ${t})`}return e.startsWith("rgba")?e.replace(/[\d.]+\)$/,`${t})`):e}}class Ns{renderer;world;muzzleFlashes=[];bulletTracers=[];particleSystem;pickupNotifications=[];matchEndConfetti=[];matchEndStartTime=0;lastMatchEndPhase=!1;appVersion;constructor(e,t,i){this.renderer=e,this.world=t,this.appVersion=i,this.particleSystem=new zs}render(e){this.renderer.beginFrame();const t=this.world.getLocalPlayer();if(t){const i=Ge(t.prevPosition.x,t.position.x,e),o=Ge(t.prevPosition.y,t.position.y,e);this.renderer.setCamera(i,o,1)}else this.renderer.setCamera(this.world.getMap().getWidth()/2,this.world.getMap().getHeight()/2,.8);this.renderer.beginWorld(),this.renderMap(),this.renderAbilityEffects(),this.renderVisualEffects(e);for(const i of this.world.getPlayers())this.renderPlayer(i,e,i.id===t?.id);for(const i of this.world.getProjectiles())this.renderProjectile(i,e);for(const i of this.world.getGrenades())this.renderGrenade(i);for(const i of this.world.getBombs())this.renderBomb(i);this.renderSupplyDropSystem(e),this.renderBulletTracers(),this.renderMuzzleFlashes(),this.particleSystem.render(this.renderer),this.renderRadioCallIndicator(),this.renderer.endWorld(),this.renderUI(),this.renderer.endFrame()}renderMap(){const e=this.world.getMap(),t=e.getTileSize(),i=e.data.tiles,o=this.renderer.getCameraOffset(),s=this.renderer.getCameraZoom(),n=this.renderer.getWidth()/s,a=this.renderer.getHeight()/s,r=Math.max(0,Math.floor(o.x/t)),c=Math.max(0,Math.floor(o.y/t)),d=Math.min(i[0]?.length??0,Math.ceil((o.x+n)/t)+1),h=Math.min(i.length,Math.ceil((o.y+a)/t)+1);this.renderer.drawRect(0,0,e.getWidth(),e.getHeight(),{fill:"#151520"}),this.renderer.drawDebugGrid(t,"#1a1a2a");for(let u=c;u<h;u++){const p=i[u];if(p)for(let w=r;w<d;w++)p[w]===1&&this.renderer.drawRect(w*t,u*t,t,t,{fill:"#2a2a3a",stroke:"#3a3a4a",strokeWidth:1})}for(let u=0;u<e.data.spikeSites.length;u++){const p=e.data.spikeSites[u];this.renderer.drawNeonRect(p,u===0?y.CYAN:y.MAGENTA,.5),this.renderer.drawText(`SITE ${String.fromCharCode(65+u)}`,p.x+p.width/2,p.y+p.height/2,{color:"#fff",align:"center",baseline:"middle",size:16})}const m=this.world.getObjectives();if(m.spikePlanted&&m.spikePosition){const u=m.spikePosition.x,p=m.spikePosition.y,w=Math.sin(this.world.getAbsoluteTime()*.01)*.3+.7;this.renderer.drawCircle(u,p,25+w*5,{fill:`rgba(255, 50, 50, ${w*.3})`,glow:!0,glowColor:"#ff0000",glowSize:20}),this.renderer.drawCircle(u,p,15,{fill:"#ff2222",stroke:"#ff6666",strokeWidth:3,glow:!0,glowColor:"#ff0000",glowSize:15}),this.renderer.drawCircle(u,p,6,{fill:"#ffffff",glow:!0,glowColor:"#ff0000",glowSize:8}),this.renderer.drawText(" SPIKE",u,p-35,{color:"#ff4444",align:"center",size:12});const x=60,S=8,k=u-x/2,I=p+25;this.renderer.drawRect(k,I,x,S,{fill:"rgba(0, 0, 0, 0.7)",stroke:"#ff4444",strokeWidth:1});const T=m.spikeProgress;T>0&&this.renderer.drawRect(k+1,I+1,(x-2)*T,S-2,{fill:T>.7?"#ff0000":"#ff4444"})}}renderPlayer(e,t,i){const o=Ge(e.prevPosition.x,e.position.x,t),s=Ge(e.prevPosition.y,e.position.y,t),n=e.rotation,a=e.team===g.Attackers?y.ATTACKER:y.DEFENDER,r=i?y.CYAN:a;if(e.isInvisible&&!i)return;if(!e.alive){const p=this.world.getAbsoluteTime()-e.deathTime,w=1e3;if(p>w)return;const x=1-p/w,S=`rgba(51, 51, 51, ${x})`;this.renderer.drawCircle(o,s,16,{fill:S,stroke:`rgba(100, 100, 100, ${x*.5})`,strokeWidth:2});return}if(this.renderer.drawCircle(o,s,16,{fill:e.isInvisible?`${a}4D`:a,stroke:e.isInvisible?`${r}4D`:r,strokeWidth:i?3:2,glow:i&&!e.isInvisible,glowColor:r,glowSize:10}),e.alive){const p=o+Math.cos(n)*20,w=s+Math.sin(n)*20;this.renderer.drawLine(o,s,p,w,{color:e.isInvisible?"rgba(255,255,255,0.3)":"#fff",width:2});const x=o+Math.cos(n)*30,S=s+Math.sin(n)*30;if(this.renderer.drawCircle(x,S,4,{fill:e.isInvisible?`${y.CYAN}4D`:y.CYAN,glow:!e.isInvisible,glowColor:y.CYAN,glowSize:5}),e.isStunned&&this.renderer.drawCircle(o,s-25,8,{fill:"rgba(255, 255, 0, 0.8)",glow:!0,glowColor:y.YELLOW,glowSize:10}),this.world.getEffectSystem().getEffect(e.id,L.Marked)){const I=Math.sin(this.world.getAbsoluteTime()*.01)*.3+.7;this.renderer.drawCircle(o,s,28+I*5,{stroke:`rgba(255, 50, 50, ${I})`,strokeWidth:3,glow:!0,glowColor:"#ff0000",glowSize:15});const T=s-55;this.renderer.drawCircle(o,T,10,{stroke:"#ff4444",strokeWidth:2,glow:!0,glowColor:"#ff0000",glowSize:10}),this.renderer.drawLine(o-16,T,o-6,T,{color:"#ff4444",width:2}),this.renderer.drawLine(o+6,T,o+16,T,{color:"#ff4444",width:2}),this.renderer.drawLine(o,T-16,o,T-6,{color:"#ff4444",width:2}),this.renderer.drawLine(o,T+6,o,T+16,{color:"#ff4444",width:2}),this.renderer.drawText(" MARKED",o,s-72,{color:"#ff4444",align:"center",size:10})}}this.renderer.drawHealthBar(o-20,s-30,40,6,e.health,e.maxHealth,e.shield,e.maxShield),this.renderer.drawText(e.name,o,s-40,{color:"#fff",align:"center",size:10});const d=ee[e.heroId];this.renderer.drawText(d.name.charAt(0),o,s,{color:"#fff",align:"center",baseline:"middle",size:14,glow:!0,glowColor:"#000",glowSize:2});const h=this.world.getObjectives();if(h.spikeCarrierId===e.id&&!h.spikePlanted){const p=Math.sin(this.world.getAbsoluteTime()*.008)*.2+.8;this.renderer.drawText("",o+25,s-10,{color:"#ff4444",align:"center",size:14}),this.renderer.drawCircle(o,s,22,{stroke:`rgba(255, 100, 50, ${p})`,strokeWidth:2})}if((h.plantingPeerId===e.peerId||h.plantingPlayerId===e.id)&&h.plantingProgress>0){const x=o-25,S=s+30;this.renderer.drawRect(x,S,50,6,{fill:"rgba(0, 0, 0, 0.8)",stroke:"#ff8800",strokeWidth:1}),this.renderer.drawRect(x+1,S+1,48*h.plantingProgress,4,{fill:"#ff8800"}),this.renderer.drawText("PLANTING...",o,S+6+10,{color:"#ff8800",align:"center",size:8})}if((h.defusingPeerId===e.peerId||h.defusingPlayerId===e.id)&&h.defusingProgress>0){const x=o-25,S=s+30;this.renderer.drawRect(x,S,50,6,{fill:"rgba(0, 0, 0, 0.8)",stroke:"#00ff88",strokeWidth:1}),this.renderer.drawRect(x+1,S+1,48*h.defusingProgress,4,{fill:"#00ff88"}),this.renderer.drawText("DEFUSING...",o,S+6+10,{color:"#00ff88",align:"center",size:8})}}renderProjectile(e,t){const i=e.position.x,o=e.position.y;this.renderer.drawCircle(i,o,4,{fill:y.YELLOW,glow:!0,glowColor:y.YELLOW,glowSize:8});const s=i-e.velocity.x*.02,n=o-e.velocity.y*.02;this.renderer.drawLine(s,n,i,o,{color:y.YELLOW,width:2})}renderGrenade(e){const t=e.position.x,i=e.position.y,o=performance.now(),s=e.fuseTime/3e3,n=5-s*4,a=Math.abs(Math.sin(o/(100/n)));this.renderer.drawCircle(t,i,8,{fill:"#2a2a2a",stroke:"#ff4444",strokeWidth:2});const r=s>.5?"#ffaa00":"#ff0000",c=4+a*6;this.renderer.drawCircle(t,i,c,{fill:r,glow:!0,glowColor:r,glowSize:8+a*12});const d=12,h=t+Math.cos(e.rotation)*d,m=i+Math.sin(e.rotation)*d;this.renderer.drawLine(t,i,h,m,{color:r,width:2})}renderRadioCallIndicator(){const e=this.world.getLocalPlayer();if(!e)return;const t=this.world.getRadioCallState(e.id);if(!t||!t.firstClick||!t.awaitingSecondClick)return;const i=t.firstClick,o={x:e.input.aimX,y:e.input.aimY};if(t.type==="bomb"){const s=o.x-i.x,n=o.y-i.y,a=Math.sqrt(s*s+n*n),r=Math.atan2(n,s);if(a>20){const m=Math.floor(a/35);for(let W=0;W<m;W++){const $=W*35,Y=$+20,Z=i.x+Math.cos(r)*$,N=i.y+Math.sin(r)*$,O=i.x+Math.cos(r)*Y,ve=i.y+Math.sin(r)*Y;this.renderer.drawLine(Z,N,O,ve,{color:y.MAGENTA,width:3})}const u=30,p=o.x,w=o.y,x=p+Math.cos(r)*u,S=w+Math.sin(r)*u,k=p+Math.cos(r+Math.PI*.7)*u*.8,I=w+Math.sin(r+Math.PI*.7)*u*.8,T=p+Math.cos(r-Math.PI*.7)*u*.8,R=w+Math.sin(r-Math.PI*.7)*u*.8;this.renderer.drawPolygon([{x,y:S},{x:k,y:I},{x:T,y:R}],{fill:y.MAGENTA,stroke:"#FFFFFF",strokeWidth:2,glow:!0,glowColor:y.MAGENTA,glowSize:15})}this.renderer.drawCircle(i.x,i.y,12,{stroke:y.MAGENTA,strokeWidth:3,glow:!0,glowColor:y.MAGENTA,glowSize:10}),this.renderer.drawText("BOMBING RUN",(i.x+o.x)/2,(i.y+o.y)/2-30,{color:y.MAGENTA,align:"center",size:16})}else if(t.type==="missile"){const s=e.input.aimX,n=e.input.aimY,a=performance.now(),r=250+Math.sin(a/150)*20;this.renderer.drawCircle(s,n,r,{stroke:"#ff6600",strokeWidth:3,glow:!0,glowColor:"#ff6600",glowSize:15}),this.renderer.drawCircle(s,n,r*.5,{stroke:"#ff3300",strokeWidth:2,glow:!0,glowColor:"#ff3300",glowSize:10});const c=15;this.renderer.drawLine(s-c,n,s+c,n,{color:"#ff0000",width:2}),this.renderer.drawLine(s,n-c,s,n+c,{color:"#ff0000",width:2});const d=300,h=.3+Math.sin(a/100)*.2,m=[{angle:-Math.PI*.25},{angle:Math.PI*.25},{angle:Math.PI*.75},{angle:-Math.PI*.75}];for(const u of m){const p=s+Math.cos(u.angle)*d,w=n+Math.sin(u.angle)*d;this.renderer.drawLine(p,w,s,n,{color:`rgba(255, 0, 0, ${h})`,width:2}),this.renderer.drawLine(p,w,s,n,{color:`rgba(255, 200, 200, ${h*.7})`,width:1})}this.renderer.drawText("MISSILE STRIKE",s,n-r-30,{color:"#ff6600",align:"center",size:18}),this.renderer.drawText("INCOMING",s,n-r-50,{color:"#ff0000",align:"center",size:14})}}renderBomb(e){const t=e.position.x,i=e.position.y,o=e.launchPosition&&e.targetPosition&&e.launchTime!==void 0;if(o&&e.trail.length>1)for(let n=0;n<e.trail.length-1;n++){const a=e.trail[n],r=e.trail[n+1];if(!a||!r)continue;const c=n/e.trail.length*.6,d=3+n/e.trail.length*2;this.renderer.drawLine(a.x,a.y,r.x,r.y,{color:`rgba(255, 255, 255, ${c})`,width:d})}const s=.3+(1-e.altitude/1200)*.7;if(o){const n=18*s,a=5*s;let r=-Math.PI/2;if(e.trail.length>=2){const k=e.trail[e.trail.length-2],I=e.position;k&&(r=Math.atan2(I.y-k.y,I.x-k.x))}const c=Math.max(0,1-e.altitude/1200);this.renderer.drawCircle(t,i,8+c*8,{fill:`rgba(0, 0, 0, ${c*.5})`});const d=Math.cos(r),h=Math.sin(r),m={x:t+d*n/2,y:i+h*n/2},u={x:t-h*a/2,y:i+d*a/2},p={x:t+h*a/2,y:i-d*a/2},w={x:t-d*n/3-h*a/3,y:i-h*n/3+d*a/3},x={x:t-d*n/3+h*a/3,y:i-h*n/3-d*a/3},S={x:t-d*n/3,y:i-h*n/3};if(this.renderer.drawPolygon([m,u,w,S,x,p],{fill:"#ff6600",stroke:"#ff3300",strokeWidth:2}),this.renderer.drawCircle(m.x-d*n*.3,m.y-h*n*.3,a*.5,{fill:"#ffaa00",glow:!0,glowColor:"#ff6600",glowSize:10*s}),e.altitude>20){const k=15+s*15,I=Math.min(.9,e.altitude/200);this.renderer.drawLine(S.x,S.y,S.x-d*k,S.y-h*k,{color:`rgba(255, 150, 50, ${I})`,width:5*s}),this.renderer.drawLine(S.x,S.y,S.x-d*k*.6,S.y-h*k*.6,{color:`rgba(255, 255, 200, ${I*.9})`,width:3*s})}}else{const n=8+s*10,a=Math.max(0,1-e.altitude/1200),r=8+a*12;this.renderer.drawCircle(t,i,r*1.5,{fill:`rgba(0, 0, 0, ${a*.2})`}),this.renderer.drawCircle(t,i,r,{fill:`rgba(0, 0, 0, ${a*.5})`});const c=.6+a*.4;if(this.renderer.drawCircle(t,i,n,{fill:`rgba(40, 40, 40, ${c})`,stroke:`rgba(60, 60, 60, ${c})`,strokeWidth:2*s}),s>.6&&this.renderer.drawCircle(t,i,n*.7,{fill:`rgba(255, 200, 0, ${a*.6})`}),this.renderer.drawCircle(t,i,n*.4,{fill:`rgba(255, 100, 0, ${c})`,glow:!0,glowColor:"#ff6600",glowSize:n*.5}),e.altitude>30){const d=15+(400-e.altitude)/10,h=Math.min(.7,(400-e.altitude)/300),m=Math.abs(e.velocity.x)>.01||Math.abs(e.velocity.y)>.01,u=m?t-e.velocity.x*100:t,p=m?i-e.velocity.y*100:i-d;this.renderer.drawLine(t,i,u,p,{color:`rgba(120, 120, 120, ${h})`,width:2+s*2}),this.renderer.drawLine(t,i,t+(u-t)*.5,i+(p-i)*.5,{color:`rgba(180, 180, 180, ${h*.7})`,width:1+s})}}}renderSupplyDropSystem(e){const t=performance.now();for(const i of this.world.getAircraft()){const o=1+i.altitude/500,s=Math.PI/4,n=i.altitude*.8,a=Math.cos(s)*n,r=Math.sin(s)*n,c=i.altitude/10,d=Math.max(.15,.5-i.altitude/2e3),h=i.getRotation(),m=i.position.x+a,u=i.position.y+r,p=this.renderer.getContext();p.save(),p.translate(m,u),p.rotate(h),i.type===ge.Bomber?(p.fillStyle=`rgba(0, 0, 0, ${d*.2})`,p.fillRect(-40-c,-25-c,80+c*2,50+c*2),p.fillStyle=`rgba(0, 0, 0, ${d*.6})`,p.fillRect(-35,-8,70,16),p.fillRect(-30,-22,60,44),p.fillRect(-38,-5,8,10)):(p.fillStyle=`rgba(0, 0, 0, ${d*.2})`,p.beginPath(),p.moveTo(-35-c,0),p.lineTo(0,-20-c),p.lineTo(35+c,0),p.lineTo(0,15+c),p.closePath(),p.fill(),p.fillStyle=`rgba(0, 0, 0, ${d*.6})`,p.beginPath(),p.moveTo(-30,0),p.lineTo(0,-18),p.lineTo(30,0),p.lineTo(0,12),p.closePath(),p.fill()),p.restore(),i.type===ge.Bomber?this.renderB52Bomber(i,h,o,t):this.renderB2Spirit(i,h,o,t)}for(const i of this.world.getSupplyCrates()){if(!i.active)continue;const o=i.supplyType==="weapon"?y.MAGENTA:i.supplyType==="health_kit"?"#44FF44":i.supplyType==="shield"?y.CYAN:i.supplyType==="credits"?y.YELLOW:i.supplyType==="bomb_call"?y.MAGENTA:i.supplyType==="missile_strike"?"#ff6600":"#FF8800",s=i.supplyType==="weapon"?"#FF00FF":i.supplyType==="health_kit"?"#00FF00":i.supplyType==="shield"?"#00FFFF":i.supplyType==="credits"?"#FFFF00":i.supplyType==="bomb_call"?"#FF00FF":i.supplyType==="missile_strike"?"#ff6600":"#FFA500";if(i.parachuteActive&&i.altitude>0){const h=20+i.altitude/10;this.renderer.drawCircle(i.position.x,i.position.y,h,{fill:"rgba(255, 100, 100, 0.3)",stroke:"rgba(255, 50, 50, 0.8)",strokeWidth:2}),this.renderer.drawCircle(i.position.x,i.position.y,h*.7,{fill:"rgba(255, 150, 150, 0.2)",stroke:"rgba(255, 100, 100, 0.6)",strokeWidth:1}),this.renderer.drawCircle(i.position.x,i.position.y,h*.2,{fill:"rgba(0, 0, 0, 0.3)"});for(let m=0;m<8;m++){const u=m/8*Math.PI*2;this.renderer.drawLine(i.position.x+Math.cos(u)*h*.9,i.position.y+Math.sin(u)*h*.9,i.position.x,i.position.y,{color:"rgba(200, 200, 200, 0.6)",width:1})}}const n=15+(200-i.altitude)/10,a=Math.max(.1,Math.min(.4,(200-i.altitude)/200));this.renderer.drawCircle(i.position.x,i.position.y,n,{fill:`rgba(0, 0, 0, ${a})`});const r=i.claimed?12:18,c=t/800%(Math.PI*2),d=1+Math.sin(c)*.15;if(!i.claimed&&i.isLanded()&&this.renderer.drawCircle(i.position.x,i.position.y,r*2*d,{fill:`${o}20`}),this.renderer.drawCircle(i.position.x,i.position.y,r,{fill:i.claimed?"#333333":`${o}40`,stroke:i.claimed?"#555555":o,strokeWidth:2,glow:!i.claimed,glowColor:o,glowSize:20*d}),i.claimed||this.renderer.drawCircle(i.position.x,i.position.y,r*.7,{fill:s,glow:!0,glowColor:s,glowSize:8}),!i.claimed){let h="?";i.supplyType==="weapon"?h="":i.supplyType==="health_kit"?h="":i.supplyType==="shield"?h="":i.supplyType==="credits"?h="":i.supplyType==="grenade"&&(h=""),this.renderer.drawText(h,i.position.x,i.position.y,{color:"#FFFFFF",align:"center",size:14})}if(i.isLanded()&&!i.claimed)for(let h=0;h<3;h++){const m=t/1500+h*Math.PI*2/3,u=r+8,p=i.position.x+Math.cos(m)*u,w=i.position.y+Math.sin(m)*u;this.renderer.drawCircle(p,w,2,{fill:o,glow:!0,glowColor:o,glowSize:4})}}}renderB2Spirit(e,t,i,o){const s=Math.cos(t),n=Math.sin(t),a=[{x:e.position.x+s*30,y:e.position.y+n*30},{x:e.position.x+s*25-n*15,y:e.position.y+n*25+s*15},{x:e.position.x+s*15-n*35,y:e.position.y+n*15+s*35},{x:e.position.x+s*0-n*45,y:e.position.y+n*0+s*45},{x:e.position.x-s*10-n*48,y:e.position.y-n*10+s*48},{x:e.position.x-s*15-n*45,y:e.position.y-n*15+s*45},{x:e.position.x-s*25-n*35,y:e.position.y-n*25+s*35},{x:e.position.x-s*28-n*22,y:e.position.y-n*28+s*22},{x:e.position.x-s*32-n*18,y:e.position.y-n*32+s*18},{x:e.position.x-s*35-n*8,y:e.position.y-n*35+s*8},{x:e.position.x-s*35,y:e.position.y-n*35},{x:e.position.x-s*35+n*8,y:e.position.y-n*35-s*8},{x:e.position.x-s*32+n*18,y:e.position.y-n*32-s*18},{x:e.position.x-s*28+n*22,y:e.position.y-n*28-s*22},{x:e.position.x-s*25+n*35,y:e.position.y-n*25-s*35},{x:e.position.x-s*15+n*45,y:e.position.y-n*15-s*45},{x:e.position.x-s*10+n*48,y:e.position.y-n*10-s*48},{x:e.position.x+s*0+n*45,y:e.position.y+n*0-s*45},{x:e.position.x+s*15+n*35,y:e.position.y+n*15-s*35},{x:e.position.x+s*25+n*15,y:e.position.y+n*25-s*15}];this.renderer.drawPolygon(a,{fill:"#0a0a12",stroke:y.CYAN,strokeWidth:1.5}),this.renderer.drawLine(e.position.x+s*28,e.position.y+n*28,e.position.x-s*30,e.position.y-n*30,{color:"#1a1a2e",width:3}),this.renderer.drawCircle(e.position.x+s*22,e.position.y+n*22,5,{fill:"#0CE5F0",glow:!0,glowColor:y.CYAN,glowSize:8});const r=.6+Math.sin(o/100)*.4;this.renderer.drawCircle(e.position.x-s*30-n*20,e.position.y-n*30+s*20,3,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:10*r}),this.renderer.drawCircle(e.position.x-s*32-n*10,e.position.y-n*32+s*10,3,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:10*r}),this.renderer.drawCircle(e.position.x-s*32+n*10,e.position.y-n*32-s*10,3,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:10*r}),this.renderer.drawCircle(e.position.x-s*30+n*20,e.position.y-n*30-s*20,3,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:10*r});const c=40,d=.4*r;this.renderer.drawLine(e.position.x-s*30-n*20,e.position.y-n*30+s*20,e.position.x-s*(30+c)-n*20,e.position.y-n*(30+c)+s*20,{color:`rgba(255, 0, 255, ${d})`,width:3}),this.renderer.drawLine(e.position.x-s*32-n*10,e.position.y-n*32+s*10,e.position.x-s*(32+c)-n*10,e.position.y-n*(32+c)+s*10,{color:`rgba(255, 0, 255, ${d})`,width:3}),this.renderer.drawLine(e.position.x-s*32+n*10,e.position.y-n*32-s*10,e.position.x-s*(32+c)+n*10,e.position.y-n*(32+c)-s*10,{color:`rgba(255, 0, 255, ${d})`,width:3}),this.renderer.drawLine(e.position.x-s*30+n*20,e.position.y-n*30-s*20,e.position.x-s*(30+c)+n*20,e.position.y-n*(30+c)-s*20,{color:`rgba(255, 0, 255, ${d})`,width:3}),this.renderer.drawCircle(e.position.x-s*8-n*46,e.position.y-n*8+s*46,2,{fill:"#FF4444",glow:!0,glowColor:"#FF4444",glowSize:4}),this.renderer.drawCircle(e.position.x-s*8+n*46,e.position.y-n*8-s*46,2,{fill:"#44FF44",glow:!0,glowColor:"#44FF44",glowSize:4})}renderB52Bomber(e,t,i,o){const s=Math.cos(t),n=Math.sin(t),a=[{x:e.position.x+s*40,y:e.position.y+n*40},{x:e.position.x+s*30-n*20,y:e.position.y+n*30+s*20},{x:e.position.x+s*20-n*50,y:e.position.y+n*20+s*50},{x:e.position.x+s*0-n*65,y:e.position.y+n*0+s*65},{x:e.position.x-s*10-n*68,y:e.position.y-n*10+s*68},{x:e.position.x-s*20-n*65,y:e.position.y-n*20+s*65},{x:e.position.x-s*30-n*55,y:e.position.y-n*30+s*55},{x:e.position.x-s*35-n*30,y:e.position.y-n*35+s*30},{x:e.position.x-s*40-n*8,y:e.position.y-n*40+s*8},{x:e.position.x-s*45,y:e.position.y-n*45},{x:e.position.x-s*40+n*8,y:e.position.y-n*40-s*8},{x:e.position.x-s*35+n*30,y:e.position.y-n*35-s*30},{x:e.position.x-s*30+n*55,y:e.position.y-n*30-s*55},{x:e.position.x-s*20+n*65,y:e.position.y-n*20-s*65},{x:e.position.x-s*10+n*68,y:e.position.y-n*10-s*68},{x:e.position.x+s*0+n*65,y:e.position.y+n*0-s*65},{x:e.position.x+s*20+n*50,y:e.position.y+n*20-s*50},{x:e.position.x+s*30+n*20,y:e.position.y+n*30-s*20}];this.renderer.drawPolygon(a,{fill:"#2a2a3a",stroke:y.CYAN,strokeWidth:2}),this.renderer.drawLine(e.position.x+s*38,e.position.y+n*38,e.position.x-s*40,e.position.y-n*40,{color:"#3a3a4a",width:4}),this.renderer.drawCircle(e.position.x+s*32,e.position.y+n*32,6,{fill:"#0CE5F0",glow:!0,glowColor:y.CYAN,glowSize:10});const r=.6+Math.sin(o/100)*.4;this.renderer.drawCircle(e.position.x-s*25-n*58,e.position.y-n*25+s*58,3.5,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:12*r}),this.renderer.drawCircle(e.position.x-s*27-n*50,e.position.y-n*27+s*50,3.5,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:12*r}),this.renderer.drawCircle(e.position.x-s*32-n*35,e.position.y-n*32+s*35,3.5,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:12*r}),this.renderer.drawCircle(e.position.x-s*34-n*27,e.position.y-n*34+s*27,3.5,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:12*r}),this.renderer.drawCircle(e.position.x-s*25+n*58,e.position.y-n*25-s*58,3.5,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:12*r}),this.renderer.drawCircle(e.position.x-s*27+n*50,e.position.y-n*27-s*50,3.5,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:12*r}),this.renderer.drawCircle(e.position.x-s*32+n*35,e.position.y-n*32-s*35,3.5,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:12*r}),this.renderer.drawCircle(e.position.x-s*34+n*27,e.position.y-n*34-s*27,3.5,{fill:y.MAGENTA,glow:!0,glowColor:y.MAGENTA,glowSize:12*r});const c=50,d=.5*r;this.renderer.drawLine(e.position.x-s*25-n*58,e.position.y-n*25+s*58,e.position.x-s*(25+c)-n*58,e.position.y-n*(25+c)+s*58,{color:`rgba(255, 0, 255, ${d})`,width:3.5}),this.renderer.drawLine(e.position.x-s*27-n*50,e.position.y-n*27+s*50,e.position.x-s*(27+c)-n*50,e.position.y-n*(27+c)+s*50,{color:`rgba(255, 0, 255, ${d})`,width:3.5}),this.renderer.drawLine(e.position.x-s*32-n*35,e.position.y-n*32+s*35,e.position.x-s*(32+c)-n*35,e.position.y-n*(32+c)+s*35,{color:`rgba(255, 0, 255, ${d})`,width:3.5}),this.renderer.drawLine(e.position.x-s*34-n*27,e.position.y-n*34+s*27,e.position.x-s*(34+c)-n*27,e.position.y-n*(34+c)+s*27,{color:`rgba(255, 0, 255, ${d})`,width:3.5}),this.renderer.drawLine(e.position.x-s*25+n*58,e.position.y-n*25-s*58,e.position.x-s*(25+c)+n*58,e.position.y-n*(25+c)-s*58,{color:`rgba(255, 0, 255, ${d})`,width:3.5}),this.renderer.drawLine(e.position.x-s*27+n*50,e.position.y-n*27-s*50,e.position.x-s*(27+c)+n*50,e.position.y-n*(27+c)-s*50,{color:`rgba(255, 0, 255, ${d})`,width:3.5}),this.renderer.drawLine(e.position.x-s*32+n*35,e.position.y-n*32-s*35,e.position.x-s*(32+c)+n*35,e.position.y-n*(32+c)-s*35,{color:`rgba(255, 0, 255, ${d})`,width:3.5}),this.renderer.drawLine(e.position.x-s*34+n*27,e.position.y-n*34-s*27,e.position.x-s*(34+c)+n*27,e.position.y-n*(34+c)-s*27,{color:`rgba(255, 0, 255, ${d})`,width:3.5}),this.renderer.drawCircle(e.position.x-s*8-n*66,e.position.y-n*8+s*66,3,{fill:"#FF4444",glow:!0,glowColor:"#FF4444",glowSize:6}),this.renderer.drawCircle(e.position.x-s*8+n*66,e.position.y-n*8-s*66,3,{fill:"#44FF44",glow:!0,glowColor:"#44FF44",glowSize:6})}renderMuzzleFlashes(){const e=performance.now();this.muzzleFlashes=this.muzzleFlashes.filter(t=>e-t.time<100);for(const t of this.muzzleFlashes){const i=e-t.time,o=1-i/100,s=15+i*.2;this.renderer.drawCircle(t.position.x+Math.cos(t.direction)*25,t.position.y+Math.sin(t.direction)*25,s*o,{fill:`rgba(255, 200, 100, ${o*.8})`,glow:!0,glowColor:y.YELLOW,glowSize:15*o})}}renderAbilityEffects(){const e=this.world.getAbilityEffects(),t=this.world.getTime();for(const i of e){const s=(t-i.startTime)/i.duration,n=1-s;switch(i.type){case"shield":this.renderShieldEffect(i,n);break;case"shockwave":this.renderShockwaveEffect(i,s);break;case"dash":this.renderDashEffect(i,n);break}}}renderShieldEffect(e,t){const{position:i,direction:o,radius:s=60}=e,n=o-Math.PI/3,a=o+Math.PI/3;for(let r=0;r<3;r++){const c=s+r*8,d=t*(1-r*.2);this.renderer.drawArc(i.x,i.y,c,n,a,{stroke:`rgba(100, 200, 255, ${d*.8})`,strokeWidth:4-r,glow:!0,glowColor:y.CYAN,glowSize:10})}}renderShockwaveEffect(e,t){const{position:i,radius:o=120}=e,s=o*t,n=1-t;if(this.renderer.drawCircle(i.x,i.y,s,{stroke:`rgba(255, 150, 50, ${n*.9})`,strokeWidth:6*(1-t),glow:!0,glowColor:"#ff9933",glowSize:20*n}),t<.3){const a=1-t/.3;this.renderer.drawCircle(i.x,i.y,o*.3,{fill:`rgba(255, 200, 100, ${a*.5})`,glow:!0,glowColor:y.YELLOW,glowSize:30*a})}}renderDashEffect(e,t){const{position:i,direction:o,radius:s=100}=e,n={x:i.x-Math.cos(o)*s,y:i.y-Math.sin(o)*s};this.renderer.drawLine(n.x,n.y,i.x,i.y,{color:`rgba(255, 100, 100, ${t*.8})`,width:8,glow:!0,glowColor:y.MAGENTA,glowSize:15})}renderVisualEffects(e){const t=this.world.getVisualEffects(),i=this.world.getTime(),o=t.filter(s=>s.type===V.BarrierWall);o.length>1&&console.warn(`[VFX] Multiple barrier effects: ${o.length}`);for(const s of t){const n=i-s.startTime,a=Math.max(0,Math.min(1,n/s.duration)),r=Math.max(0,Math.min(1,1-a));let c=s.position,d=s.direction||0;if(s.followPlayerId){const h=this.world.getPlayer(s.followPlayerId);h&&h.alive&&(c={x:Ge(h.prevPosition.x,h.position.x,e),y:Ge(h.prevPosition.y,h.position.y,e)},d=h.rotation)}switch(s.type){case V.Blink:case V.BlinkTrail:this.renderBlinkEffect(c,r);break;case V.Shockwave:this.renderNewShockwaveEffect(c,a,s.radius||128);break;case V.Shield:this.renderNewShieldEffect(c,r,s.color||y.CYAN);break;case V.DomeShield:this.renderDomeShieldEffect(c,r,s.radius||160);break;case V.BarrierWall:this.renderBarrierWallEffect(c,d,r,s.color||y.CYAN);break;case V.HealBurst:case V.HealingField:this.renderHealingEffect(c,a,s.radius||160);break;case V.PoisonCloud:this.renderPoisonCloudEffect(s.position,r,s.radius||128);break;case V.Explosion:this.renderExplosionEffect(s.position,a,s.radius||80);break;case V.DashSlash:this.renderDashSlashEffect(s.position,s.direction||0,r);break;case V.TurretSpawn:this.renderTurretSpawnEffect(s.position,r);break;case V.Cloak:break;case V.Reveal:this.renderRevealEffect(s.position,a);break}}}renderBlinkEffect(e,t){this.renderer.drawCircle(e.x,e.y,30*t,{fill:`rgba(100, 200, 255, ${t*.5})`,stroke:`rgba(150, 230, 255, ${t})`,strokeWidth:3,glow:!0,glowColor:y.CYAN,glowSize:20*t});for(let i=0;i<8;i++){const o=i/8*Math.PI*2,s=20+(1-t)*40,n=e.x+Math.cos(o)*s,a=e.y+Math.sin(o)*s;this.renderer.drawCircle(n,a,4*t,{fill:y.CYAN,glow:!0,glowColor:y.CYAN,glowSize:5})}}renderNewShockwaveEffect(e,t,i){const o=i*t,s=1-t;if(this.renderer.drawCircle(e.x,e.y,o,{stroke:`rgba(255, 150, 50, ${s*.9})`,strokeWidth:8*(1-t),glow:!0,glowColor:"#ff9933",glowSize:20*s}),t<.5){const n=1-t/.5;this.renderer.drawCircle(e.x,e.y,o*.6,{stroke:`rgba(255, 200, 100, ${n*.7})`,strokeWidth:4})}}renderNewShieldEffect(e,t,i){this.renderer.drawCircle(e.x,e.y,35,{fill:`rgba(100, 200, 255, ${t*.2})`,stroke:i,strokeWidth:3*t,glow:!0,glowColor:i,glowSize:15*t})}renderDomeShieldEffect(e,t,i){this.renderer.drawCircle(e.x,e.y,i,{fill:`rgba(100, 200, 255, ${t*.15})`,stroke:`rgba(150, 230, 255, ${t*.8})`,strokeWidth:4,glow:!0,glowColor:y.CYAN,glowSize:25*t});for(let o=0;o<6;o++){const s=o/6*Math.PI*2,n=e.x+Math.cos(s)*i*.7,a=e.y+Math.sin(s)*i*.7;this.renderer.drawCircle(n,a,8,{stroke:`rgba(200, 240, 255, ${t*.5})`,strokeWidth:2})}}renderBarrierWallEffect(e,t,i,o){const s=Math.max(0,Math.min(1,i)),n=45,a=Math.PI*(2/3),r=t-a/2,c=t+a/2,d=this.renderer.getContext();d.save(),d.beginPath(),d.arc(e.x,e.y,n,r,c),d.strokeStyle=o,d.lineWidth=8*s,d.lineCap="round",d.shadowColor=o,d.shadowBlur=20*s,d.stroke(),d.beginPath(),d.arc(e.x,e.y,n-4,r+.1,c-.1),d.strokeStyle=`rgba(255, 255, 255, ${s*.6})`,d.lineWidth=3*s,d.stroke();for(const m of[r,c]){const u=e.x+Math.cos(m)*n,p=e.y+Math.sin(m)*n;d.beginPath(),d.arc(u,p,6*s,0,Math.PI*2),d.fillStyle=o,d.fill()}const h=5;for(let m=1;m<h;m++){const u=r+a*m/h,p=e.x+Math.cos(u)*n,w=e.y+Math.sin(u)*n;d.beginPath(),d.arc(p,w,3*s,0,Math.PI*2),d.fillStyle=`rgba(255, 255, 255, ${s*.8})`,d.fill()}d.restore()}renderHealingEffect(e,t,i){const o=1-t*.5;this.renderer.drawCircle(e.x,e.y,i,{fill:`rgba(100, 255, 150, ${o*.1})`,stroke:`rgba(100, 255, 150, ${o*.6})`,strokeWidth:2});const s=6;for(let n=0;n<s;n++){const a=n/s*Math.PI*2+t*2,r=i*.5,c=e.x+Math.cos(a)*r,d=e.y+Math.sin(a)*r-t*30;this.renderer.drawText("+",c,d,{color:`rgba(100, 255, 150, ${o})`,size:16,align:"center",baseline:"middle"})}}renderPoisonCloudEffect(e,t,i){this.renderer.drawCircle(e.x,e.y,i,{fill:`rgba(100, 200, 50, ${t*.3})`,stroke:`rgba(150, 220, 80, ${t*.6})`,strokeWidth:3});for(let o=0;o<5;o++){const s=o/5*Math.PI*2,n=i*(.3+Math.random()*.5),a=e.x+Math.cos(s)*n,r=e.y+Math.sin(s)*n;this.renderer.drawCircle(a,r,5+Math.random()*10,{fill:`rgba(120, 200, 60, ${t*.4})`})}}renderExplosionEffect(e,t,i){const o=i*t,s=1-t;if(this.renderer.drawCircle(e.x,e.y,o,{fill:`rgba(255, 150, 50, ${s*.6})`,glow:!0,glowColor:"#ff6600",glowSize:30*s}),t<.3){const n=1-t/.3;this.renderer.drawCircle(e.x,e.y,o*.5,{fill:`rgba(255, 255, 200, ${n})`})}}renderDashSlashEffect(e,t,i){const o=t-Math.PI/4,s=t+Math.PI/4;this.renderer.drawArc(e.x,e.y,40,o,s,{stroke:`rgba(255, 100, 100, ${i})`,strokeWidth:6*i,glow:!0,glowColor:y.MAGENTA,glowSize:15*i})}renderTurretSpawnEffect(e,t){this.renderer.drawCircle(e.x,e.y,25,{stroke:`rgba(255, 200, 100, ${t})`,strokeWidth:3,glow:!0,glowColor:y.YELLOW,glowSize:10*t});for(let i=-1;i<=1;i++)this.renderer.drawLine(e.x-20,e.y+i*10,e.x+20,e.y+i*10,{color:`rgba(255, 200, 100, ${t*.5})`,width:1}),this.renderer.drawLine(e.x+i*10,e.y-20,e.x+i*10,e.y+20,{color:`rgba(255, 200, 100, ${t*.5})`,width:1})}renderRevealEffect(e,t){const i=50+t*100,o=1-t;this.renderer.drawCircle(e.x,e.y,i,{stroke:`rgba(255, 50, 50, ${o*.8})`,strokeWidth:2})}renderBulletTracers(){const e=performance.now();this.bulletTracers=this.bulletTracers.filter(t=>e-t.time<200);for(const t of this.bulletTracers){const o=1-(e-t.time)/200,s=t.isEnemy?`rgba(255, 80, 80, ${o*.9})`:`rgba(100, 255, 255, ${o*.9})`,n=t.isEnemy?`rgba(255, 100, 100, ${o*.8})`:`rgba(100, 255, 200, ${o*.8})`,a=t.isEnemy?y.ATTACKER:y.CYAN;this.renderer.drawLine(t.start.x,t.start.y,t.end.x,t.end.y,{color:s,width:2}),this.renderer.drawCircle(t.end.x,t.end.y,5*o,{fill:n,glow:!0,glowColor:a,glowSize:10*o})}}addMuzzleFlash(e,t){this.muzzleFlashes.push({position:{...e},direction:t,time:performance.now()}),this.particleSystem.muzzleFlashParticles(e,t)}addBulletTracer(e,t,i=!1){this.bulletTracers.push({start:{...e},end:{...t},time:performance.now(),isEnemy:i});const o={x:t.x-e.x,y:t.y-e.y},s=Math.sqrt(o.x*o.x+o.y*o.y);if(s>0){const n={x:-o.x/s,y:-o.y/s};this.particleSystem.bulletImpact(t,n)}}addPlayerDeath(e){this.particleSystem.playerDeath(e)}addPlayerHit(e,t){this.particleSystem.bulletHitPlayer(e,t)}addWeaponSwitch(e){this.particleSystem.weaponSwitch(e)}addPickupNotification(e,t="#00FF88"){this.pickupNotifications.push({message:e,time:performance.now(),duration:3e3,color:t})}updateParticles(e){this.particleSystem.update(e)}renderUI(){const e=this.renderer.getWidth(),t=this.renderer.getHeight(),i=this.world.getLocalPlayer();this.world.isGamePaused()&&this.renderGamePauseOverlay(e,t),this.renderTopBar(e),this.renderPickupNotifications(e),i&&i.alive&&this.renderBottomBar(i,e,t),this.renderCrosshair(e,t),this.world.getPhase()!==A.RoundActive&&this.renderPhaseOverlay(e,t)}renderGamePauseOverlay(e,t){const i=this.world.getGamePausedBy();this.renderer.drawRect(0,0,e,t,{fill:"rgba(0, 0, 0, 0.7)"});const o=e/2,s=t/2-60,n=12,a=40,r=10;this.renderer.drawRect(o-r-n,s-a/2,n,a,{fill:y.YELLOW,glow:!0,glowColor:y.YELLOW,glowSize:10}),this.renderer.drawRect(o+r,s-a/2,n,a,{fill:y.YELLOW,glow:!0,glowColor:y.YELLOW,glowSize:10}),this.renderer.drawText("GAME PAUSED",e/2,t/2,{color:y.YELLOW,align:"center",baseline:"middle",size:32,glow:!0,glowColor:y.YELLOW,glowSize:15}),this.renderer.drawText(`${i} is away`,e/2,t/2+40,{color:"#aaa",align:"center",baseline:"middle",size:18}),this.renderer.drawText("Waiting for all players to return...",e/2,t/2+70,{color:"#666",align:"center",baseline:"middle",size:14})}renderPickupNotifications(e){const t=performance.now(),i=60,o=35;this.pickupNotifications=this.pickupNotifications.filter(s=>t-s.time<s.duration),this.pickupNotifications.forEach((s,n)=>{const a=t-s.time,r=a<500?a/500:(s.duration-a)/500,c=i+n*o,d=s.message.length*10,h=15,m=d+h*2,u=e-m-20;this.renderer.drawRect(u,c-12,m,24,{fill:`rgba(0, 0, 0, ${Math.min(.8,r)})`,stroke:s.color,strokeWidth:2}),this.renderer.drawText(s.message,e-20-h,c,{color:s.color,align:"right",baseline:"middle",size:14})})}renderTopBar(e){const t=this.world.getScore(),i=this.world.getTime(),s=Math.max(0,18e4-i),n=this.world.getObjectives(),a=this.world.getLocalPlayer(),r=this.world.getMap();if(this.renderer.drawRect(0,0,e,40,{fill:"rgba(0,0,0,0.7)"}),this.renderer.drawText(`Map: ${r.data.name}`,15,14,{color:"#888",align:"left",baseline:"middle",size:11}),a){const c=ee[a.heroId];this.renderer.drawText(c.name,15,28,{color:y.CYAN,align:"left",baseline:"middle",size:12})}if(this.renderer.drawText(`${t.attackers}`,e/2-60,20,{color:y.ATTACKER,align:"center",baseline:"middle",size:24}),this.renderer.drawText(us(s),e/2,20,{color:y.CYAN,align:"center",baseline:"middle",size:20}),this.renderer.drawText(`${t.defenders}`,e/2+60,20,{color:y.DEFENDER,align:"center",baseline:"middle",size:24}),this.renderer.drawText(`v${this.appVersion}`,e-10,48,{color:"rgba(255,255,255,0.4)",align:"right",baseline:"middle",size:9}),this.renderer.drawText(`Round ${this.world.getRoundNumber()}`,e/2,35,{color:"#888",align:"center",baseline:"middle",size:10}),n.spikeCarrierId||n.spikePlanted){const c=e-150;if(n.spikePlanted){const d=Math.max(0,45e3-(this.world.getAbsoluteTime()-n.spikePlantTime)),h=Math.sin(this.world.getAbsoluteTime()*.015)*.3+.7;this.renderer.drawRect(c-10,5,160,30,{fill:`rgba(255, 0, 0, ${h*.3})`,stroke:"#ff4444",strokeWidth:2}),this.renderer.drawText(" SPIKE PLANTED",c+70,13,{color:"#ff4444",align:"center",size:12}),this.renderer.drawText(`${(d/1e3).toFixed(1)}s`,c+70,27,{color:"#ffffff",align:"center",size:14})}else if(n.spikeCarrierId){const d=this.world.getPlayers().find(m=>m.id===n.spikeCarrierId),h=a&&n.spikeCarrierId===a.id;this.renderer.drawRect(c-10,5,160,30,{fill:"rgba(0, 0, 0, 0.5)",stroke:h?"#ff8800":"#666",strokeWidth:1}),h?(this.renderer.drawText(" YOU HAVE SPIKE",c+70,13,{color:"#ff8800",align:"center",size:11}),this.renderer.drawText("Hold E in site to plant",c+70,27,{color:"#aaa",align:"center",size:9})):d&&this.renderer.drawText(` ${d.name}`,c+70,20,{color:"#888",align:"center",size:11})}}}renderBottomBar(e,t,i){const s=i-80;this.renderer.drawRect(0,s,t,80,{fill:"rgba(0,0,0,0.7)"}),this.renderer.drawHealthBar(20,s+20,200,20,e.health,e.maxHealth,e.shield,e.maxShield),this.renderer.drawText(`${Math.ceil(e.health)}`,120,s+30,{color:"#222",align:"center",baseline:"middle",size:14});const n=28,a=4,r=240;for(let I=0;I<10;I++){const T=r+I*(n+a),R=s+15,W=e.weaponInventory[I]!==null,$=e.currentWeaponSlot===I;this.renderer.drawRect(T,R,n,n,{fill:$?"rgba(12, 229, 240, 0.3)":"rgba(30, 30, 40, 0.8)",stroke:$?y.CYAN:W?"#555":"#333",strokeWidth:$?2:1});const Y=I===9?0:I+1;if(this.renderer.drawText(`${Y}`,T+n/2,R+n/2,{color:W?$?y.CYAN:"#aaa":"#444",align:"center",baseline:"middle",size:11}),W){const N=e.weaponInventory[I].weaponId.charAt(0).toUpperCase();this.renderer.drawText(N,T+n/2,R+n+8,{color:"#666",align:"center",size:8})}}const c=600;this.renderer.drawText(e.weapon.weaponId.toUpperCase().replace("_"," "),c,s+20,{color:"#fff",align:"left",size:14});const d=e.weapon.reloading?"RELOADING...":`${e.weapon.ammo} / ${e.weapon.maxAmmo}`;this.renderer.drawText(d,c,s+45,{color:e.weapon.reloading?y.YELLOW:y.CYAN,align:"left",size:18});const h=c+150;this.renderer.drawText("GRENADES",h,s+20,{color:"#888",align:"left",size:10});const m=h+10,u=s+40;this.renderer.drawCircle(m,u,8,{fill:e.grenadeCount>0?"#2a2a2a":"#1a1a1a",stroke:e.grenadeCount>0?"#ff4444":"#333",strokeWidth:2}),this.renderer.drawText(`${e.grenadeCount}`,m+20,u,{color:e.grenadeCount>0?y.YELLOW:"#555",align:"left",baseline:"middle",size:16}),this.renderer.drawText("G",m+40,u,{color:"#666",align:"left",baseline:"middle",size:10});const p=h+120,w=p,x=s+40;this.renderer.drawRect(w-10,x-8,20,16,{fill:e.bombCallCount>0?"#1a1a2a":"#0a0a12",stroke:e.bombCallCount>0?y.MAGENTA:"#333",strokeWidth:2}),this.renderer.drawLine(w,x-8,w,x-14,{color:e.bombCallCount>0?y.MAGENTA:"#333",width:2}),this.renderer.drawText(e.bombCallCount>0?"":"",w,x,{color:e.bombCallCount>0?y.MAGENTA:"#555",align:"center",baseline:"middle",size:12}),this.renderer.drawText("V",w,x+18,{color:"#666",align:"center",size:10});const S=p+40,k=s+40;this.renderer.drawRect(S-10,k-8,20,16,{fill:e.missileStrikeCount>0?"#1a2a1a":"#0a0a12",stroke:e.missileStrikeCount>0?"#ff6600":"#333",strokeWidth:2}),this.renderer.drawLine(S,k-8,S,k-14,{color:e.missileStrikeCount>0?"#ff6600":"#333",width:2}),this.renderer.drawText(e.missileStrikeCount>0?"":"",S,k,{color:e.missileStrikeCount>0?"#ff6600":"#555",align:"center",baseline:"middle",size:12}),this.renderer.drawText("J",S,k+18,{color:"#666",align:"center",size:10}),this.renderAbilities(e,t,s)}renderCrosshair(e,t){const i=e/2,o=t/2,s=10,n=4;this.renderer.drawLine(i-s,o,i-n,o,{color:y.CYAN,width:2}),this.renderer.drawLine(i+n,o,i+s,o,{color:y.CYAN,width:2}),this.renderer.drawLine(i,o-s,i,o-n,{color:y.CYAN,width:2}),this.renderer.drawLine(i,o+n,i,o+s,{color:y.CYAN,width:2}),this.renderer.drawCircle(i,o,2,{fill:y.CYAN})}renderAbilities(e,t,i){const o=ee[e.heroId],s=this.world.getTime(),a={Spectre:["","","",""],Byte:["","","",""],Vanta:["","","",""],Katana:["","","",""],Glyph:["","","",""],Spark:["","","",""],Zero:["","","",""],Mira:["","","",""]}[o.name]||["","","",""],r=["","Q","F","X"],c=48,d=8,h=4*c+3*d,m=t-h-20,u=i+16,p=m-70;this.renderer.drawRect(p-30,u+8,60,32,{fill:"rgba(30, 30, 40, 0.8)",stroke:y.YELLOW,strokeWidth:1}),this.renderer.drawText(`$${e.credits}`,p,u+24,{color:y.YELLOW,align:"center",baseline:"middle",size:16});for(let w=0;w<4;w++){const x=e.abilities[w],S=o.abilities[w];if(!x||!S)continue;const k=m+w*(c+d),I=w===0,T=w===3,R=Math.max(0,x.cooldownEndTime-s),W=S.cooldown>0?R/S.cooldown:0,$=R===0,Y=x.charges>0;if(T?this.drawHexagon(k+c/2,u+c/2,c/2,{fill:$?"rgba(255, 200, 0, 0.3)":"rgba(30, 30, 40, 0.9)",stroke:$?y.YELLOW:"#444",strokeWidth:2}):I?this.renderer.drawRect(k,u,c,c,{fill:"rgba(50, 80, 50, 0.6)",stroke:"#4a4",strokeWidth:1}):this.renderer.drawRect(k,u,c,c,{fill:$&&Y?"rgba(12, 229, 240, 0.2)":"rgba(30, 30, 40, 0.9)",stroke:$&&Y?y.CYAN:"#444",strokeWidth:$&&Y?2:1}),W>0&&!I){const N=k+c/2,O=u+c/2,ve=c/2-2;this.renderer.getContext().save(),this.renderer.getContext().globalAlpha=.7,this.renderer.getContext().fillStyle="#000",this.renderer.getContext().beginPath(),this.renderer.getContext().moveTo(N,O),this.renderer.getContext().arc(N,O,ve,-Math.PI/2,-Math.PI/2+Math.PI*2*W,!1),this.renderer.getContext().closePath(),this.renderer.getContext().fill(),this.renderer.getContext().restore();const Ne=Math.ceil(R/1e3);this.renderer.drawText(`${Ne}`,k+c/2,u+c/2,{color:"#fff",align:"center",baseline:"middle",size:16})}else this.renderer.drawText(a[w]??"",k+c/2,u+c/2,{color:"#fff",align:"center",baseline:"middle",size:20});const Z=I?"#4a4":$&&Y?y.CYAN:"#666";if(this.renderer.drawText(r[w]??"",k+8,u+10,{color:Z,align:"center",baseline:"middle",size:10}),S.charges>1){const N=`${x.charges}/${S.charges}`;this.renderer.drawText(N,k+c-8,u+c-6,{color:x.charges>0?y.CYAN:"#666",align:"center",baseline:"middle",size:9})}if(T){const N=x.ultimateCharge||0,O=S.ultimateCost||6,ve=Math.min(1,N/O),Ne=c-4,Fe=4,ct=k+2,We=u+c+2;this.renderer.drawRect(ct,We,Ne,Fe,{fill:"#222"});const Ii=N>=O;this.renderer.drawRect(ct,We,Ne*ve,Fe,{fill:Ii?y.YELLOW:y.CYAN}),Ii?this.renderer.drawText("READY",k+c/2,We+Fe+8,{color:y.YELLOW,align:"center",baseline:"middle",size:8}):this.renderer.drawText(`${Math.floor(N)}/${O}`,k+c/2,We+Fe+8,{color:"#888",align:"center",baseline:"middle",size:8})}if(!T){const N=S.name.length>10?S.name.substring(0,9)+"":S.name;this.renderer.drawText(N,k+c/2,u+c+8,{color:I?"#4a4":"#888",align:"center",baseline:"middle",size:7})}}this.renderer.drawText(o.name.toUpperCase(),m+h/2,u-8,{color:y.CYAN,align:"center",baseline:"middle",size:12})}drawHexagon(e,t,i,o){const s=this.renderer.getContext();s.save(),s.beginPath();for(let n=0;n<6;n++){const a=Math.PI/3*n-Math.PI/2,r=e+i*Math.cos(a),c=t+i*Math.sin(a);n===0?s.moveTo(r,c):s.lineTo(r,c)}s.closePath(),o.fill&&(s.fillStyle=o.fill,s.fill()),o.stroke&&(s.strokeStyle=o.stroke,s.lineWidth=o.strokeWidth||1,s.stroke()),s.restore()}renderPhaseOverlay(e,t){const i=this.world.getPhase(),o=i===A.MatchEnd;let s="",n="",a=!1,r=!1;const c=this.world.getLocalPlayer();if(o&&c){const m=this.world.getScore(),u=m.attackers>m.defenders;a=c.team===g.Attackers&&u||c.team===g.Defenders&&!u,r=!a}switch(o&&!this.lastMatchEndPhase&&(this.matchEndStartTime=Date.now(),a&&this.spawnVictoryConfetti(e,t)),this.lastMatchEndPhase=o,i){case A.Lobby:s="WAITING FOR PLAYERS",n="Press SPACE to start when ready";break;case A.BuyPhase:s="BUY PHASE",n="Purchase weapons and abilities";break;case A.RoundEnd:const m=this.world.getScore();s="ROUND OVER",n=`Attackers: ${m.attackers} - Defenders: ${m.defenders}`;break;case A.MatchEnd:const u=this.world.getScore();a?s=" VICTORY! ":r?s=" DEFEAT ":s=u.attackers>u.defenders?"ATTACKERS WIN":"DEFENDERS WIN",n=`Final Score: ${u.attackers} - ${u.defenders}`;break}o&&a?this.renderer.drawRect(0,0,e,t,{fill:"rgba(0,40,0,0.6)"}):o&&r?this.renderer.drawRect(0,0,e,t,{fill:"rgba(40,0,0,0.6)"}):this.renderer.drawRect(0,0,e,t,{fill:"rgba(0,0,0,0.5)"}),o&&a&&this.updateAndRenderConfetti(e,t),o&&r&&this.renderDefeatEffect(e,t);let d=y.CYAN,h=20;if(o&&(a?(d="#ffd700",h=30):r&&(d="#ff4444",h=15)),this.renderer.drawText(s,e/2,t/2-40,{color:d,align:"center",baseline:"middle",size:o?48:36,glow:!0,glowColor:d,glowSize:h}),this.renderer.drawText(n,e/2,t/2,{color:"#888",align:"center",baseline:"middle",size:16}),i===A.RoundEnd){const m=this.world.getCountdownTime(),u=this.world.isCountdownPaused(),p=this.world.getCountdownPausedBy(),w=Math.ceil(m/1e3),x=u?`PAUSED by ${p}`:`Next round in ${w}s`,S=u?y.YELLOW:y.CYAN;this.renderer.drawText(x,e/2,t/2+40,{color:S,align:"center",baseline:"middle",size:24,glow:!0,glowColor:S,glowSize:10});const k=u?"Press P to resume":"Press P to pause countdown";this.renderer.drawText(k,e/2,t/2+70,{color:"#666",align:"center",baseline:"middle",size:12})}}spawnVictoryConfetti(e,t){const i=["#ffd700","#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#ffeaa7","#dfe6e9","#a29bfe","#fd79a8","#00b894"];for(let o=0;o<150;o++)this.matchEndConfetti.push({x:Math.random()*e,y:-20-Math.random()*200,vx:(Math.random()-.5)*200,vy:Math.random()*300+100,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*10,width:Math.random()*8+4,height:Math.random()*12+6,color:i[Math.floor(Math.random()*i.length)],life:5+Math.random()*3,maxLife:5+Math.random()*3})}updateAndRenderConfetti(e,t){const i=this.renderer.getContext(),o=1/60;for(let n=this.matchEndConfetti.length-1;n>=0;n--){const a=this.matchEndConfetti[n];if(a.life-=o,a.life<=0){this.matchEndConfetti.splice(n,1);continue}a.vy+=400*o,a.vx+=Math.sin(Date.now()/500+a.x/100)*50*o,a.x+=a.vx*o,a.y+=a.vy*o,a.rotation+=a.rotationSpeed*o,a.vx*=.99,a.vy*=.995,a.x<-20&&(a.x=e+20),a.x>e+20&&(a.x=-20);const r=Math.min(1,a.life/(a.maxLife*.3));i.save(),i.translate(a.x,a.y),i.rotate(a.rotation),i.fillStyle=a.color,i.globalAlpha=r,i.fillRect(-a.width/2,-a.height/2,a.width,a.height),i.restore()}if(i.globalAlpha=1,Date.now()-this.matchEndStartTime<5e3&&Math.random()<.3){const n=["#ffd700","#ff6b6b","#4ecdc4","#45b7d1","#96ceb4","#ffeaa7"];this.matchEndConfetti.push({x:Math.random()*e,y:-10,vx:(Math.random()-.5)*150,vy:Math.random()*200+100,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*8,width:Math.random()*8+4,height:Math.random()*12+6,color:n[Math.floor(Math.random()*n.length)],life:4+Math.random()*2,maxLife:4+Math.random()*2})}}renderDefeatEffect(e,t){const i=this.renderer.getContext(),o=Date.now()-this.matchEndStartTime,s=.3+Math.sin(o/500)*.1,n=i.createRadialGradient(e/2,t/2,0,e/2,t/2,Math.max(e,t)*.7);n.addColorStop(0,"rgba(0, 0, 0, 0)"),n.addColorStop(.5,"rgba(80, 0, 0, 0.2)"),n.addColorStop(1,`rgba(100, 0, 0, ${s})`),i.fillStyle=n,i.fillRect(0,0,e,t);const a=8;for(let r=0;r<a;r++){const c=e/a*r+e/a/2,d=(o/20+r*100)%(t+100)-50,h=.3+Math.sin(o/300+r)*.1,m=20+Math.sin(r*1.5)*5;i.save(),i.globalAlpha=h,i.font=`${m}px Arial`,i.textAlign="center",i.textBaseline="middle",i.fillStyle="#444",i.fillText("",c+Math.sin(o/400+r*2)*20,d),i.restore()}i.globalAlpha=1,i.strokeStyle="rgba(60, 0, 0, 0.3)",i.lineWidth=2,i.beginPath(),i.moveTo(e*.3,0),i.lineTo(e*.4,t*.3),i.lineTo(e*.35,t*.5),i.lineTo(e*.45,t),i.stroke(),i.beginPath(),i.moveTo(e*.7,0),i.lineTo(e*.6,t*.4),i.lineTo(e*.65,t*.7),i.lineTo(e*.55,t),i.stroke()}updateWorld(e){this.world=e}}var F=(l=>(l.PulsePistolShoot="weapon_pulse_pistol_shoot",l.PlasmaRifleShoot="weapon_plasma_rifle_shoot",l.ScatterGunShoot="weapon_scatter_gun_shoot",l.FusionCannonShoot="weapon_fusion_cannon_shoot",l.WeaponReload="weapon_reload",l.WeaponEmpty="weapon_empty",l.WeaponSwitch="weapon_switch",l.FootstepMetal="player_footstep",l.PlayerDamage="player_damage",l.PlayerDeath="player_death",l.PlayerRespawn="player_respawn",l.BulletImpactWall="combat_impact_wall",l.BulletImpactPlayer="combat_impact_player",l.Headshot="combat_headshot",l.KillConfirmed="combat_kill",l.AbilityCast="ability_cast",l.Explosion="ability_explosion",l.Teleport="ability_teleport",l.RoundStart="game_round_start",l.RoundEnd="game_round_end",l.MatchWin="game_match_win",l.MatchLose="game_match_lose",l.CountdownTick="game_countdown_tick",l.CountdownGo="game_countdown_go",l.AirplaneFlyby="game_airplane_flyby",l.ParachuteDrop="game_parachute_drop",l.WeaponPickup="game_weapon_pickup",l.HealthPickup="game_health_pickup",l.ItemPickup="game_item_pickup",l.MissileIncoming="game_missile_incoming",l.UIClick="ui_click",l.UIHover="ui_hover",l.UISuccess="ui_success",l.UIError="ui_error",l))(F||{});const jt={weapon_pulse_pistol_shoot:"./assets/audio/weapons/pulse_pistol_shoot.mp3",weapon_plasma_rifle_shoot:"./assets/audio/weapons/plasma_rifle_shoot.mp3",weapon_scatter_gun_shoot:"./assets/audio/weapons/scatter_gun_shoot.mp3",weapon_fusion_cannon_shoot:"./assets/audio/weapons/fusion_cannon_shoot.mp3",weapon_reload:"./assets/audio/weapons/reload.mp3",weapon_empty:"./assets/audio/weapons/empty_click.mp3",weapon_switch:"./assets/audio/weapons/weapon_switch.mp3",player_footstep:"./assets/audio/player/footstep_metal.mp3",player_damage:"./assets/audio/player/damage.mp3",player_death:"./assets/audio/player/death.mp3",player_respawn:"./assets/audio/player/respawn.mp3",combat_impact_wall:"./assets/audio/combat/impact_wall.mp3",combat_impact_player:"./assets/audio/combat/impact_player.mp3",combat_headshot:"./assets/audio/combat/headshot.mp3",combat_kill:"./assets/audio/combat/kill_confirmed.mp3",ability_cast:"./assets/audio/abilities/cast.mp3",ability_explosion:"./assets/audio/abilities/explosion.mp3",ability_teleport:"./assets/audio/abilities/teleport.mp3",game_round_start:"./assets/audio/game/round_start.mp3",game_round_end:"./assets/audio/game/round_end.mp3",game_match_win:"./assets/audio/game/match_win.mp3",game_match_lose:"./assets/audio/game/match_lose.mp3",game_countdown_tick:"./assets/audio/game/countdown_tick.mp3",game_countdown_go:"./assets/audio/game/countdown_go.mp3",game_airplane_flyby:"./assets/audio/game/airplane-flyby.mp3",game_parachute_drop:"./assets/audio/game/parachute-drop.mp3",game_missile_incoming:"./assets/audio/_depo/missile-explosion-168600.mp3",game_weapon_pickup:"./assets/audio/game/weapon-equipped.mp3",game_health_pickup:"./assets/audio/game/health-pickup.mp3",game_item_pickup:"./assets/audio/game/item-pickup.mp3",ui_click:"./assets/audio/ui/click.mp3",ui_hover:"./assets/audio/ui/hover.mp3",ui_success:"./assets/audio/ui/success.mp3",ui_error:"./assets/audio/ui/error.mp3",music_menu:"./assets/audio/music/menu_theme.mp3",music_gameplay:"./assets/audio/music/gameplay_loop.mp3",music_victory:"./assets/audio/music/victory_theme.mp3",music_defeat:"./assets/audio/music/defeat_theme.mp3"},Ti={weapon_pulse_pistol_shoot:"sfx",weapon_plasma_rifle_shoot:"sfx",weapon_scatter_gun_shoot:"sfx",weapon_fusion_cannon_shoot:"sfx",weapon_reload:"sfx",weapon_empty:"sfx",weapon_switch:"sfx",player_footstep:"sfx",player_damage:"sfx",player_death:"sfx",player_respawn:"sfx",combat_impact_wall:"sfx",combat_impact_player:"sfx",combat_headshot:"sfx",combat_kill:"sfx",ability_cast:"sfx",ability_explosion:"sfx",ability_teleport:"sfx",game_round_start:"voice",game_round_end:"voice",game_match_win:"voice",game_match_lose:"voice",game_countdown_tick:"voice",game_countdown_go:"voice",ui_click:"ui",ui_hover:"ui",ui_success:"ui",ui_error:"ui",music_menu:"music",music_gameplay:"music",music_victory:"music",music_defeat:"music"},Fs={player_footstep:.3,ui_hover:.4,combat_impact_wall:.5},Li={masterVolume:80,musicVolume:50,sfxVolume:80,uiVolume:70,voiceVolume:100,masterEnabled:!0,musicEnabled:!0,sfxEnabled:!0,uiEnabled:!0,voiceEnabled:!0};class Ws{audioManager;loadedSounds=new Set;settings;constructor(){this.audioManager=new cs,this.settings={...Li},this.loadSettings()}loadSettings(){try{const e=localStorage.getItem("cybergrid_audioSettings");e&&(this.settings={...Li,...JSON.parse(e)})}catch{}}saveSettings(){try{localStorage.setItem("cybergrid_audioSettings",JSON.stringify(this.settings))}catch{}}getSettings(){return{...this.settings}}updateSettings(e){this.settings={...this.settings,...e},this.applySettings(),this.saveSettings()}applySettings(){this.audioManager.setMasterVolume(this.settings.masterEnabled?this.settings.masterVolume/100:0),this.audioManager.setMusicVolume(this.settings.musicEnabled?this.settings.musicVolume/100:0)}getEffectiveVolume(e,t){if(!this.settings.masterEnabled)return 0;const i=Ti[e]||"sfx";let o=1,s=!0;switch(i){case"music":o=this.settings.musicVolume/100,s=this.settings.musicEnabled;break;case"sfx":o=this.settings.sfxVolume/100,s=this.settings.sfxEnabled;break;case"ui":o=this.settings.uiVolume/100,s=this.settings.uiEnabled;break;case"voice":o=this.settings.voiceVolume/100,s=this.settings.voiceEnabled;break}if(!s)return 0;const n=Fs[e]??1,a=this.settings.masterVolume/100;return n*t*o*a}isCategoryEnabled(e){if(!this.settings.masterEnabled)return!1;switch(Ti[e]||"sfx"){case"music":return this.settings.musicEnabled;case"sfx":return this.settings.sfxEnabled;case"ui":return this.settings.uiEnabled;case"voice":return this.settings.voiceEnabled;default:return!0}}async init(){await this.audioManager.init(),this.applySettings(),console.log("[GameAudio] Initialized")}async loadAllSounds(){const e=[];for(const[t,i]of Object.entries(jt))e.push(this.audioManager.loadSound(t,i).then(()=>{this.loadedSounds.add(t)}).catch(()=>{console.warn(`[GameAudio] Failed to load: ${t}`)}));await Promise.race([Promise.allSettled(e),new Promise(t=>setTimeout(t,1e4))]),console.log(`[GameAudio] Loaded ${this.loadedSounds.size}/${Object.keys(jt).length} sounds`)}async loadEssentialSounds(){const e=["weapon_pulse_pistol_shoot","weapon_plasma_rifle_shoot","weapon_scatter_gun_shoot","weapon_fusion_cannon_shoot","player_damage","player_death","combat_kill","game_round_start","game_countdown_tick","game_airplane_flyby","game_parachute_drop","game_weapon_pickup","game_health_pickup","game_item_pickup","ui_click","ui_hover"];for(const t of e){const i=jt[t];if(i)try{await this.audioManager.loadSound(t,i),this.loadedSounds.add(t)}catch{}}console.log(`[GameAudio] Loaded ${this.loadedSounds.size} essential sounds`)}play(e,t=1){if(!this.isCategoryEnabled(e))return null;const i=this.getEffectiveVolume(e,t);return i<=0?null:this.audioManager.play(e,{volume:i})}playAtOffset(e,t,i=1){if(!this.isCategoryEnabled(e))return null;const o=this.getEffectiveVolume(e,i);return o<=0?null:this.audioManager.play(e,{volume:o,offset:t})}getSoundDuration(e){return this.audioManager.getSoundDuration(e)}playWithVariation(e,t=1){if(!this.isCategoryEnabled(e))return null;const i=this.getEffectiveVolume(e,t);if(i<=0)return null;const o=.9+Math.random()*.2;return this.audioManager.play(e,{volume:i,pitch:o})}stop(e){this.audioManager.stop(e)}playMusic(e,t=1){!this.settings.masterEnabled||!this.settings.musicEnabled||this.audioManager.playMusic(e,t)}stopMusic(e=.5){this.audioManager.stopMusic(e)}stopAll(){this.audioManager.stopAll()}isEnabled(){return this.settings.masterEnabled}async resume(){await this.audioManager.resume()}}let Xt=null;function Gs(){return Xt||(Xt=new Ws),Xt}const ie={apiKey:"AIzaSyBaF85KsT8rIfVSXkyO_815TvxtgauSLRQ",authDomain:"cybergrid-assult.firebaseapp.com",projectId:"cybergrid-assult",storageBucket:"cybergrid-assult.firebasestorage.app",messagingSenderId:"576758568996",appId:"1:576758568996:web:f6faf029bb1fe37b4b20b1",measurementId:"G-QNLH88NB94"};class fe{db=null;firebase=null;playerId="";currentSession=null;isInitialized=!1;countryInfo={code:"XX",name:"Unknown"};static UNSAVED_PLAYTIME_KEY="cybergrid_unsavedPlayTime";getOrCreatePlayerId(){const e="cybergrid_playerId";let t=localStorage.getItem(e);return t||(t=`player_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem(e,t)),t}async detectCountry(){try{const e=await fetch("https://ipapi.co/json/",{method:"GET",headers:{Accept:"application/json"}});if(e.ok){const t=await e.json();return{code:t.country_code||"XX",name:t.country_name||"Unknown"}}}catch(e){console.warn("[PlayerStats] Country detection failed:",e)}return{code:"XX",name:"Unknown"}}async initialize(){if(!this.isInitialized)try{this.playerId=this.getOrCreatePlayerId(),this.detectCountry().then(p=>{this.countryInfo=p,console.log(`[PlayerStats] Country detected: ${p.name} (${p.code})`)});const{initializeApp:e,getApps:t,getApp:i}=await Se(async()=>{const{initializeApp:p,getApps:w,getApp:x}=await import("./index.esm-OOYOW6k3.js");return{initializeApp:p,getApps:w,getApp:x}},__vite__mapDeps([0,1]),import.meta.url),{getFirestore:o,collection:s,doc:n,setDoc:a,getDoc:r,updateDoc:c,increment:d,serverTimestamp:h,arrayUnion:m}=await Se(async()=>{const{getFirestore:p,collection:w,doc:x,setDoc:S,getDoc:k,updateDoc:I,increment:T,serverTimestamp:R,arrayUnion:W}=await import("./index.esm-DbUeHnob.js");return{getFirestore:p,collection:w,doc:x,setDoc:S,getDoc:k,updateDoc:I,increment:T,serverTimestamp:R,arrayUnion:W}},__vite__mapDeps([2,1]),import.meta.url);this.firebase={collection:s,doc:n,setDoc:a,getDoc:r,updateDoc:c,increment:d,serverTimestamp:h,arrayUnion:m};const u=t().length===0?e(ie):i();this.db=o(u),this.isInitialized=!0,console.log(`[PlayerStats] Initialized with player ID: ${this.playerId}`)}catch(e){console.error("[PlayerStats] Initialization failed:",e)}}async startSession(e,t){this.isInitialized||await this.initialize(),await this.recoverUnsavedPlayTime();const{doc:i,getDoc:o,setDoc:s,updateDoc:n,serverTimestamp:a}=this.firebase;this.currentSession={sessionId:`session_${Date.now()}`,startTime:Date.now(),heroId:t,gamesPlayed:0,gamesWon:0,kills:0,deaths:0,assists:0};try{const r=i(this.db,"playerStats",this.playerId);if((await o(r)).exists())await n(r,{callsign:e,country:this.countryInfo.code,countryName:this.countryInfo.name,lastSeenAt:a(),lastSessionStart:a()});else{const d={odplayerId:this.playerId,callsign:e,country:this.countryInfo.code,countryName:this.countryInfo.name,totalPlayTimeSeconds:0,gamesPlayed:0,gamesWon:0,gamesLost:0,totalKills:0,totalDeaths:0,totalAssists:0,favoriteHero:t,heroStats:{},firstSeenAt:a(),lastSeenAt:a(),lastSessionStart:a()};await s(r,d),await this.incrementGlobalStat("totalUniquePlayers",1),await this.updateCountryStats(this.countryInfo.code,1)}console.log(`[PlayerStats] Session started for ${e}`)}catch(r){console.error("[PlayerStats] Failed to start session:",r)}}async recordGameResult(e,t,i,o,s){if(!this.isInitialized||!this.currentSession)return;const{doc:n,updateDoc:a,increment:r,serverTimestamp:c}=this.firebase;this.currentSession.gamesPlayed++,e&&this.currentSession.gamesWon++,this.currentSession.kills+=t,this.currentSession.deaths+=i,this.currentSession.assists+=o;try{const d=n(this.db,"playerStats",this.playerId);await a(d,{gamesPlayed:r(1),gamesWon:r(e?1:0),gamesLost:r(e?0:1),totalKills:r(t),totalDeaths:r(i),totalAssists:r(o),lastSeenAt:c(),[`heroStats.${s}.gamesPlayed`]:r(1),[`heroStats.${s}.gamesWon`]:r(e?1:0),[`heroStats.${s}.kills`]:r(t),[`heroStats.${s}.deaths`]:r(i)}),await this.incrementGlobalStat("totalGamesPlayed",1),console.log(`[PlayerStats] Game recorded: ${e?"WIN":"LOSS"} - K:${t} D:${i} A:${o}`)}catch(d){console.error("[PlayerStats] Failed to record game:",d)}}async endSession(){if(!this.isInitialized||!this.currentSession)return;const{doc:e,updateDoc:t,increment:i,serverTimestamp:o}=this.firebase,s=Math.floor((Date.now()-this.currentSession.startTime)/1e3);try{const n=e(this.db,"playerStats",this.playerId);await t(n,{totalPlayTimeSeconds:i(s),lastSeenAt:o(),[`heroStats.${this.currentSession.heroId}.playTimeSeconds`]:i(s)}),await this.incrementGlobalStat("totalPlayTimeHours",s/3600),console.log(`[PlayerStats] Session ended. Duration: ${Math.floor(s/60)} minutes`)}catch(n){console.error("[PlayerStats] Failed to end session:",n),this.saveUnsavedPlayTime(s,this.currentSession.heroId)}this.currentSession=null}saveUnsavedPlayTimeSync(){if(!this.currentSession)return;const e=Math.floor((Date.now()-this.currentSession.startTime)/1e3);e<5||(this.saveUnsavedPlayTime(e,this.currentSession.heroId),console.log(`[PlayerStats] Saved unsaved play time to localStorage: ${e}s`))}saveUnsavedPlayTime(e,t){try{const i=localStorage.getItem(fe.UNSAVED_PLAYTIME_KEY),o=i?JSON.parse(i):{totalSeconds:0,heroSeconds:{}};o.totalSeconds=(o.totalSeconds||0)+e,o.heroSeconds=o.heroSeconds||{},o.heroSeconds[t]=(o.heroSeconds[t]||0)+e,o.playerId=this.playerId,o.timestamp=Date.now(),localStorage.setItem(fe.UNSAVED_PLAYTIME_KEY,JSON.stringify(o))}catch(i){console.warn("[PlayerStats] Failed to save unsaved play time:",i)}}async recoverUnsavedPlayTime(){try{const e=localStorage.getItem(fe.UNSAVED_PLAYTIME_KEY);if(!e)return;const t=JSON.parse(e);if(t.playerId!==this.playerId){localStorage.removeItem(fe.UNSAVED_PLAYTIME_KEY);return}if(Date.now()-t.timestamp>7*24*60*60*1e3){localStorage.removeItem(fe.UNSAVED_PLAYTIME_KEY);return}const{doc:i,updateDoc:o,increment:s,serverTimestamp:n}=this.firebase,a=i(this.db,"playerStats",this.playerId),r={totalPlayTimeSeconds:s(t.totalSeconds),lastSeenAt:n()};for(const[c,d]of Object.entries(t.heroSeconds||{}))r[`heroStats.${c}.playTimeSeconds`]=s(d);await o(a,r),await this.incrementGlobalStat("totalPlayTimeHours",t.totalSeconds/3600),localStorage.removeItem(fe.UNSAVED_PLAYTIME_KEY),console.log(`[PlayerStats] Recovered ${Math.floor(t.totalSeconds/60)} minutes of unsaved play time`)}catch(e){console.warn("[PlayerStats] Failed to recover unsaved play time:",e)}}async incrementGlobalStat(e,t){const{doc:i,getDoc:o,setDoc:s,updateDoc:n,increment:a,serverTimestamp:r}=this.firebase;try{const c=i(this.db,"globalStats","stats");(await o(c)).exists()?await n(c,{[e]:a(t),lastUpdated:r()}):await s(c,{totalUniquePlayers:e==="totalUniquePlayers"?t:0,totalGamesPlayed:e==="totalGamesPlayed"?t:0,totalPlayTimeHours:e==="totalPlayTimeHours"?t:0,playersByCountry:{},lastUpdated:r()})}catch(c){console.error("[PlayerStats] Failed to update global stat:",c)}}async updateCountryStats(e,t){const{doc:i,updateDoc:o,increment:s,serverTimestamp:n}=this.firebase;try{const a=i(this.db,"globalStats","stats");await o(a,{[`playersByCountry.${e}`]:s(t),lastUpdated:n()})}catch(a){console.error("[PlayerStats] Failed to update country stats:",a)}}async getMyStats(){this.isInitialized||await this.initialize();const{doc:e,getDoc:t}=this.firebase;try{const i=e(this.db,"playerStats",this.playerId),o=await t(i);if(o.exists())return o.data()}catch(i){console.error("[PlayerStats] Failed to get stats:",i)}return null}async getGlobalStats(){this.isInitialized||await this.initialize();const{doc:e,getDoc:t}=this.firebase;try{const i=e(this.db,"globalStats","stats"),o=await t(i);if(o.exists())return o.data()}catch(i){console.error("[PlayerStats] Failed to get global stats:",i)}return null}getPlayerId(){return this.playerId}hasActiveSession(){return this.currentSession!==null}}const Me=new fe,Hs="G-QNLH88NB94";class Os{initialized=!1;isAvailable(){return typeof window<"u"&&typeof window.gtag=="function"}initialize(){this.initialized||(this.isAvailable()?(this.initialized=!0,console.log("[Analytics] GA4 initialized")):console.warn("[Analytics] gtag not available - analytics disabled"))}trackEvent(e,t){if(this.isAvailable())try{window.gtag("event",e,{...t,send_to:Hs})}catch(i){console.warn("[Analytics] Failed to track event:",i)}}trackGameStart(e,t){this.trackEvent("game_start",{mode:e,callsign_length:t.length})}trackGameEnd(e,t){this.trackEvent("game_end",{duration_seconds:e,games_played:t})}trackMatchStart(e){this.trackEvent("match_start",{game_mode:e.gameMode,map_id:e.mapId,player_count:e.playerCount,bot_count:e.botCount,is_host:e.isHost})}trackMatchEnd(e){this.trackEvent("match_end",{game_mode:e.gameMode,map_id:e.mapId,won:e.won,duration_seconds:e.durationSeconds,kills:e.kills,deaths:e.deaths,assists:e.assists,hero_id:e.heroId,kd_ratio:e.deaths>0?(e.kills/e.deaths).toFixed(2):e.kills})}trackHeroSelect(e){this.trackEvent("hero_select",{hero_id:e})}trackAbilityUse(e,t,i){this.trackEvent("ability_use",{hero_id:e,ability_name:t,ability_slot:i})}trackWeaponPurchase(e,t){this.trackEvent("weapon_purchase",{weapon_id:e,price:t})}trackUIOpen(e){const t={settings:"settings_open",how_to_play:"how_to_play_open",buy_menu:"buy_menu_open"};this.trackEvent(t[e])}trackRoundEnd(e){this.trackEvent("round_end",{round_number:e.roundNumber,won:e.won,team_score:e.teamScore,enemy_score:e.enemyScore})}setUserProperties(e){if(this.isAvailable())try{window.gtag("set","user_properties",e)}catch(t){console.warn("[Analytics] Failed to set user properties:",t)}}}const ae=new Os;typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ae.initialize()}):ae.initialize());const Ys={enemyBotCount:3,friendlyBotCount:0,botDifficulty:"medium",gameMode:"deathmatch",playerHero:"vanta",abilityQSlot:1,abilityFSlot:2,totalRounds:5,mapId:"neon_arena"};class Di{gameLoop;inputManager;renderer;audio;world;gameRenderer;network=null;existingNetwork=null;lobbyPlayers=[];isHost=!1;localPeerId="";debugBroadcastStarted=!1;playerName;canvas;settings;initialized=!1;lastInputSendTime=0;lastPingTime=0;lastLocalFireTime=0;lastStateBroadcastTime=0;debugInfo=null;debugLoggedNoPlayer=!1;debugReceivedState=!1;showFPS=!0;lastPhase=A.RoundActive;countdownSoundId=null;lastCountdownPaused=!1;heroTutorialShown=!1;heroTutorialOverlay=null;constructor(e){this.canvas=e.canvas,this.playerName=e.playerName,this.settings=e.settings||Ys,this.existingNetwork=e.network||null,this.lobbyPlayers=e.lobbyPlayers||[],console.log(`[Game] Constructor - existingNetwork: ${!!this.existingNetwork}, lobbyPlayers: ${this.lobbyPlayers.length}`),console.log(`[Game] Ability settings - Q slot: ${this.settings.abilityQSlot}, F slot: ${this.settings.abilityFSlot}`),this.existingNetwork&&console.log(`[Game] Constructor - existing network has ${this.existingNetwork.getPeerIds().length} peers`),this.settings.aiMode==="slm"?pt.setMode(q.SLM):pt.setMode(q.RuleBased),console.log(`[Game] Bot AI mode: ${pt.getModeName()}`),this.renderer=new ls(this.canvas,Ut.canvasWidth,Ut.canvasHeight),this.inputManager=new rs(this.canvas),this.audio=Gs();const t=this.settings.gameMode==="spike"?Q.DataSpikeAssault:Q.NeonDeathmatch;this.world=new ut({mode:t,maxPlayers:8,isHost:!0,abilityQSlot:this.settings.abilityQSlot,abilityFSlot:this.settings.abilityFSlot,totalRounds:this.settings.totalRounds,mapId:this.settings.mapId});const i=e.appVersion||"0.0.0";this.gameRenderer=new Ns(this.renderer,this.world,i),this.gameLoop=new ns(Ut.tickRate,this.update.bind(this),this.render.bind(this)),this.debugInfo=document.getElementById("debug-info")}async init(){this.initialized||(await this.audio.init(),await this.audio.loadEssentialSounds(),this.initialized=!0,console.log("[Game] Initialized"))}start(){if(!this.initialized){console.error("[Game] Not initialized");return}this.gameLoop.start(),console.log("[Game] Started"),this.checkAndShowHeroTutorial()}stop(){this.countdownSoundId&&(this.audio.stop(this.countdownSoundId),this.countdownSoundId=null),this.gameLoop.stop(),console.log("[Game] Stopped")}pause(){this.gameLoop.stop(),console.log("[Game] Paused")}resume(){this.gameLoop.start(),console.log("[Game] Resumed")}isPaused(){return!this.gameLoop.isRunning()}restartGame(){if(!this.isHost)return;const e=this.settings.gameMode==="spike"?Q.DataSpikeAssault:Q.NeonDeathmatch;this.world=new ut({mode:e,maxPlayers:8,isHost:!0,abilityQSlot:this.settings.abilityQSlot,abilityFSlot:this.settings.abilityFSlot,totalRounds:this.settings.totalRounds,mapId:this.settings.mapId}),this.gameRenderer.updateWorld(this.world);const t=this.getHeroFromSettings(),i=this.world.addPlayer(this.localPeerId||"local",this.playerName,g.Attackers,t);this.world.setLocalPlayer(i.id);const o=this.network?.getPeerCount()||0;if(this.network!==null&&o>0){const n=this.network.getPeerIds();console.log(`[Game] Restart: Re-adding ${n.length} connected peers to Defenders`);for(const a of n){const c=this.lobbyPlayers.find(d=>d.id===a)?.name||`Player ${a.slice(-4)}`;this.world.addPlayer(a,c,g.Defenders,M.Vanta)}}else{const n=this.settings.enemyBotCount,a=this.settings.botDifficulty;n>0&&(this.world.spawnBots(n,g.Defenders,a),console.log(`[Game] Restart: Spawning ${n} enemy bots for single player`));const r=this.settings.friendlyBotCount;r>0&&(this.world.spawnBots(r,g.Attackers,a),console.log(`[Game] Restart: Spawning ${r} friendly bots`))}this.world.setPhase(A.RoundActive),this.world.startRound(),console.log("[Game] Restarted")}nextRound(){this.isHost&&(this.world.setPhase(A.RoundActive),this.world.startRound(),console.log("[Game] Next round started"))}getRoundEndInfo(){const e=this.world.getPhase();if(e!==A.RoundEnd&&e!==A.MatchEnd)return null;const t=this.world.getAttackerScore(),i=this.world.getDefenderScore(),o=t>i?"attackers":"defenders";return{isRoundOver:!0,isMatchOver:e===A.MatchEnd,winningTeam:o,attackerScore:t,defenderScore:i,roundsToWin:this.world.getRoundsToWin(),totalRounds:this.world.getTotalRounds(),isForfeit:this.world.isDisconnectForfeit(),forfeitPlayerName:this.world.getDisconnectedPlayerName()}}getCountdownInfo(){return this.world.getPhase()!==A.RoundEnd?null:{countdownTime:this.world.getCountdownTime(),isPaused:this.world.isCountdownPaused(),pausedBy:this.world.getCountdownPausedBy()}}isRoundActive(){return this.world.getPhase()===A.RoundActive}getLocalPlayerStats(){const e=this.world.getLocalPlayer();return e?{kills:e.kills,deaths:e.deaths,assists:e.assists,team:e.team}:null}didLocalPlayerWin(){const e=this.world.getLocalPlayer();if(!e)return!1;const t=this.world.getAttackerScore(),i=this.world.getDefenderScore();return e.team===g.Attackers?t>i:i>t}sessionStartTime=0;gamesPlayedThisSession=0;async startStatsSession(){this.sessionStartTime=Date.now(),this.gamesPlayedThisSession=0;try{await Me.startSession(this.playerName,this.settings.playerHero),console.log("[Game] Stats session started")}catch(e){console.warn("[Game] Failed to start stats session:",e)}ae.trackHeroSelect(this.settings.playerHero)}async recordMatchResult(){const e=this.getLocalPlayerStats();if(!e)return;const t=this.didLocalPlayerWin();this.gamesPlayedThisSession++;try{await Me.recordGameResult(t,e.kills,e.deaths,e.assists,this.settings.playerHero),console.log(`[Game] Match result recorded: ${t?"WIN":"LOSS"}`)}catch(i){console.warn("[Game] Failed to record match result:",i)}ae.trackMatchEnd({gameMode:this.settings.gameMode,mapId:this.settings.mapId,won:t,durationSeconds:Math.floor((Date.now()-this.sessionStartTime)/1e3),kills:e.kills,deaths:e.deaths,assists:e.assists,heroId:this.settings.playerHero})}async endStatsSession(){const e=Math.floor((Date.now()-this.sessionStartTime)/1e3);try{await Me.endSession(),console.log("[Game] Stats session ended")}catch(t){console.warn("[Game] Failed to end stats session:",t)}ae.trackGameEnd(e,this.gamesPlayedThisSession)}saveStatsOnUnload(){Me.saveUnsavedPlayTimeSync(),console.log("[Game] Stats saved to localStorage for recovery")}trackMatchStart(){const e=this.lobbyPlayers.length||1,t=this.settings.enemyBotCount+this.settings.friendlyBotCount;ae.trackMatchStart({gameMode:this.settings.gameMode,mapId:this.settings.mapId,playerCount:e,botCount:t,isHost:this.isHost})}async hostGame(e){this.isHost=!0,console.log(`[Game] hostGame() called - existingNetwork: ${!!this.existingNetwork}`),this.existingNetwork&&console.log(`[Game] hostGame() - existingNetwork peers: ${this.existingNetwork.getPeerIds().length}`);const t=this.settings.gameMode==="spike"?Q.DataSpikeAssault:Q.NeonDeathmatch;this.world=new ut({mode:t,maxPlayers:8,isHost:!0,abilityQSlot:this.settings.abilityQSlot,abilityFSlot:this.settings.abilityFSlot,totalRounds:this.settings.totalRounds,mapId:this.settings.mapId}),this.gameRenderer.updateWorld(this.world);const i=this.getHeroFromSettings();let o=e||this.generateRoomCode();this.localPeerId="local";const s=this.world.addPlayer("local",this.playerName,g.Attackers,i);if(this.world.setLocalPlayer(s.id),this.existingNetwork){console.log("[Game] Using existing network from lobby"),this.network=this.existingNetwork,this.existingNetwork=null;const d=this.network.getPeerIds(),h=this.network.getPeerCount();console.log(`[Game] Network has ${h} peers: [${d.join(", ")}]`),console.log("[Game] Lobby players passed to game:",this.lobbyPlayers);const m=this.network.getLocalPeerId();this.localPeerId=m,s.peerId=m,this.world.updatePlayerPeerId("local",m),this.setupNetworkListeners(),o=this.network.getRoomCode()||o,console.log(`[Game] Using existing room: ${o}`);for(const u of d){const w=this.lobbyPlayers.find(x=>x.id===u)?.name||`Player ${u.slice(-4)}`;this.world.addPlayer(u,w,g.Defenders,M.Vanta),console.log(`[Game] Added lobby player to game: ${w} (${u}) as Defender`)}}else try{if(ie.apiKey&&ie.apiKey!=="YOUR_API_KEY"){this.network=new He({isHost:!0,useFirestore:!0}),await this.network.connectWithFirebase(ie);const d=this.network.getLocalPeerId();this.localPeerId=d,s.peerId=d,this.world.updatePlayerPeerId("local",d),this.setupNetworkListeners(),await this.network.createRoom(),console.log(`[Game] Connected to Firebase, hosting room: ${o}`)}else{this.network=new He({isHost:!0}),await this.network.connect(dt.SIGNALING_SERVER);const d=this.network.getLocalPeerId();this.localPeerId=d,s.peerId=d,this.world.updatePlayerPeerId("local",d),this.setupNetworkListeners(),await this.network.createRoom(),console.log(`[Game] Connected to signaling server, hosting room: ${o}`)}}catch{console.log("[Game] Networking not available, running in local-only mode"),this.network=null}const n=this.network?.getPeerCount()||0,a=this.network!==null&&n>0;if(!a&&this.settings.enemyBotCount>0){const d=this.settings.enemyBotCount,h=this.settings.botDifficulty;this.world.spawnBots(d,g.Defenders,h),console.log(`[Game] Solo mode: Spawning ${d} ${h} enemy bots`)}else a&&console.log(`[Game] Multiplayer mode: No bots will be spawned (${n} peers connected)`);if(!a&&this.settings.friendlyBotCount>0){const d=this.settings.friendlyBotCount,h=this.settings.botDifficulty;this.world.spawnBots(d,g.Attackers,h),console.log(`[Game] Solo mode: Spawning ${d} ${h} friendly bots`)}this.world.setPhase(A.RoundActive),this.world.startRound(),this.audio.play(F.RoundStart);const r=this.world.getTeamPlayers(g.Attackers),c=this.world.getTeamPlayers(g.Defenders);return console.log(`[Game] Team composition - Attackers: ${r.length} (${r.map(d=>`${d.name}/${d.peerId}/${d.alive}`).join(", ")})`),console.log(`[Game] Team composition - Defenders: ${c.length} (${c.map(d=>`${d.name}/${d.peerId}/${d.alive}`).join(", ")})`),c.length===0&&a&&console.warn("[Game] WARNING: No defenders but this is a multiplayer game! Waiting for peers..."),console.log(`[Game] Hosting game: ${o}, hero: ${i}`),o}generateRoomCode(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ",t="0123456789";let i="";for(let o=0;o<4;o++)i+=e.charAt(Math.floor(Math.random()*e.length));for(let o=0;o<2;o++)i+=t.charAt(Math.floor(Math.random()*t.length));return i}getHeroFromSettings(){switch(this.settings.playerHero){case"vanta":return M.Vanta;case"spectre":return M.Spectre;case"byte":return M.Byte;case"katana":return M.Katana;case"glyph":return M.Glyph;case"spark":return M.Spark;case"zero":return M.Zero;case"mira":return M.Mira;default:return M.Vanta}}async joinGame(e){this.isHost=!1;const t=this.settings.gameMode==="spike"?Q.DataSpikeAssault:Q.NeonDeathmatch;if(this.world=new ut({mode:t,maxPlayers:8,isHost:!1,abilityQSlot:this.settings.abilityQSlot,abilityFSlot:this.settings.abilityFSlot,totalRounds:this.settings.totalRounds,mapId:this.settings.mapId}),this.gameRenderer.updateWorld(this.world),this.existingNetwork)console.log("[Game] Using existing network from lobby for joining"),this.network=this.existingNetwork,this.existingNetwork=null,this.setupNetworkListeners(),this.localPeerId=this.network.getLocalPeerId();else try{ie.apiKey&&ie.apiKey!=="YOUR_API_KEY"?(this.network=new He({isHost:!1,useFirestore:!0}),await this.network.connectWithFirebase(ie),console.log("[Game] Connected to Firebase for joining")):(this.network=new He({isHost:!1}),await this.network.connect(dt.SIGNALING_SERVER),console.log("[Game] Connected to signaling server for joining")),this.setupNetworkListeners(),await this.network.joinRoom(e),console.log(`[Game] Joining room: ${e}`),this.localPeerId=this.network.getLocalPeerId()}catch(s){throw console.error("[Game] Failed to join game:",s),new Error("Could not connect. Make sure Firebase is configured or the signaling server is running.")}const i=this.getHeroFromSettings(),o=this.world.addPlayer(this.localPeerId,this.playerName,g.Defenders,i);this.world.setLocalPlayer(o.id),this.network&&(this.network.broadcast({type:_.PlayerJoin,timestamp:Date.now(),senderId:this.localPeerId,data:{name:this.playerName,heroId:i}}),console.log("[Game] Sent PlayerJoin to host")),console.log("[Game] Waiting for connection to host...")}leaveGame(){this.network?.disconnect(),this.network=null,this.world.setPhase(A.Lobby)}setupNetworkListeners(){if(this.network&&(this.network.on("peerConnected",({peerId:e})=>{if(console.log(`[Game] Peer connected: ${e}`),this.isHost){const t=this.world.getPlayerByPeerId(e);if(t)t.isDisconnected?(t.isDisconnected=!1,console.log(`[Game] Player ${e} reconnected: ${t.name}`)):console.log(`[Game] Player ${e} already exists: ${t.name}`);else{const i=this.lobbyPlayers.find(s=>s.id===e),o=i?.name||`Player ${e.slice(-4)}`;this.world.addPlayer(e,o,g.Defenders,M.Vanta),console.log(`[Game] Added new player ${e} to Defenders: "${o}"`),i||setTimeout(()=>{const s=this.world.getPlayerByPeerId(e);s&&s.name===o&&s.name.startsWith("Player ")&&(console.log(`[Game] Removing unverified player ${e} (no PlayerJoin received)`),this.world.removePlayer(s.id))},1e4)}}}),this.network.on("peerDisconnected",({peerId:e})=>{console.log(`[Game] Peer disconnected: ${e}`);const t=this.world.getPlayerByPeerId(e);if(t&&this.isHost){const o=this.world.getPlayers().filter(s=>!s.peerId.startsWith("bot_")).filter(s=>s.peerId!==e&&!s.isDisconnected);console.log(`[Game] Player ${t.name} disconnected. Remaining human players: ${o.length}`),this.world.getPhase()!==A.MatchEnd&&o.length<=1?(this.world.endMatchByDisconnect(t.team,t.name),console.log(`[Game] Match ended - ${t.name} forfeited by disconnecting`)):(t.isDisconnected=!0,console.log(`[Game] Marked player ${t.name} (${e}) as disconnected`),setTimeout(()=>{const s=this.world.getPlayerByPeerId(e);s&&s.isDisconnected&&(console.log(`[Game] Removing disconnected player ${s.name} (${e}) after timeout`),this.world.removePlayer(s.id))},3e4))}}),this.network.on("packet",({peerId:e,packet:t})=>{this.handlePacket(e,t)}),this.isHost)){const e=this.network.getPeerIds();console.log(`[Game] Found ${e.length} existing peers from lobby`),console.log("[Game] Lobby players:",this.lobbyPlayers);for(const t of e)if(!this.world.getPlayerByPeerId(t)){const s=this.lobbyPlayers.find(n=>n.id===t)?.name||`Player ${t.slice(-4)}`;this.world.addPlayer(t,s,g.Defenders,M.Vanta),console.log(`[Game] Added remote player ${t} to Defenders: "${s}"`)}}}handlePacket(e,t){switch(t.type){case _.PlayerJoin:if(this.isHost){const i=t.data;console.log(`[Game] Received PlayerJoin from ${e}: name=${i.name}, hero=${i.heroId}`);let o=this.world.getPlayerByPeerId(e);if(o){const s=o.name;o.name=i.name,i.heroId&&(o.heroId=i.heroId),console.log(`[Game] Updated player ${e}: "${s}" -> "${i.name}"`)}else{const s=this.world.getPlayerByName(i.name);if(s&&s.isDisconnected){const n=s.peerId;this.world.updatePlayerPeerId(n,e),s.isDisconnected=!1,i.heroId&&(s.heroId=i.heroId),console.log(`[Game] Reconnected player ${i.name}: ${n} -> ${e}`)}else if(s){const n=this.world.getPlayerByPeerId(e);n&&(console.log(`[Game] Removing duplicate player ${e} (${i.name} already exists)`),this.world.removePlayer(n.id))}else o=this.world.addPlayer(e,i.name,g.Defenders,i.heroId||M.Vanta),console.log(`[Game] Created player ${e}: "${i.name}"`)}}break;case _.Input:if(this.isHost){const i=t.data,o=this.world.getPlayerByPeerId(e);o&&o.alive?(o.setInput(i),i.interact&&console.log(`[Game] Input from ${o.name} (${e}): interact=true`),(i.moveX!==0||i.moveY!==0)&&console.log(`[Game] Input from ${o.name}: move(${i.moveX.toFixed(1)}, ${i.moveY.toFixed(1)})`)):o||console.log(`[Game] Input from unknown peer: ${e}`)}break;case _.StateSnapshot:if(!this.isHost){const i=t.data;this.debugReceivedState||(console.log(`[Game] First state received from host - phase: ${i.phase}, players: ${i.players?.length||0}`),this.debugReceivedState=!0),this.applySerializedState(i)}break;case _.CountdownPause:if(this.isHost){const o=this.world.getPlayerByPeerId(e)?.name||"Unknown";this.world.pauseCountdown(o)}break;case _.CountdownResume:if(this.isHost){const o=this.world.getPlayerByPeerId(e)?.name||"Unknown";this.world.resumeCountdown(o)}break;case _.GamePause:if(this.isHost){const o=this.world.getPlayerByPeerId(e)?.name||"Unknown";this.world.playerLostFocus(e,o)}break;case _.GameResume:if(this.isHost){const o=this.world.getPlayerByPeerId(e)?.name||"Unknown";this.world.playerRegainedFocus(e,o)}break}}serializeState(){const e=this.world.getState();return{phase:e.phase,mode:e.mode,mapId:e.mapId,tick:e.tick,time:e.time,roundStartTime:e.roundStartTime,roundNumber:e.roundNumber,maxRounds:e.maxRounds,roundTimeLimit:e.roundTimeLimit,attackerScore:e.attackerScore,defenderScore:e.defenderScore,players:Array.from(e.players.entries()),projectiles:Array.from(e.projectiles.entries()),objectives:e.objectives,recentShots:e.recentShots||[],countdownTime:e.countdownTime??1e4,countdownPaused:e.countdownPaused??!1,countdownPausedBy:e.countdownPausedBy??"",gamePaused:this.world.isGamePaused(),gamePausedBy:this.world.getGamePausedBy(),disconnectForfeit:this.world.isDisconnectForfeit(),disconnectedPlayerName:this.world.getDisconnectedPlayerName()}}applySerializedState(e){const t={phase:e.phase,mode:e.mode,mapId:e.mapId,tick:e.tick,time:e.time,roundStartTime:e.roundStartTime,roundNumber:e.roundNumber,maxRounds:e.maxRounds,roundTimeLimit:e.roundTimeLimit,attackerScore:e.attackerScore,defenderScore:e.defenderScore,players:new Map(e.players),projectiles:new Map(e.projectiles),objectives:e.objectives,recentShots:e.recentShots||[],countdownTime:e.countdownTime??1e4,countdownPaused:e.countdownPaused??!1,countdownPausedBy:e.countdownPausedBy??""};if(this.world.applyState(t),e.gamePaused!==void 0&&this.world.setGamePauseState(e.gamePaused,e.gamePausedBy??""),e.disconnectForfeit!==void 0&&this.world.setDisconnectForfeitState(e.disconnectForfeit,e.disconnectedPlayerName??""),t.recentShots){const i=this.world.getLocalPlayer();for(const o of t.recentShots){if(i&&o.shooterPeerId===i.peerId)continue;const s=this.world.isEnemyOfLocal(o.shooterId);this.gameRenderer.addBulletTracer(o.start,o.end,s)}}}toggleCountdownPause(){const t=this.world.getLocalPlayer()?.name||"Unknown";if(this.isHost)this.world.toggleCountdownPause(t);else if(this.network){const i=this.world.isCountdownPaused();this.network.broadcast({type:i?_.CountdownResume:_.CountdownPause,timestamp:Date.now(),senderId:this.network.getLocalPeerId(),data:{playerName:t}})}}onTabBlur(){const e=this.world.getLocalPlayer(),t=e?.name||"Unknown",i=e?.peerId||this.localPeerId;this.isHost?this.world.playerLostFocus(i,t):this.network&&this.network.broadcast({type:_.GamePause,timestamp:Date.now(),senderId:this.network.getLocalPeerId(),data:{playerName:t}}),console.log(`[Game] Tab blur - requesting game pause for ${t}`)}onTabFocus(){const e=this.world.getLocalPlayer(),t=e?.name||"Unknown",i=e?.peerId||this.localPeerId;this.isHost?this.world.playerRegainedFocus(i,t):this.network&&this.network.broadcast({type:_.GameResume,timestamp:Date.now(),senderId:this.network.getLocalPeerId(),data:{playerName:t}}),console.log(`[Game] Tab focus - requesting game resume for ${t}`)}isGamePausedByFocus(){return this.world.isGamePaused()}getGamePausedInfo(){return{isPaused:this.world.isGamePaused(),pausedBy:this.world.getGamePausedBy(),pausedCount:this.world.getPausedPlayerCount()}}getAudioSettings(){return this.audio.getSettings()}updateAudioSettings(e){this.audio.updateSettings(e)}broadcastState(){if(!this.network||!this.isHost)return;this.debugBroadcastStarted||(console.log(`[Game] Starting state broadcasts to ${this.network.getPeerCount()} peers`),this.debugBroadcastStarted=!0);const e=this.serializeState();this.network.broadcast({type:_.StateSnapshot,timestamp:Date.now(),senderId:this.localPeerId,data:e})}handleGameEvent(e){switch(e.type){case G.PlayerKill:{const t=e.data,i=this.world.getPlayer(t.victimId),o=this.world.getLocalPlayer();i&&(this.gameRenderer.addPlayerDeath(i.position),this.audio.play(F.PlayerDeath),o&&t.killerId===o.id&&setTimeout(()=>{this.audio.play(F.KillConfirmed,1)},200));break}case G.PlayerDamage:{const t=e.data,i=this.world.getPlayer(t.targetId);if(i&&t.position){const o={x:i.position.x-t.position.x,y:i.position.y-t.position.y};this.gameRenderer.addPlayerHit(t.position,o),this.audio.playWithVariation(F.PlayerDamage,.8)}break}case G.RoundStarted:{const t=e.data;if(t.eventType==="aircraft_spawn")this.audio.play(F.AirplaneFlyby,.6);else if(t.eventType==="parachute_landed")this.audio.play(F.ParachuteDrop,.5);else if(t.eventType==="missile_incoming")this.audio.play(F.MissileIncoming,.7);else if(t.eventType==="crate_pickup"){const i=this.world.getLocalPlayer(),o=t;if(i&&o.playerId===i.id&&o.pickupMessage){let s="#00FF88";o.pickupSound==="weapon"?s="#FF00FF":o.pickupSound==="health"?s="#44FF44":o.pickupMessage.includes("$")&&(s="#FFD700"),this.gameRenderer.addPickupNotification(o.pickupMessage,s)}console.log(`[Game] Received crate_pickup event - sound type: ${o.pickupSound}`),o.pickupSound==="weapon"?(console.log("[Game] Playing WeaponPickup sound"),this.audio.play(F.WeaponPickup,.8)):o.pickupSound==="health"?(console.log("[Game] Playing HealthPickup sound"),this.audio.play(F.HealthPickup,.7)):(console.log("[Game] Playing ItemPickup sound"),this.audio.play(F.ItemPickup,.7))}else if(t.eventType==="grenade_explosion"){const i=t;i.position&&(this.gameRenderer.addPlayerDeath(i.position),this.audio.play(F.Explosion,.9))}else if(t.eventType==="bomb_explosion"){const i=t;i.position&&(this.gameRenderer.addPlayerDeath(i.position),this.gameRenderer.addPlayerDeath(i.position),this.audio.play(F.Explosion,1))}break}}}playWeaponSound(e){switch(e){case"burst_pistol":this.audio.playWithVariation(F.PulsePistolShoot);break;case"neo_smg9":case"pulse_rifle":this.audio.playWithVariation(F.PlasmaRifleShoot);break;case"scatter_shot":this.audio.playWithVariation(F.ScatterGunShoot);break;case"rail_sniper":this.audio.playWithVariation(F.FusionCannonShoot);break;default:this.audio.playWithVariation(F.PulsePistolShoot)}}update(e,t){this.inputManager.update(),this.updateCameraInput();const i=this.world.getPhase(),o=i===A.RoundActive;if(i!==this.lastPhase){if(i===A.RoundEnd&&this.lastPhase===A.RoundActive){this.countdownSoundId&&this.audio.stop(this.countdownSoundId);const n=this.world.getCountdownTime(),a=this.audio.getSoundDuration(F.CountdownTick),r=Math.max(0,a-n/1e3);this.countdownSoundId=this.audio.playAtOffset(F.CountdownTick,r),this.lastCountdownPaused=!1}i===A.RoundActive&&this.lastPhase===A.RoundEnd&&(this.countdownSoundId&&(this.audio.stop(this.countdownSoundId),this.countdownSoundId=null),this.audio.play(F.RoundStart),this.inputManager.resetAllInputs()),this.lastPhase=i}if(i===A.RoundEnd){const n=this.world.isCountdownPaused();if(n!==this.lastCountdownPaused){if(n)this.countdownSoundId&&(this.audio.stop(this.countdownSoundId),this.countdownSoundId=null);else{const a=this.world.getCountdownTime(),r=this.audio.getSoundDuration(F.CountdownTick),c=Math.max(0,r-a/1e3);this.countdownSoundId=this.audio.playAtOffset(F.CountdownTick,c)}this.lastCountdownPaused=n}}const s=this.world.getLocalPlayer();if(!s&&o&&!this.debugLoggedNoPlayer&&(console.log(`[Game] WARNING: No local player found! isHost=${this.isHost}, localPlayerId=${this.world.localPlayerId}`),this.debugLoggedNoPlayer=!0),s&&o){const n=this.inputManager.getState(),a={moveX:n.moveX,moveY:n.moveY,aimX:n.aimX,aimY:n.aimY,shoot:n.shoot,reload:n.reload,interact:n.interact,throwGrenade:n.throwGrenade,useBombCall:n.useBombCall,useMissileStrike:n.useMissileStrike,ability1:n.ability1,ability2:n.ability2,ultimate:n.ultimate,weaponSlot:n.weaponSlot,sequence:this.inputManager.getNextSequence()};if(s.setInput(a),n.weaponSlot!==0&&s.alive){let r=!1;n.weaponSlot===-1?r=s.cycleWeaponNext():n.weaponSlot===-2?r=s.cycleWeaponPrevious():n.weaponSlot>0&&(r=s.switchToWeaponSlot(n.weaponSlot)),r&&this.gameRenderer.addWeaponSwitch(s.position)}if(n.shoot&&s.alive&&s.canFire(this.world.getTime()+this.world.getRoundNumber()*2e5)){const r=performance.now();if(r-this.lastLocalFireTime>50){if(this.gameRenderer.addMuzzleFlash(s.position,s.rotation),this.playWeaponSound(s.weapon.weaponId),!this.isHost){const c=s.getWeaponDefinition();if(c&&c.projectileSpeed===0){const d={x:Math.cos(s.rotation),y:Math.sin(s.rotation)},h={x:s.position.x+d.x*20,y:s.position.y+d.y*20},u=this.world.getCollisionWorld().raycast(h,d,c.range,65535),p=u?u.point:{x:h.x+d.x*c.range,y:h.y+d.y*c.range};this.gameRenderer.addBulletTracer(h,p,!1)}}this.lastLocalFireTime=r}}if(!this.isHost&&this.network){const r=performance.now();r-this.lastInputSendTime>=1e3/dt.INPUT_RATE&&(this.network.broadcast({type:_.Input,timestamp:Date.now(),senderId:this.localPeerId,data:a}),this.lastInputSendTime=r)}}if(this.isHost){if(this.world.update(e),this.network&&this.network.getPeerCount()>0){const r=performance.now();r-this.lastStateBroadcastTime>=50&&(this.broadcastState(),this.lastStateBroadcastTime=r)}const n=this.world.getAndClearRecentShots();for(const r of n){const c=this.world.isEnemyOfLocal(r.shooterId);this.gameRenderer.addBulletTracer(r.start,r.end,c)}const a=this.world.getPendingEvents();for(const r of a)this.handleGameEvent(r)}else this.world.updateLocalPlayerOnly(e);if(this.gameRenderer.updateParticles(e),this.network){const n=performance.now();n-this.lastPingTime>=dt.PING_INTERVAL&&(this.network.pingPeers(),this.lastPingTime=n)}}updateCameraInput(){const e=this.renderer.getCameraOffset(),t=this.renderer.getCameraZoom();this.inputManager.updateCamera(e,t)}render(e){if(this.gameRenderer.render(e),this.showFPS&&this.debugInfo){const t=this.gameLoop.getFPS(),i=this.gameLoop.getTPS(),o=this.world.getPlayers().length,s=this.world.getPhase(),n=this.network?.getAverageLatency()??0;this.debugInfo.innerHTML=`
        FPS: ${t} | TPS: ${i}<br>
        Phase: ${s}<br>
        Players: ${o}<br>
        Tick: ${this.world.getTick()}<br>
        ${this.network?`Latency: ${n.toFixed(1)}ms<br>`:""}
        ${this.isHost?"HOST":"CLIENT"}
      `,this.debugInfo.style.display="block"}else this.debugInfo&&(this.debugInfo.style.display="none")}setPlayerName(e){this.playerName=e}getPlayerName(){return this.playerName}isRunning(){return this.gameLoop.isRunning()}getWorld(){return this.world}setShowFPS(e){this.showFPS=e,this.debugInfo&&!e&&(this.debugInfo.style.display="none")}getShowFPS(){return this.showFPS}showHeroTutorial(e){const t=JSON.parse(localStorage.getItem("cybergrid_tutorials")||"[]");if(t.includes(e))return;const i=ee[e];if(!i)return;this.heroTutorialOverlay=document.createElement("div"),this.heroTutorialOverlay.id="hero-tutorial-overlay",this.heroTutorialOverlay.innerHTML=`
      <div class="tutorial-content">
        <h2>Playing as ${i.name}</h2>
        <p class="hero-role">${i.role}</p>
        
        <div class="abilities-list">
          <div class="ability-item passive">
            <span class="key">PASSIVE</span>
            <span class="name">${i.abilities[0]?.name||"Unknown"}</span>
            <span class="desc">${i.abilities[0]?.description||""}</span>
          </div>
          <div class="ability-item">
            <span class="key">Q</span>
            <span class="name">${i.abilities[1]?.name||"Unknown"}</span>
            <span class="desc">${i.abilities[1]?.description||""}</span>
          </div>
          <div class="ability-item">
            <span class="key">F</span>
            <span class="name">${i.abilities[2]?.name||"Unknown"}</span>
            <span class="desc">${i.abilities[2]?.description||""}</span>
          </div>
          <div class="ability-item ultimate">
            <span class="key">X</span>
            <span class="name">${i.abilities[3]?.name||"Unknown"}</span>
            <span class="desc">${i.abilities[3]?.description||""}</span>
          </div>
        </div>
        
        <button id="tutorial-dismiss">Got it! (Click or press any key)</button>
      </div>
    `;const o=document.createElement("style");o.textContent=`
      #hero-tutorial-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .tutorial-content {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid #0ce5f0;
        border-radius: 12px;
        padding: 30px 40px;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 0 30px rgba(12, 229, 240, 0.3);
      }
      .tutorial-content h2 {
        color: #0ce5f0;
        margin: 0 0 5px 0;
        font-size: 28px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .hero-role {
        color: #888;
        margin: 0 0 20px 0;
        font-size: 14px;
      }
      .abilities-list {
        text-align: left;
        margin: 20px 0;
      }
      .ability-item {
        display: grid;
        grid-template-columns: 60px 1fr;
        grid-template-rows: auto auto;
        gap: 2px 10px;
        padding: 10px;
        margin: 8px 0;
        background: rgba(255,255,255,0.05);
        border-radius: 6px;
        border-left: 3px solid #0ce5f0;
      }
      .ability-item.passive {
        border-left-color: #4a4;
      }
      .ability-item.ultimate {
        border-left-color: #ffcc00;
        background: rgba(255, 200, 0, 0.1);
      }
      .ability-item .key {
        grid-row: span 2;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(12, 229, 240, 0.2);
        color: #0ce5f0;
        font-weight: bold;
        font-size: 18px;
        border-radius: 4px;
      }
      .ability-item.passive .key {
        background: rgba(68, 170, 68, 0.2);
        color: #4a4;
        font-size: 10px;
      }
      .ability-item.ultimate .key {
        background: rgba(255, 200, 0, 0.2);
        color: #ffcc00;
      }
      .ability-item .name {
        color: #fff;
        font-weight: bold;
        font-size: 14px;
      }
      .ability-item .desc {
        color: #aaa;
        font-size: 12px;
      }
      #tutorial-dismiss {
        background: linear-gradient(135deg, #0ce5f0 0%, #0891b2 100%);
        border: none;
        color: #000;
        padding: 12px 30px;
        font-size: 14px;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      #tutorial-dismiss:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(12, 229, 240, 0.5);
      }
    `,document.head.appendChild(o),document.body.appendChild(this.heroTutorialOverlay);const s=()=>{this.heroTutorialOverlay&&(this.heroTutorialOverlay.remove(),this.heroTutorialOverlay=null),t.push(e),localStorage.setItem("cybergrid_tutorials",JSON.stringify(t)),this.heroTutorialShown=!0,document.removeEventListener("keydown",s),document.removeEventListener("click",s)};document.getElementById("tutorial-dismiss")?.addEventListener("click",s),setTimeout(()=>{document.addEventListener("keydown",s,{once:!0})},500)}checkAndShowHeroTutorial(){if(this.heroTutorialShown)return;const e=this.settings.playerHero;this.showHeroTutorial(e)}showHeroInfo(){if(this.heroTutorialOverlay){this.heroTutorialOverlay.remove(),this.heroTutorialOverlay=null;return}const e=this.settings.playerHero,t=ee[e];if(!t)return;if(this.heroTutorialOverlay=document.createElement("div"),this.heroTutorialOverlay.id="hero-tutorial-overlay",this.heroTutorialOverlay.innerHTML=`
      <div class="tutorial-content">
        <div class="info-columns">
          <div class="hero-column">
            <h2>${t.name}</h2>
            <p class="hero-role">${t.role}</p>
            <p class="hero-stats">HP: ${t.health} | Shield: ${t.shield} | Speed: ${Math.round(t.speed*100)}%</p>
            
            <div class="abilities-list">
              <div class="ability-item passive">
                <span class="key">PASSIVE</span>
                <span class="name">${t.abilities[0]?.name||"Unknown"}</span>
                <span class="desc">${t.abilities[0]?.description||""}</span>
              </div>
              <div class="ability-item">
                <span class="key">Q</span>
                <span class="name">${t.abilities[1]?.name||"Unknown"}</span>
                <span class="desc">${t.abilities[1]?.description||""}</span>
                <span class="cooldown">${(t.abilities[1]?.cooldown||0)/1e3}s cooldown</span>
              </div>
              <div class="ability-item">
                <span class="key">F</span>
                <span class="name">${t.abilities[2]?.name||"Unknown"}</span>
                <span class="desc">${t.abilities[2]?.description||""}</span>
                <span class="cooldown">${(t.abilities[2]?.cooldown||0)/1e3}s cooldown</span>
              </div>
              <div class="ability-item ultimate">
                <span class="key">X</span>
                <span class="name">${t.abilities[3]?.name||"Unknown"}</span>
                <span class="desc">${t.abilities[3]?.description||""}</span>
                <span class="cooldown">${t.abilities[3]?.ultimateCost||0} charge cost</span>
              </div>
            </div>
          </div>
          
          <div class="controls-column">
            <h3>Controls</h3>
            <div class="controls-list">
              <div class="control-item"><span class="ctrl-key">WASD</span><span class="ctrl-action">Move</span></div>
              <div class="control-item"><span class="ctrl-key">Mouse</span><span class="ctrl-action">Aim</span></div>
              <div class="control-item"><span class="ctrl-key">Left Click</span><span class="ctrl-action">Shoot</span></div>
              <div class="control-item"><span class="ctrl-key">Right Click</span><span class="ctrl-action">Reload</span></div>
              <div class="control-item"><span class="ctrl-key">R</span><span class="ctrl-action">Reload</span></div>
              <div class="control-item"><span class="ctrl-key">Wheel</span><span class="ctrl-action">Switch Weapon</span></div>
              <div class="control-item"><span class="ctrl-key">1-5</span><span class="ctrl-action">Select Weapon</span></div>
              <div class="control-item"><span class="ctrl-key">Q</span><span class="ctrl-action">Ability 1</span></div>
              <div class="control-item"><span class="ctrl-key">F</span><span class="ctrl-action">Ability 2</span></div>
              <div class="control-item"><span class="ctrl-key">X</span><span class="ctrl-action">Ultimate</span></div>
              <div class="control-item"><span class="ctrl-key">B</span><span class="ctrl-action">Buy Menu</span></div>
              <div class="control-item"><span class="ctrl-key">P</span><span class="ctrl-action">Pause Countdown</span></div>
              <div class="control-item"><span class="ctrl-key">ESC</span><span class="ctrl-action">Pause/Menu</span></div>
              <div class="control-item"><span class="ctrl-key">H</span><span class="ctrl-action">This Help</span></div>
            </div>
          </div>
        </div>
        
        <p class="dismiss-hint">Press H or click anywhere to close</p>
      </div>
    `,!document.getElementById("hero-info-styles")){const o=document.createElement("style");o.id="hero-info-styles",o.textContent=`
        #hero-tutorial-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.85);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .tutorial-content {
          background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
          border: 2px solid #0ce5f0;
          border-radius: 12px;
          padding: 30px 40px;
          max-width: 850px;
          text-align: center;
          box-shadow: 0 0 30px rgba(12, 229, 240, 0.3);
        }
        .info-columns {
          display: flex;
          gap: 30px;
          text-align: left;
        }
        .hero-column {
          flex: 1;
          min-width: 320px;
        }
        .controls-column {
          flex: 0 0 220px;
          border-left: 1px solid #333;
          padding-left: 30px;
        }
        .controls-column h3 {
          color: #0ce5f0;
          margin: 0 0 15px 0;
          font-size: 18px;
          text-transform: uppercase;
          letter-spacing: 1px;
        }
        .controls-list {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }
        .control-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 4px 0;
        }
        .ctrl-key {
          background: #333;
          color: #0ce5f0;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: bold;
          min-width: 60px;
          text-align: center;
        }
        .ctrl-action {
          color: #aaa;
          font-size: 12px;
        }
        .tutorial-content h2 {
          color: #0ce5f0;
          margin: 0 0 5px 0;
          font-size: 28px;
          text-transform: uppercase;
          letter-spacing: 2px;
        }
        .hero-role {
          color: #888;
          margin: 0 0 5px 0;
          font-style: italic;
        }
        .hero-stats {
          color: #6af;
          margin: 0 0 20px 0;
          font-size: 14px;
        }
        .abilities-list {
          text-align: left;
          margin: 20px 0;
        }
        .ability-item {
          display: grid;
          grid-template-columns: 70px 1fr;
          grid-template-rows: auto auto;
          gap: 2px 10px;
          padding: 10px;
          margin: 8px 0;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 6px;
          border-left: 3px solid #0ce5f0;
        }
        .ability-item.passive {
          border-left-color: #4a4;
          opacity: 0.8;
        }
        .ability-item.ultimate {
          border-left-color: #f0c020;
          background: rgba(240, 192, 32, 0.1);
        }
        .ability-item .key {
          grid-row: 1 / 3;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #0ce5f0;
          color: #000;
          font-weight: bold;
          font-size: 16px;
          border-radius: 4px;
          padding: 5px;
        }
        .ability-item.passive .key {
          background: #4a4;
          font-size: 10px;
        }
        .ability-item.ultimate .key {
          background: #f0c020;
        }
        .ability-item .name {
          color: #fff;
          font-weight: bold;
          font-size: 14px;
        }
        .ability-item .desc {
          color: #aaa;
          font-size: 12px;
        }
        .ability-item .cooldown {
          grid-column: 2;
          color: #0ce5f0;
          font-size: 11px;
          margin-top: 2px;
        }
        .dismiss-hint {
          color: #666;
          font-size: 12px;
          margin-top: 15px;
        }
      `,document.head.appendChild(o)}document.body.appendChild(this.heroTutorialOverlay);const i=o=>{o.type==="click"&&o.target!==this.heroTutorialOverlay||(this.heroTutorialOverlay&&(this.heroTutorialOverlay.remove(),this.heroTutorialOverlay=null),document.removeEventListener("click",i))};setTimeout(()=>{this.heroTutorialOverlay?.addEventListener("click",i)},100)}isHeroInfoVisible(){return this.heroTutorialOverlay!==null}}class Vs{db=null;firebase=null;isInitialized=!1;unsubscribe=null;async initialize(){if(!this.isInitialized)try{const{initializeApp:e,getApps:t,getApp:i}=await Se(async()=>{const{initializeApp:I,getApps:T,getApp:R}=await import("./index.esm-OOYOW6k3.js");return{initializeApp:I,getApps:T,getApp:R}},__vite__mapDeps([0,1]),import.meta.url),{getFirestore:o,collection:s,doc:n,setDoc:a,getDoc:r,updateDoc:c,deleteDoc:d,query:h,where:m,orderBy:u,limit:p,getDocs:w,onSnapshot:x,serverTimestamp:S}=await Se(async()=>{const{getFirestore:I,collection:T,doc:R,setDoc:W,getDoc:$,updateDoc:Y,deleteDoc:Z,query:N,where:O,orderBy:ve,limit:Ne,getDocs:Fe,onSnapshot:ct,serverTimestamp:We}=await import("./index.esm-DbUeHnob.js");return{getFirestore:I,collection:T,doc:R,setDoc:W,getDoc:$,updateDoc:Y,deleteDoc:Z,query:N,where:O,orderBy:ve,limit:Ne,getDocs:Fe,onSnapshot:ct,serverTimestamp:We}},__vite__mapDeps([2,1]),import.meta.url);this.firebase={collection:s,doc:n,setDoc:a,getDoc:r,updateDoc:c,deleteDoc:d,query:h,where:m,orderBy:u,limit:p,getDocs:w,onSnapshot:x,serverTimestamp:S};const k=t().length===0?e(ie):i();this.db=o(k),this.isInitialized=!0,console.log("[LobbyBrowser] Initialized")}catch(e){console.error("[LobbyBrowser] Initialization failed:",e)}}async createPublicLobby(e){this.isInitialized||await this.initialize();const{doc:t,setDoc:i,serverTimestamp:o}=this.firebase;try{const s=t(this.db,"publicLobbies",e.roomCode);await i(s,{roomCode:e.roomCode,hostId:e.hostId,hostName:e.hostName,gameMode:e.gameMode,mapId:e.mapId,currentPlayers:1,maxPlayers:e.maxPlayers,isPublic:!0,status:"waiting",createdAt:o(),lastUpdated:o()}),console.log(`[LobbyBrowser] Public lobby created: ${e.roomCode}`)}catch(s){console.error("[LobbyBrowser] Failed to create public lobby:",s)}}async updateLobbyPlayerCount(e,t){this.isInitialized||await this.initialize();const{doc:i,updateDoc:o,serverTimestamp:s}=this.firebase;try{const n=i(this.db,"publicLobbies",e);await o(n,{currentPlayers:t,lastUpdated:s()})}catch(n){console.warn("[LobbyBrowser] Failed to update player count:",n)}}async updateLobbyStatus(e,t){this.isInitialized||await this.initialize();const{doc:i,updateDoc:o,deleteDoc:s,serverTimestamp:n}=this.firebase;try{const a=i(this.db,"publicLobbies",e);t==="playing"||t==="finished"?(await s(a),console.log(`[LobbyBrowser] Lobby removed: ${e}`)):await o(a,{status:t,lastUpdated:n()})}catch(a){console.warn("[LobbyBrowser] Failed to update lobby status:",a)}}async removeLobby(e){this.isInitialized||await this.initialize();const{doc:t,deleteDoc:i}=this.firebase;try{const o=t(this.db,"publicLobbies",e);await i(o),console.log(`[LobbyBrowser] Lobby removed: ${e}`)}catch(o){console.warn("[LobbyBrowser] Failed to remove lobby:",o)}}async getPublicLobbies(){this.isInitialized||await this.initialize();const{collection:e,query:t,limit:i,getDocs:o}=this.firebase;try{console.log("[LobbyBrowser] Querying publicLobbies collection...");const s=t(e(this.db,"publicLobbies"),i(50)),n=await o(s);console.log(`[LobbyBrowser] Query returned ${n.size} documents`);const a=[];return n.forEach(r=>{const c=r.data();console.log("[LobbyBrowser] Lobby data:",c),c.status==="waiting"&&c.isPublic===!0&&c.currentPlayers<c.maxPlayers&&a.push({roomCode:c.roomCode,hostName:c.hostName,hostId:c.hostId,gameMode:c.gameMode,mapId:c.mapId,currentPlayers:c.currentPlayers,maxPlayers:c.maxPlayers,createdAt:c.createdAt?.toMillis?.()||Date.now(),isPublic:c.isPublic,status:c.status})}),a.sort((r,c)=>c.createdAt-r.createdAt),console.log(`[LobbyBrowser] Found ${a.length} public lobbies`),a}catch(s){return console.error("[LobbyBrowser] Failed to fetch lobbies:",s),[]}}subscribeToLobbies(e){if(!this.isInitialized)return console.warn("[LobbyBrowser] Not initialized - call initialize() first"),()=>{};this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null);const{collection:t,query:i,limit:o,onSnapshot:s}=this.firebase;try{console.log("[LobbyBrowser] Setting up real-time subscription...");const n=i(t(this.db,"publicLobbies"),o(50)),a=s(n,r=>{const c=[];r.forEach(d=>{const h=d.data();h.status==="waiting"&&h.isPublic===!0&&h.currentPlayers<h.maxPlayers&&c.push({roomCode:h.roomCode,hostName:h.hostName,hostId:h.hostId,gameMode:h.gameMode,mapId:h.mapId,currentPlayers:h.currentPlayers,maxPlayers:h.maxPlayers,createdAt:h.createdAt?.toMillis?.()||Date.now(),isPublic:h.isPublic,status:h.status})}),c.sort((d,h)=>h.createdAt-d.createdAt),e(c)},r=>{console.error("[LobbyBrowser] Subscription error:",r)});return this.unsubscribe=a,a}catch(n){return console.error("[LobbyBrowser] Failed to subscribe to lobbies:",n),()=>{}}}unsubscribeFromLobbies(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}async cleanupStaleLobbies(){this.isInitialized||await this.initialize();const{collection:e,query:t,getDocs:i,deleteDoc:o,doc:s,limit:n}=this.firebase;try{const a=Date.now()-6e5,r=t(e(this.db,"publicLobbies"),n(100)),c=await i(r);let d=0;for(const h of c.docs){const m=h.data();(m.createdAt?.toMillis?.()||0)<a&&m.status==="waiting"&&(await o(s(this.db,"publicLobbies",h.id)),d++)}return d>0&&console.log(`[LobbyBrowser] Cleaned up ${d} stale lobbies`),d}catch(a){return console.warn("[LobbyBrowser] Failed to cleanup stale lobbies:",a),0}}}const re=new Vs;class ye{static instance=null;localStream=null;micEnabled=!1;peerConnections=new Map;audioElements=new Map;allowedPeers=new Set;constructor(){}static getInstance(){return ye.instance||(ye.instance=new ye),ye.instance}async initialize(){console.log("[VoiceChat] Initialized")}async enableMicrophone(){if(this.micEnabled)return!0;try{return this.localStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),this.micEnabled=!0,console.log("[VoiceChat] Microphone enabled"),this.updatePeerTracks(),!0}catch(e){return console.error("[VoiceChat] Failed to enable microphone:",e),!1}}disableMicrophone(){this.micEnabled&&(this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.micEnabled=!1,console.log("[VoiceChat] Microphone disabled"),this.updatePeerTracks())}async toggleMicrophone(){return this.micEnabled?(this.disableMicrophone(),!1):await this.enableMicrophone()}isMicrophoneEnabled(){return this.micEnabled}setAllowedPeers(e){this.allowedPeers.clear(),e.forEach(t=>this.allowedPeers.add(t)),console.log("[VoiceChat] Allowed peers:",e)}addPeerConnection(e,t){if(!this.allowedPeers.has(e)){console.log("[VoiceChat] Peer not allowed:",e);return}if(this.peerConnections.set(e,t),this.localStream&&this.micEnabled){const i=this.localStream.getAudioTracks()[0];i&&t.addTrack(i,this.localStream)}t.ontrack=i=>{console.log("[VoiceChat] Received track from:",e);const o=i.streams[0];let s=this.audioElements.get(e);s||(s=new Audio,s.autoplay=!0,this.audioElements.set(e,s)),s.srcObject=o},console.log("[VoiceChat] Added peer connection:",e)}removePeerConnection(e){this.peerConnections.delete(e);const t=this.audioElements.get(e);t&&(t.srcObject=null,this.audioElements.delete(e)),console.log("[VoiceChat] Removed peer connection:",e)}updatePeerTracks(){this.peerConnections.forEach(e=>{if(e.getSenders().forEach(i=>{i.track?.kind==="audio"&&e.removeTrack(i)}),this.localStream&&this.micEnabled){const i=this.localStream.getAudioTracks()[0];i&&e.addTrack(i,this.localStream)}})}cleanup(){this.disableMicrophone(),this.peerConnections.forEach(e=>e.close()),this.peerConnections.clear(),this.audioElements.forEach(e=>{e.srcObject=null}),this.audioElements.clear(),this.allowedPeers.clear(),console.log("[VoiceChat] Cleaned up")}}class Us{context=null;sounds=new Map;initialized=!1;loading=!1;enabled=!0;volume=.7;async init(){if(!(this.initialized||this.loading)){this.loading=!0;try{this.context=new AudioContext,await Promise.all([this.loadSound("hover","./assets/audio/ui/hover.mp3"),this.loadSound("click","./assets/audio/ui/click.mp3")]),this.initialized=!0,console.log("[UIAudio] Initialized with",this.sounds.size,"sounds")}catch(e){console.warn("[UIAudio] Failed to initialize:",e)}this.loading=!1}}async loadSound(e,t){if(this.context)try{const o=await(await fetch(t)).arrayBuffer(),s=await this.context.decodeAudioData(o);this.sounds.set(e,s),console.log(`[UIAudio] Loaded: ${e}`)}catch(i){console.warn(`[UIAudio] Failed to load ${e}:`,i)}}play(e,t=.5){if(!this.enabled||!this.context||!this.sounds.has(e)){!this.initialized&&!this.loading&&this.init();return}this.context.state==="suspended"&&this.context.resume();const i=this.sounds.get(e),o=this.context.createBufferSource();o.buffer=i;const s=this.context.createGain();s.gain.value=t*this.volume,o.connect(s),s.connect(this.context.destination),o.start(0)}playHover(){this.play("hover",.3)}playClick(){this.play("click",.5)}setEnabled(e){this.enabled=e}setVolume(e){this.volume=Math.max(0,Math.min(1,e))}}const ce=new Us,Ye=()=>{ce.init(),document.removeEventListener("click",Ye),document.removeEventListener("keydown",Ye),document.removeEventListener("mousemove",Ye)};document.addEventListener("click",Ye);document.addEventListener("keydown",Ye);document.addEventListener("mousemove",Ye);let z=null;const Ve=document.getElementById("game-canvas"),pe=document.getElementById("connection-ui"),Ri=document.getElementById("version-badge"),se=document.getElementById("player-name"),je=document.getElementById("btn-host"),Xe=document.getElementById("btn-join"),oe=document.getElementById("room-code"),js=document.getElementById("btn-connect"),Xs=document.getElementById("btn-back"),lt=document.getElementById("join-buttons"),Gt=document.getElementById("btn-settings"),Ie=document.getElementById("settings-panel"),Ks=document.getElementById("btn-how-to-play"),Kt=document.getElementById("how-to-play-modal"),Js=document.getElementById("btn-how-to-play-close"),qs=document.getElementById("btn-stats"),Jt=document.getElementById("stats-modal"),Zs=document.getElementById("btn-stats-close"),X=document.getElementById("btn-mic-toggle"),kt=document.getElementById("setting-bot-count"),Gi=document.getElementById("bot-count-value"),Hi=document.getElementById("setting-bot-difficulty"),Pt=document.getElementById("setting-friendly-bots"),Oi=document.getElementById("friendly-bot-count-value"),Yi=document.getElementById("setting-ai-mode"),at=document.getElementById("setting-game-mode"),de=document.getElementById("setting-map"),ke=document.getElementById("map-hint"),Ht=document.getElementById("setting-hero"),Ot=document.getElementById("setting-ability-q"),Yt=document.getElementById("setting-ability-f"),Qs=document.getElementById("ability-q-name"),eo=document.getElementById("ability-f-name"),to=document.getElementById("btn-settings-save"),io=document.getElementById("btn-settings-close"),tt=document.getElementById("settings-audio-master-volume"),ii=document.getElementById("settings-audio-master-enabled"),si=document.getElementById("settings-audio-master-value"),it=document.getElementById("settings-audio-music-volume"),oi=document.getElementById("settings-audio-music-enabled"),ni=document.getElementById("settings-audio-music-value"),st=document.getElementById("settings-audio-sfx-volume"),ai=document.getElementById("settings-audio-sfx-enabled"),ri=document.getElementById("settings-audio-sfx-value"),ot=document.getElementById("settings-audio-voice-volume"),li=document.getElementById("settings-audio-voice-enabled"),ci=document.getElementById("settings-audio-voice-value"),nt=document.getElementById("settings-audio-ui-volume"),di=document.getElementById("settings-audio-ui-enabled"),hi=document.getElementById("settings-audio-ui-value"),Ae=document.getElementById("pause-menu"),so=document.getElementById("btn-resume"),oo=document.getElementById("btn-quit"),Ct=document.getElementById("setting-sensitivity"),Vi=document.getElementById("sensitivity-value"),It=document.getElementById("setting-fps"),De=document.getElementById("audio-master-volume"),Et=document.getElementById("audio-master-enabled"),Mt=document.getElementById("audio-master-value"),Re=document.getElementById("audio-music-volume"),At=document.getElementById("audio-music-enabled"),Tt=document.getElementById("audio-music-value"),Be=document.getElementById("audio-sfx-volume"),Lt=document.getElementById("audio-sfx-enabled"),Dt=document.getElementById("audio-sfx-value"),_e=document.getElementById("audio-voice-volume"),Rt=document.getElementById("audio-voice-enabled"),Bt=document.getElementById("audio-voice-value"),$e=document.getElementById("audio-ui-volume"),_t=document.getElementById("audio-ui-enabled"),$t=document.getElementById("audio-ui-value"),xi=document.getElementById("help-panel");let ui=!1,Te=null;const he=document.getElementById("buy-menu"),no=document.getElementById("buy-credits"),Ui=he.querySelectorAll(".weapon-item");let Ue=null;const be=document.getElementById("round-over-panel"),ne=document.getElementById("winner-text"),qt=document.getElementById("match-info"),ao=document.getElementById("score-attackers"),ro=document.getElementById("score-defenders"),ft=document.getElementById("btn-play-again"),mi=document.getElementById("btn-main-menu"),Bi=document.getElementById("countdown-display"),mt=document.getElementById("countdown-text"),qe=document.getElementById("btn-pause-countdown"),ji=document.getElementById("room-code-display"),lo=document.getElementById("room-code-text"),Je=document.getElementById("btn-copy-code"),Vt=document.getElementById("lobby-screen"),Ze=document.getElementById("lobby-room-code"),co=document.getElementById("host-settings"),zt=document.getElementById("lobby-player-count"),ho=document.getElementById("lobby-round-count"),uo=document.getElementById("lobby-current-players"),Xi=document.getElementById("lobby-max-players"),_i=document.getElementById("lobby-player-list"),we=document.getElementById("lobby-waiting-text"),gt=document.getElementById("lobby-countdown"),mo=document.getElementById("btn-leave-lobby"),Zt=document.getElementById("btn-copy-lobby-code"),Si=document.getElementById("btn-start-game"),Nt=document.getElementById("lobby-make-public"),po=document.getElementById("btn-find-match"),Ki=document.getElementById("lobby-browser-modal"),fo=document.getElementById("btn-lobby-browser-close"),pi=document.getElementById("btn-refresh-lobbies"),$i=document.getElementById("lobby-list"),Qt=document.getElementById("lobby-empty");let v=null;const go={vanta:{ability1:"Energy Shield",ability2:"Shockwave Slam"},spectre:{ability1:"Cloak",ability2:"Reveal Pulse"},katana:{ability1:"Blink",ability2:"Invisibility"},byte:{ability1:"EMP Pulse",ability2:"Shock Trap"},glyph:{ability1:"Poison Cloud",ability2:"Turret Deploy"},spark:{ability1:"Fire Bottle",ability2:"Minigun Mode"},zero:{ability1:"Mark Target",ability2:"Dash Back"},mira:{ability1:"Heal Field",ability2:"Shield Burst"}};let E={enemyBotCount:3,friendlyBotCount:0,botDifficulty:"medium",gameMode:"deathmatch",mapId:"neon_arena",playerHero:"vanta",abilityQSlot:1,abilityFSlot:2,totalRounds:5,aiMode:"rule_based"};function Ji(l){const e=de.value;de.innerHTML="";const t=bi.filter(o=>l==="spike"?o.hasSpikeSites:!o.hasSpikeSites);for(const o of t){const s=document.createElement("option");s.value=o.id,s.textContent=`${o.name} - ${o.description}`,de.appendChild(s)}t.map(o=>o.id).includes(e)?de.value=e:t.length>0&&(de.value=t[0].id),vi()}function vi(){const l=de.value,e=bi.find(t=>t.id===l);if(e){const t=at.value;t==="spike"&&!e.hasSpikeSites?(ke.textContent=" This map has no spike sites!",ke.style.color="#ff6b6b"):t==="deathmatch"&&e.hasSpikeSites?(ke.textContent=" Spike sites available but unused in Deathmatch",ke.style.color="#4ecdc4"):(ke.textContent=` ${e.description}`,ke.style.color="#2ecc71")}else ke.textContent=""}function yt(){const l=Ht.value,e=go[l]||{ability1:"Ability 1",ability2:"Ability 2"},t=parseInt(Ot.value),i=parseInt(Yt.value);Qs.textContent=t===1?e.ability1:e.ability2,eo.textContent=i===1?e.ability1:e.ability2}function zi(l){return!l||l==="XX"?"":l.toUpperCase().replace(/./g,e=>String.fromCodePoint(127397+e.charCodeAt(0)))}function ei(l){return l>=1e6?(l/1e6).toFixed(1)+"M":l>=1e3?(l/1e3).toFixed(1)+"K":l.toString()}async function yo(){await Me.initialize();const l=document.getElementById("stats-total-players"),e=document.getElementById("stats-total-games"),t=document.getElementById("stats-total-hours"),i=document.getElementById("stats-my-stats"),o=document.getElementById("stats-countries"),s=document.getElementById("stats-leaderboard");try{const n=await Me.getGlobalStats();if(n&&(l&&(l.textContent=ei(n.totalUniquePlayers||0)),e&&(e.textContent=ei(n.totalGamesPlayed||0)),t&&(t.textContent=ei(Math.floor(n.totalPlayTimeHours||0))),o&&n.playersByCountry)){const a=Object.entries(n.playersByCountry).sort((r,c)=>c[1]-r[1]).slice(0,8);a.length===0?o.innerHTML='<span class="stats-loading">No country data yet</span>':o.innerHTML=a.map(([r,c])=>`
              <span class="country-tag">
                ${zi(r)} ${r}
                <span class="count">${c}</span>
              </span>
            `).join("")}}catch(n){console.warn("[Stats] Failed to load global stats:",n)}try{const n=await Me.getMyStats();if(i)if(n){const a=n.gamesPlayed>0?Math.round(n.gamesWon/n.gamesPlayed*100):0,r=n.totalDeaths>0?(n.totalKills/n.totalDeaths).toFixed(2):n.totalKills.toString();i.innerHTML=`
          <div class="my-stat">
            <span class="my-stat-label">Games Played</span>
            <span class="my-stat-value">${n.gamesPlayed}</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">Wins</span>
            <span class="my-stat-value">${n.gamesWon} (${a}%)</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">Total Kills</span>
            <span class="my-stat-value">${n.totalKills}</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">K/D Ratio</span>
            <span class="my-stat-value">${r}</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">Play Time</span>
            <span class="my-stat-value">${Math.floor(n.totalPlayTimeSeconds/60)} min</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">Country</span>
            <span class="my-stat-value">${zi(n.country)} ${n.countryName||"Unknown"}</span>
          </div>
        `}else i.innerHTML='<div class="stats-loading">Play a game to see your stats!</div>'}catch(n){console.warn("[Stats] Failed to load my stats:",n),i&&(i.innerHTML='<div class="stats-loading">Play a game to see your stats!</div>')}try{const n=await wo();s&&(n.length===0?s.innerHTML='<li class="stats-loading">No players yet</li>':s.innerHTML=n.map((a,r)=>{const c=a.gamesPlayed>0?Math.round(a.gamesWon/a.gamesPlayed*100):0;return`
              <li>
                <span class="rank">#${r+1}</span>
                <span class="name">${a.callsign||"Unknown"}</span>
                <span class="wins">${a.gamesWon||0} wins (${c}%)</span>
              </li>
            `}).join(""))}catch(n){console.warn("[Stats] Failed to load leaderboard:",n),s&&(s.innerHTML='<li class="stats-loading">Failed to load</li>')}}async function wo(){try{const{getFirestore:l,collection:e,query:t,orderBy:i,limit:o,getDocs:s}=await Se(async()=>{const{getFirestore:u,collection:p,query:w,orderBy:x,limit:S,getDocs:k}=await import("./index.esm-DbUeHnob.js");return{getFirestore:u,collection:p,query:w,orderBy:x,limit:S,getDocs:k}},__vite__mapDeps([2,1]),import.meta.url),{initializeApp:n,getApps:a,getApp:r}=await Se(async()=>{const{initializeApp:u,getApps:p,getApp:w}=await import("./index.esm-OOYOW6k3.js");return{initializeApp:u,getApps:p,getApp:w}},__vite__mapDeps([0,1]),import.meta.url),c=a().length===0?n(ie):r(),d=l(c),h=t(e(d,"playerStats"),i("gamesWon","desc"),o(5));return(await s(h)).docs.map(u=>u.data())}catch(l){return console.warn("[Stats] Failed to query leaderboard:",l),[]}}let Le=null;async function bo(){if(console.log("[LobbyBrowser] Opening lobby browser..."),!se.value.trim()){console.log("[LobbyBrowser] No player name entered"),se.focus(),se.style.borderColor="#ff4444",setTimeout(()=>{se.style.borderColor=""},2e3);return}Ki.classList.remove("hidden"),pe.classList.add("hidden");try{Le&&(Le(),Le=null),console.log("[LobbyBrowser] Initializing service..."),await re.initialize(),console.log("[LobbyBrowser] Cleaning stale lobbies..."),await re.cleanupStaleLobbies(),console.log("[LobbyBrowser] Subscribing to lobbies..."),Le=re.subscribeToLobbies(e=>{console.log("[LobbyBrowser] Real-time update:",e.length,"lobbies"),Zi(e)}),console.log("[LobbyBrowser] Lobby browser ready")}catch(e){console.error("[LobbyBrowser] Error opening lobby browser:",e)}}function qi(){Ki.classList.add("hidden"),pe.classList.remove("hidden"),Le&&(Le(),Le=null)}async function xo(){pi.classList.add("spinning");try{const l=await re.getPublicLobbies();Zi(l)}catch(l){console.error("[LobbyBrowser] Failed to refresh lobbies:",l)}setTimeout(()=>{pi.classList.remove("spinning")},500)}function Zi(l){if($i.querySelectorAll(".lobby-item").forEach(t=>t.remove()),l.length===0){Qt.style.display="block";return}Qt.style.display="none";for(const t of l){const i=document.createElement("div");i.className="lobby-item";const o=t.gameMode==="spike"?" Spike":" Deathmatch",n=bi.find(r=>r.id===t.mapId)?.name||t.mapId;i.innerHTML=`
      <div class="lobby-info">
        <div class="lobby-host">${So(t.hostName)}</div>
        <div class="lobby-details">
          <span>${o}</span>
          <span> ${n}</span>
        </div>
      </div>
      <span class="lobby-players">${t.currentPlayers}/${t.maxPlayers}</span>
      <button class="join-btn" data-room-code="${t.roomCode}">Join</button>
    `,i.querySelector(".join-btn").addEventListener("click",()=>{vo(t.roomCode)}),$i.insertBefore(i,Qt)}}function So(l){const e=document.createElement("div");return e.textContent=l,e.innerHTML}async function vo(l){qi(),oe.value=l,await is()}function Ni(){const l=localStorage.getItem("cybergrid_settings");if(l)try{const e=JSON.parse(l);E={...E,...e},E.abilityQSlot!==1&&E.abilityQSlot!==2&&(E.abilityQSlot=1),E.abilityFSlot!==1&&E.abilityFSlot!==2&&(E.abilityFSlot=2),E.abilityQSlot===E.abilityFSlot&&(E.abilityQSlot=1,E.abilityFSlot=2),console.log("[Settings] Loaded:",E)}catch(e){console.warn("Failed to load settings:",e)}kt.value=String(E.enemyBotCount),Gi.textContent=String(E.enemyBotCount),Pt.value=String(E.friendlyBotCount),Oi.textContent=String(E.friendlyBotCount),Hi.value=E.botDifficulty,Yi.value=E.aiMode||"rule_based",at.value=E.gameMode,Ji(E.gameMode),E.mapId&&(de.value=E.mapId),Ht.value=E.playerHero,Ot.value=String(E.abilityQSlot),Yt.value=String(E.abilityFSlot),yt(),vi()}function ko(){E={enemyBotCount:parseInt(kt.value),friendlyBotCount:parseInt(Pt.value),botDifficulty:Hi.value,gameMode:at.value,mapId:de.value,playerHero:Ht.value,abilityQSlot:parseInt(Ot.value),abilityFSlot:parseInt(Yt.value),totalRounds:E.totalRounds,aiMode:Yi.value},localStorage.setItem("cybergrid_settings",JSON.stringify(E)),Ie.classList.add("hidden")}let xe={volume:100,sensitivity:1,showFps:!0},C={masterVolume:80,masterEnabled:!0,musicVolume:50,musicEnabled:!0,sfxVolume:80,sfxEnabled:!0,voiceVolume:100,voiceEnabled:!0,uiVolume:70,uiEnabled:!0};function Po(){const l=localStorage.getItem("cybergrid_audio");if(l)try{C={...C,...JSON.parse(l)}}catch(i){console.warn("Failed to load audio settings:",i)}Co();const e=C.masterVolume/100,t=C.uiVolume/100;ce.setVolume(e*t),ce.setEnabled(C.masterEnabled&&C.uiEnabled)}function Fi(){localStorage.setItem("cybergrid_audio",JSON.stringify(C))}function Co(){De.value=String(C.masterVolume),Et.checked=C.masterEnabled,Mt.textContent=`${C.masterVolume}%`,De.disabled=!C.masterEnabled,Re.value=String(C.musicVolume),At.checked=C.musicEnabled,Tt.textContent=`${C.musicVolume}%`,Re.disabled=!C.musicEnabled,Be.value=String(C.sfxVolume),Lt.checked=C.sfxEnabled,Dt.textContent=`${C.sfxVolume}%`,Be.disabled=!C.sfxEnabled,_e.value=String(C.voiceVolume),Rt.checked=C.voiceEnabled,Bt.textContent=`${C.voiceVolume}%`,_e.disabled=!C.voiceEnabled,$e.value=String(C.uiVolume),_t.checked=C.uiEnabled,$t.textContent=`${C.uiVolume}%`,$e.disabled=!C.uiEnabled,tt.value=String(C.masterVolume),ii.checked=C.masterEnabled,si.textContent=`${C.masterVolume}%`,tt.disabled=!C.masterEnabled,it.value=String(C.musicVolume),oi.checked=C.musicEnabled,ni.textContent=`${C.musicVolume}%`,it.disabled=!C.musicEnabled,st.value=String(C.sfxVolume),ai.checked=C.sfxEnabled,ri.textContent=`${C.sfxVolume}%`,st.disabled=!C.sfxEnabled,ot.value=String(C.voiceVolume),li.checked=C.voiceEnabled,ci.textContent=`${C.voiceVolume}%`,ot.disabled=!C.voiceEnabled,nt.value=String(C.uiVolume),di.checked=C.uiEnabled,hi.textContent=`${C.uiVolume}%`,nt.disabled=!C.uiEnabled}function Io(){const l=localStorage.getItem("cybergrid_gameplay");if(l)try{xe={...xe,...JSON.parse(l)}}catch(e){console.warn("Failed to load gameplay settings:",e)}Mo()}function Eo(){xe={volume:100,sensitivity:parseFloat(Ct.value)/10,showFps:It.checked},localStorage.setItem("cybergrid_gameplay",JSON.stringify(xe))}function Mo(){if(Ct.value=String(Math.round(xe.sensitivity*10)),Vi.textContent=xe.sensitivity.toFixed(1),It.checked=xe.showFps,v){const l=v.getAudioSettings();l&&(De.value=String(l.masterVolume),Et.checked=l.masterEnabled,Mt.textContent=`${l.masterVolume}%`,De.disabled=!l.masterEnabled,Re.value=String(l.musicVolume),At.checked=l.musicEnabled,Tt.textContent=`${l.musicVolume}%`,Re.disabled=!l.musicEnabled,Be.value=String(l.sfxVolume),Lt.checked=l.sfxEnabled,Dt.textContent=`${l.sfxVolume}%`,Be.disabled=!l.sfxEnabled,_e.value=String(l.voiceVolume),Rt.checked=l.voiceEnabled,Bt.textContent=`${l.voiceVolume}%`,_e.disabled=!l.voiceEnabled,$e.value=String(l.uiVolume),_t.checked=l.uiEnabled,$t.textContent=`${l.uiVolume}%`,$e.disabled=!l.uiEnabled)}}const Ao={burst_pistol:0,neo_smg9:1100,pulse_rifle:1500,scatter_shot:1400,rail_sniper:2100,shard_launcher:600,nano_repeater:900,arc_welder:1300,phase_repeater:1800,plasma_cannon:2800};function To(l=!1){ui=!0,xi.classList.add("visible"),Te!==null&&(clearTimeout(Te),Te=null),l&&(Te=window.setTimeout(()=>{Lo()},5e3))}function Lo(){ui&&(ui=!1,xi.classList.remove("visible"),Te!==null&&(clearTimeout(Te),Te=null))}function Do(){if(!v)return;const l=v.getWorld().getLocalPlayer();!l||!l.alive||(Qi(),he.classList.remove("hidden"),ki())}function Ft(){he.classList.add("hidden"),Ue!==null&&(clearTimeout(Ue),Ue=null)}function ki(){Ue!==null&&clearTimeout(Ue),Ue=window.setTimeout(()=>{Ft()},3e3)}function Qi(){if(!v)return;const l=v.getWorld().getLocalPlayer();l&&(no.textContent=String(l.credits),Ui.forEach(e=>{const t=e.dataset.weapon||"",i=e.dataset.slot||"1",o=parseInt(i)-1,s=Ao[t]||0,n=l.weaponInventory[o]!==null,a=l.credits>=s;if(e.classList.remove("owned","cant-afford"),n){e.classList.add("owned");const r=e.querySelector(".weapon-price");r&&(r.textContent="OWNED")}else!a&&s>0&&e.classList.add("cant-afford")}))}function Ro(l){if(!v)return;const e=v.getWorld().getLocalPlayer();if(!e||!e.alive)return;const i={burst_pistol:"burst_pistol",neo_smg9:"neo_smg9",pulse_rifle:"pulse_rifle",scatter_shot:"scatter_shot",rail_sniper:"rail_sniper",shard_launcher:"shard_launcher",nano_repeater:"nano_repeater",arc_welder:"arc_welder",phase_repeater:"phase_repeater",plasma_cannon:"plasma_cannon"}[l];if(!i)return;const o=e.getWeaponSlotForId(i)-1;if(e.weaponInventory[o]!==null){e.switchToWeaponSlot(o+1),Ft();return}e.buyWeapon(i)&&Qi(),ki()}function Bo(){v&&(v.pause(),Ae.classList.remove("hidden"))}function Wi(){v&&(Ae.classList.add("hidden"),Eo(),v.resume())}function fi(){v&&(v.endStatsSession(),Vo(),v.stop(),v=null,ue=!1,es(),Pi(),Ve.classList.add("hidden"),Ae.classList.add("hidden"),be.classList.add("hidden"),ji.classList.add("hidden"),Vt.classList.add("hidden"),xi.classList.remove("visible"),he.classList.add("hidden"),pe.classList.remove("hidden"),Gt.classList.remove("hidden"),je.classList.remove("hidden"),Xe.classList.remove("hidden"),oe.classList.add("hidden"),lt.classList.add("hidden"),oe.value="",b.isHost=!1,b.players=[],b.roomCode="",b.isPublic=!1,ue=!1,z&&(z.disconnect(),z=null))}const b={isHost:!1,roomCode:"",players:[],maxPlayers:2,countdownActive:!1,countdownValue:5,isPublic:!1};let wt=null;function _o(){const l="ABCDEFGHJKLMNPQRSTUVWXYZ",e="0123456789";let t="";for(let i=0;i<4;i++)t+=l.charAt(Math.floor(Math.random()*l.length));for(let i=0;i<2;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}function gi(l,e,t){ue=!1,b.isHost=l,b.roomCode=e,b.maxPlayers=parseInt(zt.value),b.countdownActive=!1,b.isPublic=l?Nt.checked:!1,b.players=[{id:"local",name:t,isHost:l}],Ze.textContent=e,Xi.textContent=String(b.maxPlayers),co.style.display=l?"block":"none",Si.style.display=l?"block":"none",l?we.innerHTML='Waiting for players<span class="dots">...</span>':we.innerHTML='Connecting to host<span class="dots">...</span>',pe.classList.add("hidden"),Ie.classList.add("hidden"),Gt.classList.add("hidden"),Vt.classList.remove("hidden"),l&&(Nt.checked=b.isPublic,console.log("[Lobby] isHost:",l,"isPublic:",b.isPublic)),ze()}function ze(){uo.textContent=String(b.players.length),Xi.textContent=String(b.maxPlayers),_i.innerHTML="";for(const l of b.players){const e=document.createElement("div");e.className=`player-item${l.isHost?" host":""}`,e.innerHTML=`
      <span class="name">${l.name}</span>
      ${l.isHost?'<span class="tag">Host</span>':""}
    `,_i.appendChild(e)}if(b.isHost){const l=b.players.length>=b.maxPlayers||b.maxPlayers===1;Si.disabled=!l,l&&!b.countdownActive?we.textContent="All players ready!":b.countdownActive||(we.innerHTML='Waiting for players<span class="dots">...</span>'),b.isPublic&&re.updateLobbyPlayerCount(b.roomCode,b.players.length)}else b.players.some(e=>e.isHost&&e.id!=="local")?we.innerHTML='Waiting for host to start<span class="dots">...</span>':we.innerHTML='Connecting to host<span class="dots">...</span>';b.players.length>=b.maxPlayers&&!b.countdownActive&&b.maxPlayers>1&&$o()}function $o(){b.countdownActive||(b.countdownActive=!0,b.countdownValue=5,we.classList.add("hidden"),gt.classList.remove("hidden"),gt.textContent=String(b.countdownValue),wt=window.setInterval(()=>{b.countdownValue--,gt.textContent=String(b.countdownValue),b.countdownValue<=0&&(Pi(),Ci())},1e3))}function Pi(){wt!==null&&(clearInterval(wt),wt=null),b.countdownActive=!1,gt.classList.add("hidden"),we.classList.remove("hidden")}let ue=!1;function zo(){Pi(),Vt.classList.add("hidden"),pe.classList.remove("hidden"),Gt.classList.remove("hidden"),b.isHost&&b.isPublic&&re.removeLobby(b.roomCode),je.classList.remove("hidden"),Xe.classList.remove("hidden"),oe.classList.add("hidden"),lt.classList.add("hidden"),oe.value="",b.isHost=!1,b.players=[],b.roomCode="",b.isPublic=!1,ue=!1,z&&(z.disconnect(),z=null)}async function Ci(){if(ue){console.log("[Main] startGameFromLobby already called, ignoring");return}ue=!0;const l=se.value.trim()||"Player";Vt.classList.add("hidden"),b.isHost&&b.isPublic&&re.removeLobby(b.roomCode),E.totalRounds=parseInt(ho.value);const e=z;z=null,e&&(e.removeAllListeners(),console.log("[Main] Removed lobby listeners from network")),b.isHost&&e&&(console.log("[Main] Broadcasting GameStart to all peers"),e.broadcast({type:_.GameStart,timestamp:Date.now(),senderId:e.getLocalPeerId(),data:{roomCode:b.roomCode,totalRounds:E.totalRounds,mapId:E.mapId,gameMode:E.gameMode}})),console.log("[Main] lobbyState.players RAW:",JSON.stringify(b.players));const t=b.players.map(i=>({id:i.id,name:i.name,isHost:i.isHost}));if(console.log(`[Main] Passing ${t.length} lobby players to game:`,JSON.stringify(t)),console.log(`[Main] networkToPass exists: ${!!e}, peers: ${e?.getPeerIds().length||0}`),e?(console.log(`[Main] Creating Game with EXISTING network (${e.getPeerIds().length} peers)`),v=new Di({canvas:Ve,playerName:l,settings:E,network:e,lobbyPlayers:t,appVersion:"0.5.2-beta"})):(console.log("[Main] Creating Game WITHOUT network (will create new)"),v=new Di({canvas:Ve,playerName:l,settings:E,lobbyPlayers:t,appVersion:"0.5.2-beta"})),await v.init(),v.setShowFPS(xe.showFps),v.updateAudioSettings(C),b.isHost){const i=await v.hostGame(b.roomCode);console.log(`[Main] Starting game as HOST: ${i} (Best of ${E.totalRounds})`)}else await v.joinGame(b.roomCode),console.log(`[Main] Joined game: ${b.roomCode}`);ji.classList.add("hidden"),Ve.classList.remove("hidden"),v.start(),v.startStatsSession(),v.trackMatchStart(),To(!0),Wo(),Yo()}let bt=null,Ee=!1,xt=null,yi=Date.now();function No(l,e,t,i,o,s=!1,n=""){const a=be.querySelector("h2");qt.textContent=`First to ${o} wins`,i?(s?(a&&(a.textContent=" Player Disconnected"),ne.textContent=`${n} has left the match`,ne.className="winner-text",qt.textContent="Opponent forfeited - You Win!"):l==="attackers"?(a&&(a.textContent=" Match Over!"),ne.textContent=" ATTACKERS WIN THE MATCH!",ne.className="winner-text attackers"):(a&&(a.textContent=" Match Over!"),ne.textContent=" DEFENDERS WIN THE MATCH!",ne.className="winner-text defenders"),s||(qt.textContent="Match Complete!"),ft.classList.remove("hidden"),ft.textContent="Play Again",mi.classList.remove("hidden"),Bi.classList.add("hidden"),v&&v.recordMatchResult(),Go()):(a&&(a.textContent=" Round Over"),l==="attackers"?(ne.textContent=" Attackers Win Round!",ne.className="winner-text attackers"):(ne.textContent=" Defenders Win Round!",ne.className="winner-text defenders"),Bi.classList.remove("hidden"),ft.classList.add("hidden"),mi.classList.add("hidden")),ao.textContent=String(e),ro.textContent=String(t),be.classList.remove("hidden"),Ee=!0}function Fo(){if(!v)return;const l=v.getCountdownInfo();if(!l)return;const e=Math.ceil(l.countdownTime/1e3);l.isPaused?(mt.textContent=`PAUSED by ${l.pausedBy}`,mt.classList.add("paused"),qe.textContent=" Resume",qe.classList.add("paused")):(mt.textContent=`Next round in ${e}s`,mt.classList.remove("paused"),qe.textContent=" Pause",qe.classList.remove("paused"))}function Wo(){Ee=!1,bt=window.setInterval(()=>{if(!v){es();return}const l=v.getRoundEndInfo();l&&!Ee&&No(l.winningTeam,l.attackerScore,l.defenderScore,l.isMatchOver,l.roundsToWin,l.isForfeit,l.forfeitPlayerName),Ee&&l&&!l.isMatchOver&&Fo(),Ee&&v.isRoundActive()&&(be.classList.add("hidden"),Ee=!1)},100)}function es(){bt!==null&&(clearInterval(bt),bt=null),rt()}function Go(){rt(),yi=Date.now(),xt=window.setInterval(()=>{Date.now()-yi>=6e4&&(console.log("[Main] 60 seconds idle - returning to menu"),rt(),fi())},1e3)}function rt(){xt!==null&&(clearInterval(xt),xt=null)}function Qe(){yi=Date.now()}function Ho(){if(!v)return;Qe(),rt(),v.getRoundEndInfo()?.isMatchOver&&(be.classList.add("hidden"),Ee=!1,v.restartGame())}function Oo(){v&&v.toggleCountdownPause()}function Yo(){const l=ye.getInstance();if(l.initialize(),X&&(X.classList.add("show"),ts(!1)),v){const e=v.getWorld().getLocalPlayer();if(e){const t=v.getWorld().getPlayers();if(t.length===2){const o=t.filter(s=>s.id!==e.id).map(s=>s.peerId);l.setAllowedPeers(o)}else{const o=t.filter(s=>s.team===e.team&&s.id!==e.id).map(s=>s.peerId);l.setAllowedPeers(o)}}}}function Vo(){ye.getInstance().cleanup(),X&&X.classList.remove("show")}function ts(l){X&&(l?(X.classList.add("active"),X.classList.remove("muted"),X.innerHTML="",X.title="Microphone ON (click to mute)"):(X.classList.remove("active"),X.classList.add("muted"),X.innerHTML="",X.title="Microphone OFF (click to enable)"))}async function Uo(){Ve.width=1280,Ve.height=720,Ri&&(Ri.textContent="v0.5.2-beta");const l=localStorage.getItem("cybergrid_playerName");l&&(se.value=l),Ni(),je.addEventListener("click",jo),Xe.addEventListener("click",Xo),js.addEventListener("click",is),Xs.addEventListener("click",Ko),se.addEventListener("input",()=>{localStorage.setItem("cybergrid_playerName",se.value)}),Gt.addEventListener("click",()=>{Ie.classList.toggle("hidden"),Ie.classList.contains("hidden")||ae.trackUIOpen("settings")}),io.addEventListener("click",()=>{Ni(),Ie.classList.add("hidden")}),to.addEventListener("click",ko),Ks.addEventListener("click",()=>{Kt.classList.toggle("hidden"),Kt.classList.contains("hidden")||ae.trackUIOpen("how_to_play")}),Js.addEventListener("click",()=>{Kt.classList.add("hidden")}),qs.addEventListener("click",()=>{Jt.classList.toggle("hidden"),Jt.classList.contains("hidden")||yo()}),Zs.addEventListener("click",()=>{Jt.classList.add("hidden")}),X.addEventListener("click",async()=>{ce.playClick();const n=await ye.getInstance().toggleMicrophone();ts(n)}),X.addEventListener("mouseenter",()=>{ce.playHover()}),po.addEventListener("click",()=>{bo()}),fo.addEventListener("click",()=>{qi()}),pi.addEventListener("click",()=>{xo()}),Nt.addEventListener("change",async()=>{if(!b.isHost)return;b.isPublic=Nt.checked;const s=se.value.trim()||"Player";if(b.isPublic){console.log("[Lobby] Making lobby public...");try{await re.initialize(),await re.createPublicLobby({roomCode:b.roomCode,hostId:"local",hostName:s,gameMode:E.gameMode,mapId:E.mapId,maxPlayers:b.maxPlayers}),console.log("[Lobby] Lobby is now public")}catch(n){console.error("[Lobby] Failed to make lobby public:",n)}}else{console.log("[Lobby] Making lobby private...");try{await re.removeLobby(b.roomCode),console.log("[Lobby] Lobby is now private")}catch(n){console.error("[Lobby] Failed to make lobby private:",n)}}}),kt.addEventListener("input",()=>{Gi.textContent=kt.value}),Pt.addEventListener("input",()=>{Oi.textContent=Pt.value}),at.addEventListener("change",()=>{Ji(at.value)}),de.addEventListener("change",vi),Ht.addEventListener("change",yt),Ot.addEventListener("change",yt),Yt.addEventListener("change",yt),so.addEventListener("click",Wi),oo.addEventListener("click",fi),ft.addEventListener("click",Ho),mi.addEventListener("click",()=>{Qe(),rt(),fi()}),qe.addEventListener("click",Oo),be.addEventListener("mousemove",Qe),be.addEventListener("keydown",Qe),be.addEventListener("click",Qe),Je.addEventListener("click",()=>{const s=lo.textContent||"";navigator.clipboard.writeText(s).then(()=>{Je.textContent="Copied!",Je.classList.add("copied"),setTimeout(()=>{Je.textContent="Copy",Je.classList.remove("copied")},2e3)}).catch(()=>{alert(`Room Code: ${s}`)})}),mo.addEventListener("click",zo),Si.addEventListener("click",()=>{b.isHost&&Ci()});const e=()=>{const s=Ze.textContent||"";navigator.clipboard.writeText(s).then(()=>{Ze.classList.add("copied"),Zt.textContent=" Copied!",setTimeout(()=>{Ze.classList.remove("copied"),Zt.textContent=" Copy Code"},1500)}).catch(()=>{alert(`Room Code: ${s}`)})};Zt.addEventListener("click",e),Ze.addEventListener("click",e),zt.addEventListener("change",()=>{b.maxPlayers=parseInt(zt.value),ze()});const t=(s,n,a,r,c=!1)=>{s.addEventListener("input",()=>{const d=parseInt(s.value);if(a.textContent=`${d}%`,C[r]=d,Fi(),c?(r==="masterVolume"&&(De.value=s.value,Mt.textContent=`${d}%`),r==="musicVolume"&&(Re.value=s.value,Tt.textContent=`${d}%`),r==="sfxVolume"&&(Be.value=s.value,Dt.textContent=`${d}%`),r==="voiceVolume"&&(_e.value=s.value,Bt.textContent=`${d}%`),r==="uiVolume"&&($e.value=s.value,$t.textContent=`${d}%`)):(r==="masterVolume"&&(tt.value=s.value,si.textContent=`${d}%`),r==="musicVolume"&&(it.value=s.value,ni.textContent=`${d}%`),r==="sfxVolume"&&(st.value=s.value,ri.textContent=`${d}%`),r==="voiceVolume"&&(ot.value=s.value,ci.textContent=`${d}%`),r==="uiVolume"&&(nt.value=s.value,hi.textContent=`${d}%`)),v&&v.updateAudioSettings({[r]:d}),r==="uiVolume"||r==="masterVolume"){const h=C.masterVolume/100,m=C.uiVolume/100;ce.setVolume(h*m)}}),n.addEventListener("change",()=>{const d=n.checked;s.disabled=!d;const h=r.replace("Volume","Enabled");C[h]=d,Fi(),c?(r==="masterVolume"&&(Et.checked=d,De.disabled=!d),r==="musicVolume"&&(At.checked=d,Re.disabled=!d),r==="sfxVolume"&&(Lt.checked=d,Be.disabled=!d),r==="voiceVolume"&&(Rt.checked=d,_e.disabled=!d),r==="uiVolume"&&(_t.checked=d,$e.disabled=!d)):(r==="masterVolume"&&(ii.checked=d,tt.disabled=!d),r==="musicVolume"&&(oi.checked=d,it.disabled=!d),r==="sfxVolume"&&(ai.checked=d,st.disabled=!d),r==="voiceVolume"&&(li.checked=d,ot.disabled=!d),r==="uiVolume"&&(di.checked=d,nt.disabled=!d)),v&&v.updateAudioSettings({[h]:d}),(r==="uiVolume"||r==="masterVolume")&&ce.setEnabled(C.masterEnabled&&C.uiEnabled)})};t(De,Et,Mt,"masterVolume"),t(Re,At,Tt,"musicVolume"),t(Be,Lt,Dt,"sfxVolume"),t(_e,Rt,Bt,"voiceVolume"),t($e,_t,$t,"uiVolume"),t(tt,ii,si,"masterVolume",!0),t(it,oi,ni,"musicVolume",!0),t(st,ai,ri,"sfxVolume",!0),t(ot,li,ci,"voiceVolume",!0),t(nt,di,hi,"uiVolume",!0),Ct.addEventListener("input",()=>{Vi.textContent=(parseFloat(Ct.value)/10).toFixed(1)}),It.addEventListener("change",()=>{v&&v.setShowFPS(It.checked)}),Io(),Po(),window.addEventListener("keydown",s=>{if(s.code==="Escape"){if(!Ie.classList.contains("hidden")){Ie.classList.add("hidden");return}if(!he.classList.contains("hidden")){Ft();return}v&&(Ae.classList.contains("hidden")?Bo():Wi())}s.code==="KeyB"&&v&&Ae.classList.contains("hidden")&&(he.classList.contains("hidden")?Ae.classList.contains("hidden")&&Do():Ft()),s.code==="KeyH"&&v&&Ae.classList.contains("hidden")&&he.classList.contains("hidden")&&v.showHeroInfo(),s.code==="KeyP"&&v&&v.toggleCountdownPause()}),document.addEventListener("visibilitychange",()=>{!v||!ue||(document.hidden?v.onTabBlur():v.onTabFocus())}),window.addEventListener("blur",()=>{!v||!ue||v.onTabBlur()}),window.addEventListener("focus",()=>{!v||!ue||v.onTabFocus()});const i=()=>{if(v)try{v.saveStatsOnUnload()}catch(s){console.warn("[Main] Failed to save stats on unload:",s)}};window.addEventListener("beforeunload",i),window.addEventListener("pagehide",i),Ui.forEach(s=>{s.addEventListener("click",()=>{const n=s.dataset.weapon;n&&v&&Ro(n)})}),he.addEventListener("mousemove",()=>{he.classList.contains("hidden")||ki()}),(()=>{document.querySelectorAll("button, .btn, .lobby-player-count-option, .weapon-item").forEach(n=>{n.addEventListener("mouseenter",()=>ce.playHover()),n.addEventListener("mousedown",()=>ce.playClick())})})(),console.log("[Main] CyberGrid Assault initialized"),console.log("[Main] Press HOST to start a local game")}async function jo(){const l=se.value.trim()||"Player";ae.trackGameStart("host",l);const e=_o();if(parseInt(zt.value)===1){gi(!0,e,l);return}pe.classList.add("hidden");try{z=new He({isHost:!0,useFirestore:!0}),await z.connectWithFirebase(ie),z.on("peerConnected",({peerId:o})=>{console.log(`[Lobby] Peer connected (WebRTC ready): ${o}`),b.players.push({id:o,name:"Connecting...",isHost:!1}),ze()}),z.on("peerDisconnected",({peerId:o})=>{console.log(`[Lobby Host] Peer disconnected: ${o}`),console.log("[Lobby Host] Players BEFORE filter:",JSON.stringify(b.players)),b.players=b.players.filter(s=>s.id!==o),console.log("[Lobby Host] Players AFTER filter:",JSON.stringify(b.players)),ze()}),z.on("packet",({peerId:o,packet:s})=>{if(console.log(`[Lobby Host] Received packet from ${o}:`,s.type),s.type===_.PlayerJoin){const n=s.data;console.log(`[Lobby Host] Player ${o} name: ${n.name}`);const a=b.players.find(r=>r.id===o);a&&(a.name=n.name,ze())}}),await z.createRoom();const i=z.getRoomCode();console.log(`[Main] Room created in Firebase: ${i}`),gi(!0,i,l)}catch(i){console.error("[Main] Failed to create room:",i),alert("Failed to create game room. Check console for details."),pe.classList.remove("hidden"),z=null}}function Xo(){je.classList.add("hidden"),Xe.classList.add("hidden"),oe.classList.remove("hidden"),lt.classList.remove("hidden"),oe.focus()}function Ko(){oe.classList.add("hidden"),lt.classList.add("hidden"),oe.value="",je.classList.remove("hidden"),Xe.classList.remove("hidden")}async function is(){const l=oe.value.trim().toUpperCase();if(!l){alert("Please enter a room code");return}const e=se.value.trim()||"Player";ae.trackGameStart("join",e),pe.classList.add("hidden"),oe.classList.add("hidden"),lt.classList.add("hidden");try{z=new He({isHost:!1,useFirestore:!0}),await z.connectWithFirebase(ie),z.on("peerConnected",({peerId:t})=>{console.log(`[Lobby Joiner] Peer connected: ${t}`),b.players.push({id:t,name:"Host",isHost:!0}),ze(),console.log(`[Lobby Joiner] Sending our name to host: ${e}`),z?.broadcast({type:_.PlayerJoin,timestamp:Date.now(),senderId:z.getLocalPeerId(),data:{name:e}})}),z.on("peerDisconnected",({peerId:t})=>{console.log(`[Lobby] Peer disconnected: ${t}`),b.players=b.players.filter(i=>i.id!==t),ze()}),z.on("packet",({peerId:t,packet:i})=>{if(console.log(`[Lobby Joiner] Received packet from ${t}:`,i.type),i.type===_.GameStart){console.log("[Lobby] Host started the game!");const o=i.data;o.totalRounds&&(E.totalRounds=o.totalRounds),o.mapId&&(E.mapId=o.mapId,console.log(`[Lobby Joiner] Using host's map: ${o.mapId}`)),o.gameMode&&(E.gameMode=o.gameMode,console.log(`[Lobby Joiner] Using host's game mode: ${o.gameMode}`)),Ci()}}),await z.joinRoom(l),console.log(`[Main] Joined room in Firebase: ${l}`),gi(!1,l,e)}catch(t){console.error("[Main] Failed to join room:",t),alert("Failed to join game. Make sure the room code is correct and the host is online."),pe.classList.remove("hidden"),je.classList.remove("hidden"),Xe.classList.remove("hidden"),z=null}}const ti=document.getElementById("weapon-tooltip"),Jo={1:"Burst Pistol",2:"Neo SMG-9",3:"Pulse Rifle",4:"Scatter Shot",5:"Rail Sniper",6:"Shard Launcher",7:"Nano Repeater",8:"Arc Welder",9:"Phase Repeater",10:"Plasma Cannon"};document.addEventListener("keydown",l=>{if(!v||!v.isRunning())return;let e=0;if(l.code==="Digit1"?e=1:l.code==="Digit2"?e=2:l.code==="Digit3"?e=3:l.code==="Digit4"?e=4:l.code==="Digit5"?e=5:l.code==="Digit6"?e=6:l.code==="Digit7"?e=7:l.code==="Digit8"?e=8:l.code==="Digit9"?e=9:l.code==="Digit0"&&(e=10),e>0){const t=Jo[e];t&&(ti.textContent=t,ti.classList.add("visible"),setTimeout(()=>{ti.classList.remove("visible")},1500))}});Uo().catch(console.error);
//# sourceMappingURL=index-ChAaBCjU.js.map
