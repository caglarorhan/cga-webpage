const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index.esm-OOYOW6k3.js","./index.esm-Dm3ezxcN.js","./index.esm-DbUeHnob.js"])))=>i.map(i=>d[i]);
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();const Ni="modulepreload",Wi=function(r,e){return new URL(r,e).href},ri={},de=function(e,t,i){let o=Promise.resolve();if(t&&t.length>0){const a=document.getElementsByTagName("link"),n=document.querySelector("meta[property=csp-nonce]"),l=n?.nonce||n?.getAttribute("nonce");o=Promise.allSettled(t.map(c=>{if(c=Wi(c,i),c in ri)return;ri[c]=!0;const d=c.endsWith(".css"),h=d?'[rel="stylesheet"]':"";if(!!i)for(let g=a.length-1;g>=0;g--){const w=a[g];if(w.href===c&&(!d||w.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${h}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":Ni,d||(f.as="script"),f.crossOrigin="",f.href=c,l&&f.setAttribute("nonce",l),document.head.appendChild(f),d)return new Promise((g,w)=>{f.addEventListener("load",g),f.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(a){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=a,window.dispatchEvent(n),!n.defaultPrevented)throw a}return o.then(a=>{for(const n of a||[])n.status==="rejected"&&s(n.reason);return e().catch(s)})};class Fi{running=!1;lastTime=0;accumulator=0;frameId=0;fixedDeltaTime;maxFrameTime;onUpdate;onRender;fps=0;frameCount=0;fpsTimer=0;tickCount=0;tps=0;constructor(e,t,i){this.fixedDeltaTime=1e3/e,this.maxFrameTime=this.fixedDeltaTime*5,this.onUpdate=t,this.onRender=i}start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.accumulator=0,this.frameCount=0,this.tickCount=0,this.fpsTimer=this.lastTime,this.loop())}stop(){this.running=!1,this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=0)}loop=()=>{if(!this.running)return;const e=performance.now();let t=e-this.lastTime;for(this.lastTime=e,t>this.maxFrameTime&&(t=this.maxFrameTime),this.accumulator+=t;this.accumulator>=this.fixedDeltaTime;)this.onUpdate(this.fixedDeltaTime,e),this.accumulator-=this.fixedDeltaTime,this.tickCount++;const i=this.accumulator/this.fixedDeltaTime;this.onRender(i),this.frameCount++,e-this.fpsTimer>=1e3&&(this.fps=this.frameCount,this.tps=this.tickCount,this.frameCount=0,this.tickCount=0,this.fpsTimer=e),this.frameId=requestAnimationFrame(this.loop)};getFPS(){return this.fps}getTPS(){return this.tps}isRunning(){return this.running}getFixedDeltaTime(){return this.fixedDeltaTime}}const Hi=[{action:"reload",key:"KeyR",type:"press"},{action:"interact",key:"KeyE",type:"hold"},{action:"ability1",key:"KeyQ",type:"press"},{action:"ability2",key:"KeyF",type:"press"},{action:"ultimate",key:"KeyX",type:"press"},{action:"menu",key:"Escape",type:"press"},{action:"scoreboard",key:"Tab",type:"hold"},{action:"buyMenu",key:"KeyB",type:"press"}];class Oi{canvas;keysDown=new Set;keysPressed=new Set;mouseDown=new Set;mousePressed=new Set;mousePosition={x:0,y:0};mouseWorldPosition={x:0,y:0};mouseWheelDelta=0;currentState;previousState;cameraOffset={x:0,y:0};cameraZoom=1;bindings;sequence=0;constructor(e){this.canvas=e,this.bindings=[...Hi],this.currentState=this.createEmptyState(),this.previousState=this.createEmptyState(),this.setupListeners()}createEmptyState(){return{moveX:0,moveY:0,aimX:0,aimY:0,shoot:!1,reload:!1,interact:!1,ability1:!1,ability2:!1,ultimate:!1,weaponSlot:0,menu:!1,scoreboard:!1,buyMenu:!1}}setupListeners(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.canvas.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("mousemove",this.onMouseMove),this.canvas.addEventListener("wheel",this.onMouseWheel,{passive:!1}),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("keydown",e=>{e.code==="Tab"&&e.preventDefault()})}onKeyDown=e=>{this.keysDown.has(e.code)||this.keysPressed.add(e.code),this.keysDown.add(e.code)};onKeyUp=e=>{this.keysDown.delete(e.code)};onMouseDown=e=>{this.mouseDown.has(e.button)||this.mousePressed.add(e.button),this.mouseDown.add(e.button)};onMouseUp=e=>{this.mouseDown.delete(e.button)};onMouseWheel=e=>{e.preventDefault(),this.mouseWheelDelta=e.deltaY};onMouseMove=e=>{const t=this.canvas.getBoundingClientRect();this.mousePosition={x:e.clientX-t.left,y:e.clientY-t.top},this.mouseWorldPosition={x:this.mousePosition.x/this.cameraZoom+this.cameraOffset.x,y:this.mousePosition.y/this.cameraZoom+this.cameraOffset.y}};update(){this.previousState={...this.currentState},this.currentState=this.createEmptyState(),(this.keysDown.has("KeyW")||this.keysDown.has("ArrowUp"))&&(this.currentState.moveY-=1),(this.keysDown.has("KeyS")||this.keysDown.has("ArrowDown"))&&(this.currentState.moveY+=1),(this.keysDown.has("KeyA")||this.keysDown.has("ArrowLeft"))&&(this.currentState.moveX-=1),(this.keysDown.has("KeyD")||this.keysDown.has("ArrowRight"))&&(this.currentState.moveX+=1);const e=Math.sqrt(this.currentState.moveX*this.currentState.moveX+this.currentState.moveY*this.currentState.moveY);e>1&&(this.currentState.moveX/=e,this.currentState.moveY/=e),this.currentState.aimX=this.mouseWorldPosition.x,this.currentState.aimY=this.mouseWorldPosition.y,this.currentState.shoot=this.mouseDown.has(0),this.mousePressed.has(2)&&(this.currentState.reload=!0);for(const t of this.bindings)t.type==="press"?this.keysPressed.has(t.key)&&(this.currentState[t.action]=!0):this.keysDown.has(t.key)&&(this.currentState[t.action]=!0);this.keysPressed.has("Digit1")?this.currentState.weaponSlot=1:this.keysPressed.has("Digit2")?this.currentState.weaponSlot=2:this.keysPressed.has("Digit3")?this.currentState.weaponSlot=3:this.keysPressed.has("Digit4")?this.currentState.weaponSlot=4:this.keysPressed.has("Digit5")?this.currentState.weaponSlot=5:this.mouseWheelDelta!==0&&(this.currentState.weaponSlot=this.mouseWheelDelta>0?-1:-2,this.mouseWheelDelta=0),this.keysPressed.clear(),this.mousePressed.clear()}getState(){return{...this.currentState}}wasPressed(e){return this.currentState[e]===!0&&this.previousState[e]===!1}wasReleased(e){return this.currentState[e]===!1&&this.previousState[e]===!0}isDown(e){return this.currentState[e]===!0}getMousePosition(){return{...this.mousePosition}}getMouseWorldPosition(){return{...this.mouseWorldPosition}}updateCamera(e,t){this.cameraOffset=e,this.cameraZoom=t,this.mouseWorldPosition={x:this.mousePosition.x/this.cameraZoom+this.cameraOffset.x,y:this.mousePosition.y/this.cameraZoom+this.cameraOffset.y}}getNextSequence(){return++this.sequence}setBindings(e){this.bindings=e}resetAllInputs(){this.keysDown.clear(),this.keysPressed.clear(),this.mouseDown.clear(),this.mousePressed.clear(),this.mouseWheelDelta=0,this.currentState=this.createEmptyState(),this.previousState=this.createEmptyState()}destroy(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),this.canvas.removeEventListener("mousedown",this.onMouseDown),this.canvas.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("mousemove",this.onMouseMove)}}var k=(r=>(r.Spectre="spectre",r.Byte="byte",r.Vanta="vanta",r.Katana="katana",r.Glyph="glyph",r.Spark="spark",r.Zero="zero",r.Mira="mira",r.Phantom="katana",r.Titan="vanta",r.Medic="mira",r.Havoc="spark",r.Cipher="byte",r.Venom="glyph",r.Aegis="zero",r))(k||{}),m=(r=>(r[r.None=0]="None",r[r.Attackers=1]="Attackers",r[r.Defenders=2]="Defenders",r))(m||{}),L=(r=>(r.BurstPistol="burst_pistol",r.NeoSMG9="neo_smg9",r.PulseRifle="pulse_rifle",r.ScatterShot="scatter_shot",r.RailSniper="rail_sniper",r))(L||{}),C=(r=>(r.Lobby="lobby",r.HeroSelect="hero_select",r.BuyPhase="buy_phase",r.RoundActive="round_active",r.RoundEnd="round_end",r.MatchEnd="match_end",r))(C||{}),j=(r=>(r.DataSpikeAssault="data_spike",r.ReactorEscort="reactor_escort",r.NeonDeathmatch="deathmatch",r))(j||{}),R=(r=>(r[r.Handshake=0]="Handshake",r[r.HandshakeAck=1]="HandshakeAck",r[r.Disconnect=2]="Disconnect",r[r.Ping=3]="Ping",r[r.Pong=4]="Pong",r[r.LobbyState=10]="LobbyState",r[r.PlayerJoin=11]="PlayerJoin",r[r.PlayerLeave=12]="PlayerLeave",r[r.PlayerReady=13]="PlayerReady",r[r.TeamChange=14]="TeamChange",r[r.HeroSelect=15]="HeroSelect",r[r.GameStart=16]="GameStart",r[r.Input=20]="Input",r[r.StateSnapshot=21]="StateSnapshot",r[r.StateDelta=22]="StateDelta",r[r.Event=23]="Event",r[r.PlayerDamage=30]="PlayerDamage",r[r.PlayerKill=31]="PlayerKill",r[r.AbilityUse=32]="AbilityUse",r[r.WeaponFire=33]="WeaponFire",r[r.Reload=34]="Reload",r[r.SpikePlant=35]="SpikePlant",r[r.SpikeDefuse=36]="SpikeDefuse",r[r.RoundEnd=37]="RoundEnd",r[r.CountdownPause=40]="CountdownPause",r[r.CountdownResume=41]="CountdownResume",r))(R||{}),Ye=(r=>(r.PlayerDamage="player_damage",r.PlayerKill="player_kill",r.PlayerRespawn="player_respawn",r.AbilityUsed="ability_used",r.WeaponFired="weapon_fired",r.SpikePlanted="spike_planted",r.SpikeDefused="spike_defused",r.RoundStarted="round_started",r.RoundEnded="round_ended",r))(Ye||{});const Rt={canvasWidth:1280,canvasHeight:720,tickRate:20},y={CYAN:"#0CE5F0",MAGENTA:"#F02BFF",YELLOW:"#FFE500",BACKGROUND:"#0a0a12",ATTACKER:"#FF4444",DEFENDER:"#44AAFF",HEALTH:"#44FF44",SHIELD:"#44AAFF",TEXT_PRIMARY:"#FFFFFF"},ue={[L.BurstPistol]:{id:L.BurstPistol,name:"Burst Pistol",price:0,damage:25,spread:.02,fireRate:4,range:800,ammoCapacity:15,reloadTime:1500,burstCount:3,burstDelay:60,projectileSpeed:0,headshotMultiplier:1.5},[L.NeoSMG9]:{id:L.NeoSMG9,name:"Neo SMG-9",price:1100,damage:18,spread:.06,fireRate:12,range:600,ammoCapacity:30,reloadTime:1800,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:1.3},[L.PulseRifle]:{id:L.PulseRifle,name:"Pulse Rifle",price:1500,damage:35,spread:.03,fireRate:6,range:1e3,ammoCapacity:25,reloadTime:2e3,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:2},[L.ScatterShot]:{id:L.ScatterShot,name:"Scatter Shot",price:1400,damage:15,spread:.15,fireRate:1.2,range:300,ammoCapacity:6,reloadTime:2500,burstCount:8,burstDelay:0,projectileSpeed:0,headshotMultiplier:1.5},[L.RailSniper]:{id:L.RailSniper,name:"Rail Sniper",price:2100,damage:120,spread:.005,fireRate:.8,range:2e3,ammoCapacity:5,reloadTime:3e3,burstCount:1,burstDelay:0,projectileSpeed:0,headshotMultiplier:2.5}},X={[k.Spectre]:{id:k.Spectre,name:"Spectre",faction:"Vanta Syndicate",role:"Flanker / Scout",health:100,shield:0,speed:1,abilities:[{name:"Ghost Protocol",description:"10% damage reduction",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Cloak",description:"Invisible for 2s",cooldown:1e4,duration:2e3,charges:1,chargeTime:1e4,isUltimate:!1,ultimateCost:0},{name:"Reveal Pulse",description:"Reveal enemies nearby 3s",cooldown:14e3,duration:3e3,charges:1,chargeTime:14e3,isUltimate:!1,ultimateCost:0},{name:"Shadow Dive",description:"Teleport behind enemy + 75 dmg",cooldown:5e4,duration:0,charges:1,chargeTime:5e4,isUltimate:!0,ultimateCost:6}]},[k.Byte]:{id:k.Byte,name:"Byte",faction:"Collapse Unit",role:"Control Specialist",health:100,shield:25,speed:.95,abilities:[{name:"Quick Recovery",description:"+25% shield regen speed",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"EMP Pulse",description:"AOE stun + slow 1.5s",cooldown:12e3,duration:1500,charges:1,chargeTime:12e3,isUltimate:!1,ultimateCost:0},{name:"Shock Trap",description:"Slowing zone 5s",cooldown:15e3,duration:5e3,charges:1,chargeTime:15e3,isUltimate:!1,ultimateCost:0},{name:"System Crash",description:"Large AOE stun + slow",cooldown:6e4,duration:3e3,charges:1,chargeTime:6e4,isUltimate:!0,ultimateCost:7}]},[k.Vanta]:{id:k.Vanta,name:"Vanta",faction:"HelixCorp",role:"Tank / Frontline",health:120,shield:50,speed:.85,abilities:[{name:"Titan Armor",description:"+50 shield, 15% damage reduction",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Energy Shield",description:"Front barrier 3s, blocks bullets",cooldown:1e4,duration:3e3,charges:1,chargeTime:1e4,isUltimate:!1,ultimateCost:0},{name:"Shockwave Slam",description:"AOE stun + 30 dmg",cooldown:14e3,duration:1e3,charges:1,chargeTime:14e3,isUltimate:!1,ultimateCost:0},{name:"Overclock",description:"40% DR + fire rate 5s",cooldown:55e3,duration:4e3,charges:1,chargeTime:55e3,isUltimate:!0,ultimateCost:6}]},[k.Katana]:{id:k.Katana,name:"Katana",faction:"ArcLight Initiative",role:"Burst Assassin",health:90,shield:0,speed:1.15,abilities:[{name:"Swift Strike",description:"+15% speed, +10% damage",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Blink",description:"Teleport 3 tiles forward",cooldown:8e3,duration:200,charges:2,chargeTime:8e3,isUltimate:!1,ultimateCost:0},{name:"Invisibility",description:"Cloak for 4 seconds",cooldown:12e3,duration:4e3,charges:1,chargeTime:12e3,isUltimate:!1,ultimateCost:0},{name:"Shadow Strike",description:"Teleport behind enemy + 75 dmg",cooldown:5e4,duration:0,charges:1,chargeTime:5e4,isUltimate:!0,ultimateCost:6}]},[k.Glyph]:{id:k.Glyph,name:"Glyph",faction:"ArcLight Initiative",role:"Vision / Utility",health:100,shield:25,speed:1,abilities:[{name:"Keen Eyes",description:"+10% damage (precision)",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Poison Cloud",description:"DOT zone 15dmg/tick 4s",cooldown:1e4,duration:4e3,charges:1,chargeTime:1e4,isUltimate:!1,ultimateCost:0},{name:"Turret Deploy",description:"Auto-attack turret 10s",cooldown:14e3,duration:1e4,charges:1,chargeTime:14e3,isUltimate:!1,ultimateCost:0},{name:"Toxic Storm",description:"Massive poison zone 5s",cooldown:55e3,duration:5e3,charges:1,chargeTime:55e3,isUltimate:!0,ultimateCost:7}]},[k.Spark]:{id:k.Spark,name:"Spark",faction:"HelixCorp",role:"Area Denial",health:100,shield:25,speed:.95,abilities:[{name:"Fireproof",description:"Fire immune, +10% fire rate",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Fire Bottle",description:"Burning zone 15dmg/tick",cooldown:12e3,duration:4e3,charges:2,chargeTime:12e3,isUltimate:!1,ultimateCost:0},{name:"Minigun Mode",description:"+50% fire rate 4s",cooldown:15e3,duration:4e3,charges:1,chargeTime:15e3,isUltimate:!1,ultimateCost:0},{name:"Napalm Strike",description:"Huge fire zone 6s",cooldown:55e3,duration:6e3,charges:1,chargeTime:55e3,isUltimate:!0,ultimateCost:7}]},[k.Zero]:{id:k.Zero,name:"Zero",faction:"Collapse Unit",role:"Sniper / Scout",health:90,shield:0,speed:1,abilities:[{name:"Steady Aim",description:"+15% damage (sniper)",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Mark Target",description:"Reveal + 20% bonus dmg 5s",cooldown:8e3,duration:5e3,charges:1,chargeTime:8e3,isUltimate:!1,ultimateCost:0},{name:"Dash Back",description:"Quick backward escape",cooldown:12e3,duration:200,charges:1,chargeTime:12e3,isUltimate:!1,ultimateCost:0},{name:"Dome Shield",description:"Team protection dome 3s",cooldown:6e4,duration:3e3,charges:1,chargeTime:6e4,isUltimate:!0,ultimateCost:8}]},[k.Mira]:{id:k.Mira,name:"Mira",faction:"Independent",role:"Medic / Support",health:100,shield:25,speed:1,abilities:[{name:"Combat Medic",description:"+25% healing received/given",cooldown:0,duration:0,charges:1,chargeTime:0,isUltimate:!1,ultimateCost:0},{name:"Heal Field",description:"Healing zone 10HP/tick 4s",cooldown:1e4,duration:4e3,charges:1,chargeTime:1e4,isUltimate:!1,ultimateCost:0},{name:"Shield Burst",description:"+30 shields to allies",cooldown:14e3,duration:3e3,charges:1,chargeTime:14e3,isUltimate:!1,ultimateCost:0},{name:"Resync",description:"Revive ally at 50% HP",cooldown:6e4,duration:0,charges:1,chargeTime:6e4,isUltimate:!0,ultimateCost:8}]}},Qe={SIGNALING_SERVER:"ws://localhost:8080",TICK_RATE:20,SNAPSHOT_RATE:10,INPUT_RATE:20,PING_INTERVAL:1e3,TIMEOUT_MS:1e4,INPUT_BUFFER_SIZE:64,SNAPSHOT_BUFFER_SIZE:32,INTERPOLATION_DELAY:100},U={ROUND_TIME:18e4,MAX_ROUNDS:13,SPIKE_PLANT_TIME:3e3,SPIKE_DEFUSE_TIME:5e3,SPIKE_UPLOAD_TIME:45e3,STARTING_CREDITS:800,KILL_REWARD:300,HEADSHOT_ZONE_RATIO:.3,BASE_SPEED:200};class Gi{canvas;ctx;cameraX=0;cameraY=0;cameraZoom=1;cameraShake={x:0,y:0};viewportWidth;viewportHeight;constructor(e,t,i){this.canvas=e,this.viewportWidth=t,this.viewportHeight=i;const o=e.getContext("2d");if(!o)throw new Error("Failed to get 2D context");this.ctx=o,this.resize(t,i),this.ctx.imageSmoothingEnabled=!1}resize(e,t){const i=window.devicePixelRatio||1;this.canvas.width=e*i,this.canvas.height=t*i,this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`,this.ctx.scale(i,i),this.viewportWidth=e,this.viewportHeight=t}setCamera(e,t,i=1){this.cameraX=e,this.cameraY=t,this.cameraZoom=i}setCameraShake(e,t){this.cameraShake={x:e,y:t}}getCameraOffset(){return{x:this.cameraX-this.viewportWidth/2/this.cameraZoom+this.cameraShake.x,y:this.cameraY-this.viewportHeight/2/this.cameraZoom+this.cameraShake.y}}getCameraZoom(){return this.cameraZoom}worldToScreen(e){const t=this.getCameraOffset();return{x:(e.x-t.x)*this.cameraZoom,y:(e.y-t.y)*this.cameraZoom}}screenToWorld(e){const t=this.getCameraOffset();return{x:e.x/this.cameraZoom+t.x,y:e.y/this.cameraZoom+t.y}}isInView(e,t,i=100){const o=this.worldToScreen({x:e,y:t});return o.x>=-i&&o.x<=this.viewportWidth+i&&o.y>=-i&&o.y<=this.viewportHeight+i}beginFrame(){this.ctx.save(),this.clear()}endFrame(){this.ctx.restore()}beginWorld(){this.ctx.save();const e=this.getCameraOffset();this.ctx.scale(this.cameraZoom,this.cameraZoom),this.ctx.translate(-e.x,-e.y)}endWorld(){this.ctx.restore()}clear(e=y.BACKGROUND){this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.viewportWidth,this.viewportHeight)}drawRect(e,t,i,o,s={}){const{fill:a,stroke:n,strokeWidth:l=1,glow:c=!1,glowColor:d=y.CYAN,glowSize:h=10,cornerRadius:p=0}=s;this.ctx.save(),c&&(this.ctx.shadowColor=d,this.ctx.shadowBlur=h),p>0?(this.ctx.beginPath(),this.ctx.roundRect(e,t,i,o,p),a&&(this.ctx.fillStyle=a,this.ctx.fill()),n&&(this.ctx.strokeStyle=n,this.ctx.lineWidth=l,this.ctx.stroke())):(a&&(this.ctx.fillStyle=a,this.ctx.fillRect(e,t,i,o)),n&&(this.ctx.strokeStyle=n,this.ctx.lineWidth=l,this.ctx.strokeRect(e,t,i,o))),this.ctx.restore()}drawCircle(e,t,i,o={}){const{fill:s,stroke:a,strokeWidth:n=1,glow:l=!1,glowColor:c=y.CYAN,glowSize:d=10}=o;this.ctx.save(),l&&(this.ctx.shadowColor=c,this.ctx.shadowBlur=d),this.ctx.beginPath(),this.ctx.arc(e,t,i,0,Math.PI*2),s&&(this.ctx.fillStyle=s,this.ctx.fill()),a&&(this.ctx.strokeStyle=a,this.ctx.lineWidth=n,this.ctx.stroke()),this.ctx.restore()}drawArc(e,t,i,o,s,a={}){const{fill:n,stroke:l,strokeWidth:c=1,glow:d=!1,glowColor:h=y.CYAN,glowSize:p=10}=a;this.ctx.save(),d&&(this.ctx.shadowColor=h,this.ctx.shadowBlur=p),this.ctx.beginPath(),this.ctx.arc(e,t,i,o,s),n&&(this.ctx.fillStyle=n,this.ctx.fill()),l&&(this.ctx.strokeStyle=l,this.ctx.lineWidth=c,this.ctx.stroke()),this.ctx.restore()}drawLine(e,t,i,o,s={}){const{color:a=y.CYAN,width:n=1,glow:l=!1,glowColor:c=y.CYAN,glowSize:d=10,dash:h=[]}=s;this.ctx.save(),l&&(this.ctx.shadowColor=c,this.ctx.shadowBlur=d),this.ctx.strokeStyle=a,this.ctx.lineWidth=n,this.ctx.setLineDash(h),this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(i,o),this.ctx.stroke(),this.ctx.restore()}drawPolygon(e,t={}){if(e.length<3)return;const{fill:i,stroke:o,strokeWidth:s=1,glow:a=!1,glowColor:n=y.CYAN,glowSize:l=10}=t;this.ctx.save(),a&&(this.ctx.shadowColor=n,this.ctx.shadowBlur=l),this.ctx.beginPath(),this.ctx.moveTo(e[0].x,e[0].y);for(let c=1;c<e.length;c++)this.ctx.lineTo(e[c].x,e[c].y);this.ctx.closePath(),i&&(this.ctx.fillStyle=i,this.ctx.fill()),o&&(this.ctx.strokeStyle=o,this.ctx.lineWidth=s,this.ctx.stroke()),this.ctx.restore()}drawText(e,t,i,o={}){const{font:s="Segoe UI",size:a=14,color:n=y.TEXT_PRIMARY,align:l="left",baseline:c="top",glow:d=!1,glowColor:h=y.CYAN,glowSize:p=10}=o;this.ctx.save(),d&&(this.ctx.shadowColor=h,this.ctx.shadowBlur=p),this.ctx.font=`${a}px ${s}`,this.ctx.fillStyle=n,this.ctx.textAlign=l,this.ctx.textBaseline=c,this.ctx.fillText(e,t,i),this.ctx.restore()}measureText(e,t,i){this.ctx.save(),this.ctx.font=`${i}px ${t}`;const o=this.ctx.measureText(e);return this.ctx.restore(),o}drawSprite(e,t,i,o,s){const a=o??e.width,n=s??e.height;this.ctx.drawImage(e.image,e.x,e.y,e.width,e.height,t,i,a,n)}drawImage(e,t,i,o,s,a=0){const n=o??e.width,l=s??e.height;this.ctx.save(),this.ctx.translate(t+n/2,i+l/2),this.ctx.rotate(a),this.ctx.drawImage(e,-n/2,-l/2,n,l),this.ctx.restore()}drawNeonRect(e,t,i=1){const{x:o,y:s,width:a,height:n}=e;this.drawRect(o,s,a,n,{stroke:t,strokeWidth:2,glow:!0,glowColor:t,glowSize:15*i}),this.drawRect(o+2,s+2,a-4,n-4,{fill:`${t}22`})}drawHealthBar(e,t,i,o,s,a,n=0,l=0){const c=Math.max(0,s/a),d=l>0?Math.max(0,n/l):0;if(this.drawRect(e,t,i,o,{fill:"#000000AA",stroke:"#333",strokeWidth:1}),c>0){const h=(i-2)*c;this.drawRect(e+1,t+1,h,o-2,{fill:y.HEALTH})}if(d>0){const h=(i-2)*d;this.drawRect(e+1,t+1,h,o-2,{fill:y.SHIELD})}}drawAbilityCooldown(e,t,i,o,s){if(this.drawCircle(e,t,i,{fill:"#222",stroke:y.CYAN,strokeWidth:2}),s){const a=i*1.4;this.drawImage(s,e-a/2,t-a/2,a,a)}o>0&&(this.ctx.save(),this.ctx.globalAlpha=.7,this.ctx.fillStyle="#000",this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.arc(e,t,i,-Math.PI/2,-Math.PI/2+Math.PI*2*o,!1),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore())}drawDebugGrid(e,t="#333"){const i=this.getCameraOffset(),o=Math.floor(i.x/e)*e,s=Math.floor(i.y/e)*e,a=i.x+this.viewportWidth/this.cameraZoom+e,n=i.y+this.viewportHeight/this.cameraZoom+e;this.ctx.save(),this.ctx.strokeStyle=t,this.ctx.lineWidth=.5;for(let l=o;l<=a;l+=e)this.drawLine(l,s,l,n,{color:t,width:.5});for(let l=s;l<=n;l+=e)this.drawLine(o,l,a,l,{color:t,width:.5});this.ctx.restore()}drawDebugPoint(e,t,i=y.CYAN,o){this.drawCircle(e,t,4,{fill:i}),o&&this.drawText(o,e+8,t-8,{color:i,size:10})}drawDebugRect(e,t=y.CYAN,i){this.drawRect(e.x,e.y,e.width,e.height,{stroke:t,strokeWidth:1}),i&&this.drawText(i,e.x,e.y-14,{color:t,size:10})}getWidth(){return this.viewportWidth}getHeight(){return this.viewportHeight}getContext(){return this.ctx}}class Vi{context=null;masterVolume=1;sfxVolume=1;musicVolume=.5;sounds=new Map;activeSources=new Map;activeGains=new Map;currentMusic=null;currentMusicKey=null;initialized=!1;async init(){if(!this.initialized)try{this.context=new AudioContext,this.initialized=!0}catch(e){console.warn("Web Audio API not supported:",e)}}async loadSound(e,t){if(this.context)try{const o=await(await fetch(t)).arrayBuffer(),s=await this.context.decodeAudioData(o);this.sounds.set(e,s)}catch(i){console.warn(`Failed to load sound: ${e}`,i)}}play(e,t={}){if(!this.context||!this.sounds.has(e))return null;const i=this.sounds.get(e),o=this.context.createBufferSource();o.buffer=i;const s=this.context.createGain();s.gain.value=(t.volume??1)*this.sfxVolume*this.masterVolume,o.connect(s),s.connect(this.context.destination),o.loop=t.loop??!1,t.pitch&&(o.playbackRate.value=t.pitch);const a=`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;this.activeSources.set(a,o),this.activeGains.set(a,s),o.onended=()=>{this.activeSources.delete(a),this.activeGains.delete(a)};const n=t.offset??0;return o.start(0,n),a}stop(e){const t=this.activeSources.get(e);t&&(t.stop(),this.activeSources.delete(e),this.activeGains.delete(e))}getSoundDuration(e){const t=this.sounds.get(e);return t?t.duration:0}playMusic(e,t=0){if(!this.context||!this.sounds.has(e)||this.currentMusicKey===e)return;this.stopMusic(.5);const i=this.sounds.get(e),o=this.context.createBufferSource();o.buffer=i,o.loop=!0;const s=this.context.createGain();t>0?(s.gain.value=0,s.gain.linearRampToValueAtTime(this.musicVolume*this.masterVolume,this.context.currentTime+t)):s.gain.value=this.musicVolume*this.masterVolume,o.connect(s),s.connect(this.context.destination),o.start(0),this.currentMusic=o,this.currentMusicKey=e}stopMusic(e=0){if(!this.currentMusic||!this.context)return;const t=this.currentMusic;if(e>0){const i=this.context.createGain();t.disconnect(),t.connect(i),i.connect(this.context.destination),i.gain.linearRampToValueAtTime(0,this.context.currentTime+e),setTimeout(()=>{try{t.stop()}catch{}},e*1e3)}else t.stop();this.currentMusic=null,this.currentMusicKey=null}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e))}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}setMusicVolume(e){this.musicVolume=Math.max(0,Math.min(1,e))}async resume(){this.context?.state==="suspended"&&await this.context.resume()}suspend(){this.context?.suspend()}stopAll(){for(const[e]of this.activeSources)this.stop(e);this.stopMusic()}isInitialized(){return this.initialized}}const u={create(r=0,e=0){return{x:r,y:e}},clone(r){return{x:r.x,y:r.y}},add(r,e){return{x:r.x+e.x,y:r.y+e.y}},sub(r,e){return{x:r.x-e.x,y:r.y-e.y}},mul(r,e){return{x:r.x*e,y:r.y*e}},div(r,e){return e===0?{x:0,y:0}:{x:r.x/e,y:r.y/e}},dot(r,e){return r.x*e.x+r.y*e.y},cross(r,e){return r.x*e.y-r.y*e.x},length(r){return Math.sqrt(r.x*r.x+r.y*r.y)},lengthSquared(r){return r.x*r.x+r.y*r.y},normalize(r){const e=u.length(r);return e===0?{x:0,y:0}:{x:r.x/e,y:r.y/e}},distance(r,e){const t=e.x-r.x,i=e.y-r.y;return Math.sqrt(t*t+i*i)},distanceSquared(r,e){const t=e.x-r.x,i=e.y-r.y;return t*t+i*i},angle(r){return Math.atan2(r.y,r.x)},fromAngle(r,e=1){return{x:Math.cos(r)*e,y:Math.sin(r)*e}},rotate(r,e){const t=Math.cos(e),i=Math.sin(e);return{x:r.x*t-r.y*i,y:r.x*i+r.y*t}},lerp(r,e,t){return{x:r.x+(e.x-r.x)*t,y:r.y+(e.y-r.y)*t}},clamp(r,e){return u.length(r)<=e?{x:r.x,y:r.y}:u.mul(u.normalize(r),e)},equals(r,e,t=1e-4){return Math.abs(r.x-e.x)<t&&Math.abs(r.y-e.y)<t},zero(){return{x:0,y:0}}},li={pointInRect(r,e){return r.x>=e.x&&r.x<=e.x+e.width&&r.y>=e.y&&r.y<=e.y+e.height},pointInCircle(r,e){const t=r.x-e.x,i=r.y-e.y;return t*t+i*i<=e.radius*e.radius},rectIntersect(r,e){return r.x<e.x+e.width&&r.x+r.width>e.x&&r.y<e.y+e.height&&r.y+r.height>e.y},circleIntersect(r,e){const t=e.x-r.x,i=e.y-r.y,o=r.radius+e.radius;return t*t+i*i<=o*o},circleRectIntersect(r,e){const t=Math.max(e.x,Math.min(r.x,e.x+e.width)),i=Math.max(e.y,Math.min(r.y,e.y+e.height)),o=r.x-t,s=r.y-i;return o*o+s*s<=r.radius*r.radius},lineIntersect(r,e,t,i){const o=(i.y-t.y)*(e.x-r.x)-(i.x-t.x)*(e.y-r.y);if(Math.abs(o)<1e-4)return null;const s=((i.x-t.x)*(r.y-t.y)-(i.y-t.y)*(r.x-t.x))/o,a=((e.x-r.x)*(r.y-t.y)-(e.y-r.y)*(r.x-t.x))/o;return s>=0&&s<=1&&a>=0&&a<=1?{x:r.x+s*(e.x-r.x),y:r.y+s*(e.y-r.y)}:null},lineRectIntersect(r,e,t){const i=[{p1:{x:t.x,y:t.y},p2:{x:t.x+t.width,y:t.y}},{p1:{x:t.x+t.width,y:t.y},p2:{x:t.x+t.width,y:t.y+t.height}},{p1:{x:t.x+t.width,y:t.y+t.height},p2:{x:t.x,y:t.y+t.height}},{p1:{x:t.x,y:t.y+t.height},p2:{x:t.x,y:t.y}}];let o=null,s=1/0;for(const a of i){const n=this.lineIntersect(r,e,a.p1,a.p2);if(n){const l=u.distanceSquared(r,n);l<s&&(s=l,o=n)}}return o}};let Ui=0;function J(r="e"){return`${r}_${Date.now().toString(36)}_${(Ui++).toString(36)}`}function Ae(r,e,t){return r+(e-r)*t}function Yi(r,e){return r+Math.random()*(e-r)}function ji(r){const e=Math.floor(r/1e3),t=Math.floor(e/60),i=e%60;return`${t}:${i.toString().padStart(2,"0")}`}var je=(r=>(r.Circle="circle",r.Box="box",r))(je||{});const M={PLAYER:1,ENEMY:2,PROJECTILE:4,WALL:8,TRIGGER:16,ALL:4294967295};class Xi{cellSize;cells=new Map;bodyPositions=new Map;constructor(e=128){this.cellSize=e}getCellsForBody(e){const t=this.getBodyBounds(e),i=[],o=Math.floor(t.x/this.cellSize),s=Math.floor(t.y/this.cellSize),a=Math.floor((t.x+t.width)/this.cellSize),n=Math.floor((t.y+t.height)/this.cellSize);for(let l=o;l<=a;l++)for(let c=s;c<=n;c++)i.push(`${l},${c}`);return i}getBodyBounds(e){if(e.collider.type==="circle"){const t=e.collider;return{x:e.position.x+t.offset.x-t.radius,y:e.position.y+t.offset.y-t.radius,width:t.radius*2,height:t.radius*2}}else{const t=e.collider;return{x:e.position.x+t.offset.x,y:e.position.y+t.offset.y,width:t.width,height:t.height}}}insert(e){this.remove(e.id);const t=this.getCellsForBody(e);this.bodyPositions.set(e.id,t);for(const i of t)this.cells.has(i)||this.cells.set(i,new Set),this.cells.get(i).add(e.id)}remove(e){const t=this.bodyPositions.get(e);if(t){for(const i of t)this.cells.get(i)?.delete(e);this.bodyPositions.delete(e)}}update(e){this.insert(e)}query(e){const t=new Set,i=Math.floor(e.x/this.cellSize),o=Math.floor(e.y/this.cellSize),s=Math.floor((e.x+e.width)/this.cellSize),a=Math.floor((e.y+e.height)/this.cellSize);for(let n=i;n<=s;n++)for(let l=o;l<=a;l++){const c=this.cells.get(`${n},${l}`);if(c)for(const d of c)t.add(d)}return t}getNearby(e){const t=this.getBodyBounds(e);t.x-=this.cellSize,t.y-=this.cellSize,t.width+=this.cellSize*2,t.height+=this.cellSize*2;const i=this.query(t);return i.delete(e.id),i}clear(){this.cells.clear(),this.bodyPositions.clear()}}class Ki{bodies=new Map;spatialHash;collisions=[];constructor(e=128){this.spatialHash=new Xi(e)}addBody(e){this.bodies.set(e.id,e),this.spatialHash.insert(e)}removeBody(e){this.bodies.delete(e),this.spatialHash.remove(e)}getBody(e){return this.bodies.get(e)}updateBody(e,t,i){const o=this.bodies.get(e);o&&(o.position=t,i&&(o.velocity=i),this.spatialHash.update(o))}detectCollisions(){this.collisions=[];for(const[e,t]of this.bodies){const i=this.spatialHash.getNearby(t);for(const o of i){if(o<=e)continue;const s=this.bodies.get(o);if(!s||!(t.layer&s.mask)&&!(s.layer&t.mask))continue;const a=this.checkCollision(t,s);a&&this.collisions.push(a)}}return this.collisions}checkCollision(e,t){const i=e.collider,o=t.collider,s=u.add(e.position,i.offset),a=u.add(t.position,o.offset);if(i.type==="circle"&&o.type==="circle"){const n=i.radius+o.radius,l=u.distance(s,a);if(l<n){const c=u.normalize(u.sub(a,s)),d=n-l,h=u.add(s,u.mul(c,i.radius));return{bodyA:e,bodyB:t,normal:c,depth:d,point:h}}}if(i.type==="box"&&o.type==="box"){const n={x:s.x,y:s.y,width:i.width,height:i.height},l={x:a.x,y:a.y,width:o.width,height:o.height};if(li.rectIntersect(n,l)){const c=Math.min(n.x+n.width,l.x+l.width)-Math.max(n.x,l.x),d=Math.min(n.y+n.height,l.y+l.height)-Math.max(n.y,l.y),h={x:s.x+i.width/2,y:s.y+i.height/2},p={x:a.x+o.width/2,y:a.y+o.height/2},f=u.sub(p,h);let g,w;c<d?(g={x:f.x>0?1:-1,y:0},w=c):(g={x:0,y:f.y>0?1:-1},w=d);const I={x:h.x+g.x*(i.width/2),y:h.y+g.y*(i.height/2)};return{bodyA:e,bodyB:t,normal:g,depth:w,point:I}}}if(i.type==="circle"&&o.type==="box"||i.type==="box"&&o.type==="circle"){const n=i.type==="circle"?e:t,l=i.type==="box"?e:t,c=n.collider,d=l.collider,h=u.add(n.position,c.offset),p=u.add(l.position,d.offset),f={x:p.x,y:p.y,width:d.width,height:d.height},g=Math.max(f.x,Math.min(h.x,f.x+f.width)),w=Math.max(f.y,Math.min(h.y,f.y+f.height)),I=h.x-g,A=h.y-w,P=I*I+A*A,T=c.radius*c.radius;if(h.x>=f.x&&h.x<=f.x+f.width&&h.y>=f.y&&h.y<=f.y+f.height){const D=h.x-f.x,G=f.x+f.width-h.x,N=h.y-f.y,q=f.y+f.height-h.y,se=Math.min(D,G,N,q);let B,W;return se===D?(B={x:-1,y:0},W=D+c.radius):se===G?(B={x:1,y:0},W=G+c.radius):se===N?(B={x:0,y:-1},W=N+c.radius):(B={x:0,y:1},W=q+c.radius),{bodyA:n,bodyB:l,normal:B,depth:W,point:{x:g,y:w}}}else if(P<T){const D=Math.sqrt(P),G=c.radius-D,N=D>1e-4?{x:I/D,y:A/D}:{x:1,y:0};return{bodyA:n,bodyB:l,normal:N,depth:G,point:{x:g,y:w}}}}return null}resolveCollisions(){const e=[...this.collisions].sort((t,i)=>{const o=t.bodyA.isStatic||t.bodyB.isStatic,s=i.bodyA.isStatic||i.bodyB.isStatic;return o&&!s?-1:!o&&s?1:0});for(const t of e){const{bodyA:i,bodyB:o,normal:s,depth:a}=t;if(!(i.isTrigger||o.isTrigger)&&!(a<=0||!isFinite(a))){if(i.isStatic&&!o.isStatic){o.position.x-=s.x*a,o.position.y-=s.y*a;const n=o.velocity.x*s.x+o.velocity.y*s.y;n>0&&(o.velocity.x-=s.x*n,o.velocity.y-=s.y*n)}else if(o.isStatic&&!i.isStatic){i.position.x+=s.x*a,i.position.y+=s.y*a;const n=i.velocity.x*s.x+i.velocity.y*s.y;n<0&&(i.velocity.x-=s.x*n,i.velocity.y-=s.y*n)}else if(!i.isStatic&&!o.isStatic){const n=a/2,l=.8;i.position.x+=s.x*n*l,i.position.y+=s.y*n*l,o.position.x-=s.x*n*l,o.position.y-=s.y*n*l}this.spatialHash.update(i),this.spatialHash.update(o)}}}raycast(e,t,i,o=M.ALL){const s=u.normalize(t),a=u.add(e,u.mul(s,i));let n=null;for(const[,l]of this.bodies){if(!(l.layer&o))continue;const c=l.collider,d=u.add(l.position,c.offset);let h=null;if(c.type==="box"){const p={x:d.x,y:d.y,width:c.width,height:c.height};h=li.lineRectIntersect(e,a,p)}else c.type==="circle"&&(h=this.lineCircleIntersection(e,a,d,c.radius));if(h){const p=u.distance(e,h);(!n||p<n.distance)&&(n={body:l,point:h,distance:p})}}return n}lineCircleIntersection(e,t,i,o){const s=u.sub(t,e),a=u.sub(e,i),n=u.dot(s,s),l=2*u.dot(a,s),c=u.dot(a,a)-o*o;let d=l*l-4*n*c;if(d<0)return null;d=Math.sqrt(d);const h=(-l-d)/(2*n),p=(-l+d)/(2*n);return h>=0&&h<=1?u.add(e,u.mul(s,h)):p>=0&&p<=1?u.add(e,u.mul(s,p)):null}getCollisions(){return this.collisions}clear(){this.bodies.clear(),this.spatialHash.clear(),this.collisions=[]}}class Ct{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){this.listeners.get(e)?.delete(t)}emit(e,t){const i=this.listeners.get(e);if(i)for(const o of i)try{o(t)}catch(s){console.error(`Error in event handler for ${String(e)}:`,s)}}once(e,t){const i=o=>{this.off(e,i),t(o)};this.on(e,i)}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}}const qi=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}];class et extends Ct{peerId;connection;dataChannel=null;isConnected=!1;constructor(e,t){super(),this.peerId=e,this.connection=new RTCPeerConnection({iceServers:t?.iceServers??qi}),this.setupConnectionListeners()}setupConnectionListeners(){this.connection.oniceconnectionstatechange=()=>{const e=this.connection.iceConnectionState;console.log(`[Peer ${this.peerId}] ICE state: ${e}`),e==="connected"?this.isConnected||(this.isConnected=!0,this.emit("connected",{peerId:this.peerId})):(e==="disconnected"||e==="failed"||e==="closed")&&(this.isConnected=!1,this.emit("disconnected",{peerId:this.peerId}))},this.connection.ondatachannel=e=>{this.setupDataChannel(e.channel)}}setupDataChannel(e){this.dataChannel=e,this.dataChannel.binaryType="arraybuffer",this.dataChannel.onopen=()=>{console.log(`[Peer ${this.peerId}] Data channel opened`)},this.dataChannel.onclose=()=>{console.log(`[Peer ${this.peerId}] Data channel closed`)},this.dataChannel.onmessage=t=>{this.emit("message",{peerId:this.peerId,data:t.data})},this.dataChannel.onerror=t=>{this.emit("error",{peerId:this.peerId,error:new Error("Data channel error")}),console.error(`[Peer ${this.peerId}] Data channel error:`,t)}}async createOffer(){const e=this.connection.createDataChannel("game",{ordered:!1,maxRetransmits:0});this.setupDataChannel(e);const t=await this.connection.createOffer();return await this.connection.setLocalDescription(t),t}async handleOffer(e){await this.connection.setRemoteDescription(e);const t=await this.connection.createAnswer();return await this.connection.setLocalDescription(t),t}async handleAnswer(e){await this.connection.setRemoteDescription(e)}async addIceCandidate(e){try{await this.connection.addIceCandidate(e)}catch(t){console.warn(`[Peer ${this.peerId}] Failed to add ICE candidate:`,t)}}onIceCandidate(e){this.connection.onicecandidate=t=>{t.candidate&&e(t.candidate)}}send(e){if(!this.dataChannel||this.dataChannel.readyState!=="open")return!1;try{return typeof e=="string"?this.dataChannel.send(e):this.dataChannel.send(new Uint8Array(e)),!0}catch(t){return console.error(`[Peer ${this.peerId}] Send failed:`,t),!1}}sendIfReady(e){return!this.dataChannel||this.dataChannel.readyState!=="open"?!1:this.dataChannel.bufferedAmount>65536?(console.warn(`[Peer ${this.peerId}] Buffer full, skipping send`),!1):this.send(e)}close(){this.dataChannel?.close(),this.connection.close(),this.isConnected=!1}getPeerId(){return this.peerId}getIsConnected(){return this.isConnected&&this.dataChannel?.readyState==="open"}getStats(){return this.connection.getStats()}}class Zi extends Ct{ws=null;serverUrl;localPeerId;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=1e3;constructor(e){super(),this.serverUrl=e,this.localPeerId=this.generatePeerId()}generatePeerId(){return`peer_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}connect(){return new Promise((e,t)=>{try{this.ws=new WebSocket(this.serverUrl),this.ws.onopen=()=>{console.log("[Signaling] Connected"),this.reconnectAttempts=0,this.emit("connected",void 0),e()},this.ws.onclose=()=>{console.log("[Signaling] Disconnected"),this.emit("disconnected",void 0),this.attemptReconnect()},this.ws.onerror=i=>{console.error("[Signaling] Error:",i),t(i)},this.ws.onmessage=i=>{this.handleMessage(i.data)}}catch(i){t(i)}})}handleMessage(e){try{const t=JSON.parse(e);switch(t.type){case"room-created":this.emit("roomCreated",{roomCode:t.roomCode});break;case"room-joined":this.emit("roomJoined",{roomCode:t.roomCode,peers:t.payload});break;case"peer-joined":this.emit("peerJoined",{peerId:t.peerId});break;case"peer-left":this.emit("peerLeft",{peerId:t.peerId});break;case"offer":this.emit("offer",{peerId:t.peerId,offer:t.payload});break;case"answer":this.emit("answer",{peerId:t.peerId,answer:t.payload});break;case"ice-candidate":this.emit("iceCandidate",{peerId:t.peerId,candidate:t.payload});break;case"error":this.emit("error",{message:t.payload});break;default:console.warn("[Signaling] Unknown message type:",t.type)}}catch(t){console.error("[Signaling] Failed to parse message:",t)}}attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("[Signaling] Max reconnect attempts reached");return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);console.log(`[Signaling] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.connect().catch(()=>{})},e)}send(e){this.ws?.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.warn("[Signaling] Cannot send, not connected")}createRoom(){this.send({type:"create-room",peerId:this.localPeerId})}joinRoom(e){this.send({type:"join-room",roomCode:e,peerId:this.localPeerId})}leaveRoom(){this.send({type:"leave-room",peerId:this.localPeerId})}sendOffer(e,t){this.send({type:"offer",peerId:this.localPeerId,targetId:e,payload:t})}sendAnswer(e,t){this.send({type:"answer",peerId:this.localPeerId,targetId:e,payload:t})}sendIceCandidate(e,t){this.send({type:"ice-candidate",peerId:this.localPeerId,targetId:e,payload:t})}disconnect(){this.ws?.close(),this.ws=null}getLocalPeerId(){return this.localPeerId}isConnected(){return this.ws?.readyState===WebSocket.OPEN}}class Ji extends Ct{db=null;localPeerId;roomCode="";unsubscribers=[];isConnected=!1;firebase=null;constructor(){super(),this.localPeerId=this.generatePeerId()}generatePeerId(){return`peer_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`}async connect(e){try{const{initializeApp:t,getApps:i,getApp:o}=await de(async()=>{const{initializeApp:A,getApps:P,getApp:T}=await import("./index.esm-OOYOW6k3.js");return{initializeApp:A,getApps:P,getApp:T}},__vite__mapDeps([0,1]),import.meta.url),{getFirestore:s,collection:a,doc:n,setDoc:l,getDoc:c,addDoc:d,onSnapshot:h,deleteDoc:p,updateDoc:f,serverTimestamp:g,arrayUnion:w}=await de(async()=>{const{getFirestore:A,collection:P,doc:T,setDoc:$,getDoc:D,addDoc:G,onSnapshot:N,deleteDoc:q,updateDoc:se,serverTimestamp:B,arrayUnion:W}=await import("./index.esm-DbUeHnob.js");return{getFirestore:A,collection:P,doc:T,setDoc:$,getDoc:D,addDoc:G,onSnapshot:N,deleteDoc:q,updateDoc:se,serverTimestamp:B,arrayUnion:W}},__vite__mapDeps([2,1]),import.meta.url);this.firebase={collection:a,doc:n,setDoc:l,getDoc:c,addDoc:d,onSnapshot:h,deleteDoc:p,updateDoc:f,serverTimestamp:g,arrayUnion:w};const I=i().length===0?t(e):o();this.db=s(I),this.isConnected=!0,this.emit("connected",void 0),console.log("[FirestoreSignaling] Connected to Firebase")}catch(t){throw console.error("[FirestoreSignaling] Failed to connect:",t),t}}async createRoom(){if(!this.db)throw new Error("Not connected to Firebase");const{doc:e,setDoc:t,serverTimestamp:i}=this.firebase;this.roomCode=this.generateRoomCode();const o=e(this.db,"rooms",this.roomCode);await t(o,{hostId:this.localPeerId,createdAt:i(),peers:[this.localPeerId]});const s=e(this.db,"rooms",this.roomCode,"peers",this.localPeerId);return await t(s,{joinedAt:i(),isHost:!0}),this.listenForPeers(),this.listenForSignals(),this.emit("roomCreated",{roomCode:this.roomCode}),console.log(`[FirestoreSignaling] Room created: ${this.roomCode}`),this.roomCode}async joinRoom(e){if(!this.db)throw new Error("Not connected to Firebase");const{doc:t,getDoc:i,setDoc:o,updateDoc:s,serverTimestamp:a,arrayUnion:n}=this.firebase;this.roomCode=e.toUpperCase(),console.log(`[FirestoreSignaling] Attempting to join room: ${this.roomCode} as peer: ${this.localPeerId}`);const l=t(this.db,"rooms",this.roomCode),c=await i(l);if(!c.exists())throw this.emit("error",{message:`Room ${this.roomCode} not found`}),new Error(`Room ${this.roomCode} not found`);const h=c.data().peers||[];console.log(`[FirestoreSignaling] Room exists, current peers: [${h.join(", ")}]`);try{await s(l,{peers:n(this.localPeerId)}),console.log("[FirestoreSignaling] Added self to peers array")}catch(g){console.error("[FirestoreSignaling] Failed to update peers array:",g),await s(l,{peers:[...h,this.localPeerId]})}const p=t(this.db,"rooms",this.roomCode,"peers",this.localPeerId);await o(p,{joinedAt:a(),isHost:!1}),console.log("[FirestoreSignaling] Created peer document"),this.listenForPeers(),this.listenForSignals();const f=h.filter(g=>g!==this.localPeerId);this.emit("roomJoined",{roomCode:this.roomCode,peers:f}),console.log(`[FirestoreSignaling] Joined room: ${this.roomCode}, will connect to peers: [${f.join(", ")}]`)}listenForPeers(){const{collection:e,onSnapshot:t}=this.firebase,i=e(this.db,"rooms",this.roomCode,"peers"),o=t(i,s=>{s.docChanges().forEach(a=>{const n=a.doc.id;n!==this.localPeerId&&(a.type==="added"?(console.log(`[FirestoreSignaling] Peer joined: ${n}`),this.emit("peerJoined",{peerId:n})):a.type==="removed"&&(console.log(`[FirestoreSignaling] Peer left: ${n}`),this.emit("peerLeft",{peerId:n})))})});this.unsubscribers.push(o)}listenForSignals(){const{collection:e,onSnapshot:t,deleteDoc:i,doc:o}=this.firebase,s=e(this.db,"rooms",this.roomCode,"signals",this.localPeerId,"messages"),a=t(s,n=>{n.docChanges().forEach(async l=>{if(l.type==="added"){const c=l.doc.data(),d=l.doc.id;switch(console.log(`[FirestoreSignaling] Received signal: ${c.type} from ${c.from}`),c.type){case"offer":this.emit("offer",{peerId:c.from,offer:c.payload});break;case"answer":this.emit("answer",{peerId:c.from,answer:c.payload});break;case"ice-candidate":this.emit("iceCandidate",{peerId:c.from,candidate:c.payload});break}const h=o(this.db,"rooms",this.roomCode,"signals",this.localPeerId,"messages",d);await i(h)}})});this.unsubscribers.push(a)}async sendOffer(e,t){await this.sendSignal(e,"offer",t)}async sendAnswer(e,t){await this.sendSignal(e,"answer",t)}async sendIceCandidate(e,t){await this.sendSignal(e,"ice-candidate",t)}async sendSignal(e,t,i){if(!this.db)return;const{collection:o,addDoc:s,serverTimestamp:a}=this.firebase,n=o(this.db,"rooms",this.roomCode,"signals",e,"messages");await s(n,{type:t,from:this.localPeerId,payload:i,timestamp:a()}),console.log(`[FirestoreSignaling] Sent ${t} to ${e}`)}async leaveRoom(){if(!this.db||!this.roomCode)return;const{doc:e,deleteDoc:t,getDoc:i,updateDoc:o}=this.firebase;this.unsubscribers.forEach(l=>l()),this.unsubscribers=[];const s=e(this.db,"rooms",this.roomCode,"peers",this.localPeerId);await t(s);const a=e(this.db,"rooms",this.roomCode),n=await i(a);if(n.exists()){const d=(n.data().peers||[]).filter(h=>h!==this.localPeerId);d.length===0?(await t(a),console.log(`[FirestoreSignaling] Room ${this.roomCode} deleted (empty)`)):await o(a,{peers:d})}this.roomCode="",console.log("[FirestoreSignaling] Left room")}disconnect(){this.leaveRoom(),this.isConnected=!1,this.emit("disconnected",void 0)}generateRoomCode(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let t="";for(let i=0;i<6;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}getLocalPeerId(){return this.localPeerId}getRoomCode(){return this.roomCode}getIsConnected(){return this.isConnected}}class Qi{encoder=new TextEncoder;decoder=new TextDecoder;serialize(e){const t=JSON.stringify(e);return this.encoder.encode(t).buffer}deserialize(e){const t=this.decoder.decode(e);return JSON.parse(t)}serializeInput(e,t){const i=new ArrayBuffer(64),o=new DataView(i);let s=0;o.setUint8(s,R.Input),s+=1,o.setFloat64(s,Date.now()),s+=8;const a=this.encoder.encode(t);o.setUint8(s,a.length),s+=1,new Uint8Array(i,s,a.length).set(a),s+=a.length,o.setFloat32(s,e.moveX),s+=4,o.setFloat32(s,e.moveY),s+=4,o.setFloat32(s,e.aimX),s+=4,o.setFloat32(s,e.aimY),s+=4;let n=0;return e.shoot&&(n|=1),e.reload&&(n|=2),e.interact&&(n|=4),e.ability1&&(n|=8),e.ability2&&(n|=16),e.ultimate&&(n|=32),o.setUint8(s,n),s+=1,o.setUint32(s,e.sequence),s+=4,i.slice(0,s)}deserializeInput(e){try{const t=new DataView(e);let i=0;if(t.getUint8(i)!==R.Input)return null;i+=1;const s=t.getFloat64(i);i+=8;const a=t.getUint8(i);i+=1;const n=this.decoder.decode(new Uint8Array(e,i,a));i+=a;const l=t.getFloat32(i);i+=4;const c=t.getFloat32(i);i+=4;const d=t.getFloat32(i);i+=4;const h=t.getFloat32(i);i+=4;const p=t.getUint8(i);i+=1;const f=t.getUint32(i),g={moveX:l,moveY:c,aimX:d,aimY:h,shoot:(p&1)!==0,reload:(p&2)!==0,interact:(p&4)!==0,ability1:(p&8)!==0,ability2:(p&16)!==0,ultimate:(p&32)!==0,weaponSlot:0,sequence:f};return{senderId:n,input:g,timestamp:s}}catch{return null}}serializeSnapshot(e,t,i,o){const s={type:R.StateSnapshot,timestamp:Date.now(),senderId:"host",data:{tick:e,players:t,projectiles:i,objectives:o}};return this.serialize(s)}}class Me extends Ct{signaling=null;firestoreSignaling=null;peers=new Map;serializer=new Qi;isHost;localPeerId="";roomCode="";useFirestore;pingTimes=new Map;latencies=new Map;constructor(e){super(),this.isHost=e.isHost,this.useFirestore=e.useFirestore??!1}async connect(e){this.signaling=new Zi(e),this.setupSignalingListeners(),await this.signaling.connect(),this.localPeerId=this.signaling.getLocalPeerId(),this.emit("connected",void 0)}async connectWithFirebase(e){this.useFirestore=!0,this.firestoreSignaling=new Ji,this.setupFirestoreListeners(),await this.firestoreSignaling.connect(e),this.localPeerId=this.firestoreSignaling.getLocalPeerId(),this.emit("connected",void 0)}setupSignalingListeners(){this.signaling&&(this.signaling.on("roomCreated",({roomCode:e})=>{this.roomCode=e,console.log(`[Network] Room created: ${e}`),this.emit("roomCreated",{roomCode:e})}),this.signaling.on("roomJoined",({roomCode:e,peers:t})=>{this.roomCode=e,console.log(`[Network] Joined room: ${e}, peers:`,t),this.emit("roomJoined",{roomCode:e});for(const i of t)this.initiateConnection(i)}),this.signaling.on("peerJoined",({peerId:e})=>{console.log(`[Network] Peer joined: ${e}`)}),this.signaling.on("peerLeft",({peerId:e})=>{console.log(`[Network] Peer left: ${e}`),this.removePeer(e)}),this.signaling.on("offer",async({peerId:e,offer:t})=>{console.log(`[Network] Received offer from: ${e}`),await this.handleOffer(e,t)}),this.signaling.on("answer",async({peerId:e,answer:t})=>{console.log(`[Network] Received answer from: ${e}`);const i=this.peers.get(e);i&&await i.handleAnswer(t)}),this.signaling.on("iceCandidate",async({peerId:e,candidate:t})=>{const i=this.peers.get(e);i&&await i.addIceCandidate(t)}),this.signaling.on("error",({message:e})=>{console.error(`[Network] Signaling error: ${e}`),this.emit("error",{message:e})}),this.signaling.on("disconnected",()=>{console.log("[Network] Signaling disconnected"),this.emit("disconnected",void 0)}))}setupFirestoreListeners(){this.firestoreSignaling&&(this.firestoreSignaling.on("roomCreated",({roomCode:e})=>{this.roomCode=e,console.log(`[Network] Room created (Firestore): ${e}`),this.emit("roomCreated",{roomCode:e})}),this.firestoreSignaling.on("roomJoined",({roomCode:e,peers:t})=>{this.roomCode=e,console.log(`[Network] Joined room (Firestore): ${e}`),console.log(`[Network] Existing peers in room: [${t.join(", ")}]`),this.emit("roomJoined",{roomCode:e}),console.log(`[Network] Will initiate connections to ${t.length} peer(s)`);for(const i of t)console.log(`[Network] Initiating connection to peer: ${i}`),this.initiateConnectionFirestore(i)}),this.firestoreSignaling.on("peerJoined",({peerId:e})=>{console.log(`[Network] Peer joined (Firestore): ${e}`)}),this.firestoreSignaling.on("peerLeft",({peerId:e})=>{console.log(`[Network] Peer left (Firestore): ${e}`),this.removePeer(e)}),this.firestoreSignaling.on("offer",async({peerId:e,offer:t})=>{console.log(`[Network] Received offer (Firestore) from: ${e}`),await this.handleOfferFirestore(e,t)}),this.firestoreSignaling.on("answer",async({peerId:e,answer:t})=>{console.log(`[Network] Received answer (Firestore) from: ${e}`);const i=this.peers.get(e);i&&await i.handleAnswer(t)}),this.firestoreSignaling.on("iceCandidate",async({peerId:e,candidate:t})=>{const i=this.peers.get(e);i&&await i.addIceCandidate(t)}),this.firestoreSignaling.on("error",({message:e})=>{console.error(`[Network] Firestore signaling error: ${e}`),this.emit("error",{message:e})}),this.firestoreSignaling.on("disconnected",()=>{console.log("[Network] Firestore signaling disconnected"),this.emit("disconnected",void 0)}))}async initiateConnection(e){const t=new et(e);this.setupPeerListeners(t),this.peers.set(e,t),t.onIceCandidate(o=>{this.signaling?.sendIceCandidate(e,o.toJSON())});const i=await t.createOffer();this.signaling?.sendOffer(e,i)}async handleOffer(e,t){const i=new et(e);this.setupPeerListeners(i),this.peers.set(e,i),i.onIceCandidate(s=>{this.signaling?.sendIceCandidate(e,s.toJSON())});const o=await i.handleOffer(t);this.signaling?.sendAnswer(e,o)}async initiateConnectionFirestore(e){console.log(`[Network] Initiating WebRTC connection to: ${e}`);const t=new et(e);this.setupPeerListeners(t),this.peers.set(e,t),console.log(`[Network] Peer added to map. Total peers: ${this.peers.size}`),t.onIceCandidate(i=>{console.log(`[Network] Sending ICE candidate to: ${e}`),this.firestoreSignaling?.sendIceCandidate(e,i.toJSON())});try{const i=await t.createOffer();console.log(`[Network] Created offer for: ${e}`),await this.firestoreSignaling?.sendOffer(e,i),console.log(`[Network] Sent offer to: ${e}`)}catch(i){console.error(`[Network] Failed to create/send offer to ${e}:`,i)}}async handleOfferFirestore(e,t){console.log(`[Network] Handling offer from: ${e}`);const i=new et(e);this.setupPeerListeners(i),this.peers.set(e,i),console.log(`[Network] Peer added to map from offer. Total peers: ${this.peers.size}`),i.onIceCandidate(o=>{console.log(`[Network] Sending ICE candidate to: ${e}`),this.firestoreSignaling?.sendIceCandidate(e,o.toJSON())});try{const o=await i.handleOffer(t);console.log(`[Network] Created answer for: ${e}`),await this.firestoreSignaling?.sendAnswer(e,o),console.log(`[Network] Sent answer to: ${e}`)}catch(o){console.error(`[Network] Failed to handle offer from ${e}:`,o)}}setupPeerListeners(e){e.on("connected",({peerId:t})=>{console.log(`[Network] Peer connected: ${t}`),this.emit("peerConnected",{peerId:t})}),e.on("disconnected",({peerId:t})=>{console.log(`[Network] Peer disconnected: ${t}`),this.removePeer(t)}),e.on("message",({peerId:t,data:i})=>{this.handleMessage(t,i)}),e.on("error",({peerId:t,error:i})=>{console.error(`[Network] Peer error (${t}):`,i)})}handleMessage(e,t){try{let i;if(t instanceof ArrayBuffer?i=this.serializer.deserialize(t):i=JSON.parse(t),i.type===R.Pong){const o=this.pingTimes.get(e);if(o){const s=performance.now()-o;this.latencies.set(e,s),this.pingTimes.delete(e)}return}if(i.type===R.Ping){this.sendToPeer(e,{type:R.Pong,timestamp:Date.now(),senderId:this.localPeerId,data:null});return}this.emit("packet",{peerId:e,packet:i})}catch(i){console.error(`[Network] Failed to parse message from ${e}:`,i)}}removePeer(e){const t=this.peers.get(e);t&&(t.close(),this.peers.delete(e),this.latencies.delete(e),this.pingTimes.delete(e),this.emit("peerDisconnected",{peerId:e}))}async createRoom(){this.useFirestore&&this.firestoreSignaling?await this.firestoreSignaling.createRoom():this.signaling?.createRoom()}async joinRoom(e){this.useFirestore&&this.firestoreSignaling?await this.firestoreSignaling.joinRoom(e.toUpperCase()):this.signaling?.joinRoom(e.toUpperCase())}leaveRoom(){for(const[e]of this.peers)this.removePeer(e);this.useFirestore&&this.firestoreSignaling?this.firestoreSignaling.leaveRoom():this.signaling?.leaveRoom(),this.roomCode=""}sendToPeer(e,t){const i=this.peers.get(e);if(!i?.getIsConnected())return!1;const o=this.serializer.serialize(t);return i.send(o)}broadcast(e){const t=this.serializer.serialize(e);for(const[,i]of this.peers)i.getIsConnected()&&i.send(t)}sendJson(e,t){const i=this.peers.get(e);return i?.getIsConnected()?i.send(JSON.stringify(t)):!1}broadcastJson(e){const t=JSON.stringify(e);for(const[,i]of this.peers)i.getIsConnected()&&i.send(t)}pingPeers(){const e=performance.now();for(const[t,i]of this.peers)i.getIsConnected()&&(this.pingTimes.set(t,e),this.sendToPeer(t,{type:R.Ping,timestamp:Date.now(),senderId:this.localPeerId,data:null}))}getLatency(e){return this.latencies.get(e)??-1}getAverageLatency(){if(this.latencies.size===0)return-1;let e=0;for(const t of this.latencies.values())e+=t;return e/this.latencies.size}disconnect(){this.leaveRoom(),this.useFirestore&&this.firestoreSignaling?(this.firestoreSignaling.disconnect(),this.firestoreSignaling=null):(this.signaling?.disconnect(),this.signaling=null)}getLocalPeerId(){return this.localPeerId}getRoomCode(){return this.roomCode}getPeerIds(){return Array.from(this.peers.keys())}getPeerCount(){return this.peers.size}getIsHost(){return this.isHost}isConnected(){return this.signaling?.isConnected()??!1}}class Fe{id;name;peerId;team;heroId;position;velocity;rotation;prevPosition;prevRotation;targetPosition=null;targetRotation=null;health;maxHealth;shield;maxShield;alive;respawnTime;credits;kills;deaths;assists;weaponInventory;currentWeaponSlot;weapon;abilities;ultimateCharge;input;lastDamageTime;lastAttackerId;deathTime;isDisconnected;speedMultiplier;isSlowed;isStunned;isInvisible;damageReduction;damageBonus;shieldRegenBonus;fireRateBonus;isFireImmune;healingBonus;constructor(e,t,i,o,s){this.id=J("player"),this.peerId=e,this.name=t,this.team=i,this.heroId=o;const a=X[o];this.position={...s},this.prevPosition={...s},this.velocity=u.zero(),this.rotation=0,this.prevRotation=0,this.maxHealth=a.health,this.health=this.maxHealth,this.maxShield=a.shield,this.shield=this.maxShield,this.alive=!0,this.respawnTime=0,this.credits=U.STARTING_CREDITS,this.kills=0,this.deaths=0,this.assists=0;const n=ue[L.BurstPistol],l={weaponId:L.BurstPistol,ammo:n.ammoCapacity,maxAmmo:n.ammoCapacity,reloading:!1,reloadEndTime:0,lastFireTime:0};this.weaponInventory=[l,null,null,null,null],this.currentWeaponSlot=0,this.weapon=l,this.abilities=a.abilities.map((c,d)=>({abilityIndex:d,cooldownEndTime:0,charges:a.abilities[d]?.charges??1,active:!1,duration:0,ultimateCharge:0})),this.ultimateCharge=0,this.input=this.createEmptyInput(),this.lastDamageTime=0,this.lastAttackerId=null,this.deathTime=0,this.isDisconnected=!1,this.speedMultiplier=a.speed,this.isSlowed=!1,this.isStunned=!1,this.isInvisible=!1,this.damageReduction=0,this.damageBonus=0,this.shieldRegenBonus=0,this.fireRateBonus=0,this.isFireImmune=!1,this.healingBonus=0,this.applyHeroPassives()}applyHeroPassives(){switch(this.heroId){case"spectre":this.damageReduction=.1;break;case"byte":this.shieldRegenBonus=.25;break;case"vanta":this.damageReduction=.15;break;case"katana":this.damageBonus=.1;break;case"glyph":this.damageBonus=.1;break;case"spark":this.isFireImmune=!0,this.fireRateBonus=.1;break;case"zero":this.damageBonus=.15;break;case"mira":this.healingBonus=.25;break}}createEmptyInput(){return{moveX:0,moveY:0,aimX:0,aimY:0,shoot:!1,reload:!1,interact:!1,ability1:!1,ability2:!1,ultimate:!1,weaponSlot:0,sequence:0}}update(e,t){if(this.prevPosition={...this.position},this.prevRotation=this.rotation,!this.alive||this.isStunned)return;const i=u.sub({x:this.input.aimX,y:this.input.aimY},this.position);if(this.rotation=u.angle(i),this.updateMovement(e),this.updateWeapon(t),this.updateAbilities(t),t-this.lastDamageTime>3e3&&this.shield<this.maxShield){const o=.05*(1+this.shieldRegenBonus);this.shield=Math.min(this.maxShield,this.shield+this.maxShield*o*(e/1e3))}}updateMovement(e){let t=U.BASE_SPEED*this.speedMultiplier;this.isSlowed&&(t*=.6);const i=u.normalize({x:this.input.moveX,y:this.input.moveY}),o=u.mul(i,t);if(u.length(o)>0)this.velocity=u.lerp(this.velocity,o,1-Math.exp(-1500*e/1e3));else{const s=1-Math.exp(-800*e/1e3);this.velocity=u.mul(this.velocity,1-s)}this.position=u.add(this.position,u.mul(this.velocity,e/1e3))}updateWeapon(e){if(this.weapon.reloading&&e>=this.weapon.reloadEndTime&&(this.weapon.ammo=this.weapon.maxAmmo,this.weapon.reloading=!1),this.input.reload&&!this.weapon.reloading&&this.weapon.ammo<this.weapon.maxAmmo){const t=ue[this.weapon.weaponId];this.weapon.reloading=!0,this.weapon.reloadEndTime=e+t.reloadTime}}updateAbilities(e){for(const t of this.abilities){t.active&&t.duration>0&&e>=t.duration&&(t.active=!1,t.duration=0);const i=X[this.heroId].abilities[t.abilityIndex];i&&t.charges<i.charges&&e>=t.cooldownEndTime&&(t.charges++,t.charges<i.charges&&(t.cooldownEndTime=e+i.chargeTime))}}getWeaponDefinition(){return ue[this.weapon.weaponId]}getEffectiveFireRate(){return this.getWeaponDefinition().fireRate*(1+this.fireRateBonus)}getEffectiveDamage(){return this.getWeaponDefinition().damage*(1+this.damageBonus)}canFire(e){if(!this.alive||this.weapon.reloading||this.weapon.ammo<=0||this.isStunned)return!1;const t=1e3/this.getEffectiveFireRate();return e>=this.weapon.lastFireTime+t}fire(e){if(this.canFire(e)&&(this.weapon.lastFireTime=e,this.weapon.ammo--,this.weapon.ammo<=0)){const t=ue[this.weapon.weaponId];this.weapon.reloading=!0,this.weapon.reloadEndTime=e+t.reloadTime}}canUseAbility(e,t){if(!this.alive||this.isStunned||e<0||e>=this.abilities.length)return!1;const i=this.abilities[e];if(!i)return!1;const o=X[this.heroId].abilities[e];return!o||o.isUltimate&&this.ultimateCharge<o.ultimateCost?!1:i.charges>0}useAbility(e,t){if(!this.canUseAbility(e,t))return;const i=this.abilities[e],o=X[this.heroId].abilities[e];i.charges--,i.cooldownEndTime=t+o.cooldown,o.duration>0&&(i.active=!0,i.duration=t+o.duration),o.isUltimate&&(this.ultimateCharge=0)}takeDamage(e,t,i,o){if(!this.alive||o==="fire"&&this.isFireImmune)return 0;let s=e*(1-this.damageReduction);if(this.shield>0){const a=Math.min(this.shield,s);this.shield-=a,s-=a}return this.health=Math.max(0,this.health-s),this.lastDamageTime=i,this.lastAttackerId=t,this.health<=0&&this.die(i),e-s}heal(e){if(!this.alive)return 0;const t=e*(1+this.healingBonus),i=Math.min(this.maxHealth-this.health,t);return this.health+=i,i}addShield(e){const t=Math.min(this.maxShield-this.shield,e);return this.shield+=t,t}die(e){this.alive=!1,this.health=0,this.deaths++,this.velocity=u.zero(),this.deathTime=e,this.respawnTime=e+U.ROUND_TIME}respawn(e){this.alive=!0,this.health=this.maxHealth,this.shield=this.maxShield,this.position={...e},this.prevPosition={...e},this.velocity=u.zero(),this.isSlowed=!1,this.isStunned=!1,this.isInvisible=!1;const t=ue[this.weapon.weaponId];this.weapon.ammo=t.ammoCapacity,this.weapon.reloading=!1}resetAbilities(){const e=X[this.heroId];for(let t=0;t<this.abilities.length;t++){const i=this.abilities[t],o=e.abilities[t];i&&o&&(i.cooldownEndTime=0,i.charges=o.charges,i.active=!1,i.duration=0)}}setInput(e){this.input={...e}}switchToWeaponSlot(e){if(e<1||e>5)return!1;const t=e-1,i=this.weaponInventory[t];return!i||this.currentWeaponSlot===t||this.weapon.reloading?!1:(this.currentWeaponSlot=t,this.weapon=i,!0)}cycleWeaponNext(){if(this.weapon.reloading)return!1;for(let e=1;e<=5;e++){const t=(this.currentWeaponSlot+e)%5;if(this.weaponInventory[t])return this.currentWeaponSlot=t,this.weapon=this.weaponInventory[t],!0}return!1}cycleWeaponPrevious(){if(this.weapon.reloading)return!1;for(let e=1;e<=5;e++){const t=(this.currentWeaponSlot-e+5)%5;if(this.weaponInventory[t])return this.currentWeaponSlot=t,this.weapon=this.weaponInventory[t],!0}return!1}getWeaponSlotForId(e){switch(e){case L.BurstPistol:return 1;case L.NeoSMG9:return 2;case L.PulseRifle:return 3;case L.ScatterShot:return 4;case L.RailSniper:return 5;default:return 1}}buyWeapon(e){const t=ue[e];if(this.credits<t.price)return!1;this.credits-=t.price;const i={weaponId:e,ammo:t.ammoCapacity,maxAmmo:t.ammoCapacity,reloading:!1,reloadEndTime:0,lastFireTime:0},s=this.getWeaponSlotForId(e)-1;return this.weaponInventory[s]=i,this.currentWeaponSlot=s,this.weapon=i,!0}getCollisionBody(){return{id:this.id,position:this.position,velocity:this.velocity,collider:{type:je.Circle,offset:{x:0,y:0},radius:16},layer:this.team===m.Attackers?M.PLAYER:M.ENEMY,mask:M.WALL|M.PLAYER|M.ENEMY|M.TRIGGER,isStatic:!1,isTrigger:!1,userData:this}}toState(){return{id:this.id,name:this.name,peerId:this.peerId,team:this.team,heroId:this.heroId,position:{...this.position},velocity:{...this.velocity},rotation:this.rotation,health:this.health,maxHealth:this.maxHealth,shield:this.shield,maxShield:this.maxShield,alive:this.alive,credits:this.credits,kills:this.kills,deaths:this.deaths,assists:this.assists,weapon:{...this.weapon},abilities:this.abilities.map(e=>({...e})),input:{...this.input}}}static fromState(e){const t=new Fe(e.peerId,e.name,e.team,e.heroId,e.position);return t.velocity={...e.velocity},t.rotation=e.rotation,t.health=e.health,t.maxHealth=e.maxHealth,t.shield=e.shield,t.maxShield=e.maxShield,t.alive=e.alive,t.credits=e.credits,t.kills=e.kills,t.deaths=e.deaths,t.assists=e.assists,t.weapon={...e.weapon},t.abilities=e.abilities.map(i=>({...i})),t.input={...e.input},t}}class ct{id;ownerId;position;prevPosition;velocity;damage;lifetime;spawnTime;active;radius;constructor(e,t,i,o,s,a,n){this.id=J("proj"),this.ownerId=e,this.position={...t},this.prevPosition={...t},this.velocity=u.mul(u.normalize(i),o),this.damage=s,this.lifetime=a,this.spawnTime=n,this.active=!0,this.radius=4}update(e,t){this.active&&(this.prevPosition={...this.position},this.position=u.add(this.position,u.mul(this.velocity,e/1e3)),t>=this.spawnTime+this.lifetime&&(this.active=!1))}destroy(){this.active=!1}getCollisionBody(){return{id:this.id,position:this.position,velocity:this.velocity,collider:{type:je.Circle,offset:{x:0,y:0},radius:this.radius},layer:M.PROJECTILE,mask:M.PLAYER|M.ENEMY|M.WALL,isStatic:!1,isTrigger:!0,userData:this}}toState(){return{id:this.id,ownerId:this.ownerId,position:{...this.position},velocity:{...this.velocity},damage:this.damage,lifetime:this.lifetime,spawnTime:this.spawnTime}}static fromState(e){const t=new ct(e.ownerId,e.position,u.normalize(e.velocity),u.length(e.velocity),e.damage,e.lifetime,e.spawnTime);return t.velocity={...e.velocity},t}}class K{data;collisionBodies=[];constructor(e){this.data=e,this.buildCollision()}buildCollision(){for(let e=0;e<this.data.tiles.length;e++){const t=this.data.tiles[e];if(t){for(let i=0;i<t.length;i++)if(t[i]===1){const s={id:J("wall"),position:{x:i*this.data.tileSize,y:e*this.data.tileSize},velocity:{x:0,y:0},collider:{type:je.Box,offset:{x:0,y:0},width:this.data.tileSize,height:this.data.tileSize},layer:M.WALL,mask:M.ALL,isStatic:!0,isTrigger:!1};this.collisionBodies.push(s)}}}for(const e of this.data.props)if(e.collider){const t={id:J("prop"),position:e.position,velocity:{x:0,y:0},collider:{type:je.Box,offset:{x:0,y:0},width:e.collider.width,height:e.collider.height},layer:M.WALL,mask:M.ALL,isStatic:!0,isTrigger:!1};this.collisionBodies.push(t)}}registerCollision(e){for(const t of this.collisionBodies)e.addBody(t)}getSpawnPoints(e){return this.data.spawnPoints.filter(t=>t.team===e)}getSpawnPoint(e,t){const i=this.getSpawnPoints(e),o=i[t%i.length];return o?{...o.position}:{x:0,y:0}}getSpikeSites(){return this.data.spikeSites}isInSpikeSite(e){for(let t=0;t<this.data.spikeSites.length;t++){const i=this.data.spikeSites[t];if(e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height)return t}return-1}getTileAt(e,t){const i=Math.floor(e/this.data.tileSize),o=Math.floor(t/this.data.tileSize);if(o<0||o>=this.data.tiles.length)return 1;const s=this.data.tiles[o];return!s||i<0||i>=s.length?1:s[i]??1}isWalkable(e,t){return this.getTileAt(e,t)===0}getWidth(){return this.data.width}getHeight(){return this.data.height}getTileSize(){return this.data.tileSize}}const ti=[{id:"neon_arena",name:"Neon Arena",description:"Classic symmetrical arena",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"reactor_core",name:"Reactor Core",description:"Circular arena with central cover",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"grid_maze",name:"Grid Maze",description:"Complex maze with many corners",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"neon_tower",name:"Neon Tower",description:"Vertical tower with open floors",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"crossfire",name:"Crossfire",description:"Four-way intersection battle",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"warehouse",name:"Warehouse",description:"Industrial storage facility",hasSpikeSites:!1,recommended:"Deathmatch"},{id:"cyber_district",name:"Cyber District",description:"Urban streets with spike sites",hasSpikeSites:!0,recommended:"Data Spike"},{id:"helix_labs",name:"Helix Labs",description:"Tight corridors and open labs",hasSpikeSites:!0,recommended:"Data Spike"},{id:"sky_bridge",name:"Sky Bridge",description:"Three lanes connected by bridges",hasSpikeSites:!0,recommended:"Data Spike"},{id:"data_vault",name:"Data Vault",description:"Secure vault with multiple entries",hasSpikeSites:!0,recommended:"Data Spike"},{id:"server_farm",name:"Server Farm",description:"High-tech data center",hasSpikeSites:!0,recommended:"Data Spike"},{id:"nexus_hub",name:"Nexus Hub",description:"Central network control room",hasSpikeSites:!0,recommended:"Data Spike"}];function es(r){switch(r){case"neon_arena":return ci();case"cyber_district":return ts();case"helix_labs":return is();case"reactor_core":return ss();case"grid_maze":return os();case"sky_bridge":return ns();case"data_vault":return as();case"neon_tower":return rs();case"crossfire":return ls();case"warehouse":return cs();case"server_farm":return ds();case"nexus_hub":return hs();default:return console.warn(`Unknown map ID: ${r}, falling back to neon_arena`),ci()}}function ci(){const i=[];for(let s=0;s<30;s++){const a=[];for(let n=0;n<40;n++)n===0||n===39||s===0||s===29||n>=18&&n<=21&&s>=13&&s<=16||n>=6&&n<=8&&s>=8&&s<=10||n>=10&&n<=12&&s>=13&&s<=16||n>=6&&n<=8&&s>=19&&s<=21||n>=31&&n<=33&&s>=8&&s<=10||n>=27&&n<=29&&s>=13&&s<=16||n>=31&&n<=33&&s>=19&&s<=21||n>=15&&n<=17&&s===8||n>=22&&n<=24&&s===8||n>=15&&n<=17&&s===21||n>=22&&n<=24&&s===21?a.push(1):a.push(0);i.push(a)}const o={id:"neon_arena",name:"Neon Arena",width:40*32,height:30*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:80,y:240},team:m.Attackers,index:0},{position:{x:80,y:340},team:m.Attackers,index:1},{position:{x:80,y:440},team:m.Attackers,index:2},{position:{x:80,y:540},team:m.Attackers,index:3},{position:{x:1200,y:240},team:m.Defenders,index:0},{position:{x:1200,y:340},team:m.Defenders,index:1},{position:{x:1200,y:440},team:m.Defenders,index:2},{position:{x:1200,y:540},team:m.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new K(o)}function ts(){const i=[];for(let s=0;s<32;s++){const a=[];for(let n=0;n<45;n++)n===0||n===44||s===0||s===31||n>=2&&n<=6&&s>=2&&s<=6||n>=2&&n<=6&&s>=25&&s<=29||n>=38&&n<=42&&s>=2&&s<=6||n>=38&&n<=42&&s>=25&&s<=29||n>=28&&n<=30&&s>=4&&s<=8||n>=34&&n<=36&&s>=8&&s<=10||n>=28&&n<=30&&s>=23&&s<=27||n>=34&&n<=36&&s>=21&&s<=23||n>=14&&n<=16&&s>=12&&s<=14||n>=14&&n<=16&&s>=17&&s<=19||n>=20&&n<=24&&s>=13&&s<=18?a.push(1):a.push(0);i.push(a)}const o={id:"cyber_district",name:"Cyber District",width:45*32,height:32*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:80,y:300},team:m.Attackers,index:0},{position:{x:80,y:400},team:m.Attackers,index:1},{position:{x:80,y:500},team:m.Attackers,index:2},{position:{x:80,y:600},team:m.Attackers,index:3},{position:{x:45*32-100,y:200},team:m.Defenders,index:0},{position:{x:45*32-100,y:300},team:m.Defenders,index:1},{position:{x:45*32-100,y:700},team:m.Defenders,index:2},{position:{x:45*32-100,y:800},team:m.Defenders,index:3}],spikeSites:[{x:960,y:128,width:224,height:160},{x:960,y:32*32-288,width:224,height:160}],reactorPath:[],props:[]};return new K(o)}function is(){const i=[];for(let s=0;s<35;s++){const a=[];for(let n=0;n<50;n++)n===0||n===49||s===0||s===34||n>=3&&n<=10&&s===8||n>=3&&n<=10&&s===16||n===10&&s>=8&&s<=16||n>=3&&n<=10&&s===26||n>=3&&n<=10&&s===18||n===10&&s>=18&&s<=26||n>=18&&n<=20&&s>=10&&s<=12||n>=18&&n<=20&&s>=22&&s<=24||n>=29&&n<=31&&s>=10&&s<=12||n>=29&&n<=31&&s>=22&&s<=24||n>=22&&n<=27&&s>=15&&s<=19||n>=38&&n<=46&&s===5||n>=38&&n<=46&&s===12||n===38&&s>=5&&s<=12||n>=38&&n<=46&&s===29||n>=38&&n<=46&&s===22||n===38&&s>=22&&s<=29?a.push(1):a.push(0);i.push(a)}const o={id:"helix_labs",name:"Helix Labs",width:50*32,height:35*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:64,y:350},team:m.Attackers,index:0},{position:{x:64,y:450},team:m.Attackers,index:1},{position:{x:64,y:550},team:m.Attackers,index:2},{position:{x:64,y:650},team:m.Attackers,index:3},{position:{x:50*32-80,y:250},team:m.Defenders,index:0},{position:{x:50*32-80,y:350},team:m.Defenders,index:1},{position:{x:50*32-80,y:750},team:m.Defenders,index:2},{position:{x:50*32-80,y:850},team:m.Defenders,index:3}],spikeSites:[{x:1248,y:192,width:256,height:192},{x:1248,y:35*32-384,width:256,height:192}],reactorPath:[],props:[]};return new K(o)}function ss(){const i=Math.floor(19),o=Math.floor(38/2),s=[];for(let n=0;n<38;n++){const l=[];for(let c=0;c<38;c++){const d=c-i,h=n-o,p=Math.sqrt(d*d+h*h);if(c===0||c===37||n===0||n===37)l.push(1);else if(c<4&&n<4||c<4&&n>33||c>33&&n<4||c>33&&n>33)l.push(1);else if(p>=4&&p<=6){const g=(Math.atan2(h,d)+Math.PI)/(2*Math.PI)*360,w=g>=355||g<=5||g>=85&&g<=95||g>=175&&g<=185||g>=265&&g<=275;l.push(w?0:1)}else if(p>=10&&p<=11){const g=(Math.atan2(h,d)+Math.PI)/(2*Math.PI)*360,w=g>=40&&g<=50||g>=130&&g<=140||g>=220&&g<=230||g>=310&&g<=320;l.push(w?1:0)}else l.push(0)}s.push(l)}const a={id:"reactor_core",name:"Reactor Core",width:38*32,height:38*32,tileSize:32,tiles:s,spawnPoints:[{position:{x:100,y:o*32-80},team:m.Attackers,index:0},{position:{x:100,y:o*32},team:m.Attackers,index:1},{position:{x:100,y:o*32+80},team:m.Attackers,index:2},{position:{x:150,y:o*32+160},team:m.Attackers,index:3},{position:{x:38*32-100,y:o*32-80},team:m.Defenders,index:0},{position:{x:38*32-100,y:o*32},team:m.Defenders,index:1},{position:{x:38*32-100,y:o*32+80},team:m.Defenders,index:2},{position:{x:38*32-150,y:o*32+160},team:m.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new K(a)}function os(){const i=[];for(let s=0;s<32;s++){const a=[];for(let n=0;n<42;n++)n===0||n===41||s===0||s===31?a.push(1):n%6===3&&s>2&&s<29?s>=7&&s<=9||s>=14&&s<=16||s>=22&&s<=24?a.push(0):a.push(1):s===7&&n>1&&n<40&&n%6!==0||s===16&&n>1&&n<40&&n%6!==3||s===24&&n>1&&n<40&&n%6!==0||n>=8&&n<=10&&s>=11&&s<=13||n>=20&&n<=22&&s>=11&&s<=13||n>=31&&n<=33&&s>=11&&s<=13||n>=14&&n<=16&&s>=19&&s<=21||n>=26&&n<=28&&s>=19&&s<=21?a.push(1):a.push(0);i.push(a)}const o={id:"grid_maze",name:"Grid Maze",width:42*32,height:32*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:64,y:150},team:m.Attackers,index:0},{position:{x:64,y:350},team:m.Attackers,index:1},{position:{x:64,y:550},team:m.Attackers,index:2},{position:{x:64,y:750},team:m.Attackers,index:3},{position:{x:42*32-64,y:150},team:m.Defenders,index:0},{position:{x:42*32-64,y:350},team:m.Defenders,index:1},{position:{x:42*32-64,y:550},team:m.Defenders,index:2},{position:{x:42*32-64,y:750},team:m.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new K(o)}function ns(){const i=[];for(let s=0;s<36;s++){const a=[];for(let n=0;n<48;n++)n===0||n===47||s===0||s===35?a.push(1):s===8&&n>3&&n<44||s===27&&n>3&&n<44?n>=14&&n<=16||n>=31&&n<=33?a.push(0):a.push(1):n>=10&&n<=12&&s>=16&&s<=19||n>=22&&n<=25&&s>=15&&s<=20||n>=35&&n<=37&&s>=16&&s<=19||n>=38&&n<=44&&s===3||n===38&&s>=3&&s<=7||n>=38&&n<=44&&s===32||n===38&&s>=28&&s<=32||n===6&&(s>=10&&s<=14||s>=21&&s<=25)?a.push(1):a.push(0);i.push(a)}const o={id:"sky_bridge",name:"Sky Bridge",width:48*32,height:36*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:80,y:180},team:m.Attackers,index:0},{position:{x:80,y:400},team:m.Attackers,index:1},{position:{x:80,y:620},team:m.Attackers,index:2},{position:{x:80,y:900},team:m.Attackers,index:3},{position:{x:48*32-80,y:180},team:m.Defenders,index:0},{position:{x:48*32-80,y:400},team:m.Defenders,index:1},{position:{x:48*32-80,y:620},team:m.Defenders,index:2},{position:{x:48*32-80,y:900},team:m.Defenders,index:3}],spikeSites:[{x:1248,y:96,width:192,height:160},{x:1248,y:36*32-256,width:192,height:160}],reactorPath:[],props:[]};return new K(o)}function as(){const i=[];for(let s=0;s<34;s++){const a=[];for(let n=0;n<44;n++)n===0||n===43||s===0||s===33?a.push(1):n===24&&s>=4&&s<=29?s>=8&&s<=10||s>=16&&s<=17||s>=23&&s<=25?a.push(0):a.push(1):s===4&&n>=24&&n<43||s===29&&n>=24&&n<43?a.push(1):n===32&&s>=6&&s<=13?s>=9&&s<=10?a.push(0):a.push(1):n===32&&s>=20&&s<=27?s>=22&&s<=23?a.push(0):a.push(1):s===6&&n>=32&&n<=40||s===13&&n>=32&&n<=40||s===20&&n>=32&&n<=40||s===27&&n>=32&&n<=40||n>=6&&n<=8&&s>=8&&s<=11||n>=12&&n<=14&&s>=14&&s<=19||n>=6&&n<=8&&s>=22&&s<=25||n>=16&&n<=18&&s>=8&&s<=10||n>=16&&n<=18&&s>=23&&s<=25?a.push(1):a.push(0);i.push(a)}const o={id:"data_vault",name:"Data Vault",width:44*32,height:34*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:64,y:200},team:m.Attackers,index:0},{position:{x:64,y:400},team:m.Attackers,index:1},{position:{x:64,y:600},team:m.Attackers,index:2},{position:{x:64,y:800},team:m.Attackers,index:3},{position:{x:44*32-80,y:300},team:m.Defenders,index:0},{position:{x:44*32-80,y:450},team:m.Defenders,index:1},{position:{x:44*32-80,y:600},team:m.Defenders,index:2},{position:{x:44*32-80,y:750},team:m.Defenders,index:3}],spikeSites:[{x:1056,y:224,width:224,height:192},{x:1056,y:34*32-416,width:224,height:192}],reactorPath:[],props:[]};return new K(o)}function rs(){const i=[];for(let s=0;s<40;s++){const a=[];for(let n=0;n<36;n++)n===0||n===35||s===0||s===39||s===8&&n>=4&&n<=14||s===8&&n>=21&&n<=31?a.push(1):s===16&&n>=8&&n<=27?n>=16&&n<=19?a.push(0):a.push(1):s===24&&n>=4&&n<=31?n>=10&&n<=12||n>=23&&n<=25?a.push(0):a.push(1):s===32&&n>=8&&n<=27?n>=16&&n<=19?a.push(0):a.push(1):n===8&&s>=10&&s<=14||n===27&&s>=10&&s<=14||n===12&&s>=26&&s<=30||n===23&&s>=26&&s<=30||n>=15&&n<=20&&s>=18&&s<=22||n>=3&&n<=5&&s>=3&&s<=5||n>=30&&n<=32&&s>=3&&s<=5||n>=3&&n<=5&&s>=34&&s<=36||n>=30&&n<=32&&s>=34&&s<=36?a.push(1):a.push(0);i.push(a)}const o={id:"neon_tower",name:"Neon Tower",width:36*32,height:40*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:100,y:100},team:m.Attackers,index:0},{position:{x:200,y:100},team:m.Attackers,index:1},{position:{x:100,y:200},team:m.Attackers,index:2},{position:{x:200,y:200},team:m.Attackers,index:3},{position:{x:36*32-100,y:40*32-100},team:m.Defenders,index:0},{position:{x:36*32-200,y:40*32-100},team:m.Defenders,index:1},{position:{x:36*32-100,y:40*32-200},team:m.Defenders,index:2},{position:{x:36*32-200,y:40*32-200},team:m.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new K(o)}function ls(){const i=Math.floor(20),o=Math.floor(40/2),s=[];for(let n=0;n<40;n++){const l=[];for(let c=0;c<40;c++)c===0||c===39||n===0||n===39?l.push(1):c>=3&&c<=10&&n>=3&&n<=10?c===10&&n>=6&&n<=8||n===10&&c>=6&&c<=8?l.push(0):l.push(1):c>=29&&c<=36&&n>=3&&n<=10?c===29&&n>=6&&n<=8||n===10&&c>=31&&c<=33?l.push(0):l.push(1):c>=3&&c<=10&&n>=29&&n<=36?c===10&&n>=31&&n<=33||n===29&&c>=6&&c<=8?l.push(0):l.push(1):c>=29&&c<=36&&n>=29&&n<=36?c===29&&n>=31&&n<=33||n===29&&c>=31&&c<=33?l.push(0):l.push(1):c>=i-2&&c<=i+2&&n>=o-1&&n<=o+1||c>=i-1&&c<=i+1&&n>=o-2&&n<=o+2?l.push(1):l.push(0);s.push(l)}const a={id:"crossfire",name:"Crossfire",width:40*32,height:40*32,tileSize:32,tiles:s,spawnPoints:[{position:{x:64,y:o*32-50},team:m.Attackers,index:0},{position:{x:64,y:o*32+50},team:m.Attackers,index:1},{position:{x:100,y:o*32-100},team:m.Attackers,index:2},{position:{x:100,y:o*32+100},team:m.Attackers,index:3},{position:{x:40*32-64,y:o*32-50},team:m.Defenders,index:0},{position:{x:40*32-64,y:o*32+50},team:m.Defenders,index:1},{position:{x:40*32-100,y:o*32-100},team:m.Defenders,index:2},{position:{x:40*32-100,y:o*32+100},team:m.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new K(a)}function cs(){const i=[];for(let s=0;s<32;s++){const a=[];for(let n=0;n<44;n++)n===0||n===43||s===0||s===31||s>=5&&s<=7&&(n>=8&&n<=10||n>=16&&n<=18||n>=24&&n<=26||n>=32&&n<=34)||s>=12&&s<=14&&(n>=5&&n<=7||n>=13&&n<=15||n>=21&&n<=23||n>=29&&n<=31||n>=37&&n<=39)||s>=19&&s<=21&&(n>=8&&n<=10||n>=16&&n<=18||n>=24&&n<=26||n>=32&&n<=34)||s>=26&&s<=28&&(n>=5&&n<=7||n>=13&&n<=15||n>=21&&n<=23||n>=29&&n<=31||n>=37&&n<=39)?a.push(1):a.push(0);i.push(a)}const o={id:"warehouse",name:"Warehouse",width:44*32,height:32*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:64,y:160},team:m.Attackers,index:0},{position:{x:64,y:320},team:m.Attackers,index:1},{position:{x:64,y:480},team:m.Attackers,index:2},{position:{x:64,y:640},team:m.Attackers,index:3},{position:{x:44*32-64,y:160},team:m.Defenders,index:0},{position:{x:44*32-64,y:320},team:m.Defenders,index:1},{position:{x:44*32-64,y:480},team:m.Defenders,index:2},{position:{x:44*32-64,y:640},team:m.Defenders,index:3}],spikeSites:[],reactorPath:[],props:[]};return new K(o)}function ds(){const i=[];for(let s=0;s<36;s++){const a=[];for(let n=0;n<48;n++)n===0||n===47||s===0||s===35?a.push(1):n===10&&s>=4&&s<=31?s>=10&&s<=12||s>=22&&s<=24?a.push(0):a.push(1):n===18&&s>=4&&s<=31||n===28&&s>=4&&s<=31?s>=15&&s<=19?a.push(0):a.push(1):n===36&&s>=4&&s<=31?s>=10&&s<=12||s>=22&&s<=24?a.push(0):a.push(1):s===5&&n>=38&&n<=44||n===38&&s>=5&&s<=12||s===30&&n>=38&&n<=44||n===38&&s>=23&&s<=30?a.push(1):a.push(0);i.push(a)}const o={id:"server_farm",name:"Server Farm",width:48*32,height:36*32,tileSize:32,tiles:i,spawnPoints:[{position:{x:80,y:200},team:m.Attackers,index:0},{position:{x:80,y:400},team:m.Attackers,index:1},{position:{x:80,y:600},team:m.Attackers,index:2},{position:{x:80,y:800},team:m.Attackers,index:3},{position:{x:48*32-80,y:280},team:m.Defenders,index:0},{position:{x:48*32-80,y:450},team:m.Defenders,index:1},{position:{x:48*32-80,y:620},team:m.Defenders,index:2},{position:{x:48*32-80,y:790},team:m.Defenders,index:3}],spikeSites:[{x:1248,y:192,width:192,height:192},{x:1248,y:36*32-384,width:192,height:192}],reactorPath:[],props:[]};return new K(o)}function hs(){const i=Math.floor(23),o=Math.floor(38/2),s=[];for(let n=0;n<38;n++){const l=[];for(let c=0;c<46;c++)c===0||c===45||n===0||n===37?l.push(1):c>=i-5&&c<=i+5&&(n===o-4||n===o+4)||n>=o-4&&n<=o+4&&(c===i-5||c===i+5)?n===o&&(c===i-5||c===i+5)||c===i&&(n===o-4||n===o+4)?l.push(0):l.push(1):c>=6&&c<=8&&n>=12&&n<=14||c>=6&&c<=8&&n>=23&&n<=25?l.push(1):c===32&&n>=4&&n<=12||n===4&&c>=32&&c<=42||n===12&&c>=32&&c<=42?c===32&&n>=7&&n<=9?l.push(0):l.push(1):c===32&&n>=25&&n<=33||n===33&&c>=32&&c<=42||n===25&&c>=32&&c<=42?c===32&&n>=28&&n<=30?l.push(0):l.push(1):l.push(0);s.push(l)}const a={id:"nexus_hub",name:"Nexus Hub",width:46*32,height:38*32,tileSize:32,tiles:s,spawnPoints:[{position:{x:80,y:300},team:m.Attackers,index:0},{position:{x:80,y:450},team:m.Attackers,index:1},{position:{x:80,y:600},team:m.Attackers,index:2},{position:{x:80,y:750},team:m.Attackers,index:3},{position:{x:46*32-80,y:250},team:m.Defenders,index:0},{position:{x:46*32-80,y:400},team:m.Defenders,index:1},{position:{x:46*32-80,y:700},team:m.Defenders,index:2},{position:{x:46*32-80,y:850},team:m.Defenders,index:3}],spikeSites:[{x:1056,y:160,width:288,height:224},{x:1056,y:38*32-384,width:288,height:224}],reactorPath:[],props:[]};return new K(a)}var Y=(r=>(r.RuleBased="rule_based",r.SLM="slm",r))(Y||{}),H=(r=>(r.Aggressive="aggressive",r.Defensive="defensive",r.Flanking="flanking",r.Supporting="supporting",r.Objective="objective",r.Retreating="retreating",r.Patrolling="patrolling",r))(H||{});const us={aggressionLevel:.6,reactionTime:200,accuracy:.6,patrolRadius:300,sightRange:500,attackRange:400};class ms{type=Y.RuleBased;player;config;state="patrol";currentContext=null;currentObjectives;targetPosition=null;patrolCenter;lastPatrolChange=0;patrolInterval=3e3;targetEnemy=null;lastSeenEnemy=0;lastStateChange=0;lastPosition;stuckTime=0;spikePosition=null;spikeSitePosition=null;followTarget=null;collisionWorld=null;nearbyBots=[];randomOffset;tacticalIntent=null;cachedVisibleEnemies=[];constructor(e,t={}){this.player=e,this.config={...us,...t},this.patrolCenter={...e.position},this.lastPosition={...e.position},this.randomOffset=Math.random()*1e3,this.patrolInterval=2e3+Math.random()*3e3}update(e){return this.currentContext=e,this.currentObjectives=e.objectives,this.collisionWorld=e.collisionWorld,this.updateInternal(e.dt,e.time,e.allPlayers,e.collisionWorld,e.map,e.objectives)}getPlayer(){return this.player}getStateInfo(){const e=this.currentContext?.map,t=this.player.abilities[1],i=this.player.abilities[2],o={botId:this.player.id,position:{...this.player.position},health:this.player.health,shield:this.player.shield,team:this.player.team===m.Attackers?"attackers":"defenders",isAlive:this.player.alive,ammo:this.player.weapon.ammo,maxAmmo:this.player.weapon.maxAmmo,isReloading:this.player.weapon.reloading,weaponName:this.player.weapon.weaponId,ability1Ready:t!==void 0&&t.charges>0,ability2Ready:i!==void 0&&i.charges>0,ultimateReady:this.player.ultimateCharge>=100,ultimateCharge:this.player.ultimateCharge,visibleEnemies:this.cachedVisibleEnemies.map(s=>({id:s.id,position:{...s.position},health:s.health,distance:u.distance(this.player.position,s.position)})),nearbyTeammates:this.nearbyBots.filter(s=>s.team===this.player.team).map(s=>({id:s.id,position:{...s.position},health:s.health,distance:u.distance(this.player.position,s.position)})),hasSpikeCarrier:this.currentObjectives?.spikeCarrierId===this.player.id,spikePlanted:this.currentObjectives?.spikePlanted||!1,inSpikeSite:e?e.isInSpikeSite(this.player.position)!==-1:!1,distanceToNearestWall:this.getDistanceToNearestWall(),currentZone:this.getCurrentZone()};return this.currentObjectives?.spikePosition&&(o.spikePosition=this.currentObjectives.spikePosition),o}setTacticalIntent(e){this.tacticalIntent=e,this.mapIntentToState(e)}getTacticalIntent(){return this.tacticalIntent}onRoundStart(){this.state="patrol",this.tacticalIntent=null,this.patrolCenter={...this.player.position},this.targetEnemy=null,this.followTarget=null}onRoundEnd(){this.tacticalIntent=null}dispose(){}getDistanceToNearestWall(){if(!this.collisionWorld)return 999;const e=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:.707,y:.707},{x:-.707,y:.707},{x:.707,y:-.707},{x:-.707,y:-.707}];let t=999;for(const i of e){const o=this.collisionWorld.raycast(this.player.position,i,200,M.WALL);o&&o.distance<t&&(t=o.distance)}return t}getCurrentZone(){const e=this.currentContext?.map;if(!e)return"unknown";const t=e.isInSpikeSite(this.player.position);if(t===0)return"site_a";if(t===1)return"site_b";const i=e.getWidth(),o=e.getHeight(),s=this.player.position.x/i,a=this.player.position.y/o;return s<.3?"left":s>.7?"right":a<.3?"top":a>.7?"bottom":"mid"}mapIntentToState(e){switch(e){case H.Aggressive:this.state="chase";break;case H.Retreating:this.state="retreat";break;case H.Defensive:this.state="patrol";break;case H.Flanking:this.state="patrol";break;case H.Supporting:this.state="follow";break;case H.Objective:this.player.team===m.Attackers?this.state="plant_spike":this.state="defuse";break;case H.Patrolling:default:this.state="patrol";break}}updateInternal(e,t,i,o,s,a){this.collisionWorld=o,this.checkStuck(e);const n=i.filter(p=>p.team!==this.player.team&&p.alive),l=i.filter(p=>p.team===this.player.team&&p.alive&&p.id!==this.player.id);this.nearbyBots=i.filter(p=>p.alive&&p.id!==this.player.id&&u.distance(this.player.position,p.position)<80);const c=this.findVisibleEnemies(n,o);this.cachedVisibleEnemies=c,this.findFollowTarget(l,a);const d=this.checkSpikeState(a);d?this.setState(d,t):c.length===0&&this.followTarget&&this.player.team===m.Attackers?this.setState("follow",t):this.updateState(t,c);const h=this.generateInput(t,c,o);return this.lastPosition={...this.player.position},h}findFollowTarget(e,t){if(e.length===0){this.followTarget=null;return}if(t?.spikeCarrierId){const s=e.find(a=>a.id===t.spikeCarrierId);if(s){this.followTarget=s;return}}let i=null,o=1/0;for(const s of e){const a=u.distance(this.player.position,s.position);a<o&&(o=a,i=s)}this.followTarget=i}checkStuck(e){u.distance(this.player.position,this.lastPosition)<1?(this.stuckTime+=e,this.stuckTime>1e3&&(this.targetPosition=this.getRandomPatrolPoint(),this.stuckTime=0)):this.stuckTime=0}findVisibleEnemies(e,t){const i=[];for(const o of e){if(!o.alive||o.team===this.player.team||o.isInvisible)continue;const s=u.distance(this.player.position,o.position);if(s>this.config.sightRange)continue;const a=u.normalize(u.sub(o.position,this.player.position)),n=t.raycast(this.player.position,a,s,M.WALL);n&&n.distance<s-20||i.push(o)}return i}updateState(e,t){const i=e-this.lastStateChange;t.length>0?(t.sort((s,a)=>u.distance(this.player.position,s.position)-u.distance(this.player.position,a.position)),this.targetEnemy=t[0],this.lastSeenEnemy=e,u.distance(this.player.position,this.targetEnemy.position)<=this.config.attackRange?this.player.health<30&&this.config.aggressionLevel<.8?this.setState("retreat",e):this.setState("attack",e):this.config.aggressionLevel>.4?this.setState("chase",e):this.setState("attack",e)):(this.targetEnemy=null,e-this.lastSeenEnemy<2e3||i>2e3&&this.setState("patrol",e))}setState(e,t){this.state!==e&&(this.state=e,this.lastStateChange=t)}generateInput(e,t,i){const o={moveX:0,moveY:0,aimX:this.player.position.x+Math.cos(this.player.rotation)*100,aimY:this.player.position.y+Math.sin(this.player.rotation)*100,shoot:!1,reload:!1,interact:!1,ability1:!1,ability2:!1,ultimate:!1,weaponSlot:0,sequence:0};switch(this.state){case"patrol":this.doPatrol(e,o);break;case"chase":this.doChase(o);break;case"attack":this.doAttack(e,o,t);break;case"retreat":this.doRetreat(o);break;case"defuse":this.doDefuse(o,this.spikePosition);break;case"plant_spike":this.doPlantSpike(o,this.spikeSitePosition);break;case"follow":this.doFollow(o);break}return this.player.weapon.ammo===0&&!this.player.weapon.reloading&&(o.reload=!0),this.applySeparation(o),o}applySeparation(e){if(this.nearbyBots.length===0)return;let t=0,i=0;for(const o of this.nearbyBots){const s=u.distance(this.player.position,o.position);if(s<5)continue;const a=u.normalize(u.sub(this.player.position,o.position)),n=Math.max(0,(80-s)/80);t+=a.x*n,i+=a.y*n}if(t!==0||i!==0){const o=Math.sqrt(t*t+i*i);if(o>0){e.moveX+=t/o*.5,e.moveY+=i/o*.5;const a=Math.sqrt(e.moveX*e.moveX+e.moveY*e.moveY);a>1&&(e.moveX/=a,e.moveY/=a)}}}doPatrol(e,t){if((!this.targetPosition||e-this.lastPatrolChange>this.patrolInterval)&&(this.targetPosition=this.getRandomPatrolPoint(),this.lastPatrolChange=e),this.moveToward(this.targetPosition,t),t.moveX!==0||t.moveY!==0){const i=Math.atan2(t.moveY,t.moveX);t.aimX=this.player.position.x+Math.cos(i)*100,t.aimY=this.player.position.y+Math.sin(i)*100}}doChase(e){this.targetEnemy&&(this.moveToward(this.targetEnemy.position,e),e.aimX=this.targetEnemy.position.x,e.aimY=this.targetEnemy.position.y)}doAttack(e,t,i){if(!this.targetEnemy||i.length===0)return;const o=u.distance(this.player.position,this.targetEnemy.position),s=Math.sin(e/500)*.7,a=u.normalize(u.sub(this.targetEnemy.position,this.player.position)),n={x:-a.y,y:a.x};t.moveX=n.x*s,t.moveY=n.y*s,o>this.config.attackRange*.8?(t.moveX+=a.x*.5,t.moveY+=a.y*.5):o<100&&(t.moveX-=a.x*.5,t.moveY-=a.y*.5);const l=Math.sqrt(t.moveX*t.moveX+t.moveY*t.moveY);l>1&&(t.moveX/=l,t.moveY/=l);const c=(1-this.config.accuracy)*50;t.aimX=this.targetEnemy.position.x+(Math.random()-.5)*c,t.aimY=this.targetEnemy.position.y+(Math.random()-.5)*c,!this.player.weapon.reloading&&this.player.weapon.ammo>0&&e-this.lastSeenEnemy>this.config.reactionTime&&(t.shoot=!0)}doRetreat(e){if(!this.targetEnemy)this.moveToward(this.patrolCenter,e);else{const t=u.normalize(u.sub(this.player.position,this.targetEnemy.position));e.moveX=t.x,e.moveY=t.y,e.aimX=this.targetEnemy.position.x,e.aimY=this.targetEnemy.position.y,!this.player.weapon.reloading&&this.player.weapon.ammo>0&&(e.shoot=!0)}}moveToward(e,t){const i=u.sub(e,this.player.position);if(u.length(i)>10){let s=u.normalize(i);if(this.collisionWorld){const n=this.collisionWorld.raycast(this.player.position,s,50,M.WALL);if(n&&n.distance<50){const l={x:-s.y,y:s.x},c={x:s.y,y:-s.x},d=this.collisionWorld.raycast(this.player.position,l,50,M.WALL),h=this.collisionWorld.raycast(this.player.position,c,50,M.WALL),p=d?d.distance:50,f=h?h.distance:50;p>f&&p>20?s=u.normalize({x:s.x*.3+l.x*.7,y:s.y*.3+l.y*.7}):f>20&&(s=u.normalize({x:s.x*.3+c.x*.7,y:s.y*.3+c.y*.7}))}}t.moveX=s.x,t.moveY=s.y}}getRandomPatrolPoint(){const e=Date.now()+this.randomOffset,t=(Math.random()+e%1e3/1e3)*Math.PI*2,i=(Math.random()*.5+.5)*this.config.patrolRadius,o=(this.player.id.charCodeAt(0)+this.player.id.charCodeAt(this.player.id.length-1))%360,s=t+o*Math.PI/180;return{x:this.patrolCenter.x+Math.cos(s)*i,y:this.patrolCenter.y+Math.sin(s)*i}}checkSpikeState(e){if(!e)return null;if(this.player.team===m.Defenders&&e.spikePlanted&&e.spikePosition){const t=u.distance(this.player.position,e.spikePosition);if(this.spikePosition=e.spikePosition,t<=60||t>60&&(!this.targetEnemy||u.distance(this.player.position,this.targetEnemy.position)>150))return"defuse"}return this.player.team===m.Attackers&&e.spikeCarrierId===this.player.id?(this.spikeSitePosition={x:600,y:400},"plant_spike"):null}doDefuse(e,t){if(!t)return;u.distance(this.player.position,t)>50?(this.moveToward(t,e),e.aimX=t.x,e.aimY=t.y):(e.interact=!0,e.moveX=0,e.moveY=0,e.aimX=t.x+Math.cos(Date.now()/500)*100,e.aimY=t.y+Math.sin(Date.now()/500)*100)}doPlantSpike(e,t){if(!t)return;if(u.distance(this.player.position,t)>80){this.moveToward(t,e);const o=u.normalize(u.sub(t,this.player.position));e.aimX=this.player.position.x+o.x*100,e.aimY=this.player.position.y+o.y*100}else e.interact=!0,e.moveX=0,e.moveY=0}doFollow(e){if(!this.followTarget)return;if(u.distance(this.player.position,this.followTarget.position)>120){const i=u.normalize(u.sub(this.followTarget.position,this.player.position)),o=(this.player.id.charCodeAt(0)%3-1)*.3,s={x:-i.y*o,y:i.x*o};e.moveX=i.x+s.x,e.moveY=i.y+s.y;const a=Math.sqrt(e.moveX*e.moveX+e.moveY*e.moveY);a>1&&(e.moveX/=a,e.moveY/=a),e.aimX=this.player.position.x+i.x*100,e.aimY=this.player.position.y+i.y*100}else{e.moveX=0,e.moveY=0;const i={x:Math.cos(this.followTarget.rotation),y:Math.sin(this.followTarget.rotation)};e.aimX=this.player.position.x+i.x*100,e.aimY=this.player.position.y+i.y*100}}}class fs{type=Y.SLM;player;tacticalIntent=H.Defensive;constructor(e){this.player=e,console.log(`[SLMBotController] Created for player ${e.id} (stub mode)`)}update(e){return this.generateFallbackInput(e)}getPlayer(){return this.player}getStateInfo(){return{botId:this.player.id,position:{...this.player.position},health:this.player.health,shield:this.player.shield,team:this.player.team===m.Attackers?"attackers":"defenders",isAlive:this.player.alive,ammo:this.player.weapon.ammo,maxAmmo:this.player.weapon.maxAmmo,isReloading:this.player.weapon.reloading,weaponName:this.player.weapon.weaponId,ability1Ready:!1,ability2Ready:!1,ultimateReady:this.player.ultimateCharge>=100,ultimateCharge:this.player.ultimateCharge,visibleEnemies:[],nearbyTeammates:[],hasSpikeCarrier:!1,spikePlanted:!1,inSpikeSite:!1,distanceToNearestWall:0,currentZone:"unknown"}}setTacticalIntent(e){this.tacticalIntent=e}getTacticalIntent(){return this.tacticalIntent}destroy(){console.log(`[SLMBotController] Destroyed for player ${this.player.id}`)}async initializeSLM(){return console.log("[SLMBotController] SLM initialization not yet implemented"),!1}async querySLM(e){return H.Defensive}formatPrompt(e){return JSON.stringify({pos:[Math.round(e.position.x),Math.round(e.position.y)],hp:e.health,team:e.team==="attackers"?"a":"d",ammo:e.ammo,enemies:e.visibleEnemies.length,spike:e.hasSpikeCarrier?"carry":e.spikePlanted?"planted":"none"})}parseResponse(e){const t=e.toLowerCase().trim();return t.includes("attack")||t.includes("aggress")?H.Aggressive:t.includes("defend")||t.includes("hold")?H.Defensive:t.includes("flank")?H.Flanking:t.includes("support")||t.includes("follow")?H.Supporting:t.includes("plant")||t.includes("defuse")||t.includes("objective")?H.Objective:H.Defensive}generateFallbackInput(e){const t=e.time;return{moveX:0,moveY:0,aimX:this.player.position.x+Math.cos(t*.001)*100,aimY:this.player.position.y+Math.sin(t*.001)*100,shoot:!1,reload:!1,ability1:!1,ability2:!1,ultimate:!1,interact:!1,weaponSlot:0,sequence:0}}}class st{static currentMode=Y.RuleBased;static slmAvailable=!1;static create(e,t){return this.currentMode===Y.SLM&&this.slmAvailable?new fs(e):(this.currentMode===Y.SLM&&console.warn("[BotControllerFactory] SLM not available, falling back to rule-based"),new ms(e,t))}static getMode(){return this.currentMode}static setMode(e){console.log(`[BotControllerFactory] AI mode set to: ${e}`),this.currentMode=e}static isSLMAvailable(){return this.slmAvailable}static setSLMAvailable(e){this.slmAvailable=e,console.log(`[BotControllerFactory] SLM availability: ${e}`)}static getModeName(){switch(this.currentMode){case Y.SLM:return"SLM (AI Language Model)";case Y.RuleBased:default:return"Rule-Based (Classic)"}}static cycleMode(){return this.currentMode===Y.RuleBased&&this.slmAvailable?this.currentMode=Y.SLM:this.currentMode=Y.RuleBased,console.log(`[BotControllerFactory] Cycled to: ${this.getModeName()}`),this.currentMode}}var E=(r=>(r.Poison="poison",r.Burn="burn",r.Bleed="bleed",r.Regen="regen",r.HealBurst="heal_burst",r.Stun="stun",r.Slow="slow",r.Root="root",r.Silence="silence",r.Blind="blind",r.Shield="shield",r.DamageReduction="damage_reduction",r.Immunity="immunity",r.FrontShield="front_shield",r.DamageBoost="damage_boost",r.FireRateBoost="fire_rate_boost",r.CritBoost="crit_boost",r.SpeedBoost="speed_boost",r.SpeedReduction="speed_reduction",r.Cloak="cloak",r.Revealed="revealed",r.Marked="marked",r.Invulnerable="invulnerable",r.Phased="phased",r))(E||{});const ze={poison:{type:"poison",category:"debuff",stackBehavior:"stack",maxStacks:5,priority:10,cleansable:!0,dispellable:!0},burn:{type:"burn",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:10,cleansable:!0,dispellable:!0},bleed:{type:"bleed",category:"debuff",stackBehavior:"stack",maxStacks:3,priority:10,cleansable:!1,dispellable:!0},regen:{type:"regen",category:"buff",stackBehavior:"replace",maxStacks:1,priority:5,cleansable:!1,dispellable:!0},heal_burst:{type:"heal_burst",category:"buff",stackBehavior:"none",maxStacks:1,priority:100,cleansable:!1,dispellable:!1},stun:{type:"stun",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:90,cleansable:!0,dispellable:!0},slow:{type:"slow",category:"debuff",stackBehavior:"replace",maxStacks:1,priority:50,cleansable:!0,dispellable:!0},root:{type:"root",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:85,cleansable:!0,dispellable:!0},silence:{type:"silence",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:80,cleansable:!0,dispellable:!0},blind:{type:"blind",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:60,cleansable:!0,dispellable:!0},shield:{type:"shield",category:"buff",stackBehavior:"replace",maxStacks:1,priority:95,cleansable:!1,dispellable:!0},damage_reduction:{type:"damage_reduction",category:"buff",stackBehavior:"replace",maxStacks:1,priority:94,cleansable:!1,dispellable:!0},immunity:{type:"immunity",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:99,cleansable:!1,dispellable:!1},front_shield:{type:"front_shield",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:93,cleansable:!1,dispellable:!0},damage_boost:{type:"damage_boost",category:"buff",stackBehavior:"replace",maxStacks:1,priority:40,cleansable:!1,dispellable:!0},fire_rate_boost:{type:"fire_rate_boost",category:"buff",stackBehavior:"replace",maxStacks:1,priority:40,cleansable:!1,dispellable:!0},crit_boost:{type:"crit_boost",category:"buff",stackBehavior:"replace",maxStacks:1,priority:40,cleansable:!1,dispellable:!0},speed_boost:{type:"speed_boost",category:"buff",stackBehavior:"replace",maxStacks:1,priority:50,cleansable:!1,dispellable:!0},speed_reduction:{type:"speed_reduction",category:"debuff",stackBehavior:"replace",maxStacks:1,priority:50,cleansable:!0,dispellable:!0},cloak:{type:"cloak",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:70,cleansable:!1,dispellable:!0},revealed:{type:"revealed",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:75,cleansable:!1,dispellable:!1},marked:{type:"marked",category:"debuff",stackBehavior:"refresh",maxStacks:1,priority:30,cleansable:!0,dispellable:!0},invulnerable:{type:"invulnerable",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:100,cleansable:!1,dispellable:!1},phased:{type:"phased",category:"buff",stackBehavior:"refresh",maxStacks:1,priority:60,cleansable:!1,dispellable:!1}};var oe=(r=>(r.PoisonCloud="poison_cloud",r.FireZone="fire_zone",r.HealingField="healing_field",r.SlowField="slow_field",r.ShieldDome="shield_dome",r.StunZone="stun_zone",r))(oe||{});class ps{activeEffects=new Map;zoneEffects=[];onEffectApplied=null;onEffectRemoved=null;onEffectTick=null;onZoneTick=null;constructor(e){e&&(this.onEffectApplied=e.onEffectApplied??null,this.onEffectRemoved=e.onEffectRemoved??null,this.onEffectTick=e.onEffectTick??null,this.onZoneTick=e.onZoneTick??null)}applyEffect(e,t,i,o,s,a=0,n){const l=ze[e];if(!l)return null;let c=this.activeEffects.get(i);c||(c=[],this.activeEffects.set(i,c));const d=c.findIndex(f=>f.type===e),h=d>=0?c[d]:null;switch(l.stackBehavior){case"none":if(h)return null;break;case"refresh":if(h)return h.startTime=Date.now(),h.duration=o,s>h.value&&(h.value=s),h;break;case"stack":if(h)return h.stacks<l.maxStacks&&(h.stacks++,h.startTime=Date.now(),h.duration=o),h;break;case"replace":if(h)return s>=h.value&&(h.value=s,h.startTime=Date.now(),h.duration=o,h.sourceId=t),h;break;case"separate":const f=c.find(g=>g.type===e&&g.sourceId===t);if(f)return f.startTime=Date.now(),f.duration=o,f.value=s,f;break}const p={id:J("effect"),type:e,sourceId:t,targetId:i,startTime:Date.now(),duration:o,value:s,stacks:1,tickInterval:a,lastTickTime:Date.now(),data:n??null};return c.push(p),this.resolveConflicts(i),this.onEffectApplied?.(p),p}resolveConflicts(e){const t=this.activeEffects.get(e);if(!t)return;if(t.some(s=>s.type==="revealed")){const s=t.findIndex(a=>a.type==="cloak");if(s>=0){const a=t.splice(s,1)[0];a&&this.onEffectRemoved?.(a)}}if(t.some(s=>s.type==="immunity"||s.type==="invulnerable"))for(let s=t.length-1;s>=0;s--){const a=t[s];if(ze[a.type].category==="debuff"){const l=t.splice(s,1)[0];l&&this.onEffectRemoved?.(l)}}}removeEffect(e,t){const i=this.activeEffects.get(e);if(!i)return!1;const o=i.findIndex(a=>a.id===t);if(o<0)return!1;const s=i.splice(o,1)[0];return s&&this.onEffectRemoved?.(s),!0}removeEffectsByType(e,t){const i=this.activeEffects.get(e);if(!i)return 0;let o=0;for(let s=i.length-1;s>=0;s--)if(i[s].type===t){const a=i.splice(s,1)[0];a&&(this.onEffectRemoved?.(a),o++)}return o}removeAllEffects(e){const t=this.activeEffects.get(e);if(t){for(const i of t)this.onEffectRemoved?.(i);this.activeEffects.delete(e)}}cleanse(e){const t=this.activeEffects.get(e);if(!t)return 0;let i=0;for(let o=t.length-1;o>=0;o--){const s=t[o];if(ze[s.type].cleansable){const n=t.splice(o,1)[0];n&&(this.onEffectRemoved?.(n),i++)}}return i}dispel(e){const t=this.activeEffects.get(e);if(!t)return 0;let i=0;for(let o=t.length-1;o>=0;o--){const s=t[o];if(ze[s.type].dispellable){const n=t.splice(o,1)[0];n&&(this.onEffectRemoved?.(n),i++)}}return i}createZone(e,t,i,o,s,a,n,l,c,d){const h={id:J("zone"),type:e,sourceId:t,position:{...i},radius:o,startTime:Date.now(),duration:s,tickInterval:a,lastTickTime:Date.now(),value:n,affectsAllies:l,affectsEnemies:c,visualType:d};return this.zoneEffects.push(h),h}removeZone(e){const t=this.zoneEffects.findIndex(i=>i.id===e);return t<0?!1:(this.zoneEffects.splice(t,1),!0)}getZones(){return[...this.zoneEffects]}hasEffect(e,t){return this.activeEffects.get(e)?.some(o=>o.type===t)??!1}getEffect(e,t){return this.activeEffects.get(e)?.find(o=>o.type===t)}getEffects(e){return this.activeEffects.get(e)??[]}getEffectsByCategory(e,t){const i=this.activeEffects.get(e);return i?i.filter(o=>ze[o.type].category===t):[]}getSpeedModifier(e){const t=this.activeEffects.get(e);if(!t)return 1;let i=1;for(const o of t)switch(o.type){case"speed_boost":i*=1+o.value/100;break;case"speed_reduction":case"slow":i*=1-o.value/100;break;case"root":case"stun":i=0;break}return Math.max(0,i)}getDamageModifier(e){const t=this.activeEffects.get(e);if(!t)return 1;let i=1;for(const o of t)o.type==="damage_boost"&&(i*=1+o.value/100);return i}getDamageReduction(e){const t=this.activeEffects.get(e);if(!t)return 0;let i=0;for(const o of t)if(o.type==="damage_reduction"&&(i=Math.max(i,o.value)),o.type==="immunity"||o.type==="invulnerable")return 100;return i}getFireRateModifier(e){const t=this.activeEffects.get(e);if(!t)return 1;let i=1;for(const o of t)o.type==="fire_rate_boost"&&(i*=1+o.value/100),o.type==="stun"&&(i=0);return i}isStunned(e){return this.hasEffect(e,"stun")}isRooted(e){return this.hasEffect(e,"root")}isSilenced(e){return this.hasEffect(e,"silence")}isCloaked(e){return this.hasEffect(e,"cloak")&&!this.hasEffect(e,"revealed")}isPhased(e){return this.hasEffect(e,"phased")}isInvulnerable(e){return this.hasEffect(e,"invulnerable")||this.hasEffect(e,"immunity")}update(e,t){const i=Date.now();for(const[o,s]of this.activeEffects){for(let a=s.length-1;a>=0;a--){const n=s[a];if(n.duration>0&&i>=n.startTime+n.duration){const l=s.splice(a,1)[0];l&&this.onEffectRemoved?.(l);continue}if(n.tickInterval>0&&i>=n.lastTickTime+n.tickInterval){n.lastTickTime=i;const l=n.value*n.stacks;this.onEffectTick?.(n,l)}}s.length===0&&this.activeEffects.delete(o)}for(let o=this.zoneEffects.length-1;o>=0;o--){const s=this.zoneEffects[o];if(i>=s.startTime+s.duration){this.zoneEffects.splice(o,1);continue}if(i>=s.lastTickTime+s.tickInterval){s.lastTickTime=i;const a=t(s.position,s.radius);a.length>0&&this.onZoneTick?.(s,a)}}}getState(){return{effects:new Map(this.activeEffects),zones:[...this.zoneEffects]}}setState(e){this.activeEffects=new Map(e.effects),this.zoneEffects=[...e.zones]}clear(){this.activeEffects.clear(),this.zoneEffects=[]}}const gs=32;function z(r){return r*gs}const V={SHORT:z(3),MEDIUM:z(5),VERY_LONG:z(12),BLINK:z(3),REVEAL:z(5),HEAL_BURST:z(4),SHOCKWAVE:z(4),GRENADE:z(6),TURRET_RANGE:z(5),POISON_CLOUD:z(3),DOME_SHIELD:z(4)};var F=(r=>(r.Blink="blink",r.BlinkTrail="blink_trail",r.Shockwave="shockwave",r.Shield="shield",r.DomeShield="dome_shield",r.BarrierWall="barrier_wall",r.Cloak="cloak",r.Reveal="reveal",r.HealBurst="heal_burst",r.HealingField="healing_field",r.PoisonCloud="poison_cloud",r.Grenade="grenade",r.Explosion="explosion",r.TurretSpawn="turret_spawn",r.DashSlash="dash_slash",r.MinigunMode="minigun_mode",r))(F||{});class ys{effectSystem;turrets=new Map;activeMiniguns=new Map;getEnemies;getAllies;getTime;raycast;constructor(e,t){this.effectSystem=e,this.getEnemies=t.getEnemies,this.getAllies=t.getAllies,this.getTime=t.getTime,this.raycast=t.raycast}executeAbility(e,t){if(this.effectSystem.isSilenced(e.id))return{success:!1,effectsApplied:[]};switch(e.heroId){case k.Katana:return this.executePhantomAbility(e,t);case k.Vanta:return this.executeTitanAbility(e,t);case k.Spectre:return this.executeSpectreAbility(e,t);case k.Mira:return this.executeMedicAbility(e,t);case k.Spark:return this.executeHavocAbility(e,t);case k.Byte:return this.executeCipherAbility(e,t);case k.Glyph:return this.executeVenomAbility(e,t);case k.Zero:return this.executeAegisAbility(e,t);default:return{success:!1,effectsApplied:[]}}}executePhantomAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=V.BLINK,s=u.fromAngle(e.rotation),a=u.add(e.position,u.mul(s,o)),n=this.raycast(e.position,s,o,[e.id]),l=n?u.sub(n.point,u.mul(s,20)):a;i.teleportTo=l,i.visualEffects.push({type:"blink",position:e.position,duration:300},{type:"blink",position:l,duration:300},{type:"blink_trail",position:e.position,targetPosition:l,duration:200}),i.success=!0}break;case 2:this.effectSystem.applyEffect(E.Cloak,e.id,e.id,4e3,100),i.effectsApplied.push("cloak"),i.visualEffects.push({type:"cloak",position:e.position,duration:4e3}),i.success=!0;break;case 3:{const o=this.getEnemies(e.team).filter(n=>n.alive);if(o.length===0)break;let s=null,a=1/0;for(const n of o){const l=u.distance(e.position,n.position);l<a&&l<z(10)&&(a=l,s=n)}if(s){const n=u.fromAngle(s.rotation+Math.PI),l=u.add(s.position,u.mul(n,40));i.teleportTo=l,i.damage=75,i.targetIds=[s.id],i.visualEffects.push({type:"blink",position:e.position,duration:300},{type:"dash_slash",position:l,direction:s.rotation,duration:500}),i.success=!0}}break}return i}executeTitanAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:this.effectSystem.applyEffect(E.FrontShield,e.id,e.id,3e3,80),i.effectsApplied.push("front_shield"),i.visualEffects.push({type:"barrier_wall",position:{...e.position},direction:e.rotation,duration:3e3,color:"#0ce5f0",followPlayerId:e.id}),i.success=!0;break;case 2:{const o=V.SHOCKWAVE,s=30,a=1500,n=this.getEnemies(e.team).filter(c=>c.alive),l=[];for(const c of n)u.distance(e.position,c.position)<=o&&(this.effectSystem.applyEffect(E.Stun,e.id,c.id,a,100),l.push(c.id));i.damage=s,i.targetIds=l,i.effectsApplied.push("stun"),i.visualEffects.push({type:"shockwave",position:e.position,radius:o,duration:500}),i.success=!0}break;case 3:this.effectSystem.applyEffect(E.DamageReduction,e.id,e.id,5e3,40),this.effectSystem.applyEffect(E.FireRateBoost,e.id,e.id,5e3,40),i.effectsApplied.push("damage_reduction","fire_rate_boost"),i.visualEffects.push({type:"shield",position:e.position,duration:5e3,color:"#ff0000"}),i.success=!0;break}return i}executeSpectreAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:this.effectSystem.applyEffect(E.Cloak,e.id,e.id,2e3,100),i.effectsApplied.push("cloak"),i.visualEffects.push({type:"cloak",position:e.position,duration:2e3}),i.success=!0;break;case 2:{const o=V.REVEAL,s=3e3,a=this.getEnemies(e.team).filter(l=>l.alive),n=[];for(const l of a)u.distance(e.position,l.position)<=o&&(this.effectSystem.applyEffect(E.Revealed,e.id,l.id,s,100),n.push(l.id));i.targetIds=n,i.effectsApplied.push("revealed"),i.visualEffects.push({type:"reveal",position:e.position,radius:o,duration:500}),i.success=!0}break;case 3:{const o=this.getEnemies(e.team).filter(n=>n.alive);if(o.length===0)break;let s=null,a=1/0;for(const n of o){const l=u.distance(e.position,n.position);l<a&&(a=l,s=n)}if(s){const n=u.fromAngle(s.rotation+Math.PI),l=u.add(s.position,u.mul(n,50));i.teleportTo=l,i.visualEffects.push({type:"blink",position:e.position,duration:300},{type:"blink",position:l,duration:300}),i.success=!0}}break}return i}executeMedicAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=z(3),s=4e3;this.effectSystem.createZone(E.Regen,e.id,e.position,o,s,500,10,!0,!1,oe.HealingField),i.zones=[{id:J("zone"),type:oe.HealingField,position:{...e.position},radius:o,duration:s}],i.visualEffects.push({type:"healing_field",position:e.position,radius:o,duration:s,color:"#00ff88"}),i.success=!0}break;case 2:{const o=V.HEAL_BURST,s=30,a=3e3,n=this.getAllies(e.team,e.id).filter(c=>c.alive),l=[];for(const c of n)u.distance(e.position,c.position)<=o&&(this.effectSystem.applyEffect(E.Shield,e.id,c.id,a,s),l.push(c.id));this.effectSystem.applyEffect(E.Shield,e.id,e.id,a,s),i.targetIds=l,i.effectsApplied.push("shield"),i.visualEffects.push({type:"heal_burst",position:e.position,radius:o,duration:500,color:"#00aaff"}),i.success=!0}break;case 3:{const o=this.getAllies(e.team,e.id).filter(n=>!n.alive);if(o.length===0)break;let s=null,a=z(5);for(const n of o){const l=u.distance(e.position,n.position);l<a&&(a=l,s=n)}s&&(i.targetIds=[s.id],i.healing=s.maxHealth*.5,i.effectsApplied.push("revive"),i.visualEffects.push({type:"heal_burst",position:s.position,duration:1e3,color:"#ffff00"}),i.success=!0)}break}return i}executeHavocAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=V.GRENADE,s=u.fromAngle(e.rotation),a=u.add(e.position,u.mul(s,o)),n=this.raycast(e.position,s,o,[e.id]),l=n?n.point:a,c=z(2),d=4e3;this.effectSystem.createZone(E.Burn,e.id,l,c,d,500,15,!1,!0,oe.FireZone),i.zones=[{id:J("zone"),type:oe.FireZone,position:l,radius:c,duration:d}],i.visualEffects.push({type:"grenade",position:e.position,targetPosition:l,duration:500},{type:"explosion",position:l,radius:c,duration:300}),i.success=!0}break;case 2:{const o=z(4),s=this.getEnemies(e.team).filter(a=>a.alive);for(const a of s)u.distance(e.position,a.position)<=o&&(this.effectSystem.removeEffectsByType(a.id,E.Cloak),this.effectSystem.applyEffect(E.Revealed,e.id,a.id,2e3,100));i.effectsApplied.push("revealed"),i.visualEffects.push({type:"shockwave",position:e.position,radius:o,duration:300,color:"#ff8800"}),i.success=!0}break;case 3:{const o=z(5),s=60,a=this.getEnemies(e.team).filter(l=>l.alive),n=[];for(const l of a)u.distance(e.position,l.position)<=o&&(this.effectSystem.applyEffect(E.Burn,e.id,l.id,3e3,10,500),n.push(l.id));i.damage=s,i.targetIds=n,i.effectsApplied.push("burn"),i.visualEffects.push({type:"explosion",position:e.position,radius:o,duration:800,color:"#ff4400"}),i.success=!0}break}return i}executeCipherAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=z(4),s=1500,a=this.getEnemies(e.team).filter(l=>l.alive),n=[];for(const l of a)u.distance(e.position,l.position)<=o&&(this.effectSystem.applyEffect(E.Silence,e.id,l.id,s,100),this.effectSystem.applyEffect(E.Slow,e.id,l.id,s,30),n.push(l.id));i.targetIds=n,i.effectsApplied.push("silence","slow"),i.visualEffects.push({type:"shockwave",position:e.position,radius:o,duration:400,color:"#00ffff"}),i.success=!0}break;case 2:{const o=u.fromAngle(e.rotation),s=u.add(e.position,u.mul(o,60)),a=z(2),n=5e3;this.effectSystem.createZone(E.Slow,e.id,s,a,n,500,40,!1,!0,oe.SlowField),i.zones=[{id:J("zone"),type:oe.SlowField,position:s,radius:a,duration:n}],i.visualEffects.push({type:"turret_spawn",position:s,duration:300,color:"#00aaff"}),i.success=!0}break;case 3:{const o=u.fromAngle(e.rotation),s=u.add(e.position,u.mul(o,50)),a={id:J("turret"),ownerId:e.id,ownerTeam:e.team,position:s,rotation:e.rotation,health:100,maxHealth:100,range:V.TURRET_RANGE,damage:20,fireRate:1e3,lastFireTime:0,spawnTime:this.getTime(),duration:1e4,targetId:null};this.turrets.set(a.id,a),i.visualEffects.push({type:"turret_spawn",position:s,duration:500}),i.success=!0}break}return i}executeVenomAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=V.MEDIUM,s=u.fromAngle(e.rotation),a=this.getEnemies(e.team).filter(l=>l.alive);let n=null;for(const l of a){const c=u.sub(l.position,e.position);if(u.length(c)>o)continue;if(u.dot(u.normalize(c),s)>.9){n=l;break}}n&&(this.effectSystem.applyEffect(E.Poison,e.id,n.id,3e3,8,500),i.targetIds=[n.id],i.effectsApplied.push("poison")),i.visualEffects.push({type:"dash_slash",position:e.position,direction:e.rotation,duration:300,color:"#00ff00"}),i.success=!0}break;case 2:{const o=u.fromAngle(e.rotation),s=u.add(e.position,u.mul(o,V.SHORT)),a=V.POISON_CLOUD,n=5e3;this.effectSystem.createZone(E.Poison,e.id,s,a,n,500,15,!1,!0,oe.PoisonCloud),i.zones=[{id:J("zone"),type:oe.PoisonCloud,position:s,radius:a,duration:n}],i.visualEffects.push({type:"poison_cloud",position:s,radius:a,duration:n,color:"#44ff44"}),i.success=!0}break;case 3:{const o=V.MEDIUM,s=this.getEnemies(e.team).filter(l=>l.alive);let a=null,n=o;for(const l of s){const c=u.distance(e.position,l.position);c<n&&(n=c,a=l)}if(a){this.effectSystem.applyEffect(E.Poison,e.id,a.id,6e3,10,500);const l=z(2),c=[a.id];for(const d of s){if(d.id===a.id)continue;u.distance(a.position,d.position)<=l&&c.length<4&&(this.effectSystem.applyEffect(E.Poison,e.id,d.id,6e3,8,500),c.push(d.id))}i.targetIds=c,i.effectsApplied.push("poison"),i.visualEffects.push({type:"poison_cloud",position:a.position,radius:l,duration:1e3,color:"#00ff00"}),i.success=!0}}break}return i}executeAegisAbility(e,t){const i={success:!1,effectsApplied:[],visualEffects:[]};switch(t){case 0:break;case 1:{const o=V.VERY_LONG*2,s=u.fromAngle(e.rotation);console.log("[Zero] Mark Target activated - scanning for enemies...");const a=this.getEnemies(e.team).filter(d=>d.alive);let n=null,l=.5,c=1/0;console.log(`[Zero] Found ${a.length} alive enemies to check`);for(const d of a){const h=u.sub(d.position,e.position),p=u.length(h);if(p>o){console.log(`[Zero] Enemy ${d.name} too far: ${p.toFixed(0)} > ${o}`);continue}const f=u.normalize(h),g=u.dot(f,s);console.log(`[Zero] Enemy ${d.name}: dist=${p.toFixed(0)}, dot=${g.toFixed(2)} (need >${l})`),g>l&&p<c&&(c=p,n=d)}n?(this.effectSystem.applyEffect(E.Marked,e.id,n.id,5e3,20),i.targetIds=[n.id],i.effectsApplied.push("marked"),console.log(`[Zero]  MARKED: ${n.name} for 5 seconds (+20% damage)`)):console.log("[Zero]  No target found. Make sure you're aiming at an enemy within range."),i.success=!0}break;case 2:{const o=V.BLINK,s=u.fromAngle(e.rotation+Math.PI),a=u.add(e.position,u.mul(s,o)),n=this.raycast(e.position,s,o,[e.id]),l=n?u.sub(n.point,u.mul(s,20)):a;i.teleportTo=l,i.visualEffects.push({type:"blink",position:e.position,duration:300},{type:"blink_trail",position:e.position,targetPosition:l,duration:200}),i.success=!0,console.log("[Zero] Dash Back executed")}break;case 3:{const o=V.DOME_SHIELD,s=5e3,a=this.getAllies(e.team);for(const n of a)u.distance(e.position,n.position)<=o&&this.effectSystem.applyEffect(E.DamageReduction,e.id,n.id,s,70);this.effectSystem.applyEffect(E.DamageReduction,e.id,e.id,s,70),i.effectsApplied.push("damage_reduction"),i.visualEffects.push({type:"dome_shield",position:e.position,radius:o,duration:s,color:"#4488ff"}),i.success=!0}break}return i}updateTurrets(e){const t=[],i=this.getTime();for(const[o,s]of this.turrets){if(i>=s.spawnTime+s.duration){this.turrets.delete(o);continue}const a=this.getEnemies(s.ownerTeam).filter(c=>c.alive);let n=null,l=s.range;for(const c of a){const d=u.distance(s.position,c.position);d<l&&(l=d,n=c)}n?(s.targetId=n.id,s.rotation=u.angle(u.sub(n.position,s.position)),i>=s.lastFireTime+s.fireRate&&(s.lastFireTime=i,t.push({turretId:o,targetId:n.id,damage:s.damage,position:s.position}))):s.targetId=null}return t}getTurrets(){return Array.from(this.turrets.values())}clearTurrets(){this.turrets.clear()}damageTurret(e,t){const i=this.turrets.get(e);return i?(i.health-=t,i.health<=0?(this.turrets.delete(e),!0):!1):!1}isInMinigunMode(e){const t=this.activeMiniguns.get(e);return t?this.getTime()<t:!1}activateMinigunMode(e,t){this.activeMiniguns.set(e,this.getTime()+t)}clear(){this.turrets.clear(),this.activeMiniguns.clear()}}class tt{config;isHost;abilityQSlot=1;abilityFSlot=2;totalRounds=5;roundsToWin=3;phase=C.Lobby;tick=0;time=0;roundNumber=0;roundStartTime=0;attackerScore=0;defenderScore=0;players=new Map;playersByPeerId=new Map;projectiles=new Map;collisionWorld;map;objectives;pendingEvents=[];recentShots=[];abilityEffects=[];localPlayerId=null;bots=new Map;countdownTime=1e4;countdownPaused=!1;countdownPausedBy="";countdownDuration=1e4;effectSystem;abilitySystem;visualEffectQueue=[];constructor(e){this.config=e,this.isHost=e.isHost,this.abilityQSlot=e.abilityQSlot??1,this.abilityFSlot=e.abilityFSlot??2,this.totalRounds=e.totalRounds??5,this.roundsToWin=Math.ceil(this.totalRounds/2),this.collisionWorld=new Ki(128),this.map=es(e.mapId||"neon_arena"),this.map.registerCollision(this.collisionWorld),this.effectSystem=new ps({onEffectApplied:t=>{console.log(`[EffectSystem] Applied ${t.type} to ${t.targetId}`)},onEffectRemoved:t=>{console.log(`[EffectSystem] Removed ${t.type} from ${t.targetId}`)},onEffectTick:(t,i)=>{const o=this.players.get(t.targetId);if(!(!o||!o.alive))switch(t.type){case E.Poison:case E.Burn:case E.Bleed:o.takeDamage(i,t.sourceId,this.time);break;case E.Regen:o.heal(i);break}},onZoneTick:(t,i)=>{for(const o of i){const s=this.players.get(o);if(!s||!s.alive)continue;const a=this.players.get(t.sourceId);if(!a)continue;const n=s.team===a.team,l=s.team!==a.team;t.affectsAllies&&n&&this.applyZoneEffect(t,s),t.affectsEnemies&&l&&this.applyZoneEffect(t,s)}}}),this.abilitySystem=new ys(this.effectSystem,{getPlayer:t=>this.players.get(t),getPlayers:()=>Array.from(this.players.values()),getEnemies:t=>this.getPlayers().filter(i=>i.team!==t&&i.alive),getAllies:(t,i)=>this.getPlayers().filter(o=>o.team===t&&o.id!==i),getTime:()=>this.time,raycast:(t,i,o,s)=>{const a=this.collisionWorld.raycast(t,i,o,M.WALL);return a?{point:a.point,distance:u.distance(t,a.point)}:null}}),this.objectives={spikeCarrierId:null,spikePlanted:!1,spikeSite:-1,spikePlantTime:0,spikeProgress:0,spikePosition:null,plantingPlayerId:null,plantingProgress:0,defusingPlayerId:null,defusingProgress:0,reactorPosition:{x:0,y:0},reactorProgress:0,reactorContested:!1,reactorPushers:0}}applyZoneEffect(e,t){switch(e.type){case E.Poison:t.takeDamage(e.value,e.sourceId,this.time,"poison");break;case E.Burn:t.takeDamage(e.value,e.sourceId,this.time,"fire");break;case E.Regen:t.heal(e.value);break;case E.Slow:this.effectSystem.applyEffect(E.Slow,e.sourceId,t.id,500,e.value);break}}addPlayer(e,t,i,o){const s=this.playersByPeerId.get(e);if(s)return console.log(`[GameWorld] Player with peerId ${e} already exists, returning existing`),s;const a=this.getTeamPlayerCount(i),n=this.map.getSpawnPoint(i,a),l=new Fe(e,t,i,o,n);return this.players.set(l.id,l),this.playersByPeerId.set(e,l),this.collisionWorld.addBody(l.getCollisionBody()),console.log(`[GameWorld] Added player: ${t} (${e}) to team ${i}`),l}removePlayer(e){const t=this.players.get(e);t&&(this.collisionWorld.removeBody(e),this.playersByPeerId.delete(t.peerId),this.players.delete(e),this.bots.delete(e))}getPlayer(e){return this.players.get(e)}getPlayerByPeerId(e){return this.playersByPeerId.get(e)}getPlayerByName(e){for(const t of this.players.values())if(t.name===e)return t}updatePlayerPeerId(e,t){const i=this.playersByPeerId.get(e);i&&(this.playersByPeerId.delete(e),i.peerId=t,this.playersByPeerId.set(t,i),console.log(`[GameWorld] Updated player peerId: ${e} -> ${t}`))}getPlayers(){return Array.from(this.players.values())}getTeamPlayers(e){return this.getPlayers().filter(t=>t.team===e)}getTeamPlayerCount(e){return this.getTeamPlayers(e).length}setLocalPlayer(e){this.localPlayerId=e}getLocalPlayer(){return this.localPlayerId?this.players.get(this.localPlayerId):void 0}addBot(e,t=k.Vanta,i="medium"){const o=this.bots.size,s=this.addPlayer(`bot_${o}`,`Bot ${o+1}`,e,t),a=this.getDifficultySettings(i),n=st.create(s,{aggressionLevel:a.aggressionLevel+Math.random()*.1,accuracy:a.accuracy+Math.random()*.1,reactionTime:a.reactionTime+Math.random()*50});return this.bots.set(s.id,n),s}getDifficultySettings(e){switch(e){case"easy":return{aggressionLevel:.3,accuracy:.2,reactionTime:400};case"medium":return{aggressionLevel:.5,accuracy:.5,reactionTime:250};case"hard":return{aggressionLevel:.8,accuracy:.8,reactionTime:100};default:return{aggressionLevel:.5,accuracy:.5,reactionTime:250}}}spawnBots(e,t,i="medium"){const o=[L.NeoSMG9,L.PulseRifle,L.ScatterShot,L.RailSniper];for(let s=0;s<e;s++){const a=this.addBot(t,k.Vanta,i),n=o[Math.floor(Math.random()*o.length)];a.buyWeapon(n)}}startRound(){this.phase=C.RoundActive,this.roundNumber++,this.roundStartTime=this.time;for(const e of this.players.values()){const t=this.getTeamPlayers(e.team).indexOf(e),i=this.map.getSpawnPoint(e.team,t),o=!e.alive;e.respawn(i),e.resetAbilities(),o?this.collisionWorld.addBody(e.getCollisionBody()):this.collisionWorld.updateBody(e.id,e.position,e.velocity)}if(this.projectiles.clear(),this.abilityEffects=[],this.visualEffectQueue=[],this.abilitySystem.clearTurrets(),this.effectSystem.clear(),this.objectives={spikeCarrierId:null,spikePlanted:!1,spikeSite:-1,spikePlantTime:0,spikeProgress:0,spikePosition:null,plantingPlayerId:null,plantingProgress:0,defusingPlayerId:null,defusingProgress:0,reactorPosition:{x:0,y:0},reactorProgress:0,reactorContested:!1,reactorPushers:0},this.config.mode===j.DataSpikeAssault){const e=this.getTeamPlayers(m.Attackers),t=e.filter(i=>!this.bots.has(i.id));if(t.length>0){const i=t[Math.floor(Math.random()*t.length)];this.objectives.spikeCarrierId=i.id,console.log(`[Spike] Spike carrier assigned to human: ${i.name}`)}else if(e.length>0){const i=e[Math.floor(Math.random()*e.length)];this.objectives.spikeCarrierId=i.id,console.log(`[Spike] Spike carrier assigned to bot (no humans): ${i.name}`)}}}endRound(e){console.log(`[GameWorld] endRound called - Winner: ${e===m.Attackers?"Attackers":"Defenders"}`),this.phase=C.RoundEnd,this.roundStartTime=this.time,this.countdownTime=this.countdownDuration,this.countdownPaused=!1,this.countdownPausedBy="",e===m.Attackers?this.attackerScore++:e===m.Defenders&&this.defenderScore++,this.attackerScore>=this.roundsToWin||this.defenderScore>=this.roundsToWin?(this.phase=C.MatchEnd,console.log(`[GameWorld] MATCH ENDED! Final Score: Attackers ${this.attackerScore} - Defenders ${this.defenderScore}`)):console.log(`[GameWorld] Round ended. Score: Attackers ${this.attackerScore} - Defenders ${this.defenderScore}. Countdown: ${this.countdownDuration/1e3}s`)}pauseCountdown(e){this.phase===C.RoundEnd&&!this.countdownPaused&&(this.countdownPaused=!0,this.countdownPausedBy=e,console.log(`[GameWorld] Countdown paused by ${e} at ${(this.countdownTime/1e3).toFixed(1)}s`))}resumeCountdown(e){this.phase===C.RoundEnd&&this.countdownPaused&&(this.countdownPaused=!1,this.countdownPausedBy="",console.log(`[GameWorld] Countdown resumed by ${e} at ${(this.countdownTime/1e3).toFixed(1)}s`))}toggleCountdownPause(e){this.countdownPaused?this.resumeCountdown(e):this.pauseCountdown(e)}update(e){if(!this.isHost)return;if(this.tick++,this.phase===C.RoundActive&&(this.time+=e),this.phase!==C.RoundActive){if(this.phase===C.RoundEnd&&!this.countdownPaused&&(this.countdownTime-=e,this.countdownTime<=0)){console.log("[GameWorld] Countdown finished, starting next round"),this.startRound();return}for(const d of this.players.values())d.setInput({moveX:0,moveY:0,aimX:d.position.x,aimY:d.position.y,shoot:!1,reload:!1,ability1:!1,ability2:!1,ultimate:!1,interact:!1,weaponSlot:0,sequence:0}),d.prevPosition.x=d.position.x,d.prevPosition.y=d.position.y,d.velocity.x=0,d.velocity.y=0;return}const t=this.getPlayers();for(const[d,h]of this.bots){const p=this.players.get(d);if(p&&p.alive){const f={dt:e,time:this.time,allPlayers:t,collisionWorld:this.collisionWorld,map:this.map,objectives:this.objectives},g=h.update(f);p.setInput(g)}}for(const d of this.players.values())d.update(e,this.time),this.collisionWorld.updateBody(d.id,d.position,d.velocity);for(const[d,h]of this.projectiles)h.update(e,this.time),h.active?this.collisionWorld.updateBody(d,h.position,h.velocity):(this.projectiles.delete(d),this.collisionWorld.removeBody(d));for(let d=0;d<4;d++)this.collisionWorld.detectCollisions(),this.collisionWorld.resolveCollisions();for(const d of this.players.values())d.input.shoot&&d.canFire(this.time)&&(this.processShot(d),d.fire(this.time));this.processAbilities(),this.config.mode===j.DataSpikeAssault&&this.processSpikeInteraction(e),this.checkRoundEnd();const i=this.map.getWidth(),o=this.map.getHeight(),s=this.map.getTileSize(),a=16,n=s+a,l=i-s-a,c=o-s-a;for(const d of this.players.values())d.position.x=Math.max(n,Math.min(l,d.position.x)),d.position.y=Math.max(n,Math.min(c,d.position.y)),this.collisionWorld.updateBody(d.id,d.position,d.velocity)}updateLocalPlayerOnly(e){const t=this.getLocalPlayer();if(this.phase===C.RoundActive){if(t&&t.alive){t.update(e,this.time),this.collisionWorld.updateBody(t.id,t.position,t.velocity),this.collisionWorld.detectCollisions(),this.collisionWorld.resolveCollisions();const i=this.map.getWidth(),o=this.map.getHeight(),s=this.map.getTileSize(),a=16,n=s+a,l=i-s-a,c=o-s-a;t.position.x=Math.max(n,Math.min(l,t.position.x)),t.position.y=Math.max(n,Math.min(c,t.position.y))}for(const i of this.players.values())if(i.id!==this.localPlayerId){if(i.targetPosition){i.prevPosition={...i.position};const o=1-Math.exp(-15*e/1e3);i.position.x+=(i.targetPosition.x-i.position.x)*o,i.position.y+=(i.targetPosition.y-i.position.y)*o}if(i.targetRotation!==null){i.prevRotation=i.rotation;const o=1-Math.exp(-15*e/1e3);i.rotation+=(i.targetRotation-i.rotation)*o}}for(const i of this.projectiles.values())i.update(e,this.time)}}processShot(e){const t=ue[e.weapon.weaponId],i=e.rotation,o=t.spread,s=t.id===L.ScatterShot?t.burstCount:1;for(let a=0;a<s;a++){const n=i+Yi(-o,o),l=u.fromAngle(n),c=u.add(e.position,u.mul(l,20));if(t.projectileSpeed===0){const d=this.collisionWorld.raycast(c,l,t.range,M.PLAYER|M.ENEMY|M.WALL),h=d?d.point:u.add(c,u.mul(l,t.range));if(this.recentShots.push({start:{x:c.x,y:c.y},end:{x:h.x,y:h.y},shooterId:e.id,shooterPeerId:e.peerId}),d&&d.body.userData instanceof Fe){const p=d.body.userData;if(p.id!==e.id&&p.team!==e.team){const f=Math.random()<U.HEADSHOT_ZONE_RATIO,g=e.getEffectiveDamage(),w=f?g*t.headshotMultiplier:g;p.takeDamage(w,e.id,this.time);const I=w/25;e.ultimateCharge=Math.min(10,e.ultimateCharge+I),this.pendingEvents.push({type:Ye.PlayerDamage,data:{targetId:p.id,attackerId:e.id,damage:w,position:d.point,isHeadshot:f}}),p.alive||(e.kills++,e.credits+=U.KILL_REWARD,e.ultimateCharge=Math.min(10,e.ultimateCharge+2),this.collisionWorld.removeBody(p.id),this.pendingEvents.push({type:Ye.PlayerKill,data:{victimId:p.id,killerId:e.id,weaponId:e.weapon.weaponId,isHeadshot:f}}))}}}else{const d=new ct(e.id,c,l,t.projectileSpeed,t.damage,2e3,this.time);this.projectiles.set(d.id,d),this.collisionWorld.addBody(d.getCollisionBody())}}}processAbilities(){this.abilityEffects=this.abilityEffects.filter(t=>this.time<t.startTime+t.duration),this.visualEffectQueue=this.visualEffectQueue.filter(t=>this.time<t.startTime+t.duration),this.effectSystem.update(this.time,(t,i)=>{const o=[];for(const s of this.players.values())u.distance(s.position,t)<=i&&o.push(s.id);return o});const e=this.abilitySystem.updateTurrets(16);for(const t of e){const i=this.players.get(t.targetId);i&&i.alive&&i.takeDamage(t.damage,t.turretId,this.time)}for(const t of this.players.values()){if(!t.alive)continue;const i=t.id===this.localPlayerId,o=i?this.abilityQSlot:1,s=i?this.abilityFSlot:2;if(t.input.ability1&&t.canUseAbility(o,this.time)&&(console.log(`[Input] Q pressed (ability1) -> executing ability index ${o}`),this.executeAbilityNew(t,o)),t.input.ability2&&t.canUseAbility(s,this.time)&&(console.log(`[Input] F pressed (ability2) -> executing ability index ${s}`),this.executeAbilityNew(t,s)),t.input.ultimate){const a=t.canUseAbility(3,this.time),l=X[t.heroId]?.abilities[3]?.ultimateCost||6;console.log(`[Input] X pressed - ultimate charge: ${t.ultimateCharge.toFixed(1)}/${l}, canUse: ${a}`),a&&this.executeAbilityNew(t,3)}this.applyEffectModifiers(t)}}executeAbilityNew(e,t){const i=X[e.heroId],o=i?.abilities[t];console.log(`[Ability] Executing ability ${t}: ${o?.name||"Unknown"} for ${i?.name||"Unknown hero"}`),e.useAbility(t,this.time);const s=this.abilitySystem.executeAbility(e,t);if(s.success){if(s.teleportTo&&(e.position={...s.teleportTo},e.prevPosition={...s.teleportTo},this.collisionWorld.updateBody(e.id,e.position)),s.damage&&s.targetIds)for(const a of s.targetIds){const n=this.players.get(a);n&&n.alive&&(n.takeDamage(s.damage,e.id,this.time),n.alive||(e.kills++,e.credits+=U.KILL_REWARD,this.collisionWorld.removeBody(n.id)))}if(s.healing&&s.targetIds)for(const a of s.targetIds){const n=this.players.get(a);n&&(n.alive?n.heal(s.healing):(n.alive=!0,n.health=s.healing,this.collisionWorld.addBody(n.getCollisionBody())))}if(s.visualEffects)for(const a of s.visualEffects)this.visualEffectQueue.push({...a,startTime:this.time});s.effectsApplied.includes("cloak")&&(this.abilityEffects.push({type:"cloak",playerId:e.id,position:{...e.position},direction:e.rotation,startTime:this.time,duration:4e3}),e.isInvisible=!0)}}applyEffectModifiers(e){const t=this.effectSystem.getSpeedModifier(e.id);e.speedMultiplier=t,e.isStunned=this.effectSystem.isStunned(e.id);const i=this.effectSystem.isCloaked(e.id);e.isInvisible=i}calculateDamage(e,t,i){let o=e;const s=this.effectSystem.getDamageModifier(t);o*=s;const a=this.effectSystem.getEffect(i,E.Marked);a&&(o*=1+a.value/100);const n=this.effectSystem.getDamageReduction(i);return o*=1-n/100,Math.floor(o)}getFireRateModifier(e){return this.effectSystem.getFireRateModifier(e)}getZoneEffects(){return this.effectSystem.getZones()}getTurrets(){return this.abilitySystem.getTurrets()}getVisualEffects(){return[...this.visualEffectQueue]}getAbilityEffects(){return[...this.abilityEffects]}getEffectSystem(){return this.effectSystem}hasEffect(e,t){return this.effectSystem.hasEffect(e,t)}processSpikeInteraction(e){const t=U.SPIKE_PLANT_TIME,i=U.SPIKE_DEFUSE_TIME;this.objectives.spikePlanted?this.handleSpikeDefusing(e,i):this.handleSpikePlanting(e,t)}handleSpikePlanting(e,t){const i=this.objectives.spikeCarrierId?this.players.get(this.objectives.spikeCarrierId):null;if(!i||!i.alive){if(this.objectives.spikeCarrierId){const s=this.getTeamPlayers(m.Attackers).filter(n=>n.alive&&n.id!==this.objectives.spikeCarrierId),a=s.filter(n=>!this.bots.has(n.id));if(a.length>0){const n=a[0];this.objectives.spikeCarrierId=n.id,console.log(`[Spike] Spike transferred to human: ${n.name}`)}else if(s.length>0){const n=s[0];this.objectives.spikeCarrierId=n.id,console.log(`[Spike] Spike transferred to bot: ${n.name}`)}}this.objectives.plantingPlayerId=null,this.objectives.plantingProgress=0;return}const o=this.map.isInSpikeSite(i.position);if(o===-1){this.objectives.plantingPlayerId&&console.log("[Spike] Planting cancelled - left spike site"),this.objectives.plantingPlayerId=null,this.objectives.plantingProgress=0;return}i.input.interact?(this.objectives.plantingPlayerId!==i.id&&(this.objectives.plantingPlayerId=i.id,this.objectives.plantingProgress=0,console.log(`[Spike] Starting to plant at site ${o===0?"A":"B"}`)),this.objectives.plantingProgress+=e/t,this.objectives.plantingProgress>=1&&(this.objectives.spikePlanted=!0,this.objectives.spikeSite=o,this.objectives.spikePlantTime=this.time,this.objectives.spikePosition={...i.position},this.objectives.plantingPlayerId=null,this.objectives.plantingProgress=0,console.log(`[Spike]  SPIKE PLANTED at site ${o===0?"A":"B"}! Defenders have ${U.SPIKE_UPLOAD_TIME/1e3}s to defuse!`))):this.objectives.plantingPlayerId&&(console.log("[Spike] Planting cancelled - released E key"),this.objectives.plantingPlayerId=null,this.objectives.plantingProgress=0)}handleSpikeDefusing(e,t){let i=null;for(const o of this.players.values()){if(!o.alive||o.team!==m.Defenders||!o.input.interact||!this.objectives.spikePosition)continue;if(u.distance(o.position,this.objectives.spikePosition)<=50){i=o;break}}if(i)this.objectives.defusingPlayerId!==i.id&&(this.objectives.defusingPlayerId=i.id,this.objectives.defusingProgress=0,console.log(`[Spike] ${i.name} started defusing!`)),this.objectives.defusingProgress+=e/t,this.objectives.defusingProgress>=1&&(console.log(`[Spike]  SPIKE DEFUSED by ${i.name}! Defenders win!`),this.endRound(m.Defenders));else{if(this.objectives.defusingPlayerId){const o=this.players.get(this.objectives.defusingPlayerId);console.log(`[Spike] Defuse cancelled by ${o?.name||"unknown"}`)}this.objectives.defusingPlayerId=null,this.objectives.defusingProgress=0}}checkRoundEnd(){const e=this.players.size;if(e<2)return;const t=this.time-this.roundStartTime;if(t<1e4)return;const i=this.getTeamPlayers(m.Attackers),o=this.getTeamPlayers(m.Defenders),s=i.filter(n=>n.alive).length,a=o.filter(n=>n.alive).length;if(Math.floor(t/2e3)!==Math.floor((t-16)/2e3)){console.log(`[GameWorld] Round check @ ${Math.round(t)}ms - Total: ${e}, Attackers: ${s}/${i.length}, Defenders: ${a}/${o.length}`);for(const n of this.players.values())console.log(`  - ${n.name} (${n.peerId}): team=${n.team}, alive=${n.alive}`)}if(!(i.length===0||o.length===0)){if(this.config.mode===j.NeonDeathmatch){if(s===0&&i.length>0){console.log("[GameWorld] Round ending: All attackers eliminated"),this.endRound(m.Defenders);return}if(a===0&&o.length>0){console.log("[GameWorld] Round ending: All defenders eliminated"),this.endRound(m.Attackers);return}}else{if(s===0&&i.length>0){console.log("[GameWorld] Round ending: All attackers eliminated"),this.endRound(m.Defenders);return}if(a===0&&o.length>0){console.log("[GameWorld] Round ending: All defenders eliminated"),this.endRound(m.Attackers);return}}if(t>=U.ROUND_TIME){this.endRound(m.Defenders);return}if(this.objectives.spikePlanted){const n=this.time-this.objectives.spikePlantTime;this.objectives.spikeProgress=n/U.SPIKE_UPLOAD_TIME,this.objectives.spikeProgress>=1&&this.endRound(m.Attackers)}}}processInput(e,t){const i=this.playersByPeerId.get(e);i&&i.setInput(t)}getState(){return{phase:this.phase,mode:this.config.mode,mapId:this.map.data.id,tick:this.tick,time:this.time,roundStartTime:this.roundStartTime,roundNumber:this.roundNumber,maxRounds:U.MAX_ROUNDS,roundTimeLimit:U.ROUND_TIME,attackerScore:this.attackerScore,defenderScore:this.defenderScore,players:new Map(Array.from(this.players.values()).map(e=>[e.peerId,e.toState()])),projectiles:new Map(Array.from(this.projectiles.entries()).map(([e,t])=>[e,t.toState()])),objectives:{...this.objectives},recentShots:[...this.recentShots],countdownTime:this.countdownTime,countdownPaused:this.countdownPaused,countdownPausedBy:this.countdownPausedBy}}applyState(e){this.phase=e.phase,this.tick=e.tick,this.time=e.time,this.roundStartTime=e.roundStartTime,this.roundNumber=e.roundNumber,this.attackerScore=e.attackerScore,this.defenderScore=e.defenderScore,e.countdownTime!==void 0&&(this.countdownTime=e.countdownTime),e.countdownPaused!==void 0&&(this.countdownPaused=e.countdownPaused),e.countdownPausedBy!==void 0&&(this.countdownPausedBy=e.countdownPausedBy),this.objectives={...e.objectives};const i=this.getLocalPlayer()?.peerId,o=new Set;for(const[a,n]of e.players){o.add(a);let l=this.playersByPeerId.get(a);if(!l)l=Fe.fromState(n),this.players.set(l.id,l),this.playersByPeerId.set(a,l),this.collisionWorld.addBody(l.getCollisionBody()),console.log(`[GameWorld] Created player from state: ${l.name} (${a})`),a===i&&(this.localPlayerId=l.id,console.log(`[GameWorld] Updated localPlayerId to ${l.id} for peerId ${a}`));else if(l.id===this.localPlayerId){const d=e.roundNumber!==this.roundNumber,h=!l.alive&&n.alive,p=n.position.x-l.position.x,f=n.position.y-l.position.y,g=p*p+f*f,w=g>1e4;(d||h||w)&&(l.position={...n.position},l.prevPosition={...n.position},l.velocity={...n.velocity},l.rotation=n.rotation,l.prevRotation=n.rotation,console.log(`[GameWorld] Force synced local player position (round: ${d}, respawn: ${h}, dist: ${Math.sqrt(g).toFixed(0)})`)),l.health=n.health,l.shield=n.shield,l.alive=n.alive,l.weapon={...n.weapon},l.abilities=n.abilities.map(I=>({...I})),l.team=n.team}else l.targetPosition={...n.position},l.targetRotation=n.rotation,l.velocity={...n.velocity},l.health=n.health,l.shield=n.shield,l.alive=n.alive,l.weapon={...n.weapon},l.abilities=n.abilities.map(d=>({...d})),l.team=n.team}for(const[a,n]of this.players)if(!o.has(n.peerId)){if(a===this.localPlayerId){console.log(`[GameWorld] Keeping local player even though not in host state: ${n.name}`);continue}console.log(`[GameWorld] Removing player not in state: ${n.name} (${n.peerId})`),this.removePlayer(a)}const s=new Set;for(const[a,n]of e.projectiles){s.add(a);let l=this.projectiles.get(a);l?(l.position={...n.position},l.velocity={...n.velocity}):(l=ct.fromState(n),this.projectiles.set(a,l))}for(const a of this.projectiles.keys())s.has(a)||this.projectiles.delete(a)}getPendingEvents(){const e=[...this.pendingEvents];return this.pendingEvents=[],e}getPhase(){return this.phase}getTick(){return this.tick}getTime(){return this.time-this.roundStartTime}getAbsoluteTime(){return this.time}getRoundNumber(){return this.roundNumber}getMap(){return this.map}getProjectiles(){return Array.from(this.projectiles.values())}getAndClearRecentShots(){const e=this.recentShots;return this.recentShots=[],e}isEnemyOfLocal(e){const t=this.getLocalPlayer(),i=this.getPlayer(e);return!t||!i?!1:t.team!==i.team}getObjectives(){return{...this.objectives}}getScore(){return{attackers:this.attackerScore,defenders:this.defenderScore}}getAttackerScore(){return this.attackerScore}getDefenderScore(){return this.defenderScore}getRoundsToWin(){return this.roundsToWin}getTotalRounds(){return this.totalRounds}getCollisionWorld(){return this.collisionWorld}setPhase(e){this.phase=e}getCountdownTime(){return this.countdownTime}isCountdownPaused(){return this.countdownPaused}getCountdownPausedBy(){return this.countdownPausedBy}}class ws{particles=[];maxParticles=1e3;update(e){const t=e/1e3;for(let i=this.particles.length-1;i>=0;i--){const o=this.particles[i];if(o.life-=t,o.life<=0){this.particles.splice(i,1);continue}o.trail&&(o.trail.push({...o.position}),o.trail.length>10&&o.trail.shift()),o.velocity=u.add(o.velocity,u.mul(o.acceleration,t)),o.position=u.add(o.position,u.mul(o.velocity,t)),o.rotation+=o.rotationSpeed*t}}render(e){for(const t of this.particles){const i=t.life/t.maxLife,o=Math.min(1,i*2);switch(t.type){case"spark":this.renderSpark(e,t,o);break;case"smoke":this.renderSmoke(e,t,o);break;case"debris":this.renderDebris(e,t,o);break;case"energy":this.renderEnergy(e,t,o);break;case"glitch":this.renderGlitch(e,t,o);break;case"data":this.renderData(e,t,o);break;case"blood":this.renderBlood(e,t,o);break}}}renderSpark(e,t,i){const o=this.colorWithAlpha(t.color,i),s=u.length(t.velocity)*.03,a=u.normalize(t.velocity),n=u.sub(t.position,u.mul(a,s));e.drawLine(n.x,n.y,t.position.x,t.position.y,{color:o,width:t.size}),e.drawCircle(t.position.x,t.position.y,t.size*.5,{fill:o,glow:!0,glowColor:t.color,glowSize:t.size*2})}renderSmoke(e,t,i){const o=t.size*(1+(1-t.life/t.maxLife)*2),s=this.colorWithAlpha(t.color,i*.5);e.drawCircle(t.position.x,t.position.y,o,{fill:s})}renderDebris(e,t,i){const o=this.colorWithAlpha(t.color,i),s=t.size,a=e.ctx;a.save(),a.translate(t.position.x,t.position.y),a.rotate(t.rotation),a.fillStyle=o,a.fillRect(-s/2,-s/2,s,s),a.restore()}renderEnergy(e,t,i){const o=this.colorWithAlpha(t.color,i);if(e.drawCircle(t.position.x,t.position.y,t.size,{fill:o,glow:!0,glowColor:t.color,glowSize:t.size*3}),t.trail&&t.trail.length>1)for(let s=1;s<t.trail.length;s++){const a=t.trail[s-1],n=t.trail[s],l=s/t.trail.length*i*.5;e.drawLine(a.x,a.y,n.x,n.y,{color:this.colorWithAlpha(t.color,l),width:t.size*.5})}}renderGlitch(e,t,i){const o=this.colorWithAlpha(t.color,i),s=(Math.random()-.5)*10,a=(Math.random()-.5)*5,n=t.size*2+Math.random()*10,l=t.size*.5,c=e.ctx;c.fillStyle=o,c.fillRect(t.position.x+s-n/2,t.position.y+a-l/2,n,l)}renderData(e,t,i){const o=this.colorWithAlpha(t.color,i),s=Math.random()>.5?"1":"0",a=e.ctx;a.font=`${t.size*2}px monospace`,a.fillStyle=o,a.textAlign="center",a.textBaseline="middle",a.fillText(s,t.position.x,t.position.y)}renderBlood(e,t,i){const o=t.size*(1+(1-t.life/t.maxLife)*.5),s=this.colorWithAlpha(t.color,i*.8);e.drawCircle(t.position.x,t.position.y,o,{fill:s})}emit(e){const{count:t,position:i,direction:o=0,spread:s=Math.PI*2,speed:a,size:n,life:l,colors:c,type:d,gravity:h=0,friction:p=0,rotationSpeed:f={min:0,max:0},trail:g=!1}=e;for(let w=0;w<t&&this.particles.length<this.maxParticles;w++){const I=o+(Math.random()-.5)*s,A=a.min+Math.random()*(a.max-a.min),P=n.min+Math.random()*(n.max-n.min),T=l.min+Math.random()*(l.max-l.min),$=c[Math.floor(Math.random()*c.length)],D=f.min+Math.random()*(f.max-f.min);this.particles.push({position:{...i},velocity:u.mul(u.fromAngle(I),A),acceleration:{x:p*-1,y:h},color:$,size:P,life:T,maxLife:T,rotation:Math.random()*Math.PI*2,rotationSpeed:D,type:d,trail:g?[]:void 0})}}bulletImpact(e,t){const i=Math.atan2(t.y,t.x);this.emit({count:8,position:e,direction:i,spread:Math.PI*.6,speed:{min:100,max:300},size:{min:1,max:3},life:{min:.1,max:.3},colors:[y.CYAN,y.YELLOW,"#ffffff"],type:"spark",gravity:300}),this.emit({count:3,position:e,spread:Math.PI*2,speed:{min:20,max:50},size:{min:3,max:6},life:{min:.2,max:.4},colors:["#666666","#888888","#aaaaaa"],type:"smoke",gravity:-50})}bulletHitPlayer(e,t){const i=Math.atan2(t.y,t.x);this.emit({count:12,position:e,direction:i+Math.PI,spread:Math.PI*.8,speed:{min:80,max:200},size:{min:2,max:4},life:{min:.15,max:.35},colors:[y.MAGENTA,y.CYAN,"#ff4488"],type:"energy",gravity:100,trail:!0})}playerDeath(e){this.emit({count:30,position:e,spread:Math.PI*2,speed:{min:150,max:400},size:{min:3,max:8},life:{min:.3,max:.8},colors:[y.CYAN,y.MAGENTA,"#ff4488","#44ffaa"],type:"energy",gravity:200,trail:!0}),this.emit({count:20,position:e,spread:Math.PI*2,speed:{min:50,max:150},size:{min:4,max:12},life:{min:.2,max:.5},colors:[y.CYAN,y.MAGENTA,"#ffffff"],type:"glitch"}),this.emit({count:15,position:e,spread:Math.PI*2,speed:{min:100,max:250},size:{min:6,max:12},life:{min:.4,max:1},colors:[y.CYAN,"#00ff88",y.MAGENTA],type:"data",gravity:150}),this.emit({count:15,position:e,spread:Math.PI*2,speed:{min:100,max:300},size:{min:3,max:8},life:{min:.3,max:.7},colors:["#333344","#444455","#555566","#2a2a3a"],type:"debris",gravity:500,rotationSpeed:{min:-10,max:10}})}weaponSwitch(e){this.emit({count:8,position:e,spread:Math.PI*2,speed:{min:30,max:80},size:{min:2,max:4},life:{min:.15,max:.3},colors:[y.CYAN,y.YELLOW],type:"energy"})}muzzleFlashParticles(e,t){this.emit({count:5,position:e,direction:t,spread:Math.PI*.3,speed:{min:200,max:400},size:{min:1,max:2},life:{min:.05,max:.15},colors:[y.YELLOW,"#ffaa00","#ffffff"],type:"spark",gravity:300})}blinkEffect(e){this.emit({count:20,position:e,spread:Math.PI*2,speed:{min:100,max:300},size:{min:3,max:8},life:{min:.2,max:.5},colors:[y.CYAN,y.MAGENTA,"#ffffff"],type:"energy"}),this.emit({count:10,position:e,spread:Math.PI*2,speed:{min:50,max:150},size:{min:4,max:8},life:{min:.3,max:.6},colors:[y.CYAN,"#00ffaa"],type:"data"})}blinkTrail(e,t){const i=u.distance(e,t),o=Math.floor(i/20);for(let s=0;s<o;s++){const a=s/o,n=u.lerp(e,t,a);this.emit({count:2,position:n,spread:Math.PI*2,speed:{min:20,max:50},size:{min:2,max:4},life:{min:.1,max:.3},colors:[y.CYAN,y.MAGENTA],type:"energy"})}}shockwaveEffect(e,t,i=y.CYAN){const o=Math.floor(t/5);for(let s=0;s<o;s++){const a=s/o*Math.PI*2,n={x:e.x+Math.cos(a)*t*.8,y:e.y+Math.sin(a)*t*.8};this.emit({count:1,position:n,direction:a,spread:.2,speed:{min:50,max:100},size:{min:4,max:8},life:{min:.2,max:.4},colors:[i,"#ffffff"],type:"energy"})}}shieldEffect(e,t="#00aaff"){this.emit({count:15,position:e,spread:Math.PI*2,speed:{min:20,max:60},size:{min:3,max:6},life:{min:.5,max:1},colors:[t,"#ffffff"],type:"energy"})}cloakEffect(e){this.emit({count:12,position:e,spread:Math.PI*2,speed:{min:10,max:40},size:{min:4,max:8},life:{min:.3,max:.6},colors:["#4444ff","#8888ff","#aaaaff"],type:"glitch"})}revealEffect(e,t){this.shockwaveEffect(e,t,y.YELLOW),this.emit({count:8,position:e,spread:Math.PI*2,speed:{min:30,max:80},size:{min:3,max:5},life:{min:.4,max:.8},colors:[y.YELLOW,"#ffaa00"],type:"data"})}healBurstEffect(e,t="#00ff88"){this.emit({count:20,position:e,spread:Math.PI*2,speed:{min:40,max:100},size:{min:3,max:6},life:{min:.5,max:1},colors:[t,"#00ffaa","#88ffaa"],type:"energy",gravity:-100}),this.emit({count:8,position:e,spread:Math.PI*2,speed:{min:20,max:60},size:{min:6,max:10},life:{min:.6,max:1.2},colors:[t,"#ffffff"],type:"data",gravity:-50})}poisonCloudEffect(e,t){const i=Math.floor(t/8);for(let o=0;o<i;o++){const s=Math.random()*Math.PI*2,a=Math.random()*t*.8,n={x:e.x+Math.cos(s)*a,y:e.y+Math.sin(s)*a};this.emit({count:2,position:n,spread:Math.PI*2,speed:{min:5,max:20},size:{min:8,max:16},life:{min:.8,max:1.5},colors:["#44ff44","#22aa22","#116611"],type:"smoke",gravity:-30})}}explosionEffect(e,t,i="#ff4400"){const o=Math.max(1,t/50);this.emit({count:Math.floor(30*o),position:e,spread:Math.PI*2,speed:{min:100,max:300},size:{min:4,max:12},life:{min:.2,max:.5},colors:[i,"#ff8800","#ffff00","#ffffff"],type:"spark",gravity:100}),this.emit({count:Math.floor(15*o),position:e,spread:Math.PI*2,speed:{min:30,max:80},size:{min:10,max:20},life:{min:.5,max:1},colors:["#333333","#444444","#222222"],type:"smoke",gravity:-50}),this.emit({count:Math.floor(10*o),position:e,spread:Math.PI*2,speed:{min:150,max:400},size:{min:2,max:5},life:{min:.3,max:.7},colors:["#666666","#888888","#444444"],type:"debris",gravity:400})}grenadeTrail(e){this.emit({count:3,position:e,spread:Math.PI*2,speed:{min:10,max:30},size:{min:2,max:4},life:{min:.1,max:.2},colors:["#888888","#666666"],type:"smoke"})}turretSpawnEffect(e){this.emit({count:20,position:e,spread:Math.PI*2,speed:{min:50,max:150},size:{min:3,max:6},life:{min:.3,max:.6},colors:[y.CYAN,"#00ffaa","#ffffff"],type:"energy"}),this.emit({count:10,position:e,spread:Math.PI*2,speed:{min:100,max:200},size:{min:1,max:3},life:{min:.1,max:.3},colors:[y.YELLOW,"#ffaa00"],type:"spark",gravity:200})}dashSlashEffect(e,t,i=y.CYAN){for(let o=-3;o<=3;o++){const s=t+o*.15,a={x:e.x+Math.cos(s)*40,y:e.y+Math.sin(s)*40};this.emit({count:3,position:a,direction:s,spread:.3,speed:{min:100,max:200},size:{min:3,max:6},life:{min:.1,max:.25},colors:[i,"#ffffff"],type:"energy"})}}domeShieldEffect(e,t,i="#4488ff"){for(let s=0;s<12;s++){const a=s/12*Math.PI*2,n={x:e.x+Math.cos(a)*t,y:e.y+Math.sin(a)*t};this.emit({count:2,position:n,direction:a+Math.PI/2,spread:.5,speed:{min:20,max:50},size:{min:3,max:6},life:{min:.4,max:.8},colors:[i,"#ffffff"],type:"energy"})}}fireZoneEffect(e,t){const i=Math.floor(t/15);for(let o=0;o<i;o++){const s=Math.random()*Math.PI*2,a=Math.random()*t*.8,n={x:e.x+Math.cos(s)*a,y:e.y+Math.sin(s)*a};this.emit({count:2,position:n,spread:.5,speed:{min:30,max:80},size:{min:4,max:10},life:{min:.2,max:.5},colors:["#ff4400","#ff8800","#ffaa00"],type:"spark",gravity:-100})}}stunEffect(e){this.emit({count:15,position:e,spread:Math.PI*2,speed:{min:50,max:150},size:{min:2,max:5},life:{min:.2,max:.4},colors:["#ffff00","#ffffff","#ffff88"],type:"spark"}),this.emit({count:8,position:e,spread:Math.PI*2,speed:{min:20,max:60},size:{min:4,max:8},life:{min:.3,max:.6},colors:["#00ffff","#88ffff"],type:"glitch"})}markedEffect(e){this.emit({count:6,position:e,spread:Math.PI*2,speed:{min:10,max:30},size:{min:3,max:5},life:{min:.5,max:1},colors:["#ff0000","#ff4444"],type:"energy",gravity:-20})}clear(){this.particles=[]}getParticleCount(){return this.particles.length}colorWithAlpha(e,t){if(e.startsWith("#")){const i=parseInt(e.slice(1,3),16),o=parseInt(e.slice(3,5),16),s=parseInt(e.slice(5,7),16);return`rgba(${i}, ${o}, ${s}, ${t})`}return e.startsWith("rgba")?e.replace(/[\d.]+\)$/,`${t})`):e}}class bs{renderer;world;muzzleFlashes=[];bulletTracers=[];particleSystem;constructor(e,t){this.renderer=e,this.world=t,this.particleSystem=new ws}render(e){this.renderer.beginFrame();const t=this.world.getLocalPlayer();if(t){const i=Ae(t.prevPosition.x,t.position.x,e),o=Ae(t.prevPosition.y,t.position.y,e);this.renderer.setCamera(i,o,1)}else this.renderer.setCamera(this.world.getMap().getWidth()/2,this.world.getMap().getHeight()/2,.8);this.renderer.beginWorld(),this.renderMap(),this.renderAbilityEffects(),this.renderVisualEffects(e);for(const i of this.world.getPlayers())this.renderPlayer(i,e,i.id===t?.id);for(const i of this.world.getProjectiles())this.renderProjectile(i,e);this.renderBulletTracers(),this.renderMuzzleFlashes(),this.particleSystem.render(this.renderer),this.renderer.endWorld(),this.renderUI(),this.renderer.endFrame()}renderMap(){const e=this.world.getMap(),t=e.getTileSize(),i=e.data.tiles,o=this.renderer.getCameraOffset(),s=this.renderer.getCameraZoom(),a=this.renderer.getWidth()/s,n=this.renderer.getHeight()/s,l=Math.max(0,Math.floor(o.x/t)),c=Math.max(0,Math.floor(o.y/t)),d=Math.min(i[0]?.length??0,Math.ceil((o.x+a)/t)+1),h=Math.min(i.length,Math.ceil((o.y+n)/t)+1);this.renderer.drawRect(0,0,e.getWidth(),e.getHeight(),{fill:"#151520"}),this.renderer.drawDebugGrid(t,"#1a1a2a");for(let f=c;f<h;f++){const g=i[f];if(g)for(let w=l;w<d;w++)g[w]===1&&this.renderer.drawRect(w*t,f*t,t,t,{fill:"#2a2a3a",stroke:"#3a3a4a",strokeWidth:1})}for(let f=0;f<e.data.spikeSites.length;f++){const g=e.data.spikeSites[f];this.renderer.drawNeonRect(g,f===0?y.CYAN:y.MAGENTA,.5),this.renderer.drawText(`SITE ${String.fromCharCode(65+f)}`,g.x+g.width/2,g.y+g.height/2,{color:"#fff",align:"center",baseline:"middle",size:16})}const p=this.world.getObjectives();if(p.spikePlanted&&p.spikePosition){const f=p.spikePosition.x,g=p.spikePosition.y,w=Math.sin(this.world.getAbsoluteTime()*.01)*.3+.7;this.renderer.drawCircle(f,g,25+w*5,{fill:`rgba(255, 50, 50, ${w*.3})`,glow:!0,glowColor:"#ff0000",glowSize:20}),this.renderer.drawCircle(f,g,15,{fill:"#ff2222",stroke:"#ff6666",strokeWidth:3,glow:!0,glowColor:"#ff0000",glowSize:15}),this.renderer.drawCircle(f,g,6,{fill:"#ffffff",glow:!0,glowColor:"#ff0000",glowSize:8}),this.renderer.drawText(" SPIKE",f,g-35,{color:"#ff4444",align:"center",size:12});const I=60,A=8,P=f-I/2,T=g+25;this.renderer.drawRect(P,T,I,A,{fill:"rgba(0, 0, 0, 0.7)",stroke:"#ff4444",strokeWidth:1});const $=p.spikeProgress;$>0&&this.renderer.drawRect(P+1,T+1,(I-2)*$,A-2,{fill:$>.7?"#ff0000":"#ff4444"})}}renderPlayer(e,t,i){const o=Ae(e.prevPosition.x,e.position.x,t),s=Ae(e.prevPosition.y,e.position.y,t),a=e.rotation,n=e.team===m.Attackers?y.ATTACKER:y.DEFENDER,l=i?y.CYAN:n;if(e.isInvisible&&!i)return;if(!e.alive){const p=this.world.getAbsoluteTime()-e.deathTime,f=1e3;if(p>f)return;const g=1-p/f,w=`rgba(51, 51, 51, ${g})`;this.renderer.drawCircle(o,s,16,{fill:w,stroke:`rgba(100, 100, 100, ${g*.5})`,strokeWidth:2});return}if(this.renderer.drawCircle(o,s,16,{fill:e.isInvisible?`${n}4D`:n,stroke:e.isInvisible?`${l}4D`:l,strokeWidth:i?3:2,glow:i&&!e.isInvisible,glowColor:l,glowSize:10}),e.alive){const p=o+Math.cos(a)*20,f=s+Math.sin(a)*20;this.renderer.drawLine(o,s,p,f,{color:e.isInvisible?"rgba(255,255,255,0.3)":"#fff",width:2});const g=o+Math.cos(a)*30,w=s+Math.sin(a)*30;if(this.renderer.drawCircle(g,w,4,{fill:e.isInvisible?`${y.CYAN}4D`:y.CYAN,glow:!e.isInvisible,glowColor:y.CYAN,glowSize:5}),e.isStunned&&this.renderer.drawCircle(o,s-25,8,{fill:"rgba(255, 255, 0, 0.8)",glow:!0,glowColor:y.YELLOW,glowSize:10}),this.world.getEffectSystem().getEffect(e.id,E.Marked)){const A=Math.sin(this.world.getAbsoluteTime()*.01)*.3+.7;this.renderer.drawCircle(o,s,28+A*5,{stroke:`rgba(255, 50, 50, ${A})`,strokeWidth:3,glow:!0,glowColor:"#ff0000",glowSize:15});const P=s-55;this.renderer.drawCircle(o,P,10,{stroke:"#ff4444",strokeWidth:2,glow:!0,glowColor:"#ff0000",glowSize:10}),this.renderer.drawLine(o-16,P,o-6,P,{color:"#ff4444",width:2}),this.renderer.drawLine(o+6,P,o+16,P,{color:"#ff4444",width:2}),this.renderer.drawLine(o,P-16,o,P-6,{color:"#ff4444",width:2}),this.renderer.drawLine(o,P+6,o,P+16,{color:"#ff4444",width:2}),this.renderer.drawText(" MARKED",o,s-72,{color:"#ff4444",align:"center",size:10})}}this.renderer.drawHealthBar(o-20,s-30,40,6,e.health,e.maxHealth,e.shield,e.maxShield),this.renderer.drawText(e.name,o,s-40,{color:"#fff",align:"center",size:10});const d=X[e.heroId];this.renderer.drawText(d.name.charAt(0),o,s,{color:"#fff",align:"center",baseline:"middle",size:14,glow:!0,glowColor:"#000",glowSize:2});const h=this.world.getObjectives();if(h.spikeCarrierId===e.id&&!h.spikePlanted){const p=Math.sin(this.world.getAbsoluteTime()*.008)*.2+.8;this.renderer.drawText("",o+25,s-10,{color:"#ff4444",align:"center",size:14}),this.renderer.drawCircle(o,s,22,{stroke:`rgba(255, 100, 50, ${p})`,strokeWidth:2})}if(h.plantingPlayerId===e.id&&h.plantingProgress>0){const g=o-25,w=s+30;this.renderer.drawRect(g,w,50,6,{fill:"rgba(0, 0, 0, 0.8)",stroke:"#ff8800",strokeWidth:1}),this.renderer.drawRect(g+1,w+1,48*h.plantingProgress,4,{fill:"#ff8800"}),this.renderer.drawText("PLANTING...",o,w+6+10,{color:"#ff8800",align:"center",size:8})}if(h.defusingPlayerId===e.id&&h.defusingProgress>0){const g=o-25,w=s+30;this.renderer.drawRect(g,w,50,6,{fill:"rgba(0, 0, 0, 0.8)",stroke:"#00ff88",strokeWidth:1}),this.renderer.drawRect(g+1,w+1,48*h.defusingProgress,4,{fill:"#00ff88"}),this.renderer.drawText("DEFUSING...",o,w+6+10,{color:"#00ff88",align:"center",size:8})}}renderProjectile(e,t){const i=e.position.x,o=e.position.y;this.renderer.drawCircle(i,o,4,{fill:y.YELLOW,glow:!0,glowColor:y.YELLOW,glowSize:8});const s=i-e.velocity.x*.02,a=o-e.velocity.y*.02;this.renderer.drawLine(s,a,i,o,{color:y.YELLOW,width:2})}renderMuzzleFlashes(){const e=performance.now();this.muzzleFlashes=this.muzzleFlashes.filter(t=>e-t.time<100);for(const t of this.muzzleFlashes){const i=e-t.time,o=1-i/100,s=15+i*.2;this.renderer.drawCircle(t.position.x+Math.cos(t.direction)*25,t.position.y+Math.sin(t.direction)*25,s*o,{fill:`rgba(255, 200, 100, ${o*.8})`,glow:!0,glowColor:y.YELLOW,glowSize:15*o})}}renderAbilityEffects(){const e=this.world.getAbilityEffects(),t=this.world.getTime();for(const i of e){const s=(t-i.startTime)/i.duration,a=1-s;switch(i.type){case"shield":this.renderShieldEffect(i,a);break;case"shockwave":this.renderShockwaveEffect(i,s);break;case"dash":this.renderDashEffect(i,a);break}}}renderShieldEffect(e,t){const{position:i,direction:o,radius:s=60}=e,a=o-Math.PI/3,n=o+Math.PI/3;for(let l=0;l<3;l++){const c=s+l*8,d=t*(1-l*.2);this.renderer.drawArc(i.x,i.y,c,a,n,{stroke:`rgba(100, 200, 255, ${d*.8})`,strokeWidth:4-l,glow:!0,glowColor:y.CYAN,glowSize:10})}}renderShockwaveEffect(e,t){const{position:i,radius:o=120}=e,s=o*t,a=1-t;if(this.renderer.drawCircle(i.x,i.y,s,{stroke:`rgba(255, 150, 50, ${a*.9})`,strokeWidth:6*(1-t),glow:!0,glowColor:"#ff9933",glowSize:20*a}),t<.3){const n=1-t/.3;this.renderer.drawCircle(i.x,i.y,o*.3,{fill:`rgba(255, 200, 100, ${n*.5})`,glow:!0,glowColor:y.YELLOW,glowSize:30*n})}}renderDashEffect(e,t){const{position:i,direction:o,radius:s=100}=e,a={x:i.x-Math.cos(o)*s,y:i.y-Math.sin(o)*s};this.renderer.drawLine(a.x,a.y,i.x,i.y,{color:`rgba(255, 100, 100, ${t*.8})`,width:8,glow:!0,glowColor:y.MAGENTA,glowSize:15})}renderVisualEffects(e){const t=this.world.getVisualEffects(),i=this.world.getTime(),o=t.filter(s=>s.type===F.BarrierWall);o.length>1&&console.warn(`[VFX] Multiple barrier effects: ${o.length}`);for(const s of t){const a=i-s.startTime,n=Math.max(0,Math.min(1,a/s.duration)),l=Math.max(0,Math.min(1,1-n));let c=s.position,d=s.direction||0;if(s.followPlayerId){const h=this.world.getPlayer(s.followPlayerId);h&&h.alive&&(c={x:Ae(h.prevPosition.x,h.position.x,e),y:Ae(h.prevPosition.y,h.position.y,e)},d=h.rotation)}switch(s.type){case F.Blink:case F.BlinkTrail:this.renderBlinkEffect(c,l);break;case F.Shockwave:this.renderNewShockwaveEffect(c,n,s.radius||128);break;case F.Shield:this.renderNewShieldEffect(c,l,s.color||y.CYAN);break;case F.DomeShield:this.renderDomeShieldEffect(c,l,s.radius||160);break;case F.BarrierWall:this.renderBarrierWallEffect(c,d,l,s.color||y.CYAN);break;case F.HealBurst:case F.HealingField:this.renderHealingEffect(c,n,s.radius||160);break;case F.PoisonCloud:this.renderPoisonCloudEffect(s.position,l,s.radius||128);break;case F.Explosion:this.renderExplosionEffect(s.position,n,s.radius||80);break;case F.DashSlash:this.renderDashSlashEffect(s.position,s.direction||0,l);break;case F.TurretSpawn:this.renderTurretSpawnEffect(s.position,l);break;case F.Cloak:break;case F.Reveal:this.renderRevealEffect(s.position,n);break}}}renderBlinkEffect(e,t){this.renderer.drawCircle(e.x,e.y,30*t,{fill:`rgba(100, 200, 255, ${t*.5})`,stroke:`rgba(150, 230, 255, ${t})`,strokeWidth:3,glow:!0,glowColor:y.CYAN,glowSize:20*t});for(let i=0;i<8;i++){const o=i/8*Math.PI*2,s=20+(1-t)*40,a=e.x+Math.cos(o)*s,n=e.y+Math.sin(o)*s;this.renderer.drawCircle(a,n,4*t,{fill:y.CYAN,glow:!0,glowColor:y.CYAN,glowSize:5})}}renderNewShockwaveEffect(e,t,i){const o=i*t,s=1-t;if(this.renderer.drawCircle(e.x,e.y,o,{stroke:`rgba(255, 150, 50, ${s*.9})`,strokeWidth:8*(1-t),glow:!0,glowColor:"#ff9933",glowSize:20*s}),t<.5){const a=1-t/.5;this.renderer.drawCircle(e.x,e.y,o*.6,{stroke:`rgba(255, 200, 100, ${a*.7})`,strokeWidth:4})}}renderNewShieldEffect(e,t,i){this.renderer.drawCircle(e.x,e.y,35,{fill:`rgba(100, 200, 255, ${t*.2})`,stroke:i,strokeWidth:3*t,glow:!0,glowColor:i,glowSize:15*t})}renderDomeShieldEffect(e,t,i){this.renderer.drawCircle(e.x,e.y,i,{fill:`rgba(100, 200, 255, ${t*.15})`,stroke:`rgba(150, 230, 255, ${t*.8})`,strokeWidth:4,glow:!0,glowColor:y.CYAN,glowSize:25*t});for(let o=0;o<6;o++){const s=o/6*Math.PI*2,a=e.x+Math.cos(s)*i*.7,n=e.y+Math.sin(s)*i*.7;this.renderer.drawCircle(a,n,8,{stroke:`rgba(200, 240, 255, ${t*.5})`,strokeWidth:2})}}renderBarrierWallEffect(e,t,i,o){const s=Math.max(0,Math.min(1,i)),a=45,n=Math.PI*(2/3),l=t-n/2,c=t+n/2,d=this.renderer.getContext();d.save(),d.beginPath(),d.arc(e.x,e.y,a,l,c),d.strokeStyle=o,d.lineWidth=8*s,d.lineCap="round",d.shadowColor=o,d.shadowBlur=20*s,d.stroke(),d.beginPath(),d.arc(e.x,e.y,a-4,l+.1,c-.1),d.strokeStyle=`rgba(255, 255, 255, ${s*.6})`,d.lineWidth=3*s,d.stroke();for(const p of[l,c]){const f=e.x+Math.cos(p)*a,g=e.y+Math.sin(p)*a;d.beginPath(),d.arc(f,g,6*s,0,Math.PI*2),d.fillStyle=o,d.fill()}const h=5;for(let p=1;p<h;p++){const f=l+n*p/h,g=e.x+Math.cos(f)*a,w=e.y+Math.sin(f)*a;d.beginPath(),d.arc(g,w,3*s,0,Math.PI*2),d.fillStyle=`rgba(255, 255, 255, ${s*.8})`,d.fill()}d.restore()}renderHealingEffect(e,t,i){const o=1-t*.5;this.renderer.drawCircle(e.x,e.y,i,{fill:`rgba(100, 255, 150, ${o*.1})`,stroke:`rgba(100, 255, 150, ${o*.6})`,strokeWidth:2});const s=6;for(let a=0;a<s;a++){const n=a/s*Math.PI*2+t*2,l=i*.5,c=e.x+Math.cos(n)*l,d=e.y+Math.sin(n)*l-t*30;this.renderer.drawText("+",c,d,{color:`rgba(100, 255, 150, ${o})`,size:16,align:"center",baseline:"middle"})}}renderPoisonCloudEffect(e,t,i){this.renderer.drawCircle(e.x,e.y,i,{fill:`rgba(100, 200, 50, ${t*.3})`,stroke:`rgba(150, 220, 80, ${t*.6})`,strokeWidth:3});for(let o=0;o<5;o++){const s=o/5*Math.PI*2,a=i*(.3+Math.random()*.5),n=e.x+Math.cos(s)*a,l=e.y+Math.sin(s)*a;this.renderer.drawCircle(n,l,5+Math.random()*10,{fill:`rgba(120, 200, 60, ${t*.4})`})}}renderExplosionEffect(e,t,i){const o=i*t,s=1-t;if(this.renderer.drawCircle(e.x,e.y,o,{fill:`rgba(255, 150, 50, ${s*.6})`,glow:!0,glowColor:"#ff6600",glowSize:30*s}),t<.3){const a=1-t/.3;this.renderer.drawCircle(e.x,e.y,o*.5,{fill:`rgba(255, 255, 200, ${a})`})}}renderDashSlashEffect(e,t,i){const o=t-Math.PI/4,s=t+Math.PI/4;this.renderer.drawArc(e.x,e.y,40,o,s,{stroke:`rgba(255, 100, 100, ${i})`,strokeWidth:6*i,glow:!0,glowColor:y.MAGENTA,glowSize:15*i})}renderTurretSpawnEffect(e,t){this.renderer.drawCircle(e.x,e.y,25,{stroke:`rgba(255, 200, 100, ${t})`,strokeWidth:3,glow:!0,glowColor:y.YELLOW,glowSize:10*t});for(let i=-1;i<=1;i++)this.renderer.drawLine(e.x-20,e.y+i*10,e.x+20,e.y+i*10,{color:`rgba(255, 200, 100, ${t*.5})`,width:1}),this.renderer.drawLine(e.x+i*10,e.y-20,e.x+i*10,e.y+20,{color:`rgba(255, 200, 100, ${t*.5})`,width:1})}renderRevealEffect(e,t){const i=50+t*100,o=1-t;this.renderer.drawCircle(e.x,e.y,i,{stroke:`rgba(255, 50, 50, ${o*.8})`,strokeWidth:2})}renderBulletTracers(){const e=performance.now();this.bulletTracers=this.bulletTracers.filter(t=>e-t.time<200);for(const t of this.bulletTracers){const o=1-(e-t.time)/200,s=t.isEnemy?`rgba(255, 80, 80, ${o*.9})`:`rgba(100, 255, 255, ${o*.9})`,a=t.isEnemy?`rgba(255, 100, 100, ${o*.8})`:`rgba(100, 255, 200, ${o*.8})`,n=t.isEnemy?y.ATTACKER:y.CYAN;this.renderer.drawLine(t.start.x,t.start.y,t.end.x,t.end.y,{color:s,width:2}),this.renderer.drawCircle(t.end.x,t.end.y,5*o,{fill:a,glow:!0,glowColor:n,glowSize:10*o})}}addMuzzleFlash(e,t){this.muzzleFlashes.push({position:{...e},direction:t,time:performance.now()}),this.particleSystem.muzzleFlashParticles(e,t)}addBulletTracer(e,t,i=!1){this.bulletTracers.push({start:{...e},end:{...t},time:performance.now(),isEnemy:i});const o={x:t.x-e.x,y:t.y-e.y},s=Math.sqrt(o.x*o.x+o.y*o.y);if(s>0){const a={x:-o.x/s,y:-o.y/s};this.particleSystem.bulletImpact(t,a)}}addPlayerDeath(e){this.particleSystem.playerDeath(e)}addPlayerHit(e,t){this.particleSystem.bulletHitPlayer(e,t)}addWeaponSwitch(e){this.particleSystem.weaponSwitch(e)}updateParticles(e){this.particleSystem.update(e)}renderUI(){const e=this.renderer.getWidth(),t=this.renderer.getHeight(),i=this.world.getLocalPlayer();this.renderTopBar(e),i&&i.alive&&this.renderBottomBar(i,e,t),this.renderCrosshair(e,t),this.world.getPhase()!==C.RoundActive&&this.renderPhaseOverlay(e,t)}renderTopBar(e){const t=this.world.getScore(),i=this.world.getTime(),s=Math.max(0,18e4-i),a=this.world.getObjectives(),n=this.world.getLocalPlayer(),l=this.world.getMap();if(this.renderer.drawRect(0,0,e,40,{fill:"rgba(0,0,0,0.7)"}),this.renderer.drawText(`Map: ${l.data.name}`,15,14,{color:"#888",align:"left",baseline:"middle",size:11}),n){const c=X[n.heroId];this.renderer.drawText(c.name,15,28,{color:y.CYAN,align:"left",baseline:"middle",size:12})}if(this.renderer.drawText(`${t.attackers}`,e/2-60,20,{color:y.ATTACKER,align:"center",baseline:"middle",size:24}),this.renderer.drawText(ji(s),e/2,20,{color:y.CYAN,align:"center",baseline:"middle",size:20}),this.renderer.drawText(`${t.defenders}`,e/2+60,20,{color:y.DEFENDER,align:"center",baseline:"middle",size:24}),this.renderer.drawText("v0.5.0-beta",e-10,48,{color:"rgba(255,255,255,0.4)",align:"right",baseline:"middle",size:9}),this.renderer.drawText(`Round ${this.world.getRoundNumber()}`,e/2,35,{color:"#888",align:"center",baseline:"middle",size:10}),a.spikeCarrierId||a.spikePlanted){const c=e-150;if(a.spikePlanted){const d=Math.max(0,45e3-(this.world.getAbsoluteTime()-a.spikePlantTime)),h=Math.sin(this.world.getAbsoluteTime()*.015)*.3+.7;this.renderer.drawRect(c-10,5,160,30,{fill:`rgba(255, 0, 0, ${h*.3})`,stroke:"#ff4444",strokeWidth:2}),this.renderer.drawText(" SPIKE PLANTED",c+70,13,{color:"#ff4444",align:"center",size:12}),this.renderer.drawText(`${(d/1e3).toFixed(1)}s`,c+70,27,{color:"#ffffff",align:"center",size:14})}else if(a.spikeCarrierId){const d=this.world.getPlayers().find(p=>p.id===a.spikeCarrierId),h=n&&a.spikeCarrierId===n.id;this.renderer.drawRect(c-10,5,160,30,{fill:"rgba(0, 0, 0, 0.5)",stroke:h?"#ff8800":"#666",strokeWidth:1}),h?(this.renderer.drawText(" YOU HAVE SPIKE",c+70,13,{color:"#ff8800",align:"center",size:11}),this.renderer.drawText("Hold E in site to plant",c+70,27,{color:"#aaa",align:"center",size:9})):d&&this.renderer.drawText(` ${d.name}`,c+70,20,{color:"#888",align:"center",size:11})}}}renderBottomBar(e,t,i){const s=i-80;this.renderer.drawRect(0,s,t,80,{fill:"rgba(0,0,0,0.7)"}),this.renderer.drawHealthBar(20,s+20,200,20,e.health,e.maxHealth,e.shield,e.maxShield),this.renderer.drawText(`${Math.ceil(e.health)}`,120,s+30,{color:"#fff",align:"center",baseline:"middle",size:14});const a=30,n=5,l=250;for(let d=0;d<5;d++){const h=l+d*(a+n),p=s+15,f=e.weaponInventory[d]!==null,g=e.currentWeaponSlot===d;if(this.renderer.drawRect(h,p,a,a,{fill:g?"rgba(12, 229, 240, 0.3)":"rgba(30, 30, 40, 0.8)",stroke:g?y.CYAN:f?"#555":"#333",strokeWidth:g?2:1}),this.renderer.drawText(`${d+1}`,h+a/2,p+a/2,{color:f?g?y.CYAN:"#aaa":"#444",align:"center",baseline:"middle",size:12}),f){const I=e.weaponInventory[d].weaponId.charAt(0).toUpperCase();this.renderer.drawText(I,h+a/2,p+a+8,{color:"#666",align:"center",size:8})}}this.renderer.drawText(e.weapon.weaponId.toUpperCase().replace("_"," "),t/2,s+20,{color:"#fff",align:"center",size:14});const c=e.weapon.reloading?"RELOADING...":`${e.weapon.ammo} / ${e.weapon.maxAmmo}`;this.renderer.drawText(c,t/2,s+45,{color:e.weapon.reloading?y.YELLOW:y.CYAN,align:"center",size:18}),this.renderAbilities(e,t,s)}renderCrosshair(e,t){const i=e/2,o=t/2,s=10,a=4;this.renderer.drawLine(i-s,o,i-a,o,{color:y.CYAN,width:2}),this.renderer.drawLine(i+a,o,i+s,o,{color:y.CYAN,width:2}),this.renderer.drawLine(i,o-s,i,o-a,{color:y.CYAN,width:2}),this.renderer.drawLine(i,o+a,i,o+s,{color:y.CYAN,width:2}),this.renderer.drawCircle(i,o,2,{fill:y.CYAN})}renderAbilities(e,t,i){const o=X[e.heroId],s=this.world.getTime(),n={Spectre:["","","",""],Byte:["","","",""],Vanta:["","","",""],Katana:["","","",""],Glyph:["","","",""],Spark:["","","",""],Zero:["","","",""],Mira:["","","",""]}[o.name]||["","","",""],l=["","Q","F","X"],c=48,d=8,h=4*c+3*d,p=t-h-20,f=i+16,g=p-70;this.renderer.drawRect(g-30,f+8,60,32,{fill:"rgba(30, 30, 40, 0.8)",stroke:y.YELLOW,strokeWidth:1}),this.renderer.drawText(`$${e.credits}`,g,f+24,{color:y.YELLOW,align:"center",baseline:"middle",size:16});for(let w=0;w<4;w++){const I=e.abilities[w],A=o.abilities[w];if(!I||!A)continue;const P=p+w*(c+d),T=w===0,$=w===3,D=Math.max(0,I.cooldownEndTime-s),G=A.cooldown>0?D/A.cooldown:0,N=D===0,q=I.charges>0;if($?this.drawHexagon(P+c/2,f+c/2,c/2,{fill:N?"rgba(255, 200, 0, 0.3)":"rgba(30, 30, 40, 0.9)",stroke:N?y.YELLOW:"#444",strokeWidth:2}):T?this.renderer.drawRect(P,f,c,c,{fill:"rgba(50, 80, 50, 0.6)",stroke:"#4a4",strokeWidth:1}):this.renderer.drawRect(P,f,c,c,{fill:N&&q?"rgba(12, 229, 240, 0.2)":"rgba(30, 30, 40, 0.9)",stroke:N&&q?y.CYAN:"#444",strokeWidth:N&&q?2:1}),G>0&&!T){const B=P+c/2,W=f+c/2,Be=c/2-2;this.renderer.getContext().save(),this.renderer.getContext().globalAlpha=.7,this.renderer.getContext().fillStyle="#000",this.renderer.getContext().beginPath(),this.renderer.getContext().moveTo(B,W),this.renderer.getContext().arc(B,W,Be,-Math.PI/2,-Math.PI/2+Math.PI*2*G,!1),this.renderer.getContext().closePath(),this.renderer.getContext().fill(),this.renderer.getContext().restore();const Ie=Math.ceil(D/1e3);this.renderer.drawText(`${Ie}`,P+c/2,f+c/2,{color:"#fff",align:"center",baseline:"middle",size:16})}else this.renderer.drawText(n[w]??"",P+c/2,f+c/2,{color:"#fff",align:"center",baseline:"middle",size:20});const se=T?"#4a4":N&&q?y.CYAN:"#666";if(this.renderer.drawText(l[w]??"",P+8,f+10,{color:se,align:"center",baseline:"middle",size:10}),A.charges>1){const B=`${I.charges}/${A.charges}`;this.renderer.drawText(B,P+c-8,f+c-6,{color:I.charges>0?y.CYAN:"#666",align:"center",baseline:"middle",size:9})}if($){const B=I.ultimateCharge||0,W=A.ultimateCost||6,Be=Math.min(1,B/W),Ie=c-4,Ee=4,Je=P+2,Ce=f+c+2;this.renderer.drawRect(Je,Ce,Ie,Ee,{fill:"#222"});const ai=B>=W;this.renderer.drawRect(Je,Ce,Ie*Be,Ee,{fill:ai?y.YELLOW:y.CYAN}),ai?this.renderer.drawText("READY",P+c/2,Ce+Ee+8,{color:y.YELLOW,align:"center",baseline:"middle",size:8}):this.renderer.drawText(`${Math.floor(B)}/${W}`,P+c/2,Ce+Ee+8,{color:"#888",align:"center",baseline:"middle",size:8})}if(!$){const B=A.name.length>10?A.name.substring(0,9)+"":A.name;this.renderer.drawText(B,P+c/2,f+c+8,{color:T?"#4a4":"#888",align:"center",baseline:"middle",size:7})}}this.renderer.drawText(o.name.toUpperCase(),p+h/2,f-8,{color:y.CYAN,align:"center",baseline:"middle",size:12})}drawHexagon(e,t,i,o){const s=this.renderer.getContext();s.save(),s.beginPath();for(let a=0;a<6;a++){const n=Math.PI/3*a-Math.PI/2,l=e+i*Math.cos(n),c=t+i*Math.sin(n);a===0?s.moveTo(l,c):s.lineTo(l,c)}s.closePath(),o.fill&&(s.fillStyle=o.fill,s.fill()),o.stroke&&(s.strokeStyle=o.stroke,s.lineWidth=o.strokeWidth||1,s.stroke()),s.restore()}renderPhaseOverlay(e,t){const i=this.world.getPhase();let o="",s="";switch(i){case C.Lobby:o="WAITING FOR PLAYERS",s="Press SPACE to start when ready";break;case C.BuyPhase:o="BUY PHASE",s="Purchase weapons and abilities";break;case C.RoundEnd:const a=this.world.getScore();o="ROUND OVER",s=`Attackers: ${a.attackers} - Defenders: ${a.defenders}`;break;case C.MatchEnd:const n=this.world.getScore();o=n.attackers>n.defenders?"ATTACKERS WIN":"DEFENDERS WIN",s=`Final Score: ${n.attackers} - ${n.defenders}`;break}if(this.renderer.drawRect(0,0,e,t,{fill:"rgba(0,0,0,0.5)"}),this.renderer.drawText(o,e/2,t/2-40,{color:y.CYAN,align:"center",baseline:"middle",size:36,glow:!0,glowColor:y.CYAN,glowSize:20}),this.renderer.drawText(s,e/2,t/2,{color:"#888",align:"center",baseline:"middle",size:16}),i===C.RoundEnd){const a=this.world.getCountdownTime(),n=this.world.isCountdownPaused(),l=this.world.getCountdownPausedBy(),c=Math.ceil(a/1e3),d=n?`PAUSED by ${l}`:`Next round in ${c}s`,h=n?y.YELLOW:y.CYAN;this.renderer.drawText(d,e/2,t/2+40,{color:h,align:"center",baseline:"middle",size:24,glow:!0,glowColor:h,glowSize:10});const p=n?"Press P to resume":"Press P to pause countdown";this.renderer.drawText(p,e/2,t/2+70,{color:"#666",align:"center",baseline:"middle",size:12})}}updateWorld(e){this.world=e}}var O=(r=>(r.PulsePistolShoot="weapon_pulse_pistol_shoot",r.PlasmaRifleShoot="weapon_plasma_rifle_shoot",r.ScatterGunShoot="weapon_scatter_gun_shoot",r.FusionCannonShoot="weapon_fusion_cannon_shoot",r.WeaponReload="weapon_reload",r.WeaponEmpty="weapon_empty",r.WeaponSwitch="weapon_switch",r.FootstepMetal="player_footstep",r.PlayerDamage="player_damage",r.PlayerDeath="player_death",r.PlayerRespawn="player_respawn",r.BulletImpactWall="combat_impact_wall",r.BulletImpactPlayer="combat_impact_player",r.Headshot="combat_headshot",r.KillConfirmed="combat_kill",r.AbilityCast="ability_cast",r.Explosion="ability_explosion",r.Teleport="ability_teleport",r.RoundStart="game_round_start",r.RoundEnd="game_round_end",r.MatchWin="game_match_win",r.MatchLose="game_match_lose",r.CountdownTick="game_countdown_tick",r.CountdownGo="game_countdown_go",r.UIClick="ui_click",r.UIHover="ui_hover",r.UISuccess="ui_success",r.UIError="ui_error",r))(O||{});const _t={weapon_pulse_pistol_shoot:"./assets/audio/weapons/pulse_pistol_shoot.mp3",weapon_plasma_rifle_shoot:"./assets/audio/weapons/plasma_rifle_shoot.mp3",weapon_scatter_gun_shoot:"./assets/audio/weapons/scatter_gun_shoot.mp3",weapon_fusion_cannon_shoot:"./assets/audio/weapons/fusion_cannon_shoot.mp3",weapon_reload:"./assets/audio/weapons/reload.mp3",weapon_empty:"./assets/audio/weapons/empty_click.mp3",weapon_switch:"./assets/audio/weapons/weapon_switch.mp3",player_footstep:"./assets/audio/player/footstep_metal.mp3",player_damage:"./assets/audio/player/damage.mp3",player_death:"./assets/audio/player/death.mp3",player_respawn:"./assets/audio/player/respawn.mp3",combat_impact_wall:"./assets/audio/combat/impact_wall.mp3",combat_impact_player:"./assets/audio/combat/impact_player.mp3",combat_headshot:"./assets/audio/combat/headshot.mp3",combat_kill:"./assets/audio/combat/kill_confirmed.mp3",ability_cast:"./assets/audio/abilities/cast.mp3",ability_explosion:"./assets/audio/abilities/explosion.mp3",ability_teleport:"./assets/audio/abilities/teleport.mp3",game_round_start:"./assets/audio/game/round_start.mp3",game_round_end:"./assets/audio/game/round_end.mp3",game_match_win:"./assets/audio/game/match_win.mp3",game_match_lose:"./assets/audio/game/match_lose.mp3",game_countdown_tick:"./assets/audio/game/countdown_tick.mp3",game_countdown_go:"./assets/audio/game/countdown_go.mp3",ui_click:"./assets/audio/ui/click.mp3",ui_hover:"./assets/audio/ui/hover.mp3",ui_success:"./assets/audio/ui/success.mp3",ui_error:"./assets/audio/ui/error.mp3",music_menu:"./assets/audio/music/menu_theme.mp3",music_gameplay:"./assets/audio/music/gameplay_loop.mp3",music_victory:"./assets/audio/music/victory_theme.mp3",music_defeat:"./assets/audio/music/defeat_theme.mp3"},di={weapon_pulse_pistol_shoot:"sfx",weapon_plasma_rifle_shoot:"sfx",weapon_scatter_gun_shoot:"sfx",weapon_fusion_cannon_shoot:"sfx",weapon_reload:"sfx",weapon_empty:"sfx",weapon_switch:"sfx",player_footstep:"sfx",player_damage:"sfx",player_death:"sfx",player_respawn:"sfx",combat_impact_wall:"sfx",combat_impact_player:"sfx",combat_headshot:"sfx",combat_kill:"sfx",ability_cast:"sfx",ability_explosion:"sfx",ability_teleport:"sfx",game_round_start:"voice",game_round_end:"voice",game_match_win:"voice",game_match_lose:"voice",game_countdown_tick:"voice",game_countdown_go:"voice",ui_click:"ui",ui_hover:"ui",ui_success:"ui",ui_error:"ui",music_menu:"music",music_gameplay:"music",music_victory:"music",music_defeat:"music"},Ss={player_footstep:.3,ui_hover:.4,combat_impact_wall:.5},hi={masterVolume:80,musicVolume:50,sfxVolume:80,uiVolume:70,voiceVolume:100,masterEnabled:!0,musicEnabled:!0,sfxEnabled:!0,uiEnabled:!0,voiceEnabled:!0};class xs{audioManager;loadedSounds=new Set;settings;constructor(){this.audioManager=new Vi,this.settings={...hi},this.loadSettings()}loadSettings(){try{const e=localStorage.getItem("cybergrid_audioSettings");e&&(this.settings={...hi,...JSON.parse(e)})}catch{}}saveSettings(){try{localStorage.setItem("cybergrid_audioSettings",JSON.stringify(this.settings))}catch{}}getSettings(){return{...this.settings}}updateSettings(e){this.settings={...this.settings,...e},this.applySettings(),this.saveSettings()}applySettings(){this.audioManager.setMasterVolume(this.settings.masterEnabled?this.settings.masterVolume/100:0),this.audioManager.setMusicVolume(this.settings.musicEnabled?this.settings.musicVolume/100:0)}getEffectiveVolume(e,t){if(!this.settings.masterEnabled)return 0;const i=di[e]||"sfx";let o=1,s=!0;switch(i){case"music":o=this.settings.musicVolume/100,s=this.settings.musicEnabled;break;case"sfx":o=this.settings.sfxVolume/100,s=this.settings.sfxEnabled;break;case"ui":o=this.settings.uiVolume/100,s=this.settings.uiEnabled;break;case"voice":o=this.settings.voiceVolume/100,s=this.settings.voiceEnabled;break}if(!s)return 0;const a=Ss[e]??1,n=this.settings.masterVolume/100;return a*t*o*n}isCategoryEnabled(e){if(!this.settings.masterEnabled)return!1;switch(di[e]||"sfx"){case"music":return this.settings.musicEnabled;case"sfx":return this.settings.sfxEnabled;case"ui":return this.settings.uiEnabled;case"voice":return this.settings.voiceEnabled;default:return!0}}async init(){await this.audioManager.init(),this.applySettings(),console.log("[GameAudio] Initialized")}async loadAllSounds(){const e=[];for(const[t,i]of Object.entries(_t))e.push(this.audioManager.loadSound(t,i).then(()=>{this.loadedSounds.add(t)}).catch(()=>{console.warn(`[GameAudio] Failed to load: ${t}`)}));await Promise.race([Promise.allSettled(e),new Promise(t=>setTimeout(t,1e4))]),console.log(`[GameAudio] Loaded ${this.loadedSounds.size}/${Object.keys(_t).length} sounds`)}async loadEssentialSounds(){const e=["weapon_pulse_pistol_shoot","weapon_plasma_rifle_shoot","weapon_scatter_gun_shoot","weapon_fusion_cannon_shoot","player_damage","player_death","combat_kill","game_round_start","game_countdown_tick","ui_click","ui_hover"];for(const t of e){const i=_t[t];if(i)try{await this.audioManager.loadSound(t,i),this.loadedSounds.add(t)}catch{}}console.log(`[GameAudio] Loaded ${this.loadedSounds.size} essential sounds`)}play(e,t=1){if(!this.isCategoryEnabled(e))return null;const i=this.getEffectiveVolume(e,t);return i<=0?null:this.audioManager.play(e,{volume:i})}playAtOffset(e,t,i=1){if(!this.isCategoryEnabled(e))return null;const o=this.getEffectiveVolume(e,i);return o<=0?null:this.audioManager.play(e,{volume:o,offset:t})}getSoundDuration(e){return this.audioManager.getSoundDuration(e)}playWithVariation(e,t=1){if(!this.isCategoryEnabled(e))return null;const i=this.getEffectiveVolume(e,t);if(i<=0)return null;const o=.9+Math.random()*.2;return this.audioManager.play(e,{volume:i,pitch:o})}stop(e){this.audioManager.stop(e)}playMusic(e,t=1){!this.settings.masterEnabled||!this.settings.musicEnabled||this.audioManager.playMusic(e,t)}stopMusic(e=.5){this.audioManager.stopMusic(e)}stopAll(){this.audioManager.stopAll()}isEnabled(){return this.settings.masterEnabled}async resume(){await this.audioManager.resume()}}let Bt=null;function vs(){return Bt||(Bt=new xs),Bt}const Z={apiKey:"AIzaSyBaF85KsT8rIfVSXkyO_815TvxtgauSLRQ",authDomain:"cybergrid-assult.firebaseapp.com",projectId:"cybergrid-assult",storageBucket:"cybergrid-assult.firebasestorage.app",messagingSenderId:"576758568996",appId:"1:576758568996:web:f6faf029bb1fe37b4b20b1",measurementId:"G-QNLH88NB94"};class ks{db=null;firebase=null;playerId="";currentSession=null;isInitialized=!1;countryInfo={code:"XX",name:"Unknown"};getOrCreatePlayerId(){const e="cybergrid_playerId";let t=localStorage.getItem(e);return t||(t=`player_${Date.now().toString(36)}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem(e,t)),t}async detectCountry(){try{const e=await fetch("https://ipapi.co/json/",{method:"GET",headers:{Accept:"application/json"}});if(e.ok){const t=await e.json();return{code:t.country_code||"XX",name:t.country_name||"Unknown"}}}catch(e){console.warn("[PlayerStats] Country detection failed:",e)}return{code:"XX",name:"Unknown"}}async initialize(){if(!this.isInitialized)try{this.playerId=this.getOrCreatePlayerId(),this.detectCountry().then(g=>{this.countryInfo=g,console.log(`[PlayerStats] Country detected: ${g.name} (${g.code})`)});const{initializeApp:e,getApps:t,getApp:i}=await de(async()=>{const{initializeApp:g,getApps:w,getApp:I}=await import("./index.esm-OOYOW6k3.js");return{initializeApp:g,getApps:w,getApp:I}},__vite__mapDeps([0,1]),import.meta.url),{getFirestore:o,collection:s,doc:a,setDoc:n,getDoc:l,updateDoc:c,increment:d,serverTimestamp:h,arrayUnion:p}=await de(async()=>{const{getFirestore:g,collection:w,doc:I,setDoc:A,getDoc:P,updateDoc:T,increment:$,serverTimestamp:D,arrayUnion:G}=await import("./index.esm-DbUeHnob.js");return{getFirestore:g,collection:w,doc:I,setDoc:A,getDoc:P,updateDoc:T,increment:$,serverTimestamp:D,arrayUnion:G}},__vite__mapDeps([2,1]),import.meta.url);this.firebase={collection:s,doc:a,setDoc:n,getDoc:l,updateDoc:c,increment:d,serverTimestamp:h,arrayUnion:p};const f=t().length===0?e(Z):i();this.db=o(f),this.isInitialized=!0,console.log(`[PlayerStats] Initialized with player ID: ${this.playerId}`)}catch(e){console.error("[PlayerStats] Initialization failed:",e)}}async startSession(e,t){this.isInitialized||await this.initialize();const{doc:i,getDoc:o,setDoc:s,updateDoc:a,serverTimestamp:n}=this.firebase;this.currentSession={sessionId:`session_${Date.now()}`,startTime:Date.now(),heroId:t,gamesPlayed:0,gamesWon:0,kills:0,deaths:0,assists:0};try{const l=i(this.db,"playerStats",this.playerId);if((await o(l)).exists())await a(l,{callsign:e,country:this.countryInfo.code,countryName:this.countryInfo.name,lastSeenAt:n(),lastSessionStart:n()});else{const d={odplayerId:this.playerId,callsign:e,country:this.countryInfo.code,countryName:this.countryInfo.name,totalPlayTimeSeconds:0,gamesPlayed:0,gamesWon:0,gamesLost:0,totalKills:0,totalDeaths:0,totalAssists:0,favoriteHero:t,heroStats:{},firstSeenAt:n(),lastSeenAt:n(),lastSessionStart:n()};await s(l,d),await this.incrementGlobalStat("totalUniquePlayers",1),await this.updateCountryStats(this.countryInfo.code,1)}console.log(`[PlayerStats] Session started for ${e}`)}catch(l){console.error("[PlayerStats] Failed to start session:",l)}}async recordGameResult(e,t,i,o,s){if(!this.isInitialized||!this.currentSession)return;const{doc:a,updateDoc:n,increment:l,serverTimestamp:c}=this.firebase;this.currentSession.gamesPlayed++,e&&this.currentSession.gamesWon++,this.currentSession.kills+=t,this.currentSession.deaths+=i,this.currentSession.assists+=o;try{const d=a(this.db,"playerStats",this.playerId);await n(d,{gamesPlayed:l(1),gamesWon:l(e?1:0),gamesLost:l(e?0:1),totalKills:l(t),totalDeaths:l(i),totalAssists:l(o),lastSeenAt:c(),[`heroStats.${s}.gamesPlayed`]:l(1),[`heroStats.${s}.gamesWon`]:l(e?1:0),[`heroStats.${s}.kills`]:l(t),[`heroStats.${s}.deaths`]:l(i)}),await this.incrementGlobalStat("totalGamesPlayed",1),console.log(`[PlayerStats] Game recorded: ${e?"WIN":"LOSS"} - K:${t} D:${i} A:${o}`)}catch(d){console.error("[PlayerStats] Failed to record game:",d)}}async endSession(){if(!this.isInitialized||!this.currentSession)return;const{doc:e,updateDoc:t,increment:i,serverTimestamp:o}=this.firebase,s=Math.floor((Date.now()-this.currentSession.startTime)/1e3);try{const a=e(this.db,"playerStats",this.playerId);await t(a,{totalPlayTimeSeconds:i(s),lastSeenAt:o(),[`heroStats.${this.currentSession.heroId}.playTimeSeconds`]:i(s)}),await this.incrementGlobalStat("totalPlayTimeHours",s/3600),console.log(`[PlayerStats] Session ended. Duration: ${Math.floor(s/60)} minutes`)}catch(a){console.error("[PlayerStats] Failed to end session:",a)}this.currentSession=null}async incrementGlobalStat(e,t){const{doc:i,getDoc:o,setDoc:s,updateDoc:a,increment:n,serverTimestamp:l}=this.firebase;try{const c=i(this.db,"globalStats","stats");(await o(c)).exists()?await a(c,{[e]:n(t),lastUpdated:l()}):await s(c,{totalUniquePlayers:e==="totalUniquePlayers"?t:0,totalGamesPlayed:e==="totalGamesPlayed"?t:0,totalPlayTimeHours:e==="totalPlayTimeHours"?t:0,playersByCountry:{},lastUpdated:l()})}catch(c){console.error("[PlayerStats] Failed to update global stat:",c)}}async updateCountryStats(e,t){const{doc:i,updateDoc:o,increment:s,serverTimestamp:a}=this.firebase;try{const n=i(this.db,"globalStats","stats");await o(n,{[`playersByCountry.${e}`]:s(t),lastUpdated:a()})}catch(n){console.error("[PlayerStats] Failed to update country stats:",n)}}async getMyStats(){this.isInitialized||await this.initialize();const{doc:e,getDoc:t}=this.firebase;try{const i=e(this.db,"playerStats",this.playerId),o=await t(i);if(o.exists())return o.data()}catch(i){console.error("[PlayerStats] Failed to get stats:",i)}return null}async getGlobalStats(){this.isInitialized||await this.initialize();const{doc:e,getDoc:t}=this.firebase;try{const i=e(this.db,"globalStats","stats"),o=await t(i);if(o.exists())return o.data()}catch(i){console.error("[PlayerStats] Failed to get global stats:",i)}return null}getPlayerId(){return this.playerId}hasActiveSession(){return this.currentSession!==null}}const Le=new ks,Ps="G-QNLH88NB94";class Is{initialized=!1;isAvailable(){return typeof window<"u"&&typeof window.gtag=="function"}initialize(){this.initialized||(this.isAvailable()?(this.initialized=!0,console.log("[Analytics] GA4 initialized")):console.warn("[Analytics] gtag not available - analytics disabled"))}trackEvent(e,t){if(this.isAvailable())try{window.gtag("event",e,{...t,send_to:Ps})}catch(i){console.warn("[Analytics] Failed to track event:",i)}}trackGameStart(e,t){this.trackEvent("game_start",{mode:e,callsign_length:t.length})}trackGameEnd(e,t){this.trackEvent("game_end",{duration_seconds:e,games_played:t})}trackMatchStart(e){this.trackEvent("match_start",{game_mode:e.gameMode,map_id:e.mapId,player_count:e.playerCount,bot_count:e.botCount,is_host:e.isHost})}trackMatchEnd(e){this.trackEvent("match_end",{game_mode:e.gameMode,map_id:e.mapId,won:e.won,duration_seconds:e.durationSeconds,kills:e.kills,deaths:e.deaths,assists:e.assists,hero_id:e.heroId,kd_ratio:e.deaths>0?(e.kills/e.deaths).toFixed(2):e.kills})}trackHeroSelect(e){this.trackEvent("hero_select",{hero_id:e})}trackAbilityUse(e,t,i){this.trackEvent("ability_use",{hero_id:e,ability_name:t,ability_slot:i})}trackWeaponPurchase(e,t){this.trackEvent("weapon_purchase",{weapon_id:e,price:t})}trackUIOpen(e){const t={settings:"settings_open",how_to_play:"how_to_play_open",buy_menu:"buy_menu_open"};this.trackEvent(t[e])}trackRoundEnd(e){this.trackEvent("round_end",{round_number:e.roundNumber,won:e.won,team_score:e.teamScore,enemy_score:e.enemyScore})}setUserProperties(e){if(this.isAvailable())try{window.gtag("set","user_properties",e)}catch(t){console.warn("[Analytics] Failed to set user properties:",t)}}}const te=new Is;typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{te.initialize()}):te.initialize());const Es={enemyBotCount:3,friendlyBotCount:0,botDifficulty:"medium",gameMode:"deathmatch",playerHero:"vanta",abilityQSlot:1,abilityFSlot:2,totalRounds:5,mapId:"neon_arena"};class ui{gameLoop;inputManager;renderer;audio;world;gameRenderer;network=null;existingNetwork=null;lobbyPlayers=[];isHost=!1;localPeerId="";debugBroadcastStarted=!1;playerName;canvas;settings;initialized=!1;lastInputSendTime=0;lastPingTime=0;lastLocalFireTime=0;lastStateBroadcastTime=0;debugInfo=null;debugLoggedNoPlayer=!1;debugReceivedState=!1;showFPS=!0;lastPhase=C.RoundActive;countdownSoundId=null;lastCountdownPaused=!1;heroTutorialShown=!1;heroTutorialOverlay=null;constructor(e){this.canvas=e.canvas,this.playerName=e.playerName,this.settings=e.settings||Es,this.existingNetwork=e.network||null,this.lobbyPlayers=e.lobbyPlayers||[],console.log(`[Game] Constructor - existingNetwork: ${!!this.existingNetwork}, lobbyPlayers: ${this.lobbyPlayers.length}`),console.log(`[Game] Ability settings - Q slot: ${this.settings.abilityQSlot}, F slot: ${this.settings.abilityFSlot}`),this.existingNetwork&&console.log(`[Game] Constructor - existing network has ${this.existingNetwork.getPeerIds().length} peers`),this.settings.aiMode==="slm"?st.setMode(Y.SLM):st.setMode(Y.RuleBased),console.log(`[Game] Bot AI mode: ${st.getModeName()}`),this.renderer=new Gi(this.canvas,Rt.canvasWidth,Rt.canvasHeight),this.inputManager=new Oi(this.canvas),this.audio=vs();const t=this.settings.gameMode==="spike"?j.DataSpikeAssault:j.NeonDeathmatch;this.world=new tt({mode:t,maxPlayers:8,isHost:!0,abilityQSlot:this.settings.abilityQSlot,abilityFSlot:this.settings.abilityFSlot,totalRounds:this.settings.totalRounds,mapId:this.settings.mapId}),this.gameRenderer=new bs(this.renderer,this.world),this.gameLoop=new Fi(Rt.tickRate,this.update.bind(this),this.render.bind(this)),this.debugInfo=document.getElementById("debug-info")}async init(){this.initialized||(await this.audio.init(),await this.audio.loadEssentialSounds(),this.initialized=!0,console.log("[Game] Initialized"))}start(){if(!this.initialized){console.error("[Game] Not initialized");return}this.gameLoop.start(),console.log("[Game] Started"),this.checkAndShowHeroTutorial()}stop(){this.countdownSoundId&&(this.audio.stop(this.countdownSoundId),this.countdownSoundId=null),this.gameLoop.stop(),console.log("[Game] Stopped")}pause(){this.gameLoop.stop(),console.log("[Game] Paused")}resume(){this.gameLoop.start(),console.log("[Game] Resumed")}isPaused(){return!this.gameLoop.isRunning()}restartGame(){if(!this.isHost)return;const e=this.settings.gameMode==="spike"?j.DataSpikeAssault:j.NeonDeathmatch;this.world=new tt({mode:e,maxPlayers:8,isHost:!0,abilityQSlot:this.settings.abilityQSlot,abilityFSlot:this.settings.abilityFSlot,totalRounds:this.settings.totalRounds,mapId:this.settings.mapId}),this.gameRenderer.updateWorld(this.world);const t=this.getHeroFromSettings(),i=this.world.addPlayer(this.localPeerId||"local",this.playerName,m.Attackers,t);if(this.world.setLocalPlayer(i.id),this.network){const o=this.network.getPeerIds();console.log(`[Game] Restart: Re-adding ${o.length} connected peers to Defenders`);for(const s of o){const n=this.lobbyPlayers.find(l=>l.id===s)?.name||`Player ${s.slice(-4)}`;this.world.addPlayer(s,n,m.Defenders,k.Vanta)}}else{const o=this.settings.enemyBotCount,s=this.settings.botDifficulty;o>0&&(this.world.spawnBots(o,m.Defenders,s),console.log(`[Game] Restart: Spawning ${o} enemy bots for single player`));const a=this.settings.friendlyBotCount;a>0&&(this.world.spawnBots(a,m.Attackers,s),console.log(`[Game] Restart: Spawning ${a} friendly bots`))}this.world.setPhase(C.RoundActive),this.world.startRound(),console.log("[Game] Restarted")}nextRound(){this.isHost&&(this.world.setPhase(C.RoundActive),this.world.startRound(),console.log("[Game] Next round started"))}getRoundEndInfo(){const e=this.world.getPhase();if(e!==C.RoundEnd&&e!==C.MatchEnd)return null;const t=this.world.getAttackerScore(),i=this.world.getDefenderScore(),o=t>i?"attackers":"defenders";return{isRoundOver:!0,isMatchOver:e===C.MatchEnd,winningTeam:o,attackerScore:t,defenderScore:i,roundsToWin:this.world.getRoundsToWin(),totalRounds:this.world.getTotalRounds()}}getCountdownInfo(){return this.world.getPhase()!==C.RoundEnd?null:{countdownTime:this.world.getCountdownTime(),isPaused:this.world.isCountdownPaused(),pausedBy:this.world.getCountdownPausedBy()}}isRoundActive(){return this.world.getPhase()===C.RoundActive}getLocalPlayerStats(){const e=this.world.getLocalPlayer();return e?{kills:e.kills,deaths:e.deaths,assists:e.assists,team:e.team}:null}didLocalPlayerWin(){const e=this.world.getLocalPlayer();if(!e)return!1;const t=this.world.getAttackerScore(),i=this.world.getDefenderScore();return e.team===m.Attackers?t>i:i>t}sessionStartTime=0;gamesPlayedThisSession=0;async startStatsSession(){this.sessionStartTime=Date.now(),this.gamesPlayedThisSession=0;try{await Le.startSession(this.playerName,this.settings.playerHero),console.log("[Game] Stats session started")}catch(e){console.warn("[Game] Failed to start stats session:",e)}te.trackHeroSelect(this.settings.playerHero)}async recordMatchResult(){const e=this.getLocalPlayerStats();if(!e)return;const t=this.didLocalPlayerWin();this.gamesPlayedThisSession++;try{await Le.recordGameResult(t,e.kills,e.deaths,e.assists,this.settings.playerHero),console.log(`[Game] Match result recorded: ${t?"WIN":"LOSS"}`)}catch(i){console.warn("[Game] Failed to record match result:",i)}te.trackMatchEnd({gameMode:this.settings.gameMode,mapId:this.settings.mapId,won:t,durationSeconds:Math.floor((Date.now()-this.sessionStartTime)/1e3),kills:e.kills,deaths:e.deaths,assists:e.assists,heroId:this.settings.playerHero})}async endStatsSession(){const e=Math.floor((Date.now()-this.sessionStartTime)/1e3);try{await Le.endSession(),console.log("[Game] Stats session ended")}catch(t){console.warn("[Game] Failed to end stats session:",t)}te.trackGameEnd(e,this.gamesPlayedThisSession)}trackMatchStart(){const e=this.lobbyPlayers.length||1,t=this.settings.enemyBotCount+this.settings.friendlyBotCount;te.trackMatchStart({gameMode:this.settings.gameMode,mapId:this.settings.mapId,playerCount:e,botCount:t,isHost:this.isHost})}async hostGame(e){this.isHost=!0,console.log(`[Game] hostGame() called - existingNetwork: ${!!this.existingNetwork}`),this.existingNetwork&&console.log(`[Game] hostGame() - existingNetwork peers: ${this.existingNetwork.getPeerIds().length}`);const t=this.settings.gameMode==="spike"?j.DataSpikeAssault:j.NeonDeathmatch;this.world=new tt({mode:t,maxPlayers:8,isHost:!0,abilityQSlot:this.settings.abilityQSlot,abilityFSlot:this.settings.abilityFSlot,totalRounds:this.settings.totalRounds,mapId:this.settings.mapId}),this.gameRenderer.updateWorld(this.world);const i=this.getHeroFromSettings();let o=e||this.generateRoomCode();this.localPeerId="local";const s=this.world.addPlayer("local",this.playerName,m.Attackers,i);if(this.world.setLocalPlayer(s.id),this.existingNetwork){console.log("[Game] Using existing network from lobby"),this.network=this.existingNetwork,this.existingNetwork=null;const d=this.network.getPeerIds(),h=this.network.getPeerCount();console.log(`[Game] Network has ${h} peers: [${d.join(", ")}]`),console.log("[Game] Lobby players passed to game:",this.lobbyPlayers);const p=this.network.getLocalPeerId();this.localPeerId=p,s.peerId=p,this.world.updatePlayerPeerId("local",p),this.setupNetworkListeners(),o=this.network.getRoomCode()||o,console.log(`[Game] Using existing room: ${o}`);for(const f of d){const w=this.lobbyPlayers.find(I=>I.id===f)?.name||`Player ${f.slice(-4)}`;this.world.addPlayer(f,w,m.Defenders,k.Vanta),console.log(`[Game] Added lobby player to game: ${w} (${f}) as Defender`)}}else try{if(Z.apiKey&&Z.apiKey!=="YOUR_API_KEY"){this.network=new Me({isHost:!0,useFirestore:!0}),await this.network.connectWithFirebase(Z);const d=this.network.getLocalPeerId();this.localPeerId=d,s.peerId=d,this.world.updatePlayerPeerId("local",d),this.setupNetworkListeners(),await this.network.createRoom(),console.log(`[Game] Connected to Firebase, hosting room: ${o}`)}else{this.network=new Me({isHost:!0}),await this.network.connect(Qe.SIGNALING_SERVER);const d=this.network.getLocalPeerId();this.localPeerId=d,s.peerId=d,this.world.updatePlayerPeerId("local",d),this.setupNetworkListeners(),await this.network.createRoom(),console.log(`[Game] Connected to signaling server, hosting room: ${o}`)}}catch{console.log("[Game] Networking not available, running in local-only mode"),this.network=null}const a=this.network?.getPeerCount()||0,n=this.network!==null&&a>0;if(!n&&this.settings.enemyBotCount>0){const d=this.settings.enemyBotCount,h=this.settings.botDifficulty;this.world.spawnBots(d,m.Defenders,h),console.log(`[Game] Solo mode: Spawning ${d} ${h} enemy bots`)}else n&&console.log(`[Game] Multiplayer mode: No bots will be spawned (${a} peers connected)`);if(!n&&this.settings.friendlyBotCount>0){const d=this.settings.friendlyBotCount,h=this.settings.botDifficulty;this.world.spawnBots(d,m.Attackers,h),console.log(`[Game] Solo mode: Spawning ${d} ${h} friendly bots`)}this.world.setPhase(C.RoundActive),this.world.startRound(),this.audio.play(O.RoundStart);const l=this.world.getTeamPlayers(m.Attackers),c=this.world.getTeamPlayers(m.Defenders);return console.log(`[Game] Team composition - Attackers: ${l.length} (${l.map(d=>`${d.name}/${d.peerId}/${d.alive}`).join(", ")})`),console.log(`[Game] Team composition - Defenders: ${c.length} (${c.map(d=>`${d.name}/${d.peerId}/${d.alive}`).join(", ")})`),c.length===0&&n&&console.warn("[Game] WARNING: No defenders but this is a multiplayer game! Waiting for peers..."),console.log(`[Game] Hosting game: ${o}, hero: ${i}`),o}generateRoomCode(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ",t="0123456789";let i="";for(let o=0;o<4;o++)i+=e.charAt(Math.floor(Math.random()*e.length));for(let o=0;o<2;o++)i+=t.charAt(Math.floor(Math.random()*t.length));return i}getHeroFromSettings(){switch(this.settings.playerHero){case"vanta":return k.Vanta;case"spectre":return k.Spectre;case"byte":return k.Byte;case"katana":return k.Katana;case"glyph":return k.Glyph;case"spark":return k.Spark;case"zero":return k.Zero;case"mira":return k.Mira;default:return k.Vanta}}async joinGame(e){this.isHost=!1;const t=this.settings.gameMode==="spike"?j.DataSpikeAssault:j.NeonDeathmatch;if(this.world=new tt({mode:t,maxPlayers:8,isHost:!1,abilityQSlot:this.settings.abilityQSlot,abilityFSlot:this.settings.abilityFSlot,totalRounds:this.settings.totalRounds,mapId:this.settings.mapId}),this.gameRenderer.updateWorld(this.world),this.existingNetwork)console.log("[Game] Using existing network from lobby for joining"),this.network=this.existingNetwork,this.existingNetwork=null,this.setupNetworkListeners(),this.localPeerId=this.network.getLocalPeerId();else try{Z.apiKey&&Z.apiKey!=="YOUR_API_KEY"?(this.network=new Me({isHost:!1,useFirestore:!0}),await this.network.connectWithFirebase(Z),console.log("[Game] Connected to Firebase for joining")):(this.network=new Me({isHost:!1}),await this.network.connect(Qe.SIGNALING_SERVER),console.log("[Game] Connected to signaling server for joining")),this.setupNetworkListeners(),await this.network.joinRoom(e),console.log(`[Game] Joining room: ${e}`),this.localPeerId=this.network.getLocalPeerId()}catch(s){throw console.error("[Game] Failed to join game:",s),new Error("Could not connect. Make sure Firebase is configured or the signaling server is running.")}const i=this.getHeroFromSettings(),o=this.world.addPlayer(this.localPeerId,this.playerName,m.Defenders,i);this.world.setLocalPlayer(o.id),this.network&&(this.network.broadcast({type:R.PlayerJoin,timestamp:Date.now(),senderId:this.localPeerId,data:{name:this.playerName,heroId:i}}),console.log("[Game] Sent PlayerJoin to host")),console.log("[Game] Waiting for connection to host...")}leaveGame(){this.network?.disconnect(),this.network=null,this.world.setPhase(C.Lobby)}setupNetworkListeners(){if(this.network&&(this.network.on("peerConnected",({peerId:e})=>{if(console.log(`[Game] Peer connected: ${e}`),this.isHost){const t=this.world.getPlayerByPeerId(e);if(t)t.isDisconnected?(t.isDisconnected=!1,console.log(`[Game] Player ${e} reconnected: ${t.name}`)):console.log(`[Game] Player ${e} already exists: ${t.name}`);else{const i=this.lobbyPlayers.find(s=>s.id===e),o=i?.name||`Player ${e.slice(-4)}`;this.world.addPlayer(e,o,m.Defenders,k.Vanta),console.log(`[Game] Added new player ${e} to Defenders: "${o}"`),i||setTimeout(()=>{const s=this.world.getPlayerByPeerId(e);s&&s.name===o&&s.name.startsWith("Player ")&&(console.log(`[Game] Removing unverified player ${e} (no PlayerJoin received)`),this.world.removePlayer(s.id))},1e4)}}}),this.network.on("peerDisconnected",({peerId:e})=>{console.log(`[Game] Peer disconnected: ${e}`);const t=this.world.getPlayerByPeerId(e);t&&(t.isDisconnected=!0,console.log(`[Game] Marked player ${t.name} (${e}) as disconnected`),setTimeout(()=>{const i=this.world.getPlayerByPeerId(e);i&&i.isDisconnected&&(console.log(`[Game] Removing disconnected player ${i.name} (${e}) after timeout`),this.world.removePlayer(i.id))},3e4))}),this.network.on("packet",({peerId:e,packet:t})=>{this.handlePacket(e,t)}),this.isHost)){const e=this.network.getPeerIds();console.log(`[Game] Found ${e.length} existing peers from lobby`),console.log("[Game] Lobby players:",this.lobbyPlayers);for(const t of e)if(!this.world.getPlayerByPeerId(t)){const s=this.lobbyPlayers.find(a=>a.id===t)?.name||`Player ${t.slice(-4)}`;this.world.addPlayer(t,s,m.Defenders,k.Vanta),console.log(`[Game] Added remote player ${t} to Defenders: "${s}"`)}}}handlePacket(e,t){switch(t.type){case R.PlayerJoin:if(this.isHost){const i=t.data;console.log(`[Game] Received PlayerJoin from ${e}: name=${i.name}, hero=${i.heroId}`);let o=this.world.getPlayerByPeerId(e);if(o){const s=o.name;o.name=i.name,i.heroId&&(o.heroId=i.heroId),console.log(`[Game] Updated player ${e}: "${s}" -> "${i.name}"`)}else{const s=this.world.getPlayerByName(i.name);if(s&&s.isDisconnected){const a=s.peerId;this.world.updatePlayerPeerId(a,e),s.isDisconnected=!1,i.heroId&&(s.heroId=i.heroId),console.log(`[Game] Reconnected player ${i.name}: ${a} -> ${e}`)}else if(s){const a=this.world.getPlayerByPeerId(e);a&&(console.log(`[Game] Removing duplicate player ${e} (${i.name} already exists)`),this.world.removePlayer(a.id))}else o=this.world.addPlayer(e,i.name,m.Defenders,i.heroId||k.Vanta),console.log(`[Game] Created player ${e}: "${i.name}"`)}}break;case R.Input:if(this.isHost){const i=t.data,o=this.world.getPlayerByPeerId(e);o&&o.alive?(o.setInput(i),(i.moveX!==0||i.moveY!==0)&&console.log(`[Game] Input from ${o.name}: move(${i.moveX.toFixed(1)}, ${i.moveY.toFixed(1)})`)):o||console.log(`[Game] Input from unknown peer: ${e}`)}break;case R.StateSnapshot:if(!this.isHost){const i=t.data;this.debugReceivedState||(console.log(`[Game] First state received from host - phase: ${i.phase}, players: ${i.players?.length||0}`),this.debugReceivedState=!0),this.applySerializedState(i)}break;case R.CountdownPause:if(this.isHost){const o=this.world.getPlayerByPeerId(e)?.name||"Unknown";this.world.pauseCountdown(o)}break;case R.CountdownResume:if(this.isHost){const o=this.world.getPlayerByPeerId(e)?.name||"Unknown";this.world.resumeCountdown(o)}break}}serializeState(){const e=this.world.getState();return{phase:e.phase,mode:e.mode,mapId:e.mapId,tick:e.tick,time:e.time,roundStartTime:e.roundStartTime,roundNumber:e.roundNumber,maxRounds:e.maxRounds,roundTimeLimit:e.roundTimeLimit,attackerScore:e.attackerScore,defenderScore:e.defenderScore,players:Array.from(e.players.entries()),projectiles:Array.from(e.projectiles.entries()),objectives:e.objectives,recentShots:e.recentShots||[],countdownTime:e.countdownTime??1e4,countdownPaused:e.countdownPaused??!1,countdownPausedBy:e.countdownPausedBy??""}}applySerializedState(e){const t={phase:e.phase,mode:e.mode,mapId:e.mapId,tick:e.tick,time:e.time,roundStartTime:e.roundStartTime,roundNumber:e.roundNumber,maxRounds:e.maxRounds,roundTimeLimit:e.roundTimeLimit,attackerScore:e.attackerScore,defenderScore:e.defenderScore,players:new Map(e.players),projectiles:new Map(e.projectiles),objectives:e.objectives,recentShots:e.recentShots||[],countdownTime:e.countdownTime??1e4,countdownPaused:e.countdownPaused??!1,countdownPausedBy:e.countdownPausedBy??""};if(this.world.applyState(t),t.recentShots){const i=this.world.getLocalPlayer();for(const o of t.recentShots){if(i&&o.shooterPeerId===i.peerId)continue;const s=this.world.isEnemyOfLocal(o.shooterId);this.gameRenderer.addBulletTracer(o.start,o.end,s)}}}toggleCountdownPause(){const t=this.world.getLocalPlayer()?.name||"Unknown";if(this.isHost)this.world.toggleCountdownPause(t);else if(this.network){const i=this.world.isCountdownPaused();this.network.broadcast({type:i?R.CountdownResume:R.CountdownPause,timestamp:Date.now(),senderId:this.network.getLocalPeerId(),data:{playerName:t}})}}getAudioSettings(){return this.audio.getSettings()}updateAudioSettings(e){this.audio.updateSettings(e)}broadcastState(){if(!this.network||!this.isHost)return;this.debugBroadcastStarted||(console.log(`[Game] Starting state broadcasts to ${this.network.getPeerCount()} peers`),this.debugBroadcastStarted=!0);const e=this.serializeState();this.network.broadcast({type:R.StateSnapshot,timestamp:Date.now(),senderId:this.localPeerId,data:e})}handleGameEvent(e){switch(e.type){case Ye.PlayerKill:{const t=e.data,i=this.world.getPlayer(t.victimId),o=this.world.getLocalPlayer();i&&(this.gameRenderer.addPlayerDeath(i.position),this.audio.play(O.PlayerDeath),o&&t.killerId===o.id&&setTimeout(()=>{this.audio.play(O.KillConfirmed,1)},200));break}case Ye.PlayerDamage:{const t=e.data,i=this.world.getPlayer(t.targetId);if(i&&t.position){const o={x:i.position.x-t.position.x,y:i.position.y-t.position.y};this.gameRenderer.addPlayerHit(t.position,o),this.audio.playWithVariation(O.PlayerDamage,.8)}break}}}playWeaponSound(e){switch(e){case"burst_pistol":this.audio.playWithVariation(O.PulsePistolShoot);break;case"neo_smg9":case"pulse_rifle":this.audio.playWithVariation(O.PlasmaRifleShoot);break;case"scatter_shot":this.audio.playWithVariation(O.ScatterGunShoot);break;case"rail_sniper":this.audio.playWithVariation(O.FusionCannonShoot);break;default:this.audio.playWithVariation(O.PulsePistolShoot)}}update(e,t){this.inputManager.update(),this.updateCameraInput();const i=this.world.getPhase(),o=i===C.RoundActive;if(i!==this.lastPhase){if(i===C.RoundEnd&&this.lastPhase===C.RoundActive){this.countdownSoundId&&this.audio.stop(this.countdownSoundId);const a=this.world.getCountdownTime(),n=this.audio.getSoundDuration(O.CountdownTick),l=Math.max(0,n-a/1e3);this.countdownSoundId=this.audio.playAtOffset(O.CountdownTick,l),this.lastCountdownPaused=!1}i===C.RoundActive&&this.lastPhase===C.RoundEnd&&(this.countdownSoundId&&(this.audio.stop(this.countdownSoundId),this.countdownSoundId=null),this.audio.play(O.RoundStart),this.inputManager.resetAllInputs()),this.lastPhase=i}if(i===C.RoundEnd){const a=this.world.isCountdownPaused();if(a!==this.lastCountdownPaused){if(a)this.countdownSoundId&&(this.audio.stop(this.countdownSoundId),this.countdownSoundId=null);else{const n=this.world.getCountdownTime(),l=this.audio.getSoundDuration(O.CountdownTick),c=Math.max(0,l-n/1e3);this.countdownSoundId=this.audio.playAtOffset(O.CountdownTick,c)}this.lastCountdownPaused=a}}const s=this.world.getLocalPlayer();if(!s&&o&&!this.debugLoggedNoPlayer&&(console.log(`[Game] WARNING: No local player found! isHost=${this.isHost}, localPlayerId=${this.world.localPlayerId}`),this.debugLoggedNoPlayer=!0),s&&o){const a=this.inputManager.getState(),n={moveX:a.moveX,moveY:a.moveY,aimX:a.aimX,aimY:a.aimY,shoot:a.shoot,reload:a.reload,interact:a.interact,ability1:a.ability1,ability2:a.ability2,ultimate:a.ultimate,weaponSlot:a.weaponSlot,sequence:this.inputManager.getNextSequence()};if(s.setInput(n),a.weaponSlot!==0&&s.alive){let l=!1;a.weaponSlot===-1?l=s.cycleWeaponNext():a.weaponSlot===-2?l=s.cycleWeaponPrevious():a.weaponSlot>0&&(l=s.switchToWeaponSlot(a.weaponSlot)),l&&this.gameRenderer.addWeaponSwitch(s.position)}if(a.shoot&&s.alive&&s.canFire(this.world.getTime()+this.world.getRoundNumber()*2e5)){const l=performance.now();if(l-this.lastLocalFireTime>50){if(this.gameRenderer.addMuzzleFlash(s.position,s.rotation),this.playWeaponSound(s.weapon.weaponId),!this.isHost){const c=s.getWeaponDefinition();if(c&&c.projectileSpeed===0){const d={x:Math.cos(s.rotation),y:Math.sin(s.rotation)},h={x:s.position.x+d.x*20,y:s.position.y+d.y*20},f=this.world.getCollisionWorld().raycast(h,d,c.range,65535),g=f?f.point:{x:h.x+d.x*c.range,y:h.y+d.y*c.range};this.gameRenderer.addBulletTracer(h,g,!1)}}this.lastLocalFireTime=l}}if(!this.isHost&&this.network){const l=performance.now();l-this.lastInputSendTime>=1e3/Qe.INPUT_RATE&&(this.network.broadcast({type:R.Input,timestamp:Date.now(),senderId:this.localPeerId,data:n}),this.lastInputSendTime=l)}}if(this.isHost){if(this.world.update(e),this.network&&this.network.getPeerCount()>0){const l=performance.now();l-this.lastStateBroadcastTime>=50&&(this.broadcastState(),this.lastStateBroadcastTime=l)}const a=this.world.getAndClearRecentShots();for(const l of a){const c=this.world.isEnemyOfLocal(l.shooterId);this.gameRenderer.addBulletTracer(l.start,l.end,c)}const n=this.world.getPendingEvents();for(const l of n)this.handleGameEvent(l)}else this.world.updateLocalPlayerOnly(e);if(this.gameRenderer.updateParticles(e),this.network){const a=performance.now();a-this.lastPingTime>=Qe.PING_INTERVAL&&(this.network.pingPeers(),this.lastPingTime=a)}}updateCameraInput(){const e=this.renderer.getCameraOffset(),t=this.renderer.getCameraZoom();this.inputManager.updateCamera(e,t)}render(e){if(this.gameRenderer.render(e),this.showFPS&&this.debugInfo){const t=this.gameLoop.getFPS(),i=this.gameLoop.getTPS(),o=this.world.getPlayers().length,s=this.world.getPhase(),a=this.network?.getAverageLatency()??0;this.debugInfo.innerHTML=`
        FPS: ${t} | TPS: ${i}<br>
        Phase: ${s}<br>
        Players: ${o}<br>
        Tick: ${this.world.getTick()}<br>
        ${this.network?`Latency: ${a.toFixed(1)}ms<br>`:""}
        ${this.isHost?"HOST":"CLIENT"}
      `,this.debugInfo.style.display="block"}else this.debugInfo&&(this.debugInfo.style.display="none")}setPlayerName(e){this.playerName=e}getPlayerName(){return this.playerName}isRunning(){return this.gameLoop.isRunning()}getWorld(){return this.world}setShowFPS(e){this.showFPS=e,this.debugInfo&&!e&&(this.debugInfo.style.display="none")}getShowFPS(){return this.showFPS}showHeroTutorial(e){const t=JSON.parse(localStorage.getItem("cybergrid_tutorials")||"[]");if(t.includes(e))return;const i=X[e];if(!i)return;this.heroTutorialOverlay=document.createElement("div"),this.heroTutorialOverlay.id="hero-tutorial-overlay",this.heroTutorialOverlay.innerHTML=`
      <div class="tutorial-content">
        <h2>Playing as ${i.name}</h2>
        <p class="hero-role">${i.role}</p>
        
        <div class="abilities-list">
          <div class="ability-item passive">
            <span class="key">PASSIVE</span>
            <span class="name">${i.abilities[0]?.name||"Unknown"}</span>
            <span class="desc">${i.abilities[0]?.description||""}</span>
          </div>
          <div class="ability-item">
            <span class="key">Q</span>
            <span class="name">${i.abilities[1]?.name||"Unknown"}</span>
            <span class="desc">${i.abilities[1]?.description||""}</span>
          </div>
          <div class="ability-item">
            <span class="key">F</span>
            <span class="name">${i.abilities[2]?.name||"Unknown"}</span>
            <span class="desc">${i.abilities[2]?.description||""}</span>
          </div>
          <div class="ability-item ultimate">
            <span class="key">X</span>
            <span class="name">${i.abilities[3]?.name||"Unknown"}</span>
            <span class="desc">${i.abilities[3]?.description||""}</span>
          </div>
        </div>
        
        <button id="tutorial-dismiss">Got it! (Click or press any key)</button>
      </div>
    `;const o=document.createElement("style");o.textContent=`
      #hero-tutorial-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .tutorial-content {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid #0ce5f0;
        border-radius: 12px;
        padding: 30px 40px;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 0 30px rgba(12, 229, 240, 0.3);
      }
      .tutorial-content h2 {
        color: #0ce5f0;
        margin: 0 0 5px 0;
        font-size: 28px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .hero-role {
        color: #888;
        margin: 0 0 20px 0;
        font-size: 14px;
      }
      .abilities-list {
        text-align: left;
        margin: 20px 0;
      }
      .ability-item {
        display: grid;
        grid-template-columns: 60px 1fr;
        grid-template-rows: auto auto;
        gap: 2px 10px;
        padding: 10px;
        margin: 8px 0;
        background: rgba(255,255,255,0.05);
        border-radius: 6px;
        border-left: 3px solid #0ce5f0;
      }
      .ability-item.passive {
        border-left-color: #4a4;
      }
      .ability-item.ultimate {
        border-left-color: #ffcc00;
        background: rgba(255, 200, 0, 0.1);
      }
      .ability-item .key {
        grid-row: span 2;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(12, 229, 240, 0.2);
        color: #0ce5f0;
        font-weight: bold;
        font-size: 18px;
        border-radius: 4px;
      }
      .ability-item.passive .key {
        background: rgba(68, 170, 68, 0.2);
        color: #4a4;
        font-size: 10px;
      }
      .ability-item.ultimate .key {
        background: rgba(255, 200, 0, 0.2);
        color: #ffcc00;
      }
      .ability-item .name {
        color: #fff;
        font-weight: bold;
        font-size: 14px;
      }
      .ability-item .desc {
        color: #aaa;
        font-size: 12px;
      }
      #tutorial-dismiss {
        background: linear-gradient(135deg, #0ce5f0 0%, #0891b2 100%);
        border: none;
        color: #000;
        padding: 12px 30px;
        font-size: 14px;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      #tutorial-dismiss:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(12, 229, 240, 0.5);
      }
    `,document.head.appendChild(o),document.body.appendChild(this.heroTutorialOverlay);const s=()=>{this.heroTutorialOverlay&&(this.heroTutorialOverlay.remove(),this.heroTutorialOverlay=null),t.push(e),localStorage.setItem("cybergrid_tutorials",JSON.stringify(t)),this.heroTutorialShown=!0,document.removeEventListener("keydown",s),document.removeEventListener("click",s)};document.getElementById("tutorial-dismiss")?.addEventListener("click",s),setTimeout(()=>{document.addEventListener("keydown",s,{once:!0})},500)}checkAndShowHeroTutorial(){if(this.heroTutorialShown)return;const e=this.settings.playerHero;this.showHeroTutorial(e)}showHeroInfo(){if(this.heroTutorialOverlay){this.heroTutorialOverlay.remove(),this.heroTutorialOverlay=null;return}const e=this.settings.playerHero,t=X[e];if(!t)return;if(this.heroTutorialOverlay=document.createElement("div"),this.heroTutorialOverlay.id="hero-tutorial-overlay",this.heroTutorialOverlay.innerHTML=`
      <div class="tutorial-content">
        <div class="info-columns">
          <div class="hero-column">
            <h2>${t.name}</h2>
            <p class="hero-role">${t.role}</p>
            <p class="hero-stats">HP: ${t.health} | Shield: ${t.shield} | Speed: ${Math.round(t.speed*100)}%</p>
            
            <div class="abilities-list">
              <div class="ability-item passive">
                <span class="key">PASSIVE</span>
                <span class="name">${t.abilities[0]?.name||"Unknown"}</span>
                <span class="desc">${t.abilities[0]?.description||""}</span>
              </div>
              <div class="ability-item">
                <span class="key">Q</span>
                <span class="name">${t.abilities[1]?.name||"Unknown"}</span>
                <span class="desc">${t.abilities[1]?.description||""}</span>
                <span class="cooldown">${(t.abilities[1]?.cooldown||0)/1e3}s cooldown</span>
              </div>
              <div class="ability-item">
                <span class="key">F</span>
                <span class="name">${t.abilities[2]?.name||"Unknown"}</span>
                <span class="desc">${t.abilities[2]?.description||""}</span>
                <span class="cooldown">${(t.abilities[2]?.cooldown||0)/1e3}s cooldown</span>
              </div>
              <div class="ability-item ultimate">
                <span class="key">X</span>
                <span class="name">${t.abilities[3]?.name||"Unknown"}</span>
                <span class="desc">${t.abilities[3]?.description||""}</span>
                <span class="cooldown">${t.abilities[3]?.ultimateCost||0} charge cost</span>
              </div>
            </div>
          </div>
          
          <div class="controls-column">
            <h3>Controls</h3>
            <div class="controls-list">
              <div class="control-item"><span class="ctrl-key">WASD</span><span class="ctrl-action">Move</span></div>
              <div class="control-item"><span class="ctrl-key">Mouse</span><span class="ctrl-action">Aim</span></div>
              <div class="control-item"><span class="ctrl-key">Left Click</span><span class="ctrl-action">Shoot</span></div>
              <div class="control-item"><span class="ctrl-key">Right Click</span><span class="ctrl-action">Reload</span></div>
              <div class="control-item"><span class="ctrl-key">R</span><span class="ctrl-action">Reload</span></div>
              <div class="control-item"><span class="ctrl-key">Wheel</span><span class="ctrl-action">Switch Weapon</span></div>
              <div class="control-item"><span class="ctrl-key">1-5</span><span class="ctrl-action">Select Weapon</span></div>
              <div class="control-item"><span class="ctrl-key">Q</span><span class="ctrl-action">Ability 1</span></div>
              <div class="control-item"><span class="ctrl-key">F</span><span class="ctrl-action">Ability 2</span></div>
              <div class="control-item"><span class="ctrl-key">X</span><span class="ctrl-action">Ultimate</span></div>
              <div class="control-item"><span class="ctrl-key">B</span><span class="ctrl-action">Buy Menu</span></div>
              <div class="control-item"><span class="ctrl-key">P</span><span class="ctrl-action">Pause Countdown</span></div>
              <div class="control-item"><span class="ctrl-key">ESC</span><span class="ctrl-action">Pause/Menu</span></div>
              <div class="control-item"><span class="ctrl-key">H</span><span class="ctrl-action">This Help</span></div>
            </div>
          </div>
        </div>
        
        <p class="dismiss-hint">Press H or click anywhere to close</p>
      </div>
    `,!document.getElementById("hero-info-styles")){const o=document.createElement("style");o.id="hero-info-styles",o.textContent=`
        #hero-tutorial-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.85);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .tutorial-content {
          background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
          border: 2px solid #0ce5f0;
          border-radius: 12px;
          padding: 30px 40px;
          max-width: 850px;
          text-align: center;
          box-shadow: 0 0 30px rgba(12, 229, 240, 0.3);
        }
        .info-columns {
          display: flex;
          gap: 30px;
          text-align: left;
        }
        .hero-column {
          flex: 1;
          min-width: 320px;
        }
        .controls-column {
          flex: 0 0 220px;
          border-left: 1px solid #333;
          padding-left: 30px;
        }
        .controls-column h3 {
          color: #0ce5f0;
          margin: 0 0 15px 0;
          font-size: 18px;
          text-transform: uppercase;
          letter-spacing: 1px;
        }
        .controls-list {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }
        .control-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 4px 0;
        }
        .ctrl-key {
          background: #333;
          color: #0ce5f0;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: bold;
          min-width: 60px;
          text-align: center;
        }
        .ctrl-action {
          color: #aaa;
          font-size: 12px;
        }
        .tutorial-content h2 {
          color: #0ce5f0;
          margin: 0 0 5px 0;
          font-size: 28px;
          text-transform: uppercase;
          letter-spacing: 2px;
        }
        .hero-role {
          color: #888;
          margin: 0 0 5px 0;
          font-style: italic;
        }
        .hero-stats {
          color: #6af;
          margin: 0 0 20px 0;
          font-size: 14px;
        }
        .abilities-list {
          text-align: left;
          margin: 20px 0;
        }
        .ability-item {
          display: grid;
          grid-template-columns: 70px 1fr;
          grid-template-rows: auto auto;
          gap: 2px 10px;
          padding: 10px;
          margin: 8px 0;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 6px;
          border-left: 3px solid #0ce5f0;
        }
        .ability-item.passive {
          border-left-color: #4a4;
          opacity: 0.8;
        }
        .ability-item.ultimate {
          border-left-color: #f0c020;
          background: rgba(240, 192, 32, 0.1);
        }
        .ability-item .key {
          grid-row: 1 / 3;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #0ce5f0;
          color: #000;
          font-weight: bold;
          font-size: 16px;
          border-radius: 4px;
          padding: 5px;
        }
        .ability-item.passive .key {
          background: #4a4;
          font-size: 10px;
        }
        .ability-item.ultimate .key {
          background: #f0c020;
        }
        .ability-item .name {
          color: #fff;
          font-weight: bold;
          font-size: 14px;
        }
        .ability-item .desc {
          color: #aaa;
          font-size: 12px;
        }
        .ability-item .cooldown {
          grid-column: 2;
          color: #0ce5f0;
          font-size: 11px;
          margin-top: 2px;
        }
        .dismiss-hint {
          color: #666;
          font-size: 12px;
          margin-top: 15px;
        }
      `,document.head.appendChild(o)}document.body.appendChild(this.heroTutorialOverlay);const i=o=>{o.type==="click"&&o.target!==this.heroTutorialOverlay||(this.heroTutorialOverlay&&(this.heroTutorialOverlay.remove(),this.heroTutorialOverlay=null),document.removeEventListener("click",i))};setTimeout(()=>{this.heroTutorialOverlay?.addEventListener("click",i)},100)}isHeroInfoVisible(){return this.heroTutorialOverlay!==null}}class Cs{db=null;firebase=null;isInitialized=!1;unsubscribe=null;async initialize(){if(!this.isInitialized)try{const{initializeApp:e,getApps:t,getApp:i}=await de(async()=>{const{initializeApp:T,getApps:$,getApp:D}=await import("./index.esm-OOYOW6k3.js");return{initializeApp:T,getApps:$,getApp:D}},__vite__mapDeps([0,1]),import.meta.url),{getFirestore:o,collection:s,doc:a,setDoc:n,getDoc:l,updateDoc:c,deleteDoc:d,query:h,where:p,orderBy:f,limit:g,getDocs:w,onSnapshot:I,serverTimestamp:A}=await de(async()=>{const{getFirestore:T,collection:$,doc:D,setDoc:G,getDoc:N,updateDoc:q,deleteDoc:se,query:B,where:W,orderBy:Be,limit:Ie,getDocs:Ee,onSnapshot:Je,serverTimestamp:Ce}=await import("./index.esm-DbUeHnob.js");return{getFirestore:T,collection:$,doc:D,setDoc:G,getDoc:N,updateDoc:q,deleteDoc:se,query:B,where:W,orderBy:Be,limit:Ie,getDocs:Ee,onSnapshot:Je,serverTimestamp:Ce}},__vite__mapDeps([2,1]),import.meta.url);this.firebase={collection:s,doc:a,setDoc:n,getDoc:l,updateDoc:c,deleteDoc:d,query:h,where:p,orderBy:f,limit:g,getDocs:w,onSnapshot:I,serverTimestamp:A};const P=t().length===0?e(Z):i();this.db=o(P),this.isInitialized=!0,console.log("[LobbyBrowser] Initialized")}catch(e){console.error("[LobbyBrowser] Initialization failed:",e)}}async createPublicLobby(e){this.isInitialized||await this.initialize();const{doc:t,setDoc:i,serverTimestamp:o}=this.firebase;try{const s=t(this.db,"publicLobbies",e.roomCode);await i(s,{roomCode:e.roomCode,hostId:e.hostId,hostName:e.hostName,gameMode:e.gameMode,mapId:e.mapId,currentPlayers:1,maxPlayers:e.maxPlayers,isPublic:!0,status:"waiting",createdAt:o(),lastUpdated:o()}),console.log(`[LobbyBrowser] Public lobby created: ${e.roomCode}`)}catch(s){console.error("[LobbyBrowser] Failed to create public lobby:",s)}}async updateLobbyPlayerCount(e,t){this.isInitialized||await this.initialize();const{doc:i,updateDoc:o,serverTimestamp:s}=this.firebase;try{const a=i(this.db,"publicLobbies",e);await o(a,{currentPlayers:t,lastUpdated:s()})}catch(a){console.warn("[LobbyBrowser] Failed to update player count:",a)}}async updateLobbyStatus(e,t){this.isInitialized||await this.initialize();const{doc:i,updateDoc:o,deleteDoc:s,serverTimestamp:a}=this.firebase;try{const n=i(this.db,"publicLobbies",e);t==="playing"||t==="finished"?(await s(n),console.log(`[LobbyBrowser] Lobby removed: ${e}`)):await o(n,{status:t,lastUpdated:a()})}catch(n){console.warn("[LobbyBrowser] Failed to update lobby status:",n)}}async removeLobby(e){this.isInitialized||await this.initialize();const{doc:t,deleteDoc:i}=this.firebase;try{const o=t(this.db,"publicLobbies",e);await i(o),console.log(`[LobbyBrowser] Lobby removed: ${e}`)}catch(o){console.warn("[LobbyBrowser] Failed to remove lobby:",o)}}async getPublicLobbies(){this.isInitialized||await this.initialize();const{collection:e,query:t,limit:i,getDocs:o}=this.firebase;try{console.log("[LobbyBrowser] Querying publicLobbies collection...");const s=t(e(this.db,"publicLobbies"),i(50)),a=await o(s);console.log(`[LobbyBrowser] Query returned ${a.size} documents`);const n=[];return a.forEach(l=>{const c=l.data();console.log("[LobbyBrowser] Lobby data:",c),c.status==="waiting"&&c.isPublic===!0&&c.currentPlayers<c.maxPlayers&&n.push({roomCode:c.roomCode,hostName:c.hostName,hostId:c.hostId,gameMode:c.gameMode,mapId:c.mapId,currentPlayers:c.currentPlayers,maxPlayers:c.maxPlayers,createdAt:c.createdAt?.toMillis?.()||Date.now(),isPublic:c.isPublic,status:c.status})}),n.sort((l,c)=>c.createdAt-l.createdAt),console.log(`[LobbyBrowser] Found ${n.length} public lobbies`),n}catch(s){return console.error("[LobbyBrowser] Failed to fetch lobbies:",s),[]}}subscribeToLobbies(e){if(!this.isInitialized)return console.warn("[LobbyBrowser] Not initialized - call initialize() first"),()=>{};this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null);const{collection:t,query:i,limit:o,onSnapshot:s}=this.firebase;try{console.log("[LobbyBrowser] Setting up real-time subscription...");const a=i(t(this.db,"publicLobbies"),o(50)),n=s(a,l=>{const c=[];l.forEach(d=>{const h=d.data();h.status==="waiting"&&h.isPublic===!0&&h.currentPlayers<h.maxPlayers&&c.push({roomCode:h.roomCode,hostName:h.hostName,hostId:h.hostId,gameMode:h.gameMode,mapId:h.mapId,currentPlayers:h.currentPlayers,maxPlayers:h.maxPlayers,createdAt:h.createdAt?.toMillis?.()||Date.now(),isPublic:h.isPublic,status:h.status})}),c.sort((d,h)=>h.createdAt-d.createdAt),e(c)},l=>{console.error("[LobbyBrowser] Subscription error:",l)});return this.unsubscribe=n,n}catch(a){return console.error("[LobbyBrowser] Failed to subscribe to lobbies:",a),()=>{}}}unsubscribeFromLobbies(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null)}async cleanupStaleLobbies(){this.isInitialized||await this.initialize();const{collection:e,query:t,getDocs:i,deleteDoc:o,doc:s,limit:a}=this.firebase;try{const n=Date.now()-6e5,l=t(e(this.db,"publicLobbies"),a(100)),c=await i(l);let d=0;for(const h of c.docs){const p=h.data();(p.createdAt?.toMillis?.()||0)<n&&p.status==="waiting"&&(await o(s(this.db,"publicLobbies",h.id)),d++)}return d>0&&console.log(`[LobbyBrowser] Cleaned up ${d} stale lobbies`),d}catch(n){return console.warn("[LobbyBrowser] Failed to cleanup stale lobbies:",n),0}}}const ie=new Cs;class As{context=null;sounds=new Map;initialized=!1;loading=!1;enabled=!0;volume=.7;async init(){if(!(this.initialized||this.loading)){this.loading=!0;try{this.context=new AudioContext,await Promise.all([this.loadSound("hover","./assets/audio/ui/hover.mp3"),this.loadSound("click","./assets/audio/ui/click.mp3")]),this.initialized=!0,console.log("[UIAudio] Initialized with",this.sounds.size,"sounds")}catch(e){console.warn("[UIAudio] Failed to initialize:",e)}this.loading=!1}}async loadSound(e,t){if(this.context)try{const o=await(await fetch(t)).arrayBuffer(),s=await this.context.decodeAudioData(o);this.sounds.set(e,s),console.log(`[UIAudio] Loaded: ${e}`)}catch(i){console.warn(`[UIAudio] Failed to load ${e}:`,i)}}play(e,t=.5){if(!this.enabled||!this.context||!this.sounds.has(e)){!this.initialized&&!this.loading&&this.init();return}this.context.state==="suspended"&&this.context.resume();const i=this.sounds.get(e),o=this.context.createBufferSource();o.buffer=i;const s=this.context.createGain();s.gain.value=t*this.volume,o.connect(s),s.connect(this.context.destination),o.start(0)}playHover(){this.play("hover",.3)}playClick(){this.play("click",.5)}setEnabled(e){this.enabled=e}setVolume(e){this.volume=Math.max(0,Math.min(1,e))}}const pe=new As,Te=()=>{pe.init(),document.removeEventListener("click",Te),document.removeEventListener("keydown",Te),document.removeEventListener("mousemove",Te)};document.addEventListener("click",Te);document.addEventListener("keydown",Te);document.addEventListener("mousemove",Te);let _=null;const dt=document.getElementById("game-canvas"),ae=document.getElementById("connection-ui"),Q=document.getElementById("player-name"),Re=document.getElementById("btn-host"),_e=document.getElementById("btn-join"),ee=document.getElementById("room-code"),Ms=document.getElementById("btn-connect"),Ls=document.getElementById("btn-back"),Ze=document.getElementById("join-buttons"),At=document.getElementById("btn-settings"),me=document.getElementById("settings-panel"),Ts=document.getElementById("btn-how-to-play"),zt=document.getElementById("how-to-play-modal"),Ds=document.getElementById("btn-how-to-play-close"),Rs=document.getElementById("btn-stats"),$t=document.getElementById("stats-modal"),_s=document.getElementById("btn-stats-close"),ht=document.getElementById("setting-bot-count"),vi=document.getElementById("bot-count-value"),ki=document.getElementById("setting-bot-difficulty"),ut=document.getElementById("setting-friendly-bots"),Pi=document.getElementById("friendly-bot-count-value"),Ii=document.getElementById("setting-ai-mode"),Xe=document.getElementById("setting-game-mode"),ne=document.getElementById("setting-map"),he=document.getElementById("map-hint"),Mt=document.getElementById("setting-hero"),Lt=document.getElementById("setting-ability-q"),Tt=document.getElementById("setting-ability-f"),Bs=document.getElementById("ability-q-name"),zs=document.getElementById("ability-f-name"),$s=document.getElementById("btn-settings-save"),Ns=document.getElementById("btn-settings-close"),He=document.getElementById("settings-audio-master-volume"),Ht=document.getElementById("settings-audio-master-enabled"),Ot=document.getElementById("settings-audio-master-value"),Oe=document.getElementById("settings-audio-music-volume"),Gt=document.getElementById("settings-audio-music-enabled"),Vt=document.getElementById("settings-audio-music-value"),Ge=document.getElementById("settings-audio-sfx-volume"),Ut=document.getElementById("settings-audio-sfx-enabled"),Yt=document.getElementById("settings-audio-sfx-value"),Ve=document.getElementById("settings-audio-voice-volume"),jt=document.getElementById("settings-audio-voice-enabled"),Xt=document.getElementById("settings-audio-voice-value"),Ue=document.getElementById("settings-audio-ui-volume"),Kt=document.getElementById("settings-audio-ui-enabled"),qt=document.getElementById("settings-audio-ui-value"),ge=document.getElementById("pause-menu"),Ws=document.getElementById("btn-resume"),Fs=document.getElementById("btn-quit"),mt=document.getElementById("setting-sensitivity"),Ei=document.getElementById("sensitivity-value"),ft=document.getElementById("setting-fps"),be=document.getElementById("audio-master-volume"),pt=document.getElementById("audio-master-enabled"),gt=document.getElementById("audio-master-value"),Se=document.getElementById("audio-music-volume"),yt=document.getElementById("audio-music-enabled"),wt=document.getElementById("audio-music-value"),xe=document.getElementById("audio-sfx-volume"),bt=document.getElementById("audio-sfx-enabled"),St=document.getElementById("audio-sfx-value"),ve=document.getElementById("audio-voice-volume"),xt=document.getElementById("audio-voice-enabled"),vt=document.getElementById("audio-voice-value"),ke=document.getElementById("audio-ui-volume"),kt=document.getElementById("audio-ui-enabled"),Pt=document.getElementById("audio-ui-value"),Ci=document.getElementById("help-panel");let Zt=!1,ye=null;const De=document.getElementById("buy-menu"),Hs=document.getElementById("buy-credits"),Ai=De.querySelectorAll(".weapon-item"),Ke=document.getElementById("round-over-panel"),re=document.getElementById("winner-text"),mi=document.getElementById("match-info"),Os=document.getElementById("score-attackers"),Gs=document.getElementById("score-defenders"),ot=document.getElementById("btn-play-again"),Vs=document.getElementById("btn-main-menu"),fi=document.getElementById("countdown-display"),it=document.getElementById("countdown-text"),Ne=document.getElementById("btn-pause-countdown"),Mi=document.getElementById("room-code-display"),Us=document.getElementById("room-code-text"),$e=document.getElementById("btn-copy-code"),Dt=document.getElementById("lobby-screen"),We=document.getElementById("lobby-room-code"),Ys=document.getElementById("host-settings"),It=document.getElementById("lobby-player-count"),js=document.getElementById("lobby-round-count"),Xs=document.getElementById("lobby-current-players"),Li=document.getElementById("lobby-max-players"),pi=document.getElementById("lobby-player-list"),le=document.getElementById("lobby-waiting-text"),nt=document.getElementById("lobby-countdown"),Ks=document.getElementById("btn-leave-lobby"),Nt=document.getElementById("btn-copy-lobby-code"),ii=document.getElementById("btn-start-game"),Et=document.getElementById("lobby-make-public"),qs=document.getElementById("btn-find-match"),Ti=document.getElementById("lobby-browser-modal"),Zs=document.getElementById("btn-lobby-browser-close"),Jt=document.getElementById("btn-refresh-lobbies"),gi=document.getElementById("lobby-list"),Wt=document.getElementById("lobby-empty");let x=null;const Js={vanta:{ability1:"Energy Shield",ability2:"Shockwave Slam"},spectre:{ability1:"Cloak",ability2:"Reveal Pulse"},katana:{ability1:"Blink",ability2:"Invisibility"},byte:{ability1:"EMP Pulse",ability2:"Shock Trap"},glyph:{ability1:"Poison Cloud",ability2:"Turret Deploy"},spark:{ability1:"Fire Bottle",ability2:"Minigun Mode"},zero:{ability1:"Mark Target",ability2:"Dash Back"},mira:{ability1:"Heal Field",ability2:"Shield Burst"}};let v={enemyBotCount:3,friendlyBotCount:0,botDifficulty:"medium",gameMode:"deathmatch",mapId:"neon_arena",playerHero:"vanta",abilityQSlot:1,abilityFSlot:2,totalRounds:5,aiMode:"rule_based"};function Di(r){const e=ne.value;ne.innerHTML="";const t=ti.filter(o=>r==="spike"?o.hasSpikeSites:!o.hasSpikeSites);for(const o of t){const s=document.createElement("option");s.value=o.id,s.textContent=`${o.name} - ${o.description}`,ne.appendChild(s)}t.map(o=>o.id).includes(e)?ne.value=e:t.length>0&&(ne.value=t[0].id),si()}function si(){const r=ne.value,e=ti.find(t=>t.id===r);if(e){const t=Xe.value;t==="spike"&&!e.hasSpikeSites?(he.textContent=" This map has no spike sites!",he.style.color="#ff6b6b"):t==="deathmatch"&&e.hasSpikeSites?(he.textContent=" Spike sites available but unused in Deathmatch",he.style.color="#4ecdc4"):(he.textContent=` ${e.description}`,he.style.color="#2ecc71")}else he.textContent=""}function at(){const r=Mt.value,e=Js[r]||{ability1:"Ability 1",ability2:"Ability 2"},t=parseInt(Lt.value),i=parseInt(Tt.value);Bs.textContent=t===1?e.ability1:e.ability2,zs.textContent=i===1?e.ability1:e.ability2}function yi(r){return!r||r==="XX"?"":r.toUpperCase().replace(/./g,e=>String.fromCodePoint(127397+e.charCodeAt(0)))}function Ft(r){return r>=1e6?(r/1e6).toFixed(1)+"M":r>=1e3?(r/1e3).toFixed(1)+"K":r.toString()}async function Qs(){await Le.initialize();const r=document.getElementById("stats-total-players"),e=document.getElementById("stats-total-games"),t=document.getElementById("stats-total-hours"),i=document.getElementById("stats-my-stats"),o=document.getElementById("stats-countries"),s=document.getElementById("stats-leaderboard");try{const a=await Le.getGlobalStats();if(a&&(r&&(r.textContent=Ft(a.totalUniquePlayers||0)),e&&(e.textContent=Ft(a.totalGamesPlayed||0)),t&&(t.textContent=Ft(Math.floor(a.totalPlayTimeHours||0))),o&&a.playersByCountry)){const n=Object.entries(a.playersByCountry).sort((l,c)=>c[1]-l[1]).slice(0,8);n.length===0?o.innerHTML='<span class="stats-loading">No country data yet</span>':o.innerHTML=n.map(([l,c])=>`
              <span class="country-tag">
                ${yi(l)} ${l}
                <span class="count">${c}</span>
              </span>
            `).join("")}}catch(a){console.warn("[Stats] Failed to load global stats:",a)}try{const a=await Le.getMyStats();if(i)if(a){const n=a.gamesPlayed>0?Math.round(a.gamesWon/a.gamesPlayed*100):0,l=a.totalDeaths>0?(a.totalKills/a.totalDeaths).toFixed(2):a.totalKills.toString();i.innerHTML=`
          <div class="my-stat">
            <span class="my-stat-label">Games Played</span>
            <span class="my-stat-value">${a.gamesPlayed}</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">Wins</span>
            <span class="my-stat-value">${a.gamesWon} (${n}%)</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">Total Kills</span>
            <span class="my-stat-value">${a.totalKills}</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">K/D Ratio</span>
            <span class="my-stat-value">${l}</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">Play Time</span>
            <span class="my-stat-value">${Math.floor(a.totalPlayTimeSeconds/60)} min</span>
          </div>
          <div class="my-stat">
            <span class="my-stat-label">Country</span>
            <span class="my-stat-value">${yi(a.country)} ${a.countryName||"Unknown"}</span>
          </div>
        `}else i.innerHTML='<div class="stats-loading">Play a game to see your stats!</div>'}catch(a){console.warn("[Stats] Failed to load my stats:",a),i&&(i.innerHTML='<div class="stats-loading">Play a game to see your stats!</div>')}try{const a=await eo();s&&(a.length===0?s.innerHTML='<li class="stats-loading">No players yet</li>':s.innerHTML=a.map((n,l)=>{const c=n.gamesPlayed>0?Math.round(n.gamesWon/n.gamesPlayed*100):0;return`
              <li>
                <span class="rank">#${l+1}</span>
                <span class="name">${n.callsign||"Unknown"}</span>
                <span class="wins">${n.gamesWon||0} wins (${c}%)</span>
              </li>
            `}).join(""))}catch(a){console.warn("[Stats] Failed to load leaderboard:",a),s&&(s.innerHTML='<li class="stats-loading">Failed to load</li>')}}async function eo(){try{const{getFirestore:r,collection:e,query:t,orderBy:i,limit:o,getDocs:s}=await de(async()=>{const{getFirestore:f,collection:g,query:w,orderBy:I,limit:A,getDocs:P}=await import("./index.esm-DbUeHnob.js");return{getFirestore:f,collection:g,query:w,orderBy:I,limit:A,getDocs:P}},__vite__mapDeps([2,1]),import.meta.url),{initializeApp:a,getApps:n,getApp:l}=await de(async()=>{const{initializeApp:f,getApps:g,getApp:w}=await import("./index.esm-OOYOW6k3.js");return{initializeApp:f,getApps:g,getApp:w}},__vite__mapDeps([0,1]),import.meta.url),c=n().length===0?a(Z):l(),d=r(c),h=t(e(d,"playerStats"),i("gamesWon","desc"),o(5));return(await s(h)).docs.map(f=>f.data())}catch(r){return console.warn("[Stats] Failed to query leaderboard:",r),[]}}let we=null;async function to(){if(console.log("[LobbyBrowser] Opening lobby browser..."),!Q.value.trim()){console.log("[LobbyBrowser] No player name entered"),Q.focus(),Q.style.borderColor="#ff4444",setTimeout(()=>{Q.style.borderColor=""},2e3);return}Ti.classList.remove("hidden"),ae.classList.add("hidden");try{we&&(we(),we=null),console.log("[LobbyBrowser] Initializing service..."),await ie.initialize(),console.log("[LobbyBrowser] Cleaning stale lobbies..."),await ie.cleanupStaleLobbies(),console.log("[LobbyBrowser] Subscribing to lobbies..."),we=ie.subscribeToLobbies(e=>{console.log("[LobbyBrowser] Real-time update:",e.length,"lobbies"),_i(e)}),console.log("[LobbyBrowser] Lobby browser ready")}catch(e){console.error("[LobbyBrowser] Error opening lobby browser:",e)}}function Ri(){Ti.classList.add("hidden"),ae.classList.remove("hidden"),we&&(we(),we=null)}async function io(){Jt.classList.add("spinning");try{const r=await ie.getPublicLobbies();_i(r)}catch(r){console.error("[LobbyBrowser] Failed to refresh lobbies:",r)}setTimeout(()=>{Jt.classList.remove("spinning")},500)}function _i(r){if(gi.querySelectorAll(".lobby-item").forEach(t=>t.remove()),r.length===0){Wt.style.display="block";return}Wt.style.display="none";for(const t of r){const i=document.createElement("div");i.className="lobby-item";const o=t.gameMode==="spike"?" Spike":" Deathmatch",a=ti.find(l=>l.id===t.mapId)?.name||t.mapId;i.innerHTML=`
      <div class="lobby-info">
        <div class="lobby-host">${so(t.hostName)}</div>
        <div class="lobby-details">
          <span>${o}</span>
          <span> ${a}</span>
        </div>
      </div>
      <span class="lobby-players">${t.currentPlayers}/${t.maxPlayers}</span>
      <button class="join-btn" data-room-code="${t.roomCode}">Join</button>
    `,i.querySelector(".join-btn").addEventListener("click",()=>{oo(t.roomCode)}),gi.insertBefore(i,Wt)}}function so(r){const e=document.createElement("div");return e.textContent=r,e.innerHTML}async function oo(r){Ri(),ee.value=r,await $i()}function wi(){const r=localStorage.getItem("cybergrid_settings");if(r)try{const e=JSON.parse(r);v={...v,...e},v.abilityQSlot!==1&&v.abilityQSlot!==2&&(v.abilityQSlot=1),v.abilityFSlot!==1&&v.abilityFSlot!==2&&(v.abilityFSlot=2),v.abilityQSlot===v.abilityFSlot&&(v.abilityQSlot=1,v.abilityFSlot=2),console.log("[Settings] Loaded:",v)}catch(e){console.warn("Failed to load settings:",e)}ht.value=String(v.enemyBotCount),vi.textContent=String(v.enemyBotCount),ut.value=String(v.friendlyBotCount),Pi.textContent=String(v.friendlyBotCount),ki.value=v.botDifficulty,Ii.value=v.aiMode||"rule_based",Xe.value=v.gameMode,Di(v.gameMode),v.mapId&&(ne.value=v.mapId),Mt.value=v.playerHero,Lt.value=String(v.abilityQSlot),Tt.value=String(v.abilityFSlot),at(),si()}function no(){v={enemyBotCount:parseInt(ht.value),friendlyBotCount:parseInt(ut.value),botDifficulty:ki.value,gameMode:Xe.value,mapId:ne.value,playerHero:Mt.value,abilityQSlot:parseInt(Lt.value),abilityFSlot:parseInt(Tt.value),totalRounds:v.totalRounds,aiMode:Ii.value},localStorage.setItem("cybergrid_settings",JSON.stringify(v)),me.classList.add("hidden")}let ce={volume:100,sensitivity:1,showFps:!0},S={masterVolume:80,masterEnabled:!0,musicVolume:50,musicEnabled:!0,sfxVolume:80,sfxEnabled:!0,voiceVolume:100,voiceEnabled:!0,uiVolume:70,uiEnabled:!0};function ao(){const r=localStorage.getItem("cybergrid_audio");if(r)try{S={...S,...JSON.parse(r)}}catch(i){console.warn("Failed to load audio settings:",i)}ro();const e=S.masterVolume/100,t=S.uiVolume/100;pe.setVolume(e*t),pe.setEnabled(S.masterEnabled&&S.uiEnabled)}function bi(){localStorage.setItem("cybergrid_audio",JSON.stringify(S))}function ro(){be.value=String(S.masterVolume),pt.checked=S.masterEnabled,gt.textContent=`${S.masterVolume}%`,be.disabled=!S.masterEnabled,Se.value=String(S.musicVolume),yt.checked=S.musicEnabled,wt.textContent=`${S.musicVolume}%`,Se.disabled=!S.musicEnabled,xe.value=String(S.sfxVolume),bt.checked=S.sfxEnabled,St.textContent=`${S.sfxVolume}%`,xe.disabled=!S.sfxEnabled,ve.value=String(S.voiceVolume),xt.checked=S.voiceEnabled,vt.textContent=`${S.voiceVolume}%`,ve.disabled=!S.voiceEnabled,ke.value=String(S.uiVolume),kt.checked=S.uiEnabled,Pt.textContent=`${S.uiVolume}%`,ke.disabled=!S.uiEnabled,He.value=String(S.masterVolume),Ht.checked=S.masterEnabled,Ot.textContent=`${S.masterVolume}%`,He.disabled=!S.masterEnabled,Oe.value=String(S.musicVolume),Gt.checked=S.musicEnabled,Vt.textContent=`${S.musicVolume}%`,Oe.disabled=!S.musicEnabled,Ge.value=String(S.sfxVolume),Ut.checked=S.sfxEnabled,Yt.textContent=`${S.sfxVolume}%`,Ge.disabled=!S.sfxEnabled,Ve.value=String(S.voiceVolume),jt.checked=S.voiceEnabled,Xt.textContent=`${S.voiceVolume}%`,Ve.disabled=!S.voiceEnabled,Ue.value=String(S.uiVolume),Kt.checked=S.uiEnabled,qt.textContent=`${S.uiVolume}%`,Ue.disabled=!S.uiEnabled}function lo(){const r=localStorage.getItem("cybergrid_gameplay");if(r)try{ce={...ce,...JSON.parse(r)}}catch(e){console.warn("Failed to load gameplay settings:",e)}ho()}function co(){ce={volume:100,sensitivity:parseFloat(mt.value)/10,showFps:ft.checked},localStorage.setItem("cybergrid_gameplay",JSON.stringify(ce))}function ho(){if(mt.value=String(Math.round(ce.sensitivity*10)),Ei.textContent=ce.sensitivity.toFixed(1),ft.checked=ce.showFps,x){const r=x.getAudioSettings();r&&(be.value=String(r.masterVolume),pt.checked=r.masterEnabled,gt.textContent=`${r.masterVolume}%`,be.disabled=!r.masterEnabled,Se.value=String(r.musicVolume),yt.checked=r.musicEnabled,wt.textContent=`${r.musicVolume}%`,Se.disabled=!r.musicEnabled,xe.value=String(r.sfxVolume),bt.checked=r.sfxEnabled,St.textContent=`${r.sfxVolume}%`,xe.disabled=!r.sfxEnabled,ve.value=String(r.voiceVolume),xt.checked=r.voiceEnabled,vt.textContent=`${r.voiceVolume}%`,ve.disabled=!r.voiceEnabled,ke.value=String(r.uiVolume),kt.checked=r.uiEnabled,Pt.textContent=`${r.uiVolume}%`,ke.disabled=!r.uiEnabled)}}const uo={burst_pistol:0,neo_smg9:1100,pulse_rifle:1500,scatter_shot:1400,rail_sniper:2100};function mo(r=!1){Zt=!0,Ci.classList.add("visible"),ye!==null&&(clearTimeout(ye),ye=null),r&&(ye=window.setTimeout(()=>{fo()},5e3))}function fo(){Zt&&(Zt=!1,Ci.classList.remove("visible"),ye!==null&&(clearTimeout(ye),ye=null))}function po(){if(!x)return;const r=x.getWorld().getLocalPlayer();!r||!r.alive||(Bi(),De.classList.remove("hidden"))}function Qt(){De.classList.add("hidden")}function Bi(){if(!x)return;const r=x.getWorld().getLocalPlayer();r&&(Hs.textContent=String(r.credits),Ai.forEach(e=>{const t=e.dataset.weapon||"",i=e.dataset.slot||"1",o=parseInt(i)-1,s=uo[t]||0,a=r.weaponInventory[o]!==null,n=r.credits>=s;if(e.classList.remove("owned","cant-afford"),a){e.classList.add("owned");const l=e.querySelector(".weapon-price");l&&(l.textContent="OWNED")}else!n&&s>0&&e.classList.add("cant-afford")}))}function go(r){if(!x)return;const e=x.getWorld().getLocalPlayer();if(!e||!e.alive)return;const i={burst_pistol:"burst_pistol",neo_smg9:"neo_smg9",pulse_rifle:"pulse_rifle",scatter_shot:"scatter_shot",rail_sniper:"rail_sniper"}[r];if(!i)return;const o=e.getWeaponSlotForId(i)-1;if(e.weaponInventory[o]!==null){e.switchToWeaponSlot(o+1),Qt();return}e.buyWeapon(i)&&Bi()}function yo(){x&&(x.pause(),ge.classList.remove("hidden"))}function Si(){x&&(ge.classList.add("hidden"),co(),x.resume())}function xi(){x&&(x.endStatsSession(),x.stop(),x=null,qe=!1,zi(),oi(),ge.classList.add("hidden"),Ke.classList.add("hidden"),Mi.classList.add("hidden"),Dt.classList.add("hidden"),ae.classList.remove("hidden"),At.classList.remove("hidden"),Re.classList.remove("hidden"),_e.classList.remove("hidden"),ee.classList.add("hidden"),Ze.classList.add("hidden"),ee.value="",b.isHost=!1,b.players=[],b.roomCode="")}const b={isHost:!1,roomCode:"",players:[],maxPlayers:2,countdownActive:!1,countdownValue:5,isPublic:!1};let rt=null;function wo(){const r="ABCDEFGHJKLMNPQRSTUVWXYZ",e="0123456789";let t="";for(let i=0;i<4;i++)t+=r.charAt(Math.floor(Math.random()*r.length));for(let i=0;i<2;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}function ei(r,e,t){qe=!1,b.isHost=r,b.roomCode=e,b.maxPlayers=parseInt(It.value),b.countdownActive=!1,b.isPublic=r?Et.checked:!1,b.players=[{id:"local",name:t,isHost:r}],We.textContent=e,Li.textContent=String(b.maxPlayers),Ys.style.display=r?"block":"none",ii.style.display=r?"block":"none",r?le.innerHTML='Waiting for players<span class="dots">...</span>':le.innerHTML='Connecting to host<span class="dots">...</span>',ae.classList.add("hidden"),me.classList.add("hidden"),At.classList.add("hidden"),Dt.classList.remove("hidden"),r&&(Et.checked=b.isPublic,console.log("[Lobby] isHost:",r,"isPublic:",b.isPublic)),Pe()}function Pe(){Xs.textContent=String(b.players.length),Li.textContent=String(b.maxPlayers),pi.innerHTML="";for(const r of b.players){const e=document.createElement("div");e.className=`player-item${r.isHost?" host":""}`,e.innerHTML=`
      <span class="name">${r.name}</span>
      ${r.isHost?'<span class="tag">Host</span>':""}
    `,pi.appendChild(e)}if(b.isHost){const r=b.players.length>=b.maxPlayers||b.maxPlayers===1;ii.disabled=!r,r&&!b.countdownActive?le.textContent="All players ready!":b.countdownActive||(le.innerHTML='Waiting for players<span class="dots">...</span>'),b.isPublic&&ie.updateLobbyPlayerCount(b.roomCode,b.players.length)}else b.players.some(e=>e.isHost&&e.id!=="local")?le.innerHTML='Waiting for host to start<span class="dots">...</span>':le.innerHTML='Connecting to host<span class="dots">...</span>';b.players.length>=b.maxPlayers&&!b.countdownActive&&b.maxPlayers>1&&bo()}function bo(){b.countdownActive||(b.countdownActive=!0,b.countdownValue=5,le.classList.add("hidden"),nt.classList.remove("hidden"),nt.textContent=String(b.countdownValue),rt=window.setInterval(()=>{b.countdownValue--,nt.textContent=String(b.countdownValue),b.countdownValue<=0&&(oi(),ni())},1e3))}function oi(){rt!==null&&(clearInterval(rt),rt=null),b.countdownActive=!1,nt.classList.add("hidden"),le.classList.remove("hidden")}let qe=!1;function So(){oi(),Dt.classList.add("hidden"),ae.classList.remove("hidden"),At.classList.remove("hidden"),b.isHost&&b.isPublic&&ie.removeLobby(b.roomCode),Re.classList.remove("hidden"),_e.classList.remove("hidden"),ee.classList.add("hidden"),Ze.classList.add("hidden"),ee.value="",b.isHost=!1,b.players=[],b.roomCode="",b.isPublic=!1,qe=!1,_&&(_.disconnect(),_=null)}async function ni(){if(qe){console.log("[Main] startGameFromLobby already called, ignoring");return}qe=!0;const r=Q.value.trim()||"Player";Dt.classList.add("hidden"),b.isHost&&b.isPublic&&ie.removeLobby(b.roomCode),v.totalRounds=parseInt(js.value);const e=_;_=null,e&&(e.removeAllListeners(),console.log("[Main] Removed lobby listeners from network")),b.isHost&&e&&(console.log("[Main] Broadcasting GameStart to all peers"),e.broadcast({type:R.GameStart,timestamp:Date.now(),senderId:e.getLocalPeerId(),data:{roomCode:b.roomCode,totalRounds:v.totalRounds,mapId:v.mapId,gameMode:v.gameMode}})),console.log("[Main] lobbyState.players RAW:",JSON.stringify(b.players));const t=b.players.map(i=>({id:i.id,name:i.name,isHost:i.isHost}));if(console.log(`[Main] Passing ${t.length} lobby players to game:`,JSON.stringify(t)),console.log(`[Main] networkToPass exists: ${!!e}, peers: ${e?.getPeerIds().length||0}`),e?(console.log(`[Main] Creating Game with EXISTING network (${e.getPeerIds().length} peers)`),x=new ui({canvas:dt,playerName:r,settings:v,network:e,lobbyPlayers:t})):(console.log("[Main] Creating Game WITHOUT network (will create new)"),x=new ui({canvas:dt,playerName:r,settings:v,lobbyPlayers:t})),await x.init(),x.setShowFPS(ce.showFps),x.updateAudioSettings(S),b.isHost){const i=await x.hostGame(b.roomCode);console.log(`[Main] Starting game as HOST: ${i} (Best of ${v.totalRounds})`)}else await x.joinGame(b.roomCode),console.log(`[Main] Joined game: ${b.roomCode}`);Mi.classList.add("hidden"),x.start(),x.startStatsSession(),x.trackMatchStart(),mo(!0),ko()}let lt=null,fe=!1;function xo(r,e,t,i,o){const s=Ke.querySelector("h2");mi.textContent=`First to ${o} wins`,i?(s&&(s.textContent=" Match Over!"),r==="attackers"?(re.textContent=" ATTACKERS WIN THE MATCH!",re.className="winner-text attackers"):(re.textContent=" DEFENDERS WIN THE MATCH!",re.className="winner-text defenders"),mi.textContent="Match Complete!",ot.classList.remove("hidden"),ot.textContent="Play Again",fi.classList.add("hidden"),x&&x.recordMatchResult()):(s&&(s.textContent=" Round Over"),r==="attackers"?(re.textContent=" Attackers Win Round!",re.className="winner-text attackers"):(re.textContent=" Defenders Win Round!",re.className="winner-text defenders"),fi.classList.remove("hidden"),ot.classList.add("hidden")),Os.textContent=String(e),Gs.textContent=String(t),Ke.classList.remove("hidden"),fe=!0}function vo(){if(!x)return;const r=x.getCountdownInfo();if(!r)return;const e=Math.ceil(r.countdownTime/1e3);r.isPaused?(it.textContent=`PAUSED by ${r.pausedBy}`,it.classList.add("paused"),Ne.textContent=" Resume",Ne.classList.add("paused")):(it.textContent=`Next round in ${e}s`,it.classList.remove("paused"),Ne.textContent=" Pause",Ne.classList.remove("paused"))}function ko(){fe=!1,lt=window.setInterval(()=>{if(!x){zi();return}const r=x.getRoundEndInfo();r&&!fe&&xo(r.winningTeam,r.attackerScore,r.defenderScore,r.isMatchOver,r.roundsToWin),fe&&r&&!r.isMatchOver&&vo(),fe&&x.isRoundActive()&&(Ke.classList.add("hidden"),fe=!1)},100)}function zi(){lt!==null&&(clearInterval(lt),lt=null)}function Po(){if(!x)return;x.getRoundEndInfo()?.isMatchOver&&(Ke.classList.add("hidden"),fe=!1,x.restartGame())}function Io(){x&&x.toggleCountdownPause()}async function Eo(){dt.width=1280,dt.height=720;const r=localStorage.getItem("cybergrid_playerName");r&&(Q.value=r),wi(),Re.addEventListener("click",Co),_e.addEventListener("click",Ao),Ms.addEventListener("click",$i),Ls.addEventListener("click",Mo),Q.addEventListener("input",()=>{localStorage.setItem("cybergrid_playerName",Q.value)}),At.addEventListener("click",()=>{me.classList.toggle("hidden"),me.classList.contains("hidden")||te.trackUIOpen("settings")}),Ns.addEventListener("click",()=>{wi(),me.classList.add("hidden")}),$s.addEventListener("click",no),Ts.addEventListener("click",()=>{zt.classList.toggle("hidden"),zt.classList.contains("hidden")||te.trackUIOpen("how_to_play")}),Ds.addEventListener("click",()=>{zt.classList.add("hidden")}),Rs.addEventListener("click",()=>{$t.classList.toggle("hidden"),$t.classList.contains("hidden")||Qs()}),_s.addEventListener("click",()=>{$t.classList.add("hidden")}),qs.addEventListener("click",()=>{to()}),Zs.addEventListener("click",()=>{Ri()}),Jt.addEventListener("click",()=>{io()}),Et.addEventListener("change",async()=>{if(!b.isHost)return;b.isPublic=Et.checked;const o=Q.value.trim()||"Player";if(b.isPublic){console.log("[Lobby] Making lobby public...");try{await ie.initialize(),await ie.createPublicLobby({roomCode:b.roomCode,hostId:"local",hostName:o,gameMode:v.gameMode,mapId:v.mapId,maxPlayers:b.maxPlayers}),console.log("[Lobby] Lobby is now public")}catch(s){console.error("[Lobby] Failed to make lobby public:",s)}}else{console.log("[Lobby] Making lobby private...");try{await ie.removeLobby(b.roomCode),console.log("[Lobby] Lobby is now private")}catch(s){console.error("[Lobby] Failed to make lobby private:",s)}}}),ht.addEventListener("input",()=>{vi.textContent=ht.value}),ut.addEventListener("input",()=>{Pi.textContent=ut.value}),Xe.addEventListener("change",()=>{Di(Xe.value)}),ne.addEventListener("change",si),Mt.addEventListener("change",at),Lt.addEventListener("change",at),Tt.addEventListener("change",at),Ws.addEventListener("click",Si),Fs.addEventListener("click",xi),ot.addEventListener("click",Po),Vs.addEventListener("click",xi),Ne.addEventListener("click",Io),$e.addEventListener("click",()=>{const o=Us.textContent||"";navigator.clipboard.writeText(o).then(()=>{$e.textContent="Copied!",$e.classList.add("copied"),setTimeout(()=>{$e.textContent="Copy",$e.classList.remove("copied")},2e3)}).catch(()=>{alert(`Room Code: ${o}`)})}),Ks.addEventListener("click",So),ii.addEventListener("click",()=>{b.isHost&&ni()});const e=()=>{const o=We.textContent||"";navigator.clipboard.writeText(o).then(()=>{We.classList.add("copied"),Nt.textContent=" Copied!",setTimeout(()=>{We.classList.remove("copied"),Nt.textContent=" Copy Code"},1500)}).catch(()=>{alert(`Room Code: ${o}`)})};Nt.addEventListener("click",e),We.addEventListener("click",e),It.addEventListener("change",()=>{b.maxPlayers=parseInt(It.value),Pe()});const t=(o,s,a,n,l=!1)=>{o.addEventListener("input",()=>{const c=parseInt(o.value);if(a.textContent=`${c}%`,S[n]=c,bi(),l?(n==="masterVolume"&&(be.value=o.value,gt.textContent=`${c}%`),n==="musicVolume"&&(Se.value=o.value,wt.textContent=`${c}%`),n==="sfxVolume"&&(xe.value=o.value,St.textContent=`${c}%`),n==="voiceVolume"&&(ve.value=o.value,vt.textContent=`${c}%`),n==="uiVolume"&&(ke.value=o.value,Pt.textContent=`${c}%`)):(n==="masterVolume"&&(He.value=o.value,Ot.textContent=`${c}%`),n==="musicVolume"&&(Oe.value=o.value,Vt.textContent=`${c}%`),n==="sfxVolume"&&(Ge.value=o.value,Yt.textContent=`${c}%`),n==="voiceVolume"&&(Ve.value=o.value,Xt.textContent=`${c}%`),n==="uiVolume"&&(Ue.value=o.value,qt.textContent=`${c}%`)),x&&x.updateAudioSettings({[n]:c}),n==="uiVolume"||n==="masterVolume"){const d=S.masterVolume/100,h=S.uiVolume/100;pe.setVolume(d*h)}}),s.addEventListener("change",()=>{const c=s.checked;o.disabled=!c;const d=n.replace("Volume","Enabled");S[d]=c,bi(),l?(n==="masterVolume"&&(pt.checked=c,be.disabled=!c),n==="musicVolume"&&(yt.checked=c,Se.disabled=!c),n==="sfxVolume"&&(bt.checked=c,xe.disabled=!c),n==="voiceVolume"&&(xt.checked=c,ve.disabled=!c),n==="uiVolume"&&(kt.checked=c,ke.disabled=!c)):(n==="masterVolume"&&(Ht.checked=c,He.disabled=!c),n==="musicVolume"&&(Gt.checked=c,Oe.disabled=!c),n==="sfxVolume"&&(Ut.checked=c,Ge.disabled=!c),n==="voiceVolume"&&(jt.checked=c,Ve.disabled=!c),n==="uiVolume"&&(Kt.checked=c,Ue.disabled=!c)),x&&x.updateAudioSettings({[d]:c}),(n==="uiVolume"||n==="masterVolume")&&pe.setEnabled(S.masterEnabled&&S.uiEnabled)})};t(be,pt,gt,"masterVolume"),t(Se,yt,wt,"musicVolume"),t(xe,bt,St,"sfxVolume"),t(ve,xt,vt,"voiceVolume"),t(ke,kt,Pt,"uiVolume"),t(He,Ht,Ot,"masterVolume",!0),t(Oe,Gt,Vt,"musicVolume",!0),t(Ge,Ut,Yt,"sfxVolume",!0),t(Ve,jt,Xt,"voiceVolume",!0),t(Ue,Kt,qt,"uiVolume",!0),mt.addEventListener("input",()=>{Ei.textContent=(parseFloat(mt.value)/10).toFixed(1)}),ft.addEventListener("change",()=>{x&&x.setShowFPS(ft.checked)}),lo(),ao(),window.addEventListener("keydown",o=>{if(o.code==="Escape"){if(!me.classList.contains("hidden")){me.classList.add("hidden");return}if(!De.classList.contains("hidden")){Qt();return}x&&(ge.classList.contains("hidden")?yo():Si())}o.code==="KeyB"&&x&&ge.classList.contains("hidden")&&(De.classList.contains("hidden")?ge.classList.contains("hidden")&&po():Qt()),o.code==="KeyH"&&x&&ge.classList.contains("hidden")&&De.classList.contains("hidden")&&x.showHeroInfo(),o.code==="KeyP"&&x&&x.toggleCountdownPause()}),Ai.forEach(o=>{o.addEventListener("click",()=>{const s=o.dataset.weapon;s&&x&&go(s)})}),(()=>{document.querySelectorAll("button, .btn, .lobby-player-count-option, .weapon-item").forEach(s=>{s.addEventListener("mouseenter",()=>pe.playHover()),s.addEventListener("mousedown",()=>pe.playClick())})})(),console.log("[Main] CyberGrid Assault initialized"),console.log("[Main] Press HOST to start a local game")}async function Co(){const r=Q.value.trim()||"Player";te.trackGameStart("host",r);const e=wo();if(parseInt(It.value)===1){ei(!0,e,r);return}ae.classList.add("hidden");try{_=new Me({isHost:!0,useFirestore:!0}),await _.connectWithFirebase(Z),_.on("peerConnected",({peerId:o})=>{console.log(`[Lobby] Peer connected (WebRTC ready): ${o}`),b.players.push({id:o,name:"Connecting...",isHost:!1}),Pe()}),_.on("peerDisconnected",({peerId:o})=>{console.log(`[Lobby Host] Peer disconnected: ${o}`),console.log("[Lobby Host] Players BEFORE filter:",JSON.stringify(b.players)),b.players=b.players.filter(s=>s.id!==o),console.log("[Lobby Host] Players AFTER filter:",JSON.stringify(b.players)),Pe()}),_.on("packet",({peerId:o,packet:s})=>{if(console.log(`[Lobby Host] Received packet from ${o}:`,s.type),s.type===R.PlayerJoin){const a=s.data;console.log(`[Lobby Host] Player ${o} name: ${a.name}`);const n=b.players.find(l=>l.id===o);n&&(n.name=a.name,Pe())}}),await _.createRoom();const i=_.getRoomCode();console.log(`[Main] Room created in Firebase: ${i}`),ei(!0,i,r)}catch(i){console.error("[Main] Failed to create room:",i),alert("Failed to create game room. Check console for details."),ae.classList.remove("hidden"),_=null}}function Ao(){Re.classList.add("hidden"),_e.classList.add("hidden"),ee.classList.remove("hidden"),Ze.classList.remove("hidden"),ee.focus()}function Mo(){ee.classList.add("hidden"),Ze.classList.add("hidden"),ee.value="",Re.classList.remove("hidden"),_e.classList.remove("hidden")}async function $i(){const r=ee.value.trim().toUpperCase();if(!r){alert("Please enter a room code");return}const e=Q.value.trim()||"Player";te.trackGameStart("join",e),ae.classList.add("hidden"),ee.classList.add("hidden"),Ze.classList.add("hidden");try{_=new Me({isHost:!1,useFirestore:!0}),await _.connectWithFirebase(Z),_.on("peerConnected",({peerId:t})=>{console.log(`[Lobby Joiner] Peer connected: ${t}`),b.players.push({id:t,name:"Host",isHost:!0}),Pe(),console.log(`[Lobby Joiner] Sending our name to host: ${e}`),_?.broadcast({type:R.PlayerJoin,timestamp:Date.now(),senderId:_.getLocalPeerId(),data:{name:e}})}),_.on("peerDisconnected",({peerId:t})=>{console.log(`[Lobby] Peer disconnected: ${t}`),b.players=b.players.filter(i=>i.id!==t),Pe()}),_.on("packet",({peerId:t,packet:i})=>{if(console.log(`[Lobby Joiner] Received packet from ${t}:`,i.type),i.type===R.GameStart){console.log("[Lobby] Host started the game!");const o=i.data;o.totalRounds&&(v.totalRounds=o.totalRounds),o.mapId&&(v.mapId=o.mapId,console.log(`[Lobby Joiner] Using host's map: ${o.mapId}`)),o.gameMode&&(v.gameMode=o.gameMode,console.log(`[Lobby Joiner] Using host's game mode: ${o.gameMode}`)),ni()}}),await _.joinRoom(r),console.log(`[Main] Joined room in Firebase: ${r}`),ei(!1,r,e)}catch(t){console.error("[Main] Failed to join room:",t),alert("Failed to join game. Make sure the room code is correct and the host is online."),ae.classList.remove("hidden"),Re.classList.remove("hidden"),_e.classList.remove("hidden"),_=null}}Eo().catch(console.error);
//# sourceMappingURL=index-6L46NC1w.js.map
